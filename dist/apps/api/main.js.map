{"version":3,"file":"main.js","mappings":"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","sources":["external commonjs \"@nestjs/common\"","external commonjs \"@nestjs/core\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\app.module.ts","external commonjs \"tslib\"","external commonjs \"@nestjs/config\"","external commonjs \"@nestjs/serve-static\"","external node-commonjs \"path\"","external node-commonjs \"fs\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\tenant-context\\src\\index.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\tenant-context\\src\\lib\\tenant-prisma.service.ts","external commonjs \"@prisma/client\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\tenant-context\\src\\lib\\platform-prisma.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\tenant-context\\src\\lib\\tenant.middleware.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\tenant-context\\src\\lib\\tenant-id.decorator.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\tenant-context\\src\\lib\\tenant.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\app.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\app.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\health\\health.module.ts","external commonjs \"@nestjs/terminus\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\health\\health.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\health\\health.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\health\\indicators\\prisma.health.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\health\\indicators\\memory.health.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\registration\\registration.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\registration\\registration.controller.ts","external commonjs \"@nestjs/platform-express\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\registration\\registration.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\utils\\src\\index.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\utils\\src\\lib\\utils.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\utils\\src\\lib\\id-generator.ts","external commonjs \"@paralleldrive/cuid2\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\utils\\src\\lib\\industries.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\prisma\\src\\index.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\prisma\\src\\lib\\prisma.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\registration\\dto\\register-tenant.dto.ts","external commonjs \"class-validator\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\file-upload\\file-upload.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\file-upload\\file-upload.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\auth.module.ts","external commonjs \"@nestjs/passport\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\auth.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\auth.service.ts","external commonjs \"bcrypt\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\guards\\jwt-auth.guard.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\decorators\\public.decorator.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\decorators\\current-user.decorator.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\strategies\\jwt.strategy.ts","external commonjs \"passport-jwt\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\decorators\\skip-mfa.decorator.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\dto\\verify-totp.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\dto\\enroll-mfa.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\decorators\\roles.decorator.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\guards\\roles.guard.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\google-auth.controller.ts","external commonjs \"axios\"","external commonjs \"jsonwebtoken\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\auth\\guards\\mfa-required.guard.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\invitation\\invitation.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\index.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\email.service.ts","external commonjs \"nodemailer\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\invitation.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\removal.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\backup-owner-designation.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\recovery-notification.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\data-export-complete.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\tenant-deletion-initiated.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\tenant-deletion-cancelled.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\templates\\tenant-deletion-complete.template.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\email\\src\\lib\\email.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\knowledge.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\llm-config.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\llm-config.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\llm-config.service.ts","external node-commonjs \"node:crypto\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\providers\\openrouter.provider.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\providers\\local-llama.provider.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\providers\\openai.provider.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\providers\\lm-studio.provider.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\providers\\deepseek.provider.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\dto\\update-llm-config.dto.ts","external commonjs \"class-transformer\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\types\\src\\index.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\shared\\types\\src\\lib\\types.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\llm-config\\dto\\validate-provider.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\ai-gateway.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\ai-gateway.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\confidence\\confidence.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\confidence\\hedging-detector.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\personas\\templates\\persona-prompts.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\rate-limiter.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\redis.service.ts","external commonjs \"@upstash/redis\"","external commonjs \"@upstash/ratelimit\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\quota.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\token-tracker.service.ts","external commonjs \"@prisma/client/runtime/library\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\circuit-breaker.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\cost-calculator.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\request-queue.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\ai-gateway\\confidence\\improvement-suggestions.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\knowledge.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\concept.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\templates\\relationship-prompt.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\citation.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\curriculum.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\concept-seed.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\concept-matching.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\embedding.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\qdrant\\qdrant-client.service.ts","external commonjs \"@qdrant/js-client-rest\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\citation-injector.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\concept-extraction.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\templates\\extraction-prompt.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\brain-seeding.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\config\\department-categories.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\business-context.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\services\\concept-relevance.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\knowledge\\guards\\department.guard.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\invitation\\invitation.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\invitation\\invitation.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\invitation\\dto\\create-invitation.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\team\\team.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\team\\team.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\team\\team.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\team\\dto\\remove-member.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\team\\dto\\designate-backup-owner.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\conversation\\conversation.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\notes\\notes.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\notes\\notes.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\notes\\notes.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\notes\\dto\\comment.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\memory.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\memory.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\services\\memory.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\dto\\create-memory.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\dto\\update-memory.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\services\\memory-extraction.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\services\\memory-embedding.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\memory\\services\\memory-context-builder.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\workflow\\workflow.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\web-search\\web-search.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\web-search\\web-search.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\execution\\execution.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\execution\\execution-state.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\workflow\\workflow.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\workflow\\yolo-scheduler.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\attachments\\attachments.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\attachments\\attachments.controller.ts","external commonjs \"express\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\attachments\\attachments.service.ts","external commonjs \"pdf-parse\"","external commonjs \"xlsx\"","external commonjs \"mammoth\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\conversation\\conversation.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\conversation\\conversation.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\conversation\\dto\\create-conversation.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\personas\\dto\\update-persona.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\conversation\\conversation.gateway.ts","external commonjs \"@nestjs/websockets\"","external commonjs \"socket.io\"","external commonjs \"jwks-rsa\"","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\onboarding\\onboarding.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\onboarding\\onboarding.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\onboarding\\onboarding.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\onboarding\\onboarding-metric.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\onboarding\\templates\\quick-task-templates.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\onboarding\\dto\\quick-win.dto.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\personas\\personas.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\personas\\personas.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\personas\\personas.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\qdrant\\qdrant.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\admin\\admin.module.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\admin\\data-integrity.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\admin\\data-integrity.service.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\admin\\brain-config.controller.ts","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\app\\common\\filters\\all-exceptions.filter.ts","webpack/bootstrap","C:\\Users\\tanjav\\Downloads\\BMAD-METHOD-main\\mentor-ai\\apps\\api\\src\\main.ts"],"sourcesContent":["module.exports = require(\"@nestjs/common\");","module.exports = require(\"@nestjs/core\");","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { ServeStaticModule } from '@nestjs/serve-static';\r\nimport { join } from 'path';\r\nimport { existsSync } from 'fs';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AppController } from './app.controller';\r\nimport { AppService } from './app.service';\r\nimport { HealthModule } from './health/health.module';\r\nimport { RegistrationModule } from './registration/registration.module';\r\nimport { AuthModule } from './auth/auth.module';\r\nimport { InvitationModule } from './invitation/invitation.module';\r\nimport { TeamModule } from './team/team.module';\r\n// DataExportModule and TenantDeletionModule: enable when Redis is available (BullMQ dependency)\r\nimport { LlmConfigModule } from './llm-config/llm-config.module';\r\nimport { AiGatewayModule } from './ai-gateway/ai-gateway.module';\r\nimport { ConversationModule } from './conversation/conversation.module';\r\nimport { OnboardingModule } from './onboarding/onboarding.module';\r\nimport { PersonasModule } from './personas/personas.module';\r\nimport { KnowledgeModule } from './knowledge/knowledge.module';\r\nimport { MemoryModule } from './memory/memory.module';\r\nimport { QdrantModule } from './qdrant/qdrant.module';\r\nimport { WebSearchModule } from './web-search/web-search.module';\r\nimport { AdminModule } from './admin/admin.module';\r\nimport { ExecutionModule } from './execution/execution.module';\r\nimport { AttachmentsModule } from './attachments/attachments.module';\r\n\r\n// Serve Angular static files in production (combined deploy)\r\nconst staticPath = join(__dirname, '..', '..', 'web', 'browser');\r\nconst serveStaticImports = existsSync(staticPath)\r\n  ? [\r\n      ServeStaticModule.forRoot({\r\n        rootPath: staticPath,\r\n        exclude: ['/api/(.*)', '/ws/(.*)'],\r\n      }),\r\n    ]\r\n  : [];\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule.forRoot({\r\n      isGlobal: true,\r\n      envFilePath: ['apps/api/.env.local', 'apps/api/.env', '.env.local', '.env'],\r\n    }),\r\n    ...serveStaticImports,\r\n    QdrantModule,\r\n    TenantModule,\r\n    HealthModule,\r\n    RegistrationModule,\r\n    AuthModule,\r\n    InvitationModule,\r\n    TeamModule,\r\n    // TODO: Enable when Redis is available (BullMQ dependency)\r\n    // DataExportModule,\r\n    // TenantDeletionModule,\r\n    LlmConfigModule,\r\n    AiGatewayModule,\r\n    ConversationModule,\r\n    OnboardingModule,\r\n    PersonasModule,\r\n    KnowledgeModule,\r\n    MemoryModule,\r\n    WebSearchModule,\r\n    AdminModule,\r\n    ExecutionModule,\r\n    AttachmentsModule,\r\n  ],\r\n  controllers: [AppController],\r\n  providers: [AppService],\r\n})\r\nexport class AppModule {}\r\n","module.exports = require(\"tslib\");","module.exports = require(\"@nestjs/config\");","module.exports = require(\"@nestjs/serve-static\");","module.exports = require(\"path\");","module.exports = require(\"fs\");","// Tenant Context Library\r\n// Provides multi-tenant database routing and context management\r\n\r\n// Services\r\nexport { TenantPrismaService } from './lib/tenant-prisma.service';\r\nexport { PlatformPrismaService } from './lib/platform-prisma.service';\r\n\r\n// Middleware\r\nexport { TenantMiddleware, TENANT_ID_HEADER, TENANT_ID_KEY } from './lib/tenant.middleware';\r\n\r\n// Decorators\r\nexport { TenantId } from './lib/tenant-id.decorator';\r\n\r\n// Module\r\nexport { TenantModule } from './lib/tenant.module';\r\n","import { Injectable, OnModuleDestroy } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\ninterface PoolConfig {\r\n  max: number;\r\n  idleTimeoutMs: number;\r\n  acquireTimeoutMs: number;\r\n}\r\n\r\nconst DEFAULT_POOL_CONFIG: PoolConfig = {\r\n  max: 10,\r\n  idleTimeoutMs: 30000,\r\n  acquireTimeoutMs: 5000,\r\n};\r\n\r\ninterface TenantConnection {\r\n  client: PrismaClient;\r\n  lastUsed: number;\r\n}\r\n\r\n@Injectable()\r\nexport class TenantPrismaService implements OnModuleDestroy {\r\n  private readonly clients = new Map<string, TenantConnection>();\r\n  private readonly poolConfig: PoolConfig;\r\n  private cleanupInterval: NodeJS.Timeout | null = null;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    this.poolConfig = {\r\n      max: this.configService.get<number>('TENANT_DB_POOL_MAX') ?? DEFAULT_POOL_CONFIG.max,\r\n      idleTimeoutMs: this.configService.get<number>('TENANT_DB_IDLE_TIMEOUT_MS') ?? DEFAULT_POOL_CONFIG.idleTimeoutMs,\r\n      acquireTimeoutMs: this.configService.get<number>('TENANT_DB_ACQUIRE_TIMEOUT_MS') ?? DEFAULT_POOL_CONFIG.acquireTimeoutMs,\r\n    };\r\n\r\n    this.startIdleCleanup();\r\n  }\r\n\r\n  /**\r\n   * Get or create a PrismaClient for the given tenant\r\n   * Uses lazy initialization and connection pooling\r\n   */\r\n  async getClient(tenantId: string): Promise<PrismaClient> {\r\n    const existing = this.clients.get(tenantId);\r\n\r\n    if (existing) {\r\n      existing.lastUsed = Date.now();\r\n      return existing.client;\r\n    }\r\n\r\n    return this.createClient(tenantId);\r\n  }\r\n\r\n  /**\r\n   * Get a PrismaClient synchronously (for middleware use)\r\n   * Note: Will create connection if not exists\r\n   */\r\n  getClientSync(tenantId: string): PrismaClient {\r\n    const existing = this.clients.get(tenantId);\r\n\r\n    if (existing) {\r\n      existing.lastUsed = Date.now();\r\n      return existing.client;\r\n    }\r\n\r\n    const client = this.createClientSync(tenantId);\r\n    return client;\r\n  }\r\n\r\n  private async createClient(tenantId: string): Promise<PrismaClient> {\r\n    const dbUrl = this.getTenantDbUrl(tenantId);\r\n\r\n    const client = new PrismaClient({\r\n      datasources: {\r\n        db: { url: dbUrl },\r\n      },\r\n    });\r\n\r\n    try {\r\n      // Connect with timeout\r\n      const connectPromise = client.$connect();\r\n      const timeoutPromise = new Promise<never>((_, reject) => {\r\n        setTimeout(() => {\r\n          reject(new Error(`Connection acquisition timeout after ${this.poolConfig.acquireTimeoutMs}ms for tenant ${tenantId}`));\r\n        }, this.poolConfig.acquireTimeoutMs);\r\n      });\r\n\r\n      await Promise.race([connectPromise, timeoutPromise]);\r\n\r\n      this.clients.set(tenantId, {\r\n        client,\r\n        lastUsed: Date.now(),\r\n      });\r\n\r\n      return client;\r\n    } catch (error) {\r\n      // Clean up the client on connection failure to prevent memory leak\r\n      await client.$disconnect().catch(() => {\r\n        // Ignore disconnect errors during cleanup\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private createClientSync(tenantId: string): PrismaClient {\r\n    const dbUrl = this.getTenantDbUrl(tenantId);\r\n\r\n    const client = new PrismaClient({\r\n      datasources: {\r\n        db: { url: dbUrl },\r\n      },\r\n    });\r\n\r\n    this.clients.set(tenantId, {\r\n      client,\r\n      lastUsed: Date.now(),\r\n    });\r\n\r\n    // Connect in background - client will auto-connect on first query\r\n    return client;\r\n  }\r\n\r\n  private getTenantDbUrl(tenantId: string): string {\r\n    // Dev mode: use the platform DATABASE_URL for all tenants (single-database mode)\r\n    const devMode = this.configService.get<string>('DEV_MODE') === 'true';\r\n    if (devMode) {\r\n      const platformUrl = this.configService.get<string>('DATABASE_URL');\r\n      if (platformUrl) {\r\n        return platformUrl;\r\n      }\r\n    }\r\n\r\n    const host = this.configService.get<string>('TENANT_DB_HOST') ?? 'localhost';\r\n    const port = this.configService.get<number>('TENANT_DB_PORT') ?? 5432;\r\n    const user = this.configService.get<string>('TENANT_DB_USER') ?? 'postgres';\r\n    const password = this.configService.get<string>('TENANT_DB_PASSWORD') ?? 'postgres';\r\n\r\n    // Tenant database name follows convention: tenant_{tenantId without prefix}\r\n    const dbName = `tenant_${tenantId.replace('tnt_', '')}`;\r\n\r\n    // URL-encode credentials to handle special characters (e.g., @, :, /)\r\n    const encodedUser = encodeURIComponent(user);\r\n    const encodedPassword = encodeURIComponent(password);\r\n\r\n    return `postgresql://${encodedUser}:${encodedPassword}@${host}:${port}/${dbName}?connection_limit=${this.poolConfig.max}`;\r\n  }\r\n\r\n  private startIdleCleanup(): void {\r\n    // Run cleanup every minute\r\n    this.cleanupInterval = setInterval(() => {\r\n      this.cleanupIdleConnections();\r\n    }, 60000);\r\n  }\r\n\r\n  private cleanupIdleConnections(): void {\r\n    const now = Date.now();\r\n\r\n    for (const [tenantId, connection] of this.clients.entries()) {\r\n      if (now - connection.lastUsed > this.poolConfig.idleTimeoutMs) {\r\n        connection.client.$disconnect().catch(() => {\r\n          // Ignore disconnect errors during cleanup\r\n        });\r\n        this.clients.delete(tenantId);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Disconnect a specific tenant's client\r\n   */\r\n  async disconnectTenant(tenantId: string): Promise<void> {\r\n    const connection = this.clients.get(tenantId);\r\n    if (connection) {\r\n      await connection.client.$disconnect();\r\n      this.clients.delete(tenantId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the number of active connections\r\n   */\r\n  getActiveConnectionCount(): number {\r\n    return this.clients.size;\r\n  }\r\n\r\n  /**\r\n   * Check if a tenant has an active connection\r\n   */\r\n  hasConnection(tenantId: string): boolean {\r\n    return this.clients.has(tenantId);\r\n  }\r\n\r\n  async onModuleDestroy(): Promise<void> {\r\n    if (this.cleanupInterval) {\r\n      clearInterval(this.cleanupInterval);\r\n    }\r\n\r\n    // Disconnect all clients\r\n    const disconnectPromises = Array.from(this.clients.values()).map(\r\n      (connection) => connection.client.$disconnect()\r\n    );\r\n\r\n    await Promise.all(disconnectPromises);\r\n    this.clients.clear();\r\n  }\r\n}\r\n","module.exports = require(\"@prisma/client\");","import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class PlatformPrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {\r\n  constructor(configService: ConfigService) {\r\n    const databaseUrl = configService.get<string>('DATABASE_URL');\r\n\r\n    if (!databaseUrl) {\r\n      throw new Error(\r\n        'DATABASE_URL environment variable is required but not set. ' +\r\n        'Please configure DATABASE_URL in your .env file. ' +\r\n        'Example: DATABASE_URL=postgresql://user:password@localhost:5432/mentor_ai_platform'\r\n      );\r\n    }\r\n\r\n    super({\r\n      datasources: {\r\n        db: { url: databaseUrl },\r\n      },\r\n    });\r\n  }\r\n\r\n  async onModuleInit(): Promise<void> {\r\n    await this.$connect();\r\n  }\r\n\r\n  async onModuleDestroy(): Promise<void> {\r\n    await this.$disconnect();\r\n  }\r\n}\r\n","import { Injectable, NestMiddleware, ForbiddenException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { PlatformPrismaService } from './platform-prisma.service';\r\nimport { TenantStatus } from '@prisma/client';\r\n\r\nexport const TENANT_ID_HEADER = 'x-tenant-id';\r\nexport const TENANT_ID_KEY = 'tenantId';\r\n\r\n// Extend Express Request to include tenant context\r\ndeclare global {\r\n  // eslint-disable-next-line @typescript-eslint/no-namespace\r\n  namespace Express {\r\n    interface Request {\r\n      tenantId?: string;\r\n    }\r\n  }\r\n}\r\n\r\ninterface Rfc7807Error {\r\n  type: string;\r\n  title: string;\r\n  status: number;\r\n  detail: string;\r\n  correlationId?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class TenantMiddleware implements NestMiddleware {\r\n  // Paths that don't require tenant context (e.g., health checks, platform admin)\r\n  private readonly excludedPaths = [\r\n    '/health',\r\n    '/api/health',\r\n    '/api/v1/health',\r\n  ];\r\n\r\n  constructor(\r\n    private readonly platformPrisma: PlatformPrismaService,\r\n    private readonly configService: ConfigService\r\n  ) {}\r\n\r\n  async use(req: Request, res: Response, next: NextFunction): Promise<void> {\r\n    // Skip tenant validation for excluded paths\r\n    if (this.isExcludedPath(req.path)) {\r\n      return next();\r\n    }\r\n\r\n    // Dev mode: try to extract tenantId from JWT if a real token is present,\r\n    // otherwise fall back to dev-tenant-001\r\n    if (this.configService.get<string>('DEV_MODE') === 'true') {\r\n      const authHeader = req.headers?.authorization as string | undefined;\r\n      if (authHeader?.startsWith('Bearer ') && !authHeader.includes('dev-mode-token')) {\r\n        try {\r\n          const token = authHeader.substring(7);\r\n          const payloadBase64 = token.split('.')[1];\r\n          if (payloadBase64) {\r\n            const payload = JSON.parse(Buffer.from(payloadBase64, 'base64').toString());\r\n            if (payload.tenantId) {\r\n              req.tenantId = payload.tenantId;\r\n              return next();\r\n            }\r\n          }\r\n        } catch {\r\n          // Token decode failed - use dev fallback\r\n        }\r\n      }\r\n      req.tenantId = 'dev-tenant-001';\r\n      return next();\r\n    }\r\n\r\n    const tenantId = req.headers[TENANT_ID_HEADER] as string | undefined;\r\n    const correlationId = req.headers['x-correlation-id'] as string | undefined;\r\n\r\n    // Validate tenant ID is present\r\n    if (!tenantId) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'tenant_id_missing',\r\n        'Tenant ID Required',\r\n        'X-Tenant-Id header is required for this request',\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    // Validate tenant ID format (must have tnt_ prefix)\r\n    if (!tenantId.startsWith('tnt_')) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'invalid_tenant_id_format',\r\n        'Invalid Tenant ID Format',\r\n        'Tenant ID must start with \"tnt_\" prefix',\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    // Validate tenant exists and is active\r\n    const tenant = await this.platformPrisma.tenantRegistry.findUnique({\r\n      where: { id: tenantId },\r\n    });\r\n\r\n    if (!tenant) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'tenant_not_found',\r\n        'Tenant Not Found',\r\n        'No tenant found for provided X-Tenant-Id header',\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    if (tenant.status !== TenantStatus.ACTIVE) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'tenant_not_active',\r\n        'Tenant Not Active',\r\n        `Tenant is currently ${tenant.status.toLowerCase()}`,\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    // Attach tenant ID to request for downstream use\r\n    req.tenantId = tenantId;\r\n\r\n    next();\r\n  }\r\n\r\n  private isExcludedPath(path: string): boolean {\r\n    return this.excludedPaths.some(\r\n      (excluded) => path === excluded || path.startsWith(`${excluded}/`)\r\n    );\r\n  }\r\n\r\n  private createRfc7807Error(\r\n    type: string,\r\n    title: string,\r\n    detail: string,\r\n    correlationId?: string\r\n  ): Rfc7807Error {\r\n    return {\r\n      type,\r\n      title,\r\n      status: 403,\r\n      detail,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n}\r\n","import { createParamDecorator, ExecutionContext, ForbiddenException } from '@nestjs/common';\r\nimport { Request } from 'express';\r\n\r\n/**\r\n * Parameter decorator to extract the tenant ID from the request context.\r\n * The tenant ID is set by TenantMiddleware after validation.\r\n *\r\n * @example\r\n * ```typescript\r\n * @Get('data')\r\n * getData(@TenantId() tenantId: string) {\r\n *   return this.myService.getData(tenantId);\r\n * }\r\n * ```\r\n */\r\nexport const TenantId = createParamDecorator(\r\n  (data: unknown, ctx: ExecutionContext): string => {\r\n    const request = ctx.switchToHttp().getRequest<Request>();\r\n    const tenantId = request.tenantId;\r\n\r\n    if (!tenantId) {\r\n      throw new ForbiddenException({\r\n        type: 'tenant_context_missing',\r\n        title: 'Tenant Context Missing',\r\n        status: 403,\r\n        detail: 'Tenant context not available. Ensure TenantMiddleware is configured.',\r\n      });\r\n    }\r\n\r\n    return tenantId;\r\n  }\r\n);\r\n","import { Module, MiddlewareConsumer, NestModule } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { TenantPrismaService } from './tenant-prisma.service';\r\nimport { PlatformPrismaService } from './platform-prisma.service';\r\nimport { TenantMiddleware } from './tenant.middleware';\r\n\r\n@Module({\r\n  imports: [ConfigModule],\r\n  providers: [TenantPrismaService, PlatformPrismaService, TenantMiddleware],\r\n  exports: [TenantPrismaService, PlatformPrismaService],\r\n})\r\nexport class TenantModule implements NestModule {\r\n  configure(consumer: MiddlewareConsumer): void {\r\n    consumer.apply(TenantMiddleware).forRoutes('*');\r\n  }\r\n}\r\n","import { Controller, Get } from '@nestjs/common';\nimport { AppService } from './app.service';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService) {}\n\n  @Get()\n  getData() {\n    return this.appService.getData();\n  }\n}\n","import { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class AppService {\n  getData(): { message: string } {\n    return { message: 'Hello API' };\n  }\n}\n","import { Module } from '@nestjs/common';\r\nimport { TerminusModule } from '@nestjs/terminus';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { HealthController } from './health.controller';\r\nimport { HealthService } from './health.service';\r\nimport { PrismaHealthIndicator } from './indicators/prisma.health';\r\nimport { MemoryHealthIndicator } from './indicators/memory.health';\r\n\r\n@Module({\r\n  imports: [TerminusModule, TenantModule], // TenantModule provides PlatformPrismaService\r\n  controllers: [HealthController],\r\n  providers: [HealthService, PrismaHealthIndicator, MemoryHealthIndicator],\r\n})\r\nexport class HealthModule {}\r\n","module.exports = require(\"@nestjs/terminus\");","import { Controller, Get, Headers } from '@nestjs/common';\r\nimport {\r\n  HealthCheck,\r\n  HealthCheckService,\r\n  HealthCheckResult,\r\n} from '@nestjs/terminus';\r\nimport { HealthService, HealthResponse, LiveResponse } from './health.service';\r\nimport { PrismaHealthIndicator } from './indicators/prisma.health';\r\nimport { MemoryHealthIndicator } from './indicators/memory.health';\r\n\r\n@Controller('health')\r\nexport class HealthController {\r\n  constructor(\r\n    private readonly health: HealthCheckService,\r\n    private readonly healthService: HealthService,\r\n    private readonly prismaHealth: PrismaHealthIndicator,\r\n    private readonly memoryHealth: MemoryHealthIndicator\r\n  ) {}\r\n\r\n  /**\r\n   * GET /health\r\n   * Basic health check endpoint returning status, timestamp, and version.\r\n   * Response time should be < 100ms (no blocking operations).\r\n   */\r\n  @Get()\r\n  getHealth(\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): HealthResponse {\r\n    return {\r\n      status: 'healthy',\r\n      timestamp: this.healthService.getTimestamp(),\r\n      version: this.healthService.getVersion(),\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * GET /health/ready\r\n   * Readiness probe checking all critical dependencies.\r\n   * Returns 503 if any critical dependency fails.\r\n   *\r\n   * Checks performed:\r\n   * - database: PostgreSQL via Prisma\r\n   * - memory: Heap usage < 90% threshold\r\n   *\r\n   * TODO: Add Redis health indicator when Upstash is configured (Story 1.4 AC2 partial)\r\n   */\r\n  @Get('ready')\r\n  @HealthCheck()\r\n  async getReadiness(\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<HealthCheckResult> {\r\n    const result = await this.health.check([\r\n      () => this.prismaHealth.isHealthy('database'),\r\n      () => this.memoryHealth.isHealthy('memory', { threshold: 0.9 }),\r\n      // TODO: Add Redis check when Upstash is configured\r\n      // () => this.redisHealth.isHealthy('redis'),\r\n    ]);\r\n\r\n    // Add correlation ID to response if provided\r\n    if (correlationId) {\r\n      (result as HealthCheckResult & { correlationId?: string }).correlationId =\r\n        correlationId;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * GET /health/live\r\n   * Liveness probe for Kubernetes.\r\n   * Minimal payload, no external checks.\r\n   */\r\n  @Get('live')\r\n  getLiveness(): LiveResponse {\r\n    return { status: 'ok' };\r\n  }\r\n}\r\n","import { Injectable } from '@nestjs/common';\r\n\r\n// Read version from package.json\r\n// eslint-disable-next-line @typescript-eslint/no-require-imports\r\nconst packageJson = require('../../../../../package.json');\r\n\r\n/**\r\n * Health status values for the /health endpoint.\r\n * - healthy: Application is running and responding\r\n * - degraded: Application running but some non-critical checks failing (reserved for future use)\r\n * - unhealthy: Application has critical issues (reserved for future use)\r\n *\r\n * Note: Currently /health always returns 'healthy' if the app responds.\r\n * For dependency health, use /health/ready which returns 503 on failures.\r\n */\r\nexport type HealthStatus = 'healthy' | 'degraded' | 'unhealthy';\r\n\r\nexport interface HealthResponse {\r\n  status: HealthStatus;\r\n  timestamp: string;\r\n  version: string;\r\n  correlationId?: string;\r\n}\r\n\r\nexport interface LiveResponse {\r\n  status: 'ok';\r\n}\r\n\r\n@Injectable()\r\nexport class HealthService {\r\n  getVersion(): string {\r\n    return packageJson.version || '0.0.0';\r\n  }\r\n\r\n  getTimestamp(): string {\r\n    return new Date().toISOString();\r\n  }\r\n}\r\n","import { Injectable } from '@nestjs/common';\r\nimport {\r\n  HealthIndicator,\r\n  HealthIndicatorResult,\r\n  HealthCheckError,\r\n} from '@nestjs/terminus';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\n\r\nconst HEALTH_CHECK_TIMEOUT = 5000; // 5 seconds max\r\n\r\n@Injectable()\r\nexport class PrismaHealthIndicator extends HealthIndicator {\r\n  constructor(private readonly prisma: PlatformPrismaService) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Check if Prisma/PostgreSQL connection is healthy.\r\n   * Uses a simple SELECT 1 query with timeout handling.\r\n   */\r\n  async isHealthy(key: string): Promise<HealthIndicatorResult> {\r\n    try {\r\n      await this.checkWithTimeout(\r\n        () => this.prisma.$queryRaw`SELECT 1`,\r\n        HEALTH_CHECK_TIMEOUT\r\n      );\r\n      return this.getStatus(key, true);\r\n    } catch (error) {\r\n      const errorMessage =\r\n        error instanceof Error ? error.message : 'Unknown error';\r\n      throw new HealthCheckError(\r\n        'Prisma check failed',\r\n        this.getStatus(key, false, { message: errorMessage })\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute a health check with timeout.\r\n   * Implements circuit breaker pattern to prevent cascading failures.\r\n   */\r\n  private async checkWithTimeout<T>(\r\n    check: () => Promise<T>,\r\n    timeout: number\r\n  ): Promise<T> {\r\n    let timeoutId: ReturnType<typeof setTimeout> | undefined;\r\n\r\n    const timeoutPromise = new Promise<never>((_, reject) => {\r\n      timeoutId = setTimeout(\r\n        () => reject(new Error('Health check timeout')),\r\n        timeout\r\n      );\r\n    });\r\n\r\n    try {\r\n      const result = await Promise.race([check(), timeoutPromise]);\r\n      return result;\r\n    } finally {\r\n      // Clean up timer to prevent memory leaks\r\n      if (timeoutId) {\r\n        clearTimeout(timeoutId);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@nestjs/common';\r\nimport {\r\n  HealthIndicator,\r\n  HealthIndicatorResult,\r\n  HealthCheckError,\r\n} from '@nestjs/terminus';\r\n\r\nexport interface MemoryHealthOptions {\r\n  /**\r\n   * Memory usage threshold (0-1).\r\n   * Default: 0.9 (90%)\r\n   */\r\n  threshold?: number;\r\n}\r\n\r\n@Injectable()\r\nexport class MemoryHealthIndicator extends HealthIndicator {\r\n  /**\r\n   * Check if memory usage is below the threshold.\r\n   * @param key - The key which will be used for the health indicator result\r\n   * @param options - Memory health check options\r\n   */\r\n  async isHealthy(\r\n    key: string,\r\n    options: MemoryHealthOptions = {}\r\n  ): Promise<HealthIndicatorResult> {\r\n    const threshold = options.threshold ?? 0.9;\r\n    const memoryUsage = process.memoryUsage();\r\n    const heapTotal = memoryUsage.heapTotal;\r\n    const heapUsed = memoryUsage.heapUsed;\r\n    const usageRatio = heapUsed / heapTotal;\r\n    const usagePercent = Math.round(usageRatio * 100);\r\n\r\n    const isHealthy = usageRatio < threshold;\r\n\r\n    const details = {\r\n      heapUsed: this.formatBytes(heapUsed),\r\n      heapTotal: this.formatBytes(heapTotal),\r\n      usage: `${usagePercent}%`,\r\n      threshold: `${Math.round(threshold * 100)}%`,\r\n    };\r\n\r\n    if (isHealthy) {\r\n      return this.getStatus(key, true, details);\r\n    }\r\n\r\n    throw new HealthCheckError(\r\n      `Memory usage (${usagePercent}%) exceeds threshold (${Math.round(threshold * 100)}%)`,\r\n      this.getStatus(key, false, details)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Format bytes to human readable string.\r\n   */\r\n  private formatBytes(bytes: number): string {\r\n    const mb = bytes / (1024 * 1024);\r\n    return `${mb.toFixed(2)} MB`;\r\n  }\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { RegistrationController } from './registration.controller';\r\nimport { RegistrationService } from './registration.service';\r\nimport { FileUploadModule } from '../file-upload/file-upload.module';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\n\r\n@Module({\r\n  imports: [FileUploadModule, TenantModule], // TenantModule provides PlatformPrismaService\r\n  controllers: [RegistrationController],\r\n  providers: [RegistrationService],\r\n  exports: [RegistrationService],\r\n})\r\nexport class RegistrationModule {}\r\n","import {\r\n  Controller,\r\n  Post,\r\n  Body,\r\n  Headers,\r\n  HttpCode,\r\n  HttpStatus,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n} from '@nestjs/common';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { RegistrationService, RegistrationResult } from './registration.service';\r\nimport { RegisterTenantDto } from './dto/register-tenant.dto';\r\nimport { FileUploadService, UploadedFileType } from '../file-upload/file-upload.service';\r\n\r\nexport interface RegistrationResponse extends RegistrationResult {\r\n  status: 'success';\r\n  message: string;\r\n  correlationId?: string;\r\n}\r\n\r\n@Controller('registration')\r\nexport class RegistrationController {\r\n  constructor(\r\n    private readonly registrationService: RegistrationService,\r\n    private readonly fileUploadService: FileUploadService\r\n  ) {}\r\n\r\n  @Post()\r\n  @HttpCode(HttpStatus.CREATED)\r\n  @UseInterceptors(FileInterceptor('icon'))\r\n  async register(\r\n    @Body() dto: RegisterTenantDto,\r\n    @Headers('x-correlation-id') correlationId?: string,\r\n    @UploadedFile() icon?: UploadedFileType\r\n  ): Promise<RegistrationResponse> {\r\n    // Validate file upfront if provided (saveFile also validates, but fail fast)\r\n    if (icon) {\r\n      this.fileUploadService.validateFile(icon);\r\n    }\r\n\r\n    const result = await this.registrationService.registerTenant(dto);\r\n\r\n    // Save file after tenant is created (we need the tenant ID for filename)\r\n    if (icon) {\r\n      let uploadResult;\r\n      try {\r\n        uploadResult = await this.fileUploadService.saveFile(\r\n          icon,\r\n          result.tenantId,\r\n          false // Skip validation since we already validated above\r\n        );\r\n        // Update tenant with icon URL\r\n        await this.registrationService.updateTenantIcon(\r\n          result.tenantId,\r\n          uploadResult.url\r\n        );\r\n        result.iconUrl = uploadResult.url;\r\n      } catch (error) {\r\n        // Clean up orphaned file if icon update fails\r\n        if (uploadResult?.filename) {\r\n          await this.fileUploadService\r\n            .deleteFile(uploadResult.filename)\r\n            .catch(() => {\r\n              /* Ignore cleanup errors */\r\n            });\r\n        }\r\n        throw error;\r\n      }\r\n    }\r\n\r\n    const response: RegistrationResponse = {\r\n      status: 'success',\r\n      message: 'Registration successful. Please complete OAuth authentication.',\r\n      ...result,\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n}\r\n","module.exports = require(\"@nestjs/platform-express\");","import { Injectable, ConflictException } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { generateUserId, generateTenantId } from '@mentor-ai/shared/utils';\r\nimport { TenantStatus, UserRole } from '@mentor-ai/shared/prisma';\r\nimport { RegisterTenantDto } from './dto/register-tenant.dto';\r\n\r\nexport interface RegistrationResult {\r\n  tenantId: string;\r\n  userId: string;\r\n  email: string;\r\n  companyName: string;\r\n  iconUrl?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class RegistrationService {\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  async checkEmailExists(email: string): Promise<boolean> {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { email: email.toLowerCase() },\r\n    });\r\n    return user !== null;\r\n  }\r\n\r\n  async registerTenant(dto: RegisterTenantDto): Promise<RegistrationResult> {\r\n    const normalizedEmail = dto.email.toLowerCase();\r\n\r\n    // Check for existing email\r\n    const emailExists = await this.checkEmailExists(normalizedEmail);\r\n    if (emailExists) {\r\n      throw new ConflictException({\r\n        type: 'email_already_exists',\r\n        title: 'Email Already Registered',\r\n        status: 409,\r\n        detail: 'An account with this email already exists',\r\n      });\r\n    }\r\n\r\n    // Generate IDs with prefixes\r\n    const tenantId = generateTenantId();\r\n    const userId = generateUserId();\r\n\r\n    // Create tenant and user in a transaction\r\n    await this.prisma.$transaction(async (tx) => {\r\n      // Create tenant in DRAFT state\r\n      await tx.tenant.create({\r\n        data: {\r\n          id: tenantId,\r\n          name: dto.companyName,\r\n          industry: dto.industry,\r\n          description: dto.description,\r\n          status: TenantStatus.DRAFT,\r\n        },\r\n      });\r\n\r\n      // Create user with TENANT_OWNER role\r\n      await tx.user.create({\r\n        data: {\r\n          id: userId,\r\n          email: normalizedEmail,\r\n          role: UserRole.TENANT_OWNER,\r\n          tenantId: tenantId,\r\n        },\r\n      });\r\n    });\r\n\r\n    return {\r\n      tenantId,\r\n      userId,\r\n      email: normalizedEmail,\r\n      companyName: dto.companyName,\r\n    };\r\n  }\r\n\r\n  async updateTenantIcon(tenantId: string, iconUrl: string): Promise<void> {\r\n    await this.prisma.tenant.update({\r\n      where: { id: tenantId },\r\n      data: { iconUrl },\r\n    });\r\n  }\r\n}\r\n","export * from './lib/utils';\r\nexport * from './lib/id-generator';\r\nexport * from './lib/industries';\r\n","/**\r\n * Shared utility functions for Mentor AI\r\n * These utilities are used across both frontend (Angular) and backend (NestJS)\r\n */\r\n\r\n/** Generate a unique ID */\r\nexport function generateId(): string {\r\n  return crypto.randomUUID();\r\n}\r\n\r\n/** Check if a value is defined (not null or undefined) */\r\nexport function isDefined<T>(value: T | null | undefined): value is T {\r\n  return value !== null && value !== undefined;\r\n}\r\n\r\n/** Safely parse JSON with error handling */\r\nexport function safeJsonParse<T>(json: string, fallback: T): T {\r\n  try {\r\n    return JSON.parse(json) as T;\r\n  } catch {\r\n    return fallback;\r\n  }\r\n}\r\n\r\n/** Delay execution for specified milliseconds */\r\nexport function delay(ms: number): Promise<void> {\r\n  return new Promise((resolve) => setTimeout(resolve, ms));\r\n}\r\n\r\n/** Truncate string to specified length with ellipsis */\r\nexport function truncate(str: string, maxLength: number): string {\r\n  if (str.length <= maxLength) {\r\n    return str;\r\n  }\r\n  return str.slice(0, maxLength - 3) + '...';\r\n}\r\n","/**\r\n * Entity ID generators with prefixes\r\n * Uses cuid2 for collision-resistant, URL-safe IDs\r\n * Prefixes identify entity types: usr_ (user), tnt_ (tenant)\r\n */\r\n\r\nimport { createId } from '@paralleldrive/cuid2';\r\n\r\n/** Entity ID prefixes */\r\nexport const ID_PREFIX = {\r\n  USER: 'usr_',\r\n  TENANT: 'tnt_',\r\n  INVITATION: 'inv_',\r\n} as const;\r\n\r\n/** Generate a user ID with usr_ prefix */\r\nexport function generateUserId(): string {\r\n  return `${ID_PREFIX.USER}${createId()}`;\r\n}\r\n\r\n/** Generate a tenant ID with tnt_ prefix */\r\nexport function generateTenantId(): string {\r\n  return `${ID_PREFIX.TENANT}${createId()}`;\r\n}\r\n\r\n/** Generate an invitation ID with inv_ prefix */\r\nexport function generateInvitationId(): string {\r\n  return `${ID_PREFIX.INVITATION}${createId()}`;\r\n}\r\n\r\n/** Generate a URL-safe invite token (no prefix, used in invite links) */\r\nexport function generateInviteToken(): string {\r\n  return createId();\r\n}\r\n\r\n/** Validate that an ID has the expected prefix */\r\nexport function hasValidPrefix(\r\n  id: string,\r\n  prefix: (typeof ID_PREFIX)[keyof typeof ID_PREFIX]\r\n): boolean {\r\n  return id.startsWith(prefix);\r\n}\r\n\r\n/** Extract the raw ID without prefix */\r\nexport function stripPrefix(id: string): string {\r\n  const prefixMatch = Object.values(ID_PREFIX).find((p) => id.startsWith(p));\r\n  return prefixMatch ? id.slice(prefixMatch.length) : id;\r\n}\r\n","module.exports = require(\"@paralleldrive/cuid2\");","/**\r\n * Industry options for tenant registration\r\n * These values are used in the registration form dropdown\r\n * and validated on the backend\r\n */\r\n\r\nexport const INDUSTRIES = [\r\n  'Technology',\r\n  'Healthcare',\r\n  'Finance',\r\n  'Retail',\r\n  'Manufacturing',\r\n  'Education',\r\n  'Real Estate',\r\n  'Legal',\r\n  'Marketing',\r\n  'Consulting',\r\n  'Other',\r\n] as const;\r\n\r\nexport type Industry = (typeof INDUSTRIES)[number];\r\n\r\n/** Check if a value is a valid industry */\r\nexport function isValidIndustry(value: string): value is Industry {\r\n  return INDUSTRIES.includes(value as Industry);\r\n}\r\n","export * from './lib/prisma';\r\n","// Re-export Prisma client and types from @prisma/client\r\n// This provides a clean import path: @mentor-ai/shared/prisma\r\n// The Prisma client is generated from apps/api/prisma/schema.prisma\r\n\r\nexport {\r\n  PrismaClient,\r\n  Prisma,\r\n  TenantStatus,\r\n  UserRole,\r\n  InvitationStatus,\r\n  Department,\r\n  NoteSource,\r\n  NoteType,\r\n  NoteStatus,\r\n} from '@prisma/client';\r\n\r\n// Export generated model types\r\nexport type { Platform, TenantRegistry, Tenant, User, Invitation, Note } from '@prisma/client';\r\n","import {\r\n  IsEmail,\r\n  IsString,\r\n  MinLength,\r\n  MaxLength,\r\n  IsOptional,\r\n  IsIn,\r\n} from 'class-validator';\r\nimport { INDUSTRIES, Industry } from '@mentor-ai/shared/utils';\r\n\r\nexport class RegisterTenantDto {\r\n  @IsEmail({}, { message: 'Please provide a valid email address' })\r\n  email!: string;\r\n\r\n  @IsString()\r\n  @MinLength(2, { message: 'Company name must be at least 2 characters' })\r\n  @MaxLength(100, { message: 'Company name cannot exceed 100 characters' })\r\n  companyName!: string;\r\n\r\n  @IsString()\r\n  @IsIn(INDUSTRIES, { message: 'Please select a valid industry' })\r\n  industry!: Industry;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  @MaxLength(500, { message: 'Business description cannot exceed 500 characters' })\r\n  description?: string;\r\n}\r\n","module.exports = require(\"class-validator\");","import { Injectable, BadRequestException } from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\n/** Type for uploaded files from multer */\r\nexport interface UploadedFileType {\r\n  fieldname: string;\r\n  originalname: string;\r\n  encoding: string;\r\n  mimetype: string;\r\n  size: number;\r\n  buffer: Buffer;\r\n}\r\n\r\nexport interface FileUploadResult {\r\n  filename: string;\r\n  originalName: string;\r\n  mimeType: string;\r\n  size: number;\r\n  url: string;\r\n}\r\n\r\nexport interface FileValidationOptions {\r\n  maxSizeBytes: number;\r\n  allowedMimeTypes: string[];\r\n}\r\n\r\nconst DEFAULT_OPTIONS: FileValidationOptions = {\r\n  maxSizeBytes: 2 * 1024 * 1024, // 2MB\r\n  allowedMimeTypes: ['image/png', 'image/jpeg', 'image/jpg'],\r\n};\r\n\r\n@Injectable()\r\nexport class FileUploadService {\r\n  private readonly uploadDir: string;\r\n\r\n  constructor() {\r\n    // Use uploads directory in project root for development\r\n    this.uploadDir = path.join(process.cwd(), 'uploads', 'icons');\r\n    this.ensureUploadDirExists();\r\n  }\r\n\r\n  private ensureUploadDirExists(): void {\r\n    if (!fs.existsSync(this.uploadDir)) {\r\n      fs.mkdirSync(this.uploadDir, { recursive: true });\r\n    }\r\n  }\r\n\r\n  validateFile(\r\n    file: UploadedFileType,\r\n    options: FileValidationOptions = DEFAULT_OPTIONS\r\n  ): void {\r\n    // Check file size\r\n    if (file.size > options.maxSizeBytes) {\r\n      const maxSizeMB = options.maxSizeBytes / (1024 * 1024);\r\n      throw new BadRequestException({\r\n        type: 'validation_error',\r\n        title: 'File Too Large',\r\n        status: 400,\r\n        detail: `Please upload a PNG or JPG image under ${maxSizeMB}MB`,\r\n      });\r\n    }\r\n\r\n    // Check file type\r\n    if (!options.allowedMimeTypes.includes(file.mimetype)) {\r\n      throw new BadRequestException({\r\n        type: 'validation_error',\r\n        title: 'Invalid File Type',\r\n        status: 400,\r\n        detail: 'Please upload a PNG or JPG image under 2MB',\r\n      });\r\n    }\r\n  }\r\n\r\n  generateUniqueFilename(tenantId: string, originalName: string): string {\r\n    // Sanitize extension to prevent path traversal attacks\r\n    const rawExt = path.extname(originalName).toLowerCase();\r\n    const sanitizedExt = rawExt.replace(/[^a-z0-9.]/gi, '');\r\n    const ext = sanitizedExt.startsWith('.') ? sanitizedExt : `.${sanitizedExt}`;\r\n    const uniqueId = createId();\r\n    return `${tenantId}_${uniqueId}${ext}`;\r\n  }\r\n\r\n  async saveFile(\r\n    file: UploadedFileType,\r\n    tenantId: string,\r\n    skipValidation = false\r\n  ): Promise<FileUploadResult> {\r\n    // Validate file first (unless already validated)\r\n    if (!skipValidation) {\r\n      this.validateFile(file);\r\n    }\r\n\r\n    // Generate unique filename\r\n    const filename = this.generateUniqueFilename(tenantId, file.originalname);\r\n    const filePath = path.join(this.uploadDir, filename);\r\n\r\n    // Save file to disk\r\n    await fs.promises.writeFile(filePath, file.buffer);\r\n\r\n    return {\r\n      filename,\r\n      originalName: file.originalname,\r\n      mimeType: file.mimetype,\r\n      size: file.size,\r\n      url: `/uploads/icons/${filename}`,\r\n    };\r\n  }\r\n\r\n  async deleteFile(filename: string): Promise<void> {\r\n    const filePath = path.join(this.uploadDir, filename);\r\n    if (fs.existsSync(filePath)) {\r\n      await fs.promises.unlink(filePath);\r\n    }\r\n  }\r\n\r\n  getFilePath(filename: string): string {\r\n    return path.join(this.uploadDir, filename);\r\n  }\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { FileUploadService } from './file-upload.service';\r\n\r\n@Module({\r\n  providers: [FileUploadService],\r\n  exports: [FileUploadService],\r\n})\r\nexport class FileUploadModule {}\r\n","import { Module } from '@nestjs/common';\r\nimport { PassportModule } from '@nestjs/passport';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthController } from './auth.controller';\r\nimport { GoogleAuthController } from './google-auth.controller';\r\nimport { AuthService } from './auth.service';\r\nimport { JwtStrategy } from './strategies/jwt.strategy';\r\nimport { JwtAuthGuard } from './guards/jwt-auth.guard';\r\nimport { RolesGuard } from './guards/roles.guard';\r\nimport { MfaRequiredGuard } from './guards/mfa-required.guard';\r\n\r\n@Module({\r\n  imports: [\r\n    PassportModule.register({ defaultStrategy: 'jwt' }),\r\n    ConfigModule,\r\n    TenantModule, // Provides PlatformPrismaService\r\n  ],\r\n  controllers: [AuthController, GoogleAuthController],\r\n  providers: [\r\n    AuthService,\r\n    JwtStrategy,\r\n    JwtAuthGuard,\r\n    RolesGuard,\r\n    MfaRequiredGuard,\r\n  ],\r\n  exports: [AuthService, JwtAuthGuard, RolesGuard, MfaRequiredGuard],\r\n})\r\nexport class AuthModule {}\r\n","module.exports = require(\"@nestjs/passport\");","import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Body,\r\n  Param,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n  Headers,\r\n  BadRequestException,\r\n  UnauthorizedException,\r\n} from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { AuthService, MfaStatus, LockoutStatus } from './auth.service';\r\nimport { JwtAuthGuard } from './guards/jwt-auth.guard';\r\nimport { CurrentUser } from './decorators/current-user.decorator';\r\nimport { CurrentUserPayload } from './strategies/jwt.strategy';\r\nimport { SkipMfa } from './decorators/skip-mfa.decorator';\r\nimport { VerifyTotpDto } from './dto/verify-totp.dto';\r\nimport { EnrollMfaDto, VerifyRecoveryCodeDto } from './dto/enroll-mfa.dto';\r\nimport { Roles } from './decorators/roles.decorator';\r\nimport { RolesGuard } from './guards/roles.guard';\r\n\r\ninterface AuthCallbackResponse {\r\n  status: 'success';\r\n  message: string;\r\n  user: {\r\n    userId: string;\r\n    email: string;\r\n    tenantId: string;\r\n    role: string;\r\n  };\r\n  requiresMfaSetup: boolean;\r\n  correlationId?: string;\r\n}\r\n\r\ninterface MfaEnrollResponse {\r\n  status: 'success';\r\n  qrCodeDataUrl: string;\r\n  secret: string;\r\n  recoveryCodes: string[];\r\n  message: string;\r\n  correlationId?: string;\r\n}\r\n\r\ninterface MfaVerifyResponse {\r\n  status: 'success';\r\n  message: string;\r\n  correlationId?: string;\r\n}\r\n\r\n@Controller('auth')\r\nexport class AuthController {\r\n  constructor(private readonly authService: AuthService) {}\r\n\r\n  /**\r\n   * Auth0 callback endpoint - called after OAuth flow\r\n   * Links Auth0 identity to existing user\r\n   */\r\n  @Post('callback')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  @HttpCode(HttpStatus.OK)\r\n  async handleCallback(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<AuthCallbackResponse> {\r\n    // Check if user exists by email\r\n    const existingUser = await this.authService.findUserByEmail(user.email);\r\n\r\n    if (!existingUser) {\r\n      throw new UnauthorizedException({\r\n        type: 'user_not_found',\r\n        title: 'User Not Found',\r\n        status: 401,\r\n        detail: 'Please register before logging in',\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    // Link Auth0 ID if not already linked\r\n    if (!existingUser.auth0Id) {\r\n      await this.authService.linkAuth0Identity(existingUser.id, user.auth0Id);\r\n\r\n      // Update tenant status to ONBOARDING after first OAuth\r\n      if (existingUser.tenant.status === 'DRAFT') {\r\n        await this.authService.updateTenantStatusToOnboarding(existingUser.tenantId);\r\n      }\r\n    }\r\n\r\n    // Check MFA status\r\n    const mfaStatus = await this.authService.getMfaStatus(existingUser.id);\r\n\r\n    const response: AuthCallbackResponse = {\r\n      status: 'success',\r\n      message: mfaStatus.enabled\r\n        ? 'Authentication successful'\r\n        : 'Authentication successful. Please set up 2FA.',\r\n      user: {\r\n        userId: existingUser.id,\r\n        email: existingUser.email,\r\n        tenantId: existingUser.tenantId,\r\n        role: existingUser.role,\r\n      },\r\n      requiresMfaSetup: !mfaStatus.enabled,\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Get current user's MFA status\r\n   */\r\n  @Get('2fa/status')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  async getMfaStatus(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaStatus & { correlationId?: string }> {\r\n    const status = await this.authService.getMfaStatus(user.userId);\r\n    return { ...status, correlationId };\r\n  }\r\n\r\n  /**\r\n   * Initiate MFA enrollment - generates secret and QR code\r\n   */\r\n  @Post('2fa/enroll')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  @HttpCode(HttpStatus.OK)\r\n  async enrollMfa(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaEnrollResponse> {\r\n    // Check if already enrolled\r\n    const status = await this.authService.getMfaStatus(user.userId);\r\n    if (status.enabled) {\r\n      throw new BadRequestException({\r\n        type: 'mfa_already_enabled',\r\n        title: 'MFA Already Enabled',\r\n        status: 400,\r\n        detail: 'Two-factor authentication is already enabled for your account',\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    // Generate recovery codes and TOTP secret\r\n    const { codes, hashedCodes } = await this.authService.generateRecoveryCodes();\r\n    const secret = `MENTOR${createId().slice(0, 12).toUpperCase()}`;\r\n\r\n    // Generate QR code URL (otpauth format)\r\n    const appName = 'MentorAI';\r\n    const qrCodeDataUrl = `otpauth://totp/${appName}:${user.email}?secret=${secret}&issuer=${appName}`;\r\n\r\n    // Persist secret and hashed recovery codes to DB during enrollment\r\n    await this.authService.storePendingMfaEnrollment(\r\n      user.userId,\r\n      secret,\r\n      hashedCodes\r\n    );\r\n\r\n    const response: MfaEnrollResponse = {\r\n      status: 'success',\r\n      qrCodeDataUrl,\r\n      secret,\r\n      recoveryCodes: codes,\r\n      message: 'Scan the QR code with your authenticator app and enter the code to verify',\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Verify TOTP code and complete MFA enrollment\r\n   */\r\n  @Post('2fa/verify')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  @HttpCode(HttpStatus.OK)\r\n  async verifyMfaEnrollment(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: EnrollMfaDto,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaVerifyResponse> {\r\n    // Verify the TOTP code against stored secret\r\n    const secret = await this.authService.getMfaSecret(user.userId);\r\n    if (!secret) {\r\n      throw new BadRequestException({\r\n        type: 'mfa_not_enrolled',\r\n        title: 'MFA Not Enrolled',\r\n        status: 400,\r\n        detail: 'Please initiate MFA enrollment first',\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    // Validate code format (6-digit numeric)\r\n    const isValidFormat = dto.code.length === 6 && /^\\d{6}$/.test(dto.code);\r\n    if (!isValidFormat) {\r\n      throw new BadRequestException({\r\n        type: 'invalid_totp_format',\r\n        title: 'Invalid Code Format',\r\n        status: 400,\r\n        detail: 'Verification code must be a 6-digit number',\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    // TODO: Implement proper TOTP verification with otplib\r\n    // For MVP, accept any valid-format 6-digit code\r\n    // In production: authenticator.verify({ token: dto.code, secret })\r\n\r\n    // Enable MFA for user (recovery codes already stored during enrollment)\r\n    await this.authService.enableMfa(user.userId);\r\n\r\n    const response: MfaVerifyResponse = {\r\n      status: 'success',\r\n      message: 'Two-factor authentication has been enabled successfully',\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Verify TOTP code during login\r\n   */\r\n  @Post('2fa/verify-login')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  @HttpCode(HttpStatus.OK)\r\n  async verifyLoginTotp(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: VerifyTotpDto,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaVerifyResponse> {\r\n    // Check if account is locked\r\n    await this.authService.checkAccountLocked(user.userId);\r\n\r\n    // Validate code format (6-digit numeric)\r\n    const isValidFormat = dto.code.length === 6 && /^\\d{6}$/.test(dto.code);\r\n\r\n    // TODO: Implement proper TOTP verification with otplib\r\n    // For MVP, accept any valid-format 6-digit code\r\n    // In production: authenticator.verify({ token: dto.code, secret })\r\n    const secret = await this.authService.getMfaSecret(user.userId);\r\n    const isValidCode = isValidFormat && !!secret;\r\n\r\n    if (!isValidCode) {\r\n      const lockoutStatus = await this.authService.recordFailedAttempt(user.userId);\r\n\r\n      throw new UnauthorizedException({\r\n        type: 'invalid_totp',\r\n        title: 'Invalid Verification Code',\r\n        status: 401,\r\n        detail: lockoutStatus.locked\r\n          ? 'Your account has been locked due to too many failed attempts'\r\n          : `The verification code you entered is incorrect. You have ${lockoutStatus.attemptsRemaining} attempts remaining.`,\r\n        attemptsRemaining: lockoutStatus.attemptsRemaining,\r\n        locked: lockoutStatus.locked,\r\n        lockoutUntil: lockoutStatus.lockoutUntil?.toISOString(),\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    // Reset failed attempts on success\r\n    await this.authService.resetFailedAttempts(user.userId);\r\n\r\n    const response: MfaVerifyResponse = {\r\n      status: 'success',\r\n      message: 'Verification successful',\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Verify recovery code\r\n   */\r\n  @Post('2fa/recovery')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  @HttpCode(HttpStatus.OK)\r\n  async verifyRecoveryCode(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: VerifyRecoveryCodeDto,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaVerifyResponse> {\r\n    const result = await this.authService.verifyRecoveryCode(\r\n      user.userId,\r\n      dto.recoveryCode\r\n    );\r\n\r\n    if (!result.valid) {\r\n      throw new UnauthorizedException({\r\n        type: 'invalid_recovery_code',\r\n        title: 'Invalid Recovery Code',\r\n        status: 401,\r\n        detail: 'The recovery code you entered is invalid or has already been used',\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    const response: MfaVerifyResponse = {\r\n      status: 'success',\r\n      message: 'Recovery code verified. You are now logged in.',\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Get account lockout status\r\n   */\r\n  @Get('lockout-status')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  async getLockoutStatus(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<LockoutStatus & { correlationId?: string }> {\r\n    const status = await this.authService.getLockoutStatus(user.userId);\r\n    return { ...status, correlationId };\r\n  }\r\n\r\n  /**\r\n   * Unlock account (admin only)\r\n   */\r\n  @Post('unlock/:userId')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('PLATFORM_OWNER', 'TENANT_OWNER')\r\n  @HttpCode(HttpStatus.OK)\r\n  async unlockAccount(\r\n    @Param('userId') targetUserId: string,\r\n    @CurrentUser() admin: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaVerifyResponse> {\r\n    await this.authService.unlockAccount(targetUserId);\r\n\r\n    const response: MfaVerifyResponse = {\r\n      status: 'success',\r\n      message: 'Account has been unlocked',\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Logout endpoint - invalidates session\r\n   */\r\n  @Post('logout')\r\n  @UseGuards(JwtAuthGuard)\r\n  @SkipMfa()\r\n  @HttpCode(HttpStatus.OK)\r\n  async logout(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<MfaVerifyResponse> {\r\n    // In production, you would invalidate the session in Redis\r\n    // For now, Auth0 handles session invalidation on the frontend\r\n\r\n    const response: MfaVerifyResponse = {\r\n      status: 'success',\r\n      message: 'Logged out successfully',\r\n    };\r\n\r\n    if (correlationId) {\r\n      response.correlationId = correlationId;\r\n    }\r\n\r\n    return response;\r\n  }\r\n}\r\n","import {\r\n  Injectable,\r\n  ForbiddenException,\r\n  UnauthorizedException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport * as bcrypt from 'bcrypt';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\n\r\nexport interface MfaStatus {\r\n  enabled: boolean;\r\n  enrolledAt?: Date;\r\n}\r\n\r\nexport interface MfaEnrollmentResult {\r\n  secret: string;\r\n  qrCodeUrl: string;\r\n  recoveryCodes: string[];\r\n}\r\n\r\nexport interface LockoutStatus {\r\n  locked: boolean;\r\n  lockoutUntil?: Date;\r\n  attemptsRemaining: number;\r\n}\r\n\r\nexport const MAX_FAILED_ATTEMPTS = 5;\r\nexport const LOCKOUT_DURATION_MINUTES = 15;\r\nconst BCRYPT_SALT_ROUNDS = 10;\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    private readonly configService: ConfigService,\r\n    private readonly prisma: PlatformPrismaService\r\n  ) {}\r\n\r\n  /**\r\n   * Get MFA status for a user\r\n   */\r\n  async getMfaStatus(userId: string): Promise<MfaStatus> {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { mfaEnabled: true, updatedAt: true },\r\n    });\r\n\r\n    if (!user) {\r\n      return { enabled: false };\r\n    }\r\n\r\n    return {\r\n      enabled: user.mfaEnabled,\r\n      enrolledAt: user.mfaEnabled ? user.updatedAt : undefined,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get account lockout status\r\n   */\r\n  async getLockoutStatus(userId: string): Promise<LockoutStatus> {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { failedLoginAttempts: true, lockoutUntil: true },\r\n    });\r\n\r\n    if (!user) {\r\n      return { locked: false, attemptsRemaining: MAX_FAILED_ATTEMPTS };\r\n    }\r\n\r\n    const now = new Date();\r\n    const isLocked = user.lockoutUntil && user.lockoutUntil > now;\r\n\r\n    if (isLocked) {\r\n      return {\r\n        locked: true,\r\n        lockoutUntil: user.lockoutUntil!,\r\n        attemptsRemaining: 0,\r\n      };\r\n    }\r\n\r\n    // If lockout has expired, reset attempts\r\n    if (user.lockoutUntil && user.lockoutUntil <= now) {\r\n      await this.resetFailedAttempts(userId);\r\n      return { locked: false, attemptsRemaining: MAX_FAILED_ATTEMPTS };\r\n    }\r\n\r\n    return {\r\n      locked: false,\r\n      attemptsRemaining: MAX_FAILED_ATTEMPTS - user.failedLoginAttempts,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check if account is locked\r\n   */\r\n  async checkAccountLocked(userId: string): Promise<void> {\r\n    const status = await this.getLockoutStatus(userId);\r\n\r\n    if (status.locked) {\r\n      throw new ForbiddenException({\r\n        type: 'account_locked',\r\n        title: 'Account Temporarily Locked',\r\n        status: 403,\r\n        detail: `Your account has been locked due to too many failed login attempts. Please try again in ${LOCKOUT_DURATION_MINUTES} minutes.`,\r\n        lockoutUntil: status.lockoutUntil?.toISOString(),\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Record a failed login attempt\r\n   */\r\n  async recordFailedAttempt(userId: string): Promise<LockoutStatus> {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { failedLoginAttempts: true, email: true },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new UnauthorizedException('User not found');\r\n    }\r\n\r\n    const newAttempts = user.failedLoginAttempts + 1;\r\n\r\n    if (newAttempts >= MAX_FAILED_ATTEMPTS) {\r\n      // Lock the account\r\n      const lockoutUntil = new Date();\r\n      lockoutUntil.setMinutes(lockoutUntil.getMinutes() + LOCKOUT_DURATION_MINUTES);\r\n\r\n      await this.prisma.user.update({\r\n        where: { id: userId },\r\n        data: {\r\n          failedLoginAttempts: newAttempts,\r\n          lockoutUntil,\r\n        },\r\n      });\r\n\r\n      // TODO: Send email notification about account lockout\r\n      // await this.sendLockoutNotification(user.email);\r\n\r\n      return {\r\n        locked: true,\r\n        lockoutUntil,\r\n        attemptsRemaining: 0,\r\n      };\r\n    }\r\n\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { failedLoginAttempts: newAttempts },\r\n    });\r\n\r\n    return {\r\n      locked: false,\r\n      attemptsRemaining: MAX_FAILED_ATTEMPTS - newAttempts,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Reset failed login attempts after successful login\r\n   */\r\n  async resetFailedAttempts(userId: string): Promise<void> {\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        failedLoginAttempts: 0,\r\n        lockoutUntil: null,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Generate 8 recovery codes\r\n   */\r\n  async generateRecoveryCodes(): Promise<{\r\n    codes: string[];\r\n    hashedCodes: string[];\r\n  }> {\r\n    const codes: string[] = [];\r\n    const hashedCodes: string[] = [];\r\n\r\n    for (let i = 0; i < 8; i++) {\r\n      // Generate 10-character alphanumeric code\r\n      const code = createId().slice(0, 10).toUpperCase();\r\n      codes.push(code);\r\n      hashedCodes.push(await bcrypt.hash(code, BCRYPT_SALT_ROUNDS));\r\n    }\r\n\r\n    return { codes, hashedCodes };\r\n  }\r\n\r\n  /**\r\n   * Verify a recovery code\r\n   */\r\n  async verifyRecoveryCode(\r\n    userId: string,\r\n    code: string\r\n  ): Promise<{ valid: boolean; usedIndex: number }> {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { recoveryCodesHash: true },\r\n    });\r\n\r\n    if (!user || !user.recoveryCodesHash.length) {\r\n      return { valid: false, usedIndex: -1 };\r\n    }\r\n\r\n    for (let i = 0; i < user.recoveryCodesHash.length; i++) {\r\n      const hashedCode = user.recoveryCodesHash[i];\r\n      if (!hashedCode) continue;\r\n      const isValid = await bcrypt.compare(code, hashedCode);\r\n      if (isValid) {\r\n        // Remove the used recovery code\r\n        const updatedCodes = [...user.recoveryCodesHash];\r\n        updatedCodes.splice(i, 1);\r\n\r\n        await this.prisma.user.update({\r\n          where: { id: userId },\r\n          data: { recoveryCodesHash: updatedCodes },\r\n        });\r\n\r\n        // Reset failed attempts on successful recovery\r\n        await this.resetFailedAttempts(userId);\r\n\r\n        return { valid: true, usedIndex: i };\r\n      }\r\n    }\r\n\r\n    return { valid: false, usedIndex: -1 };\r\n  }\r\n\r\n  /**\r\n   * Store pending MFA enrollment data (secret + recovery codes)\r\n   */\r\n  async storePendingMfaEnrollment(\r\n    userId: string,\r\n    secret: string,\r\n    hashedRecoveryCodes: string[]\r\n  ): Promise<void> {\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        mfaSecret: secret,\r\n        recoveryCodesHash: hashedRecoveryCodes,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Enable MFA for a user (called after successful TOTP verification)\r\n   */\r\n  async enableMfa(userId: string): Promise<void> {\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { mfaEnabled: true },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get stored TOTP secret for verification\r\n   */\r\n  async getMfaSecret(userId: string): Promise<string | null> {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { mfaSecret: true },\r\n    });\r\n    return user?.mfaSecret ?? null;\r\n  }\r\n\r\n  /**\r\n   * Link Auth0 identity to user\r\n   */\r\n  async linkAuth0Identity(userId: string, auth0Id: string): Promise<void> {\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { auth0Id },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Find user by Auth0 ID\r\n   */\r\n  async findUserByAuth0Id(auth0Id: string) {\r\n    return this.prisma.user.findUnique({\r\n      where: { auth0Id },\r\n      include: { tenant: true },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Find user by email\r\n   */\r\n  async findUserByEmail(email: string) {\r\n    return this.prisma.user.findUnique({\r\n      where: { email },\r\n      include: { tenant: true },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update tenant status after first OAuth\r\n   */\r\n  async updateTenantStatusToOnboarding(tenantId: string): Promise<void> {\r\n    await this.prisma.tenant.update({\r\n      where: { id: tenantId },\r\n      data: { status: 'ONBOARDING' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unlock a user account (admin function)\r\n   */\r\n  async unlockAccount(userId: string): Promise<void> {\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        failedLoginAttempts: 0,\r\n        lockoutUntil: null,\r\n      },\r\n    });\r\n  }\r\n}\r\n","module.exports = require(\"bcrypt\");","import { ExecutionContext, Injectable, Logger, UnauthorizedException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { AuthGuard } from '@nestjs/passport';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { IS_PUBLIC_KEY } from '../decorators/public.decorator';\r\nimport { PrismaClient } from '@mentor-ai/shared/prisma';\r\n\r\n/** Static fallback when no active tenant exists yet (fresh DB) */\r\nconst DEV_USER_FALLBACK = {\r\n  userId: 'dev-user-001',\r\n  tenantId: 'dev-tenant-001',\r\n  email: 'dev@mentor-ai.local',\r\n  role: 'PLATFORM_OWNER' as const,\r\n  department: null as string | null,\r\n  permissions: ['*'],\r\n};\r\n\r\n@Injectable()\r\nexport class JwtAuthGuard extends AuthGuard('jwt') {\r\n  private readonly logger = new Logger(JwtAuthGuard.name);\r\n  /** Cached dev user resolved from DB (avoids repeat queries) */\r\n  private resolvedDevUser: typeof DEV_USER_FALLBACK | null = null;\r\n\r\n  constructor(\r\n    private reflector: Reflector,\r\n    private configService: ConfigService\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    // Check if route is marked as public\r\n    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [\r\n      context.getHandler(),\r\n      context.getClass(),\r\n    ]);\r\n\r\n    if (isPublic) {\r\n      return true;\r\n    }\r\n\r\n    const devMode = this.configService.get<string>('DEV_MODE') === 'true';\r\n\r\n    if (devMode) {\r\n      const request = context.switchToHttp().getRequest();\r\n      const authHeader = request.headers?.authorization as string | undefined;\r\n\r\n      // If a real Bearer token is present (not the dev-mode-token placeholder),\r\n      // validate it AND verify the user still exists in DB\r\n      if (authHeader?.startsWith('Bearer ') && !authHeader.includes('dev-mode-token')) {\r\n        try {\r\n          const result = await (super.canActivate(context) as Promise<boolean>);\r\n          if (result && request.user) {\r\n            // Verify user still exists in DB (may have been deleted after cleanup)\r\n            const userExists = await this.verifyUserExists(request.user.userId);\r\n            if (userExists) {\r\n              this.logger.debug(`Dev mode: authenticated real user ${request.user.email}`);\r\n              return true;\r\n            }\r\n            // User deleted from DB  fall through to dev user instead of rejecting\r\n            this.logger.warn({\r\n              message: 'JWT valid but user not found in DB  falling back to dev user',\r\n              userId: request.user.userId,\r\n            });\r\n            // Clear cached dev user so it re-resolves from current DB state\r\n            this.resolvedDevUser = null;\r\n          }\r\n        } catch (err) {\r\n          if (err instanceof UnauthorizedException) throw err;\r\n          // Token invalid or expired - fall back to dev user\r\n          this.logger.debug('Dev mode: JWT validation failed, using dev user fallback');\r\n        }\r\n      }\r\n\r\n      // No token or validation failed  resolve dev user from DB\r\n      request.user = await this.getDevUser();\r\n      return true;\r\n    }\r\n\r\n    // Production mode: validate JWT and verify user exists\r\n    const result = await (super.canActivate(context) as Promise<boolean>);\r\n    if (result) {\r\n      const request = context.switchToHttp().getRequest();\r\n      if (request.user?.userId) {\r\n        const userExists = await this.verifyUserExists(request.user.userId);\r\n        if (!userExists) {\r\n          throw new UnauthorizedException({\r\n            type: 'user_not_found',\r\n            title: 'Session Expired',\r\n            status: 401,\r\n            detail: 'Your session is no longer valid. Please log in again.',\r\n          });\r\n        }\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Verifies that a user exists in the DB. Returns false if deleted.\r\n   * Uses a short-lived PrismaClient to avoid DI dependency issues.\r\n   */\r\n  private async verifyUserExists(userId: string): Promise<boolean> {\r\n    const prisma = new PrismaClient();\r\n    try {\r\n      const user = await prisma.user.findUnique({\r\n        where: { id: userId },\r\n        select: { id: true },\r\n      });\r\n      return user !== null;\r\n    } catch {\r\n      // DB error  allow through to avoid blocking on transient failures\r\n      return true;\r\n    } finally {\r\n      await prisma.$disconnect();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resolves a real active tenant and its owner for dev mode.\r\n   * Uses a standalone PrismaClient to avoid DI module dependency issues.\r\n   * Falls back to static IDs if no active tenant exists yet.\r\n   * Result is cached so DB is only queried once per server start.\r\n   */\r\n  private async getDevUser(): Promise<typeof DEV_USER_FALLBACK> {\r\n    if (this.resolvedDevUser) return this.resolvedDevUser;\r\n\r\n    const prisma = new PrismaClient();\r\n    try {\r\n      const tenant = await prisma.tenant.findFirst({\r\n        where: { status: 'ACTIVE' },\r\n        orderBy: { createdAt: 'desc' },\r\n        select: { id: true },\r\n      });\r\n\r\n      if (tenant) {\r\n        const user = await prisma.user.findFirst({\r\n          where: { tenantId: tenant.id, isActive: true },\r\n          orderBy: { createdAt: 'asc' },\r\n          select: { id: true, email: true, role: true, department: true },\r\n        });\r\n\r\n        if (user) {\r\n          this.resolvedDevUser = {\r\n            userId: user.id,\r\n            tenantId: tenant.id,\r\n            email: user.email,\r\n            role: 'PLATFORM_OWNER' as const,\r\n            department: user.department,\r\n            permissions: ['*'],\r\n          };\r\n          this.logger.log({\r\n            message: 'Dev mode: resolved real tenant/user',\r\n            tenantId: tenant.id,\r\n            userId: user.id,\r\n          });\r\n          return this.resolvedDevUser;\r\n        }\r\n      }\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Dev mode: failed to resolve tenant, using fallback',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    } finally {\r\n      await prisma.$disconnect();\r\n    }\r\n\r\n    this.resolvedDevUser = DEV_USER_FALLBACK;\r\n    return this.resolvedDevUser;\r\n  }\r\n\r\n  handleRequest<TUser>(err: Error | null, user: TUser, info: Error): TUser {\r\n    if (err || !user) {\r\n      throw (\r\n        err ||\r\n        new UnauthorizedException({\r\n          type: 'unauthorized',\r\n          title: 'Authentication Required',\r\n          status: 401,\r\n          detail: info?.message || 'You must be logged in to access this resource',\r\n        })\r\n      );\r\n    }\r\n    return user;\r\n  }\r\n}\r\n","import { SetMetadata } from '@nestjs/common';\r\n\r\nexport const IS_PUBLIC_KEY = 'isPublic';\r\n\r\nexport const Public = () => SetMetadata(IS_PUBLIC_KEY, true);\r\n","import { createParamDecorator, ExecutionContext } from '@nestjs/common';\r\nimport { CurrentUserPayload } from '../strategies/jwt.strategy';\r\n\r\nexport const CurrentUser = createParamDecorator(\r\n  (data: keyof CurrentUserPayload | undefined, ctx: ExecutionContext) => {\r\n    const request = ctx.switchToHttp().getRequest();\r\n    const user: CurrentUserPayload = request.user;\r\n\r\n    if (!user) {\r\n      return null;\r\n    }\r\n\r\n    return data ? user[data] : user;\r\n  }\r\n);\r\n","import { Injectable, UnauthorizedException } from '@nestjs/common';\r\nimport { PassportStrategy } from '@nestjs/passport';\r\nimport { ExtractJwt, Strategy } from 'passport-jwt';\r\nimport { ConfigService } from '@nestjs/config';\r\n\r\nexport interface JwtPayload {\r\n  sub: string;\r\n  email: string;\r\n  tenantId: string;\r\n  role: string;\r\n  userId: string;\r\n  department?: string | null;\r\n  iat: number;\r\n  exp: number;\r\n}\r\n\r\nexport interface CurrentUserPayload {\r\n  userId: string;\r\n  tenantId: string;\r\n  role: 'PLATFORM_OWNER' | 'TENANT_OWNER' | 'ADMIN' | 'MEMBER';\r\n  email: string;\r\n  auth0Id: string;\r\n  department: string | null; // Business Brain domain isolation (Story 3.2)\r\n}\r\n\r\n@Injectable()\r\nexport class JwtStrategy extends PassportStrategy(Strategy) {\r\n  constructor(private readonly configService: ConfigService) {\r\n    const jwtSecret = configService.get<string>('JWT_SECRET');\r\n\r\n    if (!jwtSecret) {\r\n      throw new Error('JWT_SECRET environment variable is not set');\r\n    }\r\n\r\n    super({\r\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\r\n      secretOrKey: jwtSecret,\r\n      algorithms: ['HS256'],\r\n    });\r\n  }\r\n\r\n  validate(payload: JwtPayload): CurrentUserPayload {\r\n    if (!payload.sub) {\r\n      throw new UnauthorizedException('Invalid token: missing subject');\r\n    }\r\n\r\n    return {\r\n      userId: payload.userId || payload.sub,\r\n      tenantId: payload.tenantId || '',\r\n      role: (payload.role as CurrentUserPayload['role']) || 'MEMBER',\r\n      email: payload.email,\r\n      auth0Id: payload.sub,\r\n      department: payload.department ?? null,\r\n    };\r\n  }\r\n}\r\n","module.exports = require(\"passport-jwt\");","import { SetMetadata } from '@nestjs/common';\r\n\r\nexport const SKIP_MFA_KEY = 'skipMfa';\r\n\r\nexport const SkipMfa = () => SetMetadata(SKIP_MFA_KEY, true);\r\n","import { IsString, Length, Matches } from 'class-validator';\r\n\r\nexport class VerifyTotpDto {\r\n  @IsString()\r\n  @Length(6, 6, { message: 'TOTP code must be exactly 6 digits' })\r\n  @Matches(/^\\d{6}$/, { message: 'TOTP code must contain only digits' })\r\n  code!: string;\r\n}\r\n","import { IsString, Length, Matches, IsOptional } from 'class-validator';\r\n\r\nexport class EnrollMfaDto {\r\n  @IsString()\r\n  @Length(6, 6, { message: 'TOTP code must be exactly 6 digits' })\r\n  @Matches(/^\\d{6}$/, { message: 'TOTP code must contain only digits' })\r\n  code!: string;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  secret?: string;\r\n}\r\n\r\nexport class VerifyRecoveryCodeDto {\r\n  @IsString()\r\n  @Length(10, 10, { message: 'Recovery code must be exactly 10 characters' })\r\n  @Matches(/^[A-Z0-9]{10}$/, { message: 'Invalid recovery code format' })\r\n  recoveryCode!: string;\r\n}\r\n","import { SetMetadata } from '@nestjs/common';\r\n\r\nexport const ROLES_KEY = 'roles';\r\n\r\nexport type Role = 'PLATFORM_OWNER' | 'TENANT_OWNER' | 'ADMIN' | 'MEMBER';\r\n\r\nexport const Roles = (...roles: Role[]) => SetMetadata(ROLES_KEY, roles);\r\n","import {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { ROLES_KEY } from '../decorators/roles.decorator';\r\nimport { CurrentUserPayload } from '../strategies/jwt.strategy';\r\n\r\n@Injectable()\r\nexport class RolesGuard implements CanActivate {\r\n  constructor(private reflector: Reflector) {}\r\n\r\n  canActivate(context: ExecutionContext): boolean {\r\n    const requiredRoles = this.reflector.getAllAndOverride<string[]>(\r\n      ROLES_KEY,\r\n      [context.getHandler(), context.getClass()]\r\n    );\r\n\r\n    if (!requiredRoles || requiredRoles.length === 0) {\r\n      return true;\r\n    }\r\n\r\n    const request = context.switchToHttp().getRequest();\r\n    const user: CurrentUserPayload = request.user;\r\n\r\n    if (!user) {\r\n      throw new ForbiddenException({\r\n        type: 'forbidden',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have permission to access this resource',\r\n      });\r\n    }\r\n\r\n    const hasRole = requiredRoles.some((role) => user.role === role);\r\n\r\n    if (!hasRole) {\r\n      throw new ForbiddenException({\r\n        type: 'insufficient_permissions',\r\n        title: 'Insufficient Permissions',\r\n        status: 403,\r\n        detail: `This action requires one of the following roles: ${requiredRoles.join(', ')}`,\r\n      });\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import {\r\n  Controller,\r\n  Post,\r\n  Body,\r\n  HttpCode,\r\n  HttpStatus,\r\n  BadRequestException,\r\n  UnauthorizedException,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { IsString, IsNotEmpty } from 'class-validator';\r\nimport axios from 'axios';\r\nimport * as jwt from 'jsonwebtoken';\r\nimport { AuthService } from './auth.service';\r\nimport { Public } from './decorators/public.decorator';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { generateUserId, generateTenantId } from '@mentor-ai/shared/utils';\r\nimport { TenantStatus, UserRole } from '@mentor-ai/shared/prisma';\r\n\r\ninterface GoogleTokenResponse {\r\n  access_token: string;\r\n  id_token: string;\r\n  expires_in: number;\r\n  token_type: string;\r\n  scope: string;\r\n  refresh_token?: string;\r\n}\r\n\r\ninterface GoogleIdTokenPayload {\r\n  sub: string;\r\n  email: string;\r\n  email_verified: boolean;\r\n  name: string;\r\n  picture: string;\r\n  given_name?: string;\r\n  family_name?: string;\r\n}\r\n\r\nclass GoogleCallbackDto {\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  code!: string;\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  redirectUri!: string;\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  codeVerifier!: string;\r\n}\r\n\r\n@Controller('auth')\r\nexport class GoogleAuthController {\r\n  private readonly logger = new Logger(GoogleAuthController.name);\r\n\r\n  constructor(\r\n    private readonly configService: ConfigService,\r\n    private readonly authService: AuthService,\r\n    private readonly prisma: PlatformPrismaService\r\n  ) {}\r\n\r\n  /**\r\n   * Google OAuth callback - exchanges auth code for tokens and creates session\r\n   */\r\n  @Post('google/callback')\r\n  @Public()\r\n  @HttpCode(HttpStatus.OK)\r\n  async handleGoogleCallback(@Body() dto: GoogleCallbackDto) {\r\n    const { code, redirectUri, codeVerifier } = dto;\r\n\r\n    this.logger.log({\r\n      message: 'Google callback received',\r\n      hasCode: !!code,\r\n      redirectUri,\r\n      hasCodeVerifier: !!codeVerifier,\r\n      codeLength: code?.length ?? 0,\r\n    });\r\n\r\n    if (!code) {\r\n      throw new BadRequestException({\r\n        type: 'missing_auth_code',\r\n        title: 'Bad Request',\r\n        status: 400,\r\n        detail: 'Authorization code is required. The Google OAuth redirect may have failed.',\r\n      });\r\n    }\r\n\r\n    const clientId = this.configService.get<string>('GOOGLE_CLIENT_ID');\r\n    const clientSecret = this.configService.get<string>('GOOGLE_CLIENT_SECRET');\r\n    const jwtSecret = this.configService.get<string>('JWT_SECRET');\r\n\r\n    if (!clientId || !jwtSecret) {\r\n      throw new BadRequestException('Google OAuth is not configured on the server');\r\n    }\r\n\r\n    // Exchange authorization code for tokens\r\n    let tokenData: GoogleTokenResponse;\r\n    try {\r\n      const tokenParams: Record<string, string> = {\r\n        code,\r\n        client_id: clientId,\r\n        redirect_uri: redirectUri,\r\n        grant_type: 'authorization_code',\r\n        code_verifier: codeVerifier,\r\n      };\r\n\r\n      // Include client_secret if available (required for Web app type)\r\n      if (clientSecret && clientSecret !== 'REPLACE_WITH_YOUR_GOOGLE_CLIENT_SECRET') {\r\n        tokenParams.client_secret = clientSecret;\r\n      }\r\n\r\n      const response = await axios.post<GoogleTokenResponse>(\r\n        'https://oauth2.googleapis.com/token',\r\n        new URLSearchParams(tokenParams).toString(),\r\n        {\r\n          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n        }\r\n      );\r\n      tokenData = response.data;\r\n    } catch (error: any) {\r\n      const googleError = error?.response?.data;\r\n      this.logger.error({\r\n        message: 'Google token exchange failed',\r\n        googleError,\r\n        httpStatus: error?.response?.status,\r\n        errorMessage: error?.message,\r\n      });\r\n\r\n      // Pass Google-specific error details so the frontend can show actionable info\r\n      const googleErrorCode = googleError?.error ?? 'unknown';\r\n      const googleErrorDesc = googleError?.error_description ?? error?.message ?? 'Unknown error';\r\n\r\n      throw new UnauthorizedException({\r\n        type: 'google_token_exchange_failed',\r\n        title: 'Google Authentication Failed',\r\n        status: 401,\r\n        detail: `Google OAuth error: ${googleErrorCode}  ${googleErrorDesc}`,\r\n      });\r\n    }\r\n\r\n    // Decode the ID token to get user info\r\n    const idTokenPayload = jwt.decode(tokenData.id_token) as GoogleIdTokenPayload | null;\r\n    if (!idTokenPayload || !idTokenPayload.email) {\r\n      throw new UnauthorizedException('Invalid Google ID token');\r\n    }\r\n\r\n    // Find existing user by email\r\n    const existingUser = await this.authService.findUserByEmail(idTokenPayload.email);\r\n\r\n    let user: {\r\n      userId: string;\r\n      email: string;\r\n      tenantId: string;\r\n      role: string;\r\n      department: string | null;\r\n    };\r\n\r\n    if (existingUser) {\r\n      // Link Google ID if not already linked\r\n      if (!existingUser.auth0Id) {\r\n        await this.authService.linkAuth0Identity(existingUser.id, idTokenPayload.sub);\r\n\r\n        if (existingUser.tenant.status === 'DRAFT') {\r\n          await this.authService.updateTenantStatusToOnboarding(existingUser.tenantId);\r\n        }\r\n      }\r\n\r\n      user = {\r\n        userId: existingUser.id,\r\n        email: existingUser.email,\r\n        tenantId: existingUser.tenantId,\r\n        role: existingUser.role,\r\n        department: existingUser.department ?? null,\r\n      };\r\n    } else {\r\n      // New user  auto-register with ONBOARDING status\r\n      const tenantId = generateTenantId();\r\n      const userId = generateUserId();\r\n      const normalizedEmail = idTokenPayload.email.toLowerCase();\r\n      const displayName = idTokenPayload.name || normalizedEmail.split('@')[0] || 'My Company';\r\n\r\n      await this.prisma.$transaction(async (tx) => {\r\n        await tx.tenant.create({\r\n          data: {\r\n            id: tenantId,\r\n            name: displayName,\r\n            industry: 'General',\r\n            status: TenantStatus.ONBOARDING,\r\n          },\r\n        });\r\n\r\n        await tx.user.create({\r\n          data: {\r\n            id: userId,\r\n            email: normalizedEmail,\r\n            auth0Id: idTokenPayload.sub,\r\n            role: UserRole.TENANT_OWNER,\r\n            tenantId,\r\n          },\r\n        });\r\n      });\r\n\r\n      this.logger.log({\r\n        message: 'New user auto-registered via Google OAuth',\r\n        userId,\r\n        tenantId,\r\n        email: normalizedEmail,\r\n      });\r\n\r\n      user = {\r\n        userId,\r\n        email: normalizedEmail,\r\n        tenantId,\r\n        role: UserRole.TENANT_OWNER,\r\n        department: null,\r\n      };\r\n    }\r\n\r\n    // MFA is currently disabled  skip MFA check entirely\r\n    const requiresMfaSetup = false;\r\n\r\n    // Sign our own JWT\r\n    const appToken = jwt.sign(\r\n      {\r\n        sub: idTokenPayload.sub,\r\n        email: user.email,\r\n        userId: user.userId,\r\n        tenantId: user.tenantId,\r\n        role: user.role,\r\n        department: user.department,\r\n      },\r\n      jwtSecret,\r\n      { expiresIn: '24h', algorithm: 'HS256' }\r\n    );\r\n\r\n    return {\r\n      status: 'success',\r\n      message: requiresMfaSetup\r\n        ? 'Authentication successful. Please set up 2FA.'\r\n        : 'Authentication successful',\r\n      user,\r\n      token: appToken,\r\n      requiresMfaSetup,\r\n    };\r\n  }\r\n}\r\n","module.exports = require(\"axios\");","module.exports = require(\"jsonwebtoken\");","import {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { SKIP_MFA_KEY } from '../decorators/skip-mfa.decorator';\r\nimport { AuthService } from '../auth.service';\r\nimport { CurrentUserPayload } from '../strategies/jwt.strategy';\r\n\r\n@Injectable()\r\nexport class MfaRequiredGuard implements CanActivate {\r\n  constructor(\r\n    private reflector: Reflector,\r\n    private authService: AuthService,\r\n    private configService: ConfigService\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    // Dev mode bypass - skip MFA check for local development\r\n    if (this.configService.get<string>('DEV_MODE') === 'true') {\r\n      return true;\r\n    }\r\n\r\n    // Check if MFA check should be skipped for this route\r\n    const skipMfa = this.reflector.getAllAndOverride<boolean>(SKIP_MFA_KEY, [\r\n      context.getHandler(),\r\n      context.getClass(),\r\n    ]);\r\n\r\n    if (skipMfa) {\r\n      return true;\r\n    }\r\n\r\n    const request = context.switchToHttp().getRequest();\r\n    const user: CurrentUserPayload = request.user;\r\n\r\n    if (!user) {\r\n      return true; // Let JwtAuthGuard handle authentication\r\n    }\r\n\r\n    // Check if user has MFA enabled\r\n    const mfaStatus = await this.authService.getMfaStatus(user.userId);\r\n\r\n    if (!mfaStatus.enabled) {\r\n      throw new ForbiddenException({\r\n        type: 'mfa_required',\r\n        title: 'Two-Factor Authentication Required',\r\n        status: 403,\r\n        detail: 'Please complete 2FA setup to access your account',\r\n        redirectTo: '/2fa-setup',\r\n      });\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { EmailModule } from '@mentor-ai/shared/email';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { KnowledgeModule } from '../knowledge/knowledge.module';\r\nimport { InvitationController } from './invitation.controller';\r\nimport { InvitationService } from './invitation.service';\r\n\r\n@Module({\r\n  imports: [ConfigModule, EmailModule, TenantModule, KnowledgeModule],\r\n  controllers: [InvitationController],\r\n  providers: [InvitationService],\r\n  exports: [InvitationService],\r\n})\r\nexport class InvitationModule {}\r\n","export { EmailService } from './lib/email.service';\r\nexport type { SendEmailResult, InvitationEmailParams } from './lib/email.service';\r\nexport { EmailModule } from './lib/email.module';\r\nexport {\r\n  getInvitationEmailHtml,\r\n  getInvitationEmailText,\r\n} from './lib/templates/invitation.template';\r\nexport type { InvitationEmailData } from './lib/templates/invitation.template';\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport * as nodemailer from 'nodemailer';\r\nimport type { Transporter } from 'nodemailer';\r\nimport {\r\n  getInvitationEmailHtml,\r\n  getInvitationEmailText,\r\n} from './templates/invitation.template';\r\nimport {\r\n  getRemovalEmailHtml,\r\n  getRemovalEmailText,\r\n} from './templates/removal.template';\r\nimport {\r\n  getBackupOwnerDesignationEmailHtml,\r\n  getBackupOwnerDesignationEmailText,\r\n} from './templates/backup-owner-designation.template';\r\nimport {\r\n  getRecoveryNotificationEmailHtml,\r\n  getRecoveryNotificationEmailText,\r\n} from './templates/recovery-notification.template';\r\nimport {\r\n  getDataExportCompleteEmailHtml,\r\n  getDataExportCompleteEmailText,\r\n} from './templates/data-export-complete.template';\r\nimport {\r\n  getTenantDeletionInitiatedEmailHtml,\r\n  getTenantDeletionInitiatedEmailText,\r\n} from './templates/tenant-deletion-initiated.template';\r\nimport {\r\n  getTenantDeletionCancelledEmailHtml,\r\n  getTenantDeletionCancelledEmailText,\r\n} from './templates/tenant-deletion-cancelled.template';\r\nimport {\r\n  getTenantDeletionCompleteEmailHtml,\r\n  getTenantDeletionCompleteEmailText,\r\n} from './templates/tenant-deletion-complete.template';\r\n\r\nexport interface SendEmailResult {\r\n  success: boolean;\r\n  messageId?: string;\r\n}\r\n\r\nexport interface InvitationEmailParams {\r\n  to: string;\r\n  inviterName: string;\r\n  tenantName: string;\r\n  inviteLink: string;\r\n  department: string;\r\n}\r\n\r\nexport interface RemovalNotificationParams {\r\n  to: string;\r\n  memberName: string;\r\n  tenantName: string;\r\n  strategy: 'REASSIGN' | 'ARCHIVE';\r\n  contactEmail?: string;\r\n}\r\n\r\nexport interface BackupOwnerDesignationEmailParams {\r\n  to: string;\r\n  tenantName: string;\r\n  designatedBy: string;\r\n  designatedName: string;\r\n}\r\n\r\nexport interface RecoveryNotificationEmailParams {\r\n  to: string;\r\n  ownerName: string;\r\n  tenantName: string;\r\n  backupOwnerName: string;\r\n  recoveryTimestamp: Date;\r\n  ipAddress: string;\r\n}\r\n\r\nexport interface DataExportCompleteEmailParams {\r\n  to: string;\r\n  userName: string;\r\n  format: string;\r\n  fileSize: string;\r\n  downloadUrl: string;\r\n  expiresAt: string;\r\n}\r\n\r\nexport interface TenantDeletionInitiatedEmailParams {\r\n  to: string;\r\n  userName: string;\r\n  tenantName: string;\r\n  requestedByName: string;\r\n  requestedByEmail: string;\r\n  gracePeriodEndsAt: string;\r\n}\r\n\r\nexport interface TenantDeletionCancelledEmailParams {\r\n  to: string;\r\n  userName: string;\r\n  tenantName: string;\r\n}\r\n\r\nexport interface TenantDeletionCompleteEmailParams {\r\n  to: string;\r\n  userName: string;\r\n  tenantName: string;\r\n  certificateReference: string;\r\n}\r\n\r\n@Injectable()\r\nexport class EmailService {\r\n  private readonly logger = new Logger(EmailService.name);\r\n  private transporter: Transporter;\r\n  private readonly fromAddress: string;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    const host = this.configService.get<string>('SMTP_HOST', 'localhost');\r\n    const port = this.configService.get<number>('SMTP_PORT', 587);\r\n    const user = this.configService.get<string>('SMTP_USER', '');\r\n    const pass = this.configService.get<string>('SMTP_PASS', '');\r\n    this.fromAddress = this.configService.get<string>(\r\n      'EMAIL_FROM',\r\n      'noreply@mentor-ai.com'\r\n    );\r\n\r\n    this.transporter = nodemailer.createTransport({\r\n      host,\r\n      port,\r\n      secure: port === 465,\r\n      auth: user ? { user, pass } : undefined,\r\n    });\r\n  }\r\n\r\n  async sendInvitationEmail(\r\n    params: InvitationEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, inviterName, tenantName, inviteLink, department } = params;\r\n\r\n    const html = getInvitationEmailHtml({\r\n      inviterName,\r\n      tenantName,\r\n      inviteLink,\r\n      department,\r\n      expiresInDays: 7,\r\n    });\r\n\r\n    const text = getInvitationEmailText({\r\n      inviterName,\r\n      tenantName,\r\n      inviteLink,\r\n      department,\r\n      expiresInDays: 7,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `You're invited to join ${tenantName} on Mentor AI`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send email to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendRemovalNotificationEmail(\r\n    params: RemovalNotificationParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, memberName, tenantName, strategy, contactEmail } = params;\r\n\r\n    const html = getRemovalEmailHtml({\r\n      memberName,\r\n      tenantName,\r\n      strategy,\r\n      contactEmail,\r\n    });\r\n\r\n    const text = getRemovalEmailText({\r\n      memberName,\r\n      tenantName,\r\n      strategy,\r\n      contactEmail,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `Your access to ${tenantName} has been updated`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send removal notification to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendBackupOwnerDesignationEmail(\r\n    params: BackupOwnerDesignationEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, tenantName, designatedBy, designatedName } = params;\r\n\r\n    const html = getBackupOwnerDesignationEmailHtml({\r\n      designatedName,\r\n      tenantName,\r\n      designatedBy,\r\n    });\r\n\r\n    const text = getBackupOwnerDesignationEmailText({\r\n      designatedName,\r\n      tenantName,\r\n      designatedBy,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `You've been designated as Backup Owner for ${tenantName}`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send backup owner designation email to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendRecoveryNotificationEmail(\r\n    params: RecoveryNotificationEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, ownerName, tenantName, backupOwnerName, recoveryTimestamp, ipAddress } = params;\r\n\r\n    const html = getRecoveryNotificationEmailHtml({\r\n      ownerName,\r\n      tenantName,\r\n      backupOwnerName,\r\n      recoveryTimestamp: recoveryTimestamp.toISOString(),\r\n      ipAddress,\r\n    });\r\n\r\n    const text = getRecoveryNotificationEmailText({\r\n      ownerName,\r\n      tenantName,\r\n      backupOwnerName,\r\n      recoveryTimestamp: recoveryTimestamp.toISOString(),\r\n      ipAddress,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `Account Recovery Action - ${tenantName}`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send recovery notification to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendDataExportCompleteEmail(\r\n    params: DataExportCompleteEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, userName, format, fileSize, downloadUrl, expiresAt } = params;\r\n\r\n    const html = getDataExportCompleteEmailHtml({\r\n      userName,\r\n      format,\r\n      fileSize,\r\n      downloadUrl,\r\n      expiresAt,\r\n    });\r\n\r\n    const text = getDataExportCompleteEmailText({\r\n      userName,\r\n      format,\r\n      fileSize,\r\n      downloadUrl,\r\n      expiresAt,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `Your data export is ready  Mentor AI`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send data export email to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendTenantDeletionInitiatedEmail(\r\n    params: TenantDeletionInitiatedEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, userName, tenantName, requestedByName, requestedByEmail, gracePeriodEndsAt } = params;\r\n\r\n    const html = getTenantDeletionInitiatedEmailHtml({\r\n      userName,\r\n      tenantName,\r\n      requestedByName,\r\n      requestedByEmail,\r\n      gracePeriodEndsAt,\r\n    });\r\n\r\n    const text = getTenantDeletionInitiatedEmailText({\r\n      userName,\r\n      tenantName,\r\n      requestedByName,\r\n      requestedByEmail,\r\n      gracePeriodEndsAt,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `Important: ${tenantName} scheduled for deletion  Mentor AI`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send tenant deletion initiated email to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendTenantDeletionCancelledEmail(\r\n    params: TenantDeletionCancelledEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, userName, tenantName } = params;\r\n\r\n    const html = getTenantDeletionCancelledEmailHtml({\r\n      userName,\r\n      tenantName,\r\n    });\r\n\r\n    const text = getTenantDeletionCancelledEmailText({\r\n      userName,\r\n      tenantName,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `${tenantName} deletion cancelled  Mentor AI`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send tenant deletion cancelled email to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n\r\n  async sendTenantDeletionCompleteEmail(\r\n    params: TenantDeletionCompleteEmailParams\r\n  ): Promise<SendEmailResult> {\r\n    const { to, userName, tenantName, certificateReference } = params;\r\n\r\n    const html = getTenantDeletionCompleteEmailHtml({\r\n      userName,\r\n      tenantName,\r\n      certificateReference,\r\n    });\r\n\r\n    const text = getTenantDeletionCompleteEmailText({\r\n      userName,\r\n      tenantName,\r\n      certificateReference,\r\n    });\r\n\r\n    try {\r\n      const info = await this.transporter.sendMail({\r\n        from: this.fromAddress,\r\n        to,\r\n        subject: `Your workspace has been deleted  Mentor AI`,\r\n        html,\r\n        text,\r\n      });\r\n\r\n      return { success: true, messageId: info.messageId };\r\n    } catch (error) {\r\n      this.logger.error(\r\n        `Failed to send tenant deletion complete email to ${to}: ${error instanceof Error ? error.message : 'Unknown error'}`\r\n      );\r\n      return { success: false };\r\n    }\r\n  }\r\n}\r\n","module.exports = require(\"nodemailer\");","export interface InvitationEmailData {\r\n  inviterName: string;\r\n  tenantName: string;\r\n  inviteLink: string;\r\n  department: string;\r\n  expiresInDays: number;\r\n}\r\n\r\nexport function getInvitationEmailHtml(data: InvitationEmailData): string {\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>You're invited to join ${data.tenantName} on Mentor AI</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#18181b;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#18181b;margin:0 0 16px;\">You're invited!</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                <strong>${data.inviterName}</strong> has invited you to join\r\n                <strong>${data.tenantName}</strong> on Mentor AI as a Team Member\r\n                in the <strong>${data.department}</strong> department.\r\n              </p>\r\n              <table cellpadding=\"0\" cellspacing=\"0\" style=\"margin:24px 0;\">\r\n                <tr>\r\n                  <td style=\"background-color:#18181b;border-radius:6px;padding:12px 32px;\">\r\n                    <a href=\"${data.inviteLink}\" style=\"color:#ffffff;text-decoration:none;font-size:16px;font-weight:bold;display:inline-block;\">\r\n                      Accept Invitation\r\n                    </a>\r\n                  </td>\r\n                </tr>\r\n              </table>\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:0 0 8px;\">\r\n                This invitation expires in ${data.expiresInDays} days.\r\n              </p>\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:0;\">\r\n                If you didn't expect this invitation, you can safely ignore this email.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getInvitationEmailText(data: InvitationEmailData): string {\r\n  return [\r\n    `You're invited to join ${data.tenantName} on Mentor AI!`,\r\n    '',\r\n    `${data.inviterName} has invited you to join ${data.tenantName} as a Team Member in the ${data.department} department.`,\r\n    '',\r\n    `Accept your invitation: ${data.inviteLink}`,\r\n    '',\r\n    `This invitation expires in ${data.expiresInDays} days.`,\r\n    '',\r\n    `If you didn't expect this invitation, you can safely ignore this email.`,\r\n  ].join('\\n');\r\n}\r\n","export interface RemovalEmailData {\r\n  memberName: string;\r\n  tenantName: string;\r\n  strategy: 'REASSIGN' | 'ARCHIVE';\r\n  contactEmail?: string;\r\n}\r\n\r\nexport function getRemovalEmailHtml(data: RemovalEmailData): string {\r\n  const dataHandling =\r\n    data.strategy === 'REASSIGN'\r\n      ? 'Your notes and saved outputs have been reassigned to the workspace owner. Your conversations have been archived.'\r\n      : 'Your data has been archived and retained securely.';\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Your access to ${data.tenantName} has been removed</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#18181b;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#18181b;margin:0 0 16px;\">Access Update</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${data.memberName ? ` ${data.memberName}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Your access to <strong>${data.tenantName}</strong> on Mentor AI has been removed by the workspace owner.\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                <strong>Your data:</strong> ${dataHandling}\r\n              </p>\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:0;\">\r\n                If you have questions about this change, please contact your workspace administrator${data.contactEmail ? ` at ${data.contactEmail}` : ''}.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getRemovalEmailText(data: RemovalEmailData): string {\r\n  const dataHandling =\r\n    data.strategy === 'REASSIGN'\r\n      ? 'Your notes and saved outputs have been reassigned to the workspace owner. Your conversations have been archived.'\r\n      : 'Your data has been archived and retained securely.';\r\n\r\n  return [\r\n    `Access Update - ${data.tenantName}`,\r\n    '',\r\n    `Hi${data.memberName ? ` ${data.memberName}` : ''},`,\r\n    '',\r\n    `Your access to ${data.tenantName} on Mentor AI has been removed by the workspace owner.`,\r\n    '',\r\n    `Your data: ${dataHandling}`,\r\n    '',\r\n    `If you have questions about this change, please contact your workspace administrator${data.contactEmail ? ` at ${data.contactEmail}` : ''}.`,\r\n  ].join('\\n');\r\n}\r\n","export interface BackupOwnerDesignationEmailData {\r\n  designatedName: string;\r\n  tenantName: string;\r\n  designatedBy: string;\r\n}\r\n\r\nfunction escapeHtml(str: string): string {\r\n  return str\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nexport function getBackupOwnerDesignationEmailHtml(\r\n  data: BackupOwnerDesignationEmailData\r\n): string {\r\n  const name = escapeHtml(data.designatedName);\r\n  const tenant = escapeHtml(data.tenantName);\r\n  const by = escapeHtml(data.designatedBy);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>You've been designated as Backup Owner</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#18181b;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#18181b;margin:0 0 16px;\">Backup Owner Designation</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${name ? ` ${name}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                You have been designated as the <strong>Backup Owner</strong> for <strong>${tenant}</strong> by ${by}.\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                <strong>What this means:</strong> If the primary workspace owner loses access to their account (e.g., lost 2FA device), you can initiate account recovery to reset their two-factor authentication and restore their access.\r\n              </p>\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:0;\">\r\n                No action is needed from you at this time. You will only need to act if the primary owner requests account recovery assistance.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getBackupOwnerDesignationEmailText(\r\n  data: BackupOwnerDesignationEmailData\r\n): string {\r\n  return [\r\n    `Backup Owner Designation - ${data.tenantName}`,\r\n    '',\r\n    `Hi${data.designatedName ? ` ${data.designatedName}` : ''},`,\r\n    '',\r\n    `You have been designated as the Backup Owner for ${data.tenantName} by ${data.designatedBy}.`,\r\n    '',\r\n    'What this means: If the primary workspace owner loses access to their account (e.g., lost 2FA device), you can initiate account recovery to reset their two-factor authentication and restore their access.',\r\n    '',\r\n    'No action is needed from you at this time. You will only need to act if the primary owner requests account recovery assistance.',\r\n  ].join('\\n');\r\n}\r\n","export interface RecoveryNotificationEmailData {\r\n  ownerName: string;\r\n  tenantName: string;\r\n  backupOwnerName: string;\r\n  recoveryTimestamp: string;\r\n  ipAddress: string;\r\n}\r\n\r\nfunction escapeHtml(str: string): string {\r\n  return str\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nexport function getRecoveryNotificationEmailHtml(\r\n  data: RecoveryNotificationEmailData\r\n): string {\r\n  const owner = escapeHtml(data.ownerName);\r\n  const tenant = escapeHtml(data.tenantName);\r\n  const backup = escapeHtml(data.backupOwnerName);\r\n  const timestamp = escapeHtml(data.recoveryTimestamp);\r\n  const ip = escapeHtml(data.ipAddress);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Account Recovery Action Taken</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#18181b;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#dc2626;margin:0 0 16px;\">Account Recovery Action</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${owner ? ` ${owner}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Your two-factor authentication (2FA) for <strong>${tenant}</strong> has been reset by your designated Backup Owner, <strong>${backup}</strong>.\r\n              </p>\r\n              <table width=\"100%\" cellpadding=\"8\" cellspacing=\"0\" style=\"background-color:#fef2f2;border-radius:4px;margin:0 0 16px;\">\r\n                <tr>\r\n                  <td style=\"color:#3f3f46;font-size:14px;\">\r\n                    <strong>Recovery Details:</strong><br>\r\n                    Initiated by: ${backup}<br>\r\n                    Timestamp: ${timestamp}<br>\r\n                    IP Address: ${ip}\r\n                  </td>\r\n                </tr>\r\n              </table>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                <strong>What you need to do:</strong> On your next login, you will be prompted to set up a new 2FA method. Please do so immediately to secure your account.\r\n              </p>\r\n              <p style=\"color:#dc2626;font-size:14px;line-height:1.5;margin:0;\">\r\n                If you did not authorize this recovery, please contact support immediately.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getRecoveryNotificationEmailText(\r\n  data: RecoveryNotificationEmailData\r\n): string {\r\n  return [\r\n    `IMPORTANT: Account Recovery Action - ${data.tenantName}`,\r\n    '',\r\n    `Hi${data.ownerName ? ` ${data.ownerName}` : ''},`,\r\n    '',\r\n    `Your two-factor authentication (2FA) for ${data.tenantName} has been reset by your designated Backup Owner, ${data.backupOwnerName}.`,\r\n    '',\r\n    'Recovery Details:',\r\n    `  Initiated by: ${data.backupOwnerName}`,\r\n    `  Timestamp: ${data.recoveryTimestamp}`,\r\n    `  IP Address: ${data.ipAddress}`,\r\n    '',\r\n    'What you need to do: On your next login, you will be prompted to set up a new 2FA method. Please do so immediately to secure your account.',\r\n    '',\r\n    'If you did not authorize this recovery, please contact support immediately.',\r\n  ].join('\\n');\r\n}\r\n","export interface DataExportCompleteEmailData {\r\n  userName: string;\r\n  format: string;\r\n  fileSize: string;\r\n  downloadUrl: string;\r\n  expiresAt: string;\r\n}\r\n\r\nfunction escapeHtml(str: string): string {\r\n  return str\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nexport function getDataExportCompleteEmailHtml(\r\n  data: DataExportCompleteEmailData\r\n): string {\r\n  const name = escapeHtml(data.userName);\r\n  const format = escapeHtml(data.format);\r\n  const fileSize = escapeHtml(data.fileSize);\r\n  const downloadUrl = escapeHtml(data.downloadUrl);\r\n  const expiresAt = escapeHtml(data.expiresAt);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Your Data Export is Ready</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#18181b;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#18181b;margin:0 0 16px;\">Your Data Export is Ready</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${name ? ` ${name}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Your data export in <strong>${format}</strong> format is ready for download.\r\n              </p>\r\n              <table width=\"100%\" cellpadding=\"8\" cellspacing=\"0\" style=\"background-color:#f0f9ff;border-radius:4px;margin:0 0 16px;\">\r\n                <tr>\r\n                  <td style=\"color:#3f3f46;font-size:14px;\">\r\n                    <strong>Export Details:</strong><br>\r\n                    Format: ${format}<br>\r\n                    File Size: ${fileSize}<br>\r\n                    Expires: ${expiresAt}\r\n                  </td>\r\n                </tr>\r\n              </table>\r\n              <table cellpadding=\"0\" cellspacing=\"0\" style=\"margin:0 0 16px;\">\r\n                <tr>\r\n                  <td style=\"background-color:#3b82f6;border-radius:6px;padding:12px 24px;\">\r\n                    <a href=\"${downloadUrl}\" style=\"color:#ffffff;text-decoration:none;font-size:16px;font-weight:bold;\">Download Export</a>\r\n                  </td>\r\n                </tr>\r\n              </table>\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:0;\">\r\n                This download link will expire in 24 hours. After that, you'll need to request a new export.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getDataExportCompleteEmailText(\r\n  data: DataExportCompleteEmailData\r\n): string {\r\n  return [\r\n    `Your Data Export is Ready  Mentor AI`,\r\n    '',\r\n    `Hi${data.userName ? ` ${data.userName}` : ''},`,\r\n    '',\r\n    `Your data export in ${data.format} format is ready for download.`,\r\n    '',\r\n    'Export Details:',\r\n    `  Format: ${data.format}`,\r\n    `  File Size: ${data.fileSize}`,\r\n    `  Expires: ${data.expiresAt}`,\r\n    '',\r\n    `Download: ${data.downloadUrl}`,\r\n    '',\r\n    'This download link will expire in 24 hours. After that, you will need to request a new export.',\r\n  ].join('\\n');\r\n}\r\n","export interface TenantDeletionInitiatedEmailData {\r\n  userName: string;\r\n  tenantName: string;\r\n  requestedByName: string;\r\n  requestedByEmail: string;\r\n  gracePeriodEndsAt: string;\r\n}\r\n\r\nfunction escapeHtml(str: string): string {\r\n  return str\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nfunction formatDate(isoDate: string): string {\r\n  const date = new Date(isoDate);\r\n  return date.toLocaleDateString('en-US', {\r\n    weekday: 'long',\r\n    year: 'numeric',\r\n    month: 'long',\r\n    day: 'numeric',\r\n    hour: '2-digit',\r\n    minute: '2-digit',\r\n    timeZoneName: 'short',\r\n  });\r\n}\r\n\r\nexport function getTenantDeletionInitiatedEmailHtml(\r\n  data: TenantDeletionInitiatedEmailData\r\n): string {\r\n  const name = escapeHtml(data.userName);\r\n  const tenant = escapeHtml(data.tenantName);\r\n  const requestedBy = escapeHtml(data.requestedByName);\r\n  const requestedByEmail = escapeHtml(data.requestedByEmail);\r\n  const gracePeriodEnds = formatDate(data.gracePeriodEndsAt);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Important: Workspace scheduled for deletion</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#dc2626;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#dc2626;margin:0 0 16px;\"> Workspace Scheduled for Deletion</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${name ? ` ${name}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                The workspace <strong>${tenant}</strong> has been scheduled for deletion by ${requestedBy}.\r\n              </p>\r\n\r\n              <div style=\"background-color:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:16px;margin:16px 0;\">\r\n                <p style=\"color:#991b1b;font-size:16px;font-weight:bold;margin:0 0 8px;\">What this means:</p>\r\n                <ul style=\"color:#991b1b;font-size:14px;line-height:1.6;margin:0;padding-left:20px;\">\r\n                  <li>All workspace data will be permanently deleted</li>\r\n                  <li>All team members will lose access</li>\r\n                  <li>This action cannot be undone after the grace period</li>\r\n                </ul>\r\n              </div>\r\n\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:16px 0 8px;\">\r\n                <strong>Deletion scheduled for:</strong>\r\n              </p>\r\n              <p style=\"color:#dc2626;font-size:18px;font-weight:bold;margin:0 0 16px;\">\r\n                ${gracePeriodEnds}\r\n              </p>\r\n\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                The workspace owner can cancel this deletion within the 7-day grace period. After this time, deletion will proceed automatically.\r\n              </p>\r\n\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:16px 0 0;\">\r\n                If you believe this was a mistake, please contact the workspace owner at ${requestedByEmail}.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getTenantDeletionInitiatedEmailText(\r\n  data: TenantDeletionInitiatedEmailData\r\n): string {\r\n  const gracePeriodEnds = formatDate(data.gracePeriodEndsAt);\r\n\r\n  return [\r\n    `IMPORTANT: ${data.tenantName} scheduled for deletion`,\r\n    '',\r\n    `Hi${data.userName ? ` ${data.userName}` : ''},`,\r\n    '',\r\n    `The workspace \"${data.tenantName}\" has been scheduled for deletion by ${data.requestedByName}.`,\r\n    '',\r\n    'What this means:',\r\n    '- All workspace data will be permanently deleted',\r\n    '- All team members will lose access',\r\n    '- This action cannot be undone after the grace period',\r\n    '',\r\n    `Deletion scheduled for: ${gracePeriodEnds}`,\r\n    '',\r\n    'The workspace owner can cancel this deletion within the 7-day grace period. After this time, deletion will proceed automatically.',\r\n    '',\r\n    `If you believe this was a mistake, please contact the workspace owner at ${data.requestedByEmail}.`,\r\n  ].join('\\n');\r\n}\r\n","export interface TenantDeletionCancelledEmailData {\r\n  userName: string;\r\n  tenantName: string;\r\n}\r\n\r\nfunction escapeHtml(str: string): string {\r\n  return str\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nexport function getTenantDeletionCancelledEmailHtml(\r\n  data: TenantDeletionCancelledEmailData\r\n): string {\r\n  const name = escapeHtml(data.userName);\r\n  const tenant = escapeHtml(data.tenantName);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Workspace deletion cancelled</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#16a34a;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#16a34a;margin:0 0 16px;\"> Workspace Deletion Cancelled</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${name ? ` ${name}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Good news! The scheduled deletion of <strong>${tenant}</strong> has been cancelled.\r\n              </p>\r\n\r\n              <div style=\"background-color:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:16px;margin:16px 0;\">\r\n                <p style=\"color:#166534;font-size:16px;margin:0;\">\r\n                  Your workspace has been fully restored. All data and team member access remain intact.\r\n                </p>\r\n              </div>\r\n\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:16px 0 0;\">\r\n                No action is needed from you. You can continue using Mentor AI as normal.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getTenantDeletionCancelledEmailText(\r\n  data: TenantDeletionCancelledEmailData\r\n): string {\r\n  return [\r\n    `${data.tenantName} deletion cancelled`,\r\n    '',\r\n    `Hi${data.userName ? ` ${data.userName}` : ''},`,\r\n    '',\r\n    `Good news! The scheduled deletion of \"${data.tenantName}\" has been cancelled.`,\r\n    '',\r\n    'Your workspace has been fully restored. All data and team member access remain intact.',\r\n    '',\r\n    'No action is needed from you. You can continue using Mentor AI as normal.',\r\n  ].join('\\n');\r\n}\r\n","export interface TenantDeletionCompleteEmailData {\r\n  userName: string;\r\n  tenantName: string;\r\n  certificateReference: string;\r\n}\r\n\r\nfunction escapeHtml(str: string): string {\r\n  return str\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n\r\nexport function getTenantDeletionCompleteEmailHtml(\r\n  data: TenantDeletionCompleteEmailData\r\n): string {\r\n  const name = escapeHtml(data.userName);\r\n  const tenant = escapeHtml(data.tenantName);\r\n  const certRef = escapeHtml(data.certificateReference);\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Your workspace has been deleted</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f4f4f5;font-family:Arial,Helvetica,sans-serif;\">\r\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f4f4f5;padding:40px 0;\">\r\n    <tr>\r\n      <td align=\"center\">\r\n        <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;border-radius:8px;overflow:hidden;\">\r\n          <tr>\r\n            <td style=\"background-color:#18181b;padding:24px 32px;\">\r\n              <h1 style=\"color:#ffffff;margin:0;font-size:24px;\">Mentor AI</h1>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding:32px;\">\r\n              <h2 style=\"color:#18181b;margin:0 0 16px;\">Workspace Deletion Complete</h2>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                Hi${name ? ` ${name}` : ''},\r\n              </p>\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                As requested, the workspace <strong>${tenant}</strong> has been permanently deleted.\r\n              </p>\r\n\r\n              <div style=\"background-color:#f4f4f5;border:1px solid #e4e4e7;border-radius:8px;padding:16px;margin:16px 0;\">\r\n                <p style=\"color:#3f3f46;font-size:14px;margin:0 0 8px;\">\r\n                  <strong>GDPR Deletion Certificate Reference:</strong>\r\n                </p>\r\n                <p style=\"color:#71717a;font-size:14px;font-family:monospace;margin:0;\">\r\n                  ${certRef}\r\n                </p>\r\n              </div>\r\n\r\n              <p style=\"color:#3f3f46;font-size:16px;line-height:1.5;margin:0 0 16px;\">\r\n                In accordance with GDPR requirements:\r\n              </p>\r\n              <ul style=\"color:#3f3f46;font-size:14px;line-height:1.6;margin:0 0 16px;padding-left:20px;\">\r\n                <li>All personal data has been deleted or anonymized</li>\r\n                <li>Audit logs have been anonymized and retained for compliance</li>\r\n                <li>User identifiers have been replaced with cryptographic hashes</li>\r\n              </ul>\r\n\r\n              <p style=\"color:#71717a;font-size:14px;line-height:1.5;margin:16px 0 0;\">\r\n                Thank you for using Mentor AI. If you have any questions about this deletion or need a copy of your GDPR deletion certificate, please contact support@mentor-ai.com with your certificate reference.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"background-color:#f4f4f5;padding:16px 32px;text-align:center;\">\r\n              <p style=\"color:#a1a1aa;font-size:12px;margin:0;\">\r\n                &copy; ${new Date().getFullYear()} Mentor AI. All rights reserved.\r\n              </p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`.trim();\r\n}\r\n\r\nexport function getTenantDeletionCompleteEmailText(\r\n  data: TenantDeletionCompleteEmailData\r\n): string {\r\n  return [\r\n    `Workspace Deletion Complete - ${data.tenantName}`,\r\n    '',\r\n    `Hi${data.userName ? ` ${data.userName}` : ''},`,\r\n    '',\r\n    `As requested, the workspace \"${data.tenantName}\" has been permanently deleted.`,\r\n    '',\r\n    `GDPR Deletion Certificate Reference: ${data.certificateReference}`,\r\n    '',\r\n    'In accordance with GDPR requirements:',\r\n    '- All personal data has been deleted or anonymized',\r\n    '- Audit logs have been anonymized and retained for compliance',\r\n    '- User identifiers have been replaced with cryptographic hashes',\r\n    '',\r\n    'Thank you for using Mentor AI. If you have any questions about this deletion or need a copy of your GDPR deletion certificate, please contact support@mentor-ai.com with your certificate reference.',\r\n  ].join('\\n');\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { EmailService } from './email.service';\r\n\r\n@Module({\r\n  imports: [ConfigModule],\r\n  providers: [EmailService],\r\n  exports: [EmailService],\r\n})\r\nexport class EmailModule {}\r\n","import { Module } from '@nestjs/common';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { LlmConfigModule } from '../llm-config/llm-config.module';\r\nimport { AiGatewayModule } from '../ai-gateway/ai-gateway.module';\r\nimport { KnowledgeController } from './knowledge.controller';\r\nimport { ConceptService } from './services/concept.service';\r\nimport { ConceptSeedService } from './services/concept-seed.service';\r\nimport { ConceptMatchingService } from './services/concept-matching.service';\r\nimport { CitationInjectorService } from './services/citation-injector.service';\r\nimport { CitationService } from './services/citation.service';\r\nimport { EmbeddingService } from './services/embedding.service';\r\nimport { CurriculumService } from './services/curriculum.service';\r\nimport { ConceptExtractionService } from './services/concept-extraction.service';\r\nimport { BrainSeedingService } from './services/brain-seeding.service';\r\nimport { BusinessContextService } from './services/business-context.service';\r\nimport { ConceptRelevanceService } from './services/concept-relevance.service';\r\nimport { DepartmentGuard } from './guards/department.guard';\r\n\r\n/**\r\n * Module for business concepts knowledge base.\r\n * Provides services for querying, seeding, and citing concepts.\r\n *\r\n * Story 2.6: Added citation services for concept matching and injection.\r\n * Story 2.13: Added AiGatewayModule for dynamic relationship creation.\r\n * Story 3.2: Added BrainSeedingService + BusinessContextService.\r\n */\r\n@Module({\r\n  imports: [TenantModule, AuthModule, LlmConfigModule, AiGatewayModule],\r\n  controllers: [KnowledgeController],\r\n  providers: [\r\n    ConceptService,\r\n    ConceptSeedService,\r\n    ConceptMatchingService,\r\n    CitationInjectorService,\r\n    CitationService,\r\n    EmbeddingService,\r\n    CurriculumService,\r\n    ConceptExtractionService,\r\n    BrainSeedingService,\r\n    BusinessContextService,\r\n    ConceptRelevanceService,\r\n    DepartmentGuard,\r\n  ],\r\n  exports: [\r\n    ConceptService,\r\n    ConceptSeedService,\r\n    ConceptMatchingService,\r\n    CitationInjectorService,\r\n    CitationService,\r\n    EmbeddingService,\r\n    CurriculumService,\r\n    ConceptExtractionService,\r\n    BrainSeedingService,\r\n    BusinessContextService,\r\n    ConceptRelevanceService,\r\n    DepartmentGuard,\r\n  ],\r\n})\r\nexport class KnowledgeModule {}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { LlmConfigController } from './llm-config.controller';\r\nimport { LlmConfigService } from './llm-config.service';\r\n\r\n@Module({\r\n  imports: [ConfigModule, AuthModule, TenantModule], // TenantModule provides PlatformPrismaService\r\n  controllers: [LlmConfigController],\r\n  providers: [LlmConfigService],\r\n  exports: [LlmConfigService],\r\n})\r\nexport class LlmConfigModule {}\r\n","import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Put,\r\n  Body,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n} from '@nestjs/common';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { RolesGuard } from '../auth/guards/roles.guard';\r\nimport { Roles } from '../auth/decorators/roles.decorator';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\nimport { LlmConfigService } from './llm-config.service';\r\nimport { UpdateLlmConfigDto } from './dto/update-llm-config.dto';\r\nimport { ValidateProviderDto } from './dto/validate-provider.dto';\r\n\r\n/**\r\n * Controller for platform-level LLM provider configuration.\r\n * All endpoints require PLATFORM_OWNER role (via JWT claims).\r\n */\r\n@Controller('admin/llm-config')\r\n@UseGuards(JwtAuthGuard, RolesGuard)\r\nexport class LlmConfigController {\r\n  constructor(private readonly llmConfigService: LlmConfigService) {}\r\n\r\n  /**\r\n   * Get current LLM provider configuration.\r\n   * API keys are masked in the response.\r\n   */\r\n  @Get()\r\n  @HttpCode(HttpStatus.OK)\r\n  @Roles('PLATFORM_OWNER')\r\n  async getConfig() {\r\n    const config = await this.llmConfigService.getConfig();\r\n    return { data: config };\r\n  }\r\n\r\n  /**\r\n   * Update LLM provider configuration.\r\n   * API keys are encrypted before storage.\r\n   * Changes are logged to audit trail.\r\n   */\r\n  @Put()\r\n  @HttpCode(HttpStatus.OK)\r\n  @Roles('PLATFORM_OWNER')\r\n  async updateConfig(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: UpdateLlmConfigDto\r\n  ) {\r\n    const config = await this.llmConfigService.updateConfig(\r\n      user.userId,\r\n      dto.primaryProvider,\r\n      dto.fallbackProvider\r\n    );\r\n\r\n    return {\r\n      data: config,\r\n      message: 'LLM configuration updated successfully',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validate provider credentials before saving.\r\n   * For cloud providers, validates API key.\r\n   * For local providers, checks endpoint health.\r\n   */\r\n  @Post('validate')\r\n  @HttpCode(HttpStatus.OK)\r\n  @Roles('PLATFORM_OWNER')\r\n  async validateProvider(@Body() dto: ValidateProviderDto) {\r\n    const result = await this.llmConfigService.validateProvider(\r\n      dto.type,\r\n      dto.apiKey,\r\n      dto.endpoint\r\n    );\r\n\r\n    return { data: result };\r\n  }\r\n}\r\n","import {\r\n  Injectable,\r\n  Logger,\r\n  BadRequestException,\r\n  InternalServerErrorException,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport * as crypto from 'node:crypto';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport type {\r\n  LlmProviderConfig,\r\n  LlmConfigResponse,\r\n  LlmProviderUpdatePayload,\r\n  LlmProviderStatus,\r\n  LlmProviderType,\r\n} from '@mentor-ai/shared/types';\r\nimport { OpenRouterProvider } from './providers/openrouter.provider';\r\nimport { LocalLlamaProvider } from './providers/local-llama.provider';\r\nimport { OpenAIProvider } from './providers/openai.provider';\r\nimport { LmStudioProvider } from './providers/lm-studio.provider';\r\nimport { DeepSeekProvider } from './providers/deepseek.provider';\r\n\r\nconst ENCRYPTION_ALGORITHM = 'aes-256-gcm';\r\nconst API_KEY_MASK = '***masked***';\r\n\r\n/**\r\n * Service for managing LLM provider configuration at the platform level.\r\n * Handles provider CRUD operations, API key encryption, validation, and audit logging.\r\n */\r\n@Injectable()\r\nexport class LlmConfigService {\r\n  private readonly logger = new Logger(LlmConfigService.name);\r\n  private readonly encryptionKey: Buffer;\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly configService: ConfigService\r\n  ) {\r\n    const keyHex = this.configService.get<string>('LLM_CONFIG_ENCRYPTION_KEY');\r\n    if (!keyHex) {\r\n      this.logger.warn({\r\n        message: 'LLM_CONFIG_ENCRYPTION_KEY not set, using default (not secure for production)',\r\n      });\r\n      // Generate a consistent default key for development (32 bytes = 64 hex chars)\r\n      this.encryptionKey = Buffer.from('0'.repeat(64), 'hex');\r\n    } else {\r\n      this.encryptionKey = Buffer.from(keyHex, 'hex');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieves the current LLM provider configuration.\r\n   * API keys are masked in the response for security.\r\n   * @returns Current primary and fallback provider configuration\r\n   */\r\n  async getConfig(): Promise<LlmConfigResponse> {\r\n    const configs = await this.prisma.llmProviderConfig.findMany({\r\n      where: { isActive: true },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    const primary = configs.find((c) => c.isPrimary) ?? null;\r\n    const fallback = configs.find((c) => c.isFallback) ?? null;\r\n\r\n    return {\r\n      primaryProvider: primary ? this.mapToResponse(primary) : null,\r\n      fallbackProvider: fallback ? this.mapToResponse(fallback) : null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Updates the LLM provider configuration.\r\n   * Encrypts API keys before storage and logs changes to audit trail.\r\n   * @param userId - ID of the user making the change\r\n   * @param primaryProvider - Primary provider configuration\r\n   * @param fallbackProvider - Optional fallback provider configuration\r\n   * @returns Updated configuration\r\n   * @throws BadRequestException if primary provider validation fails\r\n   */\r\n  async updateConfig(\r\n    userId: string,\r\n    primaryProvider: LlmProviderUpdatePayload,\r\n    fallbackProvider?: LlmProviderUpdatePayload | null\r\n  ): Promise<LlmConfigResponse> {\r\n    // Get current config for audit log\r\n    const currentConfig = await this.getConfig();\r\n\r\n    // Deactivate all existing configs\r\n    await this.prisma.llmProviderConfig.updateMany({\r\n      where: { isActive: true },\r\n      data: { isActive: false },\r\n    });\r\n\r\n    // Create primary provider config\r\n    const primaryConfig = await this.prisma.llmProviderConfig.create({\r\n      data: {\r\n        providerType: primaryProvider.type,\r\n        apiKey: primaryProvider.apiKey ? this.encrypt(primaryProvider.apiKey) : null,\r\n        endpoint: primaryProvider.endpoint,\r\n        modelId: primaryProvider.modelId,\r\n        isPrimary: true,\r\n        isFallback: false,\r\n        isActive: true,\r\n      },\r\n    });\r\n\r\n    let fallbackConfig = null;\r\n    if (fallbackProvider) {\r\n      fallbackConfig = await this.prisma.llmProviderConfig.create({\r\n        data: {\r\n          providerType: fallbackProvider.type,\r\n          apiKey: fallbackProvider.apiKey ? this.encrypt(fallbackProvider.apiKey) : null,\r\n          endpoint: fallbackProvider.endpoint,\r\n          modelId: fallbackProvider.modelId,\r\n          isPrimary: false,\r\n          isFallback: true,\r\n          isActive: true,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Log the configuration change to audit trail\r\n    await this.createAuditLog(\r\n      currentConfig.primaryProvider ? 'UPDATE' : 'CREATE',\r\n      userId,\r\n      currentConfig,\r\n      {\r\n        primaryProvider: this.mapToResponse(primaryConfig),\r\n        fallbackProvider: fallbackConfig ? this.mapToResponse(fallbackConfig) : null,\r\n      }\r\n    );\r\n\r\n    this.logger.log({\r\n      message: 'LLM configuration updated',\r\n      userId,\r\n      primaryProvider: primaryProvider.type,\r\n      fallbackProvider: fallbackProvider?.type ?? null,\r\n    });\r\n\r\n    return {\r\n      primaryProvider: this.mapToResponse(primaryConfig),\r\n      fallbackProvider: fallbackConfig ? this.mapToResponse(fallbackConfig) : null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Validates provider credentials by testing connectivity.\r\n   * For cloud providers, validates API key. For local providers, checks endpoint health.\r\n   * @param type - Provider type to validate\r\n   * @param apiKey - API key for cloud providers\r\n   * @param endpoint - Endpoint URL for local providers\r\n   * @returns Validation result with available models and resource info\r\n   */\r\n  async validateProvider(\r\n    type: LlmProviderType,\r\n    apiKey?: string,\r\n    endpoint?: string\r\n  ): Promise<LlmProviderStatus> {\r\n    try {\r\n      const provider = this.createProvider(type, apiKey, endpoint);\r\n      const isValid = await provider.validateCredentials();\r\n\r\n      if (!isValid) {\r\n        return {\r\n          valid: false,\r\n          models: [],\r\n          resourceInfo: null,\r\n          errorMessage: 'Invalid credentials or endpoint unreachable',\r\n        };\r\n      }\r\n\r\n      const models = await provider.fetchModels();\r\n      const resourceInfo = await provider.getResourceInfo();\r\n\r\n      this.logger.log({\r\n        message: 'Provider validation successful',\r\n        providerType: type,\r\n        modelCount: models.length,\r\n      });\r\n\r\n      return {\r\n        valid: true,\r\n        models,\r\n        resourceInfo,\r\n      };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown validation error';\r\n\r\n      this.logger.warn({\r\n        message: 'Provider validation failed',\r\n        providerType: type,\r\n        error: errorMessage,\r\n      });\r\n\r\n      return {\r\n        valid: false,\r\n        models: [],\r\n        resourceInfo: null,\r\n        errorMessage,\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the decrypted API key for a provider (for internal use only).\r\n   * @param providerType - Type of provider to get key for\r\n   * @returns Decrypted API key or null if not found\r\n   * @throws InternalServerErrorException if decryption fails\r\n   */\r\n  async getDecryptedApiKey(providerType: LlmProviderType): Promise<string | null> {\r\n    const config = await this.prisma.llmProviderConfig.findFirst({\r\n      where: {\r\n        providerType,\r\n        isActive: true,\r\n      },\r\n    });\r\n\r\n    if (!config?.apiKey) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      return this.decrypt(config.apiKey);\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to decrypt API key',\r\n        providerType,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      throw new InternalServerErrorException({\r\n        type: 'decryption_failed',\r\n        title: 'Configuration Error',\r\n        status: 500,\r\n        detail: 'Failed to retrieve provider credentials',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the configured endpoint for a provider.\r\n   * @param providerType - Type of provider to get endpoint for\r\n   * @returns Endpoint URL or null if not found\r\n   */\r\n  async getProviderEndpoint(providerType: LlmProviderType): Promise<string | null> {\r\n    const config = await this.prisma.llmProviderConfig.findFirst({\r\n      where: {\r\n        providerType,\r\n        isActive: true,\r\n      },\r\n    });\r\n    return config?.endpoint ?? null;\r\n  }\r\n\r\n  private createProvider(type: LlmProviderType, apiKey?: string, endpoint?: string) {\r\n    switch (type) {\r\n      case 'OPENROUTER':\r\n        if (!apiKey) {\r\n          throw new BadRequestException({\r\n            type: 'api_key_required',\r\n            title: 'API Key Required',\r\n            status: 400,\r\n            detail: 'OpenRouter requires an API key',\r\n          });\r\n        }\r\n        return new OpenRouterProvider({ apiKey });\r\n\r\n      case 'LOCAL_LLAMA':\r\n        return new LocalLlamaProvider({ endpoint });\r\n\r\n      case 'OPENAI':\r\n        if (!apiKey) {\r\n          throw new BadRequestException({\r\n            type: 'api_key_required',\r\n            title: 'API Key Required',\r\n            status: 400,\r\n            detail: 'OpenAI requires an API key',\r\n          });\r\n        }\r\n        return new OpenAIProvider({ apiKey });\r\n\r\n      case 'LM_STUDIO':\r\n        return new LmStudioProvider({ endpoint: endpoint ?? 'http://localhost:1234', apiKey });\r\n\r\n      case 'DEEPSEEK':\r\n        if (!apiKey) {\r\n          throw new BadRequestException({\r\n            type: 'api_key_required',\r\n            title: 'API Key Required',\r\n            status: 400,\r\n            detail: 'DeepSeek requires an API key',\r\n          });\r\n        }\r\n        return new DeepSeekProvider({ apiKey });\r\n\r\n      case 'ANTHROPIC':\r\n        throw new BadRequestException({\r\n          type: 'provider_not_implemented',\r\n          title: 'Provider Not Available',\r\n          status: 400,\r\n          detail: `${type} provider is not yet implemented`,\r\n        });\r\n\r\n      default:\r\n        throw new BadRequestException({\r\n          type: 'invalid_provider_type',\r\n          title: 'Invalid Provider',\r\n          status: 400,\r\n          detail: 'Unknown provider type',\r\n        });\r\n    }\r\n  }\r\n\r\n  private mapToResponse(config: {\r\n    id: string;\r\n    providerType: string;\r\n    apiKey: string | null;\r\n    endpoint: string | null;\r\n    modelId: string;\r\n    isPrimary: boolean;\r\n    isFallback: boolean;\r\n    isActive: boolean;\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n  }): LlmProviderConfig {\r\n    return {\r\n      id: config.id,\r\n      providerType: config.providerType as LlmProviderType,\r\n      apiKey: config.apiKey ? API_KEY_MASK : undefined,\r\n      endpoint: config.endpoint ?? undefined,\r\n      modelId: config.modelId,\r\n      isPrimary: config.isPrimary,\r\n      isFallback: config.isFallback,\r\n      isActive: config.isActive,\r\n      createdAt: config.createdAt.toISOString(),\r\n      updatedAt: config.updatedAt.toISOString(),\r\n    };\r\n  }\r\n\r\n  private async createAuditLog(\r\n    action: 'CREATE' | 'UPDATE' | 'DELETE',\r\n    changedBy: string,\r\n    previousVal: LlmConfigResponse | null,\r\n    newVal: LlmConfigResponse\r\n  ): Promise<void> {\r\n    await this.prisma.llmConfigAuditLog.create({\r\n      data: {\r\n        action,\r\n        changedBy,\r\n        previousVal: previousVal ? JSON.parse(JSON.stringify(previousVal)) : undefined,\r\n        newVal: JSON.parse(JSON.stringify(newVal)),\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'LLM config audit log created',\r\n      action,\r\n      changedBy,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Encrypts a string using AES-256-GCM.\r\n   * Returns format: iv:authTag:encryptedData (all hex encoded)\r\n   */\r\n  private encrypt(text: string): string {\r\n    const iv = crypto.randomBytes(16);\r\n    const cipher = crypto.createCipheriv(ENCRYPTION_ALGORITHM, this.encryptionKey, iv);\r\n    let encrypted = cipher.update(text, 'utf8', 'hex');\r\n    encrypted += cipher.final('hex');\r\n    const authTag = cipher.getAuthTag();\r\n    return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;\r\n  }\r\n\r\n  /**\r\n   * Decrypts a string encrypted with the encrypt method.\r\n   * @throws Error if encrypted string format is invalid\r\n   */\r\n  private decrypt(encrypted: string): string {\r\n    const parts = encrypted.split(':');\r\n    if (parts.length !== 3) {\r\n      throw new Error('Invalid encrypted string format');\r\n    }\r\n    const [ivHex, authTagHex, encryptedText] = parts as [string, string, string];\r\n    const iv = Buffer.from(ivHex, 'hex');\r\n    const authTag = Buffer.from(authTagHex, 'hex');\r\n    const decipher = crypto.createDecipheriv(ENCRYPTION_ALGORITHM, this.encryptionKey, iv);\r\n    decipher.setAuthTag(authTag);\r\n    let decrypted = decipher.update(encryptedText, 'hex', 'utf8');\r\n    decrypted += decipher.final('utf8');\r\n    return decrypted;\r\n  }\r\n}\r\n","module.exports = require(\"node:crypto\");","import type { LlmModelInfo, LlmResourceInfo } from '@mentor-ai/shared/types';\r\nimport type { LlmProvider, LlmProviderOptions } from './llm-provider.interface';\r\n\r\nconst OPENROUTER_API_BASE = 'https://openrouter.ai/api/v1';\r\n\r\ninterface OpenRouterModel {\r\n  id: string;\r\n  name: string;\r\n  pricing?: {\r\n    prompt?: string;\r\n    completion?: string;\r\n  };\r\n  context_length?: number;\r\n}\r\n\r\ninterface OpenRouterModelsResponse {\r\n  data: OpenRouterModel[];\r\n}\r\n\r\n/**\r\n * OpenRouter provider implementation.\r\n * Validates API keys and fetches available models from OpenRouter API.\r\n */\r\nexport class OpenRouterProvider implements LlmProvider {\r\n  private readonly apiKey: string;\r\n\r\n  constructor(options: LlmProviderOptions) {\r\n    if (!options.apiKey) {\r\n      throw new Error('OpenRouter requires an API key');\r\n    }\r\n    this.apiKey = options.apiKey;\r\n  }\r\n\r\n  /**\r\n   * Validates the API key by making a test request to the models endpoint.\r\n   * @returns true if the API key is valid\r\n   */\r\n  async validateCredentials(): Promise<boolean> {\r\n    try {\r\n      const response = await fetch(`${OPENROUTER_API_BASE}/models`, {\r\n        method: 'GET',\r\n        headers: {\r\n          Authorization: `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      return response.ok;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetches available models from OpenRouter API.\r\n   * Filters to include primarily Llama and other popular models.\r\n   * @returns Array of available models with pricing\r\n   */\r\n  async fetchModels(): Promise<LlmModelInfo[]> {\r\n    const response = await fetch(`${OPENROUTER_API_BASE}/models`, {\r\n      method: 'GET',\r\n      headers: {\r\n        Authorization: `Bearer ${this.apiKey}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch models: ${response.statusText}`);\r\n    }\r\n\r\n    const data = (await response.json()) as OpenRouterModelsResponse;\r\n\r\n    // Filter and map models - focus on popular Llama and other models\r\n    const popularPrefixes = [\r\n      'meta-llama/',\r\n      'anthropic/',\r\n      'openai/',\r\n      'mistralai/',\r\n      'google/',\r\n    ];\r\n\r\n    return data.data\r\n      .filter((model) =>\r\n        popularPrefixes.some((prefix) => model.id.startsWith(prefix))\r\n      )\r\n      .map((model) => ({\r\n        id: model.id,\r\n        name: model.name,\r\n        costPer1kTokens: this.calculateCostPer1k(model.pricing),\r\n        contextLength: model.context_length,\r\n      }))\r\n      .slice(0, 50); // Limit to 50 models for UI performance\r\n  }\r\n\r\n  /**\r\n   * Returns null as OpenRouter is a cloud provider.\r\n   */\r\n  async getResourceInfo(): Promise<LlmResourceInfo | null> {\r\n    return null;\r\n  }\r\n\r\n  private calculateCostPer1k(pricing?: {\r\n    prompt?: string;\r\n    completion?: string;\r\n  }): number | null {\r\n    if (!pricing?.prompt) {\r\n      return null;\r\n    }\r\n\r\n    // OpenRouter pricing is per token, convert to per 1K tokens\r\n    const promptCost = parseFloat(pricing.prompt) * 1000;\r\n    return Math.round(promptCost * 10000) / 10000; // Round to 4 decimal places\r\n  }\r\n}\r\n","import type { LlmModelInfo, LlmResourceInfo } from '@mentor-ai/shared/types';\r\nimport type { LlmProvider, LlmProviderOptions } from './llm-provider.interface';\r\n\r\nconst DEFAULT_OLLAMA_ENDPOINT = 'http://localhost:11434';\r\n\r\ninterface OllamaModel {\r\n  name: string;\r\n  model: string;\r\n  size: number;\r\n  digest: string;\r\n  details?: {\r\n    parameter_size?: string;\r\n    quantization_level?: string;\r\n  };\r\n}\r\n\r\ninterface OllamaTagsResponse {\r\n  models: OllamaModel[];\r\n}\r\n\r\ninterface OllamaShowResponse {\r\n  details?: {\r\n    parameter_size?: string;\r\n    quantization_level?: string;\r\n  };\r\n  model_info?: {\r\n    'general.parameter_count'?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Local Llama (Ollama) provider implementation.\r\n * Validates endpoint connectivity and fetches available models from local Ollama server.\r\n */\r\nexport class LocalLlamaProvider implements LlmProvider {\r\n  private readonly endpoint: string;\r\n\r\n  constructor(options: LlmProviderOptions) {\r\n    this.endpoint = options.endpoint ?? DEFAULT_OLLAMA_ENDPOINT;\r\n  }\r\n\r\n  /**\r\n   * Validates connectivity to the Ollama server by fetching the tags endpoint.\r\n   * @returns true if the endpoint is reachable and responds correctly\r\n   */\r\n  async validateCredentials(): Promise<boolean> {\r\n    try {\r\n      const response = await fetch(`${this.endpoint}/api/tags`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      return response.ok;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetches available models from the local Ollama server.\r\n   * @returns Array of available models (cost is null for local models)\r\n   */\r\n  async fetchModels(): Promise<LlmModelInfo[]> {\r\n    const response = await fetch(`${this.endpoint}/api/tags`, {\r\n      method: 'GET',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch models: ${response.statusText}`);\r\n    }\r\n\r\n    const data = (await response.json()) as OllamaTagsResponse;\r\n\r\n    return data.models.map((model) => ({\r\n      id: model.name,\r\n      name: this.formatModelName(model.name),\r\n      costPer1kTokens: null, // Local models have no per-token cost\r\n      contextLength: this.estimateContextLength(model.name),\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Gets resource information from the local Ollama server.\r\n   * Attempts to determine GPU/CPU requirements based on available models.\r\n   * @returns Resource requirements for running local models\r\n   */\r\n  async getResourceInfo(): Promise<LlmResourceInfo> {\r\n    try {\r\n      // Get the first available model to check resource requirements\r\n      const models = await this.fetchModels();\r\n      const firstModel = models[0];\r\n      if (!firstModel) {\r\n        return this.getDefaultResourceInfo();\r\n      }\r\n\r\n      const showResponse = await fetch(\r\n        `${this.endpoint}/api/show`,\r\n        {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({ name: firstModel.id }),\r\n        }\r\n      );\r\n\r\n      if (!showResponse.ok) {\r\n        return this.getDefaultResourceInfo();\r\n      }\r\n\r\n      const showData = (await showResponse.json()) as OllamaShowResponse;\r\n      return this.parseResourceRequirements(showData, firstModel.id);\r\n    } catch {\r\n      return this.getDefaultResourceInfo();\r\n    }\r\n  }\r\n\r\n  private formatModelName(modelId: string): string {\r\n    // Convert \"llama3.1:8b\" to \"Llama 3.1 8B\"\r\n    return modelId\r\n      .replace(/([a-z])(\\d)/gi, '$1 $2')\r\n      .replace(/:/g, ' ')\r\n      .replace(/\\b\\w/g, (c) => c.toUpperCase());\r\n  }\r\n\r\n  private estimateContextLength(modelId: string): number | undefined {\r\n    // Estimate context length based on model name patterns\r\n    const lowerModel = modelId.toLowerCase();\r\n\r\n    if (lowerModel.includes('llama3.1') || lowerModel.includes('llama-3.1')) {\r\n      return 128000;\r\n    }\r\n    if (lowerModel.includes('llama3') || lowerModel.includes('llama-3')) {\r\n      return 8192;\r\n    }\r\n    if (lowerModel.includes('mistral')) {\r\n      return 32768;\r\n    }\r\n    if (lowerModel.includes('mixtral')) {\r\n      return 32768;\r\n    }\r\n\r\n    return 4096; // Default context length\r\n  }\r\n\r\n  private getDefaultResourceInfo(): LlmResourceInfo {\r\n    return {\r\n      gpuRequired: false,\r\n      gpuMemoryGb: undefined,\r\n      cpuCores: 4,\r\n      ramGb: 8,\r\n    };\r\n  }\r\n\r\n  private parseResourceRequirements(\r\n    showData: OllamaShowResponse,\r\n    modelId: string\r\n  ): LlmResourceInfo {\r\n    const paramSize = showData.details?.parameter_size ?? '';\r\n    const quantLevel = showData.details?.quantization_level ?? '';\r\n\r\n    // Estimate GPU memory based on parameter count and quantization\r\n    const gpuMemoryGb = this.estimateGpuMemory(paramSize, quantLevel, modelId);\r\n\r\n    return {\r\n      gpuRequired: gpuMemoryGb > 4,\r\n      gpuMemoryGb: gpuMemoryGb > 0 ? gpuMemoryGb : undefined,\r\n      cpuCores: gpuMemoryGb > 8 ? 8 : 4,\r\n      ramGb: Math.max(8, gpuMemoryGb * 1.5),\r\n    };\r\n  }\r\n\r\n  private estimateGpuMemory(\r\n    paramSize: string,\r\n    quantLevel: string,\r\n    modelId: string\r\n  ): number {\r\n    // Parse parameter size (e.g., \"8B\", \"70B\")\r\n    const paramMatch = paramSize.match(/(\\d+(?:\\.\\d+)?)\\s*[Bb]/);\r\n    let params = paramMatch?.[1] ? parseFloat(paramMatch[1]) : 0;\r\n\r\n    // If not in paramSize, try to extract from model name\r\n    if (params === 0) {\r\n      const modelMatch = modelId.match(/(\\d+)[Bb]/);\r\n      params = modelMatch?.[1] ? parseFloat(modelMatch[1]) : 7; // Default to 7B\r\n    }\r\n\r\n    // Quantization factor (lower bits = less memory)\r\n    let quantFactor = 2; // Default FP16\r\n    if (quantLevel.includes('Q4') || quantLevel.includes('q4')) {\r\n      quantFactor = 0.5;\r\n    } else if (quantLevel.includes('Q8') || quantLevel.includes('q8')) {\r\n      quantFactor = 1;\r\n    }\r\n\r\n    // Rough estimate: params in billions * bytes per param\r\n    return Math.ceil(params * quantFactor);\r\n  }\r\n}\r\n","import type { LlmModelInfo, LlmResourceInfo } from '@mentor-ai/shared/types';\r\nimport type { LlmProvider, LlmProviderOptions } from './llm-provider.interface';\r\n\r\nconst OPENAI_API_BASE = 'https://api.openai.com/v1';\r\n\r\ninterface OpenAIModel {\r\n  id: string;\r\n  object: string;\r\n  owned_by: string;\r\n}\r\n\r\ninterface OpenAIModelsResponse {\r\n  data: OpenAIModel[];\r\n}\r\n\r\n/**\r\n * OpenAI provider implementation.\r\n * Validates API keys and fetches available models from OpenAI API.\r\n */\r\nexport class OpenAIProvider implements LlmProvider {\r\n  private readonly apiKey: string;\r\n\r\n  constructor(options: LlmProviderOptions) {\r\n    if (!options.apiKey) {\r\n      throw new Error('OpenAI requires an API key');\r\n    }\r\n    this.apiKey = options.apiKey;\r\n  }\r\n\r\n  async validateCredentials(): Promise<boolean> {\r\n    try {\r\n      const response = await fetch(`${OPENAI_API_BASE}/models`, {\r\n        method: 'GET',\r\n        headers: {\r\n          Authorization: `Bearer ${this.apiKey}`,\r\n        },\r\n      });\r\n\r\n      return response.ok;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async fetchModels(): Promise<LlmModelInfo[]> {\r\n    const response = await fetch(`${OPENAI_API_BASE}/models`, {\r\n      method: 'GET',\r\n      headers: {\r\n        Authorization: `Bearer ${this.apiKey}`,\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch models: ${response.statusText}`);\r\n    }\r\n\r\n    const data = (await response.json()) as OpenAIModelsResponse;\r\n\r\n    // Filter to chat-capable models\r\n    const chatModelPrefixes = ['gpt-5', 'gpt-4', 'gpt-3.5', 'chatgpt', 'o1', 'o3'];\r\n\r\n    // Preferred models shown first\r\n    const preferredOrder = [\r\n      'gpt-5.2-chat-latest',\r\n      'gpt-5.2',\r\n      'gpt-5',\r\n      'gpt-5-mini',\r\n      'gpt-5-nano',\r\n      'gpt-4o',\r\n      'gpt-4o-mini',\r\n      'gpt-4-turbo',\r\n      'gpt-4',\r\n      'gpt-3.5-turbo',\r\n      'o3',\r\n      'o3-mini',\r\n      'o1',\r\n      'o1-mini',\r\n    ];\r\n\r\n    return data.data\r\n      .filter((model) => chatModelPrefixes.some((prefix) => model.id.startsWith(prefix)))\r\n      .map((model) => ({\r\n        id: model.id,\r\n        name: model.id,\r\n        costPer1kTokens: null,\r\n        contextLength: undefined,\r\n      }))\r\n      .sort((a, b) => {\r\n        const aIdx = preferredOrder.findIndex((p) => a.id.startsWith(p));\r\n        const bIdx = preferredOrder.findIndex((p) => b.id.startsWith(p));\r\n        const aPriority = aIdx >= 0 ? aIdx : 100;\r\n        const bPriority = bIdx >= 0 ? bIdx : 100;\r\n        if (aPriority !== bPriority) return aPriority - bPriority;\r\n        return a.name.localeCompare(b.name);\r\n      })\r\n      .slice(0, 30);\r\n  }\r\n\r\n  async getResourceInfo(): Promise<LlmResourceInfo | null> {\r\n    return null;\r\n  }\r\n}\r\n","import type { LlmModelInfo, LlmResourceInfo } from '@mentor-ai/shared/types';\r\nimport type { LlmProvider, LlmProviderOptions } from './llm-provider.interface';\r\n\r\nconst DEFAULT_LM_STUDIO_ENDPOINT = 'http://localhost:1234';\r\n\r\ninterface LmStudioModel {\r\n  id: string;\r\n  object: string;\r\n  owned_by?: string;\r\n}\r\n\r\ninterface LmStudioModelsResponse {\r\n  data: LmStudioModel[];\r\n}\r\n\r\n/**\r\n * LM Studio / OpenAI-compatible provider implementation.\r\n * Uses the OpenAI-compatible API at a configurable endpoint.\r\n * Supports optional API key authentication (needed for RunPod, vLLM, etc.).\r\n * No API key required by default (local LM Studio).\r\n */\r\nexport class LmStudioProvider implements LlmProvider {\r\n  private readonly endpoint: string;\r\n  private readonly apiKey?: string;\r\n\r\n  constructor(options: LlmProviderOptions) {\r\n    this.endpoint = options.endpoint ?? DEFAULT_LM_STUDIO_ENDPOINT;\r\n    this.apiKey = options.apiKey;\r\n  }\r\n\r\n  private getHeaders(): Record<string, string> {\r\n    const headers: Record<string, string> = { 'Content-Type': 'application/json' };\r\n    if (this.apiKey) {\r\n      headers['Authorization'] = `Bearer ${this.apiKey}`;\r\n    }\r\n    return headers;\r\n  }\r\n\r\n  async validateCredentials(): Promise<boolean> {\r\n    try {\r\n      const response = await fetch(`${this.endpoint}/v1/models`, {\r\n        method: 'GET',\r\n        headers: this.getHeaders(),\r\n      });\r\n\r\n      return response.ok;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async fetchModels(): Promise<LlmModelInfo[]> {\r\n    const response = await fetch(`${this.endpoint}/v1/models`, {\r\n      method: 'GET',\r\n      headers: this.getHeaders(),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch models: ${response.statusText}`);\r\n    }\r\n\r\n    const data = (await response.json()) as LmStudioModelsResponse;\r\n\r\n    return data.data.map((model) => ({\r\n      id: model.id,\r\n      name: model.id,\r\n      costPer1kTokens: null,\r\n      contextLength: undefined,\r\n    }));\r\n  }\r\n\r\n  async getResourceInfo(): Promise<LlmResourceInfo | null> {\r\n    return {\r\n      gpuRequired: false,\r\n      gpuMemoryGb: undefined,\r\n      cpuCores: undefined,\r\n      ramGb: undefined,\r\n    };\r\n  }\r\n}\r\n","import type { LlmModelInfo, LlmResourceInfo } from '@mentor-ai/shared/types';\r\nimport type { LlmProvider, LlmProviderOptions } from './llm-provider.interface';\r\n\r\nconst DEEPSEEK_API_BASE = 'https://api.deepseek.com/v1';\r\n\r\ninterface DeepSeekModel {\r\n  id: string;\r\n  object: string;\r\n  owned_by?: string;\r\n}\r\n\r\ninterface DeepSeekModelsResponse {\r\n  data: DeepSeekModel[];\r\n}\r\n\r\n/**\r\n * DeepSeek provider implementation.\r\n * Uses the OpenAI-compatible API at https://api.deepseek.com/v1.\r\n */\r\nexport class DeepSeekProvider implements LlmProvider {\r\n  private readonly apiKey: string;\r\n\r\n  constructor(options: LlmProviderOptions) {\r\n    if (!options.apiKey) {\r\n      throw new Error('DeepSeek requires an API key');\r\n    }\r\n    this.apiKey = options.apiKey;\r\n  }\r\n\r\n  async validateCredentials(): Promise<boolean> {\r\n    try {\r\n      const response = await fetch(`${DEEPSEEK_API_BASE}/models`, {\r\n        method: 'GET',\r\n        headers: {\r\n          Authorization: `Bearer ${this.apiKey}`,\r\n        },\r\n      });\r\n\r\n      return response.ok;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async fetchModels(): Promise<LlmModelInfo[]> {\r\n    const response = await fetch(`${DEEPSEEK_API_BASE}/models`, {\r\n      method: 'GET',\r\n      headers: {\r\n        Authorization: `Bearer ${this.apiKey}`,\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch models: ${response.statusText}`);\r\n    }\r\n\r\n    const data = (await response.json()) as DeepSeekModelsResponse;\r\n\r\n    return data.data.map((model) => ({\r\n      id: model.id,\r\n      name: model.id,\r\n      costPer1kTokens: null,\r\n      contextLength: undefined,\r\n    }));\r\n  }\r\n\r\n  async getResourceInfo(): Promise<LlmResourceInfo | null> {\r\n    return null;\r\n  }\r\n}\r\n","import { IsString, IsOptional, IsEnum, IsNotEmpty, IsUrl, ValidateNested } from 'class-validator';\r\nimport { Type } from 'class-transformer';\r\nimport { LlmProviderType } from '@mentor-ai/shared/types';\r\n\r\nclass ProviderConfigDto {\r\n  @IsEnum(LlmProviderType, { message: 'Invalid provider type' })\r\n  @IsNotEmpty({ message: 'Provider type is required' })\r\n  type!: LlmProviderType;\r\n\r\n  @IsString({ message: 'API key must be a string' })\r\n  @IsOptional()\r\n  apiKey?: string;\r\n\r\n  @IsUrl({ require_tld: false }, { message: 'Endpoint must be a valid URL' })\r\n  @IsOptional()\r\n  endpoint?: string;\r\n\r\n  @IsString({ message: 'Model ID must be a string' })\r\n  @IsNotEmpty({ message: 'Model ID is required' })\r\n  modelId!: string;\r\n}\r\n\r\nexport class UpdateLlmConfigDto {\r\n  @ValidateNested()\r\n  @Type(() => ProviderConfigDto)\r\n  @IsNotEmpty({ message: 'Primary provider is required' })\r\n  primaryProvider!: ProviderConfigDto;\r\n\r\n  @ValidateNested()\r\n  @Type(() => ProviderConfigDto)\r\n  @IsOptional()\r\n  fallbackProvider?: ProviderConfigDto | null;\r\n}\r\n","module.exports = require(\"class-transformer\");","export * from './lib/types';\r\n","/**\r\n * Shared TypeScript interfaces for Mentor AI\r\n * These types are used across both frontend (Angular) and backend (NestJS)\r\n */\r\n\r\n/** Base entity with common fields */\r\nexport interface BaseEntity {\r\n  id: string;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\n/** API response wrapper */\r\nexport interface ApiResponse<T> {\r\n  data: T;\r\n  message?: string;\r\n  success: boolean;\r\n}\r\n\r\n/** Pagination metadata */\r\nexport interface PaginationMeta {\r\n  page: number;\r\n  limit: number;\r\n  total: number;\r\n  totalPages: number;\r\n}\r\n\r\n/** Paginated response */\r\nexport interface PaginatedResponse<T> extends ApiResponse<T[]> {\r\n  meta: PaginationMeta;\r\n}\r\n\r\n/** User entity */\r\nexport interface User extends BaseEntity {\r\n  email: string;\r\n  displayName: string;\r\n  avatarUrl?: string;\r\n}\r\n\r\n/** Error response */\r\nexport interface ApiError {\r\n  statusCode: number;\r\n  message: string;\r\n  error?: string;\r\n}\r\n\r\n/** Invitation status */\r\nexport enum InvitationStatus {\r\n  PENDING = 'PENDING',\r\n  ACCEPTED = 'ACCEPTED',\r\n  EXPIRED = 'EXPIRED',\r\n  REVOKED = 'REVOKED',\r\n}\r\n\r\n/** Department assignment */\r\nexport enum Department {\r\n  FINANCE = 'FINANCE',\r\n  MARKETING = 'MARKETING',\r\n  TECHNOLOGY = 'TECHNOLOGY',\r\n  OPERATIONS = 'OPERATIONS',\r\n  LEGAL = 'LEGAL',\r\n  CREATIVE = 'CREATIVE',\r\n  STRATEGY = 'STRATEGY',\r\n  SALES = 'SALES',\r\n}\r\n\r\n/** Full list of industries for onboarding */\r\nexport const INDUSTRIES = [\r\n  'Accounting & Finance',\r\n  'Agriculture',\r\n  'Automotive',\r\n  'Construction & Real Estate',\r\n  'Consulting',\r\n  'Education',\r\n  'Energy & Utilities',\r\n  'Entertainment & Media',\r\n  'Food & Beverage',\r\n  'Government',\r\n  'Healthcare',\r\n  'Hospitality & Tourism',\r\n  'Insurance',\r\n  'Legal Services',\r\n  'Manufacturing',\r\n  'Non-Profit',\r\n  'Professional Services',\r\n  'Retail & E-Commerce',\r\n  'SaaS & Technology',\r\n  'Telecommunications',\r\n  'Transportation & Logistics',\r\n  'Other',\r\n] as const;\r\n\r\nexport type Industry = (typeof INDUSTRIES)[number];\r\n\r\n/** Invitation entity */\r\nexport interface Invitation extends BaseEntity {\r\n  email: string;\r\n  department: Department;\r\n  role: string;\r\n  status: InvitationStatus;\r\n  token: string;\r\n  expiresAt: Date;\r\n  tenantId: string;\r\n  invitedById: string;\r\n  acceptedByUserId?: string | null;\r\n}\r\n\r\n/** Create invitation request */\r\nexport interface CreateInvitationRequest {\r\n  email: string;\r\n  department: Department;\r\n}\r\n\r\n/** Invitation response from API */\r\nexport interface InvitationResponse extends Invitation {\r\n  tenantName?: string;\r\n  invitedByEmail?: string;\r\n}\r\n\r\n/** Team member removal strategy */\r\nexport type RemovalStrategy = 'REASSIGN' | 'ARCHIVE';\r\n\r\n/** Remove member request body */\r\nexport interface RemoveMemberRequest {\r\n  strategy: RemovalStrategy;\r\n}\r\n\r\n/** Team member response for listing active members */\r\nexport interface TeamMemberResponse {\r\n  id: string;\r\n  email: string;\r\n  name: string | null;\r\n  role: string;\r\n  department: string | null;\r\n  createdAt: Date;\r\n}\r\n\r\n/** Backup owner response */\r\nexport interface BackupOwnerResponse {\r\n  id: string;\r\n  email: string;\r\n  name: string | null;\r\n  designatedAt: string;\r\n}\r\n\r\n/** Request to designate a backup owner */\r\nexport interface DesignateBackupOwnerRequest {\r\n  backupOwnerId: string;\r\n}\r\n\r\n/** Backup owner status for warning banner check */\r\nexport interface BackupOwnerStatus {\r\n  hasBackupOwner: boolean;\r\n  tenantAgeDays: number;\r\n  showWarning: boolean;\r\n}\r\n\r\n/** Recovery result */\r\nexport interface RecoveryResult {\r\n  recoveredUserId: string;\r\n  message: string;\r\n}\r\n\r\n//  Data Export Types \r\n// NOTE: These enums intentionally mirror the Prisma schema enums (ExportFormat, ExportStatus).\r\n// Prisma generates its own types from schema.prisma, but frontend cannot import @prisma/client.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** Export format options */\r\nexport enum ExportFormat {\r\n  PDF = 'PDF',\r\n  MARKDOWN = 'MARKDOWN',\r\n  JSON = 'JSON',\r\n}\r\n\r\n/** Export status tracking */\r\nexport enum ExportStatus {\r\n  PENDING = 'PENDING',\r\n  PROCESSING = 'PROCESSING',\r\n  COMPLETED = 'COMPLETED',\r\n  FAILED = 'FAILED',\r\n  EXPIRED = 'EXPIRED',\r\n}\r\n\r\n/** Request to initiate a data export */\r\nexport interface DataExportRequest {\r\n  format: ExportFormat;\r\n  dataTypes: string[]; // [\"all\", \"profile\", \"invitations\"]\r\n}\r\n\r\n/** Single data export record response */\r\nexport interface DataExportResponse {\r\n  exportId: string;\r\n  status: ExportStatus;\r\n  format: ExportFormat;\r\n  dataTypes: string[];\r\n  fileSize: number | null;\r\n  requestedAt: string;\r\n  completedAt: string | null;\r\n  expiresAt: string | null;\r\n  downloadUrl: string | null;\r\n}\r\n\r\n/** Section of collected export data */\r\nexport interface ExportDataSection {\r\n  key: string;\r\n  title: string;\r\n  items: Record<string, unknown>[];\r\n  itemCount: number;\r\n}\r\n\r\n//  Tenant Deletion Types \r\n// NOTE: TenantStatus intentionally mirrors the Prisma schema enum.\r\n// Prisma generates its own types from schema.prisma, but frontend cannot import @prisma/client.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** Tenant status tracking */\r\nexport enum TenantStatus {\r\n  DRAFT = 'DRAFT',\r\n  ONBOARDING = 'ONBOARDING',\r\n  ACTIVE = 'ACTIVE',\r\n  SUSPENDED = 'SUSPENDED',\r\n  PENDING_DELETION = 'PENDING_DELETION',\r\n  DELETED = 'DELETED',\r\n}\r\n\r\n/** Request to initiate tenant deletion */\r\nexport interface TenantDeletionRequest {\r\n  workspaceName: string;\r\n}\r\n\r\n/** Tenant deletion status response */\r\nexport interface TenantDeletionStatusResponse {\r\n  status: TenantStatus;\r\n  requestedAt: string | null;\r\n  gracePeriodEndsAt: string | null;\r\n  estimatedCompletionBy: string | null;\r\n  canCancel: boolean;\r\n  /** Tenant name for type-to-confirm validation */\r\n  tenantName?: string;\r\n  /** Number of active team members who will lose access */\r\n  memberCount?: number;\r\n}\r\n\r\n/** Response after initiating tenant deletion */\r\nexport interface TenantDeletionResponse {\r\n  data: TenantDeletionStatusResponse;\r\n  message: string;\r\n}\r\n\r\n//  LLM Provider Configuration Types \r\n// NOTE: LlmProviderType intentionally mirrors the Prisma schema enum.\r\n// Prisma generates its own types from schema.prisma, but frontend cannot import @prisma/client.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** LLM provider types supported by the platform */\r\nexport enum LlmProviderType {\r\n  OPENROUTER = 'OPENROUTER',\r\n  LOCAL_LLAMA = 'LOCAL_LLAMA',\r\n  OPENAI = 'OPENAI',\r\n  ANTHROPIC = 'ANTHROPIC',\r\n  LM_STUDIO = 'LM_STUDIO',\r\n  DEEPSEEK = 'DEEPSEEK',\r\n}\r\n\r\n/** Single LLM provider configuration */\r\nexport interface LlmProviderConfig {\r\n  id: string;\r\n  providerType: LlmProviderType;\r\n  apiKey?: string; // Masked on read, full value on write\r\n  endpoint?: string;\r\n  modelId: string;\r\n  isPrimary: boolean;\r\n  isFallback: boolean;\r\n  isActive: boolean;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\n/** Model information from provider */\r\nexport interface LlmModelInfo {\r\n  id: string;\r\n  name: string;\r\n  costPer1kTokens: number | null;\r\n  contextLength?: number;\r\n}\r\n\r\n/** Resource requirements for local LLM */\r\nexport interface LlmResourceInfo {\r\n  gpuRequired: boolean;\r\n  gpuMemoryGb?: number;\r\n  cpuCores?: number;\r\n  ramGb?: number;\r\n}\r\n\r\n/** Provider validation status/result */\r\nexport interface LlmProviderStatus {\r\n  valid: boolean;\r\n  models: LlmModelInfo[];\r\n  resourceInfo: LlmResourceInfo | null;\r\n  errorMessage?: string;\r\n}\r\n\r\n/** Single provider configuration for update request */\r\nexport interface LlmProviderUpdatePayload {\r\n  type: LlmProviderType;\r\n  apiKey?: string;\r\n  endpoint?: string;\r\n  modelId: string;\r\n}\r\n\r\n/** Request to update LLM configuration */\r\nexport interface LlmConfigUpdateRequest {\r\n  primaryProvider: LlmProviderUpdatePayload;\r\n  fallbackProvider?: LlmProviderUpdatePayload | null;\r\n}\r\n\r\n/** Response containing current LLM configuration */\r\nexport interface LlmConfigResponse {\r\n  primaryProvider: LlmProviderConfig | null;\r\n  fallbackProvider: LlmProviderConfig | null;\r\n}\r\n\r\n/** Request to validate a provider's credentials */\r\nexport interface LlmValidateProviderRequest {\r\n  type: LlmProviderType;\r\n  apiKey?: string;\r\n  endpoint?: string;\r\n}\r\n\r\n/** Response from provider validation */\r\nexport interface LlmValidateProviderResponse {\r\n  data: LlmProviderStatus;\r\n}\r\n\r\n/** Audit log entry for LLM config changes */\r\nexport interface LlmConfigAuditLogEntry {\r\n  id: string;\r\n  action: 'CREATE' | 'UPDATE' | 'DELETE';\r\n  changedBy: string;\r\n  previousVal: Record<string, unknown> | null;\r\n  newVal: Record<string, unknown>;\r\n  createdAt: string;\r\n}\r\n\r\n//  Chat Conversation Types (Story 2.1) \r\n// NOTE: MessageRole intentionally mirrors the Prisma schema enum.\r\n// Prisma generates its own types from schema.prisma, but frontend cannot import @prisma/client.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** Message role in conversation */\r\nexport enum MessageRole {\r\n  USER = 'USER',\r\n  ASSISTANT = 'ASSISTANT',\r\n}\r\n\r\n/** Chat conversation session */\r\nexport interface Conversation {\r\n  id: string; // sess_ prefix\r\n  userId: string;\r\n  title: string | null;\r\n  personaType: PersonaType | null; // Selected department persona (Story 2.4)\r\n  conceptId: string | null; // Links to platform Concept for tree organization\r\n  conceptName?: string | null; // Denormalized concept name for display\r\n  conceptCategory?: string | null; // Denormalized concept category for display\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\n/** Individual chat message */\r\nexport interface Message {\r\n  id: string; // msg_ prefix\r\n  conversationId: string;\r\n  role: MessageRole;\r\n  content: string;\r\n  /** Confidence score for AI messages (0.0-1.0), null for user messages */\r\n  confidenceScore: number | null;\r\n  /** Confidence factor breakdown for AI messages */\r\n  confidenceFactors: ConfidenceFactor[] | null;\r\n  /** Concept citations in this message (Story 2.6) */\r\n  citations?: ConceptCitation[];\r\n  /** Memory attributions for context references (Story 2.7) */\r\n  memoryAttributions?: MemoryAttribution[];\r\n  /** Web search source URLs used for this AI response (Story 3.11) */\r\n  webSearchSources?: WebSearchSource[];\r\n  /** Suggested next actions after this AI response (D1) */\r\n  suggestedActions?: SuggestedAction[];\r\n  /** File attachments on this message */\r\n  attachments?: AttachmentItem[];\r\n  createdAt: string;\r\n}\r\n\r\n/** Web search source reference displayed under AI messages (Story 3.11) */\r\nexport interface WebSearchSource {\r\n  title: string;\r\n  link: string;\r\n}\r\n\r\n/** File attachment metadata for display in chat and tasks */\r\nexport interface AttachmentItem {\r\n  id: string;\r\n  filename: string;\r\n  originalName: string;\r\n  mimeType: string;\r\n  size: number;\r\n  createdAt: string;\r\n}\r\n\r\n/** Conversation with messages included */\r\nexport interface ConversationWithMessages extends Conversation {\r\n  messages: Message[];\r\n}\r\n\r\n/** Request to create a new conversation */\r\nexport interface CreateConversationRequest {\r\n  title?: string;\r\n  personaType?: PersonaType;\r\n  conceptId?: string;\r\n}\r\n\r\n/** Curriculum node from reference JSON */\r\nexport interface CurriculumNode {\r\n  id: string; // slug identifier\r\n  parentId: string | null;\r\n  label: string; // Serbian display name\r\n  sortOrder: number;\r\n}\r\n\r\n/** Hierarchical concept tree node (for sidebar) */\r\nexport interface ConceptHierarchyNode {\r\n  curriculumId: string;\r\n  label: string;\r\n  conceptId?: string; // DB concept ID if created\r\n  children: ConceptHierarchyNode[];\r\n  conversationCount: number; // Total conversations in this subtree\r\n  conversations: Conversation[]; // Direct conversations (only on leaf concepts)\r\n  /** Brain tree status: 'completed' | 'pending' (from task note status) */\r\n  status?: 'completed' | 'pending';\r\n  /** User who completed this concept's task */\r\n  completedByUserId?: string;\r\n  /** Note ID for pending task (for \"Istrai\" action) */\r\n  pendingNoteId?: string;\r\n  /** Conversation ID linked to this concept (for \"Pogledaj\" navigation) */\r\n  linkedConversationId?: string;\r\n}\r\n\r\n/** Full concept tree structure for sidebar */\r\nexport interface ConceptTreeData {\r\n  tree: ConceptHierarchyNode[]; // Hierarchical (replaces old categories)\r\n  uncategorized: Conversation[];\r\n}\r\n\r\n// Legacy types kept for backward compatibility during migration\r\n/** @deprecated Use ConceptHierarchyNode instead */\r\nexport interface ConceptTreeCategory {\r\n  category: string;\r\n  concepts: ConceptTreeNode[];\r\n}\r\n\r\n/** @deprecated Use ConceptHierarchyNode instead */\r\nexport interface ConceptTreeNode {\r\n  conceptId: string;\r\n  conceptName: string;\r\n  conversations: Conversation[];\r\n}\r\n\r\n/** Response for single conversation */\r\nexport interface ConversationResponse {\r\n  data: ConversationWithMessages;\r\n}\r\n\r\n/** Response for conversation list */\r\nexport interface ConversationsListResponse {\r\n  data: Conversation[];\r\n}\r\n\r\n/** Request to send a message in a conversation */\r\nexport interface SendMessageRequest {\r\n  content: string;\r\n}\r\n\r\n/** WebSocket event: Client sends message to server */\r\nexport interface ChatMessageSend {\r\n  conversationId: string;\r\n  content: string;\r\n}\r\n\r\n/** WebSocket event: Server streams message chunk to client */\r\nexport interface ChatMessageChunk {\r\n  content: string;\r\n  index: number;\r\n}\r\n\r\n/** WebSocket event: Server signals message completion */\r\nexport interface ChatComplete {\r\n  messageId: string;\r\n  fullContent: string;\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\n/** Suggested action after AI response (D1) */\r\nexport interface SuggestedAction {\r\n  type:\r\n    | 'create_tasks'\r\n    | 'run_workflow'\r\n    | 'explore_concept'\r\n    | 'deep_dive'\r\n    | 'next_domain'\r\n    | 'score_task'\r\n    | 'view_tasks'\r\n    | 'save_note'\r\n    | 'web_search';\r\n  label: string;\r\n  icon: 'tasks' | 'workflow' | 'explore' | 'search' | 'arrow' | 'score' | 'note' | 'web';\r\n  payload?: Record<string, unknown>;\r\n}\r\n\r\n//  AI Gateway Types (Story 2.2) \r\n// Types for rate limiting, token tracking, and circuit breaker\r\n\r\n/** Chat message format for AI conversations */\r\nexport interface ChatMessage {\r\n  role: 'user' | 'assistant' | 'system';\r\n  content: string;\r\n}\r\n\r\n/** Time period for usage queries */\r\nexport type UsagePeriod = 'day' | 'week' | 'month' | 'all';\r\n\r\n/** Rate limit headers for HTTP responses */\r\nexport interface RateLimitHeaders {\r\n  'X-RateLimit-Limit': string;\r\n  'X-RateLimit-Remaining': string;\r\n  'X-RateLimit-Reset': string;\r\n  'Retry-After'?: string;\r\n}\r\n\r\n/** Pricing structure for a model */\r\nexport interface ModelPricing {\r\n  /** Cost per 1000 input tokens in USD */\r\n  input: number;\r\n  /** Cost per 1000 output tokens in USD */\r\n  output: number;\r\n}\r\n\r\n/** Cost calculation result */\r\nexport interface CostCalculation {\r\n  /** Cost for input tokens */\r\n  inputCost: number;\r\n  /** Cost for output tokens */\r\n  outputCost: number;\r\n  /** Total cost */\r\n  totalCost: number;\r\n  /** Model ID used for calculation */\r\n  modelId: string;\r\n  /** Whether pricing was found for the model */\r\n  pricingFound: boolean;\r\n}\r\n\r\n/** Circuit breaker status information */\r\nexport interface CircuitBreakerStatus {\r\n  state: CircuitBreakerState;\r\n  failures: number;\r\n  lastFailure?: number;\r\n  lastSuccess?: number;\r\n  openedAt?: number;\r\n}\r\n\r\n/** Circuit breaker event for monitoring (alias for SystemCircuitBreaker) */\r\nexport type CircuitBreakerEvent = SystemCircuitBreaker;\r\n\r\n/** Token usage record for tracking AI consumption */\r\nexport interface TokenUsage {\r\n  id: string; // tku_ prefix\r\n  tenantId: string;\r\n  userId: string;\r\n  conversationId?: string;\r\n  inputTokens: number;\r\n  outputTokens: number;\r\n  totalTokens: number;\r\n  cost: number;\r\n  modelId: string;\r\n  providerId?: string;\r\n  createdAt: string;\r\n}\r\n\r\n/** Aggregated usage summary for reporting */\r\nexport interface UsageSummary {\r\n  totalTokens: number;\r\n  inputTokens: number;\r\n  outputTokens: number;\r\n  totalCost: number;\r\n  requestCount: number;\r\n}\r\n\r\n/** Rate limit information for responses */\r\nexport interface RateLimitInfo {\r\n  /** Whether the request is allowed */\r\n  allowed: boolean;\r\n  /** Maximum requests allowed in the window */\r\n  limit: number;\r\n  /** Remaining requests in the current window */\r\n  remaining: number;\r\n  /** Unix timestamp when the rate limit resets */\r\n  reset: number;\r\n  /** Retry-After value in seconds (only present when rate limited) */\r\n  retryAfter?: number;\r\n  /** Type of limit that was exceeded (tenant or user) */\r\n  limitType?: 'tenant' | 'user';\r\n}\r\n\r\n/** Quota status for a tenant */\r\nexport interface QuotaStatus {\r\n  /** Whether the request is allowed */\r\n  allowed: boolean;\r\n  /** Remaining tokens in quota */\r\n  remaining: number;\r\n  /** Total quota limit */\r\n  limit: number;\r\n  /** Tokens used so far */\r\n  used: number;\r\n  /** Percentage of quota used (0-100) */\r\n  percentUsed: number;\r\n}\r\n\r\n/** Circuit breaker states */\r\nexport enum CircuitBreakerState {\r\n  /** Normal operation - requests flow through */\r\n  CLOSED = 'CLOSED',\r\n  /** Circuit tripped - all requests rejected */\r\n  OPEN = 'OPEN',\r\n  /** Testing - allow one request to check if service recovered */\r\n  HALF_OPEN = 'HALF_OPEN',\r\n}\r\n\r\n/** WebSocket event: Queue position update */\r\nexport interface ChatQueuePosition {\r\n  position: number;\r\n  estimatedWait: number; // seconds\r\n  requestId: string;\r\n}\r\n\r\n/** WebSocket event: Circuit breaker state change */\r\nexport interface SystemCircuitBreaker {\r\n  eventId: string;\r\n  providerId: string;\r\n  previousState: CircuitBreakerState;\r\n  newState: CircuitBreakerState;\r\n  failures: number;\r\n  timestamp: number;\r\n  /** Correlation ID for request tracing */\r\n  correlationId?: string;\r\n}\r\n\r\n//  Department Persona Types (Story 2.4) \r\n// Types for department-specific AI personas\r\n// NOTE: PersonaType intentionally mirrors the Prisma schema enum.\r\n// Prisma generates its own types from schema.prisma, but frontend cannot import @prisma/client.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** Persona type for department-specific AI responses */\r\nexport enum PersonaType {\r\n  CFO = 'CFO',\r\n  CMO = 'CMO',\r\n  CTO = 'CTO',\r\n  OPERATIONS = 'OPERATIONS',\r\n  LEGAL = 'LEGAL',\r\n  CREATIVE = 'CREATIVE',\r\n  CSO = 'CSO',\r\n  SALES = 'SALES',\r\n}\r\n\r\n/**\r\n * Persona colors for UI theming (dark mode compatible).\r\n * Single source of truth for persona color values.\r\n */\r\nexport const PERSONA_COLORS: Record<PersonaType, string> = {\r\n  [PersonaType.CFO]: '#10B981', // Emerald green (financial stability)\r\n  [PersonaType.CMO]: '#F59E0B', // Amber (energy, creativity)\r\n  [PersonaType.CTO]: '#3B82F6', // Blue (technology, trust)\r\n  [PersonaType.OPERATIONS]: '#8B5CF6', // Purple (efficiency, process)\r\n  [PersonaType.LEGAL]: '#6B7280', // Gray (neutrality, formality)\r\n  [PersonaType.CREATIVE]: '#EC4899', // Pink (creativity, innovation)\r\n  [PersonaType.CSO]: '#F97316', // Orange (strategy, vision)\r\n  [PersonaType.SALES]: '#06B6D4', // Cyan (sales, connection)\r\n};\r\n\r\n/**\r\n * Persona display names for UI.\r\n * Single source of truth for persona short names.\r\n */\r\nexport const PERSONA_NAMES: Record<PersonaType, string> = {\r\n  [PersonaType.CFO]: 'CFO',\r\n  [PersonaType.CMO]: 'CMO',\r\n  [PersonaType.CTO]: 'CTO',\r\n  [PersonaType.OPERATIONS]: 'COO',\r\n  [PersonaType.LEGAL]: 'Legal',\r\n  [PersonaType.CREATIVE]: 'Creative',\r\n  [PersonaType.CSO]: 'CSO',\r\n  [PersonaType.SALES]: 'Sales',\r\n};\r\n\r\n/** Department persona definition */\r\nexport interface Persona {\r\n  /** Unique persona identifier with prs_ prefix */\r\n  id: string;\r\n  /** Persona type enum value */\r\n  type: PersonaType;\r\n  /** Full persona name (e.g., \"Chief Financial Officer\") */\r\n  name: string;\r\n  /** Short name (e.g., \"CFO\") */\r\n  shortName: string;\r\n  /** Brief description of the persona's expertise */\r\n  description: string;\r\n  /** Path to the persona's avatar image */\r\n  avatarUrl: string;\r\n  /** Hex color code for UI theming */\r\n  color: string;\r\n}\r\n\r\n/** Persona system prompt configuration */\r\nexport interface PersonaSystemPrompt {\r\n  /** Persona type */\r\n  type: PersonaType;\r\n  /** System prompt for AI context (~500 tokens) */\r\n  systemPrompt: string;\r\n  /** List of capabilities */\r\n  capabilities: string[];\r\n  /** List of limitations */\r\n  limitations: string[];\r\n}\r\n\r\n/** Request to update conversation persona */\r\nexport interface UpdatePersonaRequest {\r\n  /** Persona type to set */\r\n  personaType: PersonaType;\r\n}\r\n\r\n/** Response containing all available personas */\r\nexport interface PersonasListResponse {\r\n  data: Persona[];\r\n}\r\n\r\n/** Response containing single persona */\r\nexport interface PersonaResponse {\r\n  data: Persona;\r\n}\r\n\r\n//  Confidence Scoring Types (Story 2.5) \r\n// Types for AI response confidence scoring and improvement suggestions\r\n\r\n/** Confidence level thresholds */\r\nexport enum ConfidenceLevel {\r\n  /** High confidence: 85-100% */\r\n  HIGH = 'HIGH',\r\n  /** Medium confidence: 50-84% */\r\n  MEDIUM = 'MEDIUM',\r\n  /** Low confidence: 0-49% */\r\n  LOW = 'LOW',\r\n}\r\n\r\n/**\r\n * Confidence level colors for UI theming.\r\n * Single source of truth for confidence indicator colors.\r\n */\r\nexport const CONFIDENCE_COLORS: Record<ConfidenceLevel, string> = {\r\n  [ConfidenceLevel.HIGH]: '#22C55E', // Green\r\n  [ConfidenceLevel.MEDIUM]: '#EAB308', // Amber\r\n  [ConfidenceLevel.LOW]: '#EF4444', // Red\r\n};\r\n\r\n/** Individual factor contributing to confidence score */\r\nexport interface ConfidenceFactor {\r\n  /** Factor identifier (e.g., \"hedging_language\", \"context_depth\") */\r\n  name: string;\r\n  /** Factor score (0.0-1.0) */\r\n  score: number;\r\n  /** Factor contribution weight (should sum to 1.0 across all factors) */\r\n  weight: number;\r\n  /** Human-readable description of what this factor measures */\r\n  description?: string;\r\n}\r\n\r\n/** Complete confidence score with factor breakdown */\r\nexport interface ConfidenceScore {\r\n  /** Overall confidence score (0.0-1.0, display as percentage) */\r\n  score: number;\r\n  /** Categorized confidence level */\r\n  level: ConfidenceLevel;\r\n  /** Breakdown of individual factors */\r\n  factors: ConfidenceFactor[];\r\n  /** Actionable suggestion to improve confidence */\r\n  improvementSuggestion?: string;\r\n  /** Previous score for showing improvement delta */\r\n  previousScore?: number;\r\n}\r\n\r\n/** Improvement suggestion for low confidence responses */\r\nexport interface ImprovementSuggestion {\r\n  /** Category of missing context (e.g., \"missing_context\", \"ambiguous_question\") */\r\n  category: string;\r\n  /** User-facing actionable suggestion text */\r\n  suggestion: string;\r\n  /** Priority ranking (1 = highest) */\r\n  priority: number;\r\n}\r\n\r\n/** Context for confidence calculation */\r\nexport interface ConfidenceContext {\r\n  /** Number of messages in conversation history */\r\n  messageCount: number;\r\n  /** Whether client/project context is available */\r\n  hasClientContext: boolean;\r\n  /** Whether specific data points were provided */\r\n  hasSpecificData: boolean;\r\n  /** Active persona type */\r\n  personaType?: PersonaType;\r\n  /** User's original question */\r\n  userQuestion: string;\r\n}\r\n\r\n//  Onboarding Types (Story 2.3) \r\n// Types for the sub-5-minute first value quick win onboarding flow\r\n\r\n/** Quick task for onboarding wizard */\r\nexport interface QuickTask {\r\n  /** Unique task identifier */\r\n  id: string;\r\n  /** Display name for the task */\r\n  name: string;\r\n  /** Brief description of what the task produces */\r\n  description: string;\r\n  /** Department this task is associated with */\r\n  department: Department;\r\n  /** Estimated time this task saves the user (in minutes) */\r\n  estimatedTimeSaved: number;\r\n}\r\n\r\n/** Onboarding wizard status */\r\nexport interface OnboardingStatus {\r\n  /** Current wizard step (1, 2, 3, or 'complete') */\r\n  currentStep: 1 | 2 | 3 | 'complete';\r\n  /** Current tenant status */\r\n  tenantStatus: TenantStatus;\r\n  /** Selected industry/department from step 1 */\r\n  selectedIndustry?: string;\r\n  /** Selected task ID from step 2 */\r\n  selectedTaskId?: string;\r\n  /** Timestamp when onboarding started (ISO string) */\r\n  startedAt?: string;\r\n}\r\n\r\n/** Request to execute quick win task */\r\nexport interface QuickWinRequest {\r\n  /** Selected task ID */\r\n  taskId: string;\r\n  /** User-provided context for the task (max 280 chars) */\r\n  userContext: string;\r\n  /** Selected industry/department */\r\n  industry: string;\r\n}\r\n\r\n/** Response from quick win execution */\r\nexport interface QuickWinResponse {\r\n  /** Generated AI output */\r\n  output: string;\r\n  /** Time taken to generate (in milliseconds) */\r\n  generationTimeMs: number;\r\n  /** Token usage for this request */\r\n  tokensUsed: number;\r\n}\r\n\r\n/** Request to complete onboarding and save first note */\r\nexport interface OnboardingCompleteRequest {\r\n  /** Selected task ID */\r\n  taskId: string;\r\n  /** User-provided context */\r\n  userContext: string;\r\n  /** Selected industry */\r\n  industry: string;\r\n  /** Generated output to save as note */\r\n  generatedOutput: string;\r\n}\r\n\r\n/** Response after completing onboarding */\r\nexport interface OnboardingCompleteResponse {\r\n  /** Saved note content */\r\n  output: string;\r\n  /** Estimated time saved (in minutes) */\r\n  timeSavedMinutes: number;\r\n  /** ID of the saved note (if applicable) */\r\n  noteId?: string;\r\n  /** Celebration message to display */\r\n  celebrationMessage: string;\r\n  /** New tenant status (should be ACTIVE) */\r\n  newTenantStatus: TenantStatus;\r\n  /** ID of the welcome conversation created with task list */\r\n  welcomeConversationId?: string;\r\n  /** Execution mode selected during onboarding */\r\n  executionMode?: ExecutionMode;\r\n  /** Pre-built execution plan ID (generated during onboarding) */\r\n  planId?: string;\r\n}\r\n\r\n/** Onboarding metric for analytics */\r\nexport interface OnboardingMetricResponse {\r\n  /** Metric record ID */\r\n  id: string;\r\n  /** Tenant ID */\r\n  tenantId: string;\r\n  /** User ID */\r\n  userId: string;\r\n  /** When onboarding started */\r\n  startedAt: string;\r\n  /** When onboarding completed (null if not complete) */\r\n  completedAt: string | null;\r\n  /** Time to first value in milliseconds */\r\n  timeToFirstValueMs: number | null;\r\n  /** Quick task type used */\r\n  quickTaskType: string;\r\n  /** Industry selected */\r\n  industry: string;\r\n}\r\n\r\n//  Business Concept Types (Story 3.1) \r\n// Types for the business concepts knowledge base\r\n// NOTE: RelationshipType and ConceptCategory intentionally mirror the Prisma schema.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** Category for business concepts (matches departments) */\r\nexport enum ConceptCategory {\r\n  FINANCE = 'Finance',\r\n  MARKETING = 'Marketing',\r\n  TECHNOLOGY = 'Technology',\r\n  OPERATIONS = 'Operations',\r\n  LEGAL = 'Legal',\r\n  CREATIVE = 'Creative',\r\n  STRATEGY = 'Strategy',\r\n  SALES = 'Sales',\r\n}\r\n\r\n/** Relationship type between concepts */\r\nexport enum RelationshipType {\r\n  /** Must understand this concept first */\r\n  PREREQUISITE = 'PREREQUISITE',\r\n  /** Related topic */\r\n  RELATED = 'RELATED',\r\n  /** Deeper dive on this topic */\r\n  ADVANCED = 'ADVANCED',\r\n}\r\n\r\n/** Source tracking for how a concept was created (Story 2.15) */\r\nexport enum ConceptSource {\r\n  /** Pre-loaded from seed JSON files */\r\n  SEED_DATA = 'SEED_DATA',\r\n  /** Created via curriculum tree UI */\r\n  CURRICULUM = 'CURRICULUM',\r\n  /** Automatically extracted from AI output */\r\n  AI_DISCOVERED = 'AI_DISCOVERED',\r\n}\r\n\r\n/** Business concept entity */\r\nexport interface Concept {\r\n  /** Unique identifier with cpt_ prefix */\r\n  id: string;\r\n  /** Concept name (unique) */\r\n  name: string;\r\n  /** URL-friendly version of name */\r\n  slug: string;\r\n  /** Category (Finance, Marketing, etc.) */\r\n  category: ConceptCategory;\r\n  /** Brief definition (2-3 sentences) */\r\n  definition: string;\r\n  /** Extended description (full explanation) */\r\n  extendedDescription?: string;\r\n  /** Department tags for filtering */\r\n  departmentTags: string[];\r\n  /** Qdrant vector ID for semantic search */\r\n  embeddingId?: string;\r\n  /** How the concept was created (Story 2.15) */\r\n  source?: ConceptSource;\r\n  /** Version number for tracking updates */\r\n  version: number;\r\n  /** Parent concept ID for hierarchy */\r\n  parentId?: string | null;\r\n  /** Display order among siblings */\r\n  sortOrder?: number;\r\n  /** Links to curriculum.json id */\r\n  curriculumId?: string | null;\r\n  /** Creation timestamp */\r\n  createdAt: string;\r\n  /** Last update timestamp */\r\n  updatedAt: string;\r\n}\r\n\r\n/** Relationship between two concepts */\r\nexport interface ConceptRelationship {\r\n  /** Unique identifier */\r\n  id: string;\r\n  /** Source concept ID */\r\n  sourceConceptId: string;\r\n  /** Target concept ID */\r\n  targetConceptId: string;\r\n  /** Type of relationship */\r\n  relationshipType: RelationshipType;\r\n  /** Creation timestamp */\r\n  createdAt: string;\r\n}\r\n\r\n/** Concept with related concepts included */\r\nexport interface ConceptWithRelations extends Concept {\r\n  /** Related concepts from both directions */\r\n  relatedConcepts: Array<{\r\n    /** The related concept */\r\n    concept: Concept;\r\n    /** Type of relationship */\r\n    relationshipType: RelationshipType;\r\n    /** Direction: 'outgoing' if this concept points to it, 'incoming' if it points to this */\r\n    direction: 'outgoing' | 'incoming';\r\n  }>;\r\n}\r\n\r\n/** Result of dynamic relationship creation for a newly discovered concept */\r\nexport interface DynamicRelationshipResult {\r\n  /** The concept ID relationships were created for */\r\n  conceptId: string;\r\n  /** The concept name */\r\n  conceptName: string;\r\n  /** Number of relationships successfully created */\r\n  relationshipsCreated: number;\r\n  /** Any non-fatal errors encountered */\r\n  errors: string[];\r\n}\r\n\r\n/** Result of AI-driven concept extraction from text (Story 2.15) */\r\nexport interface ConceptExtractionResult {\r\n  /** Concepts successfully created in the database */\r\n  created: ConceptSummary[];\r\n  /** Concept names that were skipped as duplicates */\r\n  skippedDuplicates: string[];\r\n  /** Non-fatal errors encountered during extraction */\r\n  errors: string[];\r\n}\r\n\r\n/** Summary view of a concept for listings and side panels */\r\nexport interface ConceptSummary {\r\n  /** Unique identifier with cpt_ prefix */\r\n  id: string;\r\n  /** Concept name */\r\n  name: string;\r\n  /** URL-friendly slug */\r\n  slug: string;\r\n  /** Category */\r\n  category: ConceptCategory;\r\n  /** Brief definition */\r\n  definition: string;\r\n}\r\n\r\n/** Seed data format for a single concept */\r\nexport interface ConceptSeedData {\r\n  /** Concept name */\r\n  name: string;\r\n  /** URL-friendly slug */\r\n  slug: string;\r\n  /** Category */\r\n  category: string;\r\n  /** Brief definition */\r\n  definition: string;\r\n  /** Extended description */\r\n  extendedDescription?: string;\r\n  /** Department tags */\r\n  departmentTags: string[];\r\n  /** Related concepts with relationship type */\r\n  relatedConcepts?: Array<{\r\n    /** Slug of related concept */\r\n    slug: string;\r\n    /** Type of relationship */\r\n    type: RelationshipType;\r\n  }>;\r\n}\r\n\r\n/** Request for listing concepts with optional filters */\r\nexport interface ConceptsListRequest {\r\n  /** Filter by category */\r\n  category?: ConceptCategory;\r\n  /** Search query for name/definition */\r\n  search?: string;\r\n  /** Page number (1-indexed) */\r\n  page?: number;\r\n  /** Items per page */\r\n  limit?: number;\r\n}\r\n\r\n/** Response for concept listing */\r\nexport interface ConceptsListResponse {\r\n  data: ConceptSummary[];\r\n  meta: PaginationMeta;\r\n}\r\n\r\n/** Response for single concept with relations */\r\nexport interface ConceptResponse {\r\n  data: ConceptWithRelations;\r\n}\r\n\r\n/** Response for related concepts of a concept */\r\nexport interface ConceptRelationsResponse {\r\n  data: Array<{\r\n    concept: ConceptSummary;\r\n    relationshipType: RelationshipType;\r\n    direction: 'outgoing' | 'incoming';\r\n  }>;\r\n}\r\n\r\n//  Concept Citation Types (Story 2.6) \r\n// Types for linking AI responses to business concepts\r\n\r\n/** Citation of a business concept in an AI message */\r\nexport interface ConceptCitation {\r\n  /** Unique identifier with cit_ prefix */\r\n  id: string;\r\n  /** Message ID this citation belongs to */\r\n  messageId: string;\r\n  /** Concept ID being cited */\r\n  conceptId: string;\r\n  /** Concept name (denormalized for display) */\r\n  conceptName: string;\r\n  /** Concept category for styling */\r\n  conceptCategory: ConceptCategory;\r\n  /** Character position in message where citation appears */\r\n  position: number;\r\n  /** Semantic similarity score (0.0-1.0) */\r\n  score: number;\r\n  /** Creation timestamp */\r\n  createdAt: string;\r\n}\r\n\r\n/** Concept match result from semantic search */\r\nexport interface ConceptMatch {\r\n  /** Concept ID */\r\n  conceptId: string;\r\n  /** Concept name */\r\n  conceptName: string;\r\n  /** Concept category */\r\n  category: ConceptCategory;\r\n  /** Concept definition for display */\r\n  definition: string;\r\n  /** Semantic similarity score (0.0-1.0) */\r\n  score: number;\r\n}\r\n\r\n/** Result of citation injection into a response */\r\nexport interface CitationInjectionResult {\r\n  /** Content with [[Concept Name]] citations injected */\r\n  content: string;\r\n  /** List of citations that were injected */\r\n  citations: ConceptCitation[];\r\n}\r\n\r\n/** Response for message citations endpoint */\r\nexport interface MessageCitationsResponse {\r\n  data: ConceptCitation[];\r\n}\r\n\r\n/** Concept summary for citation side panel */\r\nexport interface ConceptCitationSummary {\r\n  /** Concept ID */\r\n  id: string;\r\n  /** Concept name */\r\n  name: string;\r\n  /** Concept category */\r\n  category: ConceptCategory;\r\n  /** Brief definition (2-3 sentences) */\r\n  definition: string;\r\n  /** Full educational content */\r\n  extendedDescription?: string;\r\n  /** Related concepts for exploration */\r\n  relatedConcepts: Array<{ id: string; name: string }>;\r\n}\r\n\r\n//  Persistent Memory Types (Story 2.7) \r\n// Types for AI memory persistence across conversations\r\n// NOTE: MemoryType and MemorySource intentionally mirror the Prisma schema enums.\r\n// Keep values in sync with apps/api/prisma/schema.prisma.\r\n\r\n/** Type of memory stored */\r\nexport enum MemoryType {\r\n  /** Context about a specific client */\r\n  CLIENT_CONTEXT = 'CLIENT_CONTEXT',\r\n  /** Context about a specific project */\r\n  PROJECT_CONTEXT = 'PROJECT_CONTEXT',\r\n  /** User preferences and working style */\r\n  USER_PREFERENCE = 'USER_PREFERENCE',\r\n  /** General factual statements */\r\n  FACTUAL_STATEMENT = 'FACTUAL_STATEMENT',\r\n}\r\n\r\n/** Source of the memory */\r\nexport enum MemorySource {\r\n  /** Automatically extracted from conversation by AI */\r\n  AI_EXTRACTED = 'AI_EXTRACTED',\r\n  /** Explicitly stated by user */\r\n  USER_STATED = 'USER_STATED',\r\n  /** Corrected by user after AI extraction */\r\n  USER_CORRECTED = 'USER_CORRECTED',\r\n}\r\n\r\n/**\r\n * Memory type colors for UI theming.\r\n * Single source of truth for memory type indicator colors.\r\n */\r\nexport const MEMORY_TYPE_COLORS: Record<MemoryType, string> = {\r\n  [MemoryType.CLIENT_CONTEXT]: '#3B82F6', // Blue (business relationships)\r\n  [MemoryType.PROJECT_CONTEXT]: '#8B5CF6', // Purple (project work)\r\n  [MemoryType.USER_PREFERENCE]: '#10B981', // Emerald (personal)\r\n  [MemoryType.FACTUAL_STATEMENT]: '#6B7280', // Gray (neutral facts)\r\n};\r\n\r\n/**\r\n * Memory type display labels.\r\n * Single source of truth for memory type names.\r\n */\r\nexport const MEMORY_TYPE_LABELS: Record<MemoryType, string> = {\r\n  [MemoryType.CLIENT_CONTEXT]: 'Client',\r\n  [MemoryType.PROJECT_CONTEXT]: 'Project',\r\n  [MemoryType.USER_PREFERENCE]: 'Preference',\r\n  [MemoryType.FACTUAL_STATEMENT]: 'Fact',\r\n};\r\n\r\n/** Persistent memory entity */\r\nexport interface Memory {\r\n  /** Unique identifier with mem_ prefix */\r\n  id: string;\r\n  /** Tenant ID for isolation */\r\n  tenantId: string;\r\n  /** User ID who owns this memory */\r\n  userId: string;\r\n  /** Type of memory */\r\n  type: MemoryType;\r\n  /** How the memory was created */\r\n  source: MemorySource;\r\n  /** The actual memory content */\r\n  content: string;\r\n  /** Subject name (client, project, or topic) */\r\n  subject?: string;\r\n  /** Extraction/confidence score (0.0-1.0) */\r\n  confidence: number;\r\n  /** Qdrant vector ID for semantic search */\r\n  embeddingId?: string;\r\n  /** Original message this was extracted from */\r\n  sourceMessageId?: string;\r\n  /** Whether this memory has been soft-deleted */\r\n  isDeleted: boolean;\r\n  /** When the memory was deleted (if applicable) */\r\n  deletedAt?: string;\r\n  /** Creation timestamp */\r\n  createdAt: string;\r\n  /** Last update timestamp */\r\n  updatedAt: string;\r\n}\r\n\r\n/** Memory attribution displayed in AI responses */\r\nexport interface MemoryAttribution {\r\n  /** Memory ID (mem_ prefix) */\r\n  memoryId: string;\r\n  /** Subject name (e.g., \"Acme Corp\", \"Project Phoenix\") */\r\n  subject: string;\r\n  /** Brief summary of the memory content */\r\n  summary: string;\r\n  /** Type of memory */\r\n  type: MemoryType;\r\n}\r\n\r\n/** Request to create a new memory */\r\nexport interface CreateMemoryDto {\r\n  /** Type of memory */\r\n  type: MemoryType;\r\n  /** Source of the memory */\r\n  source: MemorySource;\r\n  /** The memory content */\r\n  content: string;\r\n  /** Subject name (optional) */\r\n  subject?: string;\r\n  /** Confidence score (optional, defaults to 1.0) */\r\n  confidence?: number;\r\n  /** Source message ID (optional) */\r\n  sourceMessageId?: string;\r\n}\r\n\r\n/** Request to update/correct a memory */\r\nexport interface UpdateMemoryDto {\r\n  /** Updated content */\r\n  content: string;\r\n  /** Source will be set to USER_CORRECTED automatically */\r\n  source?: MemorySource;\r\n}\r\n\r\n/** Memory with pagination for list views */\r\nexport interface MemoryListResponse {\r\n  data: Memory[];\r\n  meta: {\r\n    total: number;\r\n    limit: number;\r\n    offset: number;\r\n  };\r\n}\r\n\r\n/** Response for single memory operations */\r\nexport interface MemoryResponse {\r\n  data: Memory;\r\n}\r\n\r\n/** Response for memory deletion */\r\nexport interface MemoryDeleteResponse {\r\n  success: boolean;\r\n  message: string;\r\n}\r\n\r\n/** Request to forget all memories (with confirmation) */\r\nexport interface ForgetAllMemoriesRequest {\r\n  /** User must type \"FORGET\" to confirm */\r\n  confirmation: string;\r\n}\r\n\r\n/** Extended completion result with memory attributions */\r\nexport interface CompletionResultWithMemory {\r\n  /** The AI response content */\r\n  content: string;\r\n  /** Token usage for this completion */\r\n  tokenUsage: TokenUsage;\r\n  /** Confidence score for the response */\r\n  confidenceScore?: ConfidenceScore;\r\n  /** Memory attributions used in this response */\r\n  memoryAttributions?: MemoryAttribution[];\r\n  /** Concept citations in the response */\r\n  citations?: ConceptCitation[];\r\n}\r\n\r\n//  Notes/Tasks Types \r\n// Types for the conversation notes and task tracking system\r\n\r\n/** Note type classification */\r\nexport enum NoteType {\r\n  TASK = 'TASK',\r\n  NOTE = 'NOTE',\r\n  SUMMARY = 'SUMMARY',\r\n  COMMENT = 'COMMENT',\r\n}\r\n\r\n/** Task completion status */\r\nexport enum NoteStatus {\r\n  PENDING = 'PENDING',\r\n  READY_FOR_REVIEW = 'READY_FOR_REVIEW',\r\n  COMPLETED = 'COMPLETED',\r\n}\r\n\r\n/** Note/task item */\r\nexport interface NoteItem {\r\n  id: string;\r\n  title: string;\r\n  content: string;\r\n  source: 'ONBOARDING' | 'CONVERSATION' | 'MANUAL';\r\n  noteType: NoteType;\r\n  status: NoteStatus | null;\r\n  conversationId: string | null;\r\n  conceptId: string | null;\r\n  messageId: string | null;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  parentNoteId: string | null;\r\n  children?: NoteItem[];\r\n  userReport: string | null;\r\n  aiScore: number | null;\r\n  aiFeedback: string | null;\r\n  expectedOutcome: string | null;\r\n  workflowStepNumber: number | null;\r\n  reusedFromNoteId: string | null;\r\n  /** File attachments on this note/task */\r\n  attachments?: AttachmentItem[];\r\n}\r\n\r\n/** Request to create a note */\r\nexport interface CreateNoteRequest {\r\n  title: string;\r\n  content: string;\r\n  noteType?: NoteType;\r\n  status?: NoteStatus;\r\n  conversationId?: string;\r\n  conceptId?: string;\r\n}\r\n\r\n/** Request to update a note */\r\nexport interface UpdateNoteRequest {\r\n  title?: string;\r\n  content?: string;\r\n}\r\n\r\n/** Request to update note/task status */\r\nexport interface UpdateNoteStatusRequest {\r\n  status: NoteStatus;\r\n}\r\n\r\n/** Response containing notes list */\r\nexport interface NotesListResponse {\r\n  data: NoteItem[];\r\n}\r\n\r\n/** A single comment on a task or workflow step */\r\nexport interface CommentItem {\r\n  id: string;\r\n  content: string;\r\n  userId: string;\r\n  userName: string;\r\n  userRole: string;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\n/** Paginated comment list response */\r\nexport interface CommentListResponse {\r\n  comments: CommentItem[];\r\n  total: number;\r\n  page: number;\r\n  limit: number;\r\n}\r\n\r\n/** Chat error data sent via WebSocket chat:error event */\r\nexport interface ChatErrorData {\r\n  type: string;\r\n  message: string;\r\n}\r\n\r\n//  Workflow & Agent Execution \r\n\r\n/** A single step in a concept workflow (generated by LLM, cached in DB) */\r\nexport interface WorkflowStep {\r\n  stepNumber: number;\r\n  title: string;\r\n  description: string;\r\n  promptTemplate: string;\r\n  expectedOutcome: string;\r\n  estimatedMinutes: number;\r\n  departmentTag?: string;\r\n}\r\n\r\n/** A step in an execution plan (derived from WorkflowStep + concept metadata) */\r\nexport interface ExecutionPlanStep {\r\n  stepId: string;\r\n  conceptId: string;\r\n  conceptName: string;\r\n  workflowStepNumber: number;\r\n  title: string;\r\n  description: string;\r\n  estimatedMinutes: number;\r\n  departmentTag?: string;\r\n  status: 'pending' | 'in_progress' | 'completed' | 'failed';\r\n  /** The originating task's title  injected as user-specific context during execution */\r\n  taskTitle?: string;\r\n  /** The originating task's content/description */\r\n  taskContent?: string;\r\n  /** The conversation where the task was created  used to load chat context */\r\n  taskConversationId?: string;\r\n}\r\n\r\n/** Full execution plan for a set of selected tasks */\r\nexport interface ExecutionPlan {\r\n  planId: string;\r\n  taskIds: string[];\r\n  steps: ExecutionPlanStep[];\r\n  totalEstimatedMinutes: number;\r\n  conceptOrder: string[];\r\n  status: 'awaiting_approval' | 'executing' | 'completed' | 'cancelled' | 'failed';\r\n  createdAt: string;\r\n}\r\n\r\n/** WebSocket payload: plan ready for user approval */\r\nexport interface WorkflowPlanReadyPayload {\r\n  plan: ExecutionPlan;\r\n  conversationId: string;\r\n}\r\n\r\n/** WebSocket payload: step execution progress */\r\nexport interface WorkflowStepProgressPayload {\r\n  planId: string;\r\n  stepId: string;\r\n  stepTitle?: string;\r\n  stepIndex?: number;\r\n  totalSteps?: number;\r\n  status: 'in_progress' | 'completed' | 'failed';\r\n  content?: string;\r\n  citations?: ConceptCitation[];\r\n  conversationId: string;\r\n}\r\n\r\n/** WebSocket payload: workflow execution complete */\r\nexport interface WorkflowCompletePayload {\r\n  planId: string;\r\n  status: 'completed' | 'cancelled' | 'failed';\r\n  completedSteps: number;\r\n  totalSteps: number;\r\n  conversationId: string;\r\n}\r\n\r\n/** WebSocket payload: per-concept conversations created for workflow execution */\r\nexport interface WorkflowConversationsCreatedPayload {\r\n  planId: string;\r\n  conversations: Array<{ conceptId: string; conceptName: string; conversationId: string }>;\r\n  originalConversationId: string;\r\n}\r\n\r\n/** WebSocket payload: workflow error */\r\nexport interface WorkflowErrorPayload {\r\n  planId?: string;\r\n  message: string;\r\n  conversationId: string;\r\n}\r\n\r\n/** WebSocket payload: step awaiting user confirmation before continuing */\r\nexport interface WorkflowStepConfirmationPayload {\r\n  planId: string;\r\n  completedStepId: string;\r\n  nextStep: {\r\n    stepId: string;\r\n    title: string;\r\n    description: string;\r\n    conceptName: string;\r\n    stepIndex: number;\r\n    totalSteps: number;\r\n  };\r\n  conversationId: string;\r\n}\r\n\r\n/** Discriminator for workflow step interaction type */\r\nexport type WorkflowStepInputType = 'text' | 'confirmation';\r\n\r\n/** WebSocket payload: step awaiting user input (text or confirmation) */\r\nexport interface WorkflowStepAwaitingInputPayload {\r\n  planId: string;\r\n  stepId: string;\r\n  stepTitle: string;\r\n  stepDescription: string;\r\n  conceptName: string;\r\n  stepIndex: number;\r\n  totalSteps: number;\r\n  inputType: WorkflowStepInputType;\r\n  conversationId: string;\r\n}\r\n\r\n/** WebSocket payload: complete workflow step message for chat rendering */\r\nexport interface WorkflowStepMessagePayload {\r\n  planId: string;\r\n  conversationId: string;\r\n  messageId: string;\r\n  content: string;\r\n  stepIndex: number;\r\n  totalSteps: number;\r\n  inputType: WorkflowStepInputType;\r\n  conceptName: string;\r\n}\r\n\r\n/** WebSocket payload: navigate to a specific conversation for workflow execution */\r\nexport interface WorkflowNavigatePayload {\r\n  planId: string;\r\n  conversationId: string;\r\n  conceptName: string;\r\n}\r\n\r\n//  YOLO Autonomous Execution \r\n\r\nexport type ExecutionMode = 'MANUAL' | 'YOLO';\r\n\r\nexport interface YoloConfig {\r\n  maxConcurrency: number;\r\n  maxConceptsHardStop: number;\r\n  retryAttempts: number;\r\n  retryBaseDelayMs?: number; // Exponential backoff base (default 5000ms)\r\n  circuitBreakerCooldownMs?: number; // Pause after consecutive failures (default 30000ms)\r\n  /** Max concepts to fully execute workflows for (default 50). Remainder created as PENDING only. */\r\n  maxExecutionBudget?: number;\r\n}\r\n\r\nexport interface YoloProgressPayload {\r\n  planId: string;\r\n  running: number;\r\n  maxConcurrency: number;\r\n  completed: number;\r\n  failed: number;\r\n  total: number;\r\n  discoveredCount: number;\r\n  /** Max concepts that will be fully executed (Story 3.10) */\r\n  executionBudget?: number;\r\n  /** Concepts fully executed so far (completed + running) */\r\n  executedSoFar?: number;\r\n  /** Concepts created as PENDING tasks but not executed this run */\r\n  createdOnlyCount?: number;\r\n  /** Total candidates considered before top-N selection */\r\n  totalConsidered?: number;\r\n  currentTasks: Array<{\r\n    conceptName: string;\r\n    status: string;\r\n    /** Current workflow step title (e.g., \"Market Analysis\") */\r\n    currentStep?: string;\r\n    /** Zero-based index of current step within the workflow */\r\n    currentStepIndex?: number;\r\n    /** Total number of steps in this task's workflow */\r\n    totalSteps?: number;\r\n  }>;\r\n  /** Last N log entries from the YOLO activity log */\r\n  recentLogs?: string[];\r\n  conversationId: string;\r\n}\r\n\r\n//  Web Search Types (Story 2.14) \r\n\r\n/** Enriched search result with optional full page content */\r\nexport interface EnrichedSearchResult {\r\n  title: string;\r\n  link: string;\r\n  snippet: string;\r\n  /** Extracted page content (truncated), if deep fetch succeeded */\r\n  pageContent?: string;\r\n  /** Timestamp when the result was fetched */\r\n  fetchedAt: string;\r\n}\r\n\r\nexport interface YoloCompletePayload {\r\n  planId: string;\r\n  status: 'completed' | 'failed' | 'hard-stopped';\r\n  completed: number;\r\n  failed: number;\r\n  total: number;\r\n  discoveredCount: number;\r\n  durationMs: number;\r\n  conversationId: string;\r\n  /** Final log entries from the YOLO execution */\r\n  logs?: string[];\r\n  /** Concepts created as PENDING tasks but not executed this run */\r\n  createdOnlyCount?: number;\r\n  /** Total candidates considered before top-N selection */\r\n  totalConsidered?: number;\r\n  /** Execution budget that was applied */\r\n  executionBudget?: number;\r\n}\r\n","import { IsString, IsOptional, IsEnum, IsNotEmpty, IsUrl } from 'class-validator';\r\nimport { LlmProviderType } from '@mentor-ai/shared/types';\r\n\r\nexport class ValidateProviderDto {\r\n  @IsEnum(LlmProviderType, { message: 'Invalid provider type' })\r\n  @IsNotEmpty({ message: 'Provider type is required' })\r\n  type!: LlmProviderType;\r\n\r\n  @IsString({ message: 'API key must be a string' })\r\n  @IsOptional()\r\n  apiKey?: string;\r\n\r\n  @IsUrl({ require_tld: false }, { message: 'Endpoint must be a valid URL' })\r\n  @IsOptional()\r\n  endpoint?: string;\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { LlmConfigModule } from '../llm-config/llm-config.module';\r\nimport { AiGatewayService } from './ai-gateway.service';\r\nimport { RedisService } from './redis.service';\r\nimport { RateLimiterService } from './rate-limiter.service';\r\nimport { TokenTrackerService } from './token-tracker.service';\r\nimport { QuotaService } from './quota.service';\r\nimport { RequestQueueService } from './request-queue.service';\r\nimport { CircuitBreakerService } from './circuit-breaker.service';\r\nimport { CostCalculatorService } from './cost-calculator.service';\r\nimport { ConfidenceService } from './confidence/confidence.service';\r\nimport { ImprovementSuggestionsService } from './confidence/improvement-suggestions.service';\r\n\r\n@Module({\r\n  // TenantModule provides PlatformPrismaService used by TokenTrackerService and QuotaService\r\n  imports: [ConfigModule, TenantModule, LlmConfigModule],\r\n  providers: [\r\n    AiGatewayService,\r\n    RedisService,\r\n    RateLimiterService,\r\n    TokenTrackerService,\r\n    QuotaService,\r\n    RequestQueueService,\r\n    CircuitBreakerService,\r\n    CostCalculatorService,\r\n    ConfidenceService,\r\n    ImprovementSuggestionsService,\r\n  ],\r\n  exports: [\r\n    AiGatewayService,\r\n    RedisService,\r\n    RateLimiterService,\r\n    TokenTrackerService,\r\n    QuotaService,\r\n    RequestQueueService,\r\n    CircuitBreakerService,\r\n    CostCalculatorService,\r\n    ConfidenceService,\r\n    ImprovementSuggestionsService,\r\n  ],\r\n})\r\nexport class AiGatewayModule {}\r\n","import {\r\n  Injectable,\r\n  Logger,\r\n  InternalServerErrorException,\r\n  HttpException,\r\n  HttpStatus,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { LlmConfigService } from '../llm-config/llm-config.service';\r\nimport {\r\n  LlmProviderType,\r\n  ChatMessage,\r\n  RateLimitInfo,\r\n  PersonaType,\r\n  ConfidenceScore,\r\n  type ConfidenceContext,\r\n} from '@mentor-ai/shared/types';\r\nimport { ConfidenceService } from './confidence/confidence.service';\r\nimport { generateSystemPrompt } from '../personas/templates/persona-prompts';\r\nimport { RateLimiterService } from './rate-limiter.service';\r\nimport { QuotaService } from './quota.service';\r\nimport { CircuitBreakerService } from './circuit-breaker.service';\r\nimport { TokenTrackerService } from './token-tracker.service';\r\nimport { CostCalculatorService } from './cost-calculator.service';\r\nimport { createId } from '@paralleldrive/cuid2';\r\n\r\n/**\r\n * Internal type for OpenRouter API streaming response.\r\n * Not shared because it's provider-specific implementation detail.\r\n */\r\ninterface OpenRouterResponse {\r\n  id: string;\r\n  choices: Array<{\r\n    delta?: {\r\n      content?: string;\r\n    };\r\n    message?: {\r\n      content: string;\r\n    };\r\n    finish_reason?: string;\r\n  }>;\r\n  usage?: {\r\n    prompt_tokens?: number;\r\n    completion_tokens?: number;\r\n    total_tokens?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Options for streaming completions with full context.\r\n */\r\nexport interface StreamCompletionOptions {\r\n  /** Tenant identifier for rate limiting and quota */\r\n  tenantId: string;\r\n  /** User identifier for rate limiting */\r\n  userId: string;\r\n  /** Conversation identifier for tracking */\r\n  conversationId?: string;\r\n  /** Skip rate limiting (for internal use) */\r\n  skipRateLimit?: boolean;\r\n  /** Skip quota check (for internal use) */\r\n  skipQuotaCheck?: boolean;\r\n  /** Optional persona type for department-specific responses */\r\n  personaType?: PersonaType;\r\n  /** Message count in conversation for confidence calculation */\r\n  messageCount?: number;\r\n  /** Whether client context is available for confidence calculation */\r\n  hasClientContext?: boolean;\r\n  /** Whether specific data is available for confidence calculation */\r\n  hasSpecificData?: boolean;\r\n  /** User's original question for confidence context */\r\n  userQuestion?: string;\r\n  /** Pre-built business context string to prepend to system prompt */\r\n  businessContext?: string;\r\n  /** Force use of fallback provider (e.g. GPT for fast plan generation) */\r\n  useFallback?: boolean;\r\n}\r\n\r\n/**\r\n * Result of a completion including usage metrics.\r\n */\r\nexport interface CompletionResult {\r\n  /** Correlation ID for tracing */\r\n  correlationId: string;\r\n  /** Whether the completion was successful */\r\n  success: boolean;\r\n  /** Input tokens used */\r\n  inputTokens: number;\r\n  /** Output tokens generated */\r\n  outputTokens: number;\r\n  /** Total cost in USD */\r\n  cost: number;\r\n  /** Rate limit information */\r\n  rateLimit?: RateLimitInfo;\r\n  /** Persona type used (if any) */\r\n  personaType?: PersonaType;\r\n  /** Confidence score for the response (Story 2.5) */\r\n  confidence?: ConfidenceScore;\r\n  /** Full response content for confidence calculation */\r\n  responseContent?: string;\r\n}\r\n\r\n/**\r\n * Service for streaming AI completions from configured LLM providers.\r\n * Includes rate limiting, quota enforcement, circuit breaker, and cost tracking.\r\n */\r\n@Injectable()\r\nexport class AiGatewayService {\r\n  private readonly logger = new Logger(AiGatewayService.name);\r\n  /** Request timeout in milliseconds (1 hour  large models like 72B can be slow) */\r\n  private readonly requestTimeoutMs = 3600 * 1000;\r\n\r\n  constructor(\r\n    private readonly llmConfigService: LlmConfigService,\r\n    private readonly configService: ConfigService,\r\n    private readonly rateLimiterService: RateLimiterService,\r\n    private readonly quotaService: QuotaService,\r\n    private readonly circuitBreakerService: CircuitBreakerService,\r\n    private readonly tokenTrackerService: TokenTrackerService,\r\n    private readonly costCalculatorService: CostCalculatorService,\r\n    private readonly confidenceService: ConfidenceService\r\n  ) {}\r\n\r\n  /**\r\n   * Streams a completion with full context including rate limiting, quota, and tracking.\r\n   *\r\n   * @param messages - Conversation history in chat format\r\n   * @param options - Stream options including tenant/user context\r\n   * @param onChunk - Callback for each streamed chunk\r\n   * @returns Completion result with usage metrics\r\n   * @throws HttpException for rate limits, quotas, or provider errors\r\n   */\r\n  async streamCompletionWithContext(\r\n    messages: ChatMessage[],\r\n    options: StreamCompletionOptions,\r\n    onChunk: (chunk: string) => void\r\n  ): Promise<CompletionResult> {\r\n    const correlationId = `cor_${createId()}`;\r\n    const { tenantId, userId, conversationId, personaType } = options;\r\n\r\n    this.logger.log({\r\n      message: 'Starting AI completion',\r\n      correlationId,\r\n      tenantId,\r\n      userId,\r\n      conversationId,\r\n      personaType: personaType ?? 'none',\r\n      messageCount: messages.length,\r\n    });\r\n\r\n    // Build combined system prompt: business context + persona\r\n    let messagesWithPersona = messages;\r\n    let systemPrompt = '';\r\n\r\n    if (options.businessContext) {\r\n      systemPrompt = options.businessContext;\r\n      this.logger.log({\r\n        message: 'Business context added to system prompt',\r\n        correlationId,\r\n        contextLength: options.businessContext.length,\r\n      });\r\n    }\r\n\r\n    if (personaType) {\r\n      const personaSystemPrompt = generateSystemPrompt(personaType);\r\n      if (personaSystemPrompt) {\r\n        systemPrompt = systemPrompt\r\n          ? `${systemPrompt}\\n\\n${personaSystemPrompt}`\r\n          : personaSystemPrompt;\r\n        this.logger.log({\r\n          message: 'Persona system prompt added',\r\n          correlationId,\r\n          personaType,\r\n          promptLength: personaSystemPrompt.length,\r\n        });\r\n      }\r\n    }\r\n\r\n    if (systemPrompt) {\r\n      messagesWithPersona = [{ role: 'system', content: systemPrompt }, ...messages];\r\n    }\r\n\r\n    // Truncate messages to fit within model context window\r\n    messagesWithPersona = this.truncateMessagesToFit(messagesWithPersona, correlationId);\r\n\r\n    // Check rate limits\r\n    let rateLimit: RateLimitInfo | undefined;\r\n    if (!options.skipRateLimit) {\r\n      const rateLimitResult = await this.rateLimiterService.checkLimits(tenantId, userId);\r\n      rateLimit = rateLimitResult;\r\n\r\n      if (!rateLimitResult.allowed) {\r\n        const headers = this.rateLimiterService.getHeaders(rateLimitResult);\r\n        throw new HttpException(\r\n          {\r\n            type: 'rate_limit_exceeded',\r\n            title: 'Rate Limit Exceeded',\r\n            status: 429,\r\n            detail: `Rate limit exceeded for ${rateLimitResult.limitType}. Try again in ${rateLimitResult.retryAfter} seconds.`,\r\n            headers,\r\n          },\r\n          HttpStatus.TOO_MANY_REQUESTS\r\n        );\r\n      }\r\n    }\r\n\r\n    // Check quota\r\n    if (!options.skipQuotaCheck) {\r\n      const quotaResult = await this.quotaService.checkQuota(tenantId);\r\n\r\n      if (!quotaResult.allowed) {\r\n        throw new HttpException(\r\n          {\r\n            type: 'quota_exceeded',\r\n            title: 'Token Quota Exceeded',\r\n            status: 402,\r\n            detail: `Monthly token quota exceeded. Used ${quotaResult.used} of ${quotaResult.limit} tokens.`,\r\n            upgrade_url: '/settings/billing',\r\n          },\r\n          HttpStatus.PAYMENT_REQUIRED\r\n        );\r\n      }\r\n    }\r\n\r\n    // Get provider config\r\n    const config = await this.llmConfigService.getConfig();\r\n\r\n    if (!config.primaryProvider) {\r\n      throw new InternalServerErrorException({\r\n        type: 'no_provider_configured',\r\n        title: 'AI Provider Not Configured',\r\n        status: 500,\r\n        detail: 'No AI provider has been configured. Please configure an LLM provider.',\r\n      });\r\n    }\r\n\r\n    const providerType = config.primaryProvider.providerType as LlmProviderType;\r\n    const modelId = config.primaryProvider.modelId;\r\n    const providerId = `${providerType}:${modelId}`;\r\n\r\n    // Check circuit breaker\r\n    const isAllowed = await this.circuitBreakerService.isAllowed(providerId);\r\n    if (!isAllowed && !config.fallbackProvider) {\r\n      throw new HttpException(\r\n        {\r\n          type: 'circuit_open',\r\n          title: 'Service Temporarily Unavailable',\r\n          status: 503,\r\n          detail:\r\n            'AI service is temporarily unavailable due to recent failures. Please try again later.',\r\n          correlationId,\r\n        },\r\n        HttpStatus.SERVICE_UNAVAILABLE\r\n      );\r\n    }\r\n\r\n    let inputTokens = 0;\r\n    let outputTokens = 0;\r\n    let outputContent = '';\r\n\r\n    try {\r\n      // Estimate input tokens (rough approximation: 1 token  4 chars)\r\n      inputTokens = Math.ceil(\r\n        messagesWithPersona.reduce((acc, m) => acc + m.content.length, 0) / 4\r\n      );\r\n\r\n      // Stream with tracking\r\n      const wrappedOnChunk = (chunk: string) => {\r\n        outputContent += chunk;\r\n        onChunk(chunk);\r\n      };\r\n\r\n      // Use fallback provider when explicitly requested or circuit is open\r\n      if ((options.useFallback || !isAllowed) && config.fallbackProvider) {\r\n        this.logger.warn({\r\n          message: options.useFallback\r\n            ? 'Using fallback provider (explicitly requested)'\r\n            : 'Primary provider circuit open, using fallback',\r\n          correlationId,\r\n          primaryProvider: providerId,\r\n          fallbackProvider: config.fallbackProvider.providerType,\r\n        });\r\n        await this.streamWithFallbackAndTimeout(\r\n          config.fallbackProvider,\r\n          messagesWithPersona,\r\n          wrappedOnChunk,\r\n          correlationId\r\n        );\r\n      } else {\r\n        await this.streamWithTimeout(\r\n          messagesWithPersona,\r\n          providerType,\r\n          modelId,\r\n          config.primaryProvider.endpoint,\r\n          wrappedOnChunk,\r\n          correlationId\r\n        );\r\n      }\r\n\r\n      // Record success with circuit breaker\r\n      await this.circuitBreakerService.recordSuccess(providerId, correlationId);\r\n\r\n      // Estimate output tokens\r\n      outputTokens = Math.ceil(outputContent.length / 4);\r\n\r\n      // Calculate cost\r\n      const costResult = this.costCalculatorService.calculateCost(\r\n        modelId,\r\n        inputTokens,\r\n        outputTokens\r\n      );\r\n\r\n      // Track token usage (fire-and-forget  don't block response)\r\n      this.tokenTrackerService\r\n        .trackUsage(\r\n          tenantId,\r\n          userId,\r\n          inputTokens,\r\n          outputTokens,\r\n          costResult.totalCost,\r\n          modelId,\r\n          conversationId,\r\n          providerId\r\n        )\r\n        .catch((err) => {\r\n          this.logger.warn({\r\n            message: 'Token usage tracking failed (non-blocking)',\r\n            correlationId,\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          });\r\n        });\r\n\r\n      // Calculate confidence score (Story 2.5)\r\n      const confidenceContext: ConfidenceContext = {\r\n        messageCount: options.messageCount ?? messages.length,\r\n        hasClientContext: options.hasClientContext ?? false,\r\n        hasSpecificData: options.hasSpecificData ?? false,\r\n        personaType,\r\n        userQuestion: options.userQuestion ?? '',\r\n      };\r\n\r\n      const confidence = this.confidenceService.calculateConfidence(\r\n        outputContent,\r\n        confidenceContext\r\n      );\r\n\r\n      this.logger.log({\r\n        message: 'AI completion successful',\r\n        correlationId,\r\n        inputTokens,\r\n        outputTokens,\r\n        cost: costResult.totalCost,\r\n        modelId,\r\n        personaType: personaType ?? 'none',\r\n        confidenceScore: confidence.score,\r\n        confidenceLevel: confidence.level,\r\n      });\r\n\r\n      return {\r\n        correlationId,\r\n        success: true,\r\n        inputTokens,\r\n        outputTokens,\r\n        cost: costResult.totalCost,\r\n        rateLimit,\r\n        personaType,\r\n        confidence,\r\n        responseContent: outputContent,\r\n      };\r\n    } catch (error) {\r\n      // Record failure with circuit breaker\r\n      await this.circuitBreakerService.recordFailure(providerId, correlationId);\r\n\r\n      this.logger.error({\r\n        message: 'AI completion failed',\r\n        correlationId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        providerId,\r\n      });\r\n\r\n      // Try fallback if available\r\n      if (config.fallbackProvider) {\r\n        this.logger.warn({\r\n          message: 'Trying fallback provider',\r\n          correlationId,\r\n          fallbackProvider: config.fallbackProvider.providerType,\r\n        });\r\n\r\n        try {\r\n          outputContent = '';\r\n          const wrappedOnChunk = (chunk: string) => {\r\n            outputContent += chunk;\r\n            onChunk(chunk);\r\n          };\r\n\r\n          await this.streamWithFallbackAndTimeout(\r\n            config.fallbackProvider,\r\n            messagesWithPersona,\r\n            wrappedOnChunk,\r\n            correlationId\r\n          );\r\n\r\n          outputTokens = Math.ceil(outputContent.length / 4);\r\n          const fallbackModelId = config.fallbackProvider.modelId;\r\n          const costResult = this.costCalculatorService.calculateCost(\r\n            fallbackModelId,\r\n            inputTokens,\r\n            outputTokens\r\n          );\r\n\r\n          this.tokenTrackerService\r\n            .trackUsage(\r\n              tenantId,\r\n              userId,\r\n              inputTokens,\r\n              outputTokens,\r\n              costResult.totalCost,\r\n              fallbackModelId,\r\n              conversationId,\r\n              `${config.fallbackProvider.providerType}:${fallbackModelId}`\r\n            )\r\n            .catch((err) => {\r\n              this.logger.warn({\r\n                message: 'Fallback token tracking failed (non-blocking)',\r\n                correlationId,\r\n                error: err instanceof Error ? err.message : 'Unknown',\r\n              });\r\n            });\r\n\r\n          // Calculate confidence score for fallback response (Story 2.5)\r\n          const fallbackConfidenceContext: ConfidenceContext = {\r\n            messageCount: options.messageCount ?? messages.length,\r\n            hasClientContext: options.hasClientContext ?? false,\r\n            hasSpecificData: options.hasSpecificData ?? false,\r\n            personaType,\r\n            userQuestion: options.userQuestion ?? '',\r\n          };\r\n\r\n          const fallbackConfidence = this.confidenceService.calculateConfidence(\r\n            outputContent,\r\n            fallbackConfidenceContext\r\n          );\r\n\r\n          this.logger.log({\r\n            message: 'Fallback AI completion successful',\r\n            correlationId,\r\n            inputTokens,\r\n            outputTokens,\r\n            cost: costResult.totalCost,\r\n            modelId: fallbackModelId,\r\n            personaType: personaType ?? 'none',\r\n            confidenceScore: fallbackConfidence.score,\r\n            confidenceLevel: fallbackConfidence.level,\r\n          });\r\n\r\n          return {\r\n            correlationId,\r\n            success: true,\r\n            inputTokens,\r\n            outputTokens,\r\n            cost: costResult.totalCost,\r\n            rateLimit,\r\n            personaType,\r\n            confidence: fallbackConfidence,\r\n            responseContent: outputContent,\r\n          };\r\n        } catch (fallbackError) {\r\n          const fallbackProviderId = `${config.fallbackProvider.providerType}:${config.fallbackProvider.modelId}`;\r\n          await this.circuitBreakerService.recordFailure(fallbackProviderId, correlationId);\r\n\r\n          this.logger.error({\r\n            message: 'Fallback provider also failed',\r\n            correlationId,\r\n            error: fallbackError instanceof Error ? fallbackError.message : 'Unknown error',\r\n          });\r\n        }\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Streams a completion from the configured AI provider.\r\n   * Legacy method for backward compatibility.\r\n   *\r\n   * @param messages - Conversation history in chat format\r\n   * @param onChunk - Callback for each streamed chunk\r\n   * @throws InternalServerErrorException if no provider is configured or streaming fails\r\n   */\r\n  async streamCompletion(messages: ChatMessage[], onChunk: (chunk: string) => void): Promise<void> {\r\n    const config = await this.llmConfigService.getConfig();\r\n\r\n    if (!config.primaryProvider) {\r\n      throw new InternalServerErrorException({\r\n        type: 'no_provider_configured',\r\n        title: 'AI Provider Not Configured',\r\n        status: 500,\r\n        detail: 'No AI provider has been configured. Please configure an LLM provider.',\r\n      });\r\n    }\r\n\r\n    const providerType = config.primaryProvider.providerType as LlmProviderType;\r\n    const modelId = config.primaryProvider.modelId;\r\n\r\n    try {\r\n      switch (providerType) {\r\n        case 'OPENROUTER':\r\n          await this.streamFromOpenRouter(messages, modelId, onChunk);\r\n          break;\r\n        case 'OPENAI':\r\n          await this.streamFromOpenAI(messages, modelId, onChunk);\r\n          break;\r\n        case 'LOCAL_LLAMA':\r\n          await this.streamFromLocalLlama(\r\n            messages,\r\n            modelId,\r\n            config.primaryProvider.endpoint ?? '',\r\n            onChunk\r\n          );\r\n          break;\r\n        case 'LM_STUDIO':\r\n          await this.streamFromLmStudio(\r\n            messages,\r\n            modelId,\r\n            config.primaryProvider.endpoint ?? '',\r\n            onChunk\r\n          );\r\n          break;\r\n        case 'DEEPSEEK':\r\n          await this.streamFromDeepSeek(messages, modelId, onChunk);\r\n          break;\r\n        case 'ANTHROPIC':\r\n          throw new InternalServerErrorException({\r\n            type: 'provider_not_implemented',\r\n            title: 'Provider Not Available',\r\n            status: 500,\r\n            detail: `${providerType} provider is not yet implemented`,\r\n          });\r\n        default:\r\n          throw new InternalServerErrorException({\r\n            type: 'unknown_provider',\r\n            title: 'Unknown Provider',\r\n            status: 500,\r\n            detail: `Unknown provider type: ${providerType}`,\r\n          });\r\n      }\r\n\r\n      this.logger.log({\r\n        message: 'AI completion streamed successfully',\r\n        providerType,\r\n        modelId,\r\n        messageCount: messages.length,\r\n      });\r\n    } catch (error) {\r\n      if (config.fallbackProvider) {\r\n        this.logger.warn({\r\n          message: 'Primary provider failed, trying fallback',\r\n          primaryProvider: providerType,\r\n          fallbackProvider: config.fallbackProvider.providerType,\r\n          error: error instanceof Error ? error.message : 'Unknown error',\r\n        });\r\n\r\n        try {\r\n          await this.streamWithFallback(config.fallbackProvider, messages, onChunk);\r\n          return;\r\n        } catch (fallbackError) {\r\n          this.logger.error({\r\n            message: 'Fallback provider also failed',\r\n            error: fallbackError instanceof Error ? fallbackError.message : 'Unknown error',\r\n          });\r\n        }\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Streams with timeout support.\r\n   */\r\n  private async streamWithTimeout(\r\n    messages: ChatMessage[],\r\n    providerType: LlmProviderType,\r\n    modelId: string,\r\n    endpoint: string | undefined,\r\n    onChunk: (chunk: string) => void,\r\n    correlationId: string\r\n  ): Promise<void> {\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => {\r\n      controller.abort();\r\n    }, this.requestTimeoutMs);\r\n\r\n    try {\r\n      switch (providerType) {\r\n        case 'OPENROUTER':\r\n          await this.streamFromOpenRouter(messages, modelId, onChunk, controller.signal);\r\n          break;\r\n        case 'OPENAI':\r\n          await this.streamFromOpenAI(messages, modelId, onChunk, controller.signal);\r\n          break;\r\n        case 'LOCAL_LLAMA':\r\n          await this.streamFromLocalLlama(\r\n            messages,\r\n            modelId,\r\n            endpoint ?? '',\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        case 'LM_STUDIO':\r\n          await this.streamFromLmStudio(\r\n            messages,\r\n            modelId,\r\n            endpoint ?? '',\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        case 'DEEPSEEK':\r\n          await this.streamFromDeepSeek(messages, modelId, onChunk, controller.signal);\r\n          break;\r\n        case 'ANTHROPIC':\r\n          throw new InternalServerErrorException({\r\n            type: 'provider_not_implemented',\r\n            title: 'Provider Not Available',\r\n            status: 500,\r\n            detail: `${providerType} provider is not yet implemented`,\r\n            correlationId,\r\n          });\r\n        default:\r\n          throw new InternalServerErrorException({\r\n            type: 'unknown_provider',\r\n            title: 'Unknown Provider',\r\n            status: 500,\r\n            detail: `Unknown provider type: ${providerType}`,\r\n            correlationId,\r\n          });\r\n      }\r\n    } catch (error) {\r\n      if (error instanceof Error && error.name === 'AbortError') {\r\n        throw new InternalServerErrorException({\r\n          type: 'request_timeout',\r\n          title: 'Request Timeout',\r\n          status: 504,\r\n          detail: `Request timed out after ${this.requestTimeoutMs / 1000} seconds`,\r\n          correlationId,\r\n        });\r\n      }\r\n      throw error;\r\n    } finally {\r\n      clearTimeout(timeoutId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Streams from fallback provider with timeout.\r\n   */\r\n  private async streamWithFallbackAndTimeout(\r\n    fallbackProvider: {\r\n      providerType: string;\r\n      modelId: string;\r\n      endpoint?: string;\r\n    },\r\n    messages: ChatMessage[],\r\n    onChunk: (chunk: string) => void,\r\n    correlationId: string\r\n  ): Promise<void> {\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => {\r\n      controller.abort();\r\n    }, this.requestTimeoutMs);\r\n\r\n    try {\r\n      switch (fallbackProvider.providerType) {\r\n        case 'OPENROUTER':\r\n          await this.streamFromOpenRouter(\r\n            messages,\r\n            fallbackProvider.modelId,\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        case 'OPENAI':\r\n          await this.streamFromOpenAI(\r\n            messages,\r\n            fallbackProvider.modelId,\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        case 'LOCAL_LLAMA':\r\n          await this.streamFromLocalLlama(\r\n            messages,\r\n            fallbackProvider.modelId,\r\n            fallbackProvider.endpoint ?? '',\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        case 'LM_STUDIO':\r\n          await this.streamFromLmStudio(\r\n            messages,\r\n            fallbackProvider.modelId,\r\n            fallbackProvider.endpoint ?? '',\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        case 'DEEPSEEK':\r\n          await this.streamFromDeepSeek(\r\n            messages,\r\n            fallbackProvider.modelId,\r\n            onChunk,\r\n            controller.signal\r\n          );\r\n          break;\r\n        default:\r\n          throw new InternalServerErrorException({\r\n            type: 'fallback_not_supported',\r\n            title: 'Fallback Not Supported',\r\n            status: 500,\r\n            detail: `Fallback provider ${fallbackProvider.providerType} is not supported`,\r\n            correlationId,\r\n          });\r\n      }\r\n    } catch (error) {\r\n      if (error instanceof Error && error.name === 'AbortError') {\r\n        throw new InternalServerErrorException({\r\n          type: 'request_timeout',\r\n          title: 'Request Timeout',\r\n          status: 504,\r\n          detail: `Fallback request timed out after ${this.requestTimeoutMs / 1000} seconds`,\r\n          correlationId,\r\n        });\r\n      }\r\n      throw error;\r\n    } finally {\r\n      clearTimeout(timeoutId);\r\n    }\r\n  }\r\n\r\n  private async streamFromOpenRouter(\r\n    messages: ChatMessage[],\r\n    modelId: string,\r\n    onChunk: (chunk: string) => void,\r\n    signal?: AbortSignal\r\n  ): Promise<void> {\r\n    const apiKey = await this.llmConfigService.getDecryptedApiKey(LlmProviderType.OPENROUTER);\r\n\r\n    if (!apiKey) {\r\n      throw new InternalServerErrorException({\r\n        type: 'api_key_not_found',\r\n        title: 'API Key Not Found',\r\n        status: 500,\r\n        detail: 'OpenRouter API key is not configured',\r\n      });\r\n    }\r\n\r\n    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${apiKey}`,\r\n        'HTTP-Referer': this.configService.get<string>('APP_URL') ?? 'http://localhost:4200',\r\n        'X-Title': 'Mentor AI',\r\n      },\r\n      body: JSON.stringify({\r\n        model: modelId,\r\n        messages,\r\n        stream: true,\r\n      }),\r\n      signal,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      throw new InternalServerErrorException({\r\n        type: 'openrouter_error',\r\n        title: 'OpenRouter API Error',\r\n        status: 500,\r\n        detail: `OpenRouter returned ${response.status}: ${errorText}`,\r\n      });\r\n    }\r\n\r\n    const reader = response.body?.getReader();\r\n    if (!reader) {\r\n      throw new InternalServerErrorException({\r\n        type: 'stream_error',\r\n        title: 'Stream Error',\r\n        status: 500,\r\n        detail: 'Failed to get response stream',\r\n      });\r\n    }\r\n\r\n    const decoder = new TextDecoder();\r\n    let buffer = '';\r\n\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() ?? '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6);\r\n            if (data === '[DONE]') continue;\r\n\r\n            try {\r\n              const parsed = JSON.parse(data) as OpenRouterResponse;\r\n              const content = parsed.choices[0]?.delta?.content;\r\n              if (content) {\r\n                onChunk(content);\r\n              }\r\n            } catch {\r\n              // Skip malformed JSON lines\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n\r\n  private async streamFromOpenAI(\r\n    messages: ChatMessage[],\r\n    modelId: string,\r\n    onChunk: (chunk: string) => void,\r\n    signal?: AbortSignal\r\n  ): Promise<void> {\r\n    const apiKey = await this.llmConfigService.getDecryptedApiKey(LlmProviderType.OPENAI);\r\n\r\n    if (!apiKey) {\r\n      throw new InternalServerErrorException({\r\n        type: 'api_key_not_found',\r\n        title: 'API Key Not Found',\r\n        status: 500,\r\n        detail: 'OpenAI API key is not configured',\r\n      });\r\n    }\r\n\r\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: modelId,\r\n        messages,\r\n        stream: true,\r\n      }),\r\n      signal,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      throw new InternalServerErrorException({\r\n        type: 'openai_error',\r\n        title: 'OpenAI API Error',\r\n        status: 500,\r\n        detail: `OpenAI returned ${response.status}: ${errorText}`,\r\n      });\r\n    }\r\n\r\n    const reader = response.body?.getReader();\r\n    if (!reader) {\r\n      throw new InternalServerErrorException({\r\n        type: 'stream_error',\r\n        title: 'Stream Error',\r\n        status: 500,\r\n        detail: 'Failed to get response stream',\r\n      });\r\n    }\r\n\r\n    const decoder = new TextDecoder();\r\n    let buffer = '';\r\n\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() ?? '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6);\r\n            if (data === '[DONE]') continue;\r\n\r\n            try {\r\n              const parsed = JSON.parse(data) as OpenRouterResponse;\r\n              const content = parsed.choices[0]?.delta?.content;\r\n              if (content) {\r\n                onChunk(content);\r\n              }\r\n            } catch {\r\n              // Skip malformed JSON lines\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n\r\n  private async streamFromDeepSeek(\r\n    messages: ChatMessage[],\r\n    modelId: string,\r\n    onChunk: (chunk: string) => void,\r\n    signal?: AbortSignal\r\n  ): Promise<void> {\r\n    const apiKey = await this.llmConfigService.getDecryptedApiKey(LlmProviderType.DEEPSEEK);\r\n\r\n    if (!apiKey) {\r\n      throw new InternalServerErrorException({\r\n        type: 'api_key_not_found',\r\n        title: 'API Key Not Found',\r\n        status: 500,\r\n        detail: 'DeepSeek API key is not configured',\r\n      });\r\n    }\r\n\r\n    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: modelId,\r\n        messages,\r\n        stream: true,\r\n      }),\r\n      signal,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      throw new InternalServerErrorException({\r\n        type: 'deepseek_error',\r\n        title: 'DeepSeek API Error',\r\n        status: 500,\r\n        detail: `DeepSeek returned ${response.status}: ${errorText}`,\r\n      });\r\n    }\r\n\r\n    const reader = response.body?.getReader();\r\n    if (!reader) {\r\n      throw new InternalServerErrorException({\r\n        type: 'stream_error',\r\n        title: 'Stream Error',\r\n        status: 500,\r\n        detail: 'Failed to get response stream from DeepSeek',\r\n      });\r\n    }\r\n\r\n    const decoder = new TextDecoder();\r\n    let buffer = '';\r\n\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() ?? '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6);\r\n            if (data === '[DONE]') continue;\r\n\r\n            try {\r\n              const parsed = JSON.parse(data) as OpenRouterResponse;\r\n              const content = parsed.choices[0]?.delta?.content;\r\n              if (content) {\r\n                onChunk(content);\r\n              }\r\n            } catch {\r\n              // Skip malformed JSON lines\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n\r\n  private async streamFromLocalLlama(\r\n    messages: ChatMessage[],\r\n    modelId: string,\r\n    endpoint: string,\r\n    onChunk: (chunk: string) => void,\r\n    signal?: AbortSignal\r\n  ): Promise<void> {\r\n    const baseUrl = endpoint || 'http://localhost:11434';\r\n\r\n    const response = await fetch(`${baseUrl}/api/chat`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        model: modelId,\r\n        messages,\r\n        stream: true,\r\n      }),\r\n      signal,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      throw new InternalServerErrorException({\r\n        type: 'local_llama_error',\r\n        title: 'Local Llama Error',\r\n        status: 500,\r\n        detail: `Local Llama returned ${response.status}: ${errorText}`,\r\n      });\r\n    }\r\n\r\n    const reader = response.body?.getReader();\r\n    if (!reader) {\r\n      throw new InternalServerErrorException({\r\n        type: 'stream_error',\r\n        title: 'Stream Error',\r\n        status: 500,\r\n        detail: 'Failed to get response stream',\r\n      });\r\n    }\r\n\r\n    const decoder = new TextDecoder();\r\n    let buffer = '';\r\n\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() ?? '';\r\n\r\n        for (const line of lines) {\r\n          if (line.trim()) {\r\n            try {\r\n              const parsed = JSON.parse(line) as {\r\n                message?: { content?: string };\r\n              };\r\n              const content = parsed.message?.content;\r\n              if (content) {\r\n                onChunk(content);\r\n              }\r\n            } catch {\r\n              // Skip malformed JSON lines\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n  }\r\n\r\n  private async streamWithFallback(\r\n    fallbackProvider: {\r\n      providerType: string;\r\n      modelId: string;\r\n      endpoint?: string;\r\n    },\r\n    messages: ChatMessage[],\r\n    onChunk: (chunk: string) => void\r\n  ): Promise<void> {\r\n    switch (fallbackProvider.providerType) {\r\n      case 'OPENROUTER':\r\n        await this.streamFromOpenRouter(messages, fallbackProvider.modelId, onChunk);\r\n        break;\r\n      case 'OPENAI':\r\n        await this.streamFromOpenAI(messages, fallbackProvider.modelId, onChunk);\r\n        break;\r\n      case 'LOCAL_LLAMA':\r\n        await this.streamFromLocalLlama(\r\n          messages,\r\n          fallbackProvider.modelId,\r\n          fallbackProvider.endpoint ?? '',\r\n          onChunk\r\n        );\r\n        break;\r\n      case 'LM_STUDIO':\r\n        await this.streamFromLmStudio(\r\n          messages,\r\n          fallbackProvider.modelId,\r\n          fallbackProvider.endpoint ?? '',\r\n          onChunk\r\n        );\r\n        break;\r\n      case 'DEEPSEEK':\r\n        await this.streamFromDeepSeek(messages, fallbackProvider.modelId, onChunk);\r\n        break;\r\n      default:\r\n        throw new InternalServerErrorException({\r\n          type: 'fallback_not_supported',\r\n          title: 'Fallback Not Supported',\r\n          status: 500,\r\n          detail: `Fallback provider ${fallbackProvider.providerType} is not supported`,\r\n        });\r\n    }\r\n  }\r\n\r\n  private async streamFromLmStudio(\r\n    messages: ChatMessage[],\r\n    modelId: string,\r\n    endpoint: string,\r\n    onChunk: (chunk: string) => void,\r\n    signal?: AbortSignal\r\n  ): Promise<void> {\r\n    const baseUrl = endpoint || 'http://localhost:1234';\r\n    const url = `${baseUrl}/v1/chat/completions`;\r\n\r\n    this.logger.log({\r\n      message: 'LM Studio request starting (SSE streaming)',\r\n      url,\r\n      modelId,\r\n      messageCount: messages.length,\r\n    });\r\n\r\n    // Build headers  include API key if configured (needed for RunPod, vLLM, etc.)\r\n    const headers: Record<string, string> = {\r\n      'Content-Type': 'application/json',\r\n    };\r\n    const apiKey = await this.llmConfigService.getDecryptedApiKey(LlmProviderType.LM_STUDIO);\r\n    if (apiKey) {\r\n      headers['Authorization'] = `Bearer ${apiKey}`;\r\n    }\r\n\r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers,\r\n      body: JSON.stringify({\r\n        model: modelId,\r\n        messages,\r\n        stream: true,\r\n      }),\r\n      signal,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      this.logger.error({\r\n        message: 'LM Studio error response',\r\n        status: response.status,\r\n        errorText,\r\n      });\r\n      throw new InternalServerErrorException({\r\n        type: 'lm_studio_error',\r\n        title: 'LM Studio Error',\r\n        status: 500,\r\n        detail: `LM Studio returned ${response.status}: ${errorText}`,\r\n      });\r\n    }\r\n\r\n    const reader = response.body?.getReader();\r\n    if (!reader) {\r\n      throw new InternalServerErrorException({\r\n        type: 'stream_error',\r\n        title: 'Stream Error',\r\n        status: 500,\r\n        detail: 'Failed to get response stream from LM Studio / vLLM',\r\n      });\r\n    }\r\n\r\n    const decoder = new TextDecoder();\r\n    let buffer = '';\r\n\r\n    try {\r\n      while (true) {\r\n        const { done, value } = await reader.read();\r\n        if (done) break;\r\n\r\n        buffer += decoder.decode(value, { stream: true });\r\n        const lines = buffer.split('\\n');\r\n        buffer = lines.pop() ?? '';\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6);\r\n            if (data === '[DONE]') continue;\r\n\r\n            try {\r\n              const parsed = JSON.parse(data) as OpenRouterResponse;\r\n              const content = parsed.choices[0]?.delta?.content;\r\n              if (content) {\r\n                onChunk(content);\r\n              }\r\n            } catch {\r\n              // Skip malformed JSON lines\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } finally {\r\n      reader.releaseLock();\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'LM Studio streaming completed',\r\n      modelId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Truncates conversation messages to fit within the model's context window.\r\n   * Preserves the system message and the latest user message, dropping oldest\r\n   * conversation history first. Uses rough token estimation (1 token  4 chars).\r\n   *\r\n   * Budget: 128000 max - 16000 reserved for output = 112000 input tokens.\r\n   */\r\n  private truncateMessagesToFit(messages: ChatMessage[], correlationId: string): ChatMessage[] {\r\n    const MAX_CONTEXT_TOKENS = 128000;\r\n    const RESERVED_FOR_OUTPUT = 16000;\r\n    const MAX_INPUT_TOKENS = MAX_CONTEXT_TOKENS - RESERVED_FOR_OUTPUT;\r\n\r\n    const estimateTokens = (text: string): number => Math.ceil(text.length / 4);\r\n\r\n    const totalTokens = messages.reduce((acc, m) => acc + estimateTokens(m.content), 0);\r\n\r\n    if (totalTokens <= MAX_INPUT_TOKENS) {\r\n      return messages;\r\n    }\r\n\r\n    this.logger.warn({\r\n      message: 'Messages exceed context window, truncating',\r\n      correlationId,\r\n      totalTokens,\r\n      maxInputTokens: MAX_INPUT_TOKENS,\r\n      messageCount: messages.length,\r\n    });\r\n\r\n    // Separate system message from conversation\r\n    const systemMessage = messages[0]?.role === 'system' ? messages[0] : null;\r\n    const conversationMessages = systemMessage ? messages.slice(1) : [...messages];\r\n\r\n    // If system message alone exceeds budget, truncate its content\r\n    let systemTokens = systemMessage ? estimateTokens(systemMessage.content) : 0;\r\n    let truncatedSystem = systemMessage;\r\n\r\n    if (systemTokens > MAX_INPUT_TOKENS * 0.6) {\r\n      // Cap system message at 60% of budget\r\n      const maxSystemChars = Math.floor(MAX_INPUT_TOKENS * 0.6 * 4);\r\n      truncatedSystem = {\r\n        role: 'system' as const,\r\n        content:\r\n          systemMessage!.content.substring(0, maxSystemChars) +\r\n          '\\n[...context trimmed to fit model limits]',\r\n      };\r\n      systemTokens = estimateTokens(truncatedSystem.content);\r\n      this.logger.warn({\r\n        message: 'System prompt truncated to fit context window',\r\n        correlationId,\r\n        originalTokens: estimateTokens(systemMessage!.content),\r\n        truncatedTokens: systemTokens,\r\n      });\r\n    }\r\n\r\n    const remainingBudget = MAX_INPUT_TOKENS - systemTokens;\r\n\r\n    // Always keep the latest message (the user's current question)\r\n    // Build from newest to oldest until budget is exhausted\r\n    const result: ChatMessage[] = [];\r\n    let usedTokens = 0;\r\n\r\n    for (let i = conversationMessages.length - 1; i >= 0; i--) {\r\n      const msg = conversationMessages[i]!;\r\n      const msgTokens = estimateTokens(msg.content);\r\n      if (usedTokens + msgTokens > remainingBudget) {\r\n        break;\r\n      }\r\n      result.unshift(msg);\r\n      usedTokens += msgTokens;\r\n    }\r\n\r\n    // Ensure at least the latest message is included even if it's large\r\n    if (result.length === 0 && conversationMessages.length > 0) {\r\n      const lastMsg = conversationMessages[conversationMessages.length - 1]!;\r\n      const maxChars = remainingBudget * 4;\r\n      const truncatedMsg: ChatMessage = {\r\n        role: lastMsg.role,\r\n        content: lastMsg.content.substring(0, maxChars),\r\n      };\r\n      result.push(truncatedMsg);\r\n      usedTokens = estimateTokens(truncatedMsg.content);\r\n    }\r\n\r\n    const finalMessages = truncatedSystem ? [truncatedSystem, ...result] : result;\r\n    const droppedCount = messages.length - finalMessages.length;\r\n\r\n    this.logger.log({\r\n      message: 'Messages truncated to fit context window',\r\n      correlationId,\r\n      originalMessages: messages.length,\r\n      keptMessages: finalMessages.length,\r\n      droppedMessages: droppedCount,\r\n      estimatedInputTokens: systemTokens + usedTokens,\r\n      maxInputTokens: MAX_INPUT_TOKENS,\r\n    });\r\n\r\n    return finalMessages;\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport {\r\n  ConfidenceScore,\r\n  ConfidenceFactor,\r\n  ConfidenceLevel,\r\n  ConfidenceContext,\r\n  type PersonaType,\r\n} from '@mentor-ai/shared/types';\r\nimport { getHedgingConfidenceScore, analyzeHedging } from './hedging-detector';\r\n\r\n/**\r\n * Configuration for confidence factor weights.\r\n * Weights must sum to 1.0.\r\n */\r\nconst FACTOR_WEIGHTS = {\r\n  hedging: 0.35,\r\n  context: 0.35,\r\n  specificity: 0.3,\r\n} as const;\r\n\r\n/**\r\n * Service for calculating AI response confidence scores.\r\n * Uses multi-factor analysis including hedging language, context depth, and response specificity.\r\n */\r\n@Injectable()\r\nexport class ConfidenceService {\r\n  private readonly logger = new Logger(ConfidenceService.name);\r\n\r\n  /**\r\n   * Calculates confidence score for an AI response.\r\n   *\r\n   * @param response - The AI-generated response text\r\n   * @param context - Context information for the calculation\r\n   * @returns ConfidenceScore with overall score, level, and factor breakdown\r\n   */\r\n  calculateConfidence(response: string, context: ConfidenceContext): ConfidenceScore {\r\n    const factors: ConfidenceFactor[] = [];\r\n\r\n    // Factor 1: Hedging language analysis\r\n    const hedgingScore = this.calculateHedgingFactor(response);\r\n    factors.push(hedgingScore);\r\n\r\n    // Factor 2: Context depth analysis\r\n    const contextScore = this.calculateContextFactor(context);\r\n    factors.push(contextScore);\r\n\r\n    // Factor 3: Response specificity analysis\r\n    const specificityScore = this.calculateSpecificityFactor(response);\r\n    factors.push(specificityScore);\r\n\r\n    // Calculate weighted average\r\n    const totalScore = factors.reduce((sum, factor) => sum + factor.score * factor.weight, 0);\r\n\r\n    const level = this.getConfidenceLevel(totalScore);\r\n\r\n    const result: ConfidenceScore = {\r\n      score: Math.round(totalScore * 100) / 100, // Round to 2 decimal places\r\n      level,\r\n      factors,\r\n    };\r\n\r\n    this.logger.log({\r\n      message: 'Confidence calculated',\r\n      score: result.score,\r\n      level: result.level,\r\n      factorScores: factors.map((f) => ({ name: f.name, score: f.score })),\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Calculates confidence for a multi-section response.\r\n   * Each section gets its own score, and overall is the weighted average.\r\n   *\r\n   * @param sections - Array of response sections to analyze\r\n   * @param context - Context information for the calculation\r\n   * @returns Array of section scores and overall average\r\n   */\r\n  calculateMultiSectionConfidence(\r\n    sections: string[],\r\n    context: ConfidenceContext,\r\n  ): { sectionScores: ConfidenceScore[]; overall: ConfidenceScore } {\r\n    const sectionScores = sections.map((section) => this.calculateConfidence(section, context));\r\n\r\n    // Calculate weighted average based on section length\r\n    const totalLength = sections.reduce((sum, s) => sum + s.length, 0);\r\n    let weightedSum = 0;\r\n\r\n    for (let i = 0; i < sections.length; i++) {\r\n      const weight = sections[i]!.length / totalLength;\r\n      weightedSum += sectionScores[i]!.score * weight;\r\n    }\r\n\r\n    // Build overall score by averaging factors\r\n    const avgFactors = this.averageFactors(sectionScores.map((s) => s.factors));\r\n\r\n    const overall: ConfidenceScore = {\r\n      score: Math.round(weightedSum * 100) / 100,\r\n      level: this.getConfidenceLevel(weightedSum),\r\n      factors: avgFactors,\r\n    };\r\n\r\n    return { sectionScores, overall };\r\n  }\r\n\r\n  /**\r\n   * Calculates the hedging language factor.\r\n   *\r\n   * @param response - Response text to analyze\r\n   * @returns Hedging confidence factor\r\n   */\r\n  private calculateHedgingFactor(response: string): ConfidenceFactor {\r\n    const hedgingScore = getHedgingConfidenceScore(response);\r\n    const analysis = analyzeHedging(response);\r\n\r\n    return {\r\n      name: 'hedging_language',\r\n      score: hedgingScore,\r\n      weight: FACTOR_WEIGHTS.hedging,\r\n      description: `Hedging word count: ${analysis.hedgingCount}. Lower hedging indicates higher confidence.`,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculates the context depth factor.\r\n   *\r\n   * @param context - Context information\r\n   * @returns Context depth confidence factor\r\n   */\r\n  private calculateContextFactor(context: ConfidenceContext): ConfidenceFactor {\r\n    let score = 0.5; // Base score\r\n\r\n    // More conversation history = more context = higher confidence\r\n    if (context.messageCount > 10) {\r\n      score += 0.2;\r\n    } else if (context.messageCount > 5) {\r\n      score += 0.15;\r\n    } else if (context.messageCount > 2) {\r\n      score += 0.1;\r\n    }\r\n\r\n    // Client context available = higher confidence\r\n    if (context.hasClientContext) {\r\n      score += 0.15;\r\n    }\r\n\r\n    // Specific data provided = higher confidence\r\n    if (context.hasSpecificData) {\r\n      score += 0.15;\r\n    }\r\n\r\n    // Cap at 1.0\r\n    score = Math.min(1.0, score);\r\n\r\n    const description = this.buildContextDescription(context);\r\n\r\n    return {\r\n      name: 'context_depth',\r\n      score,\r\n      weight: FACTOR_WEIGHTS.context,\r\n      description,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculates the response specificity factor.\r\n   * Specific responses with numbers, dates, and concrete terms score higher.\r\n   *\r\n   * @param response - Response text to analyze\r\n   * @returns Specificity confidence factor\r\n   */\r\n  private calculateSpecificityFactor(response: string): ConfidenceFactor {\r\n    let score = 0.6; // Base score\r\n\r\n    // Count specific indicators\r\n    const numberMatches = response.match(/\\d+(\\.\\d+)?%?/g) ?? [];\r\n    const currencyMatches = response.match(/\\$[\\d,]+(\\.\\d{2})?/g) ?? [];\r\n    const dateMatches =\r\n      response.match(/\\b(January|February|March|April|May|June|July|August|September|October|November|December|\\d{4}|Q[1-4])\\b/gi) ??\r\n      [];\r\n\r\n    // Increase score based on specificity indicators\r\n    if (numberMatches.length > 3) {\r\n      score += 0.2;\r\n    } else if (numberMatches.length > 0) {\r\n      score += 0.1;\r\n    }\r\n\r\n    if (currencyMatches.length > 0) {\r\n      score += 0.1;\r\n    }\r\n\r\n    if (dateMatches.length > 0) {\r\n      score += 0.1;\r\n    }\r\n\r\n    // Cap at 1.0\r\n    score = Math.min(1.0, score);\r\n\r\n    return {\r\n      name: 'response_specificity',\r\n      score,\r\n      weight: FACTOR_WEIGHTS.specificity,\r\n      description: `Found ${numberMatches.length} numbers, ${currencyMatches.length} currencies, ${dateMatches.length} dates. Specific recommendations score higher.`,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Determines confidence level from numeric score.\r\n   *\r\n   * @param score - Numeric score (0.0-1.0)\r\n   * @returns Confidence level enum\r\n   */\r\n  private getConfidenceLevel(score: number): ConfidenceLevel {\r\n    if (score >= 0.85) {\r\n      return ConfidenceLevel.HIGH;\r\n    }\r\n    if (score >= 0.5) {\r\n      return ConfidenceLevel.MEDIUM;\r\n    }\r\n    return ConfidenceLevel.LOW;\r\n  }\r\n\r\n  /**\r\n   * Builds a description for the context factor.\r\n   */\r\n  private buildContextDescription(context: ConfidenceContext): string {\r\n    const parts: string[] = [];\r\n\r\n    if (context.messageCount > 0) {\r\n      parts.push(`${context.messageCount} messages in history`);\r\n    }\r\n\r\n    if (context.hasClientContext) {\r\n      parts.push('client context available');\r\n    }\r\n\r\n    if (context.hasSpecificData) {\r\n      parts.push('specific data provided');\r\n    }\r\n\r\n    if (parts.length === 0) {\r\n      return 'Limited context available for this response.';\r\n    }\r\n\r\n    return `Context: ${parts.join(', ')}. More context improves confidence.`;\r\n  }\r\n\r\n  /**\r\n   * Averages factors across multiple confidence scores.\r\n   */\r\n  private averageFactors(factorArrays: ConfidenceFactor[][]): ConfidenceFactor[] {\r\n    if (factorArrays.length === 0) return [];\r\n\r\n    const firstFactors = factorArrays[0]!;\r\n    return firstFactors.map((factor, index) => {\r\n      const avgScore =\r\n        factorArrays.reduce((sum, factors) => sum + (factors[index]?.score ?? 0), 0) /\r\n        factorArrays.length;\r\n\r\n      return {\r\n        name: factor.name,\r\n        score: Math.round(avgScore * 100) / 100,\r\n        weight: factor.weight,\r\n        description: `Average across ${factorArrays.length} sections.`,\r\n      };\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Hedging language detector for confidence scoring.\r\n * Analyzes AI response text for uncertainty markers.\r\n */\r\n\r\n/**\r\n * Hedging pattern with weight indicating uncertainty impact.\r\n */\r\ninterface HedgingPattern {\r\n  /** Regular expression pattern to match */\r\n  pattern: RegExp;\r\n  /** Weight of this pattern (0.0-1.0, higher = more uncertain) */\r\n  weight: number;\r\n  /** Category of hedging */\r\n  category: string;\r\n}\r\n\r\n/**\r\n * Result of hedging analysis.\r\n */\r\nexport interface HedgingAnalysisResult {\r\n  /** Uncertainty ratio (0.0-1.0, higher = more uncertain) */\r\n  uncertaintyRatio: number;\r\n  /** Total hedging words found */\r\n  hedgingCount: number;\r\n  /** Total word count in the text */\r\n  wordCount: number;\r\n  /** Breakdown by category */\r\n  categories: Record<string, number>;\r\n  /** Position-weighted uncertainty (early hedging has more impact) */\r\n  positionWeightedScore: number;\r\n}\r\n\r\n/**\r\n * Hedging language patterns with uncertainty weights.\r\n * Higher weight = more uncertainty impact.\r\n */\r\nconst HEDGING_PATTERNS: HedgingPattern[] = [\r\n  // Possibility hedges (moderate uncertainty)\r\n  {\r\n    pattern: /\\b(might|may|could|possibly|perhaps)\\b/gi,\r\n    weight: 0.5,\r\n    category: 'possibility',\r\n  },\r\n  // Approximation hedges (lower uncertainty)\r\n  {\r\n    pattern: /\\b(approximately|roughly|around|about|nearly|almost)\\b/gi,\r\n    weight: 0.3,\r\n    category: 'approximation',\r\n  },\r\n  // Uncertainty markers (high uncertainty)\r\n  {\r\n    pattern: /\\b(uncertain|unclear|unsure|not sure|hard to say|difficult to determine)\\b/gi,\r\n    weight: 0.8,\r\n    category: 'uncertainty',\r\n  },\r\n  // Qualification hedges (lower uncertainty)\r\n  {\r\n    pattern: /\\b(generally|usually|typically|often|sometimes|frequently)\\b/gi,\r\n    weight: 0.2,\r\n    category: 'qualification',\r\n  },\r\n  // Disclaimer phrases (high uncertainty)\r\n  {\r\n    pattern:\r\n      /\\b(this is just|this is only|limited data|not financial advice|not legal advice|consult a professional)\\b/gi,\r\n    weight: 0.6,\r\n    category: 'disclaimer',\r\n  },\r\n  // Conditional phrases (moderate uncertainty)\r\n  {\r\n    pattern: /\\b(if|depending on|it depends|would depend)\\b/gi,\r\n    weight: 0.4,\r\n    category: 'conditional',\r\n  },\r\n  // Weak assertions (moderate uncertainty)\r\n  {\r\n    pattern: /\\b(seems|appears|suggests|indicates|implies)\\b/gi,\r\n    weight: 0.4,\r\n    category: 'weak_assertion',\r\n  },\r\n  // Probability words (lower uncertainty)\r\n  {\r\n    pattern: /\\b(likely|probably|presumably|presumably)\\b/gi,\r\n    weight: 0.3,\r\n    category: 'probability',\r\n  },\r\n];\r\n\r\n/**\r\n * Analyzes text for hedging language to determine uncertainty level.\r\n *\r\n * @param text - Text content to analyze\r\n * @returns Analysis result with uncertainty metrics\r\n */\r\nexport function analyzeHedging(text: string): HedgingAnalysisResult {\r\n  const words = text.split(/\\s+/).filter((w) => w.length > 0);\r\n  const wordCount = words.length;\r\n\r\n  if (wordCount === 0) {\r\n    return {\r\n      uncertaintyRatio: 0,\r\n      hedgingCount: 0,\r\n      wordCount: 0,\r\n      categories: {},\r\n      positionWeightedScore: 0,\r\n    };\r\n  }\r\n\r\n  const categories: Record<string, number> = {};\r\n  let totalHedgingCount = 0;\r\n  let weightedSum = 0;\r\n  let positionWeightedSum = 0;\r\n\r\n  for (const { pattern, weight, category } of HEDGING_PATTERNS) {\r\n    const matches = text.matchAll(pattern);\r\n\r\n    for (const match of matches) {\r\n      totalHedgingCount++;\r\n      weightedSum += weight;\r\n\r\n      // Track category counts\r\n      categories[category] = (categories[category] ?? 0) + 1;\r\n\r\n      // Position weighting: hedging in first 20% of text has 2x impact\r\n      if (match.index !== undefined) {\r\n        const position = match.index / text.length;\r\n        const positionMultiplier = position < 0.2 ? 2.0 : position < 0.5 ? 1.5 : 1.0;\r\n        positionWeightedSum += weight * positionMultiplier;\r\n      } else {\r\n        positionWeightedSum += weight;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Calculate uncertainty ratio (normalize by word count)\r\n  // More hedging words relative to total words = higher uncertainty\r\n  const normalizedHedgingDensity = totalHedgingCount / wordCount;\r\n\r\n  // Cap at 1.0 and scale appropriately\r\n  // A density of 0.1 (10% hedging words) would be quite high\r\n  const uncertaintyRatio = Math.min(1.0, normalizedHedgingDensity * 10);\r\n\r\n  // Position-weighted score normalized similarly\r\n  const positionWeightedScore = Math.min(1.0, (positionWeightedSum / wordCount) * 10);\r\n\r\n  return {\r\n    uncertaintyRatio,\r\n    hedgingCount: totalHedgingCount,\r\n    wordCount,\r\n    categories,\r\n    positionWeightedScore,\r\n  };\r\n}\r\n\r\n/**\r\n * Gets confidence score from hedging analysis.\r\n * Inverts uncertainty to confidence (less hedging = higher confidence).\r\n *\r\n * @param text - Text to analyze\r\n * @returns Confidence score (0.0-1.0)\r\n */\r\nexport function getHedgingConfidenceScore(text: string): number {\r\n  const analysis = analyzeHedging(text);\r\n\r\n  // Use position-weighted score for more nuanced result\r\n  // Invert: high uncertainty = low confidence\r\n  return 1 - analysis.positionWeightedScore;\r\n}\r\n","import type { PersonaSystemPrompt, PersonaType } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Shared formatting rules  injected into every persona prompt.\r\n * Single source of truth to prevent duplication.\r\n */\r\nconst FORMATTING_RULES = `\r\nFORMATIRANJE (STROGO OBAVEZNO  svaki odgovor MORA koristiti ove formate):\r\n\r\n1. SEKCIJE: Organizuj svaki odgovor sa ## naslovom za svaku sekciju.\r\n\r\n2. CALLOUT BLOKOVI (koristi MINIMUM 2 razliita tipa po odgovoru):\r\n> **Kljuni uvid:** Ovde ide najvaniji zakljuak ili preporuka.\r\n\r\n> **Upozorenje:** Ovde ide rizik, opasnost ili problem.\r\n\r\n> **Metrika:** Relevantni brojevi i KPI za datu oblast.\r\n\r\n> **Rezime:** Kratki zakljuak sa konkretnom preporukom.\r\n\r\n3. TABELE SA BROJEVIMA (OBAVEZNO kad god ima numerike podatke):\r\n| Kategorija | Vrednost | Promena |\r\n|------------|----------|---------|\r\n| Primer     | 100.000 | +15%    |\r\n\r\n4. OSTALA PRAVILA:\r\n- Koristi **bold** za sve kljune termine\r\n- Koristi bullet liste za nabrajanje, NE dugake paragrafe\r\n- Ako ima web izvore, citiraj INLINE: ([Naziv izvora](URL)) odmah posle reenice\r\n- Odgovaraj UVEK na srpskom jeziku\r\n- NIKADA ne pii odgovor bez bar jednog callout bloka i jedne tabele\r\n- Minimum 400 rei za analitike odgovore  ne daj povrne odgovore`;\r\n\r\n/**\r\n * CFO Persona  Financial expertise, ROI focus, metrics-driven\r\n */\r\nconst CFO_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'CFO' as PersonaType,\r\n  systemPrompt: `Ti si Finansijski Direktor (CFO)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Finansijska strategija i planiranje\r\n- Budetiranje, prognoziranje i finansijsko modeliranje\r\n- Upravljanje novanim tokom i optimizacija\r\n- Analiza investicija i ROI kalkulacije\r\n- Finansijsko izvetavanje i usklaenost\r\n- Procena rizika i strategije ublaavanja\r\n- Upravljanje trokovima i efikasnost\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Baziran na podacima i metrikama\r\n- Jasna finansijska terminologija\r\n- Preporuke orijentisane ka ROI i uticaju\r\n- Donoenje odluka sa sveu o riziku\r\n- Kvantitativna analiza sa kvalitativnim kontekstom\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa finansijskim implikacijama i kljunim metrikama\r\n- Ukljui relevantne KPI i benchmark-ove\r\n- Daj cost-benefit analizu kada je primenljivo\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi akcione preporuke sa oekivanim ishodima\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao pouzdan finansijski savetnik koji balansira prilike za rast sa fiskalnom odgovornou.`,\r\n  capabilities: [\r\n    'Finansijska analiza i modeliranje',\r\n    'Planiranje budeta i prognoziranje',\r\n    'ROI i analiza investicija',\r\n    'Procena rizika',\r\n    'Strategije optimizacije trokova',\r\n    'Uvidi iz finansijskih izvetaja',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pruiti specifine pravne ili poreske savete',\r\n    'Analiza bazirana na optim principima, ne specifinim regulativama',\r\n    'Preporuke zahtevaju validaciju sa stvarnim finansijskim podacima',\r\n  ],\r\n};\r\n\r\n/**\r\n * CMO Persona  Marketing expertise, brand focus, growth strategies\r\n */\r\nconst CMO_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'CMO' as PersonaType,\r\n  systemPrompt: `Ti si Direktor Marketinga (CMO)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Strategija brenda i pozicioniranje\r\n- Razvoj marketing kampanja\r\n- Akvizicija i zadravanje kupaca\r\n- Growth marketing i generisanje tranje\r\n- Istraivanje trita i analiza konkurencije\r\n- Digitalni marketing i strategija sadraja\r\n- Optimizacija korisnikog putovanja\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Fokusiran na kupca i publiku\r\n- Kreativan ali informisan podacima\r\n- Voen priom sa merljivim rezultatima\r\n- Svestan trendova i okrenut budunosti\r\n- Kolaborativan i meufunkcionalan\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa uticajem na kupca i trinom prilikom\r\n- Ukljui uvide o publici i segmentaciji\r\n- Daj preporuke specifine za kanale\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi strategije sa oekivanim metrikama engagementa i konverzije\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao strateki marketing lider koji kombinuje kreativnost sa analitikom za odrivi rast i vrednost brenda.`,\r\n  capabilities: [\r\n    'Razvoj strategije brenda',\r\n    'Planiranje i optimizacija kampanja',\r\n    'Analiza trita i pozicioniranje',\r\n    'Segmentacija kupaca',\r\n    'Strategija sadraja',\r\n    'Growth marketing taktike',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pristupiti trinim podacima u realnom vremenu',\r\n    'Strategije zahtevaju prilagoavanje specifinim uslovima trita',\r\n    'Metrike su procene bazirane na industrijskim benchmark-ovima',\r\n  ],\r\n};\r\n\r\n/**\r\n * CTO Persona  Technical expertise, architecture, scalability\r\n */\r\nconst CTO_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'CTO' as PersonaType,\r\n  systemPrompt: `Ti si Tehniki Direktor (CTO)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Tehnika arhitektura i dizajn sistema\r\n- Najbolje prakse u razvoju softvera\r\n- Cloud infrastruktura i DevOps\r\n- Tehnoloka strategija i roadmap-ovi\r\n- Sigurnosna arhitektura i usklaenost\r\n- Struktura tima i tehniko liderstvo\r\n- Evaluacija novih tehnologija\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Tehniki ali pristupaan\r\n- Fokusiran na arhitekturu i skalabilnost\r\n- Svestan sigurnosti\r\n- Svestan kompromisa (trade-off)\r\n- Pragmatian i orijentisan ka reenjima\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa tehnikim pristupom i implikacijama na arhitekturu\r\n- Ukljui razmatranja skalabilnosti i performansi\r\n- Daj kontekst sigurnosti i usklaenosti\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi opcije sa tehnikim kompromisima i preporukama\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao strateki tehnoloki lider koji balansira inovaciju sa pouzdanou, sigurnou i odrivou.`,\r\n  capabilities: [\r\n    'Dizajn i revizija arhitekture',\r\n    'Smernice za izbor tehnologije',\r\n    'Najbolje prakse sigurnosti',\r\n    'Planiranje skalabilnosti',\r\n    'Procena tehnikog duga',\r\n    'Optimizacija procesa razvoja',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pisati ili izvravati kod direktno',\r\n    'Preporuke zahtevaju validaciju sa specifinim tech stack-om',\r\n    'Sigurnosni saveti su opte smernice, ne sertifikacija usklaenosti',\r\n  ],\r\n};\r\n\r\n/**\r\n * Operations Persona  Process optimization, efficiency, resources\r\n */\r\nconst OPERATIONS_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'OPERATIONS' as PersonaType,\r\n  systemPrompt: `Ti si Operativni Direktor (COO)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Optimizacija procesa i dizajn radnih tokova\r\n- Operativna efikasnost i lean metodologije\r\n- Upravljanje lancem snabdevanja i logistika\r\n- Alokacija resursa i planiranje kapaciteta\r\n- Osiguranje kvaliteta i kontinuirano poboljanje\r\n- Upravljanje dobavljaima i nabavka\r\n- Meufunkcionalna koordinacija\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Orijentisan na procese i sistematian\r\n- Fokusiran na efikasnost sa merljivim rezultatima\r\n- Praktian i spreman za implementaciju\r\n- Operativne metrike bazirane na podacima\r\n- Kolaborativan izmeu departmana\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa operativnim uticajem i utedama u efikasnosti\r\n- Ukljui analizu tokova procesa i uskih grla\r\n- Daj korake implementacije i vremenske okvire\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi preporuke sa oekivanim operativnim poboljanjima\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao strateki operativni lider fokusiran na optimizaciju procesa, smanjenje gubitaka i maksimiziranje organizacione efektivnosti.`,\r\n  capabilities: [\r\n    'Dizajn i optimizacija procesa',\r\n    'Analiza radnih tokova',\r\n    'Planiranje kapaciteta',\r\n    'Evaluacija dobavljaa',\r\n    'Upravljanje kvalitetom',\r\n    'Praenje operativnih metrika',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pristupiti operativnim podacima u realnom vremenu',\r\n    'Preporuke zahtevaju prilagoavanje specifinim radnim tokovima',\r\n    'Procene efikasnosti bazirane na industrijskim standardima',\r\n  ],\r\n};\r\n\r\n/**\r\n * Legal Persona  Compliance, contracts, risk management\r\n */\r\nconst LEGAL_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'LEGAL' as PersonaType,\r\n  systemPrompt: `Ti si Pravni Savetnik (General Counsel)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Pregled i pregovaranje ugovora\r\n- Regulatorna usklaenost i upravljanje\r\n- Zatita intelektualne svojine\r\n- Procena i ublaavanje rizika\r\n- Korporativno upravljanje\r\n- Osnove radnog prava\r\n- Usklaenost sa zatitom podataka i privatnosti\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Precizan i pravniki orijentisan\r\n- Svestan rizika i oprezan\r\n- Jasno objanjavanje pravnih koncepata\r\n- Balansiran pristup poslovnim potrebama\r\n- Naglasak na detaljnoj dokumentaciji\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa pravnim razmatranjima i faktorima rizika\r\n- Ukljui relevantan regulatorni kontekst\r\n- Daj checkliste za usklaenost kada je primenljivo\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi preporuke sa odgovarajuim napomenama\r\n${FORMATTING_RULES}\r\n\r\nVANA NAPOMENA: Ova AI prua opte pravne informacije i smernice. NIJE zamena za profesionalni pravni savet licenciranog advokata. Uvek konsultujte kvalifikovanog pravnog savetnika za specifina pravna pitanja.`,\r\n  capabilities: [\r\n    'Smernice za strukturu ugovora',\r\n    'Pregled okvira usklaenosti',\r\n    'Identifikacija rizika',\r\n    'Smernice za razvoj politika',\r\n    'Svest o regulativi',\r\n    'abloni pravnih dokumenata',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pruiti specifine pravne savete',\r\n    'Nije zamena za konsultaciju sa licenciranim advokatom',\r\n    'Informacije moda ne odraavaju najnoviju regulativu',\r\n    'Smernice su edukativne, ne pravni savet',\r\n  ],\r\n};\r\n\r\n/**\r\n * Creative Persona  Innovation, design thinking, creative strategy\r\n */\r\nconst CREATIVE_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'CREATIVE' as PersonaType,\r\n  systemPrompt: `Ti si Kreativni Direktor (CCO)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Kreativna strategija i ideacija\r\n- Identitet brenda i vizuelni dizajn\r\n- Design thinking metodologija\r\n- Principi korisnikog iskustva (UX)\r\n- Storytelling i razvoj narativa\r\n- Inovacione radionice i brainstorming\r\n- Liderstvo kreativnog tima\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Matovit i inspirativan\r\n- Vizuelan i opisni\r\n- Empatian prema korisniku\r\n- Svestan trendova\r\n- Kolaborativan i ohrabrujui\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa kreativnom vizijom i uticajem na korisnika\r\n- Ukljui vizuelne koncepte i opise raspoloenja\r\n- Daj tehnike ideacije i kreativne framework-ove\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi vie kreativnih pravaca sa obrazloenjem\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao inovativni kreativni lider koji kombinuje umetniku viziju sa stratekim razmiljanjem za stvaranje znaajnih iskustava i ubedljivih narativa brenda.`,\r\n  capabilities: [\r\n    'Razvoj kreativne strategije',\r\n    'Smernice za identitet brenda',\r\n    'Facilitacija design thinking-a',\r\n    'Ideacija i brainstorming',\r\n    'Storytelling framework-ovi',\r\n    'Smernice za UX principe',\r\n  ],\r\n  limitations: [\r\n    'Ne moe kreirati stvarne vizuelne dizajne',\r\n    'Kreativni koncepti zahtevaju realizaciju od strane dizajnera',\r\n    'Trendovi i estetika se menjaju tokom vremena',\r\n  ],\r\n};\r\n\r\n/**\r\n * CSO Persona  Strategic planning, competitive analysis, positioning\r\n */\r\nconst CSO_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'CSO' as PersonaType,\r\n  systemPrompt: `Ti si Direktor Strategije (CSO)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Poslovna strategija i dugorono planiranje\r\n- Analiza konkurencije i trino pozicioniranje\r\n- SWOT analiza i strateki framework-ovi\r\n- Strategija rasta i ekspanzije na trite\r\n- Inovacija poslovnog modela\r\n- Strateka partnerstva i savezi\r\n- Upravljanje portfoliom i diversifikacija\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Vizionarski i okrenut budunosti\r\n- Analiza voena framework-ovima\r\n- Strateko rezonovanje bazirano na dokazima\r\n- Planiranje scenarija i kontingencija\r\n- Jasna artikulacija kompromisa\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa stratekim implikacijama i trinim kontekstom\r\n- Ukljui analizu konkurentskog pejzaa\r\n- Daj preporuke bazirane na framework-ovima (Porter, BCG, itd.)\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi strateke opcije sa procenom rizika i nagrade\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao vizionarski strateki lider koji kombinuje analitiku strogost sa kreativnim razmiljanjem za identifikaciju odrivih konkurentskih prednosti.`,\r\n  capabilities: [\r\n    'Primena stratekih framework-ova',\r\n    'Analiza konkurencije',\r\n    'Smernice za trino pozicioniranje',\r\n    'Razvoj strategije rasta',\r\n    'Evaluacija poslovnog modela',\r\n    'Facilitacija stratekog planiranja',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pristupiti vlasnikim konkurentskim podacima',\r\n    'Strategije zahtevaju validaciju sa stvarnim trinim podacima',\r\n    'Preporuke su framework-ovi, ne garantovani ishodi',\r\n  ],\r\n};\r\n\r\n/**\r\n * Sales Persona  Sales strategy, pipeline, revenue growth\r\n */\r\nconst SALES_SYSTEM_PROMPT: PersonaSystemPrompt = {\r\n  type: 'SALES' as PersonaType,\r\n  systemPrompt: `Ti si Direktor Prodaje (VP of Sales)  AI persona za poslovnu inteligenciju.\r\n\r\nEKSPERTIZA:\r\n- Strategija prodaje i upravljanje pipeline-om\r\n- Kvalifikacija i scoring lead-ova\r\n- Prognoziranje prodaje i planiranje prihoda\r\n- Upravljanje odnosima sa klijentima\r\n- Konsultativna i solution prodaja\r\n- Tehnike pregovaranja i zatvaranja\r\n- Enablement i trening prodajnog tima\r\n\r\nSTIL KOMUNIKACIJE:\r\n- Orijentisan na rezultate i prihode\r\n- Komunikacija voena odnosima\r\n- Praktian i orijentisan na akciju\r\n- Svestan metrika (pipeline, konverzija, ARR)\r\n- Samouvereni i ubedljiv\r\n\r\nFORMAT ODGOVORA:\r\n- Vodi sa uticajem na prihode i implikacijama na pipeline\r\n- Ukljui metrike prodaje i benchmark-ove konverzije\r\n- Daj akcione playbook-ove i talk track-ove\r\n- Citiraj izvore koristei [[Naziv Koncepta]] format\r\n- Predstavi preporuke sa oekivanim prihodovnim ishodima\r\n${FORMATTING_RULES}\r\n\r\nOdgovaraj kao iskusan prodajni lider koji kombinuje inteligenciju odnosa sa strategijama baziranim na podacima za ubrzanje rasta prihoda.`,\r\n  capabilities: [\r\n    'Razvoj strategije prodaje',\r\n    'Analiza i optimizacija pipeline-a',\r\n    'Framework-ovi za kvalifikaciju lead-ova',\r\n    'Smernice za pregovaranje',\r\n    'Dizajn procesa prodaje',\r\n    'Prognoziranje prihoda',\r\n  ],\r\n  limitations: [\r\n    'Ne moe pristupiti CRM podacima u realnom vremenu',\r\n    'Projekcije prodaje su procene bazirane na industrijskim benchmark-ovima',\r\n    'Strategije zahtevaju prilagoavanje specifinim ciklusima prodaje',\r\n  ],\r\n};\r\n\r\n/**\r\n * Map of all persona system prompts indexed by PersonaType\r\n */\r\nexport const PERSONA_PROMPTS: Record<string, PersonaSystemPrompt> = {\r\n  CFO: CFO_SYSTEM_PROMPT,\r\n  CMO: CMO_SYSTEM_PROMPT,\r\n  CTO: CTO_SYSTEM_PROMPT,\r\n  OPERATIONS: OPERATIONS_SYSTEM_PROMPT,\r\n  LEGAL: LEGAL_SYSTEM_PROMPT,\r\n  CREATIVE: CREATIVE_SYSTEM_PROMPT,\r\n  CSO: CSO_SYSTEM_PROMPT,\r\n  SALES: SALES_SYSTEM_PROMPT,\r\n};\r\n\r\n/**\r\n * Gets the system prompt for a specific persona type.\r\n * @param type - PersonaType string\r\n * @returns PersonaSystemPrompt or undefined if not found\r\n */\r\nexport function getPersonaSystemPrompt(type: string): PersonaSystemPrompt | undefined {\r\n  return PERSONA_PROMPTS[type];\r\n}\r\n\r\n/**\r\n * Generates the full system message for AI context.\r\n * @param type - PersonaType string\r\n * @returns System prompt string or empty string if persona not found\r\n */\r\nexport function generateSystemPrompt(type: string): string {\r\n  const prompt = PERSONA_PROMPTS[type];\r\n  return prompt?.systemPrompt ?? '';\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { RedisService } from './redis.service';\r\nimport { RateLimitInfo, RateLimitHeaders } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Alias for RateLimitInfo for backward compatibility.\r\n * @deprecated Use RateLimitInfo from @mentor-ai/shared/types directly.\r\n */\r\nexport type RateLimitResult = RateLimitInfo;\r\n\r\n// Re-export shared types for consumers\r\nexport type { RateLimitHeaders };\r\n\r\n/**\r\n * Service for enforcing rate limits on AI gateway requests.\r\n * Implements per-tenant and per-user rate limiting using sliding window algorithm.\r\n */\r\n@Injectable()\r\nexport class RateLimiterService {\r\n  private readonly logger = new Logger(RateLimiterService.name);\r\n\r\n  /** Default tenant rate limit: requests per minute */\r\n  private readonly tenantLimitPerMinute: number;\r\n  /** Default user rate limit within tenant: requests per minute */\r\n  private readonly userLimitPerMinute: number;\r\n  /** Window duration in milliseconds (1 minute) */\r\n  private readonly windowMs = 60 * 1000;\r\n\r\n  constructor(\r\n    private readonly redisService: RedisService,\r\n    private readonly configService: ConfigService\r\n  ) {\r\n    this.tenantLimitPerMinute = this.configService.get<number>(\r\n      'RATE_LIMIT_TENANT_PER_MINUTE',\r\n      60\r\n    );\r\n    this.userLimitPerMinute = this.configService.get<number>(\r\n      'RATE_LIMIT_USER_PER_MINUTE',\r\n      20\r\n    );\r\n\r\n    this.logger.log({\r\n      message: 'Rate limiter initialized',\r\n      tenantLimitPerMinute: this.tenantLimitPerMinute,\r\n      userLimitPerMinute: this.userLimitPerMinute,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if a request should be allowed based on tenant rate limits.\r\n   *\r\n   * @param tenantId - The tenant identifier (e.g., 'tnt_123')\r\n   * @returns Rate limit result with allowed status and limit info\r\n   */\r\n  async checkTenantLimit(tenantId: string): Promise<RateLimitResult> {\r\n    return this.checkLimit(`tenant:${tenantId}`, this.tenantLimitPerMinute);\r\n  }\r\n\r\n  /**\r\n   * Checks if a request should be allowed based on user rate limits within a tenant.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param userId - The user identifier (e.g., 'usr_123')\r\n   * @returns Rate limit result with allowed status and limit info\r\n   */\r\n  async checkUserLimit(\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<RateLimitResult> {\r\n    return this.checkLimit(\r\n      `user:${tenantId}:${userId}`,\r\n      this.userLimitPerMinute\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Checks both tenant and user rate limits.\r\n   * Returns the most restrictive result.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param userId - The user identifier\r\n   * @returns The most restrictive rate limit result\r\n   */\r\n  async checkLimits(\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<RateLimitResult & { limitType: 'tenant' | 'user' }> {\r\n    const [tenantResult, userResult] = await Promise.all([\r\n      this.checkTenantLimit(tenantId),\r\n      this.checkUserLimit(tenantId, userId),\r\n    ]);\r\n\r\n    // If either limit is exceeded, return that result\r\n    if (!tenantResult.allowed) {\r\n      this.logger.warn({\r\n        message: 'Tenant rate limit exceeded',\r\n        tenantId,\r\n        limit: tenantResult.limit,\r\n        remaining: tenantResult.remaining,\r\n      });\r\n      return { ...tenantResult, limitType: 'tenant' };\r\n    }\r\n\r\n    if (!userResult.allowed) {\r\n      this.logger.warn({\r\n        message: 'User rate limit exceeded',\r\n        tenantId,\r\n        userId,\r\n        limit: userResult.limit,\r\n        remaining: userResult.remaining,\r\n      });\r\n      return { ...userResult, limitType: 'user' };\r\n    }\r\n\r\n    // Return user result as it's typically more restrictive\r\n    return { ...userResult, limitType: 'user' };\r\n  }\r\n\r\n  /**\r\n   * Generates rate limit headers for HTTP responses.\r\n   *\r\n   * @param result - The rate limit result\r\n   * @returns Headers object ready to be set on the response\r\n   */\r\n  getHeaders(result: RateLimitResult): RateLimitHeaders {\r\n    const headers: RateLimitHeaders = {\r\n      'X-RateLimit-Limit': String(result.limit),\r\n      'X-RateLimit-Remaining': String(Math.max(0, result.remaining)),\r\n      'X-RateLimit-Reset': String(result.reset),\r\n    };\r\n\r\n    if (result.retryAfter !== undefined) {\r\n      headers['Retry-After'] = String(result.retryAfter);\r\n    }\r\n\r\n    return headers;\r\n  }\r\n\r\n  /**\r\n   * Internal method to check rate limit using Redis.\r\n   */\r\n  private async checkLimit(\r\n    identifier: string,\r\n    limit: number\r\n  ): Promise<RateLimitResult> {\r\n    // If Redis is not configured, allow all requests\r\n    if (!this.redisService.isConfigured()) {\r\n      this.logger.debug({\r\n        message: 'Rate limiting disabled - Redis not configured',\r\n        identifier,\r\n      });\r\n      return {\r\n        allowed: true,\r\n        limit,\r\n        remaining: limit,\r\n        reset: Math.floor(Date.now() / 1000) + 60,\r\n      };\r\n    }\r\n\r\n    const rateLimiter = this.redisService.getRateLimiter(\r\n      identifier,\r\n      limit,\r\n      this.windowMs\r\n    );\r\n\r\n    if (!rateLimiter) {\r\n      return {\r\n        allowed: true,\r\n        limit,\r\n        remaining: limit,\r\n        reset: Math.floor(Date.now() / 1000) + 60,\r\n      };\r\n    }\r\n\r\n    const result = await rateLimiter.limit(identifier);\r\n\r\n    const response: RateLimitResult = {\r\n      allowed: result.success,\r\n      limit: result.limit,\r\n      remaining: result.remaining,\r\n      reset: Math.floor(result.reset / 1000), // Convert to Unix timestamp\r\n    };\r\n\r\n    if (!result.success) {\r\n      // Calculate retry-after in seconds\r\n      response.retryAfter = Math.ceil((result.reset - Date.now()) / 1000);\r\n    }\r\n\r\n    this.logger.debug({\r\n      message: 'Rate limit check',\r\n      identifier,\r\n      allowed: response.allowed,\r\n      remaining: response.remaining,\r\n      limit: response.limit,\r\n    });\r\n\r\n    return response;\r\n  }\r\n}\r\n","import { Injectable, Logger, OnModuleDestroy } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Redis } from '@upstash/redis';\r\nimport { Ratelimit } from '@upstash/ratelimit';\r\n\r\n/**\r\n * Service for managing Redis connections and rate limiters using Upstash.\r\n * Provides a centralized Redis client and factory methods for rate limiters.\r\n */\r\n@Injectable()\r\nexport class RedisService implements OnModuleDestroy {\r\n  private readonly logger = new Logger(RedisService.name);\r\n  private readonly redis: Redis;\r\n  private readonly rateLimiters: Map<string, Ratelimit> = new Map();\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    const url = this.configService.get<string>('UPSTASH_REDIS_REST_URL');\r\n    const token = this.configService.get<string>('UPSTASH_REDIS_REST_TOKEN');\r\n\r\n    if (!url || !token) {\r\n      this.logger.warn({\r\n        message: 'Upstash Redis not configured - rate limiting will be disabled',\r\n      });\r\n      // Create a null Redis instance that will fail gracefully\r\n      this.redis = null as unknown as Redis;\r\n      return;\r\n    }\r\n\r\n    this.redis = new Redis({\r\n      url,\r\n      token,\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Redis client initialized',\r\n      url: url.replace(/\\/\\/.*@/, '//***@'), // Mask credentials in logs\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if Redis is configured and available.\r\n   * @returns True if Redis is configured, false otherwise\r\n   */\r\n  isConfigured(): boolean {\r\n    return this.redis !== null;\r\n  }\r\n\r\n  /**\r\n   * Gets the underlying Redis client for direct operations.\r\n   * @returns The Upstash Redis client instance\r\n   */\r\n  getClient(): Redis {\r\n    return this.redis;\r\n  }\r\n\r\n  /**\r\n   * Creates or retrieves a cached rate limiter for the given identifier.\r\n   * Uses a sliding window algorithm for smooth rate limiting.\r\n   *\r\n   * @param identifier - Unique identifier for this rate limiter (e.g., 'tenant:tnt_123')\r\n   * @param limit - Maximum number of requests allowed in the window\r\n   * @param windowMs - Window duration in milliseconds\r\n   * @returns A configured Ratelimit instance\r\n   */\r\n  getRateLimiter(\r\n    identifier: string,\r\n    limit: number,\r\n    windowMs: number\r\n  ): Ratelimit | null {\r\n    if (!this.isConfigured()) {\r\n      return null;\r\n    }\r\n\r\n    const cacheKey = `${identifier}:${limit}:${windowMs}`;\r\n\r\n    if (this.rateLimiters.has(cacheKey)) {\r\n      return this.rateLimiters.get(cacheKey)!;\r\n    }\r\n\r\n    // Convert milliseconds to seconds for the window\r\n    const windowSec = Math.ceil(windowMs / 1000);\r\n\r\n    const rateLimiter = new Ratelimit({\r\n      redis: this.redis,\r\n      limiter: Ratelimit.slidingWindow(limit, `${windowSec} s`),\r\n      prefix: `ratelimit:${identifier}`,\r\n      analytics: true,\r\n    });\r\n\r\n    this.rateLimiters.set(cacheKey, rateLimiter);\r\n\r\n    this.logger.debug({\r\n      message: 'Rate limiter created',\r\n      identifier,\r\n      limit,\r\n      windowMs,\r\n    });\r\n\r\n    return rateLimiter;\r\n  }\r\n\r\n  /**\r\n   * Increments a counter in Redis with optional expiration.\r\n   * Useful for tracking usage over time periods.\r\n   *\r\n   * @param key - The Redis key to increment\r\n   * @param expireMs - Optional expiration time in milliseconds\r\n   * @returns The new value after incrementing\r\n   */\r\n  async increment(key: string, expireMs?: number): Promise<number> {\r\n    if (!this.isConfigured()) {\r\n      return 0;\r\n    }\r\n\r\n    const newValue = await this.redis.incr(key);\r\n\r\n    if (expireMs && newValue === 1) {\r\n      // Set expiration only on first increment\r\n      await this.redis.pexpire(key, expireMs);\r\n    }\r\n\r\n    return newValue;\r\n  }\r\n\r\n  /**\r\n   * Gets a value from Redis.\r\n   *\r\n   * @param key - The Redis key to retrieve\r\n   * @returns The value or null if not found\r\n   */\r\n  async get<T>(key: string): Promise<T | null> {\r\n    if (!this.isConfigured()) {\r\n      return null;\r\n    }\r\n\r\n    return this.redis.get<T>(key);\r\n  }\r\n\r\n  /**\r\n   * Sets a value in Redis with optional expiration.\r\n   *\r\n   * @param key - The Redis key\r\n   * @param value - The value to store\r\n   * @param expireMs - Optional expiration time in milliseconds\r\n   */\r\n  async set<T>(key: string, value: T, expireMs?: number): Promise<void> {\r\n    if (!this.isConfigured()) {\r\n      return;\r\n    }\r\n\r\n    if (expireMs) {\r\n      await this.redis.set(key, value, { px: expireMs });\r\n    } else {\r\n      await this.redis.set(key, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deletes a key from Redis.\r\n   *\r\n   * @param key - The Redis key to delete\r\n   */\r\n  async delete(key: string): Promise<void> {\r\n    if (!this.isConfigured()) {\r\n      return;\r\n    }\r\n\r\n    await this.redis.del(key);\r\n  }\r\n\r\n  /**\r\n   * Cleanup on module destroy.\r\n   */\r\n  async onModuleDestroy(): Promise<void> {\r\n    this.rateLimiters.clear();\r\n    this.logger.log({ message: 'Redis service cleaned up' });\r\n  }\r\n}\r\n","module.exports = require(\"@upstash/redis\");","module.exports = require(\"@upstash/ratelimit\");","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { TokenTrackerService } from './token-tracker.service';\r\nimport { QuotaStatus } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Alias for QuotaStatus for backward compatibility.\r\n * @deprecated Use QuotaStatus from @mentor-ai/shared/types directly.\r\n */\r\nexport type QuotaCheckResult = QuotaStatus;\r\n\r\n/**\r\n * Service for enforcing token quotas on AI usage.\r\n * Prevents tenants from exceeding their allocated token limits.\r\n */\r\n@Injectable()\r\nexport class QuotaService {\r\n  private readonly logger = new Logger(QuotaService.name);\r\n  private readonly defaultQuota: number;\r\n\r\n  constructor(\r\n    private readonly prismaService: PlatformPrismaService,\r\n    private readonly tokenTrackerService: TokenTrackerService,\r\n    private readonly configService: ConfigService\r\n  ) {\r\n    this.defaultQuota = this.configService.get<number>('DEFAULT_TENANT_TOKEN_QUOTA', 10000000);\r\n\r\n    this.logger.log({\r\n      message: 'Quota service initialized',\r\n      defaultQuota: this.defaultQuota,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if a tenant has remaining token quota.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @returns Quota check result with allowed status and remaining tokens\r\n   */\r\n  async checkQuota(tenantId: string): Promise<QuotaCheckResult> {\r\n    // Get tenant's quota limit\r\n    const tenant = await this.prismaService.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { tokenQuota: true },\r\n    });\r\n\r\n    if (!tenant) {\r\n      this.logger.warn({\r\n        message: 'Tenant not found for quota check, using default quota',\r\n        tenantId,\r\n        defaultQuota: this.defaultQuota,\r\n      });\r\n    }\r\n\r\n    const limit = tenant?.tokenQuota ?? this.defaultQuota;\r\n\r\n    // Get current month's usage\r\n    const used = await this.tokenTrackerService.getMonthlyTokenCount(tenantId);\r\n\r\n    const remaining = Math.max(0, limit - used);\r\n    const allowed = remaining > 0;\r\n    const percentUsed = Math.min(100, Math.round((used / limit) * 100));\r\n\r\n    const result: QuotaCheckResult = {\r\n      allowed,\r\n      remaining,\r\n      limit,\r\n      used,\r\n      percentUsed,\r\n    };\r\n\r\n    if (!allowed) {\r\n      this.logger.warn({\r\n        message: 'Quota exceeded',\r\n        tenantId,\r\n        limit,\r\n        used,\r\n      });\r\n    } else if (percentUsed >= 80) {\r\n      this.logger.log({\r\n        message: 'Quota nearing limit',\r\n        tenantId,\r\n        limit,\r\n        used,\r\n        percentUsed,\r\n      });\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Estimates if a request with given token count would exceed quota.\r\n   * Use this for pre-flight checks before sending to LLM.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param estimatedTokens - Estimated tokens the request will use\r\n   * @returns Quota check result considering the estimated usage\r\n   */\r\n  async checkQuotaWithEstimate(\r\n    tenantId: string,\r\n    estimatedTokens: number\r\n  ): Promise<QuotaCheckResult> {\r\n    const quotaStatus = await this.checkQuota(tenantId);\r\n\r\n    // Check if estimated usage would exceed remaining quota\r\n    const wouldExceed = estimatedTokens > quotaStatus.remaining;\r\n\r\n    return {\r\n      ...quotaStatus,\r\n      allowed: quotaStatus.allowed && !wouldExceed,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets the quota limit for a tenant.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @returns The token quota limit\r\n   */\r\n  async getQuotaLimit(tenantId: string): Promise<number> {\r\n    const tenant = await this.prismaService.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { tokenQuota: true },\r\n    });\r\n\r\n    return tenant?.tokenQuota ?? this.defaultQuota;\r\n  }\r\n\r\n  /**\r\n   * Updates the quota limit for a tenant.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param newQuota - The new quota limit\r\n   */\r\n  async updateQuota(tenantId: string, newQuota: number): Promise<void> {\r\n    await this.prismaService.tenant.update({\r\n      where: { id: tenantId },\r\n      data: { tokenQuota: newQuota },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Quota updated',\r\n      tenantId,\r\n      newQuota,\r\n    });\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { Decimal } from '@prisma/client/runtime/library';\r\nimport type { TokenUsage } from '@prisma/client';\r\nimport { UsageSummary, UsagePeriod } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Internal token usage record with Date type for service operations.\r\n * Uses Date instead of string (shared TokenUsage) because Prisma returns Date objects.\r\n * Shared TokenUsage uses string for JSON serialization in API responses.\r\n */\r\nexport interface TokenUsageRecord {\r\n  id: string;\r\n  tenantId: string;\r\n  userId: string;\r\n  conversationId?: string;\r\n  inputTokens: number;\r\n  outputTokens: number;\r\n  totalTokens: number;\r\n  cost: number;\r\n  modelId: string;\r\n  providerId?: string;\r\n  createdAt: Date;\r\n}\r\n\r\n// Re-export shared types for consumers\r\nexport type { UsageSummary, UsagePeriod };\r\n\r\n/**\r\n * Service for tracking AI token consumption and costs.\r\n * Records all AI requests for billing and quota enforcement.\r\n */\r\n@Injectable()\r\nexport class TokenTrackerService {\r\n  private readonly logger = new Logger(TokenTrackerService.name);\r\n\r\n  constructor(private readonly prismaService: PlatformPrismaService) {}\r\n\r\n  /**\r\n   * Records token usage for an AI request.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param userId - The user identifier\r\n   * @param inputTokens - Number of input tokens used\r\n   * @param outputTokens - Number of output tokens generated\r\n   * @param cost - Cost of the request in USD\r\n   * @param modelId - The model used for the request\r\n   * @param conversationId - Optional conversation ID\r\n   * @param providerId - Optional provider ID\r\n   * @returns The created token usage record\r\n   */\r\n  async trackUsage(\r\n    tenantId: string,\r\n    userId: string,\r\n    inputTokens: number,\r\n    outputTokens: number,\r\n    cost: number,\r\n    modelId: string,\r\n    conversationId?: string,\r\n    providerId?: string\r\n  ): Promise<TokenUsageRecord> {\r\n    const id = `tku_${createId()}`;\r\n    const totalTokens = inputTokens + outputTokens;\r\n\r\n    const record = await this.prismaService.tokenUsage.create({\r\n      data: {\r\n        id,\r\n        tenantId,\r\n        userId,\r\n        conversationId,\r\n        inputTokens,\r\n        outputTokens,\r\n        totalTokens,\r\n        cost: new Decimal(cost),\r\n        modelId,\r\n        providerId,\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Token usage tracked',\r\n      id,\r\n      tenantId,\r\n      userId,\r\n      totalTokens,\r\n      cost,\r\n      modelId,\r\n    });\r\n\r\n    return {\r\n      id: record.id,\r\n      tenantId: record.tenantId,\r\n      userId: record.userId,\r\n      conversationId: record.conversationId ?? undefined,\r\n      inputTokens: record.inputTokens,\r\n      outputTokens: record.outputTokens,\r\n      totalTokens: record.totalTokens,\r\n      cost: record.cost.toNumber(),\r\n      modelId: record.modelId,\r\n      providerId: record.providerId ?? undefined,\r\n      createdAt: record.createdAt,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets aggregated usage for a tenant over a time period.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param period - Time period to query ('day', 'week', 'month', 'all')\r\n   * @returns Aggregated usage summary\r\n   */\r\n  async getUsage(tenantId: string, period: UsagePeriod): Promise<UsageSummary> {\r\n    const startDate = this.getStartDate(period);\r\n\r\n    const result = await this.prismaService.tokenUsage.aggregate({\r\n      where: {\r\n        tenantId,\r\n        ...(startDate && { createdAt: { gte: startDate } }),\r\n      },\r\n      _sum: {\r\n        inputTokens: true,\r\n        outputTokens: true,\r\n        totalTokens: true,\r\n        cost: true,\r\n      },\r\n      _count: true,\r\n    });\r\n\r\n    return {\r\n      inputTokens: result._sum.inputTokens ?? 0,\r\n      outputTokens: result._sum.outputTokens ?? 0,\r\n      totalTokens: result._sum.totalTokens ?? 0,\r\n      totalCost: result._sum.cost?.toNumber() ?? 0,\r\n      requestCount: result._count,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets aggregated usage for a specific user within a tenant.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param userId - The user identifier\r\n   * @param period - Time period to query\r\n   * @returns Aggregated usage summary for the user\r\n   */\r\n  async getUserUsage(\r\n    tenantId: string,\r\n    userId: string,\r\n    period: UsagePeriod\r\n  ): Promise<UsageSummary> {\r\n    const startDate = this.getStartDate(period);\r\n\r\n    const result = await this.prismaService.tokenUsage.aggregate({\r\n      where: {\r\n        tenantId,\r\n        userId,\r\n        ...(startDate && { createdAt: { gte: startDate } }),\r\n      },\r\n      _sum: {\r\n        inputTokens: true,\r\n        outputTokens: true,\r\n        totalTokens: true,\r\n        cost: true,\r\n      },\r\n      _count: true,\r\n    });\r\n\r\n    return {\r\n      inputTokens: result._sum.inputTokens ?? 0,\r\n      outputTokens: result._sum.outputTokens ?? 0,\r\n      totalTokens: result._sum.totalTokens ?? 0,\r\n      totalCost: result._sum.cost?.toNumber() ?? 0,\r\n      requestCount: result._count,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets the total token count for a tenant in the current billing period (month).\r\n   * Used for quota enforcement.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @returns Total tokens used this month\r\n   */\r\n  async getMonthlyTokenCount(tenantId: string): Promise<number> {\r\n    const usage = await this.getUsage(tenantId, 'month');\r\n    return usage.totalTokens;\r\n  }\r\n\r\n  /**\r\n   * Gets usage records for a specific conversation.\r\n   *\r\n   * @param conversationId - The conversation identifier\r\n   * @returns Array of token usage records\r\n   */\r\n  async getConversationUsage(\r\n    conversationId: string\r\n  ): Promise<TokenUsageRecord[]> {\r\n    const records = await this.prismaService.tokenUsage.findMany({\r\n      where: { conversationId },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n\r\n    return records.map((record: TokenUsage) => ({\r\n      id: record.id,\r\n      tenantId: record.tenantId,\r\n      userId: record.userId,\r\n      conversationId: record.conversationId ?? undefined,\r\n      inputTokens: record.inputTokens,\r\n      outputTokens: record.outputTokens,\r\n      totalTokens: record.totalTokens,\r\n      cost: record.cost.toNumber(),\r\n      modelId: record.modelId,\r\n      providerId: record.providerId ?? undefined,\r\n      createdAt: record.createdAt,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Calculates the start date for a usage period.\r\n   */\r\n  private getStartDate(period: UsagePeriod): Date | null {\r\n    const now = new Date();\r\n\r\n    switch (period) {\r\n      case 'day':\r\n        return new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n      case 'week':\r\n        const weekAgo = new Date(now);\r\n        weekAgo.setDate(weekAgo.getDate() - 7);\r\n        return weekAgo;\r\n      case 'month':\r\n        return new Date(now.getFullYear(), now.getMonth(), 1);\r\n      case 'all':\r\n        return null;\r\n    }\r\n  }\r\n}\r\n","module.exports = require(\"@prisma/client/runtime/library\");","import { Injectable, Logger } from '@nestjs/common';\r\nimport { RedisService } from './redis.service';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport {\r\n  CircuitBreakerState,\r\n  CircuitBreakerStatus,\r\n  CircuitBreakerEvent,\r\n} from '@mentor-ai/shared/types';\r\n\r\n// Re-export shared types for backward compatibility\r\nexport { CircuitBreakerState, CircuitBreakerStatus, CircuitBreakerEvent };\r\n\r\n/**\r\n * Service for implementing circuit breaker pattern for LLM providers.\r\n * Prevents cascading failures by temporarily blocking requests to failing providers.\r\n *\r\n * State transitions:\r\n * - CLOSED  OPEN: After failureThreshold consecutive failures\r\n * - OPEN  HALF_OPEN: After recoveryTimeout (30 seconds)\r\n * - HALF_OPEN  CLOSED: On first success\r\n * - HALF_OPEN  OPEN: On failure\r\n */\r\n@Injectable()\r\nexport class CircuitBreakerService {\r\n  private readonly logger = new Logger(CircuitBreakerService.name);\r\n\r\n  /** Number of consecutive failures before opening circuit */\r\n  private readonly failureThreshold = 5;\r\n  /** Time in ms before attempting recovery (30 seconds) */\r\n  private readonly recoveryTimeoutMs = 30 * 1000;\r\n  /** TTL for circuit breaker state in Redis (1 hour) */\r\n  private readonly stateTtlMs = 60 * 60 * 1000;\r\n\r\n  /** In-memory fallback for when Redis is unavailable */\r\n  private readonly localState: Map<string, CircuitBreakerStatus> = new Map();\r\n\r\n  /** Event listeners for state changes */\r\n  private readonly eventListeners: ((event: CircuitBreakerEvent) => void)[] =\r\n    [];\r\n\r\n  constructor(private readonly redisService: RedisService) {}\r\n\r\n  /**\r\n   * Checks if requests should be allowed through the circuit.\r\n   *\r\n   * @param providerId - The LLM provider identifier\r\n   * @returns True if the circuit is closed or half-open (allow request)\r\n   */\r\n  async isAllowed(providerId: string): Promise<boolean> {\r\n    const status = await this.getStatus(providerId);\r\n\r\n    switch (status.state) {\r\n      case CircuitBreakerState.CLOSED:\r\n        return true;\r\n\r\n      case CircuitBreakerState.OPEN:\r\n        // Check if recovery timeout has passed\r\n        if (\r\n          status.openedAt &&\r\n          Date.now() - status.openedAt >= this.recoveryTimeoutMs\r\n        ) {\r\n          await this.transitionTo(\r\n            providerId,\r\n            CircuitBreakerState.HALF_OPEN,\r\n            status\r\n          );\r\n          return true;\r\n        }\r\n        return false;\r\n\r\n      case CircuitBreakerState.HALF_OPEN:\r\n        // Only allow one test request at a time\r\n        // In a distributed system, this should use a lock\r\n        return true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Records a successful request.\r\n   * Resets failure count and closes circuit if half-open.\r\n   *\r\n   * @param providerId - The LLM provider identifier\r\n   * @param correlationId - Optional correlation ID for tracing\r\n   */\r\n  async recordSuccess(\r\n    providerId: string,\r\n    correlationId?: string\r\n  ): Promise<void> {\r\n    const status = await this.getStatus(providerId);\r\n\r\n    const newStatus: CircuitBreakerStatus = {\r\n      state: CircuitBreakerState.CLOSED,\r\n      failures: 0,\r\n      lastSuccess: Date.now(),\r\n    };\r\n\r\n    if (status.state !== CircuitBreakerState.CLOSED) {\r\n      this.emitEvent(providerId, status.state, newStatus.state, 0, correlationId);\r\n    }\r\n\r\n    await this.saveStatus(providerId, newStatus);\r\n\r\n    this.logger.debug({\r\n      message: 'Circuit breaker success recorded',\r\n      providerId,\r\n      correlationId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Records a failed request.\r\n   * Increments failure count and may open circuit.\r\n   *\r\n   * @param providerId - The LLM provider identifier\r\n   * @param correlationId - Optional correlation ID for tracing\r\n   */\r\n  async recordFailure(\r\n    providerId: string,\r\n    correlationId?: string\r\n  ): Promise<void> {\r\n    const status = await this.getStatus(providerId);\r\n    const newFailures = status.failures + 1;\r\n\r\n    let newState = status.state;\r\n    let openedAt = status.openedAt;\r\n\r\n    // Determine new state based on current state and failures\r\n    switch (status.state) {\r\n      case CircuitBreakerState.CLOSED:\r\n        if (newFailures >= this.failureThreshold) {\r\n          newState = CircuitBreakerState.OPEN;\r\n          openedAt = Date.now();\r\n          this.logger.warn({\r\n            message: 'Circuit breaker opened',\r\n            providerId,\r\n            failures: newFailures,\r\n            correlationId,\r\n          });\r\n        }\r\n        break;\r\n\r\n      case CircuitBreakerState.HALF_OPEN:\r\n        // Test request failed, reopen circuit\r\n        newState = CircuitBreakerState.OPEN;\r\n        openedAt = Date.now();\r\n        this.logger.warn({\r\n          message: 'Circuit breaker reopened from half-open',\r\n          providerId,\r\n          correlationId,\r\n        });\r\n        break;\r\n\r\n      case CircuitBreakerState.OPEN:\r\n        // Already open, just update failure time\r\n        break;\r\n    }\r\n\r\n    const newStatus: CircuitBreakerStatus = {\r\n      state: newState,\r\n      failures: newFailures,\r\n      lastFailure: Date.now(),\r\n      lastSuccess: status.lastSuccess,\r\n      openedAt,\r\n    };\r\n\r\n    if (status.state !== newState) {\r\n      this.emitEvent(\r\n        providerId,\r\n        status.state,\r\n        newState,\r\n        newFailures,\r\n        correlationId\r\n      );\r\n    }\r\n\r\n    await this.saveStatus(providerId, newStatus);\r\n  }\r\n\r\n  /**\r\n   * Gets the current status of a circuit breaker.\r\n   *\r\n   * @param providerId - The LLM provider identifier\r\n   * @returns Current circuit breaker status\r\n   */\r\n  async getStatus(providerId: string): Promise<CircuitBreakerStatus> {\r\n    const key = this.getKey(providerId);\r\n\r\n    if (this.redisService.isConfigured()) {\r\n      const cached = await this.redisService.get<CircuitBreakerStatus>(key);\r\n      if (cached) {\r\n        return cached;\r\n      }\r\n    }\r\n\r\n    // Check local state\r\n    const local = this.localState.get(providerId);\r\n    if (local) {\r\n      return local;\r\n    }\r\n\r\n    // Default to closed\r\n    return {\r\n      state: CircuitBreakerState.CLOSED,\r\n      failures: 0,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Manually resets a circuit breaker to closed state.\r\n   *\r\n   * @param providerId - The LLM provider identifier\r\n   */\r\n  async reset(providerId: string): Promise<void> {\r\n    const status = await this.getStatus(providerId);\r\n\r\n    const newStatus: CircuitBreakerStatus = {\r\n      state: CircuitBreakerState.CLOSED,\r\n      failures: 0,\r\n      lastSuccess: Date.now(),\r\n    };\r\n\r\n    if (status.state !== CircuitBreakerState.CLOSED) {\r\n      this.emitEvent(\r\n        providerId,\r\n        status.state,\r\n        CircuitBreakerState.CLOSED,\r\n        0\r\n      );\r\n    }\r\n\r\n    await this.saveStatus(providerId, newStatus);\r\n\r\n    this.logger.log({\r\n      message: 'Circuit breaker manually reset',\r\n      providerId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Registers a listener for circuit breaker state change events.\r\n   *\r\n   * @param listener - Callback function for events\r\n   */\r\n  onStateChange(listener: (event: CircuitBreakerEvent) => void): void {\r\n    this.eventListeners.push(listener);\r\n  }\r\n\r\n  /**\r\n   * Transitions to a new state.\r\n   */\r\n  private async transitionTo(\r\n    providerId: string,\r\n    newState: CircuitBreakerState,\r\n    currentStatus: CircuitBreakerStatus,\r\n    correlationId?: string\r\n  ): Promise<void> {\r\n    const newStatus: CircuitBreakerStatus = {\r\n      ...currentStatus,\r\n      state: newState,\r\n    };\r\n\r\n    if (newState === CircuitBreakerState.HALF_OPEN) {\r\n      this.logger.log({\r\n        message: 'Circuit breaker entering half-open state',\r\n        providerId,\r\n        correlationId,\r\n      });\r\n    }\r\n\r\n    this.emitEvent(\r\n      providerId,\r\n      currentStatus.state,\r\n      newState,\r\n      currentStatus.failures,\r\n      correlationId\r\n    );\r\n\r\n    await this.saveStatus(providerId, newStatus);\r\n  }\r\n\r\n  /**\r\n   * Saves the circuit breaker status.\r\n   */\r\n  private async saveStatus(\r\n    providerId: string,\r\n    status: CircuitBreakerStatus\r\n  ): Promise<void> {\r\n    // Always update local state\r\n    this.localState.set(providerId, status);\r\n\r\n    // Persist to Redis if available\r\n    if (this.redisService.isConfigured()) {\r\n      const key = this.getKey(providerId);\r\n      await this.redisService.set(key, status, this.stateTtlMs);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emits a state change event.\r\n   */\r\n  private emitEvent(\r\n    providerId: string,\r\n    previousState: CircuitBreakerState,\r\n    newState: CircuitBreakerState,\r\n    failures: number,\r\n    correlationId?: string\r\n  ): void {\r\n    const event: CircuitBreakerEvent = {\r\n      eventId: `cb_${createId()}`,\r\n      providerId,\r\n      previousState,\r\n      newState,\r\n      failures,\r\n      timestamp: Date.now(),\r\n      correlationId,\r\n    };\r\n\r\n    this.logger.log({\r\n      message: 'Circuit breaker state changed',\r\n      eventId: event.eventId,\r\n      providerId,\r\n      previousState,\r\n      newState,\r\n      failures,\r\n      correlationId,\r\n    });\r\n\r\n    for (const listener of this.eventListeners) {\r\n      try {\r\n        listener(event);\r\n      } catch (error) {\r\n        this.logger.error({\r\n          message: 'Error in circuit breaker event listener',\r\n          error: error instanceof Error ? error.message : 'Unknown error',\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generates the Redis key for a provider's circuit breaker state.\r\n   */\r\n  private getKey(providerId: string): string {\r\n    return `circuit:${providerId}`;\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ModelPricing, CostCalculation } from '@mentor-ai/shared/types';\r\n\r\n// Re-export shared types for backward compatibility\r\nexport type { ModelPricing, CostCalculation };\r\n\r\n/**\r\n * Default pricing for unknown models (conservative estimate).\r\n */\r\nconst DEFAULT_PRICING: ModelPricing = {\r\n  input: 0.002, // $0.002 per 1K tokens\r\n  output: 0.004, // $0.004 per 1K tokens\r\n};\r\n\r\n/**\r\n * Known model pricing (per 1000 tokens in USD).\r\n * Updated periodically based on provider pricing pages.\r\n */\r\nconst MODEL_PRICING: Record<string, ModelPricing> = {\r\n  // OpenRouter models\r\n  'openrouter/auto': { input: 0.001, output: 0.002 },\r\n\r\n  // Meta Llama models\r\n  'meta-llama/llama-3.1-70b-instruct': { input: 0.0008, output: 0.0008 },\r\n  'meta-llama/llama-3.1-8b-instruct': { input: 0.0001, output: 0.0001 },\r\n  'meta-llama/llama-3-70b-instruct': { input: 0.0008, output: 0.0008 },\r\n  'meta-llama/llama-3-8b-instruct': { input: 0.0001, output: 0.0001 },\r\n\r\n  // Anthropic Claude models\r\n  'anthropic/claude-3.5-sonnet': { input: 0.003, output: 0.015 },\r\n  'anthropic/claude-3.5-sonnet-20240620': { input: 0.003, output: 0.015 },\r\n  'anthropic/claude-3-opus': { input: 0.015, output: 0.075 },\r\n  'anthropic/claude-3-sonnet': { input: 0.003, output: 0.015 },\r\n  'anthropic/claude-3-haiku': { input: 0.00025, output: 0.00125 },\r\n\r\n  // OpenAI models\r\n  'openai/gpt-4-turbo': { input: 0.01, output: 0.03 },\r\n  'openai/gpt-4': { input: 0.03, output: 0.06 },\r\n  'openai/gpt-4o': { input: 0.005, output: 0.015 },\r\n  'openai/gpt-4o-mini': { input: 0.00015, output: 0.0006 },\r\n  'openai/gpt-3.5-turbo': { input: 0.0005, output: 0.0015 },\r\n\r\n  // Mistral models\r\n  'mistralai/mistral-large': { input: 0.004, output: 0.012 },\r\n  'mistralai/mistral-medium': { input: 0.0027, output: 0.0081 },\r\n  'mistralai/mistral-small': { input: 0.001, output: 0.003 },\r\n  'mistralai/mixtral-8x7b-instruct': { input: 0.0006, output: 0.0006 },\r\n  'mistralai/mistral-7b-instruct': { input: 0.0002, output: 0.0002 },\r\n\r\n  // Google models\r\n  'google/gemini-pro': { input: 0.00025, output: 0.0005 },\r\n  'google/gemini-pro-1.5': { input: 0.00125, output: 0.005 },\r\n\r\n  // Local models (free)\r\n  'local/llama': { input: 0, output: 0 },\r\n  'local/mistral': { input: 0, output: 0 },\r\n  'ollama/llama3': { input: 0, output: 0 },\r\n  'ollama/mistral': { input: 0, output: 0 },\r\n};\r\n\r\n/**\r\n * Service for calculating AI request costs based on token usage.\r\n * Provides accurate cost tracking for billing and quota management.\r\n */\r\n@Injectable()\r\nexport class CostCalculatorService {\r\n  private readonly logger = new Logger(CostCalculatorService.name);\r\n\r\n  constructor() {\r\n    this.logger.log({\r\n      message: 'Cost calculator initialized',\r\n      knownModels: Object.keys(MODEL_PRICING).length,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Calculates the cost for a request based on token usage.\r\n   *\r\n   * @param modelId - The model identifier\r\n   * @param inputTokens - Number of input tokens\r\n   * @param outputTokens - Number of output tokens\r\n   * @returns Cost calculation breakdown\r\n   */\r\n  calculateCost(\r\n    modelId: string,\r\n    inputTokens: number,\r\n    outputTokens: number\r\n  ): CostCalculation {\r\n    const pricing = this.getPricing(modelId);\r\n    const pricingFound = MODEL_PRICING[modelId] !== undefined;\r\n\r\n    // Calculate costs (pricing is per 1000 tokens)\r\n    const inputCost = (inputTokens / 1000) * pricing.input;\r\n    const outputCost = (outputTokens / 1000) * pricing.output;\r\n    const totalCost = inputCost + outputCost;\r\n\r\n    // Round to 6 decimal places for precision\r\n    return {\r\n      inputCost: Number(inputCost.toFixed(6)),\r\n      outputCost: Number(outputCost.toFixed(6)),\r\n      totalCost: Number(totalCost.toFixed(6)),\r\n      modelId,\r\n      pricingFound,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets the pricing for a model.\r\n   *\r\n   * @param modelId - The model identifier\r\n   * @returns Pricing structure for the model\r\n   */\r\n  getPricing(modelId: string): ModelPricing {\r\n    // Exact match\r\n    if (MODEL_PRICING[modelId]) {\r\n      return MODEL_PRICING[modelId];\r\n    }\r\n\r\n    // Try to find a partial match (e.g., 'gpt-4' matches 'gpt-4-turbo')\r\n    const normalizedId = modelId.toLowerCase();\r\n    for (const [key, pricing] of Object.entries(MODEL_PRICING)) {\r\n      if (normalizedId.includes(key.toLowerCase().replace(/^[^/]+\\//, ''))) {\r\n        return pricing;\r\n      }\r\n    }\r\n\r\n    // Check for local/free models\r\n    if (\r\n      normalizedId.includes('local') ||\r\n      normalizedId.includes('ollama') ||\r\n      normalizedId.startsWith('llama:')\r\n    ) {\r\n      return { input: 0, output: 0 };\r\n    }\r\n\r\n    this.logger.warn({\r\n      message: 'Unknown model pricing, using default',\r\n      modelId,\r\n      defaultPricing: DEFAULT_PRICING,\r\n    });\r\n\r\n    return DEFAULT_PRICING;\r\n  }\r\n\r\n  /**\r\n   * Estimates the cost for a request before sending to the LLM.\r\n   * Uses average output token count for estimation.\r\n   *\r\n   * @param modelId - The model identifier\r\n   * @param inputTokens - Number of input tokens\r\n   * @param estimatedOutputRatio - Ratio of output to input tokens (default 1.5)\r\n   * @returns Estimated cost\r\n   */\r\n  estimateCost(\r\n    modelId: string,\r\n    inputTokens: number,\r\n    estimatedOutputRatio = 1.5\r\n  ): number {\r\n    const estimatedOutput = Math.ceil(inputTokens * estimatedOutputRatio);\r\n    const calculation = this.calculateCost(modelId, inputTokens, estimatedOutput);\r\n    return calculation.totalCost;\r\n  }\r\n\r\n  /**\r\n   * Checks if a model is a local/free model.\r\n   *\r\n   * @param modelId - The model identifier\r\n   * @returns True if the model is free (local deployment)\r\n   */\r\n  isLocalModel(modelId: string): boolean {\r\n    const pricing = this.getPricing(modelId);\r\n    return pricing.input === 0 && pricing.output === 0;\r\n  }\r\n\r\n  /**\r\n   * Adds or updates pricing for a model.\r\n   * Useful for adding custom pricing at runtime.\r\n   *\r\n   * @param modelId - The model identifier\r\n   * @param pricing - The pricing structure\r\n   */\r\n  addPricing(modelId: string, pricing: ModelPricing): void {\r\n    MODEL_PRICING[modelId] = pricing;\r\n\r\n    this.logger.log({\r\n      message: 'Model pricing added',\r\n      modelId,\r\n      pricing,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets all known model pricing.\r\n   *\r\n   * @returns Map of model IDs to their pricing\r\n   */\r\n  getAllPricing(): Record<string, ModelPricing> {\r\n    return { ...MODEL_PRICING };\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { RedisService } from './redis.service';\r\nimport { UserRole } from '@prisma/client';\r\nimport { createId } from '@paralleldrive/cuid2';\r\n\r\n/**\r\n * Priority levels for request queuing.\r\n * Higher number = higher priority.\r\n */\r\nexport const PRIORITY_MAP: Record<UserRole, number> = {\r\n  [UserRole.TENANT_OWNER]: 3,\r\n  [UserRole.ADMIN]: 2,\r\n  [UserRole.MEMBER]: 1,\r\n};\r\n\r\n/**\r\n * Queued request information.\r\n */\r\nexport interface QueuedRequest {\r\n  id: string;\r\n  tenantId: string;\r\n  userId: string;\r\n  priority: number;\r\n  timestamp: number;\r\n  conversationId?: string;\r\n}\r\n\r\n/**\r\n * Queue position information for WebSocket events.\r\n */\r\nexport interface QueuePosition {\r\n  position: number;\r\n  estimatedWait: number; // seconds\r\n  requestId: string;\r\n}\r\n\r\n/**\r\n * Service for managing AI request queues with priority.\r\n * Implements a Redis-based priority queue for handling concurrent requests.\r\n */\r\n@Injectable()\r\nexport class RequestQueueService {\r\n  private readonly logger = new Logger(RequestQueueService.name);\r\n\r\n  /** Queue timeout in milliseconds (2 minutes) */\r\n  private readonly queueTimeoutMs = 2 * 60 * 1000;\r\n  /** Average processing time per request in seconds */\r\n  private readonly avgProcessingTimeSec = 5;\r\n\r\n  constructor(private readonly redisService: RedisService) {}\r\n\r\n  /**\r\n   * Adds a request to the queue with priority based on user role.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @param userId - The user identifier\r\n   * @param userRole - The user's role for priority calculation\r\n   * @param conversationId - Optional conversation ID\r\n   * @returns The queued request information\r\n   */\r\n  async enqueue(\r\n    tenantId: string,\r\n    userId: string,\r\n    userRole: UserRole,\r\n    conversationId?: string\r\n  ): Promise<QueuedRequest> {\r\n    const request: QueuedRequest = {\r\n      id: `req_${createId()}`,\r\n      tenantId,\r\n      userId,\r\n      priority: PRIORITY_MAP[userRole] ?? 1,\r\n      timestamp: Date.now(),\r\n      conversationId,\r\n    };\r\n\r\n    if (!this.redisService.isConfigured()) {\r\n      this.logger.debug({\r\n        message: 'Queue disabled - Redis not configured',\r\n        requestId: request.id,\r\n      });\r\n      return request;\r\n    }\r\n\r\n    const queueKey = this.getQueueKey(tenantId);\r\n\r\n    // Add to sorted set with priority-timestamp score\r\n    // Higher priority items have lower scores for ZRANGEBYSCORE\r\n    const score = this.calculateScore(request.priority, request.timestamp);\r\n\r\n    await this.redisService.getClient().zadd(queueKey, {\r\n      score,\r\n      member: JSON.stringify(request),\r\n    });\r\n\r\n    // Set queue TTL to cleanup stale queues\r\n    await this.redisService.getClient().expire(queueKey, 3600); // 1 hour\r\n\r\n    this.logger.log({\r\n      message: 'Request enqueued',\r\n      requestId: request.id,\r\n      tenantId,\r\n      userId,\r\n      priority: request.priority,\r\n    });\r\n\r\n    return request;\r\n  }\r\n\r\n  /**\r\n   * Removes a request from the queue after processing.\r\n   *\r\n   * @param request - The request to dequeue\r\n   */\r\n  async dequeue(request: QueuedRequest): Promise<void> {\r\n    if (!this.redisService.isConfigured()) {\r\n      return;\r\n    }\r\n\r\n    const queueKey = this.getQueueKey(request.tenantId);\r\n    await this.redisService\r\n      .getClient()\r\n      .zrem(queueKey, JSON.stringify(request));\r\n\r\n    this.logger.debug({\r\n      message: 'Request dequeued',\r\n      requestId: request.id,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets the queue position for a request.\r\n   *\r\n   * @param request - The queued request\r\n   * @returns Queue position information\r\n   */\r\n  async getPosition(request: QueuedRequest): Promise<QueuePosition> {\r\n    if (!this.redisService.isConfigured()) {\r\n      return {\r\n        position: 0,\r\n        estimatedWait: 0,\r\n        requestId: request.id,\r\n      };\r\n    }\r\n\r\n    const queueKey = this.getQueueKey(request.tenantId);\r\n    const score = this.calculateScore(request.priority, request.timestamp);\r\n\r\n    // Count how many requests are ahead (lower score = higher priority)\r\n    const position = await this.redisService\r\n      .getClient()\r\n      .zcount(queueKey, '-inf', score - 1);\r\n\r\n    return {\r\n      position: position + 1, // 1-indexed\r\n      estimatedWait: position * this.avgProcessingTimeSec,\r\n      requestId: request.id,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Checks if a request has timed out in the queue.\r\n   *\r\n   * @param request - The queued request\r\n   * @returns True if the request has exceeded queue timeout\r\n   */\r\n  isTimedOut(request: QueuedRequest): boolean {\r\n    return Date.now() - request.timestamp > this.queueTimeoutMs;\r\n  }\r\n\r\n  /**\r\n   * Gets the next request to process from the queue (highest priority).\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @returns The next request or null if queue is empty\r\n   */\r\n  async getNext(tenantId: string): Promise<QueuedRequest | null> {\r\n    if (!this.redisService.isConfigured()) {\r\n      return null;\r\n    }\r\n\r\n    const queueKey = this.getQueueKey(tenantId);\r\n\r\n    // Get the lowest score (highest priority) item\r\n    const result = await this.redisService\r\n      .getClient()\r\n      .zrange(queueKey, 0, 0);\r\n\r\n    if (!result || result.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      return JSON.parse(result[0] as string) as QueuedRequest;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the current queue length for a tenant.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @returns Number of requests in queue\r\n   */\r\n  async getQueueLength(tenantId: string): Promise<number> {\r\n    if (!this.redisService.isConfigured()) {\r\n      return 0;\r\n    }\r\n\r\n    const queueKey = this.getQueueKey(tenantId);\r\n    return this.redisService.getClient().zcard(queueKey);\r\n  }\r\n\r\n  /**\r\n   * Cleans up expired requests from the queue.\r\n   *\r\n   * @param tenantId - The tenant identifier\r\n   * @returns Number of expired requests removed\r\n   */\r\n  async cleanupExpired(tenantId: string): Promise<number> {\r\n    if (!this.redisService.isConfigured()) {\r\n      return 0;\r\n    }\r\n\r\n    const queueKey = this.getQueueKey(tenantId);\r\n    const cutoffTime = Date.now() - this.queueTimeoutMs;\r\n\r\n    // Get all items and filter expired ones\r\n    const allItems = await this.redisService\r\n      .getClient()\r\n      .zrange(queueKey, 0, -1);\r\n\r\n    let removedCount = 0;\r\n\r\n    for (const item of allItems) {\r\n      try {\r\n        const request = JSON.parse(item as string) as QueuedRequest;\r\n        if (request.timestamp < cutoffTime) {\r\n          await this.redisService\r\n            .getClient()\r\n            .zrem(queueKey, item as string);\r\n          removedCount++;\r\n        }\r\n      } catch {\r\n        // Skip malformed items\r\n      }\r\n    }\r\n\r\n    if (removedCount > 0) {\r\n      this.logger.log({\r\n        message: 'Expired requests cleaned up',\r\n        tenantId,\r\n        removedCount,\r\n      });\r\n    }\r\n\r\n    return removedCount;\r\n  }\r\n\r\n  /**\r\n   * Generates the Redis key for a tenant's queue.\r\n   */\r\n  private getQueueKey(tenantId: string): string {\r\n    return `queue:${tenantId}`;\r\n  }\r\n\r\n  /**\r\n   * Calculates the score for sorting.\r\n   * Lower score = higher priority.\r\n   * Within same priority, earlier timestamp = lower score (FIFO).\r\n   */\r\n  private calculateScore(priority: number, timestamp: number): number {\r\n    // Invert priority (higher priority = lower score)\r\n    // Add timestamp to maintain FIFO within same priority\r\n    return (4 - priority) * 1e15 + timestamp;\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport {\r\n  ConfidenceScore,\r\n  ConfidenceLevel,\r\n  ConfidenceFactor,\r\n  ImprovementSuggestion,\r\n  type PersonaType,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Context for generating improvement suggestions.\r\n */\r\nexport interface SuggestionContext {\r\n  /** Persona type for persona-specific suggestions */\r\n  personaType?: PersonaType;\r\n  /** Whether client context was provided */\r\n  hasClientContext: boolean;\r\n  /** Whether specific data was provided */\r\n  hasSpecificData: boolean;\r\n  /** Previous confidence score for improvement delta */\r\n  previousScore?: number;\r\n}\r\n\r\n/**\r\n * Result of improvement suggestion generation.\r\n */\r\nexport interface ImprovementResult {\r\n  /** Primary suggestion to display */\r\n  primarySuggestion: string | null;\r\n  /** All applicable suggestions with priorities */\r\n  suggestions: ImprovementSuggestion[];\r\n  /** Improvement delta message if applicable */\r\n  improvementDelta: string | null;\r\n  /** Previous score for reference */\r\n  previousScore?: number;\r\n  /** Current score for reference */\r\n  currentScore: number;\r\n}\r\n\r\n/**\r\n * Mapping of confidence factors to improvement suggestions.\r\n */\r\nconst FACTOR_SUGGESTIONS: Record<string, ImprovementSuggestion[]> = {\r\n  hedging_language: [\r\n    {\r\n      category: 'ambiguous_question',\r\n      suggestion: 'Try asking a more specific question to get a clearer answer.',\r\n      priority: 2,\r\n    },\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Provide more details about your specific situation for targeted guidance.',\r\n      priority: 3,\r\n    },\r\n  ],\r\n  context_depth: [\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Share more background about your business or project.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Provide relevant data points like revenue, costs, or timelines.',\r\n      priority: 1,\r\n    },\r\n  ],\r\n  response_specificity: [\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Include specific numbers (budget, revenue, headcount) for more precise recommendations.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Describe your goals or constraints to get tailored advice.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n};\r\n\r\n/**\r\n * Persona-specific improvement suggestions.\r\n */\r\nconst PERSONA_SUGGESTIONS: Record<string, ImprovementSuggestion[]> = {\r\n  CFO: [\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Provide your Q2 financial data (revenue, costs, margins) for more accurate analysis.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Share your budget constraints or financial goals.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n  CMO: [\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Include your marketing budget or campaign performance metrics.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Describe your target audience or market segment.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n  CTO: [\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Describe your current tech stack or infrastructure constraints.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Provide metrics like response times, uptime, or user load.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n  OPERATIONS: [\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Share your current operational metrics or KPIs.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Describe your process or workflow constraints.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n  LEGAL: [\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Specify your jurisdiction or industry for relevant compliance guidance.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Provide details about the contract or agreement in question.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n  CREATIVE: [\r\n    {\r\n      category: 'missing_context',\r\n      suggestion: 'Describe your brand voice or creative direction.',\r\n      priority: 1,\r\n    },\r\n    {\r\n      category: 'data_gap',\r\n      suggestion: 'Share examples of creative work you admire or want to emulate.',\r\n      priority: 2,\r\n    },\r\n  ],\r\n};\r\n\r\n/**\r\n * Service for generating improvement suggestions based on confidence scores.\r\n * Provides actionable feedback to users on how to improve AI response quality.\r\n */\r\n@Injectable()\r\nexport class ImprovementSuggestionsService {\r\n  private readonly logger = new Logger(ImprovementSuggestionsService.name);\r\n\r\n  /**\r\n   * Generates improvement suggestions based on confidence score and context.\r\n   *\r\n   * @param confidence - The calculated confidence score\r\n   * @param context - Context for generating suggestions\r\n   * @returns Improvement result with suggestions and delta message\r\n   */\r\n  generateSuggestions(\r\n    confidence: ConfidenceScore,\r\n    context: SuggestionContext\r\n  ): ImprovementResult {\r\n    const suggestions: ImprovementSuggestion[] = [];\r\n\r\n    // Only generate suggestions for non-high confidence\r\n    if (confidence.level === ConfidenceLevel.HIGH) {\r\n      return {\r\n        primarySuggestion: null,\r\n        suggestions: [],\r\n        improvementDelta: this.calculateDelta(context.previousScore, confidence.score),\r\n        previousScore: context.previousScore,\r\n        currentScore: confidence.score,\r\n      };\r\n    }\r\n\r\n    // Get factor-based suggestions\r\n    for (const factor of confidence.factors) {\r\n      if (factor.score < 0.7) {\r\n        const factorSuggestions = this.getSuggestionsForFactor(factor, context);\r\n        suggestions.push(...factorSuggestions);\r\n      }\r\n    }\r\n\r\n    // Add persona-specific suggestions if applicable\r\n    if (context.personaType && confidence.level === ConfidenceLevel.LOW) {\r\n      const personaSuggestions = PERSONA_SUGGESTIONS[context.personaType] ?? [];\r\n      for (const suggestion of personaSuggestions) {\r\n        if (!suggestions.some((s) => s.category === suggestion.category)) {\r\n          suggestions.push(suggestion);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Sort by priority and deduplicate\r\n    const uniqueSuggestions = this.deduplicateSuggestions(suggestions);\r\n    uniqueSuggestions.sort((a, b) => a.priority - b.priority);\r\n\r\n    // Get primary suggestion (highest priority)\r\n    const primarySuggestion = uniqueSuggestions[0]?.suggestion ?? null;\r\n\r\n    // Calculate improvement delta if previous score exists\r\n    const improvementDelta = this.calculateDelta(context.previousScore, confidence.score);\r\n\r\n    this.logger.log({\r\n      message: 'Improvement suggestions generated',\r\n      confidenceLevel: confidence.level,\r\n      suggestionCount: uniqueSuggestions.length,\r\n      hasPrimarySuggestion: !!primarySuggestion,\r\n      hasImprovementDelta: !!improvementDelta,\r\n    });\r\n\r\n    return {\r\n      primarySuggestion,\r\n      suggestions: uniqueSuggestions,\r\n      improvementDelta,\r\n      previousScore: context.previousScore,\r\n      currentScore: confidence.score,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generates the improvement suggestion string for the confidence score.\r\n   *\r\n   * @param confidence - The calculated confidence score\r\n   * @param context - Context for generating suggestions\r\n   * @returns Improvement suggestion string or null\r\n   */\r\n  getImprovementSuggestion(\r\n    confidence: ConfidenceScore,\r\n    context: SuggestionContext\r\n  ): string | null {\r\n    const result = this.generateSuggestions(confidence, context);\r\n    return result.primarySuggestion;\r\n  }\r\n\r\n  /**\r\n   * Calculates the improvement delta message between two scores.\r\n   *\r\n   * @param previousScore - Previous confidence score (0.0-1.0)\r\n   * @param currentScore - Current confidence score (0.0-1.0)\r\n   * @returns Delta message or null if no previous score\r\n   */\r\n  calculateDelta(previousScore: number | undefined, currentScore: number): string | null {\r\n    if (previousScore === undefined) {\r\n      return null;\r\n    }\r\n\r\n    const previousPercent = Math.round(previousScore * 100);\r\n    const currentPercent = Math.round(currentScore * 100);\r\n    const delta = currentPercent - previousPercent;\r\n\r\n    if (delta > 0) {\r\n      return `Your input improved confidence from ${previousPercent}% to ${currentPercent}%`;\r\n    } else if (delta < 0) {\r\n      return `Confidence changed from ${previousPercent}% to ${currentPercent}%`;\r\n    }\r\n\r\n    return null; // No change\r\n  }\r\n\r\n  /**\r\n   * Gets suggestions for a specific confidence factor.\r\n   */\r\n  private getSuggestionsForFactor(\r\n    factor: ConfidenceFactor,\r\n    context: SuggestionContext\r\n  ): ImprovementSuggestion[] {\r\n    const baseSuggestions = FACTOR_SUGGESTIONS[factor.name] ?? [];\r\n    const suggestions: ImprovementSuggestion[] = [];\r\n\r\n    for (const suggestion of baseSuggestions) {\r\n      // Adjust priority based on factor score\r\n      const adjustedPriority = factor.score < 0.5 ? suggestion.priority : suggestion.priority + 1;\r\n\r\n      // Skip context-related suggestions if context already provided\r\n      if (suggestion.category === 'missing_context' && context.hasClientContext) {\r\n        continue;\r\n      }\r\n\r\n      // Skip data-related suggestions if data already provided\r\n      if (suggestion.category === 'data_gap' && context.hasSpecificData) {\r\n        continue;\r\n      }\r\n\r\n      suggestions.push({\r\n        ...suggestion,\r\n        priority: adjustedPriority,\r\n      });\r\n    }\r\n\r\n    return suggestions;\r\n  }\r\n\r\n  /**\r\n   * Deduplicates suggestions by category, keeping highest priority.\r\n   */\r\n  private deduplicateSuggestions(\r\n    suggestions: ImprovementSuggestion[]\r\n  ): ImprovementSuggestion[] {\r\n    const byCategory = new Map<string, ImprovementSuggestion>();\r\n\r\n    for (const suggestion of suggestions) {\r\n      const existing = byCategory.get(suggestion.category);\r\n      if (!existing || suggestion.priority < existing.priority) {\r\n        byCategory.set(suggestion.category, suggestion);\r\n      }\r\n    }\r\n\r\n    return Array.from(byCategory.values());\r\n  }\r\n}\r\n","import { Controller, Get, Param, Query, Logger, NotFoundException } from '@nestjs/common';\r\nimport { ConceptService } from './services/concept.service';\r\nimport { CitationService } from './services/citation.service';\r\nimport { CurriculumService } from './services/curriculum.service';\r\nimport type {\r\n  ConceptCategory,\r\n  CurriculumNode,\r\n  ConceptsListResponse,\r\n  ConceptResponse,\r\n  ConceptRelationsResponse,\r\n  MessageCitationsResponse,\r\n  ConceptCitationSummary,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Controller for business concepts knowledge base endpoints.\r\n * Provides read-only access to the platform's concept library.\r\n */\r\n@Controller('v1/knowledge')\r\nexport class KnowledgeController {\r\n  private readonly logger = new Logger(KnowledgeController.name);\r\n\r\n  constructor(\r\n    private readonly conceptService: ConceptService,\r\n    private readonly citationService: CitationService,\r\n    private readonly curriculumService: CurriculumService\r\n  ) {}\r\n\r\n  /**\r\n   * Lists concepts with optional filtering and pagination.\r\n   *\r\n   * @param category - Filter by category (Finance, Marketing, etc.)\r\n   * @param search - Search query for name/definition\r\n   * @param page - Page number (1-indexed, default 1)\r\n   * @param limit - Items per page (default 20, max 100)\r\n   */\r\n  @Get('concepts')\r\n  async listConcepts(\r\n    @Query('category') category?: ConceptCategory,\r\n    @Query('search') search?: string,\r\n    @Query('page') page?: string,\r\n    @Query('limit') limit?: string\r\n  ): Promise<ConceptsListResponse> {\r\n    this.logger.log({\r\n      message: 'Listing concepts',\r\n      category,\r\n      search,\r\n      page,\r\n      limit,\r\n    });\r\n\r\n    const result = await this.conceptService.findAll({\r\n      category,\r\n      search,\r\n      page: page ? parseInt(page, 10) : undefined,\r\n      limit: limit ? parseInt(limit, 10) : undefined,\r\n    });\r\n\r\n    return {\r\n      data: result.data,\r\n      meta: result.meta,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets a single concept by ID with all related concepts.\r\n   *\r\n   * @param id - Concept ID (cpt_ prefix)\r\n   */\r\n  @Get('concepts/:id')\r\n  async getConcept(@Param('id') id: string): Promise<ConceptResponse> {\r\n    this.logger.log({\r\n      message: 'Getting concept',\r\n      id,\r\n    });\r\n\r\n    const concept = await this.conceptService.findById(id);\r\n\r\n    return {\r\n      data: concept,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets a concept by its name (case-insensitive).\r\n   * Used for citation name  conceptId lookup.\r\n   */\r\n  @Get('concepts/by-name/:name')\r\n  async getConceptByName(\r\n    @Param('name') name: string\r\n  ): Promise<{ data: { id: string; name: string } }> {\r\n    const concept = await this.conceptService.findByName(decodeURIComponent(name));\r\n    if (!concept) {\r\n      throw new NotFoundException({\r\n        type: 'concept_not_found',\r\n        title: 'Concept Not Found',\r\n        status: 404,\r\n        detail: `Concept with name \"${name}\" does not exist`,\r\n      });\r\n    }\r\n    return { data: concept };\r\n  }\r\n\r\n  /**\r\n   * Gets a concept by its URL-friendly slug.\r\n   *\r\n   * @param slug - URL-friendly concept slug\r\n   */\r\n  @Get('concepts/by-slug/:slug')\r\n  async getConceptBySlug(@Param('slug') slug: string): Promise<ConceptResponse> {\r\n    this.logger.log({\r\n      message: 'Getting concept by slug',\r\n      slug,\r\n    });\r\n\r\n    const concept = await this.conceptService.findBySlug(slug);\r\n\r\n    return {\r\n      data: concept,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets related concepts for a given concept ID.\r\n   *\r\n   * @param id - Concept ID\r\n   */\r\n  @Get('concepts/:id/related')\r\n  async getRelatedConcepts(\r\n    @Param('id') id: string\r\n  ): Promise<ConceptRelationsResponse> {\r\n    this.logger.log({\r\n      message: 'Getting related concepts',\r\n      id,\r\n    });\r\n\r\n    const relations = await this.conceptService.findRelated(id);\r\n\r\n    return {\r\n      data: relations,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets all concept categories with counts.\r\n   */\r\n  @Get('categories')\r\n  async getCategories(): Promise<{\r\n    data: Array<{ category: string; count: number }>;\r\n  }> {\r\n    this.logger.log({ message: 'Getting categories' });\r\n\r\n    const categories = await this.conceptService.getCategories();\r\n\r\n    return {\r\n      data: categories,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets knowledge base statistics.\r\n   */\r\n  @Get('stats')\r\n  async getStats(): Promise<{\r\n    data: { totalConcepts: number; categories: Array<{ category: string; count: number }> };\r\n  }> {\r\n    this.logger.log({ message: 'Getting knowledge base stats' });\r\n\r\n    const [totalConcepts, categories] = await Promise.all([\r\n      this.conceptService.getCount(),\r\n      this.conceptService.getCategories(),\r\n    ]);\r\n\r\n    return {\r\n      data: {\r\n        totalConcepts,\r\n        categories,\r\n      },\r\n    };\r\n  }\r\n\r\n  //  Curriculum Endpoints \r\n\r\n  /**\r\n   * Returns the full curriculum tree as a flat array of nodes.\r\n   */\r\n  @Get('curriculum')\r\n  getCurriculum(): { data: CurriculumNode[] } {\r\n    this.logger.log({ message: 'Getting full curriculum' });\r\n    return { data: this.curriculumService.getFullTree() };\r\n  }\r\n\r\n  /**\r\n   * Searches curriculum labels by substring match.\r\n   * @param q - Search query string\r\n   */\r\n  @Get('curriculum/search')\r\n  searchCurriculum(\r\n    @Query('q') q?: string\r\n  ): { data: CurriculumNode[] } {\r\n    this.logger.log({ message: 'Searching curriculum', query: q });\r\n    if (!q || q.length < 1) {\r\n      return { data: this.curriculumService.getTopLevelNodes() };\r\n    }\r\n    return { data: this.curriculumService.searchCurriculum(q) };\r\n  }\r\n\r\n  //  Citation Endpoints (Story 2.6) \r\n\r\n  /**\r\n   * Gets citations for a specific message.\r\n   * Returns all concept citations associated with the message.\r\n   *\r\n   * @param messageId - The message ID (msg_ prefix)\r\n   */\r\n  @Get('messages/:messageId/citations')\r\n  async getMessageCitations(\r\n    @Param('messageId') messageId: string\r\n  ): Promise<MessageCitationsResponse> {\r\n    this.logger.log({\r\n      message: 'Getting citations for message',\r\n      messageId,\r\n    });\r\n\r\n    const citations = await this.citationService.getCitationsForMessage(messageId);\r\n\r\n    return {\r\n      data: citations,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets a concept summary suitable for the citation side panel.\r\n   * Returns concept details with related concepts for exploration.\r\n   *\r\n   * @param conceptId - The concept ID (cpt_ prefix)\r\n   */\r\n  @Get('concepts/:conceptId/summary')\r\n  async getConceptSummary(\r\n    @Param('conceptId') conceptId: string\r\n  ): Promise<{ data: ConceptCitationSummary }> {\r\n    this.logger.log({\r\n      message: 'Getting concept summary for panel',\r\n      conceptId,\r\n    });\r\n\r\n    const summary = await this.citationService.getConceptSummaryForPanel(conceptId);\r\n\r\n    if (!summary) {\r\n      throw new NotFoundException({\r\n        type: 'concept_not_found',\r\n        title: 'Concept Not Found',\r\n        status: 404,\r\n        detail: `Concept with ID ${conceptId} does not exist`,\r\n      });\r\n    }\r\n\r\n    return {\r\n      data: summary,\r\n    };\r\n  }\r\n}\r\n","import { Injectable, Logger, NotFoundException } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { AiGatewayService } from '../../ai-gateway/ai-gateway.service';\r\nimport type {\r\n  Concept,\r\n  ConceptSummary,\r\n  ConceptWithRelations,\r\n  ConceptCategory,\r\n  RelationshipType,\r\n  DynamicRelationshipResult,\r\n  PaginationMeta,\r\n  ChatMessage,\r\n} from '@mentor-ai/shared/types';\r\nimport {\r\n  getRelevantCategories,\r\n  buildRelationshipClassificationPrompt,\r\n} from '../templates/relationship-prompt';\r\nimport type { RelationshipSuggestion } from '../templates/relationship-prompt';\r\n\r\n/**\r\n * Query options for listing concepts.\r\n */\r\nexport interface ConceptQueryOptions {\r\n  /** Filter by category */\r\n  category?: ConceptCategory;\r\n  /** Search query for name/definition */\r\n  search?: string;\r\n  /** Page number (1-indexed) */\r\n  page?: number;\r\n  /** Items per page */\r\n  limit?: number;\r\n}\r\n\r\n/**\r\n * Service for querying and managing business concepts.\r\n * Provides read-only access to the platform's knowledge base.\r\n */\r\n@Injectable()\r\nexport class ConceptService {\r\n  private readonly logger = new Logger(ConceptService.name);\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly aiGateway: AiGatewayService\r\n  ) {}\r\n\r\n  /**\r\n   * Finds concepts with optional filtering and pagination.\r\n   *\r\n   * @param options - Query options for filtering and pagination\r\n   * @returns Paginated list of concept summaries\r\n   */\r\n  async findAll(\r\n    options: ConceptQueryOptions = {}\r\n  ): Promise<{ data: ConceptSummary[]; meta: PaginationMeta }> {\r\n    const page = options.page ?? 1;\r\n    const limit = Math.min(options.limit ?? 20, 100);\r\n    const skip = (page - 1) * limit;\r\n\r\n    const where: Record<string, unknown> = {};\r\n\r\n    if (options.category) {\r\n      where.category = options.category;\r\n    }\r\n\r\n    if (options.search) {\r\n      where.OR = [\r\n        { name: { contains: options.search, mode: 'insensitive' } },\r\n        { definition: { contains: options.search, mode: 'insensitive' } },\r\n      ];\r\n    }\r\n\r\n    const [concepts, total] = await Promise.all([\r\n      this.prisma.concept.findMany({\r\n        where,\r\n        select: {\r\n          id: true,\r\n          name: true,\r\n          slug: true,\r\n          category: true,\r\n          definition: true,\r\n        },\r\n        orderBy: { name: 'asc' },\r\n        skip,\r\n        take: limit,\r\n      }),\r\n      this.prisma.concept.count({ where }),\r\n    ]);\r\n\r\n    this.logger.debug({\r\n      message: 'Concepts query executed',\r\n      category: options.category,\r\n      search: options.search,\r\n      page,\r\n      limit,\r\n      resultCount: concepts.length,\r\n      total,\r\n    });\r\n\r\n    return {\r\n      data: concepts.map((c) => ({\r\n        id: c.id,\r\n        name: c.name,\r\n        slug: c.slug,\r\n        category: c.category as ConceptCategory,\r\n        definition: c.definition,\r\n      })),\r\n      meta: {\r\n        page,\r\n        limit,\r\n        total,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Finds a single concept by ID with all related concepts.\r\n   *\r\n   * @param id - Concept ID (cpt_ prefix)\r\n   * @returns Full concept with relationships\r\n   * @throws NotFoundException if concept doesn't exist\r\n   */\r\n  async findById(id: string): Promise<ConceptWithRelations> {\r\n    const concept = await this.prisma.concept.findUnique({\r\n      where: { id },\r\n      include: {\r\n        relatedTo: {\r\n          include: {\r\n            targetConcept: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                slug: true,\r\n                category: true,\r\n                definition: true,\r\n                extendedDescription: true,\r\n                departmentTags: true,\r\n                embeddingId: true,\r\n                version: true,\r\n                createdAt: true,\r\n                updatedAt: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n        relatedFrom: {\r\n          include: {\r\n            sourceConcept: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                slug: true,\r\n                category: true,\r\n                definition: true,\r\n                extendedDescription: true,\r\n                departmentTags: true,\r\n                embeddingId: true,\r\n                version: true,\r\n                createdAt: true,\r\n                updatedAt: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!concept) {\r\n      throw new NotFoundException({\r\n        type: 'concept_not_found',\r\n        title: 'Concept Not Found',\r\n        status: 404,\r\n        detail: `Concept with ID ${id} does not exist`,\r\n      });\r\n    }\r\n\r\n    this.logger.debug({\r\n      message: 'Concept found',\r\n      id: concept.id,\r\n      name: concept.name,\r\n      relatedToCount: concept.relatedTo.length,\r\n      relatedFromCount: concept.relatedFrom.length,\r\n    });\r\n\r\n    // Combine relationships from both directions\r\n    const relatedConcepts: ConceptWithRelations['relatedConcepts'] = [\r\n      ...concept.relatedTo.map((rel) => ({\r\n        concept: this.mapToConcept(rel.targetConcept),\r\n        relationshipType: rel.relationshipType as RelationshipType,\r\n        direction: 'outgoing' as const,\r\n      })),\r\n      ...concept.relatedFrom.map((rel) => ({\r\n        concept: this.mapToConcept(rel.sourceConcept),\r\n        relationshipType: rel.relationshipType as RelationshipType,\r\n        direction: 'incoming' as const,\r\n      })),\r\n    ];\r\n\r\n    return {\r\n      id: concept.id,\r\n      name: concept.name,\r\n      slug: concept.slug,\r\n      category: concept.category as ConceptCategory,\r\n      definition: concept.definition,\r\n      extendedDescription: concept.extendedDescription ?? undefined,\r\n      departmentTags: concept.departmentTags,\r\n      embeddingId: concept.embeddingId ?? undefined,\r\n      version: concept.version,\r\n      createdAt: concept.createdAt.toISOString(),\r\n      updatedAt: concept.updatedAt.toISOString(),\r\n      relatedConcepts,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Finds a single concept by slug.\r\n   *\r\n   * @param slug - URL-friendly concept slug\r\n   * @returns Full concept with relationships\r\n   * @throws NotFoundException if concept doesn't exist\r\n   */\r\n  async findBySlug(slug: string): Promise<ConceptWithRelations> {\r\n    const concept = await this.prisma.concept.findUnique({\r\n      where: { slug },\r\n    });\r\n\r\n    if (!concept) {\r\n      throw new NotFoundException({\r\n        type: 'concept_not_found',\r\n        title: 'Concept Not Found',\r\n        status: 404,\r\n        detail: `Concept with slug ${slug} does not exist`,\r\n      });\r\n    }\r\n\r\n    return this.findById(concept.id);\r\n  }\r\n\r\n  /**\r\n   * Finds related concepts for a given concept ID.\r\n   *\r\n   * @param id - Concept ID\r\n   * @returns List of related concepts with relationship type and direction\r\n   */\r\n  async findRelated(id: string): Promise<\r\n    Array<{\r\n      concept: ConceptSummary;\r\n      relationshipType: RelationshipType;\r\n      direction: 'outgoing' | 'incoming';\r\n    }>\r\n  > {\r\n    const concept = await this.findById(id);\r\n\r\n    return concept.relatedConcepts.map((rel) => ({\r\n      concept: {\r\n        id: rel.concept.id,\r\n        name: rel.concept.name,\r\n        slug: rel.concept.slug,\r\n        category: rel.concept.category,\r\n        definition: rel.concept.definition,\r\n      },\r\n      relationshipType: rel.relationshipType,\r\n      direction: rel.direction,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Gets all unique categories in the database.\r\n   *\r\n   * @returns List of categories with concept counts\r\n   */\r\n  async getCategories(): Promise<Array<{ category: string; count: number }>> {\r\n    const result = await this.prisma.concept.groupBy({\r\n      by: ['category'],\r\n      _count: { id: true },\r\n      orderBy: { category: 'asc' },\r\n    });\r\n\r\n    return result.map((r) => ({\r\n      category: r.category,\r\n      count: r._count.id,\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Gets total count of concepts in the database.\r\n   */\r\n  async getCount(): Promise<number> {\r\n    return this.prisma.concept.count();\r\n  }\r\n\r\n  /**\r\n   * Finds a concept by name (case-insensitive).\r\n   * Used for citation name  conceptId lookup.\r\n   */\r\n  async findByName(name: string): Promise<{ id: string; name: string } | null> {\r\n    const concept = await this.prisma.concept.findFirst({\r\n      where: { name: { equals: name, mode: 'insensitive' } },\r\n      select: { id: true, name: true },\r\n    });\r\n    return concept;\r\n  }\r\n\r\n  /**\r\n   * Batch lookup of concepts by IDs.\r\n   * Used by ConversationService to resolve concept details for tree display.\r\n   */\r\n  async findByIds(\r\n    ids: string[]\r\n  ): Promise<\r\n    Map<\r\n      string,\r\n      {\r\n        id: string;\r\n        name: string;\r\n        slug: string;\r\n        category: string;\r\n        categorySortOrder: number;\r\n        sortOrder: number;\r\n        curriculumId: string | null;\r\n      }\r\n    >\r\n  > {\r\n    if (ids.length === 0) return new Map();\r\n\r\n    const concepts = await this.prisma.concept.findMany({\r\n      where: { id: { in: ids } },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        slug: true,\r\n        category: true,\r\n        categorySortOrder: true,\r\n        sortOrder: true,\r\n        curriculumId: true,\r\n      },\r\n    });\r\n\r\n    return new Map(concepts.map((c) => [c.id, c]));\r\n  }\r\n\r\n  /**\r\n   * Creates dynamic relationships between a newly discovered concept\r\n   * and existing concepts using AI classification.\r\n   * Non-blocking  errors are logged but never thrown to callers.\r\n   *\r\n   * Story 2.13: Dynamic Concept Relationship Creation\r\n   */\r\n  async createDynamicRelationships(\r\n    conceptId: string,\r\n    conceptName?: string,\r\n    category?: string\r\n  ): Promise<DynamicRelationshipResult> {\r\n    const result: DynamicRelationshipResult = {\r\n      conceptId,\r\n      conceptName: conceptName ?? conceptId,\r\n      relationshipsCreated: 0,\r\n      errors: [],\r\n    };\r\n\r\n    try {\r\n      // 1. Load the concept's name, definition, and category\r\n      const concept = await this.prisma.concept.findUnique({\r\n        where: { id: conceptId },\r\n        select: { name: true, definition: true, slug: true, category: true },\r\n      });\r\n\r\n      if (!concept) {\r\n        result.errors.push(`Concept ${conceptId} not found`);\r\n        return result;\r\n      }\r\n\r\n      // Resolve name and category from DB if not provided\r\n      const resolvedName = conceptName ?? concept.name;\r\n      result.conceptName = resolvedName;\r\n      const resolvedCategory = category ?? concept.category;\r\n\r\n      // 2. Query candidate concepts filtered by relevant categories\r\n      const relevantCategories = getRelevantCategories(resolvedCategory);\r\n      const candidates = await this.prisma.concept.findMany({\r\n        where: {\r\n          id: { not: conceptId },\r\n          category: { in: relevantCategories },\r\n        },\r\n        select: {\r\n          id: true,\r\n          slug: true,\r\n          name: true,\r\n          category: true,\r\n          definition: true,\r\n        },\r\n        orderBy: { name: 'asc' },\r\n        take: 20,\r\n      });\r\n\r\n      if (candidates.length === 0) {\r\n        this.logger.debug({\r\n          message: 'No candidate concepts for relationship creation',\r\n          conceptName: resolvedName,\r\n          category: resolvedCategory,\r\n        });\r\n        return result;\r\n      }\r\n\r\n      // 3. Build LLM prompt and call AI for classification\r\n      const prompt = buildRelationshipClassificationPrompt(\r\n        resolvedName,\r\n        resolvedCategory,\r\n        concept.definition,\r\n        candidates\r\n      );\r\n\r\n      const messages: ChatMessage[] = [{ role: 'user', content: prompt }];\r\n\r\n      let fullResponse = '';\r\n      await this.aiGateway.streamCompletion(messages, (chunk) => {\r\n        fullResponse += chunk;\r\n      });\r\n\r\n      // 4. Parse LLM response into relationship suggestions\r\n      const suggestions = this.parseRelationshipSuggestions(fullResponse, candidates);\r\n\r\n      if (suggestions.length === 0) {\r\n        this.logger.debug({\r\n          message: 'No relationships suggested by AI',\r\n          conceptName: resolvedName,\r\n        });\r\n        return result;\r\n      }\r\n\r\n      // 5. Map slugs to concept IDs and batch-create relationships\r\n      const slugToId = new Map(candidates.map((c) => [c.slug, c.id]));\r\n      const relationshipData = suggestions\r\n        .filter((s) => slugToId.has(s.slug))\r\n        .map((s) => ({\r\n          sourceConceptId: conceptId,\r\n          targetConceptId: slugToId.get(s.slug)!,\r\n          relationshipType: s.type,\r\n        }));\r\n\r\n      if (relationshipData.length > 0) {\r\n        const created = await this.prisma.conceptRelationship.createMany({\r\n          data: relationshipData,\r\n          skipDuplicates: true,\r\n        });\r\n        result.relationshipsCreated = created.count;\r\n      }\r\n\r\n      this.logger.log({\r\n        message: 'Dynamic relationships created',\r\n        conceptName: resolvedName,\r\n        category: resolvedCategory,\r\n        candidatesEvaluated: candidates.length,\r\n        suggestedCount: suggestions.length,\r\n        createdCount: result.relationshipsCreated,\r\n      });\r\n    } catch (err) {\r\n      const errMsg = err instanceof Error ? err.message : 'Unknown error';\r\n      result.errors.push(errMsg);\r\n      this.logger.warn({\r\n        message: 'Dynamic relationship creation failed',\r\n        conceptName,\r\n        error: errMsg,\r\n      });\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Parses JSON relationship suggestions from LLM response.\r\n   * Validates against known candidate slugs.\r\n   */\r\n  private parseRelationshipSuggestions(\r\n    response: string,\r\n    candidates: Array<{ slug: string }>\r\n  ): RelationshipSuggestion[] {\r\n    try {\r\n      // Extract first JSON array from response (non-greedy to avoid spanning multiple arrays)\r\n      const jsonMatch = response.match(/\\[[\\s\\S]*?\\]/);\r\n      if (!jsonMatch) return [];\r\n\r\n      const parsed = JSON.parse(jsonMatch[0]) as unknown[];\r\n      if (!Array.isArray(parsed)) return [];\r\n\r\n      const validTypes = new Set(['PREREQUISITE', 'RELATED', 'ADVANCED']);\r\n      const validSlugs = new Set(candidates.map((c) => c.slug));\r\n\r\n      return parsed\r\n        .filter(\r\n          (item): item is { slug: string; type: string } =>\r\n            typeof item === 'object' &&\r\n            item !== null &&\r\n            'slug' in item &&\r\n            'type' in item &&\r\n            typeof (item as Record<string, unknown>).slug === 'string' &&\r\n            typeof (item as Record<string, unknown>).type === 'string'\r\n        )\r\n        .filter((item) => validSlugs.has(item.slug) && validTypes.has(item.type))\r\n        .map((item) => ({\r\n          slug: item.slug,\r\n          type: item.type as 'PREREQUISITE' | 'RELATED' | 'ADVANCED',\r\n        }));\r\n    } catch {\r\n      this.logger.warn({\r\n        message: 'Failed to parse relationship suggestions from LLM',\r\n        responseLength: response.length,\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Maps a Prisma concept to the Concept interface.\r\n   */\r\n  private mapToConcept(data: {\r\n    id: string;\r\n    name: string;\r\n    slug: string;\r\n    category: string;\r\n    definition: string;\r\n    extendedDescription: string | null;\r\n    departmentTags: string[];\r\n    embeddingId: string | null;\r\n    version: number;\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n  }): Concept {\r\n    return {\r\n      id: data.id,\r\n      name: data.name,\r\n      slug: data.slug,\r\n      category: data.category as ConceptCategory,\r\n      definition: data.definition,\r\n      extendedDescription: data.extendedDescription ?? undefined,\r\n      departmentTags: data.departmentTags,\r\n      embeddingId: data.embeddingId ?? undefined,\r\n      version: data.version,\r\n      createdAt: data.createdAt.toISOString(),\r\n      updatedAt: data.updatedAt.toISOString(),\r\n    };\r\n  }\r\n}\r\n","/**\r\n * LLM prompt template for classifying relationships between a new concept\r\n * and existing concepts in the knowledge base.\r\n *\r\n * Story 2.13: Dynamic Concept Relationship Creation\r\n */\r\n\r\n/** Category adjacency map for pre-filtering candidates  uses actual Serbian DB categories */\r\nexport const CATEGORY_ADJACENCY: Record<string, string[]> = {\r\n  'Uvod u Poslovanje': ['Vrednost', 'Preduzetnitvo', 'Poslovni Modeli'],\r\n  Marketing: ['Prodaja', 'Digitalni Marketing', 'Odnosi sa Klijentima', 'Strategija'],\r\n  Prodaja: ['Marketing', 'Odnosi sa Klijentima', 'Strategija'],\r\n  Vrednost: ['Uvod u Poslovanje', 'Strategija', 'Poslovni Modeli'],\r\n  Finansije: ['Raunovodstvo', 'Strategija', 'Operacije'],\r\n  Operacije: ['Menadment', 'Tehnologija', 'Finansije'],\r\n  Menadment: ['Liderstvo', 'Operacije', 'Strategija'],\r\n  Preduzetnitvo: ['Uvod u Poslovanje', 'Inovacije', 'Poslovni Modeli'],\r\n  'Digitalni Marketing': ['Marketing', 'Tehnologija', 'Prodaja'],\r\n  'Odnosi sa Klijentima': ['Prodaja', 'Marketing', 'Menadment'],\r\n  Raunovodstvo: ['Finansije', 'Operacije'],\r\n  Tehnologija: ['Inovacije', 'Operacije', 'Digitalni Marketing'],\r\n  Inovacije: ['Tehnologija', 'Preduzetnitvo', 'Strategija'],\r\n  Liderstvo: ['Menadment', 'Strategija'],\r\n  Strategija: ['Poslovni Modeli', 'Finansije', 'Marketing', 'Liderstvo'],\r\n  'Poslovni Modeli': ['Strategija', 'Vrednost', 'Preduzetnitvo'],\r\n};\r\n\r\nexport interface CandidateConcept {\r\n  id: string;\r\n  slug: string;\r\n  name: string;\r\n  category: string;\r\n  definition: string;\r\n}\r\n\r\nexport interface RelationshipSuggestion {\r\n  slug: string;\r\n  type: 'PREREQUISITE' | 'RELATED' | 'ADVANCED';\r\n}\r\n\r\nconst MAX_CANDIDATES = 20;\r\n\r\n/**\r\n * Gets relevant categories for a given category (same + adjacent).\r\n */\r\nexport function getRelevantCategories(category: string): string[] {\r\n  const adjacent = CATEGORY_ADJACENCY[category] ?? [];\r\n  return [category, ...adjacent];\r\n}\r\n\r\n/**\r\n * Builds the system prompt for relationship classification.\r\n */\r\nexport function buildRelationshipClassificationPrompt(\r\n  conceptName: string,\r\n  conceptCategory: string,\r\n  conceptDefinition: string,\r\n  candidates: CandidateConcept[]\r\n): string {\r\n  const limitedCandidates = candidates.slice(0, MAX_CANDIDATES);\r\n\r\n  const candidateList = limitedCandidates\r\n    .map((c, i) => `${i + 1}. ${c.name} (${c.category}) [slug: ${c.slug}] - \"${c.definition}\"`)\r\n    .join('\\n');\r\n\r\n  return `Ti si ekspert za poslovne baze znanja. Analiziraj odnose izmeu NOVOG koncepta i postojeih koncepata.\r\n\r\nNOVI KONCEPT: \"${conceptName}\"\r\nKATEGORIJA: ${conceptCategory}\r\nDEFINICIJA: \"${conceptDefinition}\"\r\n\r\nPOSTOJEI KONCEPTI ZA EVALUACIJU:\r\n${candidateList}\r\n\r\nZa svaki postojei koncept, klasifikuj odnos OD novog koncepta KA postojeem:\r\n- PREREQUISITE: Postojei koncept mora biti shvaen PRE novog koncepta (postojei je temelj za novi)\r\n- RELATED: Koncepti su u istom poslovnom domenu i dopunjuju se meusobno\r\n- ADVANCED: Postojei koncept je dublja/specijalizovanija verzija novog koncepta\r\n- NONE: Nema smislenog odnosa\r\n\r\nPRAVILA:\r\n- Ukljui SAMO koncepte sa PREREQUISITE, RELATED ili ADVANCED odnosom. Izostavi NONE.\r\n- Budi selektivan: kreiraj odnose samo tamo gde postoji stvarna poslovna logika veza.\r\n- Ciljaj na 3-8 odnosa po konceptu. Kvalitet iznad kvantiteta.\r\n- Odnosi izmeu razliitih kategorija su vredni kada odraavaju stvarne poslovne veze.\r\n\r\nVrati SAMO validan JSON niz (bez markdown-a, bez objanjenja):\r\n[{\"slug\": \"concept-slug\", \"type\": \"RELATED\"}, {\"slug\": \"another-slug\", \"type\": \"PREREQUISITE\"}]\r\n\r\nAko ne postoje smisleni odnosi, vrati prazan niz: []`;\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport type {\r\n  ConceptCitation,\r\n  ConceptCategory,\r\n  ConceptCitationSummary,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Service for managing concept citations.\r\n * Handles storage and retrieval of message-to-concept citations.\r\n */\r\n@Injectable()\r\nexport class CitationService {\r\n  private readonly logger = new Logger(CitationService.name);\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  /**\r\n   * Stores citations for a message in the database.\r\n   *\r\n   * @param messageId - The message ID to associate citations with\r\n   * @param citations - Array of citations to store\r\n   * @returns The stored citations with database IDs\r\n   */\r\n  async storeCitations(\r\n    messageId: string,\r\n    citations: Omit<ConceptCitation, 'id' | 'createdAt'>[]\r\n  ): Promise<ConceptCitation[]> {\r\n    if (citations.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Storing citations',\r\n      messageId,\r\n      count: citations.length,\r\n    });\r\n\r\n    const createdCitations: ConceptCitation[] = [];\r\n\r\n    for (const citation of citations) {\r\n      try {\r\n        const created = await this.prisma.conceptCitation.create({\r\n          data: {\r\n            id: `cit_${createId()}`,\r\n            messageId,\r\n            conceptId: citation.conceptId,\r\n            position: citation.position,\r\n            score: citation.score,\r\n          },\r\n          include: {\r\n            concept: {\r\n              select: {\r\n                name: true,\r\n                category: true,\r\n              },\r\n            },\r\n          },\r\n        });\r\n\r\n        createdCitations.push({\r\n          id: created.id,\r\n          messageId: created.messageId,\r\n          conceptId: created.conceptId,\r\n          conceptName: created.concept.name,\r\n          conceptCategory: created.concept.category as ConceptCategory,\r\n          position: created.position,\r\n          score: created.score,\r\n          createdAt: created.createdAt.toISOString(),\r\n        });\r\n      } catch (error) {\r\n        this.logger.error({\r\n          message: 'Failed to store citation',\r\n          conceptId: citation.conceptId,\r\n          error: error instanceof Error ? error.message : 'Unknown error',\r\n        });\r\n      }\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Citations stored',\r\n      storedCount: createdCitations.length,\r\n    });\r\n\r\n    return createdCitations;\r\n  }\r\n\r\n  /**\r\n   * Retrieves citations for a specific message.\r\n   *\r\n   * @param messageId - The message ID to get citations for\r\n   * @returns Array of citations with concept details\r\n   */\r\n  async getCitationsForMessage(messageId: string): Promise<ConceptCitation[]> {\r\n    this.logger.debug({\r\n      message: 'Getting citations for message',\r\n      messageId,\r\n    });\r\n\r\n    const citations = await this.prisma.conceptCitation.findMany({\r\n      where: { messageId },\r\n      include: {\r\n        concept: {\r\n          select: {\r\n            name: true,\r\n            category: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { position: 'asc' },\r\n    });\r\n\r\n    return citations.map((c) => ({\r\n      id: c.id,\r\n      messageId: c.messageId,\r\n      conceptId: c.conceptId,\r\n      conceptName: c.concept.name,\r\n      conceptCategory: c.concept.category as ConceptCategory,\r\n      position: c.position,\r\n      score: c.score,\r\n      createdAt: c.createdAt.toISOString(),\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Gets a concept summary suitable for the citation side panel.\r\n   *\r\n   * @param conceptId - The concept ID\r\n   * @returns Concept summary with related concepts\r\n   */\r\n  async getConceptSummaryForPanel(\r\n    conceptId: string\r\n  ): Promise<ConceptCitationSummary | null> {\r\n    const concept = await this.prisma.concept.findUnique({\r\n      where: { id: conceptId },\r\n      include: {\r\n        relatedTo: {\r\n          include: {\r\n            targetConcept: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n              },\r\n            },\r\n          },\r\n          take: 5,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!concept) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      id: concept.id,\r\n      name: concept.name,\r\n      category: concept.category as ConceptCategory,\r\n      definition: concept.definition,\r\n      extendedDescription: concept.extendedDescription ?? undefined,\r\n      relatedConcepts: concept.relatedTo.map((r) => ({\r\n        id: r.targetConcept.id,\r\n        name: r.targetConcept.name,\r\n      })),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Deletes all citations for a message.\r\n   * Used when a message is deleted.\r\n   *\r\n   * @param messageId - The message ID\r\n   */\r\n  async deleteCitationsForMessage(messageId: string): Promise<void> {\r\n    this.logger.log({\r\n      message: 'Deleting citations for message',\r\n      messageId,\r\n    });\r\n\r\n    await this.prisma.conceptCitation.deleteMany({\r\n      where: { messageId },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets distinct concept IDs from citations for a user.\r\n   * Used for concept tree growth  shows concepts discovered via AI citations.\r\n   */\r\n  async getDiscoveredConceptIds(userId: string): Promise<string[]> {\r\n    // Get message IDs for this user's conversations, then find cited concepts\r\n    const messages = await this.prisma.message.findMany({\r\n      where: { conversation: { userId } },\r\n      select: { id: true },\r\n    });\r\n    if (messages.length === 0) return [];\r\n\r\n    const messageIds = messages.map((m) => m.id);\r\n    const citations = await this.prisma.conceptCitation.findMany({\r\n      where: { messageId: { in: messageIds } },\r\n      select: { conceptId: true },\r\n      distinct: ['conceptId'],\r\n    });\r\n    return citations.map((c) => c.conceptId);\r\n  }\r\n\r\n  /**\r\n   * Gets citation count for analytics.\r\n   *\r\n   * @param conceptId - Optional concept ID to filter by\r\n   * @returns Total citation count\r\n   */\r\n  async getCitationCount(conceptId?: string): Promise<number> {\r\n    return this.prisma.conceptCitation.count({\r\n      where: conceptId ? { conceptId } : undefined,\r\n    });\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport type { CurriculumNode } from '@mentor-ai/shared/types';\r\nimport { readFileSync } from 'fs';\r\nimport { join } from 'path';\r\n\r\n/**\r\n * Service for managing the curriculum reference data and on-demand concept creation.\r\n * Loads the curriculum hierarchy from a static JSON file and creates DB concepts\r\n * only when they are first discussed in a conversation.\r\n */\r\n@Injectable()\r\nexport class CurriculumService {\r\n  private readonly logger = new Logger(CurriculumService.name);\r\n  private readonly nodes: CurriculumNode[];\r\n  private readonly nodeMap: Map<string, CurriculumNode>;\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {\r\n    this.nodes = this.loadCurriculumData();\r\n    this.nodeMap = new Map(this.nodes.map((n) => [n.id, n]));\r\n    this.logger.log(`Loaded ${this.nodes.length} curriculum nodes`);\r\n  }\r\n\r\n  private loadCurriculumData(): CurriculumNode[] {\r\n    // Try multiple paths since __dirname varies between dev and built output\r\n    const paths = [\r\n      join(__dirname, 'data', 'curriculum.json'),\r\n      join(__dirname, '..', 'knowledge', 'data', 'curriculum.json'),\r\n      join(__dirname, '..', 'app', 'knowledge', 'data', 'curriculum.json'),\r\n    ];\r\n    for (const p of paths) {\r\n      try {\r\n        const raw = readFileSync(p, 'utf-8');\r\n        return JSON.parse(raw) as CurriculumNode[];\r\n      } catch {\r\n        // Try next path\r\n      }\r\n    }\r\n    this.logger.warn('Could not load curriculum.json from any expected path');\r\n    return [];\r\n  }\r\n\r\n  /** Returns the full curriculum tree as a flat array. */\r\n  getFullTree(): CurriculumNode[] {\r\n    return this.nodes;\r\n  }\r\n\r\n  /** Looks up a single curriculum node by ID. */\r\n  findNode(curriculumId: string): CurriculumNode | null {\r\n    return this.nodeMap.get(curriculumId) ?? null;\r\n  }\r\n\r\n  /** Returns the ancestor chain from root to the given node (inclusive). */\r\n  getAncestorChain(curriculumId: string): CurriculumNode[] {\r\n    const chain: CurriculumNode[] = [];\r\n    let current = this.nodeMap.get(curriculumId);\r\n    while (current) {\r\n      chain.unshift(current);\r\n      current = current.parentId ? this.nodeMap.get(current.parentId) : undefined;\r\n    }\r\n    return chain;\r\n  }\r\n\r\n  /** Returns all top-level nodes (parentId === null). */\r\n  getTopLevelNodes(): CurriculumNode[] {\r\n    return this.nodes.filter((n) => n.parentId === null);\r\n  }\r\n\r\n  /** Returns children of a given curriculum node. */\r\n  getChildren(curriculumId: string): CurriculumNode[] {\r\n    return this.nodes.filter((n) => n.parentId === curriculumId);\r\n  }\r\n\r\n  /**\r\n   * Simple substring match of a text against curriculum labels.\r\n   * Returns the best matching node or null.\r\n   */\r\n  matchTopic(text: string): CurriculumNode | null {\r\n    const lower = text.toLowerCase();\r\n    // Exact match first\r\n    for (const node of this.nodes) {\r\n      if (node.label.toLowerCase() === lower) return node;\r\n    }\r\n    // Substring match (prefer longer labels = more specific)\r\n    const matches = this.nodes.filter((n) =>\r\n      lower.includes(n.label.toLowerCase()) || n.label.toLowerCase().includes(lower)\r\n    );\r\n    if (matches.length === 0) return null;\r\n    // Return the most specific (deepest) match\r\n    return matches.sort((a, b) => b.label.length - a.label.length)[0] ?? null;\r\n  }\r\n\r\n  /**\r\n   * Searches curriculum labels by substring.\r\n   * @param query - Search string\r\n   * @param limit - Max results (default 20)\r\n   */\r\n  searchCurriculum(query: string, limit = 20): CurriculumNode[] {\r\n    const lower = query.toLowerCase();\r\n    return this.nodes\r\n      .filter((n) => n.label.toLowerCase().includes(lower))\r\n      .slice(0, limit);\r\n  }\r\n\r\n  /**\r\n   * Ensures a concept exists in the DB for the given curriculum ID.\r\n   * Creates the concept and all ancestor concepts if they don't exist yet.\r\n   * Returns the concept ID (cpt_ prefixed).\r\n   */\r\n  async ensureConceptExists(curriculumId: string): Promise<string> {\r\n    const node = this.nodeMap.get(curriculumId);\r\n    if (!node) {\r\n      throw new Error(`Curriculum node not found: ${curriculumId}`);\r\n    }\r\n\r\n    // Check if already exists\r\n    const existing = await this.prisma.concept.findUnique({\r\n      where: { curriculumId },\r\n      select: { id: true },\r\n    });\r\n    if (existing) return existing.id;\r\n\r\n    // Get ancestor chain and ensure all ancestors exist first\r\n    const chain = this.getAncestorChain(curriculumId);\r\n    let parentConceptId: string | null = null;\r\n\r\n    for (const ancestor of chain) {\r\n      const existingAncestor = await this.prisma.concept.findUnique({\r\n        where: { curriculumId: ancestor.id },\r\n        select: { id: true },\r\n      });\r\n\r\n      if (existingAncestor) {\r\n        parentConceptId = existingAncestor.id;\r\n        continue;\r\n      }\r\n\r\n      // Create the ancestor concept\r\n      const conceptId = `cpt_${createId()}`;\r\n      const topLevelCategory = chain[0]?.label ?? 'General'; // Root ancestor label as category\r\n\r\n      await this.prisma.concept.create({\r\n        data: {\r\n          id: conceptId,\r\n          name: ancestor.label,\r\n          slug: ancestor.id,\r\n          category: topLevelCategory,\r\n          definition: ancestor.label,\r\n          departmentTags: [],\r\n          parentId: parentConceptId,\r\n          sortOrder: ancestor.sortOrder,\r\n          curriculumId: ancestor.id,\r\n        },\r\n      });\r\n\r\n      this.logger.log(`Created concept for curriculum node: ${ancestor.id} (${ancestor.label})`);\r\n      parentConceptId = conceptId;\r\n    }\r\n\r\n    // The last parentConceptId is the one we just created for our target node\r\n    return parentConceptId!;\r\n  }\r\n\r\n  /**\r\n   * Finds all concepts that have a curriculumId set.\r\n   * Used for building the sparse sidebar tree.\r\n   */\r\n  async getActiveConceptsByCurriculum(): Promise<\r\n    Map<string, { id: string; name: string; curriculumId: string; parentId: string | null }>\r\n  > {\r\n    const concepts = await this.prisma.concept.findMany({\r\n      where: { curriculumId: { not: null } },\r\n      select: { id: true, name: true, curriculumId: true, parentId: true },\r\n    });\r\n\r\n    return new Map(\r\n      concepts\r\n        .filter((c): c is typeof c & { curriculumId: string } => c.curriculumId !== null)\r\n        .map((c) => [c.curriculumId, { id: c.id, name: c.name, curriculumId: c.curriculumId, parentId: c.parentId }])\r\n    );\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\nimport type { ConceptSeedData, RelationshipType } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Seed data file structure\r\n */\r\ninterface SeedFile {\r\n  concepts: ConceptSeedData[];\r\n}\r\n\r\n/**\r\n * Service for seeding business concepts into the database.\r\n * Provides idempotent seeding with bidirectional relationship creation.\r\n */\r\n@Injectable()\r\nexport class ConceptSeedService {\r\n  private readonly logger = new Logger(ConceptSeedService.name);\r\n  private readonly seedDataPath: string;\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {\r\n    // Resolve path relative to the compiled output\r\n    this.seedDataPath = path.resolve(\r\n      __dirname,\r\n      '../../../../prisma/seed-data/concepts'\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Seeds all concepts from JSON files in the seed-data folder.\r\n   * Idempotent: skips concepts that already exist.\r\n   *\r\n   * @param dryRun - If true, only logs what would be created without making changes\r\n   * @returns Summary of seeding results\r\n   */\r\n  async seedAllConcepts(dryRun = false): Promise<SeedResult> {\r\n    const result: SeedResult = {\r\n      conceptsCreated: 0,\r\n      conceptsSkipped: 0,\r\n      relationshipsCreated: 0,\r\n      errors: [],\r\n    };\r\n\r\n    this.logger.log({\r\n      message: 'Starting concept seeding',\r\n      seedDataPath: this.seedDataPath,\r\n      dryRun,\r\n    });\r\n\r\n    // Get all JSON files in the seed data folder\r\n    const files = this.getSeedFiles();\r\n\r\n    if (files.length === 0) {\r\n      this.logger.warn({\r\n        message: 'No seed files found',\r\n        path: this.seedDataPath,\r\n      });\r\n      return result;\r\n    }\r\n\r\n    // First pass: Create all concepts\r\n    const conceptsBySlug = new Map<string, string>(); // slug -> id\r\n\r\n    for (const file of files) {\r\n      const seedData = this.loadSeedFile(file);\r\n      if (!seedData) continue;\r\n\r\n      for (const conceptData of seedData.concepts) {\r\n        try {\r\n          const existingConcept = await this.prisma.concept.findUnique({\r\n            where: { slug: conceptData.slug },\r\n          });\r\n\r\n          if (existingConcept) {\r\n            conceptsBySlug.set(conceptData.slug, existingConcept.id);\r\n            result.conceptsSkipped++;\r\n            this.logger.debug({\r\n              message: 'Concept already exists, skipping',\r\n              slug: conceptData.slug,\r\n            });\r\n            continue;\r\n          }\r\n\r\n          if (dryRun) {\r\n            const conceptId = `cpt_${createId()}`;\r\n            conceptsBySlug.set(conceptData.slug, conceptId);\r\n            result.conceptsCreated++;\r\n            this.logger.log({\r\n              message: '[DRY RUN] Would create concept',\r\n              name: conceptData.name,\r\n              slug: conceptData.slug,\r\n            });\r\n            continue;\r\n          }\r\n\r\n          const concept = await this.createConcept(conceptData);\r\n          conceptsBySlug.set(conceptData.slug, concept.id);\r\n          result.conceptsCreated++;\r\n\r\n          this.logger.log({\r\n            message: 'Created concept',\r\n            id: concept.id,\r\n            name: concept.name,\r\n            category: concept.category,\r\n          });\r\n        } catch (error) {\r\n          const errorMessage =\r\n            error instanceof Error ? error.message : 'Unknown error';\r\n          result.errors.push(`Failed to create concept ${conceptData.slug}: ${errorMessage}`);\r\n          this.logger.error({\r\n            message: 'Failed to create concept',\r\n            slug: conceptData.slug,\r\n            error: errorMessage,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Second pass: Create relationships\r\n    for (const file of files) {\r\n      const seedData = this.loadSeedFile(file);\r\n      if (!seedData) continue;\r\n\r\n      for (const conceptData of seedData.concepts) {\r\n        if (!conceptData.relatedConcepts || conceptData.relatedConcepts.length === 0) {\r\n          continue;\r\n        }\r\n\r\n        const sourceId = conceptsBySlug.get(conceptData.slug);\r\n        if (!sourceId) continue;\r\n\r\n        for (const relation of conceptData.relatedConcepts) {\r\n          const targetId = conceptsBySlug.get(relation.slug);\r\n          if (!targetId) {\r\n            this.logger.warn({\r\n              message: 'Related concept not found',\r\n              sourceSlug: conceptData.slug,\r\n              targetSlug: relation.slug,\r\n            });\r\n            continue;\r\n          }\r\n\r\n          try {\r\n            if (dryRun) {\r\n              result.relationshipsCreated++;\r\n              this.logger.log({\r\n                message: '[DRY RUN] Would create relationship',\r\n                source: conceptData.slug,\r\n                target: relation.slug,\r\n                type: relation.type,\r\n              });\r\n              continue;\r\n            }\r\n\r\n            // Check if relationship already exists\r\n            const existingRelation = await this.prisma.conceptRelationship.findUnique({\r\n              where: {\r\n                sourceConceptId_targetConceptId: {\r\n                  sourceConceptId: sourceId,\r\n                  targetConceptId: targetId,\r\n                },\r\n              },\r\n            });\r\n\r\n            if (existingRelation) {\r\n              continue; // Skip existing relationships\r\n            }\r\n\r\n            await this.prisma.conceptRelationship.create({\r\n              data: {\r\n                sourceConceptId: sourceId,\r\n                targetConceptId: targetId,\r\n                relationshipType: relation.type as RelationshipType,\r\n              },\r\n            });\r\n\r\n            result.relationshipsCreated++;\r\n          } catch (error) {\r\n            const errorMessage =\r\n              error instanceof Error ? error.message : 'Unknown error';\r\n            this.logger.error({\r\n              message: 'Failed to create relationship',\r\n              source: conceptData.slug,\r\n              target: relation.slug,\r\n              error: errorMessage,\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Concept seeding complete',\r\n      conceptsCreated: result.conceptsCreated,\r\n      conceptsSkipped: result.conceptsSkipped,\r\n      relationshipsCreated: result.relationshipsCreated,\r\n      errorCount: result.errors.length,\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Gets list of seed data JSON files.\r\n   */\r\n  private getSeedFiles(): string[] {\r\n    try {\r\n      if (!fs.existsSync(this.seedDataPath)) {\r\n        this.logger.warn({\r\n          message: 'Seed data path does not exist',\r\n          path: this.seedDataPath,\r\n        });\r\n        return [];\r\n      }\r\n\r\n      return fs\r\n        .readdirSync(this.seedDataPath)\r\n        .filter((file) => file.endsWith('.json'))\r\n        .map((file) => path.join(this.seedDataPath, file));\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to read seed data directory',\r\n        path: this.seedDataPath,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads and parses a seed data JSON file.\r\n   */\r\n  private loadSeedFile(filePath: string): SeedFile | null {\r\n    try {\r\n      const content = fs.readFileSync(filePath, 'utf-8');\r\n      return JSON.parse(content) as SeedFile;\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to load seed file',\r\n        filePath,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a single concept in the database.\r\n   */\r\n  private async createConcept(data: ConceptSeedData) {\r\n    const conceptId = `cpt_${createId()}`;\r\n\r\n    return this.prisma.concept.create({\r\n      data: {\r\n        id: conceptId,\r\n        name: data.name,\r\n        slug: data.slug,\r\n        category: data.category,\r\n        definition: data.definition,\r\n        extendedDescription: data.extendedDescription,\r\n        departmentTags: data.departmentTags,\r\n        version: 1,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clears all concepts and relationships from the database.\r\n   * Use with caution - primarily for testing.\r\n   */\r\n  async clearAllConcepts(): Promise<void> {\r\n    this.logger.warn({ message: 'Clearing all concepts and relationships' });\r\n\r\n    // Delete relationships first (foreign key constraint)\r\n    await this.prisma.conceptRelationship.deleteMany({});\r\n    await this.prisma.concept.deleteMany({});\r\n\r\n    this.logger.log({ message: 'All concepts and relationships cleared' });\r\n  }\r\n}\r\n\r\n/**\r\n * Result of concept seeding operation.\r\n */\r\nexport interface SeedResult {\r\n  /** Number of concepts created */\r\n  conceptsCreated: number;\r\n  /** Number of concepts skipped (already existed) */\r\n  conceptsSkipped: number;\r\n  /** Number of relationships created */\r\n  relationshipsCreated: number;\r\n  /** Error messages for any failures */\r\n  errors: string[];\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport type { ConceptMatch, ConceptCategory, PersonaType } from '@mentor-ai/shared/types';\r\nimport { EmbeddingService } from './embedding.service';\r\n\r\n/**\r\n * Options for concept matching.\r\n */\r\nexport interface ConceptMatchingOptions {\r\n  /** Maximum number of concepts to return (default: 5) */\r\n  limit?: number;\r\n  /** Minimum similarity score threshold (default: 0.7) */\r\n  threshold?: number;\r\n  /** Filter by persona type (maps to department) */\r\n  personaType?: PersonaType;\r\n  /** Whether to include prerequisite concepts in results (default: true) */\r\n  includePrerequisites?: boolean;\r\n}\r\n\r\n/**\r\n * Service for finding relevant business concepts using semantic + keyword search.\r\n * When Qdrant embeddings are available, uses AI-scored cosine similarity.\r\n * Falls back to improved keyword matching that handles Serbian text.\r\n * Walks the PREREQUISITE relationship graph so results include dependency context.\r\n */\r\n@Injectable()\r\nexport class ConceptMatchingService {\r\n  private readonly logger = new Logger(ConceptMatchingService.name);\r\n\r\n  private readonly DEFAULT_LIMIT = 5;\r\n  private readonly DEFAULT_THRESHOLD = 0.3;\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly embeddingService: EmbeddingService\r\n  ) {}\r\n\r\n  /**\r\n   * Finds relevant business concepts for a given text.\r\n   *\r\n   * Strategy:\r\n   * 1. Try Qdrant semantic search (AI embedding similarity) if available\r\n   * 2. Fall back to improved keyword matching (supports Serbian)\r\n   * 3. Walk PREREQUISITE relationships to include dependency context\r\n   * 4. Sort by relationship-boosted score (concepts with more incoming = more foundational)\r\n   */\r\n  async findRelevantConcepts(\r\n    response: string,\r\n    options: ConceptMatchingOptions = {}\r\n  ): Promise<ConceptMatch[]> {\r\n    const limit = options.limit ?? this.DEFAULT_LIMIT;\r\n    const threshold = options.threshold ?? this.DEFAULT_THRESHOLD;\r\n    const includePrerequisites = options.includePrerequisites ?? true;\r\n\r\n    this.logger.debug({\r\n      message: 'Finding relevant concepts',\r\n      responseLength: response.length,\r\n      limit,\r\n      threshold,\r\n      personaType: options.personaType,\r\n    });\r\n\r\n    // 1. Try semantic search via Qdrant embeddings first\r\n    let directMatches = await this.semanticSearch(\r\n      response,\r\n      limit * 2,\r\n      threshold,\r\n      options.personaType\r\n    );\r\n\r\n    // 2. If no semantic results, fall back to keyword matching\r\n    if (directMatches.length === 0) {\r\n      directMatches = await this.keywordMatch(response, limit * 2, options.personaType);\r\n    }\r\n\r\n    if (directMatches.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    // 3. Walk PREREQUISITE graph to include dependency context\r\n    if (includePrerequisites) {\r\n      directMatches = await this.expandWithPrerequisites(directMatches, limit);\r\n    }\r\n\r\n    // 4. Boost scores by relationship importance (more incoming = more foundational)\r\n    const boosted = await this.boostByRelationshipImportance(directMatches);\r\n\r\n    // Sort by boosted score, take top N\r\n    return boosted.sort((a, b) => b.score - a.score).slice(0, limit);\r\n  }\r\n\r\n  /**\r\n   * Semantic search via Qdrant embeddings.\r\n   * Returns empty array if Qdrant is not available or embeddings not generated.\r\n   */\r\n  private async semanticSearch(\r\n    query: string,\r\n    limit: number,\r\n    threshold: number,\r\n    personaType?: PersonaType\r\n  ): Promise<ConceptMatch[]> {\r\n    try {\r\n      const filter = personaType\r\n        ? { department: this.personaToDepartment(personaType) }\r\n        : undefined;\r\n\r\n      const semanticMatches = await this.embeddingService.search(query, limit, filter);\r\n\r\n      if (semanticMatches.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      // Filter by threshold and enrich with full concept data\r\n      const aboveThreshold = semanticMatches.filter((m) => m.score >= threshold);\r\n      if (aboveThreshold.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      const enriched = await this.enrichMatchesWithConceptData(aboveThreshold);\r\n\r\n      this.logger.debug({\r\n        message: 'Semantic search results',\r\n        totalMatches: semanticMatches.length,\r\n        aboveThreshold: aboveThreshold.length,\r\n        enriched: enriched.length,\r\n      });\r\n\r\n      return enriched;\r\n    } catch (err) {\r\n      this.logger.debug({\r\n        message: 'Semantic search unavailable, will use keyword fallback',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enriches semantic matches with full concept data from database.\r\n   */\r\n  private async enrichMatchesWithConceptData(\r\n    matches: Array<{ conceptId: string; score: number; name: string }>\r\n  ): Promise<ConceptMatch[]> {\r\n    if (matches.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const conceptIds = matches.map((m) => m.conceptId);\r\n\r\n    const concepts = await this.prisma.concept.findMany({\r\n      where: { id: { in: conceptIds } },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        category: true,\r\n        definition: true,\r\n      },\r\n    });\r\n\r\n    const conceptMap = new Map(concepts.map((c) => [c.id, c]));\r\n\r\n    return matches\r\n      .map((match) => {\r\n        const concept = conceptMap.get(match.conceptId);\r\n        if (!concept) return null;\r\n\r\n        return {\r\n          conceptId: concept.id,\r\n          conceptName: concept.name,\r\n          category: concept.category as ConceptCategory,\r\n          definition: concept.definition,\r\n          score: match.score,\r\n        };\r\n      })\r\n      .filter((m): m is ConceptMatch => m !== null);\r\n  }\r\n\r\n  /**\r\n   * Improved keyword matching that handles Serbian text properly.\r\n   * Supports Latin and Cyrillic characters ().\r\n   */\r\n  private async keywordMatch(\r\n    response: string,\r\n    limit: number,\r\n    personaType?: PersonaType\r\n  ): Promise<ConceptMatch[]> {\r\n    // Extract words preserving Serbian characters (a-z +  + Latin extended)\r\n    const words = response\r\n      .toLowerCase()\r\n      .split(/\\s+/)\r\n      .filter((word) => word.length >= 3)\r\n      .map((word) => word.replace(/[^a-z]/gi, ''))\r\n      .filter((word) => word.length >= 3);\r\n\r\n    // Remove common words (English + Serbian)\r\n    const commonWords = new Set([\r\n      // English\r\n      'the',\r\n      'and',\r\n      'for',\r\n      'are',\r\n      'but',\r\n      'not',\r\n      'you',\r\n      'all',\r\n      'can',\r\n      'her',\r\n      'was',\r\n      'one',\r\n      'our',\r\n      'out',\r\n      'has',\r\n      'have',\r\n      'been',\r\n      'will',\r\n      'with',\r\n      'this',\r\n      'that',\r\n      'from',\r\n      'they',\r\n      'would',\r\n      'about',\r\n      'which',\r\n      'their',\r\n      'there',\r\n      'should',\r\n      'could',\r\n      // Serbian\r\n      'koji',\r\n      'koja',\r\n      'koje',\r\n      'kao',\r\n      'ali',\r\n      'ili',\r\n      'ako',\r\n      'jer',\r\n      'dok',\r\n      've',\r\n      'vec',\r\n      'jo',\r\n      'jos',\r\n      'sve',\r\n      'sam',\r\n      'smo',\r\n      'ste',\r\n      'ima',\r\n      'nije',\r\n      'biti',\r\n      'bio',\r\n      'bila',\r\n      'bilo',\r\n      'moe',\r\n      'moze',\r\n      'treba',\r\n      'samo',\r\n      'ovo',\r\n      'taj',\r\n      'tog',\r\n      'tom',\r\n      'tim',\r\n      'kod',\r\n      'izmeu',\r\n      'izmeu',\r\n      'nakon',\r\n      'pre',\r\n      'posle',\r\n      'kroz',\r\n      'nad',\r\n      'pod',\r\n    ]);\r\n    const keywords = [...new Set(words.filter((w) => !commonWords.has(w)))];\r\n\r\n    if (keywords.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    // Build OR conditions for keyword search (take top 15 keywords)\r\n    const searchConditions = keywords.slice(0, 15).map((keyword) => ({\r\n      OR: [\r\n        { name: { contains: keyword, mode: 'insensitive' as const } },\r\n        { definition: { contains: keyword, mode: 'insensitive' as const } },\r\n      ],\r\n    }));\r\n\r\n    // Add department filter if persona specified\r\n    const departmentFilter = personaType\r\n      ? { departmentTags: { has: this.personaToDepartment(personaType) } }\r\n      : {};\r\n\r\n    const concepts = await this.prisma.concept.findMany({\r\n      where: {\r\n        OR: searchConditions,\r\n        ...departmentFilter,\r\n      },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        category: true,\r\n        definition: true,\r\n        sortOrder: true,\r\n      },\r\n      take: limit * 2,\r\n    });\r\n\r\n    // Score concepts by keyword match count + name-match boost\r\n    const scoredConcepts = concepts.map((concept) => {\r\n      const nameLower = concept.name.toLowerCase();\r\n      const defLower = concept.definition.toLowerCase();\r\n\r\n      let matchScore = 0;\r\n      for (const keyword of keywords) {\r\n        // Name match is worth 3x more than definition match\r\n        if (nameLower.includes(keyword)) {\r\n          matchScore += 3;\r\n        } else if (defLower.includes(keyword)) {\r\n          matchScore += 1;\r\n        }\r\n      }\r\n\r\n      // Normalize to 0-1 range: base 0.3 + up to 0.65 from matches\r\n      const score = Math.min(0.3 + matchScore * 0.05, 0.95);\r\n\r\n      return {\r\n        conceptId: concept.id,\r\n        conceptName: concept.name,\r\n        category: concept.category as ConceptCategory,\r\n        definition: concept.definition,\r\n        score,\r\n      };\r\n    });\r\n\r\n    return scoredConcepts.sort((a, b) => b.score - a.score).slice(0, limit);\r\n  }\r\n\r\n  /**\r\n   * Expands matched concepts with their PREREQUISITE dependencies.\r\n   * If concept X requires concept Y (PREREQUISITE), Y is added to results\r\n   * with a slightly lower score so it appears in context.\r\n   */\r\n  private async expandWithPrerequisites(\r\n    matches: ConceptMatch[],\r\n    maxTotal: number\r\n  ): Promise<ConceptMatch[]> {\r\n    const matchedIds = new Set(matches.map((m) => m.conceptId));\r\n\r\n    // Find all PREREQUISITE relationships where matched concepts are the target\r\n    // i.e., \"what concepts are prerequisites for the ones we matched?\"\r\n    const prerequisites = await this.prisma.conceptRelationship.findMany({\r\n      where: {\r\n        sourceConceptId: { in: [...matchedIds] },\r\n        relationshipType: 'PREREQUISITE',\r\n      },\r\n      select: {\r\n        targetConceptId: true,\r\n        targetConcept: {\r\n          select: {\r\n            id: true,\r\n            name: true,\r\n            category: true,\r\n            definition: true,\r\n            sortOrder: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Add prerequisite concepts that aren't already in results\r\n    const prereqMatches: ConceptMatch[] = [];\r\n    for (const rel of prerequisites) {\r\n      if (matchedIds.has(rel.targetConceptId)) continue;\r\n      matchedIds.add(rel.targetConceptId);\r\n\r\n      const c = rel.targetConcept;\r\n      prereqMatches.push({\r\n        conceptId: c.id,\r\n        conceptName: c.name,\r\n        category: c.category as ConceptCategory,\r\n        definition: c.definition,\r\n        score: 0.85, // High score  prerequisites are foundational\r\n      });\r\n    }\r\n\r\n    this.logger.debug({\r\n      message: 'Expanded with prerequisites',\r\n      directMatches: matches.length,\r\n      prerequisitesAdded: prereqMatches.length,\r\n    });\r\n\r\n    // Prerequisites first (they're foundational), then direct matches\r\n    return [...prereqMatches, ...matches].slice(0, maxTotal * 2);\r\n  }\r\n\r\n  /**\r\n   * Boosts concept scores based on their relationship importance.\r\n   * Concepts with more incoming PREREQUISITE relationships are more foundational\r\n   * and get a score boost (they're needed by many other concepts).\r\n   */\r\n  private async boostByRelationshipImportance(matches: ConceptMatch[]): Promise<ConceptMatch[]> {\r\n    if (matches.length === 0) return matches;\r\n\r\n    const conceptIds = matches.map((m) => m.conceptId);\r\n\r\n    // Count incoming PREREQUISITE relationships for each concept\r\n    // (how many other concepts list this one as a prerequisite)\r\n    const incomingCounts = await this.prisma.conceptRelationship.groupBy({\r\n      by: ['targetConceptId'],\r\n      where: {\r\n        targetConceptId: { in: conceptIds },\r\n        relationshipType: 'PREREQUISITE',\r\n      },\r\n      _count: { id: true },\r\n    });\r\n\r\n    const countMap = new Map(incomingCounts.map((c) => [c.targetConceptId, c._count.id]));\r\n\r\n    // Boost score: more incoming prerequisites = more foundational = higher score\r\n    // Max boost of +0.15 for concepts with 10+ incoming relationships\r\n    return matches.map((m) => {\r\n      const incomingCount = countMap.get(m.conceptId) ?? 0;\r\n      const boost = Math.min(incomingCount * 0.015, 0.15);\r\n      return {\r\n        ...m,\r\n        score: Math.min(m.score + boost, 1.0),\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Maps PersonaType to department name for filtering.\r\n   */\r\n  private personaToDepartment(personaType: PersonaType): string {\r\n    const mapping: Record<PersonaType, string> = {\r\n      CFO: 'Finance',\r\n      CMO: 'Marketing',\r\n      CTO: 'Technology',\r\n      OPERATIONS: 'Operations',\r\n      LEGAL: 'Legal',\r\n      CREATIVE: 'Creative',\r\n      CSO: 'Strategy',\r\n      SALES: 'Sales',\r\n    };\r\n    return mapping[personaType] || personaType;\r\n  }\r\n}\r\n","import { Injectable, Logger, OnModuleInit } from '@nestjs/common';\r\nimport { createHash } from 'node:crypto';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { QdrantClientService } from '../../qdrant/qdrant-client.service';\r\n\r\n/**\r\n * Embedding vector result.\r\n */\r\nexport interface EmbeddingResult {\r\n  /** Unique ID for the embedding */\r\n  embeddingId: string;\r\n  /** The embedding vector (1536 dimensions for OpenAI text-embedding-3-small) */\r\n  vector: number[];\r\n}\r\n\r\n/**\r\n * Semantic search match result.\r\n */\r\nexport interface SemanticMatch {\r\n  /** Concept ID */\r\n  conceptId: string;\r\n  /** Similarity score (0.0-1.0) */\r\n  score: number;\r\n  /** Concept name from payload */\r\n  name: string;\r\n}\r\n\r\n/**\r\n * Interface for embedding service operations.\r\n */\r\nexport interface IEmbeddingService {\r\n  embed(text: string): Promise<EmbeddingResult>;\r\n  store(conceptId: string, vector: number[], payload: Record<string, unknown>): Promise<string>;\r\n  search(\r\n    query: string | number[],\r\n    limit: number,\r\n    filter?: Record<string, unknown>\r\n  ): Promise<SemanticMatch[]>;\r\n  delete(embeddingId: string): Promise<void>;\r\n}\r\n\r\n/**\r\n * Embedding API response shape (OpenAI-compatible, used by LM Studio).\r\n */\r\ninterface EmbeddingResponse {\r\n  data: Array<{\r\n    embedding: number[];\r\n    index: number;\r\n  }>;\r\n  model: string;\r\n  usage: {\r\n    prompt_tokens: number;\r\n    total_tokens: number;\r\n  };\r\n}\r\n\r\n/** OpenAI API endpoint for embeddings */\r\nconst OPENAI_EMBEDDINGS_URL = 'https://api.openai.com/v1/embeddings';\r\n\r\n/**\r\n * Embedding service using OpenAI text-embedding-3-small (1536-dim) + Qdrant Cloud.\r\n *\r\n * - embed(): Calls OpenAI API to generate 1536-dim embeddings\r\n * - store(): Upserts embedding vector to Qdrant 'concepts' collection\r\n * - search(): Cosine similarity search via Qdrant\r\n * - delete(): Removes point from Qdrant collection\r\n */\r\n@Injectable()\r\nexport class EmbeddingService implements IEmbeddingService, OnModuleInit {\r\n  private readonly logger = new Logger(EmbeddingService.name);\r\n  private readonly EMBEDDING_MODEL = 'text-embedding-3-small';\r\n  private readonly EMBEDDING_DIMENSIONS = 1536;\r\n  private readonly COLLECTION_NAME = 'concepts';\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly qdrantClient: QdrantClientService\r\n  ) {}\r\n\r\n  async onModuleInit(): Promise<void> {\r\n    if (!this.qdrantClient.isAvailable()) {\r\n      this.logger.warn('Qdrant not available  concept embeddings disabled');\r\n      return;\r\n    }\r\n    try {\r\n      await this.qdrantClient.ensureCollection(this.COLLECTION_NAME, this.EMBEDDING_DIMENSIONS);\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Failed to ensure Qdrant concepts collection (non-fatal)',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generates an embedding for text content using OpenAI API.\r\n   */\r\n  async embed(text: string): Promise<EmbeddingResult> {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n      this.logger.error('OPENAI_API_KEY not set  cannot generate embeddings');\r\n      return {\r\n        embeddingId: `emb_error_${Date.now()}`,\r\n        vector: new Array(this.EMBEDDING_DIMENSIONS).fill(0),\r\n      };\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(OPENAI_EMBEDDINGS_URL, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          Authorization: `Bearer ${apiKey}`,\r\n        },\r\n        body: JSON.stringify({\r\n          model: this.EMBEDDING_MODEL,\r\n          input: text,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        this.logger.error({\r\n          message: 'OpenAI embedding API error',\r\n          status: response.status,\r\n          error: errorText,\r\n        });\r\n        return {\r\n          embeddingId: `emb_error_${Date.now()}`,\r\n          vector: new Array(this.EMBEDDING_DIMENSIONS).fill(0),\r\n        };\r\n      }\r\n\r\n      const data = (await response.json()) as EmbeddingResponse;\r\n      const first = data.data[0];\r\n      if (!first) {\r\n        return {\r\n          embeddingId: `emb_error_${Date.now()}`,\r\n          vector: new Array(this.EMBEDDING_DIMENSIONS).fill(0),\r\n        };\r\n      }\r\n      const vector = first.embedding;\r\n\r\n      this.logger.debug({\r\n        message: 'Embedding generated via OpenAI',\r\n        model: data.model,\r\n        dimensions: vector.length,\r\n        tokensUsed: data.usage?.total_tokens,\r\n      });\r\n\r\n      return {\r\n        embeddingId: `emb_${Date.now()}`,\r\n        vector,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to generate embedding via OpenAI',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return {\r\n        embeddingId: `emb_error_${Date.now()}`,\r\n        vector: new Array(this.EMBEDDING_DIMENSIONS).fill(0),\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stores an embedding in the Qdrant 'concepts' collection.\r\n   * Uses a deterministic UUID from the conceptId for idempotent upserts.\r\n   */\r\n  async store(\r\n    conceptId: string,\r\n    vector: number[],\r\n    payload: Record<string, unknown>\r\n  ): Promise<string> {\r\n    const pointId = this.conceptIdToUuid(conceptId);\r\n\r\n    try {\r\n      const client = this.qdrantClient.getClient();\r\n      await client.upsert(this.COLLECTION_NAME, {\r\n        wait: true,\r\n        points: [\r\n          {\r\n            id: pointId,\r\n            vector,\r\n            payload: {\r\n              conceptId,\r\n              name: (payload['name'] as string) ?? '',\r\n              category: (payload['category'] as string) ?? '',\r\n              departmentTags: (payload['departmentTags'] as string[]) ?? [],\r\n            },\r\n          },\r\n        ],\r\n      });\r\n\r\n      // Store the Qdrant point UUID in the database\r\n      await this.prisma.concept.update({\r\n        where: { id: conceptId },\r\n        data: { embeddingId: pointId },\r\n      });\r\n\r\n      this.logger.debug({\r\n        message: 'Embedding stored in Qdrant',\r\n        conceptId,\r\n        pointId,\r\n        dimensions: vector.length,\r\n      });\r\n\r\n      return pointId;\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to store embedding in Qdrant',\r\n        conceptId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Searches for similar concepts using cosine similarity via Qdrant.\r\n   */\r\n  async search(\r\n    query: string | number[],\r\n    limit: number,\r\n    filter?: Record<string, unknown>\r\n  ): Promise<SemanticMatch[]> {\r\n    if (!this.qdrantClient.isAvailable()) {\r\n      return [];\r\n    }\r\n\r\n    let queryVector: number[];\r\n\r\n    if (typeof query === 'string') {\r\n      const embeddingResult = await this.embed(query);\r\n      if (embeddingResult.vector.every((v) => v === 0)) {\r\n        this.logger.warn('Embedding generation failed, returning empty search results');\r\n        return [];\r\n      }\r\n      queryVector = embeddingResult.vector;\r\n    } else {\r\n      queryVector = query;\r\n    }\r\n\r\n    try {\r\n      const client = this.qdrantClient.getClient();\r\n\r\n      // Build Qdrant filter for department tags if provided\r\n      const qdrantFilter = filter?.department\r\n        ? {\r\n            must: [\r\n              {\r\n                key: 'departmentTags' as const,\r\n                match: { any: [String(filter.department)] },\r\n              },\r\n            ],\r\n          }\r\n        : undefined;\r\n\r\n      const results = await client.search(this.COLLECTION_NAME, {\r\n        vector: queryVector,\r\n        limit,\r\n        filter: qdrantFilter,\r\n        with_payload: true,\r\n      });\r\n\r\n      this.logger.debug({\r\n        message: 'Semantic search completed via Qdrant',\r\n        resultCount: results.length,\r\n        topScore: results.length > 0 ? (results[0]?.score ?? null) : null,\r\n        hasDepartmentFilter: !!filter?.department,\r\n      });\r\n\r\n      return results.map((r) => ({\r\n        conceptId: (r.payload?.['conceptId'] as string) ?? '',\r\n        score: r.score,\r\n        name: (r.payload?.['name'] as string) ?? '',\r\n      }));\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Qdrant semantic search failed',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes an embedding from the Qdrant collection.\r\n   */\r\n  async delete(embeddingId: string): Promise<void> {\r\n    if (!this.qdrantClient.isAvailable()) return;\r\n\r\n    try {\r\n      const client = this.qdrantClient.getClient();\r\n      await client.delete(this.COLLECTION_NAME, {\r\n        wait: true,\r\n        points: [embeddingId],\r\n      });\r\n\r\n      this.logger.debug({\r\n        message: 'Embedding deleted from Qdrant',\r\n        pointId: embeddingId,\r\n      });\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to delete embedding from Qdrant',\r\n        pointId: embeddingId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deterministic UUID from conceptId using MD5 hash.\r\n   * Ensures re-seeding overwrites the same point rather than creating duplicates.\r\n   */\r\n  private conceptIdToUuid(conceptId: string): string {\r\n    const hash = createHash('md5').update(conceptId).digest('hex');\r\n    return [\r\n      hash.slice(0, 8),\r\n      hash.slice(8, 12),\r\n      hash.slice(12, 16),\r\n      hash.slice(16, 20),\r\n      hash.slice(20, 32),\r\n    ].join('-');\r\n  }\r\n}\r\n","import { Injectable, Logger, OnModuleInit } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { QdrantClient } from '@qdrant/js-client-rest';\r\n\r\n/**\r\n * Shared Qdrant client service.\r\n * Provides a singleton QdrantClient instance and collection management utilities.\r\n * Used by EmbeddingService (concepts) and MemoryEmbeddingService (memories).\r\n */\r\n@Injectable()\r\nexport class QdrantClientService implements OnModuleInit {\r\n  private readonly logger = new Logger(QdrantClientService.name);\r\n  private client: QdrantClient | null = null;\r\n\r\n  constructor(private readonly configService: ConfigService) {}\r\n\r\n  async onModuleInit(): Promise<void> {\r\n    const url = this.configService.get<string>('QDRANT_URL');\r\n    const apiKey = this.configService.get<string>('QDRANT_API_KEY');\r\n\r\n    if (!url) {\r\n      this.logger.warn('QDRANT_URL not configured  vector operations will be unavailable');\r\n      return;\r\n    }\r\n\r\n    this.client = new QdrantClient({ url, apiKey: apiKey || undefined });\r\n    this.logger.log({ message: 'Qdrant client initialized', url });\r\n  }\r\n\r\n  /**\r\n   * Returns the Qdrant client instance.\r\n   * @throws Error if QDRANT_URL was not configured\r\n   */\r\n  getClient(): QdrantClient {\r\n    if (!this.client) {\r\n      throw new Error('Qdrant client not initialized. Check QDRANT_URL env var.');\r\n    }\r\n    return this.client;\r\n  }\r\n\r\n  /**\r\n   * Returns true if Qdrant is configured and available.\r\n   */\r\n  isAvailable(): boolean {\r\n    return this.client !== null;\r\n  }\r\n\r\n  /**\r\n   * Ensures a collection exists with the specified vector configuration.\r\n   * Idempotent  no-ops if the collection already exists.\r\n   *\r\n   * @param name - Collection name\r\n   * @param size - Vector dimension size\r\n   * @param distance - Distance metric (default: Cosine)\r\n   */\r\n  /**\r\n   * Deletes and recreates a collection with new vector configuration.\r\n   * Use when vector dimensions change (e.g. switching embedding models).\r\n   */\r\n  async recreateCollection(\r\n    name: string,\r\n    size: number,\r\n    distance: 'Cosine' | 'Euclid' | 'Dot' = 'Cosine'\r\n  ): Promise<void> {\r\n    const client = this.getClient();\r\n\r\n    try {\r\n      await client.deleteCollection(name);\r\n      this.logger.log({ message: 'Deleted Qdrant collection', name });\r\n    } catch {\r\n      // Collection doesn't exist  that's fine\r\n    }\r\n\r\n    await client.createCollection(name, {\r\n      vectors: { size, distance },\r\n    });\r\n    this.logger.log({ message: 'Created Qdrant collection', name, size, distance });\r\n  }\r\n\r\n  async ensureCollection(\r\n    name: string,\r\n    size: number,\r\n    distance: 'Cosine' | 'Euclid' | 'Dot' = 'Cosine'\r\n  ): Promise<void> {\r\n    const client = this.getClient();\r\n\r\n    const collections = await client.getCollections();\r\n    const exists = collections.collections.some((c) => c.name === name);\r\n\r\n    if (!exists) {\r\n      await client.createCollection(name, {\r\n        vectors: { size, distance },\r\n      });\r\n      this.logger.log({ message: 'Qdrant collection created', name, size, distance });\r\n    } else {\r\n      this.logger.debug({ message: 'Qdrant collection already exists', name });\r\n    }\r\n  }\r\n}\r\n","module.exports = require(\"@qdrant/js-client-rest\");","import { Injectable, Logger } from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport type {\r\n  ConceptMatch,\r\n  ConceptCitation,\r\n  CitationInjectionResult,\r\n  ConceptCategory,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Service for injecting concept citations into AI responses.\r\n * Creates inline [[Concept Name]] markers and generates citation records.\r\n *\r\n * @example\r\n * ```typescript\r\n * const result = citationInjector.injectCitations(\r\n *   \"Consider using value-based pricing for premium products.\",\r\n *   [{ conceptId: \"cpt_123\", conceptName: \"Value-Based Pricing\", ... }]\r\n * );\r\n * // result.content = \"Consider using value-based pricing [[Value-Based Pricing]] for premium products.\"\r\n * ```\r\n */\r\n@Injectable()\r\nexport class CitationInjectorService {\r\n  private readonly logger = new Logger(CitationInjectorService.name);\r\n\r\n  /** Maximum number of citations to inject per response */\r\n  private readonly MAX_CITATIONS = 5;\r\n\r\n  /**\r\n   * Injects concept citations into a response text.\r\n   * Citations are placed at relevant positions in the text.\r\n   *\r\n   * @param response - The AI response text to inject citations into\r\n   * @param concepts - Array of matching concepts to cite\r\n   * @param messageId - Optional message ID to associate citations with (set later if not provided)\r\n   * @returns Object containing modified content and citation records\r\n   */\r\n  injectCitations(\r\n    response: string,\r\n    concepts: ConceptMatch[],\r\n    messageId = ''\r\n  ): CitationInjectionResult {\r\n    if (concepts.length === 0) {\r\n      this.logger.debug({\r\n        message: 'No concepts to inject',\r\n        responseLength: response.length,\r\n      });\r\n      return { content: response, citations: [] };\r\n    }\r\n\r\n    // Sort by relevance (highest score first) and limit\r\n    const sortedConcepts = [...concepts]\r\n      .sort((a, b) => b.score - a.score)\r\n      .slice(0, this.MAX_CITATIONS);\r\n\r\n    this.logger.debug({\r\n      message: 'Injecting citations',\r\n      conceptCount: sortedConcepts.length,\r\n      responseLength: response.length,\r\n    });\r\n\r\n    let content = response;\r\n    const citations: ConceptCitation[] = [];\r\n    const usedPositions = new Set<number>();\r\n\r\n    for (const concept of sortedConcepts) {\r\n      const insertionResult = this.findAndInsertCitation(\r\n        content,\r\n        concept,\r\n        usedPositions\r\n      );\r\n\r\n      if (insertionResult) {\r\n        content = insertionResult.content;\r\n        usedPositions.add(insertionResult.position);\r\n\r\n        citations.push({\r\n          id: `cit_${createId()}`,\r\n          messageId,\r\n          conceptId: concept.conceptId,\r\n          conceptName: concept.conceptName,\r\n          conceptCategory: concept.category,\r\n          position: insertionResult.position,\r\n          score: concept.score,\r\n          createdAt: new Date().toISOString(),\r\n        });\r\n\r\n        this.logger.debug({\r\n          message: 'Citation injected',\r\n          conceptName: concept.conceptName,\r\n          position: insertionResult.position,\r\n        });\r\n      }\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Citations injection complete',\r\n      citationsAdded: citations.length,\r\n      originalLength: response.length,\r\n      newLength: content.length,\r\n    });\r\n\r\n    return { content, citations };\r\n  }\r\n\r\n  /**\r\n   * Finds an appropriate insertion point and inserts the citation.\r\n   *\r\n   * @param content - Current content\r\n   * @param concept - Concept to insert\r\n   * @param usedPositions - Set of already used positions\r\n   * @returns Modified content and position, or null if no suitable position found\r\n   */\r\n  private findAndInsertCitation(\r\n    content: string,\r\n    concept: ConceptMatch,\r\n    usedPositions: Set<number>\r\n  ): { content: string; position: number } | null {\r\n    // Strategy 1: Find concept name mentioned in text (case-insensitive)\r\n    const namePattern = new RegExp(\r\n      this.escapeRegex(concept.conceptName),\r\n      'gi'\r\n    );\r\n    const nameMatch = namePattern.exec(content);\r\n\r\n    if (nameMatch) {\r\n      const endPosition = nameMatch.index + nameMatch[0].length;\r\n\r\n      // Check if citation already exists at this position\r\n      if (!this.hasCitationAt(content, endPosition)) {\r\n        const citation = ` [[${concept.conceptName}]]`;\r\n        return {\r\n          content:\r\n            content.slice(0, endPosition) + citation + content.slice(endPosition),\r\n          position: endPosition,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Strategy 2: Find related keywords from concept name\r\n    const keywords = concept.conceptName\r\n      .toLowerCase()\r\n      .split(/[\\s-]+/)\r\n      .filter((w) => w.length >= 4);\r\n\r\n    for (const keyword of keywords) {\r\n      const keywordPattern = new RegExp(`\\\\b${this.escapeRegex(keyword)}\\\\b`, 'gi');\r\n      let match: RegExpExecArray | null;\r\n\r\n      while ((match = keywordPattern.exec(content)) !== null) {\r\n        // Find end of sentence containing this keyword\r\n        const sentenceEnd = this.findSentenceEnd(content, match.index);\r\n\r\n        if (\r\n          sentenceEnd !== -1 &&\r\n          !usedPositions.has(sentenceEnd) &&\r\n          !this.hasCitationAt(content, sentenceEnd)\r\n        ) {\r\n          const citation = ` [[${concept.conceptName}]]`;\r\n          return {\r\n            content:\r\n              content.slice(0, sentenceEnd) +\r\n              citation +\r\n              content.slice(sentenceEnd),\r\n            position: sentenceEnd,\r\n          };\r\n        }\r\n      }\r\n    }\r\n\r\n    // Strategy 3: Find end of first paragraph if no keyword match\r\n    const firstParagraphEnd = content.indexOf('\\n\\n');\r\n    if (firstParagraphEnd !== -1 && !usedPositions.has(firstParagraphEnd)) {\r\n      // Insert at end of first paragraph\r\n      const sentenceEnd = this.findSentenceEnd(content, 0);\r\n      if (\r\n        sentenceEnd !== -1 &&\r\n        sentenceEnd < firstParagraphEnd &&\r\n        !this.hasCitationAt(content, sentenceEnd)\r\n      ) {\r\n        const citation = ` [[${concept.conceptName}]]`;\r\n        return {\r\n          content:\r\n            content.slice(0, sentenceEnd) + citation + content.slice(sentenceEnd),\r\n          position: sentenceEnd,\r\n        };\r\n      }\r\n    }\r\n\r\n    // No suitable position found\r\n    this.logger.debug({\r\n      message: 'No suitable position found for citation',\r\n      conceptName: concept.conceptName,\r\n    });\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Finds the end of the sentence containing the given position.\r\n   *\r\n   * @param content - The text content\r\n   * @param startPosition - Position to search from\r\n   * @returns Position of sentence end (before period/question mark), or -1 if not found\r\n   */\r\n  private findSentenceEnd(content: string, startPosition: number): number {\r\n    const sentenceEnders = /[.!?]/;\r\n    let position = startPosition;\r\n\r\n    while (position < content.length) {\r\n      const char = content.charAt(position);\r\n      if (sentenceEnders.test(char)) {\r\n        return position;\r\n      }\r\n      position++;\r\n    }\r\n\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n   * Checks if there's already a citation at the given position.\r\n   */\r\n  private hasCitationAt(content: string, position: number): boolean {\r\n    const ahead = content.slice(position, position + 10);\r\n    return ahead.includes('[[') || ahead.trimStart().startsWith('[[');\r\n  }\r\n\r\n  /**\r\n   * Escapes special regex characters in a string.\r\n   */\r\n  private escapeRegex(str: string): string {\r\n    return str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n  }\r\n\r\n  /**\r\n   * Parses existing citations from message content.\r\n   * Used for display purposes in the frontend.\r\n   *\r\n   * @param content - Message content with [[Citation]] markers\r\n   * @returns Array of citation markers found\r\n   */\r\n  parseCitations(content: string): Array<{ name: string; position: number }> {\r\n    const citations: Array<{ name: string; position: number }> = [];\r\n    const pattern = /\\[\\[([^\\]]+)\\]\\]/g;\r\n    let match: RegExpExecArray | null;\r\n\r\n    while ((match = pattern.exec(content)) !== null) {\r\n      const name = match[1];\r\n      if (name) {\r\n        citations.push({\r\n          name,\r\n          position: match.index,\r\n        });\r\n      }\r\n    }\r\n\r\n    return citations;\r\n  }\r\n\r\n  /**\r\n   * Removes citation markers from content for plain text display.\r\n   *\r\n   * @param content - Content with [[Citation]] markers\r\n   * @returns Plain content without citation markers\r\n   */\r\n  stripCitations(content: string): string {\r\n    return content.replace(/\\s*\\[\\[[^\\]]+\\]\\]/g, '');\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { AiGatewayService } from '../../ai-gateway/ai-gateway.service';\r\nimport { ConceptService } from './concept.service';\r\nimport type {\r\n  ConceptExtractionResult,\r\n  ConceptSummary,\r\n  ConceptCategory,\r\n  ChatMessage,\r\n} from '@mentor-ai/shared/types';\r\nimport {\r\n  buildConceptExtractionPrompt,\r\n  parseExtractionResponse,\r\n} from '../templates/extraction-prompt';\r\n\r\n/** Context for concept extraction */\r\nexport interface ExtractionContext {\r\n  conversationId?: string;\r\n  conceptId?: string;\r\n  maxNew?: number;\r\n}\r\n\r\n/** Default maximum concepts per extraction call */\r\nconst DEFAULT_MAX_NEW = 5;\r\n\r\n/**\r\n * Generic service for extracting new business concepts from AI output text.\r\n * Creates concepts in the database and triggers relationship linking.\r\n *\r\n * Used by both manual chat (conversation.gateway.ts) and YOLO workflow\r\n * (yolo-scheduler.service.ts).\r\n *\r\n * Story 2.15: AI-Driven Concept Discovery and Creation\r\n */\r\n@Injectable()\r\nexport class ConceptExtractionService {\r\n  private readonly logger = new Logger(ConceptExtractionService.name);\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly aiGateway: AiGatewayService,\r\n    private readonly conceptService: ConceptService,\r\n  ) {}\r\n\r\n  /**\r\n   * Extracts new business concepts from AI output text, validates them,\r\n   * creates them in the database, and triggers relationship linking.\r\n   *\r\n   * @param aiOutput - The AI-generated text to analyze\r\n   * @param context - Optional context (conversationId, conceptId, maxNew cap)\r\n   * @returns Result with created concepts, skipped duplicates, and errors\r\n   */\r\n  async extractAndCreateConcepts(\r\n    aiOutput: string,\r\n    context: ExtractionContext = {},\r\n  ): Promise<ConceptExtractionResult> {\r\n    const result: ConceptExtractionResult = {\r\n      created: [],\r\n      skippedDuplicates: [],\r\n      errors: [],\r\n    };\r\n\r\n    const maxNew = context.maxNew ?? DEFAULT_MAX_NEW;\r\n\r\n    try {\r\n      // 1. Get existing concept names for deduplication in the prompt\r\n      const existingConcepts = await this.prisma.concept.findMany({\r\n        select: { name: true },\r\n        orderBy: { name: 'asc' },\r\n      });\r\n      const existingNames = existingConcepts.map((c) => c.name);\r\n\r\n      // 2. Call LLM to extract concept candidates\r\n      const prompt = buildConceptExtractionPrompt(aiOutput, existingNames, maxNew);\r\n      const messages: ChatMessage[] = [{ role: 'user', content: prompt }];\r\n\r\n      let fullResponse = '';\r\n      await this.aiGateway.streamCompletion(messages, (chunk) => {\r\n        fullResponse += chunk;\r\n      });\r\n\r\n      // 3. Parse and validate candidates\r\n      const candidates = parseExtractionResponse(fullResponse);\r\n\r\n      if (candidates.length === 0) {\r\n        this.logger.debug({ message: 'No new concepts extracted from AI output' });\r\n        return result;\r\n      }\r\n\r\n      // 4. Process each candidate (up to maxNew)\r\n      const toProcess = candidates.slice(0, maxNew);\r\n\r\n      for (const candidate of toProcess) {\r\n        // Duplicate check: case-insensitive name lookup\r\n        const existing = await this.conceptService.findByName(candidate.name);\r\n        if (existing) {\r\n          result.skippedDuplicates.push(candidate.name);\r\n          this.logger.debug({\r\n            message: 'Skipped duplicate concept',\r\n            name: candidate.name,\r\n            existingId: existing.id,\r\n          });\r\n          continue;\r\n        }\r\n\r\n        // Create concept in DB\r\n        try {\r\n          const slug = this.generateSlug(candidate.name);\r\n          const conceptId = `cpt_${createId()}`;\r\n\r\n          const newConcept = await this.prisma.concept.create({\r\n            data: {\r\n              id: conceptId,\r\n              name: candidate.name,\r\n              slug,\r\n              category: candidate.category,\r\n              definition: candidate.definition,\r\n              departmentTags: candidate.departmentTags,\r\n              source: 'AI_DISCOVERED',\r\n              version: 1,\r\n            },\r\n          });\r\n\r\n          const summary: ConceptSummary = {\r\n            id: newConcept.id,\r\n            name: newConcept.name,\r\n            slug: newConcept.slug,\r\n            category: newConcept.category as ConceptCategory,\r\n            definition: newConcept.definition,\r\n          };\r\n          result.created.push(summary);\r\n\r\n          this.logger.log({\r\n            message: 'AI-discovered concept created',\r\n            conceptId: newConcept.id,\r\n            name: newConcept.name,\r\n            category: newConcept.category,\r\n          });\r\n\r\n          // Trigger relationship linking (non-blocking, fire-and-forget)\r\n          // Deviation: uses .then()/.catch() instead of async/await per project-context.md rule\r\n          // \"Always use async/await over raw Promises\". Rationale: relationship creation is\r\n          // optional post-processing; failure must not block concept creation or return an\r\n          // error to the caller. See AC6 for fire-and-forget requirement.\r\n          this.conceptService\r\n            .createDynamicRelationships(newConcept.id, newConcept.name, newConcept.category)\r\n            .then((relResult) => {\r\n              if (relResult.relationshipsCreated < 2) {\r\n                this.logger.warn({\r\n                  message: 'Fewer than 2 relationships created for AI-discovered concept (AC3)',\r\n                  conceptId: newConcept.id,\r\n                  conceptName: newConcept.name,\r\n                  relationshipsCreated: relResult.relationshipsCreated,\r\n                });\r\n              }\r\n            })\r\n            .catch((err) => {\r\n              this.logger.warn({\r\n                message: 'Relationship creation failed for AI-discovered concept',\r\n                conceptId: newConcept.id,\r\n                error: err instanceof Error ? err.message : 'Unknown',\r\n              });\r\n            });\r\n        } catch (err) {\r\n          // Handle unique constraint or other DB errors gracefully\r\n          const errMsg = err instanceof Error ? err.message : 'Unknown error';\r\n          if (errMsg.includes('Unique constraint')) {\r\n            result.skippedDuplicates.push(candidate.name);\r\n            this.logger.debug({\r\n              message: 'Concept skipped due to unique constraint',\r\n              name: candidate.name,\r\n            });\r\n          } else {\r\n            result.errors.push(`Failed to create \"${candidate.name}\": ${errMsg}`);\r\n            this.logger.warn({\r\n              message: 'Failed to create AI-discovered concept',\r\n              name: candidate.name,\r\n              error: errMsg,\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      this.logger.log({\r\n        message: 'Concept extraction complete',\r\n        created: result.created.length,\r\n        skipped: result.skippedDuplicates.length,\r\n        errors: result.errors.length,\r\n      });\r\n    } catch (err) {\r\n      const errMsg = err instanceof Error ? err.message : 'Unknown error';\r\n      result.errors.push(`Extraction failed: ${errMsg}`);\r\n      this.logger.warn({\r\n        message: 'Concept extraction failed',\r\n        error: errMsg,\r\n      });\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Generates a URL-friendly slug from a concept name.\r\n   * Handles Unicode by stripping diacritics and non-alphanumeric characters.\r\n   */\r\n  private generateSlug(name: string): string {\r\n    return name\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '') // Strip diacritics\r\n      .toLowerCase()\r\n      .replace(/[^a-z0-9]+/g, '-')\r\n      .replace(/^-|-$/g, '');\r\n  }\r\n}\r\n","/**\r\n * LLM prompt template for extracting new business concepts from AI output text.\r\n *\r\n * Story 2.15: AI-Driven Concept Discovery and Creation\r\n */\r\n\r\n/** Valid concept categories  must match actual DB values from Obsidian vault */\r\nconst VALID_CATEGORIES = [\r\n  'Uvod u Poslovanje',\r\n  'Marketing',\r\n  'Prodaja',\r\n  'Vrednost',\r\n  'Finansije',\r\n  'Operacije',\r\n  'Menadment',\r\n  'Preduzetnitvo',\r\n  'Digitalni Marketing',\r\n  'Odnosi sa Klijentima',\r\n  'Raunovodstvo',\r\n  'Tehnologija',\r\n  'Inovacije',\r\n  'Liderstvo',\r\n  'Strategija',\r\n  'Poslovni Modeli',\r\n] as const;\r\n\r\n/** Candidate concept extracted by the LLM */\r\nexport interface ExtractedConceptCandidate {\r\n  name: string;\r\n  category: string;\r\n  definition: string;\r\n  departmentTags: string[];\r\n}\r\n\r\n/**\r\n * Builds the prompt for extracting new business concepts from AI output.\r\n *\r\n * @param aiOutput - The AI-generated text to analyze\r\n * @param existingNames - Names of concepts already in the database (to avoid re-extraction)\r\n * @param maxConcepts - Maximum number of concepts to extract (default: 5)\r\n */\r\nexport function buildConceptExtractionPrompt(\r\n  aiOutput: string,\r\n  existingNames: string[],\r\n  maxConcepts = 5\r\n): string {\r\n  const existingList =\r\n    existingNames.length > 0\r\n      ? `\\nPOSTOJEI KONCEPTI (NE ekstrahuj ove):\\n${existingNames.join(', ')}\\n`\r\n      : '';\r\n\r\n  return `Ti si kurator baze poslovnog znanja. Analiziraj sledei AI-generisani tekst i identifikuj nove poslovne koncepte koji NISU ve u bazi znanja.\r\n\r\nTEKST ZA ANALIZU:\r\n\"\"\"\r\n${aiOutput}\r\n\"\"\"\r\n${existingList}\r\nVALIDNE KATEGORIJE: ${VALID_CATEGORIES.join(', ')}\r\n\r\nPRAVILA:\r\n- Ekstrahuj samo jasno definisane poslovne koncepte (okviri, metodologije, strategije, alati, procesi, metrike).\r\n- NE ekstrahuj generike pojmove (npr. \"poslovanje\", \"rast\", \"uspeh\") ili vlastita imena (firme, osobe).\r\n- NE ekstrahuj koncepte koji ve postoje u listi iznad.\r\n- Svaki koncept mora imati jasnu, specifinu definiciju od minimum 15 rei na srpskom jeziku.\r\n- Dodeli najadekvatniju kategoriju iz liste validnih kategorija.\r\n- Department tags treba da odgovaraju relevantnim odeljenjima: FINANCE, MARKETING, TECHNOLOGY, OPERATIONS, LEGAL, CREATIVE, STRATEGY, SALES.\r\n- Ekstrahuj najvie ${maxConcepts} konceptata. Prioritizuj najspecifinije i najkorisnije.\r\n- Ako nema novih koncepata, vrati prazan niz.\r\n- Naziv koncepta pii na srpskom (ili engleski ako je to ustaljen termin, npr. \"Lean Startup\", \"OKR\").\r\n- Definiciju UVEK pii na srpskom jeziku.\r\n\r\nVrati SAMO validan JSON niz (bez markdown-a, bez objanjenja):\r\n[{\"name\": \"Naziv Koncepta\", \"category\": \"Kategorija\", \"definition\": \"Jasna definicija koncepta na srpskom jeziku.\", \"departmentTags\": [\"STRATEGY\", \"FINANCE\"]}]\r\n\r\nAko nema novih koncepata, vrati: []`;\r\n}\r\n\r\n/**\r\n * Parses the LLM response into extracted concept candidates.\r\n * Validates each candidate against known categories and minimum quality.\r\n */\r\nexport function parseExtractionResponse(response: string): ExtractedConceptCandidate[] {\r\n  try {\r\n    // Extract outermost JSON array from response (greedy: first '[' to last ']')\r\n    const jsonMatch = response.match(/\\[[\\s\\S]*\\]/);\r\n    if (!jsonMatch) return [];\r\n\r\n    const parsed = JSON.parse(jsonMatch[0]) as unknown[];\r\n    if (!Array.isArray(parsed)) return [];\r\n\r\n    const validCategorySet = new Set<string>(VALID_CATEGORIES);\r\n\r\n    return parsed\r\n      .filter(\r\n        (item): item is Record<string, unknown> =>\r\n          typeof item === 'object' &&\r\n          item !== null &&\r\n          typeof (item as Record<string, unknown>).name === 'string' &&\r\n          typeof (item as Record<string, unknown>).category === 'string' &&\r\n          typeof (item as Record<string, unknown>).definition === 'string'\r\n      )\r\n      .filter((item) => {\r\n        const name = item.name as string;\r\n        const category = item.category as string;\r\n        const definition = item.definition as string;\r\n\r\n        // Validate category\r\n        if (!validCategorySet.has(category)) return false;\r\n        // Validate minimum definition quality (10+ chars AND 3+ words)\r\n        if (definition.length < 10) return false;\r\n        if (definition.trim().split(/\\s+/).length < 3) return false;\r\n        // Validate name is not empty\r\n        if (name.trim().length === 0) return false;\r\n\r\n        return true;\r\n      })\r\n      .map((item) => ({\r\n        name: (item.name as string).trim(),\r\n        category: item.category as string,\r\n        definition: (item.definition as string).trim(),\r\n        departmentTags: Array.isArray(item.departmentTags)\r\n          ? (item.departmentTags as unknown[]).filter((t): t is string => typeof t === 'string')\r\n          : [],\r\n      }));\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n","/**\r\n * Brain Seeding Service (Story 3.2)\r\n *\r\n * Creates initial PENDING task Notes for a new user based on their department.\r\n * Seeds the Business Brain tree with concepts the user should explore.\r\n */\r\n\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { NoteSource, NoteType, NoteStatus } from '@mentor-ai/shared/prisma';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport {\r\n  getVisibleCategories,\r\n  FOUNDATION_CATEGORIES,\r\n  ALL_CATEGORIES,\r\n} from '../config/department-categories';\r\n\r\n@Injectable()\r\nexport class BrainSeedingService {\r\n  private readonly logger = new Logger(BrainSeedingService.name);\r\n\r\n  /** Max concepts to seed per category for owner initial run */\r\n  private readonly OWNER_KEY_CONCEPTS_PER_CATEGORY = 4;\r\n  /** Max total seed tasks for owner */\r\n  private readonly OWNER_MAX_SEED_TOTAL = 40;\r\n  /** Max total seed tasks for department user */\r\n  private readonly DEPT_MAX_SEED_TOTAL = 30;\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  /**\r\n   * Seeds PENDING task Notes for a new user.\r\n   * Idempotent  skips if user already has pending tasks.\r\n   *\r\n   * For department users: seeds all concepts in visible categories.\r\n   * For PLATFORM_OWNER / TENANT_OWNER: seeds foundation fully + key concepts per category.\r\n   */\r\n  async seedPendingTasksForUser(\r\n    userId: string,\r\n    tenantId: string,\r\n    department: string | null,\r\n    role: string\r\n  ): Promise<{ seeded: number }> {\r\n    // Idempotency guard: skip if user already has any concept task notes (any status)\r\n    const existingCount = await this.prisma.note.count({\r\n      where: {\r\n        userId,\r\n        tenantId,\r\n        noteType: NoteType.TASK,\r\n        conceptId: { not: null },\r\n      },\r\n    });\r\n\r\n    if (existingCount > 0) {\r\n      this.logger.log({\r\n        message: 'Skipping brain seeding  user already has task notes',\r\n        userId,\r\n        tenantId,\r\n        existingCount,\r\n      });\r\n      return { seeded: 0 };\r\n    }\r\n\r\n    const isOwner = role === 'PLATFORM_OWNER' || role === 'TENANT_OWNER' || !department;\r\n\r\n    let conceptsToSeed: Array<{ id: string; name: string; category: string }>;\r\n\r\n    if (isOwner) {\r\n      conceptsToSeed = await this.getOwnerSeedConcepts();\r\n    } else {\r\n      conceptsToSeed = await this.getDepartmentSeedConcepts(department, role);\r\n    }\r\n\r\n    if (conceptsToSeed.length === 0) {\r\n      this.logger.warn({\r\n        message: 'No concepts found for brain seeding',\r\n        userId,\r\n        tenantId,\r\n        department,\r\n      });\r\n      return { seeded: 0 };\r\n    }\r\n\r\n    // Batch create PENDING task Notes\r\n    const noteData = conceptsToSeed.map((concept) => ({\r\n      id: `note_${createId()}`,\r\n      title: concept.name,\r\n      content: `Istrai koncept: ${concept.name}`,\r\n      source: NoteSource.ONBOARDING,\r\n      noteType: NoteType.TASK,\r\n      status: NoteStatus.PENDING,\r\n      conceptId: concept.id,\r\n      userId,\r\n      tenantId,\r\n    }));\r\n\r\n    await this.prisma.note.createMany({ data: noteData });\r\n\r\n    this.logger.log({\r\n      message: 'Brain seeding complete',\r\n      userId,\r\n      tenantId,\r\n      department,\r\n      role,\r\n      seeded: noteData.length,\r\n      categories: [...new Set(conceptsToSeed.map((c) => c.category))],\r\n    });\r\n\r\n    return { seeded: noteData.length };\r\n  }\r\n\r\n  /**\r\n   * Owner seed: foundation categories fully + key concepts per other category.\r\n   */\r\n  private async getOwnerSeedConcepts(): Promise<\r\n    Array<{ id: string; name: string; category: string }>\r\n  > {\r\n    // Seed all foundation concepts\r\n    const foundationConcepts = await this.prisma.concept.findMany({\r\n      where: {\r\n        category: { in: [...FOUNDATION_CATEGORIES] },\r\n      },\r\n      select: { id: true, name: true, category: true },\r\n      orderBy: { sortOrder: 'asc' },\r\n    });\r\n\r\n    // Seed key concepts from other categories (first N per category)\r\n    const otherCategories = (ALL_CATEGORIES as readonly string[]).filter(\r\n      (c) => !(FOUNDATION_CATEGORIES as readonly string[]).includes(c)\r\n    );\r\n\r\n    // Single query for all non-foundation concepts, then slice per category client-side\r\n    const allOtherConcepts = await this.prisma.concept.findMany({\r\n      where: { category: { in: [...otherCategories] } },\r\n      select: { id: true, name: true, category: true, sortOrder: true },\r\n      orderBy: { sortOrder: 'asc' },\r\n    });\r\n\r\n    const otherConcepts: Array<{ id: string; name: string; category: string }> = [];\r\n    const seenPerCategory = new Map<string, number>();\r\n    for (const concept of allOtherConcepts) {\r\n      const count = seenPerCategory.get(concept.category) ?? 0;\r\n      if (count < this.OWNER_KEY_CONCEPTS_PER_CATEGORY) {\r\n        otherConcepts.push({ id: concept.id, name: concept.name, category: concept.category });\r\n        seenPerCategory.set(concept.category, count + 1);\r\n      }\r\n    }\r\n\r\n    const combined = [...foundationConcepts, ...otherConcepts];\r\n    return combined.slice(0, this.OWNER_MAX_SEED_TOTAL);\r\n  }\r\n\r\n  /**\r\n   * Department seed: all concepts in visible categories (foundation + department).\r\n   */\r\n  private async getDepartmentSeedConcepts(\r\n    department: string | null,\r\n    role: string\r\n  ): Promise<Array<{ id: string; name: string; category: string }>> {\r\n    const visibleCategories = getVisibleCategories(department, role);\r\n\r\n    if (!visibleCategories) {\r\n      // No filter = owner path (shouldn't reach here but fallback)\r\n      return this.getOwnerSeedConcepts();\r\n    }\r\n\r\n    const concepts = await this.prisma.concept.findMany({\r\n      where: { category: { in: visibleCategories } },\r\n      select: { id: true, name: true, category: true },\r\n      orderBy: { sortOrder: 'asc' },\r\n      take: this.DEPT_MAX_SEED_TOTAL,\r\n    });\r\n\r\n    return concepts;\r\n  }\r\n}\r\n","/**\r\n * Department  Obsidian Category Mapping (Story 3.2)\r\n *\r\n * Maps the Department enum to Serbian category names from the Obsidian vault.\r\n * Foundation categories are always visible to all users.\r\n * PLATFORM_OWNER / TENANT_OWNER (department = null) see all categories.\r\n */\r\n\r\nimport { Department } from '@mentor-ai/shared/prisma';\r\n\r\n/** Foundation categories  always visible regardless of department */\r\nexport const FOUNDATION_CATEGORIES = ['Uvod u Poslovanje', 'Vrednost'] as const;\r\n\r\n/** All known categories from the Obsidian vault (excluding guide/skipped) */\r\nexport const ALL_CATEGORIES = [\r\n  'Uvod u Poslovanje',\r\n  'Marketing',\r\n  'Prodaja',\r\n  'Vrednost',\r\n  'Finansije',\r\n  'Operacije',\r\n  'Menadment',\r\n  'Preduzetnitvo',\r\n  'Digitalni Marketing',\r\n  'Odnosi sa Klijentima',\r\n  'Raunovodstvo',\r\n  'Tehnologija',\r\n  'Inovacije',\r\n  'Liderstvo',\r\n  'Strategija',\r\n  'Poslovni Modeli',\r\n] as const;\r\n\r\n/**\r\n * Maps each Department enum value to its relevant Obsidian categories.\r\n * Foundation categories are added automatically  do NOT include them here.\r\n */\r\nexport const DEPARTMENT_CATEGORY_MAP: Record<Department, string[]> = {\r\n  [Department.MARKETING]: ['Marketing', 'Digitalni Marketing'],\r\n  [Department.FINANCE]: ['Finansije', 'Raunovodstvo'],\r\n  [Department.SALES]: ['Prodaja', 'Odnosi sa Klijentima'],\r\n  [Department.OPERATIONS]: ['Operacije', 'Preduzetnitvo', 'Menadment'],\r\n  [Department.TECHNOLOGY]: ['Tehnologija', 'Inovacije'],\r\n  [Department.STRATEGY]: ['Strategija', 'Poslovni Modeli', 'Liderstvo'],\r\n  [Department.LEGAL]: ['Menadment'],\r\n  [Department.CREATIVE]: ['Marketing', 'Digitalni Marketing'],\r\n};\r\n\r\n/**\r\n * Resolve visible categories for a user based on department and role.\r\n *\r\n * - PLATFORM_OWNER / TENANT_OWNER (department = null)  ALL categories\r\n * - Department user  foundation + department-specific categories\r\n */\r\nexport function getVisibleCategories(department: string | null, role: string): string[] | null {\r\n  // Owner roles see everything  return null to signal \"no filter\"\r\n  if (role === 'PLATFORM_OWNER' || role === 'TENANT_OWNER' || !department) {\r\n    return null;\r\n  }\r\n\r\n  const deptCategories = DEPARTMENT_CATEGORY_MAP[department as Department] ?? [];\r\n\r\n  // Deduplicate (foundation might overlap with dept categories)\r\n  return [...new Set([...FOUNDATION_CATEGORIES, ...deptCategories])];\r\n}\r\n","/**\r\n * Business Context Service (Story 3.2)\r\n *\r\n * Aggregates ALL memories for a tenant (across all users and domains)\r\n * into a structured context block for injection into LLM system prompts.\r\n *\r\n * This is the \"shared brain\"  every concept execution receives the full\r\n * accumulated business knowledge, regardless of which user or department\r\n * created it.\r\n */\r\n\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\n\r\n/** Approximate characters per token for estimation */\r\nconst CHARS_PER_TOKEN = 4;\r\n\r\n/** Max tokens for the business context section in the system prompt.\r\n *  Reduced from 4000 to 1500 to fit within 8K context window models. */\r\nconst MAX_CONTEXT_TOKENS = 1500;\r\n\r\n@Injectable()\r\nexport class BusinessContextService {\r\n  private readonly logger = new Logger(BusinessContextService.name);\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  /**\r\n   * Loads and formats all business memories for a tenant.\r\n   * Returns a structured text block ready for system prompt injection.\r\n   *\r\n   * Groups memories by type and includes attribution.\r\n   * Truncates to ~4000 tokens.\r\n   */\r\n  async getBusinessContext(tenantId: string): Promise<string> {\r\n    const memories = await this.prisma.memory.findMany({\r\n      where: {\r\n        tenantId,\r\n        isDeleted: false,\r\n      },\r\n      select: {\r\n        type: true,\r\n        content: true,\r\n        subject: true,\r\n        userId: true,\r\n        createdAt: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 100, // Cap to prevent excessive load\r\n    });\r\n\r\n    if (memories.length === 0) {\r\n      return '';\r\n    }\r\n\r\n    // Group by type\r\n    const grouped = new Map<string, typeof memories>();\r\n    for (const mem of memories) {\r\n      const key = mem.type;\r\n      if (!grouped.has(key)) grouped.set(key, []);\r\n      grouped.get(key)!.push(mem);\r\n    }\r\n\r\n    // Build formatted context\r\n    let context = '\\n--- POSLOVNI KONTEKST (Business Brain Memorija) ---\\n';\r\n    let tokenCount = this.estimateTokens(context);\r\n    const maxContentTokens = MAX_CONTEXT_TOKENS - 100;\r\n\r\n    const typeLabels: Record<string, string> = {\r\n      CLIENT_CONTEXT: 'Klijent',\r\n      PROJECT_CONTEXT: 'Poslovni uvid',\r\n      USER_PREFERENCE: 'Odluka',\r\n      FACTUAL_STATEMENT: 'Poslovna injenica',\r\n    };\r\n\r\n    for (const [type, mems] of grouped) {\r\n      const label = typeLabels[type] || type;\r\n      const sectionHeader = `\\n[${label}]\\n`;\r\n      const headerTokens = this.estimateTokens(sectionHeader);\r\n\r\n      if (tokenCount + headerTokens > maxContentTokens) break;\r\n\r\n      context += sectionHeader;\r\n      tokenCount += headerTokens;\r\n\r\n      for (const mem of mems) {\r\n        const subjectPart = mem.subject ? ` (${mem.subject})` : '';\r\n        const line = `- ${mem.content}${subjectPart}\\n`;\r\n        const lineTokens = this.estimateTokens(line);\r\n\r\n        if (tokenCount + lineTokens > maxContentTokens) break;\r\n\r\n        context += line;\r\n        tokenCount += lineTokens;\r\n      }\r\n    }\r\n\r\n    context += '--- KRAJ POSLOVNOG KONTEKSTA ---\\n\\n';\r\n    context +=\r\n      'Koristi ovaj kontekst da da odgovore prilagoene specifinom poslovanju korisnika. ';\r\n    context += 'Referii se na prethodne analize i odluke kada je relevantno.\\n';\r\n\r\n    this.logger.debug({\r\n      message: 'Business context built',\r\n      tenantId,\r\n      memoriesIncluded: memories.length,\r\n      estimatedTokens: this.estimateTokens(context),\r\n    });\r\n\r\n    return context;\r\n  }\r\n\r\n  private estimateTokens(text: string): number {\r\n    return Math.ceil(text.length / CHARS_PER_TOKEN);\r\n  }\r\n}\r\n","/**\r\n * Concept Relevance Service (Story 3.3 AC5)\r\n *\r\n * Rule-based business relevance scoring for concept discovery.\r\n * DISTINCT from ConceptMatchingService (embedding-based vector similarity).\r\n *\r\n * Evaluates whether a candidate concept is relevant for a specific tenant\r\n * based on industry match, department alignment, relationship type, and prior activity.\r\n */\r\n\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { FOUNDATION_CATEGORIES, DEPARTMENT_CATEGORY_MAP } from '../config/department-categories';\r\n\r\n/** Relationship types ordered by discovery priority */\r\ntype RelationshipType = 'PREREQUISITE' | 'RELATED' | 'ADVANCED';\r\n\r\n/** Input for relevance scoring */\r\nexport interface RelevanceInput {\r\n  conceptCategory: string;\r\n  tenantIndustry: string;\r\n  completedConceptIds: Set<string>;\r\n  /** Categories where the user has prior completed concepts (domain-specific scoring) */\r\n  completedCategories?: Set<string>;\r\n  department: string | null;\r\n  role: string;\r\n  relationshipType?: RelationshipType;\r\n}\r\n\r\n/** Scoring weights */\r\nconst WEIGHTS = {\r\n  INDUSTRY: 0.3,\r\n  DEPARTMENT: 0.3,\r\n  RELATIONSHIP: 0.25,\r\n  PRIOR_ACTIVITY: 0.15,\r\n};\r\n\r\n/** Relationship type scores */\r\nconst RELATIONSHIP_SCORES: Record<RelationshipType, number> = {\r\n  PREREQUISITE: 1.0,\r\n  RELATED: 0.6,\r\n  ADVANCED: 0.2,\r\n};\r\n\r\n/**\r\n * Maps industries to relevant business concept categories.\r\n * Keywords in tenant industry string matched against category relevance.\r\n */\r\nconst INDUSTRY_CATEGORY_RELEVANCE: Record<string, string[]> = {\r\n  digital: ['Digitalni Marketing', 'Tehnologija', 'Inovacije', 'Marketing'],\r\n  tech: ['Tehnologija', 'Inovacije', 'Digitalni Marketing', 'Sistemi'],\r\n  software: ['Tehnologija', 'Inovacije', 'Digitalni Marketing', 'Sistemi'],\r\n  retail: ['Prodaja', 'Marketing', 'Odnosi sa Klijentima', 'Operacije'],\r\n  ecommerce: ['Digitalni Marketing', 'Prodaja', 'Marketing', 'Tehnologija'],\r\n  finance: ['Finansije', 'Raunovodstvo', 'Strategija'],\r\n  consulting: ['Strategija', 'Menadment', 'Liderstvo', 'Odnosi sa Klijentima'],\r\n  manufacturing: ['Operacije i Proizvodnja', 'Sistemi', 'Menadment'],\r\n  healthcare: ['Operacije', 'Menadment', 'Ljudski Resursi'],\r\n  education: ['Menadment', 'Ljudski Resursi', 'Liderstvo'],\r\n  marketing: ['Marketing', 'Digitalni Marketing', 'Prodaja'],\r\n  services: ['Odnosi sa Klijentima', 'Prodaja', 'Marketing', 'Operacije'],\r\n  startup: ['Preduzetnitvo', 'Startup', 'Inovacije', 'Poslovni Modeli'],\r\n  food: ['Operacije', 'Prodaja', 'Marketing', 'Finansije'],\r\n  'real estate': ['Finansije', 'Prodaja', 'Strategija'],\r\n  media: ['Marketing', 'Digitalni Marketing', 'Inovacije'],\r\n};\r\n\r\n@Injectable()\r\nexport class ConceptRelevanceService {\r\n  private readonly logger = new Logger(ConceptRelevanceService.name);\r\n\r\n  /** Default relevance threshold */\r\n  readonly DEFAULT_THRESHOLD = 0.3;\r\n\r\n  /** Lowered threshold for PLATFORM_OWNER (broader exploration) */\r\n  readonly OWNER_THRESHOLD = 0.15;\r\n\r\n  /**\r\n   * Scores a concept's relevance for a specific tenant context.\r\n   * Returns 0.0 - 1.0 where higher = more relevant.\r\n   *\r\n   * Foundation categories always return 1.0.\r\n   */\r\n  scoreRelevance(input: RelevanceInput): number {\r\n    const {\r\n      conceptCategory,\r\n      tenantIndustry,\r\n      completedConceptIds,\r\n      department,\r\n      role: _role,\r\n      relationshipType,\r\n    } = input;\r\n\r\n    // Foundation categories always pass\r\n    if ((FOUNDATION_CATEGORIES as readonly string[]).includes(conceptCategory)) {\r\n      return 1.0;\r\n    }\r\n\r\n    // Strip number prefix for matching (e.g., \"3. Marketing\"  \"Marketing\")\r\n    const strippedCategory = conceptCategory.replace(/^\\d+\\.\\s*/, '').trim();\r\n    if ((FOUNDATION_CATEGORIES as readonly string[]).includes(strippedCategory)) {\r\n      return 1.0;\r\n    }\r\n\r\n    let score = 0;\r\n\r\n    // 1. Industry match (0.3 weight)\r\n    const industryScore = this.scoreIndustryMatch(strippedCategory, tenantIndustry);\r\n    score += industryScore * WEIGHTS.INDUSTRY;\r\n\r\n    // 2. Department alignment (0.3 weight)\r\n    const deptScore = this.scoreDepartmentMatch(strippedCategory, department);\r\n    score += deptScore * WEIGHTS.DEPARTMENT;\r\n\r\n    // 3. Relationship type (0.25 weight)\r\n    if (relationshipType) {\r\n      score += (RELATIONSHIP_SCORES[relationshipType] ?? 0.5) * WEIGHTS.RELATIONSHIP;\r\n    } else {\r\n      score += 0.5 * WEIGHTS.RELATIONSHIP; // Default: moderate\r\n    }\r\n\r\n    // 4. Prior activity (0.15 weight)  has tenant explored this DOMAIN before?\r\n    // If completedCategories provided, check if user has explored this specific category\r\n    // Falls back to global check if category data unavailable\r\n    const hasDomainActivity = input.completedCategories\r\n      ? input.completedCategories.has(strippedCategory) ||\r\n        input.completedCategories.has(conceptCategory)\r\n      : completedConceptIds.size > 0;\r\n    score += (hasDomainActivity ? 0.8 : 0.3) * WEIGHTS.PRIOR_ACTIVITY;\r\n\r\n    return Math.min(score, 1.0);\r\n  }\r\n\r\n  /**\r\n   * Returns the appropriate threshold for a given role.\r\n   */\r\n  getThreshold(role: string): number {\r\n    if (role === 'PLATFORM_OWNER' || role === 'TENANT_OWNER') {\r\n      return this.OWNER_THRESHOLD;\r\n    }\r\n    return this.DEFAULT_THRESHOLD;\r\n  }\r\n\r\n  /**\r\n   * Scores industry-to-category match using keyword matching.\r\n   */\r\n  private scoreIndustryMatch(category: string, tenantIndustry: string): number {\r\n    if (!tenantIndustry) return 0.5; // No industry info = neutral\r\n\r\n    const industryLower = tenantIndustry.toLowerCase();\r\n\r\n    // Check each industry keyword for matches\r\n    for (const [keyword, categories] of Object.entries(INDUSTRY_CATEGORY_RELEVANCE)) {\r\n      if (industryLower.includes(keyword)) {\r\n        if (categories.includes(category)) {\r\n          return 1.0; // Direct match\r\n        }\r\n      }\r\n    }\r\n\r\n    // Universal categories that apply to any business\r\n    const universalCategories = [\r\n      'Menadment',\r\n      'Finansije',\r\n      'Prodaja',\r\n      'Marketing',\r\n      'Strategija',\r\n      'Liderstvo',\r\n      'Poslovni Modeli',\r\n    ];\r\n    if (universalCategories.includes(category)) {\r\n      return 0.6; // Broadly relevant\r\n    }\r\n\r\n    return 0.2; // Low relevance\r\n  }\r\n\r\n  /**\r\n   * Scores department-to-category alignment.\r\n   */\r\n  private scoreDepartmentMatch(category: string, department: string | null): number {\r\n    if (!department) return 0.7; // No department = owner, broadly relevant\r\n\r\n    const deptCategories =\r\n      DEPARTMENT_CATEGORY_MAP[department as keyof typeof DEPARTMENT_CATEGORY_MAP];\r\n    if (!deptCategories) return 0.5;\r\n\r\n    if (deptCategories.includes(category)) {\r\n      return 1.0; // Direct department match\r\n    }\r\n\r\n    return 0.3; // Not in department scope\r\n  }\r\n}\r\n","import {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { CurrentUserPayload } from '../../auth/strategies/jwt.strategy';\r\nimport { getVisibleCategories } from '../config/department-categories';\r\n\r\n/**\r\n * Story 3.2: Department Fence Guard\r\n *\r\n * Validates that the requesting user has access to the resource based on\r\n * their department-to-category mapping. PLATFORM_OWNER and TENANT_OWNER\r\n * bypass all checks (getVisibleCategories returns null).\r\n *\r\n * Checks:\r\n * - Query param `category`: validates it's in the user's visible categories\r\n * - Route param `id` (conversation): looks up conversation's conceptId  concept.category\r\n * - Body `taskIds`: looks up each task's conceptId  concept.category\r\n */\r\n@Injectable()\r\nexport class DepartmentGuard implements CanActivate {\r\n  private readonly logger = new Logger(DepartmentGuard.name);\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    const request = context.switchToHttp().getRequest();\r\n    const user: CurrentUserPayload | undefined = request.user;\r\n\r\n    if (!user) return true; // Let auth guards handle missing user\r\n\r\n    const visibleCategories = getVisibleCategories(user.department, user.role);\r\n    if (visibleCategories === null) return true; // Owner  no filter\r\n\r\n    const visibleSet = new Set(visibleCategories);\r\n\r\n    // Check query param `category` (e.g., yolo:start-domain)\r\n    const category = request.query?.category || request.body?.category;\r\n    if (category && typeof category === 'string') {\r\n      if (!visibleSet.has(category)) {\r\n        this.logger.warn({\r\n          message: 'Department guard: category access denied',\r\n          userId: user.userId,\r\n          department: user.department,\r\n          requestedCategory: category,\r\n        });\r\n        throw new ForbiddenException({\r\n          type: 'department_access_denied',\r\n          title: 'Access Denied',\r\n          status: 403,\r\n          detail: 'You do not have access to this domain.',\r\n        });\r\n      }\r\n    }\r\n\r\n    // Check route param `id` (conversation endpoints)\r\n    const conversationId = request.params?.id;\r\n    if (conversationId) {\r\n      const conversation = await this.prisma.conversation.findUnique({\r\n        where: { id: conversationId },\r\n        select: { conceptId: true },\r\n      });\r\n      if (conversation?.conceptId) {\r\n        const concept = await this.prisma.concept.findUnique({\r\n          where: { id: conversation.conceptId },\r\n          select: { category: true },\r\n        });\r\n        if (concept?.category && !visibleSet.has(concept.category)) {\r\n          this.logger.warn({\r\n            message: 'Department guard: conversation access denied',\r\n            userId: user.userId,\r\n            conversationId,\r\n            conceptCategory: concept.category,\r\n          });\r\n          throw new ForbiddenException({\r\n            type: 'department_access_denied',\r\n            title: 'Access Denied',\r\n            status: 403,\r\n            detail: 'You do not have access to this conversation.',\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check body `taskIds` (workflow:run-agents)\r\n    const taskIds = request.body?.taskIds;\r\n    if (Array.isArray(taskIds) && taskIds.length > 0) {\r\n      const tasks = await this.prisma.note.findMany({\r\n        where: { id: { in: taskIds }, tenantId: user.tenantId },\r\n        select: { conceptId: true },\r\n      });\r\n      const conceptIds = tasks.map((t) => t.conceptId).filter((id): id is string => id !== null);\r\n      if (conceptIds.length > 0) {\r\n        const concepts = await this.prisma.concept.findMany({\r\n          where: { id: { in: conceptIds } },\r\n          select: { category: true },\r\n        });\r\n        const denied = concepts.find((c) => c.category && !visibleSet.has(c.category));\r\n        if (denied) {\r\n          this.logger.warn({\r\n            message: 'Department guard: task access denied',\r\n            userId: user.userId,\r\n            deniedCategory: denied.category,\r\n          });\r\n          throw new ForbiddenException({\r\n            type: 'department_access_denied',\r\n            title: 'Access Denied',\r\n            status: 403,\r\n            detail: 'One or more tasks are outside your department scope.',\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Body,\r\n  Param,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n  Headers,\r\n} from '@nestjs/common';\r\nimport { InvitationService } from './invitation.service';\r\nimport { CreateInvitationDto } from './dto/create-invitation.dto';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { RolesGuard } from '../auth/guards/roles.guard';\r\nimport { Roles } from '../auth/decorators/roles.decorator';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\n\r\n@Controller('invitations')\r\nexport class InvitationController {\r\n  constructor(private readonly invitationService: InvitationService) {}\r\n\r\n  @Post()\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  @HttpCode(HttpStatus.CREATED)\r\n  async createInvitation(\r\n    @Body() dto: CreateInvitationDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const result = await this.invitationService.createInvitation(\r\n      dto,\r\n      user.userId,\r\n      user.tenantId\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      message: 'Invitation sent successfully',\r\n      data: result,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Get()\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER', 'ADMIN')\r\n  async listInvitations(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const invitations = await this.invitationService.getInvitationsByTenant(\r\n      user.tenantId\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: invitations,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Get('validate/:token')\r\n  async validateToken(\r\n    @Param('token') token: string,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const invitation = await this.invitationService.validateInviteToken(token);\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: {\r\n        id: invitation.id,\r\n        email: invitation.email,\r\n        department: invitation.department,\r\n        role: invitation.role,\r\n        tenantName: invitation.tenant.name,\r\n        expiresAt: invitation.expiresAt,\r\n      },\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Post('accept/:token')\r\n  @UseGuards(JwtAuthGuard)\r\n  @HttpCode(HttpStatus.OK)\r\n  async acceptInvitation(\r\n    @Param('token') token: string,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const result = await this.invitationService.acceptInvitation(\r\n      token,\r\n      user.userId,\r\n      user.email\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      message: 'Invitation accepted. Welcome to the team!',\r\n      data: result,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Post(':id/revoke')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  @HttpCode(HttpStatus.OK)\r\n  async revokeInvitation(\r\n    @Param('id') invitationId: string,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    await this.invitationService.revokeInvitation(\r\n      invitationId,\r\n      user.tenantId\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      message: 'Invitation revoked',\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Injectable,\r\n  Logger,\r\n  ConflictException,\r\n  ForbiddenException,\r\n  NotFoundException,\r\n  GoneException,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { generateInvitationId, generateInviteToken } from '@mentor-ai/shared/utils';\r\nimport { InvitationStatus, Department, UserRole } from '@mentor-ai/shared/prisma';\r\nimport { EmailService } from '@mentor-ai/shared/email';\r\nimport { BrainSeedingService } from '../knowledge/services/brain-seeding.service';\r\nimport { CreateInvitationDto } from './dto/create-invitation.dto';\r\n\r\nexport interface InvitationResult {\r\n  id: string;\r\n  email: string;\r\n  department: Department;\r\n  status: InvitationStatus;\r\n  token: string;\r\n  expiresAt: Date;\r\n  tenantId: string;\r\n  invitedById: string;\r\n  createdAt: Date;\r\n}\r\n\r\nexport interface UserLimitCheck {\r\n  allowed: boolean;\r\n  currentCount: number;\r\n  limit: number;\r\n}\r\n\r\nexport interface InvitationWithDetails {\r\n  id: string;\r\n  email: string;\r\n  department: Department;\r\n  role: UserRole;\r\n  status: InvitationStatus;\r\n  token: string;\r\n  expiresAt: Date;\r\n  tenantId: string;\r\n  invitedById: string;\r\n  acceptedByUserId: string | null;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  tenant: { name: string };\r\n  invitedBy: { email: string; name: string | null };\r\n}\r\n\r\n@Injectable()\r\nexport class InvitationService {\r\n  private readonly logger = new Logger(InvitationService.name);\r\n  private readonly maxTeamMembers: number;\r\n  private readonly appUrl: string;\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly emailService: EmailService,\r\n    private readonly configService: ConfigService,\r\n    private readonly brainSeedingService: BrainSeedingService\r\n  ) {\r\n    this.maxTeamMembers = this.configService.get<number>('MAX_TEAM_MEMBERS', 5);\r\n    this.appUrl = this.configService.get<string>('FRONTEND_URL', 'http://localhost:4200');\r\n  }\r\n\r\n  async checkUserLimit(tenantId: string): Promise<UserLimitCheck> {\r\n    const [activeUsers, pendingInvitations] = await Promise.all([\r\n      this.prisma.user.count({ where: { tenantId } }),\r\n      this.prisma.invitation.count({\r\n        where: {\r\n          tenantId,\r\n          status: InvitationStatus.PENDING,\r\n          expiresAt: { gt: new Date() },\r\n        },\r\n      }),\r\n    ]);\r\n\r\n    const currentCount = activeUsers + pendingInvitations;\r\n    return {\r\n      allowed: currentCount < this.maxTeamMembers,\r\n      currentCount,\r\n      limit: this.maxTeamMembers,\r\n    };\r\n  }\r\n\r\n  async createInvitation(\r\n    dto: CreateInvitationDto,\r\n    inviterId: string,\r\n    tenantId: string\r\n  ): Promise<InvitationResult> {\r\n    const normalizedEmail = dto.email.toLowerCase();\r\n\r\n    // Check user limit\r\n    const limitCheck = await this.checkUserLimit(tenantId);\r\n    if (!limitCheck.allowed) {\r\n      throw new ForbiddenException({\r\n        type: 'user_limit_reached',\r\n        title: 'User Limit Reached',\r\n        status: 403,\r\n        detail: 'User limit reached. Upgrade your plan to add more team members.',\r\n        currentCount: limitCheck.currentCount,\r\n        limit: limitCheck.limit,\r\n      });\r\n    }\r\n\r\n    // Check for duplicate pending invitation\r\n    const existingInvitation = await this.prisma.invitation.findFirst({\r\n      where: {\r\n        email: normalizedEmail,\r\n        tenantId,\r\n        status: InvitationStatus.PENDING,\r\n        expiresAt: { gt: new Date() },\r\n      },\r\n    });\r\n\r\n    if (existingInvitation) {\r\n      throw new ConflictException({\r\n        type: 'duplicate_invitation',\r\n        title: 'Duplicate Invitation',\r\n        status: 409,\r\n        detail: 'A pending invitation already exists for this email address in your workspace.',\r\n      });\r\n    }\r\n\r\n    // Check if email is already a member of the tenant\r\n    const existingMember = await this.prisma.user.findFirst({\r\n      where: { email: normalizedEmail, tenantId },\r\n    });\r\n\r\n    if (existingMember) {\r\n      throw new ConflictException({\r\n        type: 'already_member',\r\n        title: 'Already a Member',\r\n        status: 409,\r\n        detail: 'This user is already a member of your workspace.',\r\n      });\r\n    }\r\n\r\n    const invitationId = generateInvitationId();\r\n    const token = generateInviteToken();\r\n    const expiresAt = new Date();\r\n    expiresAt.setDate(expiresAt.getDate() + 7);\r\n\r\n    const invitation = await this.prisma.invitation.create({\r\n      data: {\r\n        id: invitationId,\r\n        email: normalizedEmail,\r\n        department: dto.department,\r\n        status: InvitationStatus.PENDING,\r\n        token,\r\n        expiresAt,\r\n        tenantId,\r\n        invitedById: inviterId,\r\n      },\r\n    });\r\n\r\n    // Send invitation email\r\n    const inviter = await this.prisma.user.findUnique({\r\n      where: { id: inviterId },\r\n      select: { name: true, email: true },\r\n    });\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true },\r\n    });\r\n\r\n    const inviteLink = `${this.appUrl}/invite/${token}`;\r\n\r\n    const emailResult = await this.emailService.sendInvitationEmail({\r\n      to: normalizedEmail,\r\n      inviterName: inviter?.name ?? inviter?.email ?? 'A team member',\r\n      tenantName: tenant?.name ?? 'Your workspace',\r\n      inviteLink,\r\n      department: dto.department,\r\n    });\r\n\r\n    if (!emailResult.success) {\r\n      this.logger.warn(\r\n        `Failed to send invitation email to ${normalizedEmail} for tenant ${tenantId}`\r\n      );\r\n    }\r\n\r\n    return {\r\n      id: invitation.id,\r\n      email: invitation.email,\r\n      department: invitation.department,\r\n      status: invitation.status,\r\n      token: invitation.token,\r\n      expiresAt: invitation.expiresAt,\r\n      tenantId: invitation.tenantId,\r\n      invitedById: invitation.invitedById,\r\n      createdAt: invitation.createdAt,\r\n    };\r\n  }\r\n\r\n  async getInvitationsByTenant(tenantId: string): Promise<InvitationWithDetails[]> {\r\n    return this.prisma.invitation.findMany({\r\n      where: { tenantId },\r\n      include: {\r\n        tenant: { select: { name: true } },\r\n        invitedBy: { select: { email: true, name: true } },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async getPendingInvitations(tenantId: string): Promise<InvitationWithDetails[]> {\r\n    const now = new Date();\r\n\r\n    // Auto-expire stale invitations\r\n    await this.prisma.invitation.updateMany({\r\n      where: {\r\n        tenantId,\r\n        status: InvitationStatus.PENDING,\r\n        expiresAt: { lt: now },\r\n      },\r\n      data: { status: InvitationStatus.EXPIRED },\r\n    });\r\n\r\n    return this.prisma.invitation.findMany({\r\n      where: {\r\n        tenantId,\r\n        status: InvitationStatus.PENDING,\r\n        expiresAt: { gt: now },\r\n      },\r\n      include: {\r\n        tenant: { select: { name: true } },\r\n        invitedBy: { select: { email: true, name: true } },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async validateInviteToken(token: string): Promise<InvitationWithDetails> {\r\n    const invitation = await this.prisma.invitation.findUnique({\r\n      where: { token },\r\n      include: {\r\n        tenant: { select: { name: true } },\r\n        invitedBy: { select: { email: true, name: true } },\r\n      },\r\n    });\r\n\r\n    if (!invitation) {\r\n      throw new NotFoundException({\r\n        type: 'invitation_not_found',\r\n        title: 'Invitation Not Found',\r\n        status: 404,\r\n        detail: 'This invitation link is invalid.',\r\n      });\r\n    }\r\n\r\n    if (invitation.status === InvitationStatus.REVOKED) {\r\n      throw new GoneException({\r\n        type: 'invitation_revoked',\r\n        title: 'Invitation Revoked',\r\n        status: 410,\r\n        detail: 'This invitation has been revoked. Please request a new invite.',\r\n      });\r\n    }\r\n\r\n    if (invitation.status === InvitationStatus.EXPIRED || invitation.expiresAt < new Date()) {\r\n      // Auto-update status if expired\r\n      if (invitation.status === InvitationStatus.PENDING) {\r\n        await this.prisma.invitation.update({\r\n          where: { id: invitation.id },\r\n          data: { status: InvitationStatus.EXPIRED },\r\n        });\r\n      }\r\n\r\n      throw new GoneException({\r\n        type: 'invitation_expired',\r\n        title: 'Invitation Expired',\r\n        status: 410,\r\n        detail: 'This invitation has expired. Please request a new invite.',\r\n      });\r\n    }\r\n\r\n    if (invitation.status === InvitationStatus.ACCEPTED) {\r\n      throw new ConflictException({\r\n        type: 'invitation_already_accepted',\r\n        title: 'Already Accepted',\r\n        status: 409,\r\n        detail: 'This invitation has already been accepted.',\r\n      });\r\n    }\r\n\r\n    return invitation;\r\n  }\r\n\r\n  async acceptInvitation(\r\n    token: string,\r\n    userId: string,\r\n    userEmail: string\r\n  ): Promise<{ tenantId: string; role: string; department: Department }> {\r\n    const invitation = await this.validateInviteToken(token);\r\n\r\n    // Use transaction for atomicity\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      // Check if user already belongs to this tenant\r\n      const existingUser = await tx.user.findFirst({\r\n        where: { email: userEmail.toLowerCase(), tenantId: invitation.tenantId },\r\n      });\r\n\r\n      if (existingUser) {\r\n        // User already a member, just mark invitation accepted\r\n        await tx.invitation.update({\r\n          where: { id: invitation.id },\r\n          data: {\r\n            status: InvitationStatus.ACCEPTED,\r\n            acceptedByUserId: existingUser.id,\r\n          },\r\n        });\r\n\r\n        return {\r\n          tenantId: invitation.tenantId,\r\n          role: existingUser.role,\r\n          department: invitation.department,\r\n          isNewMember: false,\r\n        };\r\n      }\r\n\r\n      // Add user to the invited tenant with department from invitation\r\n      await tx.user.update({\r\n        where: { id: userId },\r\n        data: {\r\n          tenantId: invitation.tenantId,\r\n          role: invitation.role,\r\n          department: invitation.department,\r\n        },\r\n      });\r\n\r\n      await tx.invitation.update({\r\n        where: { id: invitation.id },\r\n        data: {\r\n          status: InvitationStatus.ACCEPTED,\r\n          acceptedByUserId: userId,\r\n        },\r\n      });\r\n\r\n      return {\r\n        tenantId: invitation.tenantId,\r\n        role: invitation.role,\r\n        department: invitation.department,\r\n        isNewMember: true,\r\n      };\r\n    });\r\n\r\n    // Story 3.2: Seed pending tasks for new team member (fire-and-forget)\r\n    if (result.isNewMember) {\r\n      this.brainSeedingService\r\n        .seedPendingTasksForUser(userId, result.tenantId, result.department, result.role)\r\n        .catch((err) => {\r\n          this.logger.warn({\r\n            message: 'Brain seeding failed after invitation acceptance',\r\n            userId,\r\n            tenantId: result.tenantId,\r\n            error: err?.message,\r\n          });\r\n        });\r\n    }\r\n\r\n    return {\r\n      tenantId: result.tenantId,\r\n      role: result.role,\r\n      department: result.department,\r\n    };\r\n  }\r\n\r\n  async revokeInvitation(invitationId: string, tenantId: string): Promise<void> {\r\n    const invitation = await this.prisma.invitation.findUnique({\r\n      where: { id: invitationId },\r\n    });\r\n\r\n    if (!invitation) {\r\n      throw new NotFoundException({\r\n        type: 'invitation_not_found',\r\n        title: 'Invitation Not Found',\r\n        status: 404,\r\n        detail: 'The specified invitation was not found.',\r\n      });\r\n    }\r\n\r\n    if (invitation.tenantId !== tenantId) {\r\n      throw new ForbiddenException({\r\n        type: 'invitation_access_denied',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have permission to revoke this invitation.',\r\n      });\r\n    }\r\n\r\n    if (invitation.status !== InvitationStatus.PENDING) {\r\n      throw new ConflictException({\r\n        type: 'invitation_not_pending',\r\n        title: 'Cannot Revoke',\r\n        status: 409,\r\n        detail: `Cannot revoke invitation with status: ${invitation.status}`,\r\n      });\r\n    }\r\n\r\n    await this.prisma.invitation.update({\r\n      where: { id: invitationId },\r\n      data: { status: InvitationStatus.REVOKED },\r\n    });\r\n  }\r\n}\r\n","import { IsEmail, IsEnum } from 'class-validator';\r\nimport { Department } from '@mentor-ai/shared/prisma';\r\n\r\nexport class CreateInvitationDto {\r\n  @IsEmail({}, { message: 'Please provide a valid email address' })\r\n  email!: string;\r\n\r\n  @IsEnum(Department, { message: 'Department must be one of: FINANCE, MARKETING, TECHNOLOGY, OPERATIONS, LEGAL, CREATIVE' })\r\n  department!: Department;\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { EmailModule } from '@mentor-ai/shared/email';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { TeamController } from './team.controller';\r\nimport { TeamService } from './team.service';\r\n\r\n@Module({\r\n  imports: [ConfigModule, EmailModule, AuthModule, TenantModule], // TenantModule provides PlatformPrismaService\r\n  controllers: [TeamController],\r\n  providers: [TeamService],\r\n  exports: [TeamService],\r\n})\r\nexport class TeamModule {}\r\n","import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Delete,\r\n  Body,\r\n  Param,\r\n  Req,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n  Headers,\r\n} from '@nestjs/common';\r\nimport type { Request } from 'express';\r\nimport { TeamService } from './team.service';\r\nimport { RemoveMemberDto } from './dto/remove-member.dto';\r\nimport { DesignateBackupOwnerDto } from './dto/designate-backup-owner.dto';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { RolesGuard } from '../auth/guards/roles.guard';\r\nimport { MfaRequiredGuard } from '../auth/guards/mfa-required.guard';\r\nimport { Roles } from '../auth/decorators/roles.decorator';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\n\r\n@Controller('team')\r\nexport class TeamController {\r\n  constructor(private readonly teamService: TeamService) {}\r\n\r\n  @Get('members')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER', 'ADMIN')\r\n  async getMembers(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const members = await this.teamService.getTeamMembers(user.tenantId);\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: members,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Post('members/:id/remove')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  @HttpCode(HttpStatus.OK)\r\n  async removeMember(\r\n    @Param('id') memberId: string,\r\n    @Body() dto: RemoveMemberDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    await this.teamService.removeMember(\r\n      memberId,\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.strategy\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: null,\r\n      message: 'Member removed',\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Get('backup-owner')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  async getBackupOwner(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const backupOwner = await this.teamService.getBackupOwner(user.tenantId);\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: backupOwner,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Get('backup-owner/eligible')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  async getEligibleBackupOwners(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const eligible = await this.teamService.getEligibleBackupOwners(\r\n      user.tenantId\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: eligible,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Post('backup-owner')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  @HttpCode(HttpStatus.OK)\r\n  async designateBackupOwner(\r\n    @Body() dto: DesignateBackupOwnerDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const result = await this.teamService.designateBackupOwner(\r\n      user.tenantId,\r\n      dto.backupOwnerId,\r\n      user.userId\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: result,\r\n      message: 'Backup owner designated',\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Delete('backup-owner')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER')\r\n  @HttpCode(HttpStatus.OK)\r\n  async removeBackupDesignation(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    await this.teamService.removeBackupDesignation(user.tenantId);\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: null,\r\n      message: 'Backup owner removed',\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Post('backup-owner/recovery')\r\n  @UseGuards(JwtAuthGuard, MfaRequiredGuard)\r\n  @HttpCode(HttpStatus.OK)\r\n  async initiateRecovery(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Req() req: Request,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const ipAddress =\r\n      (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||\r\n      req.ip ||\r\n      'unknown';\r\n\r\n    const result = await this.teamService.initiateRecovery(\r\n      user.tenantId,\r\n      user.userId,\r\n      ipAddress\r\n    );\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: { recoveredUserId: result.recoveredUserId },\r\n      message: result.message,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  @Get('backup-owner/status')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles('TENANT_OWNER', 'ADMIN')\r\n  async getBackupOwnerStatus(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ) {\r\n    const status = await this.teamService.getBackupOwnerStatus(user.tenantId);\r\n\r\n    return {\r\n      status: 'success' as const,\r\n      data: status,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Injectable,\r\n  Logger,\r\n  ForbiddenException,\r\n  NotFoundException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { EmailService } from '@mentor-ai/shared/email';\r\nimport type {\r\n  RemovalStrategy,\r\n  BackupOwnerResponse,\r\n  BackupOwnerStatus,\r\n  RecoveryResult,\r\n} from '@mentor-ai/shared/types';\r\n\r\nexport { type RemovalStrategy };\r\n\r\nexport interface TeamMemberResult {\r\n  id: string;\r\n  email: string;\r\n  name: string | null;\r\n  role: string;\r\n  department: string | null;\r\n  createdAt: Date;\r\n}\r\n\r\nexport interface RemovalResult {\r\n  removedUserId: string;\r\n  strategy: RemovalStrategy;\r\n}\r\n\r\n\r\n@Injectable()\r\nexport class TeamService {\r\n  private readonly logger = new Logger(TeamService.name);\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly emailService: EmailService\r\n  ) {}\r\n\r\n  async getTeamMembers(tenantId: string): Promise<TeamMemberResult[]> {\r\n    const users = await this.prisma.user.findMany({\r\n      where: { tenantId, isActive: true },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        role: true,\r\n        createdAt: true,\r\n        invitationAccepted: {\r\n          select: { department: true },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n\r\n    return users.map((user) => ({\r\n      id: user.id,\r\n      email: user.email,\r\n      name: user.name,\r\n      role: user.role,\r\n      department: user.invitationAccepted?.department ?? null,\r\n      createdAt: user.createdAt,\r\n    }));\r\n  }\r\n\r\n  async getMemberById(\r\n    memberId: string,\r\n    tenantId: string\r\n  ): Promise<TeamMemberResult> {\r\n    const user = await this.prisma.user.findFirst({\r\n      where: { id: memberId, tenantId, isActive: true },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        role: true,\r\n        createdAt: true,\r\n        invitationAccepted: {\r\n          select: { department: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException({\r\n        type: 'member_not_found',\r\n        title: 'Member Not Found',\r\n        status: 404,\r\n        detail: 'The specified team member was not found.',\r\n      });\r\n    }\r\n\r\n    return {\r\n      id: user.id,\r\n      email: user.email,\r\n      name: user.name,\r\n      role: user.role,\r\n      department: user.invitationAccepted?.department ?? null,\r\n      createdAt: user.createdAt,\r\n    };\r\n  }\r\n\r\n  async removeMember(\r\n    memberId: string,\r\n    tenantId: string,\r\n    ownerId: string,\r\n    strategy: RemovalStrategy\r\n  ): Promise<RemovalResult> {\r\n    // Verify member exists and belongs to tenant\r\n    const member = await this.prisma.user.findFirst({\r\n      where: { id: memberId, tenantId, isActive: true },\r\n      select: { id: true, email: true, name: true, role: true },\r\n    });\r\n\r\n    if (!member) {\r\n      throw new NotFoundException({\r\n        type: 'member_not_found',\r\n        title: 'Member Not Found',\r\n        status: 404,\r\n        detail: 'The specified team member was not found.',\r\n      });\r\n    }\r\n\r\n    // Self-removal prevention (AC4)\r\n    if (memberId === ownerId) {\r\n      // Check if this is the only owner\r\n      const ownerCount = await this.prisma.user.count({\r\n        where: {\r\n          tenantId,\r\n          role: 'TENANT_OWNER',\r\n          isActive: true,\r\n        },\r\n      });\r\n\r\n      if (ownerCount <= 1) {\r\n        throw new ForbiddenException({\r\n          type: 'self_removal_denied',\r\n          title: 'Cannot Remove Yourself',\r\n          status: 403,\r\n          detail:\r\n            'You cannot remove yourself. Designate a backup Owner first.',\r\n        });\r\n      }\r\n    }\r\n\r\n    // Soft delete in a transaction\r\n    await this.prisma.$transaction(async (tx) => {\r\n      await tx.user.update({\r\n        where: { id: memberId },\r\n        data: {\r\n          isActive: false,\r\n          removedAt: new Date(),\r\n          removedById: ownerId,\r\n          removalReason: strategy,\r\n        },\r\n      });\r\n\r\n      // Future: reassign notes/conversations when those models exist\r\n    });\r\n\r\n    // Send removal notification email AFTER transaction commits (per dev notes)\r\n    const owner = await this.prisma.user.findUnique({\r\n      where: { id: ownerId },\r\n      select: { email: true },\r\n    });\r\n\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true },\r\n    });\r\n\r\n    const emailResult = await this.emailService.sendRemovalNotificationEmail({\r\n      to: member.email,\r\n      memberName: member.name ?? '',\r\n      tenantName: tenant?.name ?? 'Your workspace',\r\n      strategy,\r\n      contactEmail: owner?.email,\r\n    });\r\n\r\n    if (!emailResult.success) {\r\n      this.logger.warn(\r\n        `Failed to send removal notification to ${member.email} for tenant ${tenantId}`\r\n      );\r\n    }\r\n\r\n    this.logger.log(\r\n      `Member ${memberId} removed from tenant ${tenantId} by ${ownerId} with strategy ${strategy}`\r\n    );\r\n\r\n    return { removedUserId: memberId, strategy };\r\n  }\r\n\r\n  async getBackupOwner(\r\n    tenantId: string\r\n  ): Promise<BackupOwnerResponse | null> {\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      include: {\r\n        backupOwner: {\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            name: true,\r\n            isActive: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (\r\n      !tenant?.backupOwner ||\r\n      !tenant.backupOwner.isActive ||\r\n      !tenant.backupOwnerDesignatedAt\r\n    ) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      id: tenant.backupOwner.id,\r\n      email: tenant.backupOwner.email,\r\n      name: tenant.backupOwner.name,\r\n      designatedAt: tenant.backupOwnerDesignatedAt.toISOString(),\r\n    };\r\n  }\r\n\r\n  async getEligibleBackupOwners(\r\n    tenantId: string\r\n  ): Promise<TeamMemberResult[]> {\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { backupOwnerId: true },\r\n    });\r\n\r\n    const users = await this.prisma.user.findMany({\r\n      where: {\r\n        tenantId,\r\n        isActive: true,\r\n        role: { not: 'TENANT_OWNER' },\r\n        ...(tenant?.backupOwnerId\r\n          ? { id: { not: tenant.backupOwnerId } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        name: true,\r\n        role: true,\r\n        createdAt: true,\r\n        invitationAccepted: {\r\n          select: { department: true },\r\n        },\r\n      },\r\n      orderBy: { name: 'asc' },\r\n    });\r\n\r\n    return users.map((user) => ({\r\n      id: user.id,\r\n      email: user.email,\r\n      name: user.name,\r\n      role: user.role,\r\n      department: user.invitationAccepted?.department ?? null,\r\n      createdAt: user.createdAt,\r\n    }));\r\n  }\r\n\r\n  async designateBackupOwner(\r\n    tenantId: string,\r\n    backupOwnerId: string,\r\n    designatedById: string\r\n  ): Promise<BackupOwnerResponse> {\r\n    const now = new Date();\r\n\r\n    // Validate and designate in a transaction to prevent TOCTOU race\r\n    const candidate = await this.prisma.$transaction(async (tx) => {\r\n      // Verify candidate exists, is active, belongs to tenant\r\n      const user = await tx.user.findFirst({\r\n        where: { id: backupOwnerId, tenantId, isActive: true },\r\n        select: { id: true, email: true, name: true, role: true },\r\n      });\r\n\r\n      if (!user) {\r\n        throw new NotFoundException({\r\n          type: 'member_not_found',\r\n          title: 'Member Not Found',\r\n          status: 404,\r\n          detail: 'The specified team member was not found or is inactive.',\r\n        });\r\n      }\r\n\r\n      // Prevent TENANT_OWNER from being backup owner\r\n      if (user.role === 'TENANT_OWNER') {\r\n        throw new BadRequestException({\r\n          type: 'invalid_backup_candidate',\r\n          title: 'Invalid Backup Owner Candidate',\r\n          status: 400,\r\n          detail:\r\n            'A Tenant Owner cannot be designated as backup owner. Choose an Admin or Member.',\r\n        });\r\n      }\r\n\r\n      // Update tenant with backup owner\r\n      await tx.tenant.update({\r\n        where: { id: tenantId },\r\n        data: {\r\n          backupOwnerId: user.id,\r\n          backupOwnerDesignatedAt: now,\r\n        },\r\n      });\r\n\r\n      return user;\r\n    });\r\n\r\n    // Send email notification AFTER transaction commits\r\n    const designator = await this.prisma.user.findUnique({\r\n      where: { id: designatedById },\r\n      select: { name: true, email: true },\r\n    });\r\n\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true },\r\n    });\r\n\r\n    const emailResult =\r\n      await this.emailService.sendBackupOwnerDesignationEmail({\r\n        to: candidate.email,\r\n        tenantName: tenant?.name ?? 'Your workspace',\r\n        designatedBy: designator?.name ?? designator?.email ?? 'Workspace Owner',\r\n        designatedName: candidate.name ?? '',\r\n      });\r\n\r\n    if (!emailResult.success) {\r\n      this.logger.warn(\r\n        `Failed to send backup owner designation email to ${candidate.email} for tenant ${tenantId}`\r\n      );\r\n    }\r\n\r\n    this.logger.log(\r\n      `Backup owner designated: ${candidate.id} for tenant ${tenantId} by ${designatedById}`\r\n    );\r\n\r\n    return {\r\n      id: candidate.id,\r\n      email: candidate.email,\r\n      name: candidate.name,\r\n      designatedAt: now.toISOString(),\r\n    };\r\n  }\r\n\r\n  async removeBackupDesignation(tenantId: string): Promise<void> {\r\n    await this.prisma.tenant.update({\r\n      where: { id: tenantId },\r\n      data: {\r\n        backupOwnerId: null,\r\n        backupOwnerDesignatedAt: null,\r\n      },\r\n    });\r\n\r\n    this.logger.log(`Backup owner designation removed for tenant ${tenantId}`);\r\n  }\r\n\r\n  async initiateRecovery(\r\n    tenantId: string,\r\n    backupOwnerId: string,\r\n    ipAddress: string\r\n  ): Promise<RecoveryResult> {\r\n    // Verify caller IS the designated backup owner AND is still active\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: {\r\n        backupOwnerId: true,\r\n        name: true,\r\n        backupOwner: {\r\n          select: { isActive: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (\r\n      !tenant ||\r\n      tenant.backupOwnerId !== backupOwnerId ||\r\n      !tenant.backupOwner?.isActive\r\n    ) {\r\n      throw new ForbiddenException({\r\n        type: 'not_backup_owner',\r\n        title: 'Not Authorized',\r\n        status: 403,\r\n        detail: 'You are not the designated backup owner for this workspace.',\r\n      });\r\n    }\r\n\r\n    // Find the primary owner\r\n    const primaryOwner = await this.prisma.user.findFirst({\r\n      where: { tenantId, role: 'TENANT_OWNER', isActive: true },\r\n      select: { id: true, email: true, name: true },\r\n    });\r\n\r\n    if (!primaryOwner) {\r\n      throw new NotFoundException({\r\n        type: 'owner_not_found',\r\n        title: 'Owner Not Found',\r\n        status: 404,\r\n        detail: 'Could not find the primary owner for this workspace.',\r\n      });\r\n    }\r\n\r\n    // Reset primary owner's 2FA\r\n    await this.prisma.user.update({\r\n      where: { id: primaryOwner.id },\r\n      data: {\r\n        mfaEnabled: false,\r\n        mfaSecret: null,\r\n        failedLoginAttempts: 0,\r\n        lockoutUntil: null,\r\n      },\r\n    });\r\n\r\n    // Send recovery notification email AFTER DB update\r\n    const backupOwner = await this.prisma.user.findUnique({\r\n      where: { id: backupOwnerId },\r\n      select: { name: true },\r\n    });\r\n\r\n    const emailResult =\r\n      await this.emailService.sendRecoveryNotificationEmail({\r\n        to: primaryOwner.email,\r\n        ownerName: primaryOwner.name ?? '',\r\n        tenantName: tenant.name ?? 'Your workspace',\r\n        backupOwnerName: backupOwner?.name ?? 'Backup Owner',\r\n        recoveryTimestamp: new Date(),\r\n        ipAddress,\r\n      });\r\n\r\n    if (!emailResult.success) {\r\n      this.logger.warn(\r\n        `Failed to send recovery notification to ${primaryOwner.email} for tenant ${tenantId}`\r\n      );\r\n    }\r\n\r\n    this.logger.log(\r\n      `Recovery initiated for tenant ${tenantId} by backup owner ${backupOwnerId} from IP ${ipAddress}`\r\n    );\r\n\r\n    return {\r\n      recoveredUserId: primaryOwner.id,\r\n      message: 'Recovery completed. Primary owner 2FA has been reset.',\r\n    };\r\n  }\r\n\r\n  async getBackupOwnerStatus(\r\n    tenantId: string\r\n  ): Promise<BackupOwnerStatus> {\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: {\r\n        createdAt: true,\r\n        backupOwnerId: true,\r\n        backupOwner: {\r\n          select: { isActive: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!tenant) {\r\n      throw new NotFoundException({\r\n        type: 'tenant_not_found',\r\n        title: 'Tenant Not Found',\r\n        status: 404,\r\n        detail: 'The specified tenant was not found.',\r\n      });\r\n    }\r\n\r\n    const hasBackupOwner =\r\n      !!tenant.backupOwnerId && !!tenant.backupOwner?.isActive;\r\n    const tenantAgeDays = Math.floor(\r\n      (Date.now() - tenant.createdAt.getTime()) / (1000 * 60 * 60 * 24)\r\n    );\r\n    const showWarning = !hasBackupOwner && tenantAgeDays >= 30;\r\n\r\n    return { hasBackupOwner, tenantAgeDays, showWarning };\r\n  }\r\n}\r\n","import { IsIn } from 'class-validator';\r\n\r\nexport class RemoveMemberDto {\r\n  @IsIn(['REASSIGN', 'ARCHIVE'], {\r\n    message: 'Strategy must be one of: REASSIGN, ARCHIVE',\r\n  })\r\n  strategy!: 'REASSIGN' | 'ARCHIVE';\r\n}\r\n","import { IsString, IsNotEmpty } from 'class-validator';\r\n\r\nexport class DesignateBackupOwnerDto {\r\n  @IsString({ message: 'backupOwnerId must be a string' })\r\n  @IsNotEmpty({ message: 'backupOwnerId is required' })\r\n  backupOwnerId!: string;\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { AiGatewayModule } from '../ai-gateway/ai-gateway.module';\r\nimport { NotesModule } from '../notes/notes.module';\r\nimport { KnowledgeModule } from '../knowledge/knowledge.module';\r\nimport { MemoryModule } from '../memory/memory.module';\r\nimport { WorkflowModule } from '../workflow/workflow.module';\r\nimport { WebSearchModule } from '../web-search/web-search.module';\r\nimport { ExecutionModule } from '../execution/execution.module';\r\nimport { AttachmentsModule } from '../attachments/attachments.module';\r\nimport { ConversationController } from './conversation.controller';\r\nimport { ConversationService } from './conversation.service';\r\nimport { ConversationGateway } from './conversation.gateway';\r\n\r\n@Module({\r\n  imports: [\r\n    ConfigModule,\r\n    AuthModule,\r\n    AiGatewayModule,\r\n    TenantModule,\r\n    NotesModule,\r\n    KnowledgeModule,\r\n    MemoryModule,\r\n    WorkflowModule,\r\n    WebSearchModule,\r\n    ExecutionModule,\r\n    AttachmentsModule,\r\n  ],\r\n  controllers: [ConversationController],\r\n  providers: [ConversationService, ConversationGateway],\r\n  exports: [ConversationService],\r\n})\r\nexport class ConversationModule {}\r\n","import { Module } from '@nestjs/common';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { AiGatewayModule } from '../ai-gateway/ai-gateway.module';\r\nimport { NotesService } from './notes.service';\r\nimport { NotesController } from './notes.controller';\r\n\r\n/**\r\n * Module for managing user notes.\r\n * Provides note creation, storage, and retrieval for AI-generated content.\r\n */\r\n@Module({\r\n  imports: [\r\n    TenantModule,      // Provides PlatformPrismaService\r\n    AuthModule,        // For JwtAuthGuard\r\n    AiGatewayModule,   // For AI scoring\r\n  ],\r\n  controllers: [NotesController],\r\n  providers: [NotesService],\r\n  exports: [NotesService],\r\n})\r\nexport class NotesModule {}\r\n","import {\r\n  Injectable,\r\n  Logger,\r\n  NotFoundException,\r\n  ForbiddenException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { NoteSource, NoteType, NoteStatus } from '@mentor-ai/shared/prisma';\r\nimport type { NoteItem } from '@mentor-ai/shared/types';\r\nimport { AiGatewayService } from '../ai-gateway/ai-gateway.service';\r\n\r\n/**\r\n * DTO for creating a new note.\r\n */\r\nexport interface CreateNoteDto {\r\n  /** Title of the note */\r\n  title: string;\r\n  /** Content of the note */\r\n  content: string;\r\n  /** Source of the note creation */\r\n  source: NoteSource;\r\n  /** User ID who owns the note */\r\n  userId: string;\r\n  /** Tenant ID the note belongs to */\r\n  tenantId: string;\r\n  /** Note type (TASK, NOTE, SUMMARY) */\r\n  noteType?: NoteType;\r\n  /** Status for TASK type */\r\n  status?: NoteStatus;\r\n  /** Link to a conversation */\r\n  conversationId?: string;\r\n  /** Link to a concept */\r\n  conceptId?: string;\r\n  /** Link to a specific AI message */\r\n  messageId?: string;\r\n  /** Parent note for sub-task hierarchy */\r\n  parentNoteId?: string;\r\n  /** Expected outcome description */\r\n  expectedOutcome?: string;\r\n  /** Workflow step number */\r\n  workflowStepNumber?: number;\r\n  /** ID of the original note this was reused from */\r\n  reusedFromNoteId?: string;\r\n  /** Pre-populated user report (for reused tasks) */\r\n  userReport?: string;\r\n  /** Pre-populated AI score (for reused tasks) */\r\n  aiScore?: number;\r\n  /** Pre-populated AI feedback (for reused tasks) */\r\n  aiFeedback?: string;\r\n}\r\n\r\n/**\r\n * Service for managing user notes.\r\n * Provides CRUD operations for notes created from AI outputs and manual entry.\r\n */\r\n@Injectable()\r\nexport class NotesService {\r\n  private readonly logger = new Logger(NotesService.name);\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly aiGateway: AiGatewayService\r\n  ) {}\r\n\r\n  /**\r\n   * Creates a new note.\r\n   *\r\n   * @param dto - Note creation data\r\n   * @returns The created note with its ID\r\n   */\r\n  async createNote(dto: CreateNoteDto): Promise<{ id: string }> {\r\n    const id = `note_${createId()}`;\r\n\r\n    this.logger.log({\r\n      message: 'Creating note',\r\n      noteId: id,\r\n      userId: dto.userId,\r\n      tenantId: dto.tenantId,\r\n      source: dto.source,\r\n      titleLength: dto.title.length,\r\n      contentLength: dto.content.length,\r\n    });\r\n\r\n    await this.prisma.note.create({\r\n      data: {\r\n        id,\r\n        title: dto.title,\r\n        content: dto.content,\r\n        source: dto.source,\r\n        noteType: dto.noteType ?? NoteType.NOTE,\r\n        status: dto.noteType === NoteType.TASK ? (dto.status ?? NoteStatus.PENDING) : null,\r\n        conversationId: dto.conversationId ?? null,\r\n        conceptId: dto.conceptId ?? null,\r\n        messageId: dto.messageId ?? null,\r\n        userId: dto.userId,\r\n        tenantId: dto.tenantId,\r\n        parentNoteId: dto.parentNoteId ?? null,\r\n        expectedOutcome: dto.expectedOutcome ?? null,\r\n        workflowStepNumber: dto.workflowStepNumber ?? null,\r\n        reusedFromNoteId: dto.reusedFromNoteId ?? null,\r\n        userReport: dto.userReport ?? null,\r\n        aiScore: dto.aiScore ?? null,\r\n        aiFeedback: dto.aiFeedback ?? null,\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Note created successfully',\r\n      noteId: id,\r\n      userId: dto.userId,\r\n      tenantId: dto.tenantId,\r\n    });\r\n\r\n    return { id };\r\n  }\r\n\r\n  /**\r\n   * Gets a note by ID.\r\n   *\r\n   * @param noteId - The note ID to retrieve\r\n   * @param tenantId - The tenant ID for authorization\r\n   * @returns The note or null if not found\r\n   */\r\n  async getNoteById(noteId: string, tenantId: string) {\r\n    return this.prisma.note.findFirst({\r\n      where: {\r\n        id: noteId,\r\n        tenantId,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets all notes for a user.\r\n   *\r\n   * @param userId - The user ID\r\n   * @param tenantId - The tenant ID\r\n   * @returns Array of notes for the user\r\n   */\r\n  async getNotesByUser(userId: string, tenantId: string) {\r\n    return this.prisma.note.findMany({\r\n      where: {\r\n        userId,\r\n        tenantId,\r\n      },\r\n      orderBy: {\r\n        createdAt: 'desc',\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets the most recent note for a user filtered by source.\r\n   */\r\n  async getLatestNoteBySource(userId: string, tenantId: string, source: NoteSource) {\r\n    return this.prisma.note.findFirst({\r\n      where: { userId, tenantId, source },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets top-level notes for a conversation, with children included.\r\n   */\r\n  async getByConversation(\r\n    conversationId: string,\r\n    userId: string,\r\n    tenantId: string\r\n  ): Promise<NoteItem[]> {\r\n    const notes = await this.prisma.note.findMany({\r\n      where: { conversationId, userId, tenantId, parentNoteId: null },\r\n      include: {\r\n        children: { orderBy: { workflowStepNumber: 'asc' } },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n    return notes.map((n) => this.mapToNoteItemWithChildren(n));\r\n  }\r\n\r\n  /**\r\n   * Gets notes for a specific concept.\r\n   */\r\n  async getByConcept(conceptId: string, userId: string, tenantId: string): Promise<NoteItem[]> {\r\n    const notes = await this.prisma.note.findMany({\r\n      where: { conceptId, userId, tenantId, parentNoteId: null },\r\n      include: {\r\n        children: { orderBy: { workflowStepNumber: 'asc' } },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n    return notes.map((n) => this.mapToNoteItemWithChildren(n));\r\n  }\r\n\r\n  /**\r\n   * Gets distinct concept IDs from notes for a user/tenant.\r\n   * Used for concept tree growth  shows concepts discovered via tasks.\r\n   */\r\n  async getDiscoveredConceptIds(userId: string, tenantId: string): Promise<string[]> {\r\n    const notes = await this.prisma.note.findMany({\r\n      where: { userId, tenantId, conceptId: { not: null } },\r\n      select: { conceptId: true },\r\n      distinct: ['conceptId'],\r\n    });\r\n    return notes.map((n) => n.conceptId).filter(Boolean) as string[];\r\n  }\r\n\r\n  /**\r\n   * Links orphan notes (no conversationId) for given concepts to a conversation.\r\n   * Used after onboarding creates tasks per-concept, then creates the welcome conversation.\r\n   */\r\n  async linkNotesToConversation(\r\n    conceptIds: string[],\r\n    conversationId: string,\r\n    userId: string,\r\n    tenantId: string\r\n  ): Promise<number> {\r\n    if (conceptIds.length === 0) return 0;\r\n    const result = await this.prisma.note.updateMany({\r\n      where: {\r\n        conceptId: { in: conceptIds },\r\n        conversationId: null,\r\n        userId,\r\n        tenantId,\r\n      },\r\n      data: { conversationId },\r\n    });\r\n    return result.count;\r\n  }\r\n\r\n  /**\r\n   * Updates conceptId for all notes of a conversation that have no concept set.\r\n   * Used when a conversation is auto-classified to retroactively link its tasks.\r\n   */\r\n  async updateConceptIdForConversation(\r\n    conversationId: string,\r\n    conceptId: string,\r\n    tenantId: string\r\n  ): Promise<void> {\r\n    await this.prisma.note.updateMany({\r\n      where: {\r\n        conversationId,\r\n        tenantId,\r\n        conceptId: null,\r\n      },\r\n      data: { conceptId },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if a task already exists tenant-wide by title (Story 3.4 AC3).\r\n   * Multiple tasks per concept are allowed  dedup is by title match only.\r\n   * When both conceptId and title are provided, requires BOTH to match for strongest dedup.\r\n   *\r\n   * @returns The existing task ID if found, null otherwise\r\n   */\r\n  async findExistingTask(\r\n    tenantId: string,\r\n    options: { conceptId?: string; title?: string }\r\n  ): Promise<string | null> {\r\n    const { conceptId, title } = options;\r\n\r\n    // Must provide at least one search criterion\r\n    if (!conceptId && !title) return null;\r\n\r\n    // Load all existing tasks once for both checks (efficient single query)\r\n    const candidates = await this.prisma.note.findMany({\r\n      where: {\r\n        tenantId,\r\n        noteType: NoteType.TASK,\r\n        status: { in: [NoteStatus.PENDING, NoteStatus.COMPLETED, NoteStatus.READY_FOR_REVIEW] },\r\n        parentNoteId: null, // Only top-level tasks, not workflow step children\r\n      },\r\n      select: { id: true, title: true, conceptId: true },\r\n      take: 500,\r\n    });\r\n\r\n    // Check 1: exact conceptId + title match (same concept AND same title = true duplicate)\r\n    if (conceptId && title) {\r\n      const normalizedTitle = title.toLowerCase().trim();\r\n      const byBoth = candidates.find(\r\n        (c) => c.conceptId === conceptId && c.title.toLowerCase().trim() === normalizedTitle\r\n      );\r\n      if (byBoth) return byBoth.id;\r\n    }\r\n\r\n    // Check 2: title-only match (catches duplicates across conversations with different/null conceptIds)\r\n    if (title) {\r\n      const normalizedTitle = title.toLowerCase().trim();\r\n      const byTitle = candidates.find((c) => c.title.toLowerCase().trim() === normalizedTitle);\r\n      if (byTitle) return byTitle.id;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Finds a reusable completed task for the same concept with high score.\r\n   * Used to skip redundant AI execution when prior high-quality work exists.\r\n   *\r\n   * @param tenantId - Tenant for isolation\r\n   * @param conceptId - Concept to match\r\n   * @param options - Score threshold (default 85) and max age in days (default 30)\r\n   * @returns The reusable task data or null if none qualifies\r\n   */\r\n  async findReusableTask(\r\n    tenantId: string,\r\n    conceptId: string,\r\n    options: { scoreThreshold?: number; maxAgeDays?: number } = {}\r\n  ): Promise<{\r\n    id: string; title: string; content: string;\r\n    userReport: string; aiScore: number; aiFeedback: string | null;\r\n  } | null> {\r\n    const threshold = options.scoreThreshold ?? 85;\r\n    const maxAge = options.maxAgeDays ?? 30;\r\n    const cutoffDate = new Date();\r\n    cutoffDate.setDate(cutoffDate.getDate() - maxAge);\r\n\r\n    const existing = await this.prisma.note.findFirst({\r\n      where: {\r\n        tenantId,\r\n        conceptId,\r\n        noteType: NoteType.TASK,\r\n        status: NoteStatus.COMPLETED,\r\n        aiScore: { gte: threshold },\r\n        createdAt: { gte: cutoffDate },\r\n        parentNoteId: null,\r\n        userReport: { not: null },\r\n      },\r\n      orderBy: { aiScore: 'desc' },\r\n      select: {\r\n        id: true, title: true, content: true,\r\n        userReport: true, aiScore: true, aiFeedback: true,\r\n      },\r\n    });\r\n\r\n    if (!existing?.userReport || !existing?.aiScore) return null;\r\n\r\n    return {\r\n      id: existing.id,\r\n      title: existing.title,\r\n      content: existing.content,\r\n      userReport: existing.userReport,\r\n      aiScore: existing.aiScore,\r\n      aiFeedback: existing.aiFeedback,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Checks if a sub-task already exists for a specific workflow step (Story 3.4 AC3).\r\n   *\r\n   * @returns The existing sub-task ID if found, null otherwise\r\n   */\r\n  async findExistingSubTask(\r\n    tenantId: string,\r\n    parentNoteId: string,\r\n    workflowStepNumber: number\r\n  ): Promise<string | null> {\r\n    const existing = await this.prisma.note.findFirst({\r\n      where: {\r\n        tenantId,\r\n        parentNoteId,\r\n        workflowStepNumber,\r\n        noteType: NoteType.TASK,\r\n      },\r\n      select: { id: true },\r\n    });\r\n    return existing?.id ?? null;\r\n  }\r\n\r\n  /**\r\n   * Gets all pending tasks for a user/tenant.\r\n   * Used for auto-triggering workflow execution from chat.\r\n   */\r\n  async getPendingTasksByUser(userId: string, tenantId: string) {\r\n    return this.prisma.note.findMany({\r\n      where: { userId, tenantId, noteType: 'TASK', status: 'PENDING' },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets pending task concept IDs for the brain tree (Story 3.2).\r\n   * If userId is provided, returns only that user's pending tasks.\r\n   * If omitted, returns all pending tasks for the tenant (PLATFORM_OWNER view).\r\n   */\r\n  async getPendingTaskConceptIds(\r\n    tenantId: string,\r\n    userId?: string\r\n  ): Promise<Array<{ conceptId: string; userId: string; noteId: string }>> {\r\n    const where: Record<string, unknown> = {\r\n      tenantId,\r\n      noteType: NoteType.TASK,\r\n      status: NoteStatus.PENDING,\r\n      conceptId: { not: null },\r\n    };\r\n    if (userId) where.userId = userId;\r\n\r\n    const notes = await this.prisma.note.findMany({\r\n      where,\r\n      select: { conceptId: true, userId: true, id: true },\r\n    });\r\n    return notes\r\n      .filter((n): n is typeof n & { conceptId: string } => n.conceptId !== null)\r\n      .map((n) => ({ conceptId: n.conceptId, userId: n.userId, noteId: n.id }));\r\n  }\r\n\r\n  /**\r\n   * Gets completed task concept IDs for the brain tree.\r\n   * A concept is \"completed\" when its TASK note has status COMPLETED.\r\n   */\r\n  async getCompletedTaskConceptIds(\r\n    tenantId: string,\r\n    userId?: string\r\n  ): Promise<Array<{ conceptId: string; userId: string; noteId: string }>> {\r\n    const where: Record<string, unknown> = {\r\n      tenantId,\r\n      noteType: NoteType.TASK,\r\n      status: NoteStatus.COMPLETED,\r\n      conceptId: { not: null },\r\n    };\r\n    if (userId) where.userId = userId;\r\n\r\n    const notes = await this.prisma.note.findMany({\r\n      where,\r\n      select: { conceptId: true, userId: true, id: true },\r\n    });\r\n    return notes\r\n      .filter((n): n is typeof n & { conceptId: string } => n.conceptId !== null)\r\n      .map((n) => ({ conceptId: n.conceptId, userId: n.userId, noteId: n.id }));\r\n  }\r\n\r\n  /**\r\n   * Updates the status of a note/task.\r\n   */\r\n  async updateStatus(noteId: string, status: NoteStatus, tenantId: string): Promise<NoteItem> {\r\n    const note = await this.prisma.note.findFirst({\r\n      where: { id: noteId, tenantId },\r\n    });\r\n    if (!note) {\r\n      throw new NotFoundException(`Note ${noteId} not found`);\r\n    }\r\n    const updated = await this.prisma.note.update({\r\n      where: { id: noteId },\r\n      data: { status },\r\n    });\r\n    return this.mapToNoteItem(updated);\r\n  }\r\n\r\n  /**\r\n   * Updates a note's title and content.\r\n   */\r\n  async updateNote(\r\n    noteId: string,\r\n    title: string | undefined,\r\n    content: string | undefined,\r\n    tenantId: string\r\n  ): Promise<NoteItem> {\r\n    const note = await this.prisma.note.findFirst({\r\n      where: { id: noteId, tenantId },\r\n    });\r\n    if (!note) {\r\n      throw new NotFoundException(`Note ${noteId} not found`);\r\n    }\r\n    const data: Record<string, unknown> = {};\r\n    if (title !== undefined) data.title = title;\r\n    if (content !== undefined) data.content = content;\r\n\r\n    const updated = await this.prisma.note.update({\r\n      where: { id: noteId },\r\n      data,\r\n    });\r\n    return this.mapToNoteItem(updated);\r\n  }\r\n\r\n  /**\r\n   * Deletes a note.\r\n   */\r\n  async deleteNote(noteId: string, tenantId: string): Promise<void> {\r\n    const note = await this.prisma.note.findFirst({\r\n      where: { id: noteId, tenantId },\r\n    });\r\n    if (!note) {\r\n      throw new NotFoundException(`Note ${noteId} not found`);\r\n    }\r\n    await this.prisma.note.delete({ where: { id: noteId } });\r\n  }\r\n\r\n  /**\r\n   * Submits a user completion report for a note/task.\r\n   */\r\n  async submitReport(noteId: string, report: string, tenantId: string): Promise<NoteItem> {\r\n    const note = await this.prisma.note.findFirst({\r\n      where: { id: noteId, tenantId },\r\n    });\r\n    if (!note) {\r\n      throw new NotFoundException(`Note ${noteId} not found`);\r\n    }\r\n    const updated = await this.prisma.note.update({\r\n      where: { id: noteId },\r\n      data: { userReport: report },\r\n    });\r\n    return this.mapToNoteItem(updated);\r\n  }\r\n\r\n  /**\r\n   * AI-generates a completion report for a task.\r\n   * Returns the generated text for user review before submission.\r\n   */\r\n  async generateReport(noteId: string, userId: string, tenantId: string): Promise<string> {\r\n    const note = await this.prisma.note.findFirst({\r\n      where: { id: noteId, tenantId },\r\n    });\r\n    if (!note) {\r\n      throw new NotFoundException(`Note ${noteId} not found`);\r\n    }\r\n\r\n    // Fetch child notes (workflow step outputs)  full content, no truncation\r\n    const children = await this.prisma.note.findMany({\r\n      where: { parentNoteId: noteId, tenantId },\r\n      orderBy: { workflowStepNumber: 'asc' },\r\n    });\r\n\r\n    let prompt: string;\r\n\r\n    if (children.length > 0) {\r\n      // Workflow steps exist  synthesize into FINAL DELIVERABLE\r\n      const workflowResults = children\r\n        .map((child, i) => {\r\n          const stepNum = child.workflowStepNumber ?? i + 1;\r\n          return `--- KORAK ${stepNum}: ${child.title} ---\\n${child.content}`;\r\n        })\r\n        .join('\\n\\n');\r\n\r\n      prompt = `Ti si vrhunski poslovni strunjak. Tvoj tim je zavrio detaljnu analizu i istraivanje kroz ${children.length} koraka workflow-a. Sintetii SVE rezultate u FINALNI DOKUMENT koji vlasnik poslovanja moe odmah da koristi.\r\n\r\nZADATAK: ${note.title}\r\n${note.expectedOutcome ? `OEKIVANI REZULTAT: ${note.expectedOutcome}` : ''}\r\n\r\nREZULTATI ISTRAIVANJA I ANALIZE (ovo je tvoj ulazni materijal  koristi SVE podatke):\r\n${workflowResults}\r\n\r\nKRITINO  RAZLIKUJ DVA TIPA ZADATAKA:\r\nA) DIGITALNI (sadraj, planovi, analize, mejlovi, kampanje, budeti, abloni, procedure):\r\n    PROIZVEDI GOTOV REZULTAT. Ne daj instrukcije  NAPII sam dokument/sadraj/plan.\r\nB) FIZIKI (odlazak negde, naruivanje, pozivi, instalacija, sastanci):\r\n    NE simuliraj da si obavio fiziku radnju. Napii KO treba TA da uradi sa detaljima.\r\n    Oznai sa \" ZAHTEVA LJUDSKU AKCIJU:\" ispred svakog fizikog koraka.\r\n\r\nINSTRUKCIJE:\r\n1. Ovo NIJE izvetaj o tome ta je uraeno. Ovo je FINALNI DELIVERABLE  gotov dokument koji vlasnik koristi.\r\n2. Ako su koraci proizveli analizu  sintetii u GOTOV AKCIONI PLAN sa preporukama, rokovima, odgovornim osobama\r\n3. Ako su koraci definisali strategiju  napravi KOMPLETNU STRATEGIJU sa koracima implementacije i metrikama\r\n4. Ako su koraci istraili vrednost  definii KONKRETNE OBLIKE VREDNOSTI sa cenovnom strategijom\r\n5. Ako su koraci kreirali sadraj  napravi GOTOV SADRAJ spreman za objavljivanje\r\n6. NIKADA ne pii \"trebalo bi da...\" za digitalne zadatke  NAPRAVI to sam\r\n7. NIKADA ne izmiljaj podatke  ako nema konkretan podatak, naznai [POPUNITI: ...]\r\n8. Koristi specifine podatke, brojke i nalaze iz koraka  nemoj generalizovati\r\n9. Strukturiraj sa jasnim zaglavljima, tabelama, nabrajanjima\r\n10. NIKADA ne pii \"u prethodnim koracima smo...\"  PRIKAI gotov rezultat\r\n11. Dodaj \"Sledei koraci\" SAMO za stavke koje zahtevaju LJUDSKU intervenciju\r\n\r\nOdgovaraj ISKLJUIVO na srpskom jeziku.`;\r\n    } else {\r\n      // No workflow steps  simple task, do the work directly\r\n      prompt = `Ti si poslovni strunjak. IZVRI sledei zadatak u potpunosti.\r\n\r\nZADATAK: ${note.title}\r\n${note.content ? `OPIS: ${note.content}` : ''}\r\n${note.expectedOutcome ? `OEKIVANI REZULTAT: ${note.expectedOutcome}` : ''}\r\n\r\nKRITINO  RAZLIKUJ:\r\nA) DIGITALNI ZADACI (sadraj, planovi, analize, mejlovi, kampanje, budeti, abloni):\r\n    PROIZVEDI GOTOV REZULTAT. Ne pii instrukcije  NAPII sam dokument.\r\nB) FIZIKI ZADACI (odlazak, naruivanje, pozivi, instalacija):\r\n    NE simuliraj fiziku radnju. Napii ko treba ta da uradi sa detaljima.\r\n    Oznai: \" ZAHTEVA LJUDSKU AKCIJU:\" ispred fizikih koraka.\r\n\r\nProizvedi kompletan, profesionalan rezultat. NIKADA ne pii \"trebalo bi da...\" za digitalne zadatke. Ako nema podatak, naznai [POPUNITI: ...]. Odgovaraj na srpskom jeziku.`;\r\n    }\r\n\r\n    let fullResponse = '';\r\n    await this.aiGateway.streamCompletionWithContext(\r\n      [{ role: 'user', content: prompt }],\r\n      { tenantId, userId },\r\n      (chunk) => {\r\n        fullResponse += chunk;\r\n      }\r\n    );\r\n\r\n    const result = fullResponse.trim() || 'Generisanje nije uspelo. Pokuajte ponovo.';\r\n\r\n    // Auto-save as userReport and mark as COMPLETED\r\n    await this.prisma.note.update({\r\n      where: { id: noteId },\r\n      data: {\r\n        userReport: result,\r\n        status: 'COMPLETED',\r\n      },\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * AI-scores a user's completion report.\r\n   */\r\n  async scoreReport(noteId: string, userId: string, tenantId: string): Promise<NoteItem> {\r\n    const note = await this.prisma.note.findFirst({\r\n      where: { id: noteId, tenantId },\r\n    });\r\n    if (!note) {\r\n      throw new NotFoundException(`Note ${noteId} not found`);\r\n    }\r\n    if (!note.userReport) {\r\n      throw new NotFoundException(`Note ${noteId} has no report to score`);\r\n    }\r\n\r\n    const scoringPrompt = `Ti si AI mentor za poslovanje. Oceni izvetaj korisnika o zavrenom zadatku.\r\n\r\nZADATAK:\r\nNaslov: ${note.title}\r\nOpis: ${note.content}\r\n${note.expectedOutcome ? `Oekivani ishod: ${note.expectedOutcome}` : ''}\r\n\r\nIZVETAJ KORISNIKA:\r\n${note.userReport}\r\n\r\nOceni na skali 0-100 na osnovu:\r\n- Kompletnost: Da li su svi aspekti zadatka pokriveni?\r\n- Specifinost: Da li su navedeni konkretni detalji umesto optih fraza?\r\n- Kvalitet analize: Da li je korisnik pokazao razumevanje?\r\n- Primenljivost: Da li se rezultati mogu primeniti u praksi?\r\n\r\nOdgovori ISKLJUIVO u JSON formatu:\r\n{\"score\": <broj 0-100>, \"feedback\": \"<2-3 reenice na srpskom sa konkretnim savetima za poboljanje>\"}`;\r\n\r\n    let fullResponse = '';\r\n    await this.aiGateway.streamCompletionWithContext(\r\n      [{ role: 'user', content: scoringPrompt }],\r\n      { tenantId, userId },\r\n      (chunk) => {\r\n        fullResponse += chunk;\r\n      }\r\n    );\r\n\r\n    let score = 50;\r\n    let feedback = 'Ocenjivanje nije uspelo. Pokuajte ponovo.';\r\n    try {\r\n      const jsonMatch = fullResponse.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        const parsed = JSON.parse(jsonMatch[0]);\r\n        score = Math.max(0, Math.min(100, Number(parsed.score) || 50));\r\n        feedback = parsed.feedback || feedback;\r\n      }\r\n    } catch {\r\n      this.logger.warn({\r\n        message: 'Failed to parse AI scoring response',\r\n        noteId,\r\n        response: fullResponse.substring(0, 200),\r\n      });\r\n    }\r\n\r\n    const updated = await this.prisma.note.update({\r\n      where: { id: noteId },\r\n      data: { aiScore: score, aiFeedback: feedback },\r\n    });\r\n    return this.mapToNoteItem(updated);\r\n  }\r\n\r\n  //  Comment methods (Story 3.4 AC4) \r\n\r\n  /**\r\n   * Creates a comment on a task or workflow step note.\r\n   *\r\n   * @param taskId - The parent note ID (task or workflow step)\r\n   * @param content - Comment text\r\n   * @param userId - The commenting user's ID\r\n   * @param tenantId - Tenant for isolation\r\n   * @returns Created comment with user info\r\n   */\r\n  async createComment(\r\n    taskId: string,\r\n    content: string,\r\n    userId: string,\r\n    tenantId: string\r\n  ): Promise<{ id: string; content: string; userId: string; createdAt: string }> {\r\n    // Verify parent task exists and is a TASK type\r\n    const parent = await this.prisma.note.findFirst({\r\n      where: { id: taskId, tenantId },\r\n      select: { id: true, noteType: true },\r\n    });\r\n    if (!parent) {\r\n      throw new NotFoundException(`Task ${taskId} not found`);\r\n    }\r\n    if (parent.noteType !== NoteType.TASK) {\r\n      throw new BadRequestException('Comments can only be added to tasks or workflow steps');\r\n    }\r\n\r\n    const id = `note_${createId()}`;\r\n    const comment = await this.prisma.note.create({\r\n      data: {\r\n        id,\r\n        title: 'Comment',\r\n        content,\r\n        source: NoteSource.MANUAL,\r\n        noteType: NoteType.COMMENT,\r\n        parentNoteId: taskId,\r\n        userId,\r\n        tenantId,\r\n      },\r\n    });\r\n\r\n    return {\r\n      id: comment.id,\r\n      content: comment.content,\r\n      userId: comment.userId,\r\n      createdAt: comment.createdAt.toISOString(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets all comments for a task/workflow step, ordered oldest first.\r\n   * Includes user info (name, role) from the User model.\r\n   *\r\n   * @param taskId - The parent note ID\r\n   * @param tenantId - Tenant for isolation\r\n   * @param page - Page number (1-based, default 1)\r\n   * @param limit - Items per page (default 50)\r\n   */\r\n  async getCommentsByTask(\r\n    taskId: string,\r\n    tenantId: string,\r\n    page = 1,\r\n    limit = 50\r\n  ): Promise<{\r\n    comments: Array<{\r\n      id: string;\r\n      content: string;\r\n      userId: string;\r\n      userName: string;\r\n      userRole: string;\r\n      createdAt: string;\r\n      updatedAt: string;\r\n    }>;\r\n    total: number;\r\n    page: number;\r\n    limit: number;\r\n  }> {\r\n    // Enforce pagination bounds\r\n    page = Math.max(1, page || 1);\r\n    limit = Math.min(100, Math.max(1, limit || 50));\r\n    const skip = (page - 1) * limit;\r\n\r\n    const [comments, total] = await Promise.all([\r\n      this.prisma.note.findMany({\r\n        where: {\r\n          parentNoteId: taskId,\r\n          tenantId,\r\n          noteType: NoteType.COMMENT,\r\n        },\r\n        orderBy: { createdAt: 'asc' },\r\n        skip,\r\n        take: limit,\r\n      }),\r\n      this.prisma.note.count({\r\n        where: {\r\n          parentNoteId: taskId,\r\n          tenantId,\r\n          noteType: NoteType.COMMENT,\r\n        },\r\n      }),\r\n    ]);\r\n\r\n    // Resolve user info\r\n    const userIds = [...new Set(comments.map((c) => c.userId))];\r\n    const users =\r\n      userIds.length > 0\r\n        ? await this.prisma.user.findMany({\r\n            where: { id: { in: userIds } },\r\n            select: { id: true, name: true, role: true },\r\n          })\r\n        : [];\r\n    const userMap = new Map(users.map((u) => [u.id, u]));\r\n\r\n    return {\r\n      comments: comments.map((c) => {\r\n        const user = userMap.get(c.userId);\r\n        return {\r\n          id: c.id,\r\n          content: c.content,\r\n          userId: c.userId,\r\n          userName: user?.name ?? c.userId,\r\n          userRole: user?.role ?? 'MEMBER',\r\n          createdAt: c.createdAt.toISOString(),\r\n          updatedAt: c.updatedAt.toISOString(),\r\n        };\r\n      }),\r\n      total,\r\n      page,\r\n      limit,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Updates a comment's content. Only the comment author can edit.\r\n   *\r\n   * @param commentId - The comment note ID\r\n   * @param content - New comment content\r\n   * @param userId - The requesting user (must be author)\r\n   * @param tenantId - Tenant for isolation\r\n   */\r\n  async updateComment(\r\n    commentId: string,\r\n    content: string,\r\n    userId: string,\r\n    tenantId: string\r\n  ): Promise<{ id: string; content: string; updatedAt: string }> {\r\n    const comment = await this.prisma.note.findFirst({\r\n      where: { id: commentId, tenantId, noteType: NoteType.COMMENT },\r\n    });\r\n    if (!comment) {\r\n      throw new NotFoundException(`Comment ${commentId} not found`);\r\n    }\r\n    if (comment.userId !== userId) {\r\n      throw new ForbiddenException('Only the comment author can edit');\r\n    }\r\n\r\n    const updated = await this.prisma.note.update({\r\n      where: { id: commentId },\r\n      data: { content },\r\n    });\r\n\r\n    return {\r\n      id: updated.id,\r\n      content: updated.content,\r\n      updatedAt: updated.updatedAt.toISOString(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Deletes a comment. Only the author or TENANT_OWNER/PLATFORM_OWNER can delete.\r\n   *\r\n   * @param commentId - The comment note ID\r\n   * @param userId - The requesting user\r\n   * @param role - The requesting user's role\r\n   * @param tenantId - Tenant for isolation\r\n   */\r\n  async deleteComment(\r\n    commentId: string,\r\n    userId: string,\r\n    role: string,\r\n    tenantId: string\r\n  ): Promise<void> {\r\n    const comment = await this.prisma.note.findFirst({\r\n      where: { id: commentId, tenantId, noteType: NoteType.COMMENT },\r\n    });\r\n    if (!comment) {\r\n      throw new NotFoundException(`Comment ${commentId} not found`);\r\n    }\r\n\r\n    const isOwner = role === 'PLATFORM_OWNER' || role === 'TENANT_OWNER';\r\n    if (comment.userId !== userId && !isOwner) {\r\n      throw new ForbiddenException('Only the comment author or an owner can delete');\r\n    }\r\n\r\n    await this.prisma.note.delete({ where: { id: commentId } });\r\n  }\r\n\r\n  private mapToNoteItem(note: {\r\n    id: string;\r\n    title: string;\r\n    content: string;\r\n    source: NoteSource;\r\n    noteType: NoteType;\r\n    status: NoteStatus | null;\r\n    conversationId: string | null;\r\n    conceptId: string | null;\r\n    messageId: string | null;\r\n    parentNoteId?: string | null;\r\n    userReport?: string | null;\r\n    aiScore?: number | null;\r\n    aiFeedback?: string | null;\r\n    expectedOutcome?: string | null;\r\n    workflowStepNumber?: number | null;\r\n    reusedFromNoteId?: string | null;\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n  }): NoteItem {\r\n    return {\r\n      id: note.id,\r\n      title: note.title,\r\n      content: note.content,\r\n      source: note.source as NoteItem['source'],\r\n      noteType: note.noteType as NoteItem['noteType'],\r\n      status: note.status as NoteItem['status'],\r\n      conversationId: note.conversationId,\r\n      conceptId: note.conceptId,\r\n      messageId: note.messageId,\r\n      createdAt: note.createdAt.toISOString(),\r\n      updatedAt: note.updatedAt.toISOString(),\r\n      parentNoteId: note.parentNoteId ?? null,\r\n      userReport: note.userReport ?? null,\r\n      aiScore: note.aiScore ?? null,\r\n      aiFeedback: note.aiFeedback ?? null,\r\n      expectedOutcome: note.expectedOutcome ?? null,\r\n      workflowStepNumber: note.workflowStepNumber ?? null,\r\n      reusedFromNoteId: note.reusedFromNoteId ?? null,\r\n    };\r\n  }\r\n\r\n  private mapToNoteItemWithChildren(\r\n    note: Parameters<NotesService['mapToNoteItem']>[0] & {\r\n      children?: Array<Parameters<NotesService['mapToNoteItem']>[0]>;\r\n    }\r\n  ): NoteItem {\r\n    const mapped = this.mapToNoteItem(note);\r\n    if (note.children && note.children.length > 0) {\r\n      mapped.children = note.children.map((c) => this.mapToNoteItem(c));\r\n    }\r\n    return mapped;\r\n  }\r\n}\r\n","import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Patch,\r\n  Delete,\r\n  Body,\r\n  Param,\r\n  Query,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n} from '@nestjs/common';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\nimport { NotesService } from './notes.service';\r\nimport { NoteSource, NoteType, NoteStatus } from '@mentor-ai/shared/prisma';\r\nimport { CreateCommentDto, UpdateCommentDto } from './dto/comment.dto';\r\n\r\n@Controller('v1/notes')\r\n@UseGuards(JwtAuthGuard)\r\nexport class NotesController {\r\n  constructor(private readonly notesService: NotesService) {}\r\n\r\n  /**\r\n   * Create a new note (manual).\r\n   */\r\n  @Post()\r\n  @HttpCode(HttpStatus.CREATED)\r\n  async createNote(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body()\r\n    body: {\r\n      title: string;\r\n      content: string;\r\n      noteType?: string;\r\n      status?: string;\r\n      conversationId?: string;\r\n      conceptId?: string;\r\n    }\r\n  ) {\r\n    const result = await this.notesService.createNote({\r\n      title: body.title,\r\n      content: body.content,\r\n      source: NoteSource.MANUAL,\r\n      noteType: (body.noteType as NoteType) ?? NoteType.NOTE,\r\n      status:\r\n        body.noteType === 'TASK' ? ((body.status as NoteStatus) ?? NoteStatus.PENDING) : undefined,\r\n      conversationId: body.conversationId,\r\n      conceptId: body.conceptId,\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n    });\r\n    return { data: result };\r\n  }\r\n\r\n  /**\r\n   * Get notes for a specific conversation.\r\n   */\r\n  @Get('conversation/:conversationId')\r\n  async getByConversation(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('conversationId') conversationId: string\r\n  ) {\r\n    const notes = await this.notesService.getByConversation(\r\n      conversationId,\r\n      user.userId,\r\n      user.tenantId\r\n    );\r\n    return { data: notes };\r\n  }\r\n\r\n  /**\r\n   * Get notes for a specific concept.\r\n   */\r\n  @Get('concept/:conceptId')\r\n  async getByConcept(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('conceptId') conceptId: string\r\n  ) {\r\n    const notes = await this.notesService.getByConcept(conceptId, user.userId, user.tenantId);\r\n    return { data: notes };\r\n  }\r\n\r\n  /**\r\n   * Update a note's status (toggle task completion).\r\n   */\r\n  @Patch(':id/status')\r\n  async updateStatus(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') id: string,\r\n    @Body() body: { status: string }\r\n  ) {\r\n    const note = await this.notesService.updateStatus(id, body.status as NoteStatus, user.tenantId);\r\n    return { data: note };\r\n  }\r\n\r\n  /**\r\n   * Update a note's title and/or content.\r\n   */\r\n  @Patch(':id')\r\n  async updateNote(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') id: string,\r\n    @Body() body: { title?: string; content?: string }\r\n  ) {\r\n    const note = await this.notesService.updateNote(id, body.title, body.content, user.tenantId);\r\n    return { data: note };\r\n  }\r\n\r\n  /**\r\n   * Submit a user completion report for a note/task.\r\n   */\r\n  @Post(':id/report')\r\n  async submitReport(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') id: string,\r\n    @Body() body: { report: string }\r\n  ) {\r\n    const note = await this.notesService.submitReport(id, body.report, user.tenantId);\r\n    return { data: note };\r\n  }\r\n\r\n  /**\r\n   * AI-generate a completion report for a task.\r\n   * Returns the generated text for user review before submission.\r\n   */\r\n  @Post(':id/generate-report')\r\n  async generateReport(@CurrentUser() user: CurrentUserPayload, @Param('id') id: string) {\r\n    const report = await this.notesService.generateReport(id, user.userId, user.tenantId);\r\n    return { data: { report } };\r\n  }\r\n\r\n  /**\r\n   * AI-score a user's completion report.\r\n   */\r\n  @Post(':id/score')\r\n  async scoreReport(@CurrentUser() user: CurrentUserPayload, @Param('id') id: string) {\r\n    const note = await this.notesService.scoreReport(id, user.userId, user.tenantId);\r\n    return { data: note };\r\n  }\r\n\r\n  //  Comment endpoints (Story 3.4 AC4) \r\n\r\n  /**\r\n   * Create a comment on a task or workflow step.\r\n   */\r\n  @Post(':taskId/comments')\r\n  @HttpCode(HttpStatus.CREATED)\r\n  async createComment(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('taskId') taskId: string,\r\n    @Body() body: CreateCommentDto\r\n  ) {\r\n    const comment = await this.notesService.createComment(\r\n      taskId,\r\n      body.content,\r\n      user.userId,\r\n      user.tenantId\r\n    );\r\n    return { data: comment };\r\n  }\r\n\r\n  /**\r\n   * Get comments for a task or workflow step.\r\n   * Supports pagination via ?page=1&limit=50 query params.\r\n   */\r\n  @Get(':taskId/comments')\r\n  async getComments(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('taskId') taskId: string,\r\n    @Query('page') page?: string,\r\n    @Query('limit') limit?: string\r\n  ) {\r\n    const result = await this.notesService.getCommentsByTask(\r\n      taskId,\r\n      user.tenantId,\r\n      page ? parseInt(page, 10) : 1,\r\n      limit ? parseInt(limit, 10) : 50\r\n    );\r\n    return { data: result };\r\n  }\r\n\r\n  /**\r\n   * Edit a comment (author-only).\r\n   */\r\n  @Patch(':commentId/comment')\r\n  async updateComment(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('commentId') commentId: string,\r\n    @Body() body: UpdateCommentDto\r\n  ) {\r\n    const updated = await this.notesService.updateComment(\r\n      commentId,\r\n      body.content,\r\n      user.userId,\r\n      user.tenantId\r\n    );\r\n    return { data: updated };\r\n  }\r\n\r\n  /**\r\n   * Delete a comment (author or owner only).\r\n   */\r\n  @Delete(':commentId/comment')\r\n  @HttpCode(HttpStatus.NO_CONTENT)\r\n  async deleteComment(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('commentId') commentId: string\r\n  ) {\r\n    await this.notesService.deleteComment(commentId, user.userId, user.role, user.tenantId);\r\n  }\r\n\r\n  /**\r\n   * Delete a note.\r\n   */\r\n  @Delete(':id')\r\n  @HttpCode(HttpStatus.NO_CONTENT)\r\n  async deleteNote(@CurrentUser() user: CurrentUserPayload, @Param('id') id: string) {\r\n    await this.notesService.deleteNote(id, user.tenantId);\r\n  }\r\n}\r\n","import { IsString, IsNotEmpty, MaxLength } from 'class-validator';\r\n\r\n/**\r\n * DTO for creating a comment on a task or workflow step.\r\n */\r\nexport class CreateCommentDto {\r\n  @IsString()\r\n  @IsNotEmpty({ message: 'Comment content must not be empty' })\r\n  @MaxLength(5000, { message: 'Comment content must be at most 5000 characters' })\r\n  content!: string;\r\n}\r\n\r\n/**\r\n * DTO for updating a comment's content.\r\n */\r\nexport class UpdateCommentDto {\r\n  @IsString()\r\n  @IsNotEmpty({ message: 'Comment content must not be empty' })\r\n  @MaxLength(5000, { message: 'Comment content must be at most 5000 characters' })\r\n  content!: string;\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { MemoryController } from './memory.controller';\r\nimport { MemoryService } from './services/memory.service';\r\nimport { MemoryExtractionService } from './services/memory-extraction.service';\r\nimport { MemoryEmbeddingService } from './services/memory-embedding.service';\r\nimport { MemoryContextBuilderService } from './services/memory-context-builder.service';\r\nimport { LlmConfigModule } from '../llm-config/llm-config.module';\r\n\r\n/**\r\n * Module for persistent memory across conversations.\r\n * Provides services for creating, retrieving, and managing user memories.\r\n *\r\n * Story 2.7: Persistent Memory Across Conversations\r\n */\r\n@Module({\r\n  imports: [\r\n    ConfigModule,\r\n    TenantModule,\r\n    AuthModule, // Provides AuthService for guards\r\n    LlmConfigModule, // For LLM extraction calls\r\n  ],\r\n  controllers: [MemoryController],\r\n  providers: [\r\n    MemoryService,\r\n    MemoryExtractionService,\r\n    MemoryEmbeddingService,\r\n    MemoryContextBuilderService,\r\n  ],\r\n  exports: [\r\n    MemoryService,\r\n    MemoryExtractionService,\r\n    MemoryEmbeddingService,\r\n    MemoryContextBuilderService,\r\n  ],\r\n})\r\nexport class MemoryModule {}\r\n","import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Patch,\r\n  Delete,\r\n  Body,\r\n  Param,\r\n  Query,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { IsString, Equals } from 'class-validator';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\nimport { MemoryService } from './services/memory.service';\r\nimport { CreateMemoryDto } from './dto/create-memory.dto';\r\nimport { UpdateMemoryDto } from './dto/update-memory.dto';\r\nimport type {\r\n  Memory,\r\n  MemoryType,\r\n  MemoryListResponse,\r\n  MemoryResponse,\r\n  MemoryDeleteResponse,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Request body for forgetting all memories.\r\n * Requires typing \"FORGET\" to confirm deletion.\r\n */\r\nclass ForgetAllDto {\r\n  @IsString()\r\n  confirmation!: string;\r\n}\r\n\r\n/**\r\n * Controller for memory management endpoints.\r\n * All endpoints require JWT authentication.\r\n * Operations are tenant-scoped through the user's JWT claims.\r\n *\r\n * Story 2.7: Persistent Memory Across Conversations\r\n */\r\n@Controller('v1/memory')\r\n@UseGuards(JwtAuthGuard)\r\nexport class MemoryController {\r\n  private readonly logger = new Logger(MemoryController.name);\r\n\r\n  constructor(private readonly memoryService: MemoryService) {}\r\n\r\n  /**\r\n   * Lists all memories for the current user.\r\n   *\r\n   * @param type - Filter by memory type\r\n   * @param subject - Filter by subject (client/project name)\r\n   * @param search - Search in content\r\n   * @param limit - Max results (default 20, max 100)\r\n   * @param offset - Pagination offset\r\n   */\r\n  @Get()\r\n  @HttpCode(HttpStatus.OK)\r\n  async listMemories(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Query('type') type?: MemoryType,\r\n    @Query('subject') subject?: string,\r\n    @Query('search') search?: string,\r\n    @Query('limit') limit?: string,\r\n    @Query('offset') offset?: string\r\n  ): Promise<MemoryListResponse> {\r\n    this.logger.log({\r\n      message: 'Listing memories',\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n      type,\r\n      subject,\r\n      search,\r\n    });\r\n\r\n    const result = await this.memoryService.findMemories(\r\n      user.tenantId,\r\n      user.userId,\r\n      {\r\n        type,\r\n        subject,\r\n        search,\r\n        limit: limit ? parseInt(limit, 10) : undefined,\r\n        offset: offset ? parseInt(offset, 10) : undefined,\r\n      }\r\n    );\r\n\r\n    return {\r\n      data: result.data,\r\n      meta: result.meta,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets a single memory by ID.\r\n   *\r\n   * @param id - Memory ID (mem_ prefix)\r\n   */\r\n  @Get(':id')\r\n  @HttpCode(HttpStatus.OK)\r\n  async getMemory(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') memoryId: string\r\n  ): Promise<MemoryResponse> {\r\n    this.logger.log({\r\n      message: 'Getting memory',\r\n      memoryId,\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n    });\r\n\r\n    const memory = await this.memoryService.getMemory(\r\n      user.tenantId,\r\n      memoryId,\r\n      user.userId\r\n    );\r\n\r\n    return {\r\n      data: memory,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Creates a new memory entry.\r\n   * Typically used for user-stated memories rather than AI-extracted ones.\r\n   */\r\n  @Post()\r\n  @HttpCode(HttpStatus.CREATED)\r\n  async createMemory(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: CreateMemoryDto\r\n  ): Promise<MemoryResponse> {\r\n    this.logger.log({\r\n      message: 'Creating memory',\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n      type: dto.type,\r\n      source: dto.source,\r\n    });\r\n\r\n    const memory = await this.memoryService.createMemory(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto\r\n    );\r\n\r\n    return {\r\n      data: memory,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Updates/corrects a memory entry.\r\n   * Source is automatically set to USER_CORRECTED.\r\n   *\r\n   * @param id - Memory ID (mem_ prefix)\r\n   */\r\n  @Patch(':id')\r\n  @HttpCode(HttpStatus.OK)\r\n  async updateMemory(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') memoryId: string,\r\n    @Body() dto: UpdateMemoryDto\r\n  ): Promise<MemoryResponse> {\r\n    this.logger.log({\r\n      message: 'Updating memory',\r\n      memoryId,\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n    });\r\n\r\n    const memory = await this.memoryService.updateMemory(\r\n      user.tenantId,\r\n      memoryId,\r\n      user.userId,\r\n      dto\r\n    );\r\n\r\n    return {\r\n      data: memory,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Soft-deletes a memory entry.\r\n   * The memory is marked as deleted but not physically removed.\r\n   *\r\n   * @param id - Memory ID (mem_ prefix)\r\n   */\r\n  @Delete(':id')\r\n  @HttpCode(HttpStatus.OK)\r\n  async deleteMemory(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') memoryId: string\r\n  ): Promise<MemoryDeleteResponse> {\r\n    this.logger.log({\r\n      message: 'Deleting memory',\r\n      memoryId,\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n    });\r\n\r\n    await this.memoryService.deleteMemory(user.tenantId, memoryId, user.userId);\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Memory deleted successfully',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Forgets all memories for the current user.\r\n   * Requires typing \"FORGET\" to confirm.\r\n   */\r\n  @Post('forget-all')\r\n  @HttpCode(HttpStatus.OK)\r\n  async forgetAll(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: ForgetAllDto\r\n  ): Promise<{ success: boolean; deletedCount: number }> {\r\n    this.logger.warn({\r\n      message: 'User requesting to forget all memories',\r\n      userId: user.userId,\r\n      tenantId: user.tenantId,\r\n    });\r\n\r\n    const result = await this.memoryService.forgetAll(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.confirmation\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      deletedCount: result.deletedCount,\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Injectable,\r\n  Logger,\r\n  NotFoundException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { TenantPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport type {\r\n  Memory,\r\n  MemoryType,\r\n  MemorySource,\r\n} from '@mentor-ai/shared/types';\r\nimport { CreateMemoryDto } from '../dto/create-memory.dto';\r\nimport { UpdateMemoryDto } from '../dto/update-memory.dto';\r\n\r\n/**\r\n * Query options for listing memories.\r\n */\r\nexport interface MemoryQueryOptions {\r\n  /** Filter by memory type */\r\n  type?: MemoryType;\r\n  /** Filter by subject (client/project name) */\r\n  subject?: string;\r\n  /** Search query for content */\r\n  search?: string;\r\n  /** Pagination limit */\r\n  limit?: number;\r\n  /** Pagination offset */\r\n  offset?: number;\r\n  /** Include soft-deleted memories */\r\n  includeDeleted?: boolean;\r\n}\r\n\r\n/**\r\n * Service for managing user memories.\r\n * All operations are tenant-scoped through the TenantPrismaService.\r\n *\r\n * Story 2.7: Persistent Memory Across Conversations\r\n */\r\n@Injectable()\r\nexport class MemoryService {\r\n  private readonly logger = new Logger(MemoryService.name);\r\n\r\n  constructor(private readonly tenantPrisma: TenantPrismaService) {}\r\n\r\n  /**\r\n   * Creates a new memory entry.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param userId - User ID who owns the memory\r\n   * @param dto - Memory creation data\r\n   * @returns Created memory\r\n   */\r\n  async createMemory(\r\n    tenantId: string,\r\n    userId: string,\r\n    dto: CreateMemoryDto\r\n  ): Promise<Memory> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n    const memoryId = `mem_${createId()}`;\r\n\r\n    const memory = await prisma.memory.create({\r\n      data: {\r\n        id: memoryId,\r\n        tenantId,\r\n        userId,\r\n        type: dto.type,\r\n        source: dto.source,\r\n        content: dto.content,\r\n        subject: dto.subject ?? null,\r\n        confidence: dto.confidence ?? 1.0,\r\n        sourceMessageId: dto.sourceMessageId ?? null,\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Memory created',\r\n      memoryId,\r\n      userId,\r\n      tenantId,\r\n      type: dto.type,\r\n      source: dto.source,\r\n      subject: dto.subject ?? 'none',\r\n    });\r\n\r\n    return this.mapMemory(memory);\r\n  }\r\n\r\n  /**\r\n   * Finds memories for a user with optional filtering.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param userId - User ID to filter memories\r\n   * @param options - Query options for filtering and pagination\r\n   * @returns Paginated list of memories with total count\r\n   */\r\n  async findMemories(\r\n    tenantId: string,\r\n    userId: string,\r\n    options: MemoryQueryOptions = {}\r\n  ): Promise<{ data: Memory[]; meta: { total: number; limit: number; offset: number } }> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n    const limit = Math.min(options.limit ?? 20, 100);\r\n    const offset = options.offset ?? 0;\r\n\r\n    const where: Record<string, unknown> = {\r\n      tenantId,\r\n      userId,\r\n    };\r\n\r\n    // Only include non-deleted memories by default\r\n    if (!options.includeDeleted) {\r\n      where.isDeleted = false;\r\n    }\r\n\r\n    if (options.type) {\r\n      where.type = options.type;\r\n    }\r\n\r\n    if (options.subject) {\r\n      where.subject = { contains: options.subject, mode: 'insensitive' };\r\n    }\r\n\r\n    if (options.search) {\r\n      where.content = { contains: options.search, mode: 'insensitive' };\r\n    }\r\n\r\n    const [memories, total] = await Promise.all([\r\n      prisma.memory.findMany({\r\n        where,\r\n        orderBy: { createdAt: 'desc' },\r\n        skip: offset,\r\n        take: limit,\r\n      }),\r\n      prisma.memory.count({ where }),\r\n    ]);\r\n\r\n    this.logger.debug({\r\n      message: 'Memories query executed',\r\n      userId,\r\n      tenantId,\r\n      type: options.type,\r\n      resultCount: memories.length,\r\n      total,\r\n    });\r\n\r\n    return {\r\n      data: memories.map((m) => this.mapMemory(m)),\r\n      meta: { total, limit, offset },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Finds relevant memories for a query using keyword matching.\r\n   * This is a fallback method when semantic search is not available.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param userId - User ID to filter memories\r\n   * @param query - Search query\r\n   * @param limit - Maximum number of results\r\n   * @returns List of relevant memories\r\n   */\r\n  async findRelevantMemories(\r\n    tenantId: string,\r\n    userId: string,\r\n    query: string,\r\n    limit: number = 10\r\n  ): Promise<Memory[]> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    // Simple keyword search - will be enhanced with semantic search via MemoryEmbeddingService\r\n    const memories = await prisma.memory.findMany({\r\n      where: {\r\n        tenantId,\r\n        userId,\r\n        isDeleted: false,\r\n        OR: [\r\n          { content: { contains: query, mode: 'insensitive' } },\r\n          { subject: { contains: query, mode: 'insensitive' } },\r\n        ],\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: limit,\r\n    });\r\n\r\n    this.logger.debug({\r\n      message: 'Relevant memories search',\r\n      userId,\r\n      tenantId,\r\n      query: query.substring(0, 50),\r\n      resultCount: memories.length,\r\n    });\r\n\r\n    return memories.map((m) => this.mapMemory(m));\r\n  }\r\n\r\n  /**\r\n   * Gets a single memory by ID.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param memoryId - Memory ID to retrieve\r\n   * @param userId - User ID for ownership verification\r\n   * @returns Memory entry\r\n   * @throws NotFoundException if memory not found\r\n   * @throws ForbiddenException if user doesn't own the memory\r\n   */\r\n  async getMemory(\r\n    tenantId: string,\r\n    memoryId: string,\r\n    userId: string\r\n  ): Promise<Memory> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const memory = await prisma.memory.findUnique({\r\n      where: { id: memoryId },\r\n    });\r\n\r\n    if (!memory) {\r\n      throw new NotFoundException({\r\n        type: 'memory_not_found',\r\n        title: 'Memory Not Found',\r\n        status: 404,\r\n        detail: `Memory with ID ${memoryId} not found`,\r\n      });\r\n    }\r\n\r\n    if (memory.userId !== userId || memory.tenantId !== tenantId) {\r\n      throw new ForbiddenException({\r\n        type: 'memory_access_denied',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have access to this memory',\r\n      });\r\n    }\r\n\r\n    return this.mapMemory(memory);\r\n  }\r\n\r\n  /**\r\n   * Updates/corrects a memory entry.\r\n   * Source is automatically set to USER_CORRECTED.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param memoryId - Memory ID to update\r\n   * @param userId - User ID for ownership verification\r\n   * @param dto - Update data\r\n   * @returns Updated memory\r\n   * @throws NotFoundException if memory not found\r\n   * @throws ForbiddenException if user doesn't own the memory\r\n   */\r\n  async updateMemory(\r\n    tenantId: string,\r\n    memoryId: string,\r\n    userId: string,\r\n    dto: UpdateMemoryDto\r\n  ): Promise<Memory> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    // Verify ownership first\r\n    await this.getMemory(tenantId, memoryId, userId);\r\n\r\n    const updated = await prisma.memory.update({\r\n      where: { id: memoryId },\r\n      data: {\r\n        content: dto.content,\r\n        subject: dto.subject,\r\n        source: 'USER_CORRECTED',\r\n        confidence: 1.0, // User corrections have full confidence\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Memory updated',\r\n      memoryId,\r\n      userId,\r\n      tenantId,\r\n      newSource: 'USER_CORRECTED',\r\n    });\r\n\r\n    return this.mapMemory(updated);\r\n  }\r\n\r\n  /**\r\n   * Soft-deletes a memory entry.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param memoryId - Memory ID to delete\r\n   * @param userId - User ID for ownership verification\r\n   * @throws NotFoundException if memory not found\r\n   * @throws ForbiddenException if user doesn't own the memory\r\n   */\r\n  async deleteMemory(\r\n    tenantId: string,\r\n    memoryId: string,\r\n    userId: string\r\n  ): Promise<void> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    // Verify ownership first\r\n    await this.getMemory(tenantId, memoryId, userId);\r\n\r\n    await prisma.memory.update({\r\n      where: { id: memoryId },\r\n      data: {\r\n        isDeleted: true,\r\n        deletedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Memory soft-deleted',\r\n      memoryId,\r\n      userId,\r\n      tenantId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Deletes all memories for a user (with confirmation).\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param userId - User ID whose memories to delete\r\n   * @param confirmation - Must be \"FORGET\" to proceed\r\n   * @returns Number of memories deleted\r\n   * @throws ForbiddenException if confirmation is incorrect\r\n   */\r\n  async forgetAll(\r\n    tenantId: string,\r\n    userId: string,\r\n    confirmation: string\r\n  ): Promise<{ deletedCount: number }> {\r\n    if (confirmation !== 'FORGET') {\r\n      throw new ForbiddenException({\r\n        type: 'invalid_confirmation',\r\n        title: 'Invalid Confirmation',\r\n        status: 403,\r\n        detail: 'You must type \"FORGET\" to confirm deletion of all memories',\r\n      });\r\n    }\r\n\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const result = await prisma.memory.updateMany({\r\n      where: {\r\n        tenantId,\r\n        userId,\r\n        isDeleted: false,\r\n      },\r\n      data: {\r\n        isDeleted: true,\r\n        deletedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    this.logger.warn({\r\n      message: 'All memories soft-deleted for user',\r\n      userId,\r\n      tenantId,\r\n      deletedCount: result.count,\r\n    });\r\n\r\n    return { deletedCount: result.count };\r\n  }\r\n\r\n  /**\r\n   * Updates the embedding ID for a memory after vector generation.\r\n   *\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param memoryId - Memory ID to update\r\n   * @param embeddingId - Qdrant vector ID\r\n   */\r\n  async updateEmbeddingId(\r\n    tenantId: string,\r\n    memoryId: string,\r\n    embeddingId: string\r\n  ): Promise<void> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    await prisma.memory.update({\r\n      where: { id: memoryId },\r\n      data: { embeddingId },\r\n    });\r\n\r\n    this.logger.debug({\r\n      message: 'Memory embedding ID updated',\r\n      memoryId,\r\n      tenantId,\r\n      embeddingId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Maps a Prisma memory record to the Memory interface.\r\n   */\r\n  private mapMemory(memory: {\r\n    id: string;\r\n    tenantId: string;\r\n    userId: string;\r\n    type: string;\r\n    source: string;\r\n    content: string;\r\n    subject: string | null;\r\n    confidence: number;\r\n    embeddingId: string | null;\r\n    sourceMessageId: string | null;\r\n    isDeleted: boolean;\r\n    deletedAt: Date | null;\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n  }): Memory {\r\n    return {\r\n      id: memory.id,\r\n      tenantId: memory.tenantId,\r\n      userId: memory.userId,\r\n      type: memory.type as MemoryType,\r\n      source: memory.source as MemorySource,\r\n      content: memory.content,\r\n      subject: memory.subject ?? undefined,\r\n      confidence: memory.confidence,\r\n      embeddingId: memory.embeddingId ?? undefined,\r\n      sourceMessageId: memory.sourceMessageId ?? undefined,\r\n      isDeleted: memory.isDeleted,\r\n      deletedAt: memory.deletedAt?.toISOString(),\r\n      createdAt: memory.createdAt.toISOString(),\r\n      updatedAt: memory.updatedAt.toISOString(),\r\n    };\r\n  }\r\n}\r\n","import { IsEnum, IsString, IsOptional, IsNumber, Min, Max } from 'class-validator';\r\nimport { MemoryType, MemorySource } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * DTO for creating a new memory entry.\r\n */\r\nexport class CreateMemoryDto {\r\n  @IsEnum(MemoryType)\r\n  type!: MemoryType;\r\n\r\n  @IsEnum(MemorySource)\r\n  source!: MemorySource;\r\n\r\n  @IsString()\r\n  content!: string;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  subject?: string;\r\n\r\n  @IsOptional()\r\n  @IsNumber()\r\n  @Min(0)\r\n  @Max(1)\r\n  confidence?: number;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  sourceMessageId?: string;\r\n}\r\n","import { IsString, IsOptional } from 'class-validator';\r\n\r\n/**\r\n * DTO for updating/correcting a memory entry.\r\n * Source will automatically be set to USER_CORRECTED.\r\n */\r\nexport class UpdateMemoryDto {\r\n  @IsString()\r\n  content!: string;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  subject?: string;\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { MemoryService } from './memory.service';\r\nimport { MemoryEmbeddingService } from './memory-embedding.service';\r\nimport type { Message, MemoryType, MemorySource } from '@mentor-ai/shared/types';\r\nimport { LlmConfigService } from '../../llm-config/llm-config.service';\r\nimport { LlmProviderType } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Extracted memory from conversation.\r\n */\r\nexport interface ExtractedMemory {\r\n  type: MemoryType;\r\n  content: string;\r\n  subject?: string;\r\n  confidence: number;\r\n}\r\n\r\n/**\r\n * Service for extracting memorable facts from conversations.\r\n * Uses LLM to identify client mentions, preferences, and facts.\r\n *\r\n * Story 2.7: Persistent Memory Across Conversations\r\n */\r\n@Injectable()\r\nexport class MemoryExtractionService {\r\n  private readonly logger = new Logger(MemoryExtractionService.name);\r\n\r\n  /** Deduplication similarity threshold */\r\n  private readonly DEDUP_THRESHOLD = 0.9;\r\n\r\n  /** Extraction prompt template */\r\n  private readonly EXTRACTION_PROMPT = `Analiziraj sledei razgovor i ekstrahuj kljune poslovne injenice koje treba zapamtiti.\r\nVrati JSON niz ekstrahovanih memorija sa sledeom strukturom:\r\n{ \"type\": \"CLIENT_CONTEXT\" | \"PROJECT_CONTEXT\" | \"USER_PREFERENCE\" | \"FACTUAL_STATEMENT\",\r\n  \"content\": \"konkretna injenica na srpskom jeziku\",\r\n  \"subject\": \"naziv klijenta/projekta/koncepta ako je primenjivo\",\r\n  \"confidence\": 0.0-1.0 }\r\n\r\nFokusiraj se na:\r\n- Poslovne odluke i strateke pravce (investicije, ekspanzija, pivotiranje)\r\n- Trine podatke (konkurencija, ciljno trite, cene, trendovi)\r\n- Klijente i partnere (imena, industrija, veliina, budet, specifini zahtevi)\r\n- Projekte i rokove (timeline, budet, zahtevi, milestones, KPI)\r\n- Prioritete i preferencije vlasnika (stil komunikacije, fokus oblasti, radni model)\r\n- Finansijske podatke (prihodi, trokovi, mare, targeti)\r\n- Probleme i izazove koje je korisnik eksplicitno naveo\r\n- Resurse i kapacitete (tim, tehnologija, infrastruktura)\r\n\r\nPravila:\r\n- Ekstrahuj SAMO injenine informacije, ne miljenja ili spekulacije AI-a\r\n- Budi specifian i koncizan  svaka memorija max 2 reenice\r\n- Subject treba da bude naziv klijenta, projekta ili poslovnog koncepta\r\n- Confidence 0.9+ za eksplicitne izjave korisnika, 0.7-0.8 za implicirane injenice\r\n- NE ekstrahuj generike poslovne savete  samo injenice specifine za OVO poslovanje\r\n- Pii content na srpskom jeziku\r\n\r\nRazgovor:\r\n{messages}\r\n\r\nEkstrahovane memorije (SAMO JSON niz, bez dodatnog teksta):`;\r\n\r\n  constructor(\r\n    private readonly memoryService: MemoryService,\r\n    private readonly memoryEmbeddingService: MemoryEmbeddingService,\r\n    private readonly llmConfigService: LlmConfigService,\r\n    private readonly configService: ConfigService\r\n  ) {}\r\n\r\n  /**\r\n   * Extracts memories from conversation messages.\r\n   * Called asynchronously after conversation turns.\r\n   *\r\n   * @param messages - Conversation messages to analyze\r\n   * @param userId - User who owns the conversation\r\n   * @param tenantId - Tenant for isolation\r\n   * @returns Array of extracted and saved memories\r\n   */\r\n  async extractMemories(\r\n    messages: Message[],\r\n    userId: string,\r\n    tenantId: string,\r\n    options?: { conceptName?: string }\r\n  ): Promise<ExtractedMemory[]> {\r\n    if (messages.length < 2) {\r\n      this.logger.debug({\r\n        message: 'Skipping extraction - insufficient messages',\r\n        userId,\r\n        tenantId,\r\n        messageCount: messages.length,\r\n      });\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      // Format messages for the prompt\r\n      const formattedMessages = this.formatMessages(messages);\r\n      let prompt = this.EXTRACTION_PROMPT.replace('{messages}', formattedMessages);\r\n\r\n      // Story 3.3: Add concept context for better tagging\r\n      if (options?.conceptName) {\r\n        prompt += `\\n\\nKontekst: Ovaj razgovor se odnosi na poslovni koncept \"${options.conceptName}\". Koristi ovo kao subject za ekstrahovane memorije kada je relevantno.`;\r\n      }\r\n\r\n      // Call LLM for extraction\r\n      const extractedRaw = await this.callLlmForExtraction(prompt, tenantId, userId);\r\n\r\n      if (!extractedRaw || extractedRaw.length === 0) {\r\n        this.logger.debug({\r\n          message: 'No memories extracted',\r\n          userId,\r\n          tenantId,\r\n        });\r\n        return [];\r\n      }\r\n\r\n      // Deduplicate against existing memories\r\n      const deduplicated = await this.deduplicateMemories(extractedRaw, userId, tenantId);\r\n\r\n      // Save new memories and generate embeddings\r\n      const savedMemories: ExtractedMemory[] = [];\r\n      for (const memory of deduplicated) {\r\n        try {\r\n          // Story 3.3: Default subject to concept name for concept-tagged memories\r\n          const effectiveSubject = memory.subject || options?.conceptName || undefined;\r\n\r\n          const saved = await this.memoryService.createMemory(tenantId, userId, {\r\n            type: memory.type as MemoryType,\r\n            source: 'AI_EXTRACTED' as MemorySource,\r\n            content: memory.content,\r\n            subject: effectiveSubject,\r\n            confidence: memory.confidence,\r\n            sourceMessageId: messages[messages.length - 1]?.id,\r\n          });\r\n\r\n          // Generate embedding for semantic search (async, non-blocking)\r\n          this.memoryEmbeddingService\r\n            .generateAndStoreEmbedding(tenantId, saved.id, saved.content, {\r\n              userId,\r\n              type: saved.type,\r\n              subject: saved.subject,\r\n            })\r\n            .catch((error) => {\r\n              this.logger.warn({\r\n                message: 'Failed to generate embedding for memory',\r\n                memoryId: saved.id,\r\n                error: error instanceof Error ? error.message : 'Unknown error',\r\n              });\r\n            });\r\n\r\n          savedMemories.push(memory);\r\n        } catch (error) {\r\n          this.logger.warn({\r\n            message: 'Failed to save extracted memory',\r\n            content: memory.content.substring(0, 50),\r\n            error: error instanceof Error ? error.message : 'Unknown error',\r\n          });\r\n        }\r\n      }\r\n\r\n      this.logger.log({\r\n        message: 'Memories extracted and saved',\r\n        userId,\r\n        tenantId,\r\n        extractedCount: extractedRaw.length,\r\n        savedCount: savedMemories.length,\r\n        deduplicatedCount: extractedRaw.length - deduplicated.length,\r\n      });\r\n\r\n      return savedMemories;\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Memory extraction failed',\r\n        userId,\r\n        tenantId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calls LLM to extract memories from the prompt.\r\n   */\r\n  private async callLlmForExtraction(\r\n    prompt: string,\r\n    _tenantId: string,\r\n    _userId: string\r\n  ): Promise<ExtractedMemory[]> {\r\n    try {\r\n      const config = await this.llmConfigService.getConfig();\r\n      if (!config.primaryProvider) {\r\n        this.logger.warn({\r\n          message: 'No LLM provider configured for extraction',\r\n        });\r\n        return [];\r\n      }\r\n\r\n      const apiKey = await this.llmConfigService.getDecryptedApiKey(\r\n        config.primaryProvider.providerType as LlmProviderType\r\n      );\r\n\r\n      if (!apiKey) {\r\n        this.logger.warn({\r\n          message: 'No API key available for extraction',\r\n        });\r\n        return [];\r\n      }\r\n\r\n      // Route to correct provider endpoint\r\n      const providerType = config.primaryProvider.providerType as LlmProviderType;\r\n      const endpointMap: Record<string, string> = {\r\n        [LlmProviderType.OPENROUTER]: 'https://openrouter.ai/api/v1/chat/completions',\r\n        [LlmProviderType.DEEPSEEK]: 'https://api.deepseek.com/v1/chat/completions',\r\n        [LlmProviderType.OPENAI]: 'https://api.openai.com/v1/chat/completions',\r\n        [LlmProviderType.ANTHROPIC]: 'https://api.anthropic.com/v1/messages',\r\n        [LlmProviderType.LM_STUDIO]: `${config.primaryProvider.endpoint || 'http://localhost:1234'}/v1/chat/completions`,\r\n        [LlmProviderType.LOCAL_LLAMA]: `${config.primaryProvider.endpoint || 'http://localhost:11434'}/v1/chat/completions`,\r\n      };\r\n      const url = endpointMap[providerType];\r\n      if (!url) {\r\n        this.logger.warn({ message: `Unsupported provider for extraction: ${providerType}` });\r\n        return [];\r\n      }\r\n\r\n      const headers: Record<string, string> = {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${apiKey}`,\r\n      };\r\n      // OpenRouter requires extra headers\r\n      if (providerType === LlmProviderType.OPENROUTER) {\r\n        headers['HTTP-Referer'] =\r\n          this.configService.get<string>('APP_URL') ?? 'http://localhost:4200';\r\n        headers['X-Title'] = 'Mentor AI - Memory Extraction';\r\n      }\r\n\r\n      // Use non-streaming completion for extraction\r\n      const response = await fetch(url, {\r\n        method: 'POST',\r\n        headers,\r\n        body: JSON.stringify({\r\n          model: config.primaryProvider.modelId,\r\n          messages: [\r\n            {\r\n              role: 'system',\r\n              content:\r\n                'Ti si asistent za ekstrakciju poslovnih memorija. Ekstrahuj injenine informacije iz razgovora i vrati ISKLJUIVO JSON.',\r\n            },\r\n            {\r\n              role: 'user',\r\n              content: prompt,\r\n            },\r\n          ],\r\n          temperature: 0.1,\r\n          max_tokens: 1000,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(`LLM API returned ${response.status}: ${errorText}`);\r\n      }\r\n\r\n      const data = (await response.json()) as {\r\n        choices?: Array<{ message?: { content?: string } }>;\r\n      };\r\n\r\n      const content = data.choices?.[0]?.message?.content;\r\n      if (!content) {\r\n        return [];\r\n      }\r\n\r\n      // Parse JSON response\r\n      const extracted = this.parseExtractionResponse(content);\r\n      return extracted;\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'LLM extraction call failed',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parses the LLM extraction response.\r\n   */\r\n  private parseExtractionResponse(content: string): ExtractedMemory[] {\r\n    try {\r\n      // Try to extract JSON array from response\r\n      const jsonMatch = content.match(/\\[[\\s\\S]*\\]/);\r\n      if (!jsonMatch) {\r\n        return [];\r\n      }\r\n\r\n      const parsed = JSON.parse(jsonMatch[0]) as Array<{\r\n        type?: string;\r\n        content?: string;\r\n        subject?: string;\r\n        confidence?: number;\r\n      }>;\r\n\r\n      if (!Array.isArray(parsed)) {\r\n        return [];\r\n      }\r\n\r\n      return parsed\r\n        .filter((item) => item.type && item.content)\r\n        .map((item) => ({\r\n          type: this.normalizeMemoryType(item.type!),\r\n          content: item.content!,\r\n          subject: item.subject,\r\n          confidence: Math.min(Math.max(item.confidence ?? 0.8, 0), 1),\r\n        }));\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Failed to parse extraction response',\r\n        contentPreview: content.substring(0, 100),\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Normalizes memory type string to enum value.\r\n   */\r\n  private normalizeMemoryType(type: string): MemoryType {\r\n    const typeMap: Record<string, MemoryType> = {\r\n      CLIENT_CONTEXT: 'CLIENT_CONTEXT' as MemoryType,\r\n      PROJECT_CONTEXT: 'PROJECT_CONTEXT' as MemoryType,\r\n      USER_PREFERENCE: 'USER_PREFERENCE' as MemoryType,\r\n      FACTUAL_STATEMENT: 'FACTUAL_STATEMENT' as MemoryType,\r\n    };\r\n    return typeMap[type.toUpperCase()] ?? ('FACTUAL_STATEMENT' as MemoryType);\r\n  }\r\n\r\n  /**\r\n   * Deduplicates new memories against existing ones.\r\n   * Uses semantic similarity to avoid storing duplicate facts.\r\n   */\r\n  private async deduplicateMemories(\r\n    newMemories: ExtractedMemory[],\r\n    userId: string,\r\n    tenantId: string\r\n  ): Promise<ExtractedMemory[]> {\r\n    if (newMemories.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      // Get existing memories for comparison\r\n      const { data: existing } = await this.memoryService.findMemories(tenantId, userId, {\r\n        limit: 100,\r\n      });\r\n\r\n      if (existing.length === 0) {\r\n        return newMemories;\r\n      }\r\n\r\n      // Filter out duplicates using simple text similarity\r\n      return newMemories.filter((newMem) => {\r\n        const isDuplicate = existing.some((existingMem) => {\r\n          const similarity = this.calculateTextSimilarity(\r\n            newMem.content.toLowerCase(),\r\n            existingMem.content.toLowerCase()\r\n          );\r\n          return similarity > this.DEDUP_THRESHOLD;\r\n        });\r\n        return !isDuplicate;\r\n      });\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Deduplication failed, proceeding with all memories',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return newMemories;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculates simple text similarity using Jaccard index.\r\n   */\r\n  private calculateTextSimilarity(text1: string, text2: string): number {\r\n    const words1 = new Set(text1.split(/\\s+/).filter((w) => w.length > 2));\r\n    const words2 = new Set(text2.split(/\\s+/).filter((w) => w.length > 2));\r\n\r\n    if (words1.size === 0 && words2.size === 0) {\r\n      return 1;\r\n    }\r\n\r\n    const intersection = new Set([...words1].filter((w) => words2.has(w)));\r\n    const union = new Set([...words1, ...words2]);\r\n\r\n    return intersection.size / union.size;\r\n  }\r\n\r\n  /**\r\n   * Formats messages for the extraction prompt.\r\n   */\r\n  private formatMessages(messages: Message[]): string {\r\n    return messages\r\n      .map((m) => `${m.role === 'USER' ? 'KORISNIK' : 'AI'}: ${m.content}`)\r\n      .join('\\n\\n');\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { MemoryService } from './memory.service';\r\nimport { QdrantClientService } from '../../qdrant/qdrant-client.service';\r\nimport type { MemoryType } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Semantic search result for memory.\r\n */\r\nexport interface MemorySearchResult {\r\n  memoryId: string;\r\n  score: number;\r\n  content: string;\r\n  subject?: string;\r\n  type: MemoryType;\r\n}\r\n\r\n/** OpenAI API endpoint for embeddings */\r\nconst OPENAI_EMBEDDINGS_URL = 'https://api.openai.com/v1/embeddings';\r\n\r\n/**\r\n * Service for generating and managing memory embeddings.\r\n * Integrates with Qdrant Cloud for vector storage and semantic search.\r\n *\r\n * Collections are per-tenant: `memories_${tenantId}`\r\n * Dimensions: 1536 (OpenAI text-embedding-3-small)\r\n *\r\n * Story 2.7: Persistent Memory Across Conversations\r\n */\r\n@Injectable()\r\nexport class MemoryEmbeddingService {\r\n  private readonly logger = new Logger(MemoryEmbeddingService.name);\r\n\r\n  /** Default similarity threshold for semantic search */\r\n  private readonly DEFAULT_THRESHOLD = 0.7;\r\n\r\n  /** Embedding dimension (1536 for OpenAI text-embedding-3-small) */\r\n  private readonly EMBEDDING_DIMENSION = 1536;\r\n\r\n  /** OpenAI model for embedding generation */\r\n  private readonly EMBEDDING_MODEL = 'text-embedding-3-small';\r\n\r\n  constructor(\r\n    private readonly memoryService: MemoryService,\r\n    private readonly qdrantClient: QdrantClientService\r\n  ) {}\r\n\r\n  /**\r\n   * Returns the Qdrant collection name for a tenant's memories.\r\n   */\r\n  private collectionName(tenantId: string): string {\r\n    return `memories_${tenantId}`;\r\n  }\r\n\r\n  /**\r\n   * Ensures the tenant's memory collection exists in Qdrant.\r\n   */\r\n  async ensureCollection(tenantId: string): Promise<void> {\r\n    if (!this.qdrantClient.isAvailable()) return;\r\n    await this.qdrantClient.ensureCollection(\r\n      this.collectionName(tenantId),\r\n      this.EMBEDDING_DIMENSION\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Generates an embedding for memory content and stores it in Qdrant.\r\n   *\r\n   * @param tenantId - Tenant ID for collection scoping\r\n   * @param memoryId - Memory ID to associate\r\n   * @param content - Text content to embed\r\n   * @param metadata - Additional metadata for the vector\r\n   * @returns Embedding ID (Qdrant point UUID)\r\n   */\r\n  async generateAndStoreEmbedding(\r\n    tenantId: string,\r\n    memoryId: string,\r\n    content: string,\r\n    metadata: {\r\n      userId: string;\r\n      type: MemoryType;\r\n      subject?: string;\r\n    }\r\n  ): Promise<string> {\r\n    this.logger.debug({\r\n      message: 'Generating embedding for memory',\r\n      memoryId,\r\n      tenantId,\r\n      contentLength: content.length,\r\n    });\r\n\r\n    if (!this.qdrantClient.isAvailable()) {\r\n      this.logger.warn('Qdrant not available  skipping memory embedding');\r\n      const fallbackId = `emb_${memoryId}_${Date.now()}`;\r\n      await this.memoryService.updateEmbeddingId(tenantId, memoryId, fallbackId);\r\n      return fallbackId;\r\n    }\r\n\r\n    const vector = await this.embedText(content);\r\n    if (!vector) {\r\n      this.logger.warn({ message: 'Embedding generation failed, skipping', memoryId });\r\n      const fallbackId = `emb_failed_${memoryId}`;\r\n      await this.memoryService.updateEmbeddingId(tenantId, memoryId, fallbackId);\r\n      return fallbackId;\r\n    }\r\n\r\n    await this.ensureCollection(tenantId);\r\n\r\n    const pointId = crypto.randomUUID();\r\n    const client = this.qdrantClient.getClient();\r\n\r\n    await client.upsert(this.collectionName(tenantId), {\r\n      wait: true,\r\n      points: [\r\n        {\r\n          id: pointId,\r\n          vector,\r\n          payload: {\r\n            memoryId,\r\n            userId: metadata.userId,\r\n            type: metadata.type,\r\n            subject: metadata.subject ?? null,\r\n            content,\r\n            createdAt: new Date().toISOString(),\r\n          },\r\n        },\r\n      ],\r\n    });\r\n\r\n    // Store Qdrant point UUID in the database\r\n    await this.memoryService.updateEmbeddingId(tenantId, memoryId, pointId);\r\n\r\n    this.logger.log({\r\n      message: 'Memory embedding generated and stored',\r\n      memoryId,\r\n      tenantId,\r\n      pointId,\r\n    });\r\n\r\n    return pointId;\r\n  }\r\n\r\n  /**\r\n   * Searches for similar memories using semantic similarity via Qdrant.\r\n   */\r\n  async semanticSearch(\r\n    tenantId: string,\r\n    userId: string,\r\n    query: string,\r\n    limit = 10,\r\n    threshold: number = this.DEFAULT_THRESHOLD\r\n  ): Promise<MemorySearchResult[]> {\r\n    this.logger.debug({\r\n      message: 'Performing semantic search for memories',\r\n      tenantId,\r\n      userId,\r\n      queryLength: query.length,\r\n      limit,\r\n      threshold,\r\n    });\r\n\r\n    if (!this.qdrantClient.isAvailable()) {\r\n      return this.keywordFallback(tenantId, userId, query, limit);\r\n    }\r\n\r\n    const vector = await this.embedText(query);\r\n    if (!vector) {\r\n      this.logger.warn({ message: 'Query embedding failed, using keyword fallback' });\r\n      return this.keywordFallback(tenantId, userId, query, limit);\r\n    }\r\n\r\n    try {\r\n      const client = this.qdrantClient.getClient();\r\n      const results = await client.search(this.collectionName(tenantId), {\r\n        vector,\r\n        limit,\r\n        filter: {\r\n          must: [{ key: 'userId', match: { value: userId } }],\r\n        },\r\n        with_payload: true,\r\n        score_threshold: threshold,\r\n      });\r\n\r\n      return results.map((r) => ({\r\n        memoryId: (r.payload?.['memoryId'] as string) ?? '',\r\n        score: r.score,\r\n        content: (r.payload?.['content'] as string) ?? '',\r\n        subject: (r.payload?.['subject'] as string) ?? undefined,\r\n        type: (r.payload?.['type'] as MemoryType) ?? ('FACTUAL_STATEMENT' as MemoryType),\r\n      }));\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Qdrant memory search failed, using keyword fallback',\r\n        error: error instanceof Error ? error.message : 'Unknown',\r\n      });\r\n      return this.keywordFallback(tenantId, userId, query, limit);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Performs hybrid search combining vector and keyword matching.\r\n   * Useful for finding client names mentioned exactly.\r\n   */\r\n  async hybridSearch(\r\n    tenantId: string,\r\n    userId: string,\r\n    query: string,\r\n    limit = 10\r\n  ): Promise<MemorySearchResult[]> {\r\n    this.logger.debug({\r\n      message: 'Performing hybrid search for memories',\r\n      tenantId,\r\n      userId,\r\n      query: query.substring(0, 50),\r\n      limit,\r\n    });\r\n\r\n    // Extract potential client/project names (capitalized words)\r\n    const potentialNames = query.match(/[A-Z][a-z]+(?:\\s+[A-Z][a-z]+)*/g) || [];\r\n\r\n    // Get semantic search results\r\n    const semanticResults = await this.semanticSearch(tenantId, userId, query, limit);\r\n\r\n    // Get keyword matches for extracted names\r\n    const keywordResults: MemorySearchResult[] = [];\r\n    for (const name of potentialNames.slice(0, 3)) {\r\n      const memories = await this.memoryService.findRelevantMemories(tenantId, userId, name, 5);\r\n\r\n      for (const memory of memories) {\r\n        if (memory.subject?.toLowerCase().includes(name.toLowerCase())) {\r\n          keywordResults.push({\r\n            memoryId: memory.id,\r\n            score: 0.95,\r\n            content: memory.content,\r\n            subject: memory.subject,\r\n            type: memory.type,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Combine and deduplicate results\r\n    const combined = [...keywordResults, ...semanticResults];\r\n    const seen = new Set<string>();\r\n    const deduplicated: MemorySearchResult[] = [];\r\n\r\n    for (const result of combined) {\r\n      if (!seen.has(result.memoryId)) {\r\n        seen.add(result.memoryId);\r\n        deduplicated.push(result);\r\n      }\r\n    }\r\n\r\n    return deduplicated.sort((a, b) => b.score - a.score).slice(0, limit);\r\n  }\r\n\r\n  /**\r\n   * Deletes an embedding from Qdrant.\r\n   */\r\n  async deleteEmbedding(tenantId: string, embeddingId: string): Promise<void> {\r\n    if (!this.qdrantClient.isAvailable()) return;\r\n\r\n    try {\r\n      const client = this.qdrantClient.getClient();\r\n      await client.delete(this.collectionName(tenantId), {\r\n        wait: true,\r\n        points: [embeddingId],\r\n      });\r\n      this.logger.debug({ message: 'Memory embedding deleted', tenantId, embeddingId });\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to delete memory embedding',\r\n        tenantId,\r\n        embeddingId,\r\n        error: error instanceof Error ? error.message : 'Unknown',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generates an embedding vector using OpenAI text-embedding-3-small (1536-dim).\r\n   */\r\n  private async embedText(text: string): Promise<number[] | null> {\r\n    const apiKey = process.env.OPENAI_API_KEY;\r\n    if (!apiKey) {\r\n      this.logger.error('OPENAI_API_KEY not set  cannot generate memory embeddings');\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(OPENAI_EMBEDDINGS_URL, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          Authorization: `Bearer ${apiKey}`,\r\n        },\r\n        body: JSON.stringify({\r\n          model: this.EMBEDDING_MODEL,\r\n          input: text,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        this.logger.error({\r\n          message: 'OpenAI embedding API error',\r\n          status: response.status,\r\n        });\r\n        return null;\r\n      }\r\n\r\n      const data = (await response.json()) as {\r\n        data: Array<{ embedding: number[] }>;\r\n      };\r\n      return data.data[0]?.embedding ?? null;\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to generate embedding via OpenAI',\r\n        error: error instanceof Error ? error.message : 'Unknown',\r\n      });\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Keyword-based fallback when Qdrant is unavailable.\r\n   */\r\n  private async keywordFallback(\r\n    tenantId: string,\r\n    userId: string,\r\n    query: string,\r\n    limit: number\r\n  ): Promise<MemorySearchResult[]> {\r\n    const memories = await this.memoryService.findRelevantMemories(tenantId, userId, query, limit);\r\n    return memories.map((memory, index) => ({\r\n      memoryId: memory.id,\r\n      score: 0.9 - index * 0.05,\r\n      content: memory.content,\r\n      subject: memory.subject,\r\n      type: memory.type,\r\n    }));\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { MemoryEmbeddingService } from './memory-embedding.service';\r\nimport type { MemoryType, MemoryAttribution } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Result of building memory context for a prompt.\r\n */\r\nexport interface MemoryContext {\r\n  /** Formatted context string to inject into prompt */\r\n  context: string;\r\n  /** Attributions for memories used */\r\n  attributions: MemoryAttribution[];\r\n  /** Token estimate for the context */\r\n  estimatedTokens: number;\r\n}\r\n\r\n/**\r\n * Service for building memory context for AI prompts.\r\n * Formats relevant memories for RAG injection.\r\n *\r\n * Story 2.7: Persistent Memory Across Conversations\r\n */\r\n@Injectable()\r\nexport class MemoryContextBuilderService {\r\n  private readonly logger = new Logger(MemoryContextBuilderService.name);\r\n\r\n  /** Maximum tokens for memory context to preserve response quality.\r\n   *  Reduced from 2000 to 800 to fit within 8K context window models. */\r\n  private readonly MAX_MEMORY_TOKENS = 800;\r\n\r\n  /** Approximate characters per token */\r\n  private readonly CHARS_PER_TOKEN = 4;\r\n\r\n  constructor(private readonly memoryEmbeddingService: MemoryEmbeddingService) {}\r\n\r\n  /**\r\n   * Builds memory context for a user query.\r\n   * Retrieves relevant memories and formats them for prompt injection.\r\n   *\r\n   * @param query - User's query to match against memories\r\n   * @param userId - User ID for memory retrieval\r\n   * @param tenantId - Tenant ID for isolation\r\n   * @returns Formatted context with attributions\r\n   */\r\n  async buildContext(query: string, userId: string, tenantId: string): Promise<MemoryContext> {\r\n    this.logger.debug({\r\n      message: 'Building memory context',\r\n      userId,\r\n      tenantId,\r\n      queryLength: query.length,\r\n    });\r\n\r\n    // Retrieve relevant memories via hybrid search\r\n    const searchResults = await this.memoryEmbeddingService.hybridSearch(\r\n      tenantId,\r\n      userId,\r\n      query,\r\n      10 // Top 10 most relevant\r\n    );\r\n\r\n    if (searchResults.length === 0) {\r\n      this.logger.debug({\r\n        message: 'No relevant memories found',\r\n        userId,\r\n        tenantId,\r\n      });\r\n\r\n      return {\r\n        context: '',\r\n        attributions: [],\r\n        estimatedTokens: 0,\r\n      };\r\n    }\r\n\r\n    // Build context string with token limit\r\n    const attributions: MemoryAttribution[] = [];\r\n    let context = '\\n\\n--- PREVIOUS CONTEXT ABOUT THIS USER ---\\n';\r\n    let tokenCount = this.estimateTokens(context);\r\n    const maxContentTokens = this.MAX_MEMORY_TOKENS - 100; // Reserve for header/footer\r\n\r\n    for (const result of searchResults) {\r\n      const memoryText = this.formatMemory(result);\r\n      const memoryTokens = this.estimateTokens(memoryText);\r\n\r\n      if (tokenCount + memoryTokens > maxContentTokens) {\r\n        this.logger.debug({\r\n          message: 'Token limit reached, stopping memory inclusion',\r\n          includedCount: attributions.length,\r\n          remainingCount: searchResults.length - attributions.length,\r\n        });\r\n        break;\r\n      }\r\n\r\n      context += memoryText + '\\n';\r\n      tokenCount += memoryTokens;\r\n\r\n      attributions.push({\r\n        memoryId: result.memoryId,\r\n        subject: result.subject || 'general context',\r\n        summary: result.content.slice(0, 100),\r\n        type: result.type,\r\n      });\r\n    }\r\n\r\n    context += '--- END PREVIOUS CONTEXT ---\\n\\n';\r\n    context +=\r\n      'When using this context, indicate it with: \"Based on our previous discussion about [subject]...\"\\n';\r\n\r\n    const finalTokens = this.estimateTokens(context);\r\n\r\n    this.logger.log({\r\n      message: 'Memory context built',\r\n      userId,\r\n      tenantId,\r\n      memoriesIncluded: attributions.length,\r\n      estimatedTokens: finalTokens,\r\n    });\r\n\r\n    return {\r\n      context,\r\n      attributions,\r\n      estimatedTokens: finalTokens,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Formats a single memory for inclusion in context.\r\n   */\r\n  private formatMemory(result: {\r\n    type: MemoryType;\r\n    subject?: string;\r\n    content: string;\r\n    score: number;\r\n  }): string {\r\n    const typeLabel = this.getTypeLabel(result.type);\r\n    const subjectPart = result.subject ? `: ${result.subject}` : '';\r\n\r\n    return `[${typeLabel}${subjectPart}] ${result.content}`;\r\n  }\r\n\r\n  /**\r\n   * Gets human-readable label for memory type.\r\n   */\r\n  private getTypeLabel(type: MemoryType): string {\r\n    const labels: Record<MemoryType, string> = {\r\n      CLIENT_CONTEXT: 'Client',\r\n      PROJECT_CONTEXT: 'Project',\r\n      USER_PREFERENCE: 'Preference',\r\n      FACTUAL_STATEMENT: 'Fact',\r\n    };\r\n    return labels[type] || 'Note';\r\n  }\r\n\r\n  /**\r\n   * Estimates token count for text.\r\n   */\r\n  private estimateTokens(text: string): number {\r\n    return Math.ceil(text.length / this.CHARS_PER_TOKEN);\r\n  }\r\n\r\n  /**\r\n   * Injects memory context into existing system prompt.\r\n   *\r\n   * @param systemPrompt - Original system prompt\r\n   * @param memoryContext - Memory context to inject\r\n   * @returns Modified system prompt with memory context\r\n   */\r\n  injectIntoSystemPrompt(systemPrompt: string, memoryContext: MemoryContext): string {\r\n    if (!memoryContext.context) {\r\n      return systemPrompt;\r\n    }\r\n\r\n    // Inject memory context after the main system prompt\r\n    return `${systemPrompt}\\n${memoryContext.context}`;\r\n  }\r\n\r\n  /**\r\n   * Parses memory attributions from AI response.\r\n   * Looks for patterns like \"Based on our previous discussion about [X]...\"\r\n   *\r\n   * @param response - AI response text\r\n   * @param providedAttributions - Attributions that were provided in context\r\n   * @returns Matched attributions\r\n   */\r\n  parseAttributionsFromResponse(\r\n    response: string,\r\n    providedAttributions: MemoryAttribution[]\r\n  ): MemoryAttribution[] {\r\n    const matched: MemoryAttribution[] = [];\r\n\r\n    // Look for \"Based on our previous discussion about [subject]\" patterns\r\n    const patterns = [\r\n      /Based on our previous discussion about ([^,.]+)/gi,\r\n      /As we discussed regarding ([^,.]+)/gi,\r\n      /From our earlier conversation about ([^,.]+)/gi,\r\n      /You mentioned that ([^,.]+)/gi,\r\n    ];\r\n\r\n    for (const pattern of patterns) {\r\n      let match;\r\n      while ((match = pattern.exec(response)) !== null) {\r\n        const mentionedSubject = match[1]?.trim().toLowerCase();\r\n\r\n        // Skip if no subject captured\r\n        if (!mentionedSubject) {\r\n          continue;\r\n        }\r\n\r\n        // Find matching attribution\r\n        const found = providedAttributions.find(\r\n          (attr) =>\r\n            attr.subject.toLowerCase().includes(mentionedSubject) ||\r\n            mentionedSubject.includes(attr.subject.toLowerCase())\r\n        );\r\n\r\n        if (found && !matched.some((m) => m.memoryId === found.memoryId)) {\r\n          matched.push(found);\r\n        }\r\n      }\r\n    }\r\n\r\n    return matched;\r\n  }\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { KnowledgeModule } from '../knowledge/knowledge.module';\r\nimport { AiGatewayModule } from '../ai-gateway/ai-gateway.module';\r\nimport { NotesModule } from '../notes/notes.module';\r\nimport { WebSearchModule } from '../web-search/web-search.module';\r\nimport { ExecutionModule } from '../execution/execution.module';\r\nimport { WorkflowService } from './workflow.service';\r\nimport { YoloSchedulerService } from './yolo-scheduler.service';\r\n\r\n@Module({\r\n  imports: [\r\n    TenantModule,\r\n    KnowledgeModule,\r\n    AiGatewayModule,\r\n    NotesModule,\r\n    WebSearchModule,\r\n    ExecutionModule,\r\n  ],\r\n  providers: [WorkflowService, YoloSchedulerService],\r\n  exports: [WorkflowService, YoloSchedulerService],\r\n})\r\nexport class WorkflowModule {}\r\n","import { Module } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { WebSearchService } from './web-search.service';\r\n\r\n@Module({\r\n  imports: [ConfigModule],\r\n  providers: [WebSearchService],\r\n  exports: [WebSearchService],\r\n})\r\nexport class WebSearchModule {}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport axios from 'axios';\r\nimport type { EnrichedSearchResult } from '@mentor-ai/shared/types';\r\n\r\nexport interface SearchResult {\r\n  title: string;\r\n  link: string;\r\n  snippet: string;\r\n}\r\n\r\nconst SEARCH_TIMEOUT_MS = 8_000;\r\nconst PAGE_FETCH_TIMEOUT_MS = 10_000;\r\nconst TOTAL_WEB_RESEARCH_TIMEOUT_MS = 15_000;\r\nconst MAX_PAGE_CONTENT_CHARS = 3_000;\r\nconst MAX_TOTAL_WEB_CONTEXT_CHARS = 10_000;\r\n\r\n@Injectable()\r\nexport class WebSearchService {\r\n  private readonly logger = new Logger(WebSearchService.name);\r\n  private readonly apiKey: string | undefined;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    this.apiKey = this.configService.get<string>('SERPER_API_KEY');\r\n  }\r\n\r\n  /**\r\n   * Whether web search is available (API key configured).\r\n   */\r\n  isAvailable(): boolean {\r\n    return !!this.apiKey;\r\n  }\r\n\r\n  /**\r\n   * Searches the web using Serper.dev Google Search API.\r\n   * Returns top results with title, link, and snippet.\r\n   */\r\n  async search(query: string, numResults = 5): Promise<SearchResult[]> {\r\n    if (!this.apiKey) {\r\n      this.logger.warn('SERPER_API_KEY not configured  web search unavailable');\r\n      return [];\r\n    }\r\n\r\n    try {\r\n      const response = await axios.post(\r\n        'https://google.serper.dev/search',\r\n        { q: query, num: numResults },\r\n        {\r\n          headers: {\r\n            'X-API-KEY': this.apiKey,\r\n            'Content-Type': 'application/json',\r\n          },\r\n          timeout: SEARCH_TIMEOUT_MS,\r\n        }\r\n      );\r\n\r\n      const organic = response.data?.organic ?? [];\r\n      const results: SearchResult[] = organic\r\n        .slice(0, numResults)\r\n        .map((item: { title?: string; link?: string; snippet?: string }) => ({\r\n          title: item.title ?? '',\r\n          link: item.link ?? '',\r\n          snippet: item.snippet ?? '',\r\n        }));\r\n\r\n      this.logger.log({\r\n        message: 'Web search completed',\r\n        query,\r\n        resultCount: results.length,\r\n      });\r\n\r\n      return results;\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Web search failed',\r\n        query,\r\n        error: error instanceof Error ? error.message : 'Unknown',\r\n      });\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetches a webpage and extracts text content.\r\n   * Returns cleaned text content (max 5000 chars).\r\n   */\r\n  async fetchWebpage(url: string): Promise<string> {\r\n    try {\r\n      const response = await axios.get(url, {\r\n        timeout: PAGE_FETCH_TIMEOUT_MS,\r\n        headers: {\r\n          'User-Agent': 'Mozilla/5.0 (compatible; MentorAI/1.0)',\r\n          Accept: 'text/html,application/xhtml+xml',\r\n        },\r\n        maxRedirects: 5,\r\n        responseType: 'text',\r\n      });\r\n\r\n      const html = response.data as string;\r\n      // Basic HTML to text extraction\r\n      const text = this.extractTextFromHtml(html);\r\n\r\n      this.logger.log({\r\n        message: 'Webpage fetched',\r\n        url,\r\n        textLength: text.length,\r\n      });\r\n\r\n      return text.substring(0, 5000);\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Webpage fetch failed',\r\n        url,\r\n        error: error instanceof Error ? error.message : 'Unknown',\r\n      });\r\n      return '';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Combined search + deep page extraction with global timeout.\r\n   * Returns enriched results with optional page content.\r\n   */\r\n  async searchAndExtract(query: string, numResults = 5): Promise<EnrichedSearchResult[]> {\r\n    let timeoutId: ReturnType<typeof setTimeout>;\r\n\r\n    const globalTimeout = new Promise<EnrichedSearchResult[]>((resolve) => {\r\n      timeoutId = setTimeout(() => {\r\n        this.logger.warn({ message: 'Web research global timeout reached', query });\r\n        resolve([]);\r\n      }, TOTAL_WEB_RESEARCH_TIMEOUT_MS);\r\n    });\r\n\r\n    const work = async (): Promise<EnrichedSearchResult[]> => {\r\n      try {\r\n        // Phase 1: Search\r\n        const searchResults = await this.search(query, numResults);\r\n        if (searchResults.length === 0) return [];\r\n\r\n        const now = new Date().toISOString();\r\n\r\n        // Phase 2: Deep fetch top 3 results in parallel\r\n        const topResults = searchResults.slice(0, 3);\r\n        const fetchResults = await Promise.allSettled(\r\n          topResults.map((r) => this.fetchWebpage(r.link))\r\n        );\r\n\r\n        // Build enriched results with page content\r\n        const enriched: EnrichedSearchResult[] = [];\r\n        let totalContentChars = 0;\r\n\r\n        for (let i = 0; i < searchResults.length; i++) {\r\n          const result = searchResults[i]!;\r\n          let pageContent: string | undefined;\r\n\r\n          // Only top 3 have deep fetch attempts\r\n          if (i < fetchResults.length) {\r\n            const fetchResult = fetchResults[i]!;\r\n            if (fetchResult.status === 'fulfilled' && fetchResult.value) {\r\n              const truncated = fetchResult.value.substring(0, MAX_PAGE_CONTENT_CHARS);\r\n              if (totalContentChars + truncated.length <= MAX_TOTAL_WEB_CONTEXT_CHARS) {\r\n                pageContent = truncated;\r\n                totalContentChars += truncated.length;\r\n              }\r\n            }\r\n          }\r\n\r\n          // Also count snippet towards total\r\n          const snippetLen = result.snippet.length;\r\n          if (!pageContent && totalContentChars + snippetLen > MAX_TOTAL_WEB_CONTEXT_CHARS) {\r\n            continue; // Skip to stay within budget\r\n          }\r\n          if (!pageContent) totalContentChars += snippetLen;\r\n\r\n          enriched.push({\r\n            title: result.title,\r\n            link: result.link,\r\n            snippet: result.snippet,\r\n            pageContent,\r\n            fetchedAt: now,\r\n          });\r\n        }\r\n\r\n        this.logger.log({\r\n          message: 'Search and extract completed',\r\n          query,\r\n          resultCount: enriched.length,\r\n          deepFetchCount: fetchResults.filter((r) => r.status === 'fulfilled' && r.value).length,\r\n          totalContentChars,\r\n        });\r\n\r\n        return enriched;\r\n      } finally {\r\n        clearTimeout(timeoutId!);\r\n      }\r\n    };\r\n\r\n    return Promise.race([work(), globalTimeout]);\r\n  }\r\n\r\n  /**\r\n   * Formats enriched search results into an Obsidian-style context block\r\n   * with markdown links [Title](URL) for AI system prompt injection.\r\n   */\r\n  formatSourcesAsObsidian(results: EnrichedSearchResult[]): string {\r\n    if (!results || results.length === 0) return '';\r\n\r\n    let context = '\\n\\n--- WEB ISTRAIVANJE (aktuelni podaci) ---';\r\n    for (const result of results) {\r\n      context += `\\n\\n**[${result.title}](${result.link})**`;\r\n      if (result.pageContent) {\r\n        context += `\\n${result.pageContent}`;\r\n      } else {\r\n        context += `\\n${result.snippet}`;\r\n      }\r\n    }\r\n    context += '\\n--- KRAJ WEB ISTRAIVANJA ---';\r\n    context +=\r\n      '\\n\\nKADA KORISTI informacije iz web istraivanja, OBAVEZNO citiraj izvor INLINE odmah posle reenice koja koristi tu informaciju.';\r\n    context += '\\nFormat citiranja: ([Naziv izvora](URL))  stavi odmah posle relevantne reenice.';\r\n    context +=\r\n      '\\nPrimer: \"Trite digitalnog marketinga raste 15% godinje ([Digital Marketing Report 2026](https://example.com/report)).\"';\r\n    context += '\\nAko ne koristi informaciju iz izvora, NE citiraj ga.';\r\n    return context;\r\n  }\r\n\r\n  /**\r\n   * Basic HTML to text extraction without external dependencies.\r\n   */\r\n  private extractTextFromHtml(html: string): string {\r\n    // Remove script and style tags with their content\r\n    let text = html.replace(/<script[\\s\\S]*?<\\/script>/gi, '');\r\n    text = text.replace(/<style[\\s\\S]*?<\\/style>/gi, '');\r\n    text = text.replace(/<nav[\\s\\S]*?<\\/nav>/gi, '');\r\n    text = text.replace(/<footer[\\s\\S]*?<\\/footer>/gi, '');\r\n    text = text.replace(/<header[\\s\\S]*?<\\/header>/gi, '');\r\n    // Remove all HTML tags\r\n    text = text.replace(/<[^>]+>/g, ' ');\r\n    // Decode common HTML entities\r\n    text = text.replace(/&nbsp;/g, ' ');\r\n    text = text.replace(/&amp;/g, '&');\r\n    text = text.replace(/&lt;/g, '<');\r\n    text = text.replace(/&gt;/g, '>');\r\n    text = text.replace(/&quot;/g, '\"');\r\n    text = text.replace(/&#39;/g, \"'\");\r\n    // Collapse whitespace\r\n    text = text.replace(/\\s+/g, ' ').trim();\r\n    return text;\r\n  }\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { ExecutionStateService } from './execution-state.service';\r\n\r\n@Module({\r\n  imports: [TenantModule],\r\n  providers: [ExecutionStateService],\r\n  exports: [ExecutionStateService],\r\n})\r\nexport class ExecutionModule {}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { Prisma } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class ExecutionStateService {\r\n  private readonly logger = new Logger(ExecutionStateService.name);\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  /**\r\n   * Create a new execution record. Returns the execution ID.\r\n   */\r\n  async createExecution(\r\n    tenantId: string,\r\n    userId: string,\r\n    type: string,\r\n    planId?: string,\r\n    conversationId?: string,\r\n    metadata?: Record<string, unknown>\r\n  ): Promise<string> {\r\n    const execution = await this.prisma.execution.create({\r\n      data: {\r\n        tenantId,\r\n        userId,\r\n        type,\r\n        status: 'executing',\r\n        planId: planId ?? null,\r\n        conversationId: conversationId ?? null,\r\n        metadata: (metadata ?? {}) as Prisma.InputJsonValue,\r\n      },\r\n    });\r\n    this.logger.log({ message: 'Execution created', executionId: execution.id, type, tenantId });\r\n    return execution.id;\r\n  }\r\n\r\n  /**\r\n   * Update execution status, optionally setting result or error.\r\n   */\r\n  async updateStatus(\r\n    executionId: string,\r\n    status: string,\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    result?: any,\r\n    error?: string | null\r\n  ): Promise<void> {\r\n    await this.prisma.execution.update({\r\n      where: { id: executionId },\r\n      data: {\r\n        status,\r\n        ...(result !== undefined && result !== null\r\n          ? { result: result as Prisma.InputJsonValue }\r\n          : {}),\r\n        ...(error !== undefined ? { error } : {}),\r\n      },\r\n    });\r\n    this.logger.log({ message: 'Execution status updated', executionId, status });\r\n  }\r\n\r\n  /**\r\n   * Update checkpoint data for resume capability.\r\n   */\r\n  async updateCheckpoint(\r\n    executionId: string,\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    checkpoint: any\r\n  ): Promise<void> {\r\n    await this.prisma.execution.update({\r\n      where: { id: executionId },\r\n      data: { checkpoint: checkpoint as Prisma.InputJsonValue },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Append an event to the journal. Fire-and-forget safe  errors are logged but not thrown.\r\n   */\r\n  async appendEvent(\r\n    executionId: string,\r\n    eventName: string,\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    payload: any\r\n  ): Promise<void> {\r\n    await this.prisma.executionEvent.create({\r\n      data: {\r\n        executionId,\r\n        eventName,\r\n        payload: payload as Prisma.InputJsonValue,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get all events for an execution since a given timestamp, ordered chronologically.\r\n   */\r\n  async getEventsSince(executionId: string, since: Date) {\r\n    return this.prisma.executionEvent.findMany({\r\n      where: {\r\n        executionId,\r\n        createdAt: { gte: since },\r\n      },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get all active (executing or pending) executions for a tenant.\r\n   * Pass '*' for tenantId to get all tenants (used for server restart recovery).\r\n   */\r\n  async getActiveExecutions(tenantId: string) {\r\n    const where: Prisma.ExecutionWhereInput = {\r\n      status: { in: ['executing', 'pending'] },\r\n    };\r\n    if (tenantId !== '*') {\r\n      where.tenantId = tenantId;\r\n    }\r\n    return this.prisma.execution.findMany({\r\n      where,\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get executions that completed after a given timestamp (for \"completed while away\" display).\r\n   */\r\n  async getRecentCompletions(tenantId: string, since: Date) {\r\n    return this.prisma.execution.findMany({\r\n      where: {\r\n        tenantId,\r\n        status: { in: ['completed', 'failed'] },\r\n        updatedAt: { gte: since },\r\n      },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Find an execution by its planId.\r\n   */\r\n  async getByPlanId(planId: string) {\r\n    return this.prisma.execution.findUnique({\r\n      where: { planId },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Find stale executions (stuck in executing state for too long).\r\n   */\r\n  async getStaleExecutions(olderThanMinutes: number) {\r\n    const cutoff = new Date(Date.now() - olderThanMinutes * 60 * 1000);\r\n    return this.prisma.execution.findMany({\r\n      where: {\r\n        status: 'executing',\r\n        updatedAt: { lt: cutoff },\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete old event journal entries for cleanup.\r\n   */\r\n  async pruneOldEvents(olderThanDays: number): Promise<number> {\r\n    const cutoff = new Date(Date.now() - olderThanDays * 24 * 60 * 60 * 1000);\r\n    const result = await this.prisma.executionEvent.deleteMany({\r\n      where: { createdAt: { lt: cutoff } },\r\n    });\r\n    if (result.count > 0) {\r\n      this.logger.log({ message: 'Pruned old execution events', count: result.count });\r\n    }\r\n    return result.count;\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { NoteSource, NoteType, NoteStatus } from '@mentor-ai/shared/prisma';\r\nimport type {\r\n  WorkflowStep,\r\n  ExecutionPlan,\r\n  ExecutionPlanStep,\r\n  ChatMessage,\r\n  ConceptCitation,\r\n  EnrichedSearchResult,\r\n} from '@mentor-ai/shared/types';\r\nimport { ConceptService } from '../knowledge/services/concept.service';\r\nimport { ConceptMatchingService } from '../knowledge/services/concept-matching.service';\r\nimport { CitationInjectorService } from '../knowledge/services/citation-injector.service';\r\nimport { CitationService } from '../knowledge/services/citation.service';\r\nimport { AiGatewayService } from '../ai-gateway/ai-gateway.service';\r\nimport { NotesService } from '../notes/notes.service';\r\nimport { WebSearchService } from '../web-search/web-search.service';\r\nimport { BusinessContextService } from '../knowledge/services/business-context.service';\r\nimport { ConceptRelevanceService } from '../knowledge/services/concept-relevance.service';\r\nimport { generateSystemPrompt } from '../personas/templates/persona-prompts';\r\nimport { getVisibleCategories } from '../knowledge/config/department-categories';\r\n\r\nconst MAX_RECURSION_DEPTH = 10;\r\n\r\nconst WORKFLOW_GENERATION_SYSTEM_PROMPT = `Ti si iskusan dizajner poslovnih radnih tokova za srpska preduzea. Kreiraj strukturirane, sekvencijalne radne tokove gde svaki korak PROIZVODI konkretan poslovni dokument.\r\n\r\nSvaki radni tok mora:\r\n1. Poeti sa dijagnostikom/procenom pre stratekih preporuka  NIKADA ne preskoi analizu trenutnog stanja\r\n2. Ukljuiti promptove koji instruiraju AI da IZVRI posao i PROIZVEDE rezultate  NE da objanjava korisniku\r\n3. Svaki korak proizvodi upotrebljiv izlaz (analizu, plan, matricu, strategiju, profil, itd.)\r\n4. Koristiti odgovarajui departmanski okvir kada je departmentTag specificiran\r\n5. Biti SPECIFIAN za datu kompaniju i industriju  NE generiki\r\n\r\nKRITINO za promptTemplate polje:\r\n- Prompt MORA instruirati AI da URADI posao, NE da objanjava korisniku kako da ga uradi\r\n- Prompt je INTERNI  korisnik ga NIKADA ne vidi. Korisnik vidi samo proizveden dokument.\r\n- UVEK koristi imperativne glagole: \"Izvri\", \"Kreiraj\", \"Analiziraj\", \"Razvij\", \"Mapiraj\", \"Proizvedi\"\r\n- NIKADA ne koristi: \"Objasnite\", \"Razmotrite\", \"Trebalo bi da\", \"Preporuuje se\"\r\n- UVEK koristi placeholder {{businessContext}} za ime kompanije i industrije\r\n- UVEK koristi placeholder {{conceptName}} za naziv koncepta\r\n- SVAKI prompt MORA traiti minimum 800 rei izlaza sa strukturiranim zaglavljima i konkretnim primerima\r\n\r\nPrimer DOBAR promptTemplate:\r\n\"Izvri kompletnu SWOT analizu za {{businessContext}} koristei {{conceptName}} framework. Proizvedi strukturiranu matricu sa minimum 5 stavki po kategoriji. Za svaku stavku napii: nalaz, dokaz/obrazloenje, preporuka za akciju. Koristi tabele gde je mogue. Minimum 1000 rei.\"\r\n\r\nPrimer LO promptTemplate:\r\n\"Objasnite ta je SWOT analiza i kako je primeniti na poslovanje\"\r\n\r\nVANO: Sav tekst MORA biti na SRPSKOM JEZIKU.\r\nVrati SAMO validan JSON niz bez markdown formatiranja.`;\r\n\r\n/**\r\n * Callbacks provided by the gateway for plan execution.\r\n * Avoids circular dependency with ConversationService.\r\n */\r\nexport interface ExecutionCallbacks {\r\n  onStepStart: (stepId: string) => void;\r\n  onStepChunk: (stepId: string, chunk: string) => void;\r\n  onStepComplete: (stepId: string, fullContent: string, citations: ConceptCitation[]) => void;\r\n  onStepFailed: (stepId: string, error: string) => void;\r\n  onStepAwaitingConfirmation: (upcomingStep: ExecutionPlanStep) => void;\r\n  onComplete: (\r\n    status: 'completed' | 'cancelled' | 'failed',\r\n    completedSteps: number,\r\n    totalSteps: number\r\n  ) => void;\r\n  /** Called when post-execution discovery creates new pending tasks (Story 3.2 AC6) */\r\n  onTasksDiscovered?: (newConceptIds: string[]) => void;\r\n  saveMessage: (\r\n    role: 'system' | 'user' | 'assistant',\r\n    content: string,\r\n    conceptId?: string\r\n  ) => Promise<string>;\r\n}\r\n\r\n@Injectable()\r\nexport class WorkflowService {\r\n  private readonly logger = new Logger(WorkflowService.name);\r\n\r\n  /** In-memory store for active execution plans */\r\n  private readonly activePlans = new Map<string, ExecutionPlan>();\r\n  /** Cancellation tokens for running plans */\r\n  private readonly cancellationTokens = new Map<string, boolean>();\r\n  /** Resolve functions for paused workflows awaiting user confirmation */\r\n  private readonly stepResolvers = new Map<string, (userInput?: string) => void>();\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly conceptService: ConceptService,\r\n    private readonly conceptMatchingService: ConceptMatchingService,\r\n    private readonly citationInjectorService: CitationInjectorService,\r\n    private readonly citationService: CitationService,\r\n    private readonly aiGatewayService: AiGatewayService,\r\n    private readonly notesService: NotesService,\r\n    private readonly webSearchService: WebSearchService,\r\n    private readonly businessContextService: BusinessContextService,\r\n    private readonly conceptRelevanceService: ConceptRelevanceService\r\n  ) {}\r\n\r\n  //  Workflow Generation \r\n\r\n  /**\r\n   * Gets a cached workflow or generates a new one for a concept.\r\n   */\r\n  async getOrGenerateWorkflow(\r\n    conceptId: string,\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<{ conceptName: string; steps: WorkflowStep[] }> {\r\n    const existing = await this.prisma.conceptWorkflow.findUnique({\r\n      where: { conceptId },\r\n      include: { concept: { select: { name: true } } },\r\n    });\r\n\r\n    if (existing) {\r\n      return {\r\n        conceptName: existing.concept.name,\r\n        steps: existing.steps as unknown as WorkflowStep[],\r\n      };\r\n    }\r\n\r\n    return this.generateWorkflow(conceptId, tenantId, userId);\r\n  }\r\n\r\n  private async generateWorkflow(\r\n    conceptId: string,\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<{ conceptName: string; steps: WorkflowStep[] }> {\r\n    const concept = await this.conceptService.findById(conceptId);\r\n\r\n    // Load tenant for business context injection\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true, industry: true, description: true },\r\n    });\r\n\r\n    // Gather prerequisite names\r\n    const prerequisites = concept.relatedConcepts\r\n      .filter((r) => r.relationshipType === 'PREREQUISITE' && r.direction === 'outgoing')\r\n      .map((r) => r.concept.name);\r\n\r\n    // Gather related concept names for context\r\n    const relatedConcepts = concept.relatedConcepts\r\n      .filter((r) => r.relationshipType === 'RELATED')\r\n      .slice(0, 5)\r\n      .map((r) => r.concept.name);\r\n\r\n    const prompt = this.buildGenerationPrompt(\r\n      concept.name,\r\n      concept.definition,\r\n      concept.extendedDescription,\r\n      prerequisites,\r\n      concept.departmentTags,\r\n      tenant,\r\n      relatedConcepts\r\n    );\r\n\r\n    // LLM call to generate workflow steps (use fallback/GPT for speed)\r\n    let responseContent = '';\r\n    await this.aiGatewayService.streamCompletionWithContext(\r\n      [\r\n        { role: 'system', content: WORKFLOW_GENERATION_SYSTEM_PROMPT } as ChatMessage,\r\n        { role: 'user', content: prompt } as ChatMessage,\r\n      ],\r\n      {\r\n        tenantId,\r\n        userId,\r\n        skipRateLimit: true,\r\n        skipQuotaCheck: true,\r\n        useFallback: true,\r\n      },\r\n      (chunk: string) => {\r\n        responseContent += chunk;\r\n      }\r\n    );\r\n\r\n    const steps = this.parseWorkflowSteps(responseContent);\r\n\r\n    // Cache in DB\r\n    await this.prisma.conceptWorkflow.create({\r\n      data: {\r\n        id: `wfl_${createId()}`,\r\n        conceptId,\r\n        steps: steps as unknown as import('@prisma/client').Prisma.InputJsonValue,\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Workflow generated and cached',\r\n      conceptId,\r\n      conceptName: concept.name,\r\n      stepCount: steps.length,\r\n    });\r\n\r\n    return { conceptName: concept.name, steps };\r\n  }\r\n\r\n  /**\r\n   * Generates workflow steps specific to a task's content and conversation context.\r\n   * Unlike getOrGenerateWorkflow() which generates generic concept workflows,\r\n   * this produces steps tailored to what the user actually discussed in chat.\r\n   * These are NOT cached  each task gets unique steps.\r\n   */\r\n  async generateTaskSpecificWorkflow(\r\n    task: {\r\n      title: string;\r\n      content: string;\r\n      conversationId: string | null;\r\n      conceptId: string | null;\r\n    },\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<{ conceptName: string; steps: WorkflowStep[] }> {\r\n    // Load concept name if available\r\n    let conceptName = 'Poslovni zadatak';\r\n    let conceptContext = '';\r\n    if (task.conceptId) {\r\n      try {\r\n        const concept = await this.conceptService.findById(task.conceptId);\r\n        conceptName = concept.name;\r\n        conceptContext = `\\nKoncept: ${concept.name}  ${concept.definition}`;\r\n      } catch {\r\n        /* concept not found */\r\n      }\r\n    }\r\n\r\n    // Load conversation messages for context\r\n    let conversationContext = '';\r\n    if (task.conversationId) {\r\n      try {\r\n        const messages = await this.prisma.message.findMany({\r\n          where: { conversationId: task.conversationId },\r\n          orderBy: { createdAt: 'desc' },\r\n          take: 15,\r\n          select: { role: true, content: true },\r\n        });\r\n        if (messages.length > 0) {\r\n          conversationContext =\r\n            '\\n\\nKONVERZACIJA KORISNIKA (ovo je kontekst iz kojeg je nastao zadatak):';\r\n          for (const msg of messages.reverse()) {\r\n            const role = msg.role === 'USER' ? 'KORISNIK' : 'AI';\r\n            const content =\r\n              msg.content.length > 1000 ? msg.content.substring(0, 1000) + '...' : msg.content;\r\n            conversationContext += `\\n${role}: ${content}`;\r\n          }\r\n        }\r\n      } catch {\r\n        /* conversation not found */\r\n      }\r\n    }\r\n\r\n    const prompt = `Generii radni tok za IZVRAVANJE konkretnog poslovnog zadatka.\r\n\r\nZADATAK: ${task.title}\r\n${task.content ? `OPIS ZADATKA: ${task.content}` : ''}${conceptContext}${conversationContext}\r\n\r\nKRITINO: Koraci MORAJU biti direktno povezani sa ZADATKOM iznad i sa KONVERZACIJOM korisnika.\r\nNE generii generike korake za koncept. Generii korake koji reavaju KONKRETAN problem korisnika.\r\n\r\nVrati JSON niz koraka. Svaki korak mora imati:\r\n- stepNumber (celobrojna vrednost poevi od 1)\r\n- title (koncizan naslov akcije, max 60 karaktera, na srpskom)\r\n- description (ta ovaj korak postie, max 200 karaktera, na srpskom)\r\n- promptTemplate (INTERNI prompt koji instruie AI da IZVRI korak. Koristi {{conceptName}} i {{businessContext}} placeholdere. Akcioni glagoli: \"Izvri\", \"Kreiraj\", \"Analiziraj\". NIKADA \"Objasnite\" ili \"Trebalo bi\".)\r\n- expectedOutcome (konkretan deliverable, max 100 karaktera, na srpskom)\r\n- estimatedMinutes (celobrojna vrednost)\r\n- departmentTag (opciono: \"CFO\", \"CMO\", \"CTO\", \"OPERATIONS\", \"LEGAL\", \"CREATIVE\")\r\n\r\nGenerii 3-6 koraka. Poredaj logiki prema zadatku.`;\r\n\r\n    let responseContent = '';\r\n    await this.aiGatewayService.streamCompletionWithContext(\r\n      [\r\n        { role: 'system', content: WORKFLOW_GENERATION_SYSTEM_PROMPT } as ChatMessage,\r\n        { role: 'user', content: prompt } as ChatMessage,\r\n      ],\r\n      { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true, useFallback: true },\r\n      (chunk: string) => {\r\n        responseContent += chunk;\r\n      }\r\n    );\r\n\r\n    const steps = this.parseWorkflowSteps(responseContent);\r\n\r\n    this.logger.log({\r\n      message: 'Task-specific workflow generated',\r\n      taskTitle: task.title,\r\n      conceptName,\r\n      stepCount: steps.length,\r\n    });\r\n\r\n    return { conceptName, steps };\r\n  }\r\n\r\n  private buildGenerationPrompt(\r\n    name: string,\r\n    definition: string,\r\n    extendedDescription: string | undefined,\r\n    prerequisites: string[],\r\n    departmentTags: string[],\r\n    tenant?: { name: string | null; industry: string | null; description: string | null } | null,\r\n    relatedConcepts?: string[]\r\n  ): string {\r\n    let prompt = `Generii radni tok za IZVRAVANJE poslovne analize i PROIZVODNJU konkretnih rezultata koristei koncept \"${name}\".\r\n\r\n--- KONCEPT ---\r\nNaziv: ${name}\r\nDefinicija: ${definition}\r\n${extendedDescription ? `Proireni opis: ${extendedDescription}` : ''}\r\n${prerequisites.length > 0 ? `Preduslovi (koncept se gradi na njima): ${prerequisites.join(', ')}` : 'Nema preduslova  ovo je fundamentalni koncept.'}\r\n${relatedConcepts && relatedConcepts.length > 0 ? `Povezani koncepti: ${relatedConcepts.join(', ')}` : ''}\r\n${departmentTags.length > 0 ? `Relevantni departmani: ${departmentTags.join(', ')}` : ''}`;\r\n\r\n    if (tenant) {\r\n      prompt += `\r\n\r\n--- POSLOVNI KONTEKST ---\r\nKompanija: ${tenant.name ?? 'Nepoznata'}\r\nIndustrija: ${tenant.industry ?? 'Opta'}\r\n${tenant.description ? `Opis: ${tenant.description}` : ''}\r\nKRITINO: Koraci MORAJU biti prilagoeni ovoj kompaniji i industriji. NE generii generike korake.`;\r\n    }\r\n\r\n    prompt += `\r\n\r\n--- FORMAT ODGOVORA ---\r\nVrati JSON niz koraka. Svaki korak mora imati:\r\n- stepNumber (celobrojna vrednost poevi od 1)\r\n- title (koncizan naslov akcije, max 60 karaktera, na srpskom, akcioni glagol: \"Analizirajte...\", \"Kreirajte...\", \"Mapirajte...\")\r\n- description (ta ovaj korak postie i ZATO je vaan, max 200 karaktera, na srpskom)\r\n- promptTemplate (INTERNI prompt koji instruie AI da IZVRI korak i PROIZVEDE konkretan dokument. Mora sadrati {{conceptName}} i {{businessContext}} placeholdere. Zahtevaj minimum 800 rei izlaza, strukturu sa zaglavljima, tabele gde je mogue, konkretne primere i preporuke.)\r\n- expectedOutcome (konkretan deliverable koji klijent moe odmah koristiti, max 100 karaktera, na srpskom)\r\n- estimatedMinutes (celobrojna vrednost, realna procena)\r\n- departmentTag (opciono: \"CFO\", \"CMO\", \"CTO\", \"OPERATIONS\", \"LEGAL\", \"CREATIVE\")\r\n\r\nGenerii 4-6 koraka. Redosled:\r\n1. Dijagnostika/analiza trenutnog stanja\r\n2. Istraivanje trita/konkurencije (ako je relevantno)\r\n3. Strateko planiranje\r\n4. Akcioni plan sa konkretnim koracima\r\n5. KPI i sistem merenja (ako je relevantno)\r\n6. Implementacioni roadmap`;\r\n\r\n    return prompt;\r\n  }\r\n\r\n  private parseWorkflowSteps(response: string): WorkflowStep[] {\r\n    try {\r\n      const cleaned = response\r\n        .replace(/```json?\\n?/g, '')\r\n        .replace(/```/g, '')\r\n        .trim();\r\n      const jsonMatch = cleaned.match(/\\[[\\s\\S]*\\]/);\r\n      if (!jsonMatch) throw new Error('No JSON array found');\r\n\r\n      const parsed = JSON.parse(jsonMatch[0]);\r\n      if (!Array.isArray(parsed) || parsed.length === 0) throw new Error('Empty array');\r\n\r\n      return parsed.map((step: Record<string, unknown>, index: number) => ({\r\n        stepNumber: (step.stepNumber as number) ?? index + 1,\r\n        title: (step.title as string) || `Step ${index + 1}`,\r\n        description: (step.description as string) || '',\r\n        promptTemplate:\r\n          (step.promptTemplate as string) ||\r\n          `Izvri sveobuhvatnu analizu koncepta \"{{conceptName}}\" primenjenu na {{businessContext}}. Proizvedi strukturiran dokument sa konkretnim nalazima, tabelarnim prikazom i akcionim preporukama. Minimum 800 rei.`,\r\n        expectedOutcome: (step.expectedOutcome as string) || '',\r\n        estimatedMinutes: (step.estimatedMinutes as number) ?? 5,\r\n        departmentTag: (step.departmentTag as string) || undefined,\r\n      }));\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Failed to parse workflow steps, using fallback',\r\n        error: error instanceof Error ? error.message : 'Unknown',\r\n      });\r\n      return [\r\n        {\r\n          stepNumber: 1,\r\n          title: 'Analizirajte trenutno stanje',\r\n          description: 'Dijagnostika i analiza primenom ovog koncepta na konkretno poslovanje',\r\n          promptTemplate:\r\n            'Izvri detaljnu analizu koncepta \"{{conceptName}}\" primenjenu na {{businessContext}}. Dijagnostikuj trenutno stanje, identifikuj kljune oblasti za poboljanje. Proizvedi strukturiran dokument sa zaglavljima, tabelama i konkretnim preporukama za akciju. Minimum 1000 rei.',\r\n          expectedOutcome: 'Kompletan analitiki izvetaj sa akcionim preporukama',\r\n          estimatedMinutes: 10,\r\n        },\r\n      ];\r\n    }\r\n  }\r\n\r\n  //  Prerequisite Resolution \r\n\r\n  /**\r\n   * Resolves concept ordering by PREREQUISITE relationships via topological sort.\r\n   * Returns concept IDs in prerequisite-first order.\r\n   */\r\n  async resolveConceptOrder(conceptIds: string[]): Promise<string[]> {\r\n    if (conceptIds.length <= 1) return conceptIds;\r\n\r\n    const graph = new Map<string, string[]>();\r\n\r\n    // Batch load all prerequisite relationships in a single query instead of N findById calls\r\n    try {\r\n      const relationships = await this.prisma.conceptRelationship.findMany({\r\n        where: {\r\n          sourceConceptId: { in: conceptIds },\r\n          relationshipType: 'PREREQUISITE',\r\n          targetConceptId: { in: conceptIds },\r\n        },\r\n        select: { sourceConceptId: true, targetConceptId: true },\r\n      });\r\n\r\n      // Initialize graph nodes\r\n      for (const id of conceptIds) {\r\n        graph.set(id, []);\r\n      }\r\n\r\n      // Build adjacency from batch results\r\n      for (const rel of relationships) {\r\n        const prereqs = graph.get(rel.sourceConceptId);\r\n        if (prereqs) {\r\n          prereqs.push(rel.targetConceptId);\r\n        }\r\n      }\r\n    } catch {\r\n      // Fallback: return original order if query fails\r\n      for (const id of conceptIds) {\r\n        graph.set(id, []);\r\n      }\r\n    }\r\n\r\n    return this.topologicalSort(graph);\r\n  }\r\n\r\n  private topologicalSort(graph: Map<string, string[]>): string[] {\r\n    const visited = new Set<string>();\r\n    const visiting = new Set<string>();\r\n    const result: string[] = [];\r\n\r\n    const visit = (nodeId: string, depth: number): void => {\r\n      if (depth > MAX_RECURSION_DEPTH) {\r\n        this.logger.warn({ message: 'Max recursion depth exceeded', nodeId, depth });\r\n        return;\r\n      }\r\n      if (visited.has(nodeId)) return;\r\n      if (visiting.has(nodeId)) {\r\n        this.logger.warn({ message: 'Circular dependency detected, breaking cycle', nodeId });\r\n        return;\r\n      }\r\n\r\n      visiting.add(nodeId);\r\n      const deps = graph.get(nodeId) || [];\r\n      for (const dep of deps) {\r\n        visit(dep, depth + 1);\r\n      }\r\n      visiting.delete(nodeId);\r\n      visited.add(nodeId);\r\n      result.push(nodeId);\r\n    };\r\n\r\n    for (const nodeId of graph.keys()) {\r\n      visit(nodeId, 0);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  //  Execution Plan Building \r\n\r\n  /**\r\n   * Builds an execution plan from selected task IDs.\r\n   * Loads linked concepts, generates workflows, orders by prerequisites.\r\n   */\r\n  async buildExecutionPlan(\r\n    taskIds: string[],\r\n    userId: string,\r\n    tenantId: string,\r\n    _conversationId: string\r\n  ): Promise<ExecutionPlan> {\r\n    // Load pending tasks\r\n    const tasks = await this.prisma.note.findMany({\r\n      where: {\r\n        id: { in: taskIds },\r\n        tenantId,\r\n        noteType: 'TASK',\r\n        status: 'PENDING',\r\n      },\r\n    });\r\n\r\n    if (tasks.length === 0) {\r\n      throw new Error('No pending tasks found for the given IDs');\r\n    }\r\n\r\n    // Collect concept IDs directly linked to tasks (no semantic expansion)\r\n    // Also build a map from conceptId  task context for injection into steps\r\n    const conceptIdSet = new Set<string>();\r\n    const conceptTaskContext = new Map<\r\n      string,\r\n      { taskTitle: string; taskContent: string; taskConversationId: string | null }\r\n    >();\r\n    for (const task of tasks) {\r\n      if (task.conceptId) {\r\n        conceptIdSet.add(task.conceptId);\r\n        // Keep the first task's context per concept (most relevant)\r\n        if (!conceptTaskContext.has(task.conceptId)) {\r\n          conceptTaskContext.set(task.conceptId, {\r\n            taskTitle: task.title,\r\n            taskContent: task.content ?? '',\r\n            taskConversationId: task.conversationId,\r\n          });\r\n        }\r\n      }\r\n    }\r\n    const conceptIds = [...conceptIdSet];\r\n\r\n    this.logger.log({\r\n      message: 'Concept resolution complete',\r\n      taskCount: tasks.length,\r\n      conceptCount: conceptIds.length,\r\n      conceptIds: conceptIds.slice(0, 10),\r\n    });\r\n\r\n    if (conceptIds.length === 0) {\r\n      throw new Error(\r\n        'Nema relevantnih koncepata za odabrane zadatke. Proverite da li su koncepti uitani u bazu znanja.'\r\n      );\r\n    }\r\n\r\n    // Resolve ordering\r\n    const orderedConceptIds = await this.resolveConceptOrder(conceptIds);\r\n\r\n    // Generate workflows  task-specific ONLY when a real conversation exists,\r\n    // otherwise use cached generic workflow (much faster, avoids 10+ serial LLM calls)\r\n    const planSteps: ExecutionPlanStep[] = [];\r\n\r\n    for (const conceptId of orderedConceptIds) {\r\n      const taskCtx = conceptTaskContext.get(conceptId);\r\n\r\n      // Use task-specific workflow when:\r\n      // 1. Task has a real conversation with user dialogue, OR\r\n      // 2. Task has rich content (>200 chars = enriched by LLM, not a one-liner)\r\n      // Otherwise use cached generic workflow.\r\n      const hasRealConversation = taskCtx && taskCtx.taskConversationId;\r\n      const hasRichContent = taskCtx && taskCtx.taskContent && taskCtx.taskContent.length > 200;\r\n\r\n      let workflow: { conceptName: string; steps: WorkflowStep[] };\r\n      if (hasRealConversation || hasRichContent) {\r\n        workflow = await this.generateTaskSpecificWorkflow(\r\n          {\r\n            title: taskCtx?.taskTitle ?? '',\r\n            content: taskCtx?.taskContent ?? '',\r\n            conversationId: taskCtx?.taskConversationId ?? null,\r\n            conceptId,\r\n          },\r\n          tenantId,\r\n          userId\r\n        );\r\n      } else {\r\n        workflow = await this.getOrGenerateWorkflow(conceptId, tenantId, userId);\r\n      }\r\n\r\n      for (const step of workflow.steps) {\r\n        planSteps.push({\r\n          stepId: `step_${createId()}`,\r\n          conceptId,\r\n          conceptName: workflow.conceptName,\r\n          workflowStepNumber: step.stepNumber,\r\n          title: step.title,\r\n          description: step.description,\r\n          estimatedMinutes: step.estimatedMinutes,\r\n          departmentTag: step.departmentTag,\r\n          status: 'pending',\r\n          taskTitle: taskCtx?.taskTitle,\r\n          taskContent: taskCtx?.taskContent,\r\n          taskConversationId: taskCtx?.taskConversationId ?? undefined,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Deduplicate: if same concept+stepNumber appears multiple times, keep first\r\n    const seen = new Set<string>();\r\n    const deduplicatedSteps = planSteps.filter((step) => {\r\n      const key = `${step.conceptId}:${step.workflowStepNumber}`;\r\n      if (seen.has(key)) return false;\r\n      seen.add(key);\r\n      return true;\r\n    });\r\n\r\n    const plan: ExecutionPlan = {\r\n      planId: `ep_${createId()}`,\r\n      taskIds,\r\n      steps: deduplicatedSteps,\r\n      totalEstimatedMinutes: deduplicatedSteps.reduce((sum, s) => sum + s.estimatedMinutes, 0),\r\n      conceptOrder: orderedConceptIds,\r\n      status: 'awaiting_approval',\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n\r\n    this.activePlans.set(plan.planId, plan);\r\n    this.logger.log({\r\n      message: 'Execution plan built',\r\n      planId: plan.planId,\r\n      taskCount: taskIds.length,\r\n      conceptCount: orderedConceptIds.length,\r\n      stepCount: deduplicatedSteps.length,\r\n      estimatedMinutes: plan.totalEstimatedMinutes,\r\n    });\r\n\r\n    return plan;\r\n  }\r\n\r\n  //  Plan Execution \r\n\r\n  /**\r\n   * Executes an approved plan step by step.\r\n   * Streams each step's LLM output via callbacks.\r\n   */\r\n  async executePlan(\r\n    planId: string,\r\n    conversationId: string,\r\n    userId: string,\r\n    tenantId: string,\r\n    callbacks: ExecutionCallbacks\r\n  ): Promise<void> {\r\n    const plan = this.activePlans.get(planId);\r\n    if (!plan) throw new Error(`Plan ${planId} not found`);\r\n\r\n    plan.status = 'executing';\r\n    this.cancellationTokens.set(planId, false);\r\n\r\n    let completedCount = 0;\r\n    const completedSummaries: Array<{ title: string; conceptName: string; summary: string }> = [];\r\n\r\n    for (let i = 0; i < plan.steps.length; i++) {\r\n      // Check cancellation\r\n      if (this.cancellationTokens.get(planId)) {\r\n        plan.status = 'cancelled';\r\n        callbacks.onComplete('cancelled', completedCount, plan.steps.length);\r\n        this.scheduledCleanup(planId);\r\n        return;\r\n      }\r\n\r\n      const step = plan.steps[i];\r\n      if (!step) continue;\r\n\r\n      // Pause BEFORE each step  let the user provide input/answers\r\n      callbacks.onStepAwaitingConfirmation(step);\r\n\r\n      const userInput = await new Promise<string | undefined>((resolve) => {\r\n        this.stepResolvers.set(planId, resolve);\r\n      });\r\n      this.stepResolvers.delete(planId);\r\n\r\n      // Check cancellation after waiting\r\n      if (this.cancellationTokens.get(planId)) {\r\n        plan.status = 'cancelled';\r\n        callbacks.onComplete('cancelled', completedCount, plan.steps.length);\r\n        this.scheduledCleanup(planId);\r\n        return;\r\n      }\r\n\r\n      // If user provided input, inject it as context for this step\r\n      if (userInput) {\r\n        completedSummaries.push({\r\n          title: 'Korisniki odgovor',\r\n          conceptName: step.conceptName,\r\n          summary: userInput,\r\n        });\r\n      }\r\n\r\n      step.status = 'in_progress';\r\n      callbacks.onStepStart(step.stepId);\r\n\r\n      try {\r\n        const result = await this.executeStepAutonomous(\r\n          step,\r\n          conversationId,\r\n          userId,\r\n          tenantId,\r\n          (chunk) => callbacks.onStepChunk(step.stepId, chunk),\r\n          completedSummaries\r\n        );\r\n\r\n        // Check cancellation after step\r\n        if (this.cancellationTokens.get(planId)) {\r\n          plan.status = 'cancelled';\r\n          callbacks.onComplete('cancelled', completedCount, plan.steps.length);\r\n          this.scheduledCleanup(planId);\r\n          return;\r\n        }\r\n\r\n        // Save AI message with citation-injected content to concept conversation\r\n        const messageId = await callbacks.saveMessage('assistant', result.content, step.conceptId);\r\n\r\n        // Persist citations to DB (fire-and-forget)\r\n        if (result.citations.length > 0 && messageId) {\r\n          this.citationService.storeCitations(messageId, result.citations).catch((err) => {\r\n            this.logger.warn({\r\n              message: 'Failed to store workflow step citations',\r\n              stepId: step.stepId,\r\n              error: err instanceof Error ? err.message : 'Unknown',\r\n            });\r\n          });\r\n        }\r\n\r\n        step.status = 'completed';\r\n        completedCount++;\r\n        completedSummaries.push({\r\n          title: step.title,\r\n          conceptName: step.conceptName,\r\n          summary: result.content.substring(0, 2000),\r\n        });\r\n        callbacks.onStepComplete(step.stepId, result.content, result.citations);\r\n\r\n        // Create sub-task note linked to parent task (with dedup by parentNoteId + stepNumber, Story 3.4 AC3)\r\n        for (const taskId of plan.taskIds) {\r\n          try {\r\n            const parentNote = await this.notesService.getNoteById(taskId, tenantId);\r\n            if (parentNote && parentNote.conceptId === step.conceptId) {\r\n              // Check if sub-task already exists for this step\r\n              const existingSubTask = await this.notesService.findExistingSubTask(\r\n                tenantId,\r\n                taskId,\r\n                step.workflowStepNumber ?? 0\r\n              );\r\n              if (existingSubTask) {\r\n                this.logger.debug({\r\n                  message: 'Skipping duplicate sub-task',\r\n                  stepId: step.stepId,\r\n                  existingSubTaskId: existingSubTask,\r\n                  parentNoteId: taskId,\r\n                  workflowStepNumber: step.workflowStepNumber,\r\n                });\r\n                break;\r\n              }\r\n              await this.notesService.createNote({\r\n                title: step.title,\r\n                content: result.content,\r\n                source: NoteSource.CONVERSATION,\r\n                noteType: NoteType.TASK,\r\n                status: NoteStatus.READY_FOR_REVIEW,\r\n                userId,\r\n                tenantId,\r\n                conversationId,\r\n                conceptId: step.conceptId,\r\n                parentNoteId: taskId,\r\n                expectedOutcome: step.description?.substring(0, 2000),\r\n                workflowStepNumber: step.workflowStepNumber,\r\n              });\r\n              break;\r\n            }\r\n          } catch (err) {\r\n            this.logger.warn({\r\n              message: 'Failed to create sub-task note',\r\n              stepId: step.stepId,\r\n              error: err instanceof Error ? err.message : 'Unknown',\r\n            });\r\n          }\r\n        }\r\n      } catch (error) {\r\n        this.logger.error({\r\n          message: 'Step execution failed',\r\n          stepId: step.stepId,\r\n          error: error instanceof Error ? error.message : 'Unknown',\r\n        });\r\n        step.status = 'failed';\r\n        callbacks.onStepFailed(step.stepId, error instanceof Error ? error.message : 'Step failed');\r\n      }\r\n    }\r\n\r\n    // Mark original tasks as completed\r\n    for (const taskId of plan.taskIds) {\r\n      try {\r\n        await this.notesService.updateStatus(taskId, NoteStatus.COMPLETED, tenantId);\r\n        this.logger.log({ message: 'Task marked COMPLETED', taskId, tenantId });\r\n      } catch (error) {\r\n        // Fallback: try direct DB update bypassing tenant check\r\n        this.logger.error({\r\n          message: 'Failed to mark task complete via service, trying direct update',\r\n          taskId,\r\n          tenantId,\r\n          error: error instanceof Error ? error.message : 'Unknown',\r\n        });\r\n        try {\r\n          await this.prisma.note.update({\r\n            where: { id: taskId },\r\n            data: { status: NoteStatus.COMPLETED },\r\n          });\r\n          this.logger.log({ message: 'Task marked COMPLETED via direct update', taskId });\r\n        } catch (directError) {\r\n          this.logger.error({\r\n            message: 'Direct task update also failed',\r\n            taskId,\r\n            error: directError instanceof Error ? directError.message : 'Unknown',\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Story 3.2: Discover related concepts and create new pending tasks\r\n    const completedConceptIds = [\r\n      ...new Set(plan.steps.filter((s) => s.status === 'completed').map((s) => s.conceptId)),\r\n    ];\r\n    if (completedConceptIds.length > 0) {\r\n      this.discoverAndCreatePendingTasks(completedConceptIds, userId, tenantId)\r\n        .then((newConceptIds) => {\r\n          if (newConceptIds.length > 0 && callbacks.onTasksDiscovered) {\r\n            callbacks.onTasksDiscovered(newConceptIds);\r\n          }\r\n        })\r\n        .catch((err) => {\r\n          this.logger.warn({\r\n            message: 'Post-execution discovery failed',\r\n            planId,\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          });\r\n        });\r\n    }\r\n\r\n    plan.status = 'completed';\r\n    callbacks.onComplete('completed', completedCount, plan.steps.length);\r\n    this.scheduledCleanup(planId);\r\n  }\r\n\r\n  /**\r\n   * Executes a single plan step by calling the LLM with Qdrant-driven concept knowledge.\r\n   * Queries embeddings to find relevant concepts, loads full knowledge, and produces\r\n   * actionable deliverables (not instructions). Citations come from known input concepts.\r\n   */\r\n  async executeStepAutonomous(\r\n    step: ExecutionPlanStep,\r\n    conversationId: string,\r\n    userId: string,\r\n    tenantId: string,\r\n    onChunk: (chunk: string) => void,\r\n    completedSummaries: Array<{ title: string; conceptName: string; summary: string }> = []\r\n  ): Promise<{ content: string; citations: ConceptCitation[] }> {\r\n    // Load the workflow to get the prompt template\r\n    const workflow = await this.getOrGenerateWorkflow(step.conceptId, tenantId, userId);\r\n    const workflowStep = workflow.steps.find((s) => s.stepNumber === step.workflowStepNumber);\r\n\r\n    if (!workflowStep) {\r\n      throw new Error(\r\n        `Workflow step ${step.workflowStepNumber} not found for concept ${step.conceptId}`\r\n      );\r\n    }\r\n\r\n    // 1. Semantic search: find relevant concepts via Qdrant embeddings\r\n    const searchText = `${step.title} ${step.description ?? ''} ${step.conceptName}`;\r\n    const embeddingMatches = await this.conceptMatchingService\r\n      .findRelevantConcepts(searchText, { limit: 5, threshold: 0.5 })\r\n      .catch(() => [] as import('@mentor-ai/shared/types').ConceptMatch[]);\r\n\r\n    // Collect: primary concept + all embedding matches\r\n    const conceptIdsToLoad = new Set<string>([step.conceptId]);\r\n    for (const m of embeddingMatches) {\r\n      conceptIdsToLoad.add(m.conceptId);\r\n    }\r\n\r\n    // 2. Load ALL matched concepts and build rich knowledge block\r\n    const loadedConcepts: import('@mentor-ai/shared/types').ConceptWithRelations[] = [];\r\n    const citationCandidates: import('@mentor-ai/shared/types').ConceptMatch[] = [];\r\n    let conceptKnowledge = '\\n\\n--- BAZA ZNANJA (koristi ovo za izradu zadatka) ---';\r\n\r\n    for (const conceptId of conceptIdsToLoad) {\r\n      try {\r\n        const concept = await this.conceptService.findById(conceptId);\r\n        loadedConcepts.push(concept);\r\n\r\n        conceptKnowledge += `\\n\\nKONCEPT: ${concept.name} (${concept.category})`;\r\n        conceptKnowledge += `\\nDEFINICIJA: ${concept.definition}`;\r\n        if (concept.extendedDescription) {\r\n          conceptKnowledge += `\\nDETALJNO ZNANJE: ${concept.extendedDescription}`;\r\n        }\r\n        if (concept.relatedConcepts && concept.relatedConcepts.length > 0) {\r\n          const related = concept.relatedConcepts\r\n            .slice(0, 5)\r\n            .map((r) => `${r.concept.name} (${r.relationshipType})`)\r\n            .join(', ');\r\n          conceptKnowledge += `\\nPOVEZANI KONCEPTI: ${related}`;\r\n        }\r\n\r\n        citationCandidates.push({\r\n          conceptId: concept.id,\r\n          conceptName: concept.name,\r\n          category: concept.category as import('@mentor-ai/shared/types').ConceptCategory,\r\n          definition: concept.definition,\r\n          score: embeddingMatches.find((m) => m.conceptId === concept.id)?.score ?? 0.8,\r\n        });\r\n      } catch {\r\n        // Concept not found  skip\r\n      }\r\n    }\r\n    conceptKnowledge += '\\n--- KRAJ BAZE ZNANJA ---';\r\n\r\n    // 3. Load business context\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true, industry: true, description: true },\r\n    });\r\n    let businessInfo = '';\r\n    if (tenant) {\r\n      businessInfo = `\\n\\n--- POSLOVNI KONTEKST ---\\nKompanija: ${tenant.name}`;\r\n      if (tenant.industry) businessInfo += `\\nIndustrija: ${tenant.industry}`;\r\n      if (tenant.description) businessInfo += `\\nOpis: ${tenant.description}`;\r\n      businessInfo += '\\n--- KRAJ POSLOVNOG KONTEKSTA ---';\r\n    }\r\n\r\n    // 3.2 Story 3.2: Load tenant-wide Business Brain context (all memories)\r\n    let brainContext = '';\r\n    try {\r\n      brainContext = await this.businessContextService.getBusinessContext(tenantId);\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Business context load failed (non-blocking)',\r\n        tenantId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    }\r\n\r\n    // 3.3 Load originating conversation messages for task-specific context\r\n    let conversationContext = '';\r\n    if (step.taskConversationId) {\r\n      try {\r\n        const recentMessages = await this.prisma.message.findMany({\r\n          where: { conversationId: step.taskConversationId },\r\n          orderBy: { createdAt: 'desc' },\r\n          take: 10,\r\n          select: { role: true, content: true },\r\n        });\r\n        if (recentMessages.length > 0) {\r\n          conversationContext =\r\n            '\\n\\n--- KONTEKST KONVERZACIJE (korisnikov zahtev koji je pokrenuo ovaj zadatak) ---';\r\n          for (const msg of recentMessages.reverse()) {\r\n            const role = msg.role === 'USER' ? 'KORISNIK' : 'AI';\r\n            // Truncate long messages to keep prompt focused\r\n            const content =\r\n              msg.content.length > 500 ? msg.content.substring(0, 500) + '...' : msg.content;\r\n            conversationContext += `\\n${role}: ${content}`;\r\n          }\r\n          conversationContext += '\\n--- KRAJ KONTEKSTA KONVERZACIJE ---';\r\n        }\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Failed to load conversation context for step (non-blocking)',\r\n          stepId: step.stepId,\r\n          conversationId: step.taskConversationId,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    // 3.4 Build task-specific context from originating task\r\n    let taskSpecificContext = '';\r\n    if (step.taskTitle || step.taskContent) {\r\n      taskSpecificContext = '\\n\\n--- SPECIFIAN ZAHTEV KORISNIKA ---';\r\n      if (step.taskTitle) taskSpecificContext += `\\nZADATAK: ${step.taskTitle}`;\r\n      if (step.taskContent) taskSpecificContext += `\\nOPIS: ${step.taskContent}`;\r\n      taskSpecificContext +=\r\n        '\\nKRITINO: Tvoj odgovor MORA biti direktno relevantan za ovaj konkretan zahtev korisnika. Ne pravi generiku analizu  fokusiraj se na ono to je korisnik traio.';\r\n      taskSpecificContext += '\\n--- KRAJ SPECIFINOG ZAHTEVA ---';\r\n    }\r\n\r\n    // 3.5. Web search: enrich with real-time data (always when available)\r\n    let webSearchContext = '';\r\n    if (this.webSearchService.isAvailable()) {\r\n      try {\r\n        const searchQuery = this.buildSearchQuery(step, tenant);\r\n        const enrichedResults = await this.webSearchService.searchAndExtract(searchQuery, 5);\r\n        webSearchContext = this.webSearchService.formatSourcesAsObsidian(enrichedResults);\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Web search failed (non-blocking)',\r\n          stepId: step.stepId,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    // 4. Build ACTIONABLE system prompt with anti-patterns and few-shot examples\r\n    let systemPromptText = `Ti si iskusan poslovni konsultant koji IZVRAVA zadatke za klijenta. NE objanjava koncepte i NE daje uputstva  ti PROIZVODI konkretan poslovni dokument.\r\n\r\nZADATAK: ${step.title}\r\nOEKIVANI REZULTAT: ${workflowStep.expectedOutcome}\r\n\r\nPRAVILA:\r\n1. URADI posao  nemoj opisivati kako se radi. Proizvedi gotov dokument.\r\n2. Koristi ZNANJE O KONCEPTIMA ispod kao analitiki okvir, ali ga NE objanjavaj korisniku\r\n3. Primeni analizu specifino na OVO poslovanje koristei POSLOVNI KONTEKST\r\n4. Proizvedi kompletan, upotrebljiv rezultat koji klijent moe odmah koristiti\r\n5. Kada koristi znanje iz koncepta, oznai ga kao [[Naziv Koncepta]]\r\n6. Budi konkretan  koristi ime kompanije, industriju i specifinu situaciju\r\n7. Strukturiraj sa zaglavljima, tabelama, nabrajanjima i konkretnim preporukama\r\n8. Odgovaraj ISKLJUIVO na srpskom jeziku\r\n\r\nRAZLIKUJ DVA TIPA ZADATAKA:\r\nA) DIGITALNI (sadraj, planovi, analize, mejlovi, kampanje, budeti, abloni, procedure):\r\n    PROIZVEDI GOTOV REZULTAT. Ne daj instrukcije  URADI posao i prikai gotov dokument.\r\nB) FIZIKI (odlazak negde, naruivanje, pozivi, instalacija, sastanci):\r\n    NE simuliraj da si obavio fiziku radnju. Napii KO treba TA da uradi sa svim detaljima.\r\n    Oznai sa \" ZAHTEVA LJUDSKU AKCIJU:\" ispred svakog koraka koji AI ne moe izvriti.\r\n\r\nZABRANJENO (nikada ne radi ovo):\r\n- NE pii \"trebalo bi da analizirate...\" ili \"preporuuje se da razmotrite...\" za digitalne zadatke\r\n- NE pii \"potrebno je da razmotrite...\" ili \"razmislite o sledeem...\"\r\n- NE objanjavaj ta je koncept ili framework  PRIMENI ga\r\n- NE daj generike savete  daj SPECIFINE nalaze za ovu kompaniju\r\n- NE opisuj korake koje klijent treba da preduzme za digitalni rad  TI ih izvri i predstavi rezultate\r\n- NE pii uvode tipa \"U ovom dokumentu emo...\"  odmah poni sa sadrajem\r\n- NE izmiljaj podatke  ako nema konkretan podatak, naznai [POPUNITI: ...]\r\n\r\nPRIMER DOBROG ODGOVORA (SWOT analiza za \"LuxVino\", luksuzna vina):\r\n---\r\n## SWOT Analiza  LuxVino\r\n\r\n### Snage\r\n1. **Premium pozicioniranje**  runa berba i ograniena proizvodnja [[Value Proposition]]\r\n2. **45 godina porodinog vinogradarstva**  autentinost brenda\r\n3. **Ekskluzivni ugovori sa 30+ restorana**  stabilan B2B kanal\r\n\r\n### Slabosti\r\n1. **Samo 2% prihoda iz online kanala**  proputena digitalna publika\r\n---\r\n\r\nPRIMER LOEG ODGOVORA (ZABRANJENO):\r\n---\r\n\"SWOT analiza je strateki alat koji se koristi za procenu snaga, slabosti, prilika i pretnji.\r\nDa biste je primenili na vae poslovanje, trebalo bi da:\r\n1. Identifikujete vae kljune snage...\"\r\n---\r\nOvo je ZABRANJENO jer objanjava alat umesto da ga primeni.${taskSpecificContext}${conversationContext}${conceptKnowledge}${businessInfo}${brainContext}${webSearchContext}`;\r\n\r\n    if (step.departmentTag) {\r\n      const personaPrompt = generateSystemPrompt(step.departmentTag);\r\n      if (personaPrompt) {\r\n        systemPromptText = `${systemPromptText}\\n\\n${personaPrompt}`;\r\n      }\r\n    }\r\n\r\n    // Inject completed step summaries to prevent repetition\r\n    if (completedSummaries.length > 0) {\r\n      systemPromptText += '\\n\\n--- VE ZAVRENI KORACI (NE PONAVLJAJ) ---';\r\n      for (const prev of completedSummaries) {\r\n        systemPromptText += `\\nKORAK: ${prev.title} (${prev.conceptName})`;\r\n        systemPromptText += `\\nREZIME: ${prev.summary}`;\r\n      }\r\n      systemPromptText += '\\n--- KRAJ ZAVRENIH KORAKA ---';\r\n      systemPromptText +=\r\n        '\\nKRITINO: NE ponavljaj analize ili preporuke iz prethodnih koraka. Nadogradi na njima i fokusiraj se SAMO na nove uvide specifine za trenutni zadatak.';\r\n    }\r\n\r\n    // 5. Build user prompt from template\r\n    const prompt = workflowStep.promptTemplate\r\n      .replace(/\\{\\{conceptName\\}\\}/g, step.conceptName)\r\n      .replace(\r\n        /\\{\\{businessContext\\}\\}/g,\r\n        tenant\r\n          ? `za kompaniju \"${tenant.name}\" u industriji ${tenant.industry ?? 'opte poslovanje'}`\r\n          : 'za ovo poslovanje'\r\n      );\r\n\r\n    // 6. Stream AI response\r\n    let fullContent = '';\r\n    await this.aiGatewayService.streamCompletionWithContext(\r\n      [{ role: 'user', content: prompt } as ChatMessage],\r\n      {\r\n        tenantId,\r\n        userId,\r\n        conversationId,\r\n        skipRateLimit: true,\r\n        skipQuotaCheck: true,\r\n        businessContext: systemPromptText,\r\n      },\r\n      (chunk: string) => {\r\n        fullContent += chunk;\r\n        onChunk(chunk);\r\n      }\r\n    );\r\n\r\n    // 7. Inject citations from KNOWN input concepts (not post-hoc output scanning)\r\n    let citations: ConceptCitation[] = [];\r\n    let contentWithCitations = fullContent;\r\n    if (citationCandidates.length > 0) {\r\n      try {\r\n        const citationResult = this.citationInjectorService.injectCitations(\r\n          fullContent,\r\n          citationCandidates\r\n        );\r\n        contentWithCitations = citationResult.content;\r\n        citations = citationResult.citations;\r\n      } catch {\r\n        // Citation injection failed  return content without citations\r\n      }\r\n    }\r\n\r\n    return { content: contentWithCitations, citations };\r\n  }\r\n\r\n  /**\r\n   * Returns an active plan by ID (for metadata lookups).\r\n   */\r\n  getActivePlan(planId: string): ExecutionPlan | undefined {\r\n    return this.activePlans.get(planId);\r\n  }\r\n\r\n  /**\r\n   * Cancels a running plan.\r\n   */\r\n  cancelPlan(planId: string): boolean {\r\n    if (this.activePlans.has(planId)) {\r\n      this.cancellationTokens.set(planId, true);\r\n      // Also resolve any pending step wait so the loop can exit\r\n      const resolver = this.stepResolvers.get(planId);\r\n      if (resolver) {\r\n        resolver(undefined);\r\n        this.stepResolvers.delete(planId);\r\n      }\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Continues a paused workflow after user confirmation.\r\n   * Optionally accepts user input to inject as context for the next step.\r\n   */\r\n  continueStep(planId: string, userInput?: string): void {\r\n    const resolver = this.stepResolvers.get(planId);\r\n    if (resolver) {\r\n      resolver(userInput);\r\n    } else {\r\n      this.logger.warn({ message: 'No step resolver found for plan', planId });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Builds an optimized search query from step context.\r\n   * Leads with concept name, adds step keywords, company name, industry, and current year.\r\n   * Note: Serbian concept names are passed as-is. A future enhancement could translate\r\n   * key Serbian terms to English for improved Google search result quality.\r\n   */\r\n  buildSearchQuery(\r\n    step: ExecutionPlanStep,\r\n    tenant: { name?: string; industry?: string | null } | null\r\n  ): string {\r\n    const parts: string[] = [];\r\n\r\n    // Lead with concept name words (most specific)\r\n    if (step.conceptName) {\r\n      parts.push(...step.conceptName.split(/\\s+/).filter((w) => w.length > 0));\r\n    }\r\n\r\n    // Extract action keywords from step title (strip filler words)\r\n    const fillerWords = new Set([\r\n      'create',\r\n      'a',\r\n      'the',\r\n      'draft',\r\n      'build',\r\n      'develop',\r\n      'perform',\r\n      'run',\r\n      'kreiraj',\r\n      'kreirajte',\r\n      'izradi',\r\n      'izradite',\r\n      'napravi',\r\n      'napravite',\r\n      'izvri',\r\n      'izvrite',\r\n      'uradi',\r\n      'uradite',\r\n      'analizirajte',\r\n      'analiziraj',\r\n      'definiite',\r\n      'definii',\r\n      'razvijte',\r\n      'razvij',\r\n      'primenite',\r\n      'primeni',\r\n      'optimizujte',\r\n      'optimizuj',\r\n      'uspostavite',\r\n      'uspostavi',\r\n      'implementirajte',\r\n      'mapirajte',\r\n      'mapiraj',\r\n      'za',\r\n      'vae',\r\n      'va',\r\n      'ovo',\r\n    ]);\r\n    const titleWords = step.title\r\n      .split(/\\s+/)\r\n      .filter((w) => w.length > 2 && !fillerWords.has(w.toLowerCase()));\r\n    parts.push(...titleWords.slice(0, 4));\r\n\r\n    // Add company name and industry context\r\n    if (tenant?.name) parts.push(tenant.name);\r\n    if (tenant?.industry) parts.push(tenant.industry);\r\n\r\n    // Append current year for temporal relevance\r\n    parts.push(new Date().getFullYear().toString());\r\n\r\n    // Deduplicate (case-insensitive) and limit to 12 words\r\n    const seen = new Set<string>();\r\n    const deduped = parts.filter((w) => {\r\n      const lower = w.toLowerCase();\r\n      if (seen.has(lower)) return false;\r\n      seen.add(lower);\r\n      return true;\r\n    });\r\n\r\n    return deduped.slice(0, 12).join(' ');\r\n  }\r\n\r\n  /**\r\n   * @deprecated Use WebSearchService.formatSourcesAsObsidian() instead.\r\n   * Kept as passthrough for test compatibility.\r\n   */\r\n  formatWebContext(results: EnrichedSearchResult[]): string {\r\n    return this.webSearchService.formatSourcesAsObsidian(results);\r\n  }\r\n\r\n  /**\r\n   * Story 3.2: Post-execution discovery hook.\r\n   * Traverses relationship edges from completed concepts and creates new PENDING tasks\r\n   * for the user, scoped to their visible categories.\r\n   * Capped at 10 new tasks per execution to prevent explosion.\r\n   */\r\n  private async discoverAndCreatePendingTasks(\r\n    completedConceptIds: string[],\r\n    userId: string,\r\n    tenantId: string\r\n  ): Promise<string[]> {\r\n    const MAX_NEW_TASKS = 10;\r\n\r\n    // Get user's department to scope discoveries\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { department: true, role: true },\r\n    });\r\n    const visibleCategories = getVisibleCategories(\r\n      user?.department ?? null,\r\n      user?.role ?? 'MEMBER'\r\n    );\r\n\r\n    // Load all outgoing relationships from completed concepts\r\n    const relationships = await this.prisma.conceptRelationship.findMany({\r\n      where: {\r\n        sourceConceptId: { in: completedConceptIds },\r\n      },\r\n      include: {\r\n        targetConcept: { select: { id: true, name: true, category: true } },\r\n      },\r\n    });\r\n\r\n    if (relationships.length === 0) return [];\r\n\r\n    // Get target concept IDs\r\n    const targetConceptIds = relationships.map((r) => r.targetConcept.id);\r\n\r\n    // Story 3.3 AC6: Single batch query for duplicate prevention\r\n    // Covers both PENDING and COMPLETED task notes for this user\r\n    const existingNotes = await this.prisma.note.findMany({\r\n      where: {\r\n        userId,\r\n        tenantId,\r\n        conceptId: { in: targetConceptIds },\r\n        noteType: NoteType.TASK,\r\n      },\r\n      select: { conceptId: true },\r\n    });\r\n\r\n    const existingConceptIds = new Set(\r\n      existingNotes.map((n) => n.conceptId).filter(Boolean) as string[]\r\n    );\r\n\r\n    // Filter to only new concepts within user's visible categories\r\n    const newConcepts = relationships\r\n      .map((r) => ({\r\n        concept: r.targetConcept,\r\n        relationshipType: r.relationshipType as 'PREREQUISITE' | 'RELATED' | 'ADVANCED',\r\n      }))\r\n      .filter((r) => !existingConceptIds.has(r.concept.id))\r\n      .filter((r) => !visibleCategories || visibleCategories.includes(r.concept.category));\r\n\r\n    // Story 3.3 AC5: Relevance scoring  filter by business relevance\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { industry: true },\r\n    });\r\n    const tenantIndustry = tenant?.industry ?? '';\r\n    const completedSet = new Set(completedConceptIds);\r\n    const relevanceThreshold = this.conceptRelevanceService.getThreshold(user?.role ?? 'MEMBER');\r\n\r\n    // Get categories of completed concepts for domain-specific prior activity scoring\r\n    const completedConceptData = await this.prisma.concept.findMany({\r\n      where: { id: { in: completedConceptIds } },\r\n      select: { category: true },\r\n    });\r\n    const completedCategories = new Set(\r\n      completedConceptData.map((c) => c.category.replace(/^\\d+\\.\\s*/, '').trim())\r\n    );\r\n\r\n    const relevantConcepts = newConcepts.filter((r) => {\r\n      const score = this.conceptRelevanceService.scoreRelevance({\r\n        conceptCategory: r.concept.category,\r\n        tenantIndustry,\r\n        completedConceptIds: completedSet,\r\n        completedCategories,\r\n        department: user?.department ?? null,\r\n        role: user?.role ?? 'MEMBER',\r\n        relationshipType: r.relationshipType,\r\n      });\r\n\r\n      if (score < relevanceThreshold) {\r\n        this.logger.log({\r\n          message: 'Concept skipped  low relevance',\r\n          conceptId: r.concept.id,\r\n          conceptName: r.concept.name,\r\n          score: score.toFixed(2),\r\n          threshold: relevanceThreshold,\r\n          category: r.concept.category,\r\n        });\r\n        return false;\r\n      }\r\n      return true;\r\n    });\r\n\r\n    // Deduplicate\r\n    const uniqueNew = [...new Map(relevantConcepts.map((r) => [r.concept.id, r.concept])).values()];\r\n    const toSeed = uniqueNew.slice(0, MAX_NEW_TASKS);\r\n\r\n    if (toSeed.length === 0) return [];\r\n\r\n    // Create PENDING task Notes\r\n    const noteData = toSeed.map((concept) => ({\r\n      id: `note_${createId()}`,\r\n      title: concept.name,\r\n      content: `Istrai koncept: ${concept.name}`,\r\n      source: NoteSource.CONVERSATION,\r\n      noteType: NoteType.TASK,\r\n      status: NoteStatus.PENDING,\r\n      conceptId: concept.id,\r\n      userId,\r\n      tenantId,\r\n    }));\r\n\r\n    await this.prisma.note.createMany({ data: noteData });\r\n\r\n    const newConceptIds = toSeed.map((c) => c.id);\r\n\r\n    this.logger.log({\r\n      message: 'Post-execution discovery: new pending tasks created',\r\n      userId,\r\n      tenantId,\r\n      completedConceptIds,\r\n      newTaskCount: noteData.length,\r\n      newConceptNames: toSeed.map((c) => c.name),\r\n    });\r\n\r\n    return newConceptIds;\r\n  }\r\n\r\n  private scheduledCleanup(planId: string): void {\r\n    setTimeout(() => {\r\n      this.activePlans.delete(planId);\r\n      this.cancellationTokens.delete(planId);\r\n      this.stepResolvers.delete(planId);\r\n    }, 30000);\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { NoteSource, NoteType, NoteStatus } from '@mentor-ai/shared/prisma';\r\nimport type {\r\n  ExecutionPlanStep,\r\n  YoloConfig,\r\n  YoloProgressPayload,\r\n  YoloCompletePayload,\r\n} from '@mentor-ai/shared/types';\r\nimport { WorkflowService } from './workflow.service';\r\nimport { NotesService } from '../notes/notes.service';\r\nimport { ConceptService } from '../knowledge/services/concept.service';\r\nimport { ConceptMatchingService } from '../knowledge/services/concept-matching.service';\r\nimport { CurriculumService } from '../knowledge/services/curriculum.service';\r\nimport { ConceptExtractionService } from '../knowledge/services/concept-extraction.service';\r\nimport { ConceptRelevanceService } from '../knowledge/services/concept-relevance.service';\r\n\r\n//  Internal Types \r\n\r\ninterface YoloTask {\r\n  taskId: string;\r\n  conceptId: string;\r\n  conceptName: string;\r\n  dependencies: string[]; // conceptIds that must complete first\r\n  status: 'pending' | 'ready' | 'running' | 'completed' | 'failed';\r\n  retries: number;\r\n}\r\n\r\ninterface YoloCallbacks {\r\n  onProgress: (payload: YoloProgressPayload) => void;\r\n  onComplete: (payload: YoloCompletePayload) => void;\r\n  onError: (error: string) => void;\r\n  saveMessage: (role: string, content: string, conceptId?: string) => Promise<string>;\r\n  createConversationForConcept?: (conceptId: string, conceptName: string) => Promise<string | null>;\r\n  onConceptDiscovered?: (conceptId: string, conceptName: string, conversationId: string) => void;\r\n  /** Called after each task completes  used for auto AI popuni (synthesize + score) */\r\n  onTaskCompleted?: (taskId: string, conversationId: string) => void;\r\n}\r\n\r\ninterface YoloRunState {\r\n  planId: string;\r\n  tenantId: string;\r\n  userId: string;\r\n  conversationId: string;\r\n  config: YoloConfig;\r\n  tasks: Map<string, YoloTask>;\r\n  readyQueue: string[];\r\n  runningTasks: Map<string, Promise<void>>;\r\n  completedConcepts: Set<string>;\r\n  failedConcepts: Set<string>;\r\n  completedCount: number;\r\n  failedCount: number;\r\n  cancelled: boolean;\r\n  startTime: number;\r\n  logBuffer: string[];\r\n  conceptConversations: Map<string, string>;\r\n  discoveredConceptIds: Set<string>;\r\n  discoveredCount: number;\r\n  totalConceptsCreated: number;\r\n  workerOutputs: Map<string, string>;\r\n  locks: Map<string, { taskId: string; acquiredAt: number }>;\r\n  consecutiveFailures: number;\r\n  /** Per-worker step tracking for real-time progress (Story 2.16) */\r\n  workerStepInfo: Map<string, { stepIndex: number; totalSteps: number; stepTitle: string }>;\r\n  /** Story 3.10: Concepts created as PENDING tasks but not executed this run */\r\n  createdOnlyCount: number;\r\n  /** Story 3.10: Total candidates considered before top-N selection */\r\n  totalConsidered: number;\r\n  /** Story 3.10: Execution budget for this run */\r\n  executionBudget: number;\r\n}\r\n\r\nconst MAX_LOG_BUFFER = 100;\r\nconst SUMMARY_TRUNCATE_LENGTH = 300;\r\nconst RETRY_BASE_DELAY_MS = 5_000; // 5s base, exponential: 5s, 15s, 45s\r\nconst CIRCUIT_BREAKER_THRESHOLD = 3;\r\nconst CIRCUIT_BREAKER_COOLDOWN_MS = 30_000; // 30s pause after consecutive failures\r\n\r\n@Injectable()\r\nexport class YoloSchedulerService {\r\n  private readonly logger = new Logger(YoloSchedulerService.name);\r\n  private readonly activeRuns = new Map<string, YoloRunState>();\r\n\r\n  constructor(\r\n    private readonly workflowService: WorkflowService,\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly notesService: NotesService,\r\n    private readonly conceptService: ConceptService,\r\n    private readonly conceptMatchingService: ConceptMatchingService,\r\n    private readonly curriculumService: CurriculumService,\r\n    private readonly conceptExtractionService: ConceptExtractionService,\r\n    private readonly conceptRelevanceService: ConceptRelevanceService\r\n  ) {}\r\n\r\n  /**\r\n   * Starts YOLO autonomous execution for all pending tasks of a tenant.\r\n   * Returns the planId for tracking.\r\n   */\r\n  async startYoloExecution(\r\n    tenantId: string,\r\n    userId: string,\r\n    conversationId: string,\r\n    config: YoloConfig,\r\n    callbacks: YoloCallbacks,\r\n    conceptConversations: Map<string, string>,\r\n    category?: string // Story 3.2: per-domain scoping\r\n  ): Promise<string> {\r\n    const planId = `yolo_${createId()}`;\r\n\r\n    // Load pending TASK notes for this tenant\r\n    let taskNotes = await this.prisma.note.findMany({\r\n      where: { tenantId, noteType: 'TASK', status: 'PENDING', conceptId: { not: null } },\r\n    });\r\n\r\n    // Story 3.10: Relevance-ranked concept selection with execution budget\r\n    const executionBudget = config.maxExecutionBudget ?? 50;\r\n    const totalConsidered = taskNotes.length;\r\n    let createdOnlyCount = 0;\r\n\r\n    if (taskNotes.length > 0) {\r\n      const conceptIds = [...new Set(taskNotes.map((n) => n.conceptId!))];\r\n      const concepts = await this.prisma.concept.findMany({\r\n        where: { id: { in: conceptIds } },\r\n        select: { id: true, category: true },\r\n      });\r\n      const conceptCategoryMap = new Map(concepts.map((c) => [c.id, c.category]));\r\n\r\n      if (category) {\r\n        // Per-domain: only concepts in the specified category\r\n        taskNotes = taskNotes.filter(\r\n          (n) => n.conceptId && conceptCategoryMap.get(n.conceptId) === category\r\n        );\r\n      }\r\n\r\n      // Load tenant + user info for relevance scoring\r\n      const tenant = await this.prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        select: { industry: true },\r\n      });\r\n      const user = await this.prisma.user.findUnique({\r\n        where: { id: userId },\r\n        select: { department: true, role: true },\r\n      });\r\n\r\n      // Load completed concepts for prior activity scoring (Review fix: HIGH #7  completedCategories was empty)\r\n      const completedNotes = await this.prisma.note.findMany({\r\n        where: { tenantId, noteType: 'TASK', status: 'COMPLETED', conceptId: { not: null } },\r\n        select: { conceptId: true },\r\n      });\r\n      const completedConceptIds = new Set(completedNotes.map((n) => n.conceptId!));\r\n      const completedConceptData =\r\n        completedConceptIds.size > 0\r\n          ? await this.prisma.concept.findMany({\r\n              where: { id: { in: [...completedConceptIds] } },\r\n              select: { category: true },\r\n            })\r\n          : [];\r\n      const completedCategories = new Set(\r\n        completedConceptData.map((c) => c.category.replace(/^\\d+\\.\\s*/, '').trim())\r\n      );\r\n\r\n      // Load strongest relationship type per concept (Review fix: HIGH #1  relationshipType was missing)\r\n      const conceptRelationships = await this.prisma.conceptRelationship.findMany({\r\n        where: { targetConceptId: { in: conceptIds } },\r\n        select: { targetConceptId: true, relationshipType: true },\r\n      });\r\n      const relPriority: Record<string, number> = { PREREQUISITE: 3, RELATED: 2, ADVANCED: 1 };\r\n      const conceptRelTypes = new Map<string, 'PREREQUISITE' | 'RELATED' | 'ADVANCED'>();\r\n      for (const rel of conceptRelationships) {\r\n        const existing = conceptRelTypes.get(rel.targetConceptId);\r\n        if (!existing || (relPriority[rel.relationshipType] ?? 0) > (relPriority[existing] ?? 0)) {\r\n          conceptRelTypes.set(\r\n            rel.targetConceptId,\r\n            rel.relationshipType as 'PREREQUISITE' | 'RELATED' | 'ADVANCED'\r\n          );\r\n        }\r\n      }\r\n\r\n      // Score every candidate concept by relevance (Review fix: HIGH #3  wrapped in try/catch)\r\n      let scoredCandidates: Array<{ note: (typeof taskNotes)[number]; score: number }>;\r\n      try {\r\n        scoredCandidates = taskNotes.map((note) => ({\r\n          note,\r\n          score: this.conceptRelevanceService.scoreRelevance({\r\n            conceptCategory: conceptCategoryMap.get(note.conceptId!) ?? '',\r\n            tenantIndustry: tenant?.industry ?? '',\r\n            completedConceptIds,\r\n            completedCategories,\r\n            department: user?.department ?? null,\r\n            role: user?.role ?? 'MEMBER',\r\n            relationshipType: conceptRelTypes.get(note.conceptId!),\r\n          }),\r\n        }));\r\n      } catch (err) {\r\n        this.logger.error({\r\n          message: 'Relevance scoring failed, executing all candidates without ranking',\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n        scoredCandidates = taskNotes.map((note) => ({ note, score: 0.5 }));\r\n      }\r\n\r\n      // Sort descending by relevance score\r\n      scoredCandidates.sort((a, b) => b.score - a.score);\r\n\r\n      // Split: top N execute, rest are create-only (already PENDING in DB)\r\n      const toExecute = scoredCandidates.slice(0, executionBudget);\r\n      const toCreateOnly = scoredCandidates.slice(executionBudget);\r\n      createdOnlyCount = toCreateOnly.length;\r\n\r\n      if (toExecute.length > 0 && toCreateOnly.length > 0) {\r\n        const cutoffScore = toExecute[toExecute.length - 1]!.score;\r\n        this.logger.log({\r\n          message: `YOLO concept selection: ${toExecute.length} to execute, ${toCreateOnly.length} deferred`,\r\n          cutoffScore: cutoffScore.toFixed(3),\r\n          totalConsidered,\r\n          executionBudget,\r\n        });\r\n      }\r\n\r\n      taskNotes = toExecute.map((c) => c.note);\r\n    }\r\n\r\n    if (taskNotes.length === 0) {\r\n      callbacks.onError('No pending tasks found');\r\n      return planId;\r\n    }\r\n\r\n    // Build task map with concept info (batch lookups to avoid N+1)\r\n    const tasks = new Map<string, YoloTask>();\r\n    const notesWithConcepts = taskNotes.filter((n) => n.conceptId);\r\n    const uniqueConceptIds = [...new Set(notesWithConcepts.map((n) => n.conceptId!))];\r\n    const conceptNames = new Map<string, string>();\r\n    await Promise.all(\r\n      uniqueConceptIds.map(async (conceptId) => {\r\n        try {\r\n          const concept = await this.conceptService.findById(conceptId);\r\n          if (concept.name) conceptNames.set(conceptId, concept.name);\r\n        } catch {\r\n          // Fallback  concept name resolved from note title below\r\n        }\r\n      })\r\n    );\r\n    for (const note of notesWithConcepts) {\r\n      tasks.set(note.id, {\r\n        taskId: note.id,\r\n        conceptId: note.conceptId!,\r\n        conceptName: conceptNames.get(note.conceptId!) ?? note.title,\r\n        dependencies: [],\r\n        status: 'pending',\r\n        retries: 0,\r\n      });\r\n    }\r\n\r\n    if (tasks.size === 0) {\r\n      callbacks.onError('No tasks with linked concepts found');\r\n      return planId;\r\n    }\r\n\r\n    // Resolve dependencies from PREREQUISITE relationships\r\n    await this.resolveDependencies(tasks);\r\n\r\n    // Initialize ready queue with tasks that have no unmet dependencies\r\n    const readyQueue: string[] = [];\r\n    for (const [taskId, task] of tasks) {\r\n      if (task.dependencies.length === 0) {\r\n        task.status = 'ready';\r\n        readyQueue.push(taskId);\r\n      }\r\n    }\r\n\r\n    const state: YoloRunState = {\r\n      planId,\r\n      tenantId,\r\n      userId,\r\n      conversationId,\r\n      config,\r\n      tasks,\r\n      readyQueue,\r\n      runningTasks: new Map(),\r\n      completedConcepts: new Set(),\r\n      failedConcepts: new Set(),\r\n      completedCount: 0,\r\n      failedCount: 0,\r\n      cancelled: false,\r\n      startTime: Date.now(),\r\n      logBuffer: [],\r\n      conceptConversations,\r\n      discoveredConceptIds: new Set(uniqueConceptIds),\r\n      discoveredCount: 0,\r\n      totalConceptsCreated: 0,\r\n      workerOutputs: new Map(),\r\n      locks: new Map(),\r\n      consecutiveFailures: 0,\r\n      workerStepInfo: new Map(),\r\n      createdOnlyCount,\r\n      totalConsidered,\r\n      executionBudget,\r\n    };\r\n\r\n    this.activeRuns.set(planId, state);\r\n\r\n    this.addLog(\r\n      state,\r\n      `YOLO started: ${tasks.size} executing (of ${totalConsidered} considered), budget=${executionBudget}, deferred=${createdOnlyCount}, maxConcurrency=${config.maxConcurrency}`\r\n    );\r\n\r\n    // Emit initial progress\r\n    callbacks.onProgress(this.buildProgressPayload(state));\r\n\r\n    // Fire-and-forget the main dispatch loop\r\n    this.runDispatchLoop(state, callbacks).catch((err) => {\r\n      this.logger.error({\r\n        message: 'YOLO dispatch loop failed',\r\n        planId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      this.activeRuns.delete(planId);\r\n      callbacks.onError(err instanceof Error ? err.message : 'YOLO execution failed');\r\n    });\r\n\r\n    return planId;\r\n  }\r\n\r\n  cancelRun(planId: string): boolean {\r\n    const state = this.activeRuns.get(planId);\r\n    if (!state) return false;\r\n    state.cancelled = true;\r\n    return true;\r\n  }\r\n\r\n  getRunState(planId: string): YoloRunState | undefined {\r\n    return this.activeRuns.get(planId);\r\n  }\r\n\r\n  //  Main Dispatch Loop \r\n\r\n  private async runDispatchLoop(state: YoloRunState, callbacks: YoloCallbacks): Promise<void> {\r\n    const { config, tasks } = state;\r\n\r\n    while ((state.readyQueue.length > 0 || state.runningTasks.size > 0) && !state.cancelled) {\r\n      // Backpressure: reduce concurrency if queue is very large\r\n      const effectiveConcurrency = state.readyQueue.length > 500 ? 1 : config.maxConcurrency;\r\n\r\n      // Hard stop check\r\n      if (state.completedCount >= config.maxConceptsHardStop) {\r\n        this.addLog(state, `Hard stop reached: ${state.completedCount} concepts completed`);\r\n        break;\r\n      }\r\n\r\n      // Circuit breaker: pause if too many consecutive failures (likely DB outage)\r\n      if (state.consecutiveFailures >= CIRCUIT_BREAKER_THRESHOLD) {\r\n        const cooldown = config.circuitBreakerCooldownMs ?? CIRCUIT_BREAKER_COOLDOWN_MS;\r\n        this.addLog(\r\n          state,\r\n          `Circuit breaker: ${state.consecutiveFailures} consecutive failures, pausing ${cooldown / 1000}s`\r\n        );\r\n        await new Promise((r) => setTimeout(r, cooldown));\r\n        state.consecutiveFailures = 0;\r\n      }\r\n\r\n      // Dispatch from ready queue up to effectiveConcurrency\r\n      let dispatched = false;\r\n      while (state.readyQueue.length > 0 && state.runningTasks.size < effectiveConcurrency) {\r\n        const taskId = state.readyQueue.shift()!;\r\n        const task = tasks.get(taskId);\r\n        if (!task || task.status === 'completed' || task.status === 'failed') continue;\r\n\r\n        // Story 3.10: Per-dispatch relevance re-check removed  all tasks are pre-scored\r\n        // during startYoloExecution() and only top-N enter the task map.\r\n\r\n        // Try to acquire concept lock\r\n        if (!this.tryAcquireLock(state, task.conceptId, taskId)) {\r\n          // Can't lock, put back in queue\r\n          state.readyQueue.push(taskId);\r\n          break; // Wait for a running task to finish\r\n        }\r\n\r\n        task.status = 'running';\r\n        this.addLog(state, `Dispatching: ${task.conceptName} (${taskId})`);\r\n\r\n        const workerPromise = this.executeWorker(state, task, callbacks)\r\n          .then(async () => {\r\n            task.status = 'completed';\r\n            state.completedCount++;\r\n            state.completedConcepts.add(task.conceptId);\r\n            state.consecutiveFailures = 0; // Reset circuit breaker on success\r\n            this.releaseLock(state, task.conceptId);\r\n            this.addLog(state, `Completed: ${task.conceptName}`);\r\n\r\n            // Mark the original task note as COMPLETED\r\n            this.notesService\r\n              .updateStatus(task.taskId, NoteStatus.COMPLETED, state.tenantId)\r\n              .catch((err) => {\r\n                this.logger.warn({\r\n                  message: 'Failed to mark task as completed',\r\n                  taskId: task.taskId,\r\n                  error: err instanceof Error ? err.message : 'Unknown',\r\n                });\r\n              });\r\n\r\n            // Notify gateway for auto AI popuni (synthesize report + score)\r\n            const taskConvId =\r\n              state.conceptConversations.get(task.conceptId) ?? state.conversationId;\r\n            if (callbacks.onTaskCompleted) {\r\n              callbacks.onTaskCompleted(task.taskId, taskConvId);\r\n            }\r\n\r\n            // Extract and create new concepts from AI output (Story 2.15)\r\n            // Runs BEFORE discovery so new concepts have graph edges for traversal\r\n            const workerOutput = state.workerOutputs.get(task.taskId);\r\n            state.workerOutputs.delete(task.taskId);\r\n            if (workerOutput && state.totalConceptsCreated < 20) {\r\n              try {\r\n                const extractionResult =\r\n                  await this.conceptExtractionService.extractAndCreateConcepts(workerOutput, {\r\n                    conversationId: state.conversationId,\r\n                    conceptId: task.conceptId,\r\n                    maxNew: Math.min(5, 20 - state.totalConceptsCreated),\r\n                  });\r\n                state.totalConceptsCreated += extractionResult.created.length;\r\n                if (extractionResult.created.length > 0) {\r\n                  this.addLog(\r\n                    state,\r\n                    `Created ${extractionResult.created.length} new concepts from AI output`\r\n                  );\r\n                }\r\n              } catch (err) {\r\n                this.logger.warn({\r\n                  message: 'Concept extraction failed in YOLO (non-blocking)',\r\n                  taskId: task.taskId,\r\n                  error: err instanceof Error ? err.message : 'Unknown',\r\n                });\r\n              }\r\n\r\n              // Discover related concepts from AI output\r\n              await this.discoverRelatedConcepts(state, task, workerOutput, callbacks);\r\n            }\r\n\r\n            // Re-dispatch: find newly ready tasks (including discovered ones)\r\n            this.reEvaluateReadyQueue(state);\r\n            callbacks.onProgress(this.buildProgressPayload(state));\r\n          })\r\n          .catch(async (err) => {\r\n            state.consecutiveFailures++;\r\n            task.retries++;\r\n            if (task.retries <= config.retryAttempts) {\r\n              // Exponential backoff: 5s, 15s, 45s...\r\n              const baseDelay = config.retryBaseDelayMs ?? RETRY_BASE_DELAY_MS;\r\n              const delay = baseDelay * Math.pow(3, task.retries - 1);\r\n              this.addLog(\r\n                state,\r\n                `Retrying (${task.retries}/${config.retryAttempts}) in ${delay / 1000}s: ${task.conceptName}`\r\n              );\r\n              await new Promise((r) => setTimeout(r, delay));\r\n              task.status = 'ready';\r\n              state.readyQueue.push(taskId);\r\n            } else {\r\n              task.status = 'failed';\r\n              state.failedCount++;\r\n              state.failedConcepts.add(task.conceptId);\r\n              this.addLog(\r\n                state,\r\n                `Failed: ${task.conceptName}  ${err instanceof Error ? err.message : 'Unknown'}`\r\n              );\r\n            }\r\n            this.releaseLock(state, task.conceptId);\r\n            this.reEvaluateReadyQueue(state);\r\n            callbacks.onProgress(this.buildProgressPayload(state));\r\n          })\r\n          .finally(() => {\r\n            state.runningTasks.delete(taskId);\r\n          });\r\n\r\n        state.runningTasks.set(taskId, workerPromise);\r\n        dispatched = true;\r\n      }\r\n\r\n      // If nothing dispatched and tasks are running, wait for one to finish\r\n      if (state.runningTasks.size > 0) {\r\n        await Promise.race([...state.runningTasks.values()]).catch(() => {\r\n          // Errors handled in individual worker .catch()\r\n        });\r\n      } else if (!dispatched && state.readyQueue.length === 0) {\r\n        // Nothing running, nothing ready  we're done or deadlocked\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Clean up\r\n    const durationMs = Date.now() - state.startTime;\r\n    const totalTasks = tasks.size;\r\n    const hardStopped = state.completedCount >= config.maxConceptsHardStop;\r\n\r\n    let status: 'completed' | 'failed' | 'hard-stopped' = 'completed';\r\n    if (hardStopped) status = 'hard-stopped';\r\n    else if (state.failedCount > 0 && state.completedCount === 0) status = 'failed';\r\n\r\n    this.addLog(\r\n      state,\r\n      `YOLO finished: ${status}, completed=${state.completedCount}, failed=${state.failedCount}, duration=${durationMs}ms`\r\n    );\r\n\r\n    callbacks.onComplete({\r\n      planId: state.planId,\r\n      status,\r\n      completed: state.completedCount,\r\n      failed: state.failedCount,\r\n      total: totalTasks,\r\n      discoveredCount: state.discoveredCount,\r\n      durationMs,\r\n      conversationId: state.conversationId,\r\n      logs: [...state.logBuffer],\r\n      createdOnlyCount: state.createdOnlyCount,\r\n      totalConsidered: state.totalConsidered,\r\n      executionBudget: state.executionBudget,\r\n    });\r\n\r\n    // Scheduled cleanup\r\n    setTimeout(() => {\r\n      this.activeRuns.delete(state.planId);\r\n    }, 30000);\r\n  }\r\n\r\n  //  Worker Execution \r\n\r\n  private async executeWorker(\r\n    state: YoloRunState,\r\n    task: YoloTask,\r\n    callbacks: YoloCallbacks\r\n  ): Promise<void> {\r\n    const { tenantId, userId } = state;\r\n\r\n    // Get conversation for this concept\r\n    const conversationId = state.conceptConversations.get(task.conceptId) ?? state.conversationId;\r\n\r\n    // Generate/load workflow for this concept\r\n    const workflow = await this.workflowService.getOrGenerateWorkflow(\r\n      task.conceptId,\r\n      tenantId,\r\n      userId\r\n    );\r\n\r\n    const completedSummaries: Array<{ title: string; conceptName: string; summary: string }> = [];\r\n\r\n    const totalSteps = workflow.steps.length;\r\n\r\n    // Execute each workflow step sequentially within this worker\r\n    for (let stepIdx = 0; stepIdx < workflow.steps.length; stepIdx++) {\r\n      if (state.cancelled) return;\r\n\r\n      const workflowStep = workflow.steps[stepIdx]!;\r\n\r\n      const step: ExecutionPlanStep = {\r\n        stepId: `yolo_step_${createId()}`,\r\n        conceptId: task.conceptId,\r\n        conceptName: task.conceptName,\r\n        workflowStepNumber: workflowStep.stepNumber,\r\n        title: workflowStep.title,\r\n        description: workflowStep.description,\r\n        estimatedMinutes: workflowStep.estimatedMinutes,\r\n        departmentTag: workflowStep.departmentTag,\r\n        status: 'in_progress',\r\n      };\r\n\r\n      // Track step info and emit step-start progress (Story 2.16)\r\n      state.workerStepInfo.set(task.taskId, {\r\n        stepIndex: stepIdx,\r\n        totalSteps,\r\n        stepTitle: workflowStep.title,\r\n      });\r\n      callbacks.onProgress(this.buildProgressPayload(state));\r\n\r\n      // Execute the step using WorkflowService's shared logic\r\n      const result = await this.workflowService.executeStepAutonomous(\r\n        step,\r\n        conversationId,\r\n        userId,\r\n        tenantId,\r\n        () => {\r\n          /* Collect chunks silently  no per-step streaming in YOLO */\r\n        },\r\n        completedSummaries\r\n      );\r\n\r\n      // Emit step-complete progress (Story 2.16)\r\n      state.workerStepInfo.set(task.taskId, {\r\n        stepIndex: stepIdx,\r\n        totalSteps,\r\n        stepTitle: `${workflowStep.title} `,\r\n      });\r\n      callbacks.onProgress(this.buildProgressPayload(state));\r\n\r\n      // Save AI message to concept conversation\r\n      await callbacks.saveMessage('assistant', result.content, task.conceptId);\r\n\r\n      // Create sub-task note (with dedup  Story 3.4 AC3 review fix)\r\n      const existingSubTask = await this.notesService.findExistingSubTask(\r\n        tenantId,\r\n        task.taskId,\r\n        step.workflowStepNumber ?? 0\r\n      );\r\n      if (existingSubTask) {\r\n        this.logger.debug({\r\n          message: 'Skipping duplicate YOLO sub-task',\r\n          stepTitle: step.title,\r\n          existingSubTaskId: existingSubTask,\r\n          parentNoteId: task.taskId,\r\n          workflowStepNumber: step.workflowStepNumber,\r\n        });\r\n      } else {\r\n        await this.notesService.createNote({\r\n          title: step.title,\r\n          content: result.content,\r\n          source: NoteSource.CONVERSATION,\r\n          noteType: NoteType.TASK,\r\n          status: NoteStatus.READY_FOR_REVIEW,\r\n          userId,\r\n          tenantId,\r\n          conversationId,\r\n          conceptId: task.conceptId,\r\n          parentNoteId: task.taskId,\r\n          expectedOutcome: step.description?.substring(0, 500),\r\n          workflowStepNumber: step.workflowStepNumber,\r\n        });\r\n      }\r\n\r\n      // Memory discipline: only keep truncated summary\r\n      completedSummaries.push({\r\n        title: step.title,\r\n        conceptName: task.conceptName,\r\n        summary: result.content.substring(0, SUMMARY_TRUNCATE_LENGTH),\r\n      });\r\n    }\r\n\r\n    // Store concatenated summaries for concept discovery\r\n    const outputForDiscovery = completedSummaries.map((s) => `${s.title}: ${s.summary}`).join('\\n');\r\n    state.workerOutputs.set(task.taskId, outputForDiscovery);\r\n\r\n    // Clean up step tracking (Story 2.16)\r\n    state.workerStepInfo.delete(task.taskId);\r\n  }\r\n\r\n  //  Concept Discovery \r\n\r\n  private async discoverRelatedConcepts(\r\n    state: YoloRunState,\r\n    task: YoloTask,\r\n    aiOutput: string,\r\n    callbacks: YoloCallbacks\r\n  ): Promise<void> {\r\n    if (state.tasks.size >= state.config.maxConceptsHardStop) return;\r\n\r\n    const candidates: Array<{ conceptId: string; conceptName: string; source: string }> = [];\r\n\r\n    // Phase 1: Graph-based discovery (language-independent, reliable)\r\n    try {\r\n      const concept = await this.conceptService.findById(task.conceptId);\r\n      for (const rel of concept.relatedConcepts) {\r\n        // Skip incoming prerequisites (we don't want to go backwards)\r\n        if (rel.relationshipType === 'PREREQUISITE' && rel.direction === 'incoming') continue;\r\n        candidates.push({\r\n          conceptId: rel.concept.id,\r\n          conceptName: rel.concept.name,\r\n          source: `graph:${rel.relationshipType}`,\r\n        });\r\n      }\r\n      this.addLog(\r\n        state,\r\n        `Graph discovery for ${task.conceptName}: ${candidates.length} candidates`\r\n      );\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Graph discovery failed',\r\n        conceptId: task.conceptId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    }\r\n\r\n    // Phase 2: Semantic search (cross-language may still find some matches)\r\n    try {\r\n      const matches = await this.conceptMatchingService.findRelevantConcepts(aiOutput, {\r\n        limit: 10,\r\n        threshold: 0.55,\r\n      });\r\n      for (const match of matches) {\r\n        if (!candidates.some((c) => c.conceptId === match.conceptId)) {\r\n          candidates.push({\r\n            conceptId: match.conceptId,\r\n            conceptName: match.conceptName,\r\n            source: `semantic:${match.score.toFixed(2)}`,\r\n          });\r\n        }\r\n      }\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Semantic discovery failed (non-blocking)',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    }\r\n\r\n    // Process candidates\r\n    for (const candidate of candidates) {\r\n      if (state.discoveredConceptIds.has(candidate.conceptId)) continue;\r\n      if (state.tasks.size >= state.config.maxConceptsHardStop) break;\r\n      await this.addDiscoveredConcept(\r\n        state,\r\n        candidate.conceptId,\r\n        candidate.conceptName,\r\n        candidate.source,\r\n        task.conceptName,\r\n        callbacks\r\n      );\r\n    }\r\n  }\r\n\r\n  private async addDiscoveredConcept(\r\n    state: YoloRunState,\r\n    conceptId: string,\r\n    conceptName: string,\r\n    source: string,\r\n    parentName: string,\r\n    callbacks: YoloCallbacks\r\n  ): Promise<void> {\r\n    try {\r\n      state.discoveredConceptIds.add(conceptId);\r\n      state.discoveredCount++;\r\n      this.addLog(state, `Discovered: ${conceptName} (${source}) via ${parentName}`);\r\n\r\n      // Curriculum linking (best-effort)\r\n      try {\r\n        const node = this.curriculumService.matchTopic(conceptName);\r\n        if (node) await this.curriculumService.ensureConceptExists(node.id);\r\n      } catch {\r\n        // Non-blocking\r\n      }\r\n\r\n      // Story 2.13: Fire-and-forget dynamic relationship creation\r\n      // Deviation: uses .then()/.catch() instead of try/catch  fire-and-forget requires it\r\n      this.conceptService\r\n        .createDynamicRelationships(conceptId, conceptName)\r\n        .then((res) => {\r\n          if (res.relationshipsCreated > 0) {\r\n            this.addLog(\r\n              state,\r\n              `Created ${res.relationshipsCreated} relationships for ${conceptName}`\r\n            );\r\n          }\r\n        })\r\n        .catch((err) =>\r\n          this.logger.warn({\r\n            message: 'Dynamic relationship creation failed',\r\n            conceptName,\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          })\r\n        );\r\n\r\n      // Create PENDING task note (with dedup  Story 3.4 AC3 review fix)\r\n      const existingTask = await this.notesService.findExistingTask(state.tenantId, {\r\n        conceptId,\r\n        title: conceptName,\r\n      });\r\n      if (existingTask) {\r\n        this.logger.debug({\r\n          message: 'Skipping duplicate YOLO discovery task',\r\n          conceptName,\r\n          existingTaskId: existingTask,\r\n          tenantId: state.tenantId,\r\n        });\r\n        return;\r\n      }\r\n      const taskNote = await this.notesService.createNote({\r\n        title: conceptName,\r\n        content: `Primenite ${conceptName} na vae poslovanje`,\r\n        source: NoteSource.CONVERSATION,\r\n        noteType: NoteType.TASK,\r\n        status: NoteStatus.PENDING,\r\n        userId: state.userId,\r\n        tenantId: state.tenantId,\r\n        conversationId: state.conversationId,\r\n        conceptId,\r\n      });\r\n\r\n      // Create conversation via callback\r\n      let conversationId: string | null = null;\r\n      if (callbacks.createConversationForConcept) {\r\n        conversationId = await callbacks.createConversationForConcept(conceptId, conceptName);\r\n        if (conversationId) {\r\n          state.conceptConversations.set(conceptId, conversationId);\r\n        }\r\n      }\r\n\r\n      // Emit tree update to frontend\r\n      if (callbacks.onConceptDiscovered && conversationId) {\r\n        callbacks.onConceptDiscovered(conceptId, conceptName, conversationId);\r\n      }\r\n\r\n      // Story 3.10: Only add to execution queue if budget not exhausted\r\n      // Review fix HIGH #2: Use tasks.size (total admitted slots) instead of partial sum.\r\n      // Node.js single-thread guarantees this check + modify is atomic (no race condition).\r\n      if (state.tasks.size < state.executionBudget) {\r\n        state.tasks.set(taskNote.id, {\r\n          taskId: taskNote.id,\r\n          conceptId,\r\n          conceptName,\r\n          dependencies: [],\r\n          status: 'ready',\r\n          retries: 0,\r\n        });\r\n        state.readyQueue.push(taskNote.id);\r\n      } else {\r\n        // Budget exhausted  task created as PENDING in DB, available for next YOLO run\r\n        state.createdOnlyCount++;\r\n        this.addLog(state, `Budget exhausted, deferred: ${conceptName} (created as PENDING)`);\r\n      }\r\n    } catch (itemErr) {\r\n      // Roll back so it can be retried from another worker's discovery\r\n      state.discoveredConceptIds.delete(conceptId);\r\n      state.discoveredCount = Math.max(0, state.discoveredCount - 1);\r\n      this.logger.warn({\r\n        message: 'Failed to add discovered concept',\r\n        conceptName,\r\n        error: itemErr instanceof Error ? itemErr.message : 'Unknown',\r\n      });\r\n    }\r\n  }\r\n\r\n  //  Dependency Resolution \r\n\r\n  private async resolveDependencies(tasks: Map<string, YoloTask>): Promise<void> {\r\n    const conceptIdToTaskIds = new Map<string, string[]>();\r\n    for (const [taskId, task] of tasks) {\r\n      const list = conceptIdToTaskIds.get(task.conceptId) ?? [];\r\n      list.push(taskId);\r\n      conceptIdToTaskIds.set(task.conceptId, list);\r\n    }\r\n\r\n    const allConceptIds = [...conceptIdToTaskIds.keys()];\r\n    if (allConceptIds.length <= 1) return;\r\n\r\n    // Query PREREQUISITE relationships among our concepts\r\n    for (const [, task] of tasks) {\r\n      try {\r\n        const concept = await this.conceptService.findById(task.conceptId);\r\n        const prereqs = concept.relatedConcepts\r\n          .filter(\r\n            (r) =>\r\n              r.relationshipType === 'PREREQUISITE' &&\r\n              r.direction === 'outgoing' &&\r\n              allConceptIds.includes(r.concept.id)\r\n          )\r\n          .map((r) => r.concept.id);\r\n        task.dependencies = prereqs;\r\n      } catch {\r\n        task.dependencies = [];\r\n      }\r\n    }\r\n  }\r\n\r\n  //  Ready Queue Re-evaluation \r\n\r\n  private reEvaluateReadyQueue(state: YoloRunState): void {\r\n    for (const [taskId, task] of state.tasks) {\r\n      if (task.status !== 'pending') continue;\r\n\r\n      const allDepsMet = task.dependencies.every((depConceptId) =>\r\n        state.completedConcepts.has(depConceptId)\r\n      );\r\n      if (allDepsMet && !state.readyQueue.includes(taskId)) {\r\n        task.status = 'ready';\r\n        state.readyQueue.push(taskId);\r\n        this.addLog(state, `Unblocked: ${task.conceptName}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  //  Lock Manager \r\n\r\n  private static readonly LOCK_TTL_MS = 5 * 60 * 1000; // 5 minutes\r\n\r\n  private tryAcquireLock(state: YoloRunState, conceptId: string, taskId: string): boolean {\r\n    const holder = state.locks.get(conceptId);\r\n    if (holder) {\r\n      if (holder.taskId === taskId) return true;\r\n      // Release stale lock if TTL exceeded\r\n      if (Date.now() - holder.acquiredAt > YoloSchedulerService.LOCK_TTL_MS) {\r\n        this.addLog(state, `Stale lock released: ${conceptId} (held by ${holder.taskId})`);\r\n        state.locks.delete(conceptId);\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n    state.locks.set(conceptId, { taskId, acquiredAt: Date.now() });\r\n    return true;\r\n  }\r\n\r\n  private releaseLock(state: YoloRunState, conceptId: string): void {\r\n    state.locks.delete(conceptId);\r\n  }\r\n\r\n  //  Logging (Ring Buffer) \r\n\r\n  private addLog(state: YoloRunState, message: string): void {\r\n    const entry = `[${new Date().toISOString()}] ${message}`;\r\n    state.logBuffer.push(entry);\r\n    if (state.logBuffer.length > MAX_LOG_BUFFER) {\r\n      state.logBuffer.shift();\r\n    }\r\n    this.logger.log({ message: `YOLO [${state.planId}] ${message}` });\r\n  }\r\n\r\n  //  Progress Builder \r\n\r\n  private buildProgressPayload(state: YoloRunState): YoloProgressPayload {\r\n    const currentTasks: YoloProgressPayload['currentTasks'] = [];\r\n    for (const [, task] of state.tasks) {\r\n      if (task.status === 'running') {\r\n        const stepInfo = state.workerStepInfo.get(task.taskId);\r\n        currentTasks.push({\r\n          conceptName: task.conceptName,\r\n          status: 'running',\r\n          currentStep: stepInfo?.stepTitle,\r\n          currentStepIndex: stepInfo?.stepIndex,\r\n          totalSteps: stepInfo?.totalSteps,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Include last 10 log entries for activity stream (Story 2.16)\r\n    const recentLogs = state.logBuffer.slice(-10);\r\n\r\n    return {\r\n      planId: state.planId,\r\n      running: state.runningTasks.size,\r\n      maxConcurrency: state.config.maxConcurrency,\r\n      completed: state.completedCount,\r\n      failed: state.failedCount,\r\n      total: state.tasks.size,\r\n      discoveredCount: state.discoveredCount,\r\n      executionBudget: state.executionBudget,\r\n      executedSoFar: state.completedCount + state.runningTasks.size,\r\n      createdOnlyCount: state.createdOnlyCount,\r\n      totalConsidered: state.totalConsidered,\r\n      currentTasks,\r\n      recentLogs,\r\n      conversationId: state.conversationId,\r\n    };\r\n  }\r\n}\r\n","import { Module } from '@nestjs/common';\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\nimport { AttachmentsController } from './attachments.controller';\nimport { AttachmentsService } from './attachments.service';\n\n@Module({\n  imports: [TenantModule],\n  controllers: [AttachmentsController],\n  providers: [AttachmentsService],\n  exports: [AttachmentsService],\n})\nexport class AttachmentsModule {}\n","import {\n  Controller,\n  Post,\n  Get,\n  Param,\n  Res,\n  UseGuards,\n  UseInterceptors,\n  UploadedFile,\n  HttpCode,\n  HttpStatus,\n  BadRequestException,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { Response } from 'express';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\nimport { AttachmentsService, UploadedFile as UploadedFileType } from './attachments.service';\n\n@Controller('v1/attachments')\n@UseGuards(JwtAuthGuard)\nexport class AttachmentsController {\n  constructor(private readonly attachmentsService: AttachmentsService) {}\n\n  @Post('upload')\n  @HttpCode(HttpStatus.CREATED)\n  @UseInterceptors(FileInterceptor('file', { limits: { fileSize: 10 * 1024 * 1024 } }))\n  async upload(\n    @CurrentUser() user: CurrentUserPayload,\n    @UploadedFile() file: UploadedFileType,\n  ) {\n    if (!file) {\n      throw new BadRequestException('No file provided');\n    }\n\n    return this.attachmentsService.uploadAndExtract(\n      file,\n      user.userId,\n      user.tenantId,\n    );\n  }\n\n  @Get(':id/file')\n  async getFile(\n    @Param('id') id: string,\n    @CurrentUser() user: CurrentUserPayload,\n    @Res() res: Response,\n  ) {\n    const result = await this.attachmentsService.getAttachmentById(id, user.tenantId);\n    if (!result) {\n      res.status(404).json({ message: 'Attachment not found' });\n      return;\n    }\n\n    res.setHeader('Content-Type', result.mimeType);\n    res.setHeader(\n      'Content-Disposition',\n      `inline; filename=\"${encodeURIComponent(result.originalName)}\"`,\n    );\n    res.sendFile(result.filePath);\n  }\n}\n","module.exports = require(\"express\");","import { Injectable, Logger, BadRequestException } from '@nestjs/common';\nimport { TenantPrismaService } from '@mentor-ai/shared/tenant-context';\nimport { createId } from '@paralleldrive/cuid2';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport type { AttachmentItem } from '@mentor-ai/shared/types';\n\nconst ALLOWED_MIME_TYPES = [\n  'application/pdf',\n  'text/plain',\n  'text/csv',\n  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n  'image/jpeg',\n  'image/png',\n];\n\nconst MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB\nconst MAX_EXTRACTED_TEXT = 50_000; // chars\n\nexport interface UploadedFile {\n  fieldname: string;\n  originalname: string;\n  encoding: string;\n  mimetype: string;\n  size: number;\n  buffer: Buffer;\n}\n\n@Injectable()\nexport class AttachmentsService {\n  private readonly logger = new Logger(AttachmentsService.name);\n  private readonly uploadDir: string;\n\n  constructor(private readonly prisma: TenantPrismaService) {\n    this.uploadDir = path.join(process.cwd(), 'uploads', 'attachments');\n    if (!fs.existsSync(this.uploadDir)) {\n      fs.mkdirSync(this.uploadDir, { recursive: true });\n    }\n  }\n\n  async uploadAndExtract(\n    file: UploadedFile,\n    userId: string,\n    tenantId: string,\n  ): Promise<AttachmentItem> {\n    // Validate\n    if (!ALLOWED_MIME_TYPES.includes(file.mimetype)) {\n      throw new BadRequestException(\n        `Unsupported file type: ${file.mimetype}. Allowed: PDF, TXT, CSV, XLSX, DOCX, JPG, PNG`,\n      );\n    }\n    if (file.size > MAX_FILE_SIZE) {\n      throw new BadRequestException(`File too large. Maximum size: 10MB`);\n    }\n\n    // Save to disk\n    const ext = path.extname(file.originalname).toLowerCase().replace(/[^a-z0-9.]/gi, '') || '.bin';\n    const filename = `${createId()}${ext.startsWith('.') ? ext : `.${ext}`}`;\n    const filePath = path.join(this.uploadDir, filename);\n    await fs.promises.writeFile(filePath, file.buffer);\n\n    // Extract text\n    let extractedText: string | null = null;\n    try {\n      extractedText = await this.extractText(file.buffer, file.mimetype);\n    } catch (err) {\n      this.logger.warn(`Text extraction failed for ${file.originalname}: ${err}`);\n    }\n\n    // Save to DB\n    const client = await this.prisma.getClient(tenantId);\n    const attachment = await client.attachment.create({\n      data: {\n        filename,\n        originalName: file.originalname,\n        mimeType: file.mimetype,\n        size: file.size,\n        storagePath: `uploads/attachments/${filename}`,\n        extractedText,\n        userId,\n        tenantId,\n      },\n    });\n\n    return {\n      id: attachment.id,\n      filename: attachment.filename,\n      originalName: attachment.originalName,\n      mimeType: attachment.mimeType,\n      size: attachment.size,\n      createdAt: attachment.createdAt.toISOString(),\n    };\n  }\n\n  async linkToMessage(attachmentId: string, messageId: string, tenantId: string): Promise<void> {\n    const client = await this.prisma.getClient(tenantId);\n    const updated = await client.attachment.updateMany({\n      where: { id: attachmentId, tenantId },\n      data: { messageId },\n    });\n    if (updated.count === 0) {\n      this.logger.warn(`Attachment ${attachmentId} not found for tenant ${tenantId}`);\n    }\n  }\n\n  async linkToNote(attachmentId: string, noteId: string, tenantId: string): Promise<void> {\n    const client = await this.prisma.getClient(tenantId);\n    const updated = await client.attachment.updateMany({\n      where: { id: attachmentId, tenantId },\n      data: { noteId },\n    });\n    if (updated.count === 0) {\n      this.logger.warn(`Attachment ${attachmentId} not found for tenant ${tenantId}`);\n    }\n  }\n\n  async getExtractedText(attachmentIds: string[], tenantId: string): Promise<string> {\n    if (!attachmentIds.length) return '';\n\n    const client = await this.prisma.getClient(tenantId);\n    const attachments = await client.attachment.findMany({\n      where: { id: { in: attachmentIds }, tenantId },\n      select: { originalName: true, extractedText: true },\n    });\n\n    return attachments\n      .filter((a) => a.extractedText)\n      .map(\n        (a) =>\n          `--- PRILOENI FAJL: ${a.originalName} ---\\n${a.extractedText}\\n--- KRAJ FAJLA ---`,\n      )\n      .join('\\n\\n');\n  }\n\n  async getAttachmentById(\n    attachmentId: string,\n    tenantId: string,\n  ): Promise<{ filePath: string; mimeType: string; originalName: string } | null> {\n    const client = await this.prisma.getClient(tenantId);\n    const attachment = await client.attachment.findUnique({\n      where: { id: attachmentId },\n      select: { storagePath: true, mimeType: true, originalName: true, tenantId: true },\n    });\n\n    if (!attachment || attachment.tenantId !== tenantId) return null;\n\n    const filePath = path.join(process.cwd(), attachment.storagePath);\n    if (!fs.existsSync(filePath)) return null;\n\n    return {\n      filePath,\n      mimeType: attachment.mimeType,\n      originalName: attachment.originalName,\n    };\n  }\n\n  async getAttachmentsByMessageId(messageId: string, tenantId: string): Promise<AttachmentItem[]> {\n    const client = await this.prisma.getClient(tenantId);\n    const attachments = await client.attachment.findMany({\n      where: { messageId },\n      select: {\n        id: true,\n        filename: true,\n        originalName: true,\n        mimeType: true,\n        size: true,\n        createdAt: true,\n      },\n    });\n\n    return attachments.map((a) => ({\n      id: a.id,\n      filename: a.filename,\n      originalName: a.originalName,\n      mimeType: a.mimeType,\n      size: a.size,\n      createdAt: a.createdAt.toISOString(),\n    }));\n  }\n\n  private async extractText(buffer: Buffer, mimeType: string): Promise<string | null> {\n    let text: string | null = null;\n\n    switch (mimeType) {\n      case 'application/pdf': {\n        // eslint-disable-next-line @typescript-eslint/no-require-imports\n        const pdfParse = require('pdf-parse');\n        const result = await pdfParse(buffer);\n        text = result.text;\n        break;\n      }\n      case 'text/plain':\n      case 'text/csv': {\n        text = buffer.toString('utf-8');\n        break;\n      }\n      case 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': {\n        // eslint-disable-next-line @typescript-eslint/no-require-imports\n        const XLSX = require('xlsx');\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\n        const sheets: string[] = [];\n        for (const name of workbook.SheetNames) {\n          const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[name]);\n          sheets.push(`[Sheet: ${name}]\\n${csv}`);\n        }\n        text = sheets.join('\\n\\n');\n        break;\n      }\n      case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document': {\n        // eslint-disable-next-line @typescript-eslint/no-require-imports\n        const mammoth = require('mammoth');\n        const result = await mammoth.extractRawText({ buffer });\n        text = result.value;\n        break;\n      }\n      case 'image/jpeg':\n      case 'image/png':\n        // No text extraction for images\n        return null;\n      default:\n        return null;\n    }\n\n    if (text && text.length > MAX_EXTRACTED_TEXT) {\n      text = text.substring(0, MAX_EXTRACTED_TEXT);\n    }\n\n    return text;\n  }\n}\n","module.exports = require(\"pdf-parse\");","module.exports = require(\"xlsx\");","module.exports = require(\"mammoth\");","import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Delete,\r\n  Patch,\r\n  Body,\r\n  Param,\r\n  UseGuards,\r\n  HttpCode,\r\n  HttpStatus,\r\n} from '@nestjs/common';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { DepartmentGuard } from '../knowledge/guards/department.guard';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\nimport { ConversationService } from './conversation.service';\r\nimport { CreateConversationDto } from './dto/create-conversation.dto';\r\nimport { UpdatePersonaDto } from '../personas/dto/update-persona.dto';\r\nimport { CurriculumService } from '../knowledge/services/curriculum.service';\r\nimport { ConceptService } from '../knowledge/services/concept.service';\r\n\r\n/**\r\n * Controller for chat conversation management.\r\n * All endpoints require JWT authentication.\r\n * Operations are tenant-scoped through the user's JWT claims.\r\n */\r\n@Controller('v1/conversations')\r\n@UseGuards(JwtAuthGuard)\r\nexport class ConversationController {\r\n  constructor(\r\n    private readonly conversationService: ConversationService,\r\n    private readonly curriculumService: CurriculumService,\r\n    private readonly conceptService: ConceptService\r\n  ) {}\r\n\r\n  /**\r\n   * Create a new conversation.\r\n   * If curriculumId is provided, ensures the concept exists in DB first.\r\n   */\r\n  @Post()\r\n  @HttpCode(HttpStatus.CREATED)\r\n  async createConversation(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: CreateConversationDto\r\n  ) {\r\n    let conceptId = dto.conceptId;\r\n\r\n    // If curriculumId is provided, ensure concept exists and get its ID\r\n    if (dto.curriculumId && !conceptId) {\r\n      conceptId = await this.curriculumService.ensureConceptExists(dto.curriculumId);\r\n\r\n      // Story 2.13: Fire-and-forget dynamic relationship creation for newly created concepts\r\n      // Deviation: uses .catch() instead of try/catch  fire-and-forget pattern requires it\r\n      if (conceptId) {\r\n        this.conceptService.createDynamicRelationships(conceptId).catch(() => {\r\n          /* non-blocking */\r\n        });\r\n      }\r\n    }\r\n\r\n    const conversation = await this.conversationService.createConversation(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.title,\r\n      dto.personaType,\r\n      conceptId\r\n    );\r\n\r\n    return { data: conversation };\r\n  }\r\n\r\n  /**\r\n   * List all conversations for the current user.\r\n   * Returns conversations without messages, sorted by most recent.\r\n   */\r\n  @Get()\r\n  @HttpCode(HttpStatus.OK)\r\n  async listConversations(@CurrentUser() user: CurrentUserPayload) {\r\n    const conversations = await this.conversationService.listConversations(\r\n      user.tenantId,\r\n      user.userId\r\n    );\r\n\r\n    return { data: conversations };\r\n  }\r\n\r\n  /**\r\n   * List conversations grouped by concept category for tree display.\r\n   */\r\n  @Get('grouped')\r\n  @HttpCode(HttpStatus.OK)\r\n  async listGroupedConversations(@CurrentUser() user: CurrentUserPayload) {\r\n    const tree = await this.conversationService.listGroupedConversations(\r\n      user.tenantId,\r\n      user.userId\r\n    );\r\n\r\n    return { data: tree };\r\n  }\r\n\r\n  /**\r\n   * Business Brain tree  active + pending concepts grouped by category (Story 3.2).\r\n   * Filtered by the user's department  visible categories.\r\n   */\r\n  @Get('brain-tree')\r\n  @HttpCode(HttpStatus.OK)\r\n  async getBrainTree(@CurrentUser() user: CurrentUserPayload) {\r\n    const tree = await this.conversationService.getBrainTree(\r\n      user.tenantId,\r\n      user.userId,\r\n      user.department,\r\n      user.role\r\n    );\r\n\r\n    return { data: tree };\r\n  }\r\n\r\n  /**\r\n   * Get a single conversation with all its messages.\r\n   * Validates ownership and department scope before returning.\r\n   */\r\n  @Get(':id')\r\n  @UseGuards(DepartmentGuard)\r\n  @HttpCode(HttpStatus.OK)\r\n  async getConversation(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') conversationId: string\r\n  ) {\r\n    const conversation = await this.conversationService.getConversation(\r\n      user.tenantId,\r\n      conversationId,\r\n      user.userId\r\n    );\r\n\r\n    return { data: conversation };\r\n  }\r\n\r\n  /**\r\n   * Delete a conversation and all its messages.\r\n   * Validates ownership before deletion.\r\n   */\r\n  @Delete(':id')\r\n  @HttpCode(HttpStatus.NO_CONTENT)\r\n  async deleteConversation(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') conversationId: string\r\n  ) {\r\n    await this.conversationService.deleteConversation(user.tenantId, conversationId, user.userId);\r\n  }\r\n\r\n  /**\r\n   * Update the persona for a conversation.\r\n   * Allows switching personas mid-conversation while maintaining context.\r\n   * @param conversationId - Conversation ID to update\r\n   * @param dto.personaType - New persona type\r\n   */\r\n  @Patch(':id/persona')\r\n  @HttpCode(HttpStatus.OK)\r\n  async updatePersona(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Param('id') conversationId: string,\r\n    @Body() dto: UpdatePersonaDto\r\n  ) {\r\n    const conversation = await this.conversationService.updatePersona(\r\n      user.tenantId,\r\n      conversationId,\r\n      user.userId,\r\n      dto.personaType\r\n    );\r\n\r\n    return { data: conversation };\r\n  }\r\n}\r\n","import { Injectable, Logger, NotFoundException, ForbiddenException } from '@nestjs/common';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { TenantPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { Prisma } from '@prisma/client';\r\nimport type {\r\n  Conversation,\r\n  ConversationWithMessages,\r\n  ConceptTreeData,\r\n  ConceptHierarchyNode,\r\n  CurriculumNode,\r\n  Message,\r\n  MessageRole,\r\n  PersonaType,\r\n  ConfidenceFactor,\r\n} from '@mentor-ai/shared/types';\r\nimport { ConceptService } from '../knowledge/services/concept.service';\r\nimport { CurriculumService } from '../knowledge/services/curriculum.service';\r\nimport { CitationService } from '../knowledge/services/citation.service';\r\nimport { NotesService } from '../notes/notes.service';\r\nimport { getVisibleCategories } from '../knowledge/config/department-categories';\r\n\r\n/**\r\n * Service for managing chat conversations.\r\n * All operations are tenant-scoped through the TenantPrismaService.\r\n */\r\n@Injectable()\r\nexport class ConversationService {\r\n  private readonly logger = new Logger(ConversationService.name);\r\n\r\n  constructor(\r\n    private readonly tenantPrisma: TenantPrismaService,\r\n    private readonly conceptService: ConceptService,\r\n    private readonly curriculumService: CurriculumService,\r\n    private readonly citationService: CitationService,\r\n    private readonly notesService: NotesService\r\n  ) {}\r\n\r\n  /**\r\n   * Creates a new conversation for a user.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param userId - User ID who owns the conversation\r\n   * @param title - Optional conversation title\r\n   * @param personaType - Optional persona type for department-specific responses\r\n   * @param conceptId - Optional concept ID to link conversation to a business concept\r\n   * @returns Created conversation\r\n   */\r\n  async createConversation(\r\n    tenantId: string,\r\n    userId: string,\r\n    title?: string,\r\n    personaType?: PersonaType,\r\n    conceptId?: string\r\n  ): Promise<Conversation> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n    const conversationId = `sess_${createId()}`;\r\n\r\n    const conversation = await prisma.conversation.create({\r\n      data: {\r\n        id: conversationId,\r\n        userId,\r\n        title: title ?? null,\r\n        personaType: personaType ?? null,\r\n        conceptId: conceptId ?? null,\r\n      },\r\n    });\r\n\r\n    // Look up concept details for response\r\n    let conceptName: string | null = null;\r\n    let conceptCategory: string | null = null;\r\n    if (conceptId) {\r\n      const conceptMap = await this.conceptService.findByIds([conceptId]);\r\n      const info = conceptMap.get(conceptId);\r\n      if (info) {\r\n        conceptName = info.name;\r\n        conceptCategory = info.category;\r\n      }\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Conversation created',\r\n      conversationId,\r\n      userId,\r\n      tenantId,\r\n      personaType: personaType ?? 'none',\r\n      conceptId: conceptId ?? 'none',\r\n    });\r\n\r\n    return this.mapConversation(conversation, conceptName, conceptCategory);\r\n  }\r\n\r\n  /**\r\n   * Updates the persona for a conversation.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param conversationId - Conversation ID to update\r\n   * @param userId - User ID for ownership verification\r\n   * @param personaType - New persona type\r\n   * @returns Updated conversation\r\n   * @throws NotFoundException if conversation not found\r\n   * @throws ForbiddenException if user doesn't own the conversation\r\n   */\r\n  async updatePersona(\r\n    tenantId: string,\r\n    conversationId: string,\r\n    userId: string,\r\n    personaType: PersonaType\r\n  ): Promise<Conversation> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const conversation = await prisma.conversation.findUnique({\r\n      where: { id: conversationId },\r\n    });\r\n\r\n    if (!conversation) {\r\n      throw new NotFoundException({\r\n        type: 'conversation_not_found',\r\n        title: 'Conversation Not Found',\r\n        status: 404,\r\n        detail: `Conversation with ID ${conversationId} not found`,\r\n      });\r\n    }\r\n\r\n    if (conversation.userId !== userId) {\r\n      throw new ForbiddenException({\r\n        type: 'conversation_access_denied',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have access to this conversation',\r\n      });\r\n    }\r\n\r\n    const previousPersona = conversation.personaType;\r\n    const updated = await prisma.conversation.update({\r\n      where: { id: conversationId },\r\n      data: { personaType },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Conversation persona updated',\r\n      conversationId,\r\n      userId,\r\n      tenantId,\r\n      previousPersona: previousPersona ?? 'none',\r\n      newPersona: personaType,\r\n    });\r\n\r\n    return this.mapConversation(updated);\r\n  }\r\n\r\n  /**\r\n   * Lists all conversations for a user.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param userId - User ID to filter conversations\r\n   * @returns Array of conversations (without messages)\r\n   */\r\n  async listConversations(tenantId: string, userId: string): Promise<Conversation[]> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const conversations = await prisma.conversation.findMany({\r\n      where: { userId },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n\r\n    return conversations.map((c) => this.mapConversation(c));\r\n  }\r\n\r\n  /**\r\n   * Lists conversations grouped by curriculum hierarchy for tree display.\r\n   * Builds a sparse tree showing only branches that have active conversations.\r\n   */\r\n  async listGroupedConversations(tenantId: string, userId: string): Promise<ConceptTreeData> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const conversations = await prisma.conversation.findMany({\r\n      where: { userId },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n\r\n    // Separate linked vs unlinked\r\n    const linked = conversations.filter((c) => c.conceptId);\r\n    const uncategorized = conversations.filter((c) => !c.conceptId);\r\n\r\n    // Get active concepts with their curriculumId\r\n    const activeConceptMap = await this.curriculumService.getActiveConceptsByCurriculum();\r\n\r\n    // Map concept IDs to curriculum IDs, group conversations by curriculumId\r\n    const convsByCurriculumId = new Map<string, Conversation[]>();\r\n    const orphaned: typeof uncategorized = [];\r\n\r\n    for (const conv of linked) {\r\n      // Find which curriculum node this concept maps to\r\n      let foundCurriculumId: string | null = null;\r\n      for (const [currId, conceptInfo] of activeConceptMap.entries()) {\r\n        if (conceptInfo.id === conv.conceptId) {\r\n          foundCurriculumId = currId;\r\n          break;\r\n        }\r\n      }\r\n      if (!foundCurriculumId) {\r\n        orphaned.push(conv);\r\n        continue;\r\n      }\r\n      const mapped = this.mapConversation(conv);\r\n      if (!convsByCurriculumId.has(foundCurriculumId)) {\r\n        convsByCurriculumId.set(foundCurriculumId, []);\r\n      }\r\n      convsByCurriculumId.get(foundCurriculumId)!.push(mapped);\r\n    }\r\n\r\n    // Collect ALL discovered concept IDs from notes and citations\r\n    const allDiscoveredConceptIds = new Set<string>();\r\n    try {\r\n      const noteConceptIds = await this.notesService.getDiscoveredConceptIds(userId, tenantId);\r\n      noteConceptIds.forEach((id) => allDiscoveredConceptIds.add(id));\r\n    } catch {\r\n      // Non-critical\r\n    }\r\n    try {\r\n      const citationConceptIds = await this.citationService.getDiscoveredConceptIds(userId);\r\n      citationConceptIds.forEach((id) => allDiscoveredConceptIds.add(id));\r\n    } catch {\r\n      // Non-critical\r\n    }\r\n\r\n    // Add discovered concepts to curriculum tree if they have curriculumId\r\n    for (const conceptId of allDiscoveredConceptIds) {\r\n      for (const [currId, conceptInfo] of activeConceptMap.entries()) {\r\n        if (conceptInfo.id === conceptId && !convsByCurriculumId.has(currId)) {\r\n          convsByCurriculumId.set(currId, []); // discovered via tasks/citations, no conversations yet\r\n        }\r\n      }\r\n    }\r\n\r\n    // Build sparse hierarchy tree from curriculum data\r\n    const activeCurriculumIds = new Set(convsByCurriculumId.keys());\r\n    const neededIds = new Set<string>();\r\n    for (const currId of activeCurriculumIds) {\r\n      const chain = this.curriculumService.getAncestorChain(currId);\r\n      for (const node of chain) {\r\n        neededIds.add(node.id);\r\n      }\r\n    }\r\n\r\n    const fullTree = this.curriculumService.getFullTree();\r\n    const neededNodes = fullTree.filter((n) => neededIds.has(n.id));\r\n    const tree = this.buildHierarchyTree(neededNodes, convsByCurriculumId, activeConceptMap);\r\n\r\n    // === Category-based fallback for concepts WITHOUT curriculumId ===\r\n    // Seeded concepts (from Qdrant) may not have curriculumId set.\r\n    // Group them by category (Finance, Marketing, etc.) as fallback tree nodes.\r\n    const curriculumMappedConceptIds = new Set<string>();\r\n    for (const [, info] of activeConceptMap.entries()) {\r\n      curriculumMappedConceptIds.add(info.id);\r\n    }\r\n\r\n    // Collect concept IDs that are NOT in curriculum\r\n    const unmappedConceptIds = new Set<string>();\r\n    for (const conv of orphaned) {\r\n      if (conv.conceptId) unmappedConceptIds.add(conv.conceptId);\r\n    }\r\n    for (const id of allDiscoveredConceptIds) {\r\n      if (!curriculumMappedConceptIds.has(id)) unmappedConceptIds.add(id);\r\n    }\r\n\r\n    if (unmappedConceptIds.size > 0) {\r\n      const conceptDetails = await this.conceptService.findByIds([...unmappedConceptIds]);\r\n\r\n      // Group orphaned conversations by their conceptId\r\n      const orphanedConvsByConceptId = new Map<string, Conversation[]>();\r\n      for (const conv of orphaned) {\r\n        if (conv.conceptId && unmappedConceptIds.has(conv.conceptId)) {\r\n          if (!orphanedConvsByConceptId.has(conv.conceptId)) {\r\n            orphanedConvsByConceptId.set(conv.conceptId, []);\r\n          }\r\n          orphanedConvsByConceptId.get(conv.conceptId)!.push(this.mapConversation(conv));\r\n        }\r\n      }\r\n\r\n      // Build category  concepts grouping\r\n      const byCategory = new Map<\r\n        string,\r\n        { conceptId: string; name: string; convs: Conversation[] }[]\r\n      >();\r\n      for (const [conceptId, info] of conceptDetails) {\r\n        const cat = info.category || 'General';\r\n        if (!byCategory.has(cat)) byCategory.set(cat, []);\r\n        const convs = orphanedConvsByConceptId.get(conceptId) ?? [];\r\n        byCategory.get(cat)!.push({ conceptId, name: info.name, convs });\r\n      }\r\n\r\n      // Create category tree nodes\r\n      for (const [category, concepts] of byCategory) {\r\n        const children: ConceptHierarchyNode[] = concepts.map((c) => ({\r\n          curriculumId: `concept-${c.conceptId}`,\r\n          label: c.name,\r\n          conceptId: c.conceptId,\r\n          children: [],\r\n          conversationCount: c.convs.length,\r\n          conversations: c.convs,\r\n        }));\r\n\r\n        const totalConvs = children.reduce((sum, ch) => sum + ch.conversationCount, 0);\r\n        tree.push({\r\n          curriculumId: `category-${category.toLowerCase().replace(/\\s+/g, '-')}`,\r\n          label: category,\r\n          children,\r\n          conversationCount: totalConvs,\r\n          conversations: [],\r\n        });\r\n      }\r\n\r\n      // Remove orphaned conversations that are now placed in category tree\r\n      const placedOrphanIds = new Set(\r\n        orphaned.filter((c) => c.conceptId && unmappedConceptIds.has(c.conceptId)).map((c) => c.id)\r\n      );\r\n      const remainingOrphaned = orphaned.filter((c) => !placedOrphanIds.has(c.id));\r\n\r\n      return {\r\n        tree,\r\n        uncategorized: [...uncategorized, ...remainingOrphaned].map((c) => this.mapConversation(c)),\r\n      };\r\n    }\r\n\r\n    return {\r\n      tree,\r\n      uncategorized: [...uncategorized, ...orphaned].map((c) => this.mapConversation(c)),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Builds a hierarchical tree from the needed curriculum nodes.\r\n   */\r\n  private buildHierarchyTree(\r\n    nodes: CurriculumNode[],\r\n    convsByCurriculumId: Map<string, Conversation[]>,\r\n    activeConceptMap: Map<\r\n      string,\r\n      { id: string; name: string; curriculumId: string; parentId: string | null }\r\n    >\r\n  ): ConceptHierarchyNode[] {\r\n    const nodeMap = new Map(nodes.map((n) => [n.id, n]));\r\n    const childrenMap = new Map<string | null, CurriculumNode[]>();\r\n\r\n    for (const node of nodes) {\r\n      const parentKey = node.parentId;\r\n      if (!childrenMap.has(parentKey)) {\r\n        childrenMap.set(parentKey, []);\r\n      }\r\n      childrenMap.get(parentKey)!.push(node);\r\n    }\r\n\r\n    const buildNode = (currNode: CurriculumNode): ConceptHierarchyNode => {\r\n      const children = (childrenMap.get(currNode.id) ?? [])\r\n        .sort((a, b) => a.sortOrder - b.sortOrder)\r\n        .map(buildNode);\r\n\r\n      const directConvs = convsByCurriculumId.get(currNode.id) ?? [];\r\n      const childConvCount = children.reduce((sum, c) => sum + c.conversationCount, 0);\r\n      const conceptInfo = activeConceptMap.get(currNode.id);\r\n\r\n      return {\r\n        curriculumId: currNode.id,\r\n        label: currNode.label,\r\n        conceptId: conceptInfo?.id,\r\n        children,\r\n        conversationCount: directConvs.length + childConvCount,\r\n        conversations: directConvs,\r\n      };\r\n    };\r\n\r\n    // Get root nodes (those whose parentId is not in our needed set)\r\n    const roots = nodes.filter((n) => !n.parentId || !nodeMap.has(n.parentId));\r\n    return roots.sort((a, b) => a.sortOrder - b.sortOrder).map(buildNode);\r\n  }\r\n\r\n  /**\r\n   * Builds the Business Brain tree (Story 3.2, rewritten Story 3.4).\r\n   * Returns an N-level hierarchy matching the Obsidian vault structure.\r\n   * Shows only concepts with conversations or pending/completed tasks (sparse tree).\r\n   * All ancestor folders are preserved to maintain context.\r\n   * Filtered by user's department  visible top-level categories.\r\n   */\r\n  async getBrainTree(\r\n    tenantId: string,\r\n    userId: string,\r\n    department: string | null,\r\n    role: string\r\n  ): Promise<ConceptTreeData> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    // 1. Get conversations for linking (to enable \"Pogledaj\" navigation)\r\n    const convRows = await prisma.conversation.findMany({\r\n      where: { conceptId: { not: null } },\r\n      select: { conceptId: true, userId: true, id: true, title: true, updatedAt: true },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n\r\n    // 2. Get task notes by status\r\n    const isOwner = role === 'PLATFORM_OWNER' || role === 'TENANT_OWNER' || !department;\r\n    const [pendingTasks, completedTasks] = await Promise.all([\r\n      this.notesService.getPendingTaskConceptIds(tenantId, isOwner ? undefined : userId),\r\n      this.notesService.getCompletedTaskConceptIds(tenantId, isOwner ? undefined : userId),\r\n    ]);\r\n\r\n    // 3. Collect unique concept IDs and build lookup maps\r\n    const allConceptIds = new Set<string>();\r\n    const convMap = new Map<\r\n      string,\r\n      { userId: string; conversationId: string; title: string | null; updatedAt: Date }\r\n    >();\r\n    const convsByConceptId = new Map<string, Conversation[]>();\r\n    const completedMap = new Map<string, { userId: string; noteId: string }>();\r\n    const pendingMap = new Map<string, { userId: string; noteId: string }>();\r\n\r\n    for (const conv of convRows) {\r\n      if (conv.conceptId) {\r\n        allConceptIds.add(conv.conceptId);\r\n        if (!convMap.has(conv.conceptId)) {\r\n          convMap.set(conv.conceptId, {\r\n            userId: conv.userId,\r\n            conversationId: conv.id,\r\n            title: conv.title,\r\n            updatedAt: conv.updatedAt,\r\n          });\r\n        }\r\n        // Group all conversations by concept for the tree\r\n        if (!convsByConceptId.has(conv.conceptId)) {\r\n          convsByConceptId.set(conv.conceptId, []);\r\n        }\r\n        convsByConceptId.get(conv.conceptId)!.push({\r\n          id: conv.id,\r\n          title: conv.title ?? 'Untitled',\r\n          updatedAt: conv.updatedAt.toISOString(),\r\n        } as Conversation);\r\n      }\r\n    }\r\n\r\n    for (const task of completedTasks) {\r\n      allConceptIds.add(task.conceptId);\r\n      if (!completedMap.has(task.conceptId)) {\r\n        completedMap.set(task.conceptId, { userId: task.userId, noteId: task.noteId });\r\n      }\r\n    }\r\n\r\n    for (const task of pendingTasks) {\r\n      allConceptIds.add(task.conceptId);\r\n      if (!pendingMap.has(task.conceptId)) {\r\n        pendingMap.set(task.conceptId, { userId: task.userId, noteId: task.noteId });\r\n      }\r\n    }\r\n\r\n    if (allConceptIds.size === 0) {\r\n      return { tree: [], uncategorized: [] };\r\n    }\r\n\r\n    // 4. Load concept details (includes slug = curriculumId)\r\n    const conceptMap = await this.conceptService.findByIds([...allConceptIds]);\r\n\r\n    // 5. Get visible categories for department filtering\r\n    const visibleCategories = getVisibleCategories(department, role);\r\n\r\n    // 6. Collect all curriculum IDs that need to appear in the tree\r\n    //    For each active concept, include it + all its ancestors\r\n    const neededCurriculumIds = new Set<string>();\r\n    const conceptToCurriculum = new Map<string, string>(); // conceptId  curriculumId\r\n\r\n    for (const [conceptId, info] of conceptMap) {\r\n      // Filter by visible categories (strip number prefix from DB category for comparison)\r\n      const normalizedCategory = info.category.replace(/^\\d+(\\.\\d+)*\\.?\\s+/, '');\r\n      if (visibleCategories && !visibleCategories.includes(normalizedCategory)) {\r\n        continue;\r\n      }\r\n\r\n      // Resolve curriculum ID  fall back to slug, stripping number prefix if needed\r\n      let curriculumId = info.curriculumId ?? info.slug;\r\n      if (!this.curriculumService.findNode(curriculumId)) {\r\n        const stripped = curriculumId.replace(/^\\d+-/, '');\r\n        if (this.curriculumService.findNode(stripped)) {\r\n          curriculumId = stripped;\r\n        }\r\n      }\r\n      conceptToCurriculum.set(conceptId, curriculumId);\r\n\r\n      // Add this node and all its ancestors to the needed set\r\n      const chain = this.curriculumService.getAncestorChain(curriculumId);\r\n      for (const ancestor of chain) {\r\n        neededCurriculumIds.add(ancestor.id);\r\n      }\r\n    }\r\n\r\n    // 7. Build sparse tree from curriculum nodes\r\n    const allCurriculumNodes = this.curriculumService.getFullTree();\r\n    const curriculumNodeMap = new Map(allCurriculumNodes.map((n) => [n.id, n]));\r\n\r\n    // Build a map of curriculumId  ConceptHierarchyNode\r\n    const treeNodeMap = new Map<string, ConceptHierarchyNode>();\r\n\r\n    for (const currId of neededCurriculumIds) {\r\n      const currNode = curriculumNodeMap.get(currId);\r\n      if (!currNode) continue;\r\n\r\n      // Find if there's an active concept at this curriculum position\r\n      let conceptId: string | undefined;\r\n      let status: 'completed' | 'pending' | undefined;\r\n      let completedByUserId: string | undefined;\r\n      let pendingNoteId: string | undefined;\r\n      let linkedConversationId: string | undefined;\r\n      const conversations: Conversation[] = [];\r\n\r\n      // Search for a concept mapped to this curriculum node\r\n      for (const [cId, cSlug] of conceptToCurriculum) {\r\n        if (cSlug === currId) {\r\n          conceptId = cId;\r\n          const completed = completedMap.get(cId);\r\n          const pending = pendingMap.get(cId);\r\n          const conv = convMap.get(cId);\r\n          status = completed ? 'completed' : 'pending';\r\n          completedByUserId = completed?.userId;\r\n          pendingNoteId = pending?.noteId;\r\n          linkedConversationId = conv?.conversationId;\r\n          conversations.push(...(convsByConceptId.get(cId) ?? []));\r\n          break;\r\n        }\r\n      }\r\n\r\n      treeNodeMap.set(currId, {\r\n        curriculumId: currId,\r\n        label: currNode.label,\r\n        conceptId,\r\n        children: [],\r\n        conversationCount: 0,\r\n        conversations,\r\n        status,\r\n        completedByUserId,\r\n        pendingNoteId,\r\n        linkedConversationId,\r\n      });\r\n    }\r\n\r\n    // 8. Wire up parent-child relationships\r\n    const rootNodes: ConceptHierarchyNode[] = [];\r\n\r\n    for (const [currId, treeNode] of treeNodeMap) {\r\n      const currNode = curriculumNodeMap.get(currId);\r\n      if (!currNode?.parentId || !treeNodeMap.has(currNode.parentId)) {\r\n        // This is a root node (or its parent isn't in the sparse tree)\r\n        rootNodes.push(treeNode);\r\n      } else {\r\n        const parent = treeNodeMap.get(currNode.parentId)!;\r\n        parent.children.push(treeNode);\r\n      }\r\n    }\r\n\r\n    // 9. Sort children at every level by the curriculum sortOrder\r\n    const sortChildren = (nodes: ConceptHierarchyNode[]): void => {\r\n      nodes.sort((a, b) => {\r\n        const aSort = curriculumNodeMap.get(a.curriculumId)?.sortOrder ?? 999;\r\n        const bSort = curriculumNodeMap.get(b.curriculumId)?.sortOrder ?? 999;\r\n        return aSort - bSort;\r\n      });\r\n      for (const node of nodes) {\r\n        sortChildren(node.children);\r\n      }\r\n    };\r\n    sortChildren(rootNodes);\r\n    rootNodes.sort((a, b) => {\r\n      const aSort = curriculumNodeMap.get(a.curriculumId)?.sortOrder ?? 999;\r\n      const bSort = curriculumNodeMap.get(b.curriculumId)?.sortOrder ?? 999;\r\n      return aSort - bSort;\r\n    });\r\n\r\n    // 10. Bubble up conversationCount from leaves to ancestors\r\n    const bubbleUpCounts = (node: ConceptHierarchyNode): number => {\r\n      let count = node.conversations.length;\r\n      for (const child of node.children) {\r\n        count += bubbleUpCounts(child);\r\n      }\r\n      node.conversationCount = count;\r\n      return count;\r\n    };\r\n    for (const root of rootNodes) {\r\n      bubbleUpCounts(root);\r\n    }\r\n\r\n    // 11. Get uncategorized conversations (no conceptId)\r\n    const uncategorizedConvs = await prisma.conversation.findMany({\r\n      where: { conceptId: null, userId },\r\n      select: { id: true, title: true, updatedAt: true },\r\n      orderBy: { updatedAt: 'desc' },\r\n      take: 50,\r\n    });\r\n\r\n    const uncategorized: Conversation[] = uncategorizedConvs.map(\r\n      (c) =>\r\n        ({\r\n          id: c.id,\r\n          title: c.title ?? 'Untitled',\r\n          updatedAt: c.updatedAt.toISOString(),\r\n        }) as Conversation\r\n    );\r\n\r\n    return { tree: rootNodes, uncategorized };\r\n  }\r\n\r\n  /**\r\n   * Updates the concept ID for a conversation.\r\n   */\r\n  async updateConceptId(\r\n    tenantId: string,\r\n    conversationId: string,\r\n    userId: string,\r\n    conceptId: string\r\n  ): Promise<void> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n    await prisma.conversation.update({\r\n      where: { id: conversationId },\r\n      data: { conceptId },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Conversation concept updated',\r\n      conversationId,\r\n      userId,\r\n      tenantId,\r\n      conceptId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets a conversation by ID with all messages.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param conversationId - Conversation ID to retrieve\r\n   * @param userId - User ID for ownership verification\r\n   * @returns Conversation with messages\r\n   * @throws NotFoundException if conversation not found\r\n   * @throws ForbiddenException if user doesn't own the conversation\r\n   */\r\n  async getConversation(\r\n    tenantId: string,\r\n    conversationId: string,\r\n    userId: string\r\n  ): Promise<ConversationWithMessages> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const conversation = await prisma.conversation.findUnique({\r\n      where: { id: conversationId },\r\n      include: {\r\n        messages: {\r\n          orderBy: { createdAt: 'asc' },\r\n          include: {\r\n            attachments: {\r\n              select: {\r\n                id: true,\r\n                filename: true,\r\n                originalName: true,\r\n                mimeType: true,\r\n                size: true,\r\n                createdAt: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!conversation) {\r\n      throw new NotFoundException({\r\n        type: 'conversation_not_found',\r\n        title: 'Conversation Not Found',\r\n        status: 404,\r\n        detail: `Conversation with ID ${conversationId} not found`,\r\n      });\r\n    }\r\n\r\n    if (conversation.userId !== userId) {\r\n      throw new ForbiddenException({\r\n        type: 'conversation_access_denied',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have access to this conversation',\r\n      });\r\n    }\r\n\r\n    return this.mapConversationWithMessages(conversation);\r\n  }\r\n\r\n  /**\r\n   * Deletes a conversation and all its messages.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param conversationId - Conversation ID to delete\r\n   * @param userId - User ID for ownership verification\r\n   * @throws NotFoundException if conversation not found\r\n   * @throws ForbiddenException if user doesn't own the conversation\r\n   */\r\n  async deleteConversation(\r\n    tenantId: string,\r\n    conversationId: string,\r\n    userId: string\r\n  ): Promise<void> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const conversation = await prisma.conversation.findUnique({\r\n      where: { id: conversationId },\r\n    });\r\n\r\n    if (!conversation) {\r\n      throw new NotFoundException({\r\n        type: 'conversation_not_found',\r\n        title: 'Conversation Not Found',\r\n        status: 404,\r\n        detail: `Conversation with ID ${conversationId} not found`,\r\n      });\r\n    }\r\n\r\n    if (conversation.userId !== userId) {\r\n      throw new ForbiddenException({\r\n        type: 'conversation_access_denied',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have access to this conversation',\r\n      });\r\n    }\r\n\r\n    // Messages are cascade deleted due to onDelete: Cascade in schema\r\n    await prisma.conversation.delete({\r\n      where: { id: conversationId },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Conversation deleted',\r\n      conversationId,\r\n      userId,\r\n      tenantId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Adds a message to a conversation.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param conversationId - Conversation to add message to\r\n   * @param role - Message role (USER or ASSISTANT)\r\n   * @param content - Message content\r\n   * @param confidenceScore - Optional confidence score (0.0-1.0) for AI messages\r\n   * @param confidenceFactors - Optional confidence factor breakdown for AI messages\r\n   * @returns Created message\r\n   */\r\n  async addMessage(\r\n    tenantId: string,\r\n    conversationId: string,\r\n    role: MessageRole,\r\n    content: string,\r\n    confidenceScore?: number | null,\r\n    confidenceFactors?: ConfidenceFactor[] | null\r\n  ): Promise<Message> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n    const messageId = `msg_${createId()}`;\r\n\r\n    const message = await prisma.message.create({\r\n      data: {\r\n        id: messageId,\r\n        conversationId,\r\n        role,\r\n        content,\r\n        confidenceScore: confidenceScore ?? null,\r\n        // Prisma requires JSON input to be cast as InputJsonValue\r\n        confidenceFactors: confidenceFactors\r\n          ? (confidenceFactors as unknown as Prisma.InputJsonValue)\r\n          : Prisma.JsonNull,\r\n      },\r\n    });\r\n\r\n    // Update conversation's updatedAt timestamp\r\n    await prisma.conversation.update({\r\n      where: { id: conversationId },\r\n      data: { updatedAt: new Date() },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Message added to conversation',\r\n      messageId,\r\n      conversationId,\r\n      role,\r\n      tenantId,\r\n      confidenceScore: confidenceScore ?? 'N/A',\r\n    });\r\n\r\n    return this.mapMessage(message);\r\n  }\r\n\r\n  /**\r\n   * Updates the conversation title.\r\n   * @param tenantId - Tenant ID for database isolation\r\n   * @param conversationId - Conversation to update\r\n   * @param userId - User ID for ownership verification\r\n   * @param title - New title\r\n   * @returns Updated conversation\r\n   */\r\n  async updateTitle(\r\n    tenantId: string,\r\n    conversationId: string,\r\n    userId: string,\r\n    title: string\r\n  ): Promise<Conversation> {\r\n    const prisma = await this.tenantPrisma.getClient(tenantId);\r\n\r\n    const conversation = await prisma.conversation.findUnique({\r\n      where: { id: conversationId },\r\n    });\r\n\r\n    if (!conversation) {\r\n      throw new NotFoundException({\r\n        type: 'conversation_not_found',\r\n        title: 'Conversation Not Found',\r\n        status: 404,\r\n        detail: `Conversation with ID ${conversationId} not found`,\r\n      });\r\n    }\r\n\r\n    if (conversation.userId !== userId) {\r\n      throw new ForbiddenException({\r\n        type: 'conversation_access_denied',\r\n        title: 'Access Denied',\r\n        status: 403,\r\n        detail: 'You do not have access to this conversation',\r\n      });\r\n    }\r\n\r\n    const updated = await prisma.conversation.update({\r\n      where: { id: conversationId },\r\n      data: { title },\r\n    });\r\n\r\n    return this.mapConversation(updated);\r\n  }\r\n\r\n  private mapConversation(\r\n    conversation: {\r\n      id: string;\r\n      userId: string;\r\n      title: string | null;\r\n      personaType?: string | null;\r\n      conceptId?: string | null;\r\n      createdAt: Date;\r\n      updatedAt: Date;\r\n    },\r\n    conceptName?: string | null,\r\n    conceptCategory?: string | null\r\n  ): Conversation {\r\n    return {\r\n      id: conversation.id,\r\n      userId: conversation.userId,\r\n      title: conversation.title,\r\n      personaType: (conversation.personaType as PersonaType) ?? null,\r\n      conceptId: conversation.conceptId ?? null,\r\n      conceptName: conceptName ?? null,\r\n      conceptCategory: conceptCategory ?? null,\r\n      createdAt: conversation.createdAt.toISOString(),\r\n      updatedAt: conversation.updatedAt.toISOString(),\r\n    };\r\n  }\r\n\r\n  private mapMessage(message: {\r\n    id: string;\r\n    conversationId: string;\r\n    role: string;\r\n    content: string;\r\n    confidenceScore?: number | null;\r\n    confidenceFactors?: unknown;\r\n    createdAt: Date;\r\n    attachments?: Array<{\r\n      id: string;\r\n      filename: string;\r\n      originalName: string;\r\n      mimeType: string;\r\n      size: number;\r\n      createdAt: Date;\r\n    }>;\r\n  }): Message {\r\n    const mapped: Message = {\r\n      id: message.id,\r\n      conversationId: message.conversationId,\r\n      role: message.role as MessageRole,\r\n      content: message.content,\r\n      confidenceScore: message.confidenceScore ?? null,\r\n      confidenceFactors: (message.confidenceFactors as ConfidenceFactor[]) ?? null,\r\n      createdAt: message.createdAt.toISOString(),\r\n    };\r\n    if (message.attachments && message.attachments.length > 0) {\r\n      mapped.attachments = message.attachments.map((a) => ({\r\n        id: a.id,\r\n        filename: a.filename,\r\n        originalName: a.originalName,\r\n        mimeType: a.mimeType,\r\n        size: a.size,\r\n        createdAt: a.createdAt.toISOString(),\r\n      }));\r\n    }\r\n    return mapped;\r\n  }\r\n\r\n  private mapConversationWithMessages(conversation: {\r\n    id: string;\r\n    userId: string;\r\n    title: string | null;\r\n    personaType?: string | null;\r\n    conceptId?: string | null;\r\n    createdAt: Date;\r\n    updatedAt: Date;\r\n    messages: Array<{\r\n      id: string;\r\n      conversationId: string;\r\n      role: string;\r\n      content: string;\r\n      confidenceScore?: number | null;\r\n      confidenceFactors?: unknown;\r\n      createdAt: Date;\r\n      attachments?: Array<{\r\n        id: string;\r\n        filename: string;\r\n        originalName: string;\r\n        mimeType: string;\r\n        size: number;\r\n        createdAt: Date;\r\n      }>;\r\n    }>;\r\n  }): ConversationWithMessages {\r\n    return {\r\n      ...this.mapConversation(conversation),\r\n      messages: conversation.messages.map((m) => this.mapMessage(m)),\r\n    };\r\n  }\r\n}\r\n","import { IsString, IsOptional, MaxLength, IsIn, Matches } from 'class-validator';\r\nimport { PersonaType } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Valid persona type values for validation.\r\n * Derived from shared PersonaType enum to avoid duplication.\r\n */\r\nconst VALID_PERSONA_TYPES = Object.values(PersonaType) as string[];\r\n\r\n/**\r\n * DTO for creating a new conversation.\r\n */\r\nexport class CreateConversationDto {\r\n  @IsOptional()\r\n  @IsString()\r\n  @MaxLength(255)\r\n  title?: string;\r\n\r\n  @IsOptional()\r\n  @IsIn(VALID_PERSONA_TYPES, {\r\n    message: `Persona type must be one of: ${VALID_PERSONA_TYPES.join(', ')}`,\r\n  })\r\n  personaType?: PersonaType;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  @Matches(/^cpt_/, { message: 'conceptId must have cpt_ prefix' })\r\n  conceptId?: string;\r\n\r\n  @IsOptional()\r\n  @IsString()\r\n  curriculumId?: string;\r\n}\r\n","import { IsIn, IsNotEmpty } from 'class-validator';\r\nimport { PersonaType } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Valid persona type values for validation.\r\n * Derived from shared PersonaType enum to avoid duplication.\r\n */\r\nconst VALID_PERSONA_TYPES = Object.values(PersonaType) as string[];\r\n\r\n/**\r\n * DTO for updating conversation persona.\r\n * Used for PATCH /conversations/:id/persona endpoint.\r\n */\r\nexport class UpdatePersonaDto {\r\n  @IsNotEmpty({ message: 'Persona type is required' })\r\n  @IsIn(VALID_PERSONA_TYPES, {\r\n    message: `Persona type must be one of: ${VALID_PERSONA_TYPES.join(', ')}`,\r\n  })\r\n  personaType!: PersonaType;\r\n}\r\n","import {\r\n  WebSocketGateway,\r\n  WebSocketServer,\r\n  SubscribeMessage,\r\n  OnGatewayConnection,\r\n  OnGatewayDisconnect,\r\n  ConnectedSocket,\r\n  MessageBody,\r\n} from '@nestjs/websockets';\r\nimport { Server, Socket } from 'socket.io';\r\nimport { HttpException, Logger, OnModuleInit, UnauthorizedException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { verify, JwtPayload as JwtPayloadBase } from 'jsonwebtoken';\r\nimport jwksClient from 'jwks-rsa';\r\nimport { ConversationService } from './conversation.service';\r\nimport { AiGatewayService } from '../ai-gateway/ai-gateway.service';\r\nimport { NotesService } from '../notes/notes.service';\r\nimport { ConceptMatchingService } from '../knowledge/services/concept-matching.service';\r\nimport { ConceptService } from '../knowledge/services/concept.service';\r\nimport { CitationInjectorService } from '../knowledge/services/citation-injector.service';\r\nimport { CitationService } from '../knowledge/services/citation.service';\r\nimport { MemoryContextBuilderService } from '../memory/services/memory-context-builder.service';\r\nimport { MemoryExtractionService } from '../memory/services/memory-extraction.service';\r\nimport { MemoryService } from '../memory/services/memory.service';\r\nimport { ConceptExtractionService } from '../knowledge/services/concept-extraction.service';\r\nimport { WorkflowService } from '../workflow/workflow.service';\r\nimport { YoloSchedulerService } from '../workflow/yolo-scheduler.service';\r\nimport { WebSearchService } from '../web-search/web-search.service';\r\nimport { BusinessContextService } from '../knowledge/services/business-context.service';\r\nimport { ExecutionStateService } from '../execution/execution-state.service';\r\nimport { AttachmentsService } from '../attachments/attachments.service';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport { NoteSource, NoteType, NoteStatus } from '@mentor-ai/shared/prisma';\r\nimport { MemoryType, MemorySource, SuggestedAction } from '@mentor-ai/shared/types';\r\nimport {\r\n  MessageRole,\r\n  type ChatMessageSend,\r\n  type ChatMessage,\r\n  type ConceptCitation,\r\n  type ExecutionPlanStep,\r\n  type WorkflowPlanReadyPayload,\r\n  type WorkflowStepProgressPayload,\r\n  type WorkflowCompletePayload,\r\n  type WorkflowConversationsCreatedPayload,\r\n  type WorkflowStepConfirmationPayload,\r\n  type WorkflowStepAwaitingInputPayload,\r\n  type WorkflowStepMessagePayload,\r\n  type WorkflowNavigatePayload,\r\n  type YoloProgressPayload,\r\n  type YoloCompletePayload,\r\n} from '@mentor-ai/shared/types';\r\n\r\ninterface AuthenticatedSocket extends Socket {\r\n  userId: string;\r\n  tenantId: string;\r\n}\r\n\r\ninterface JwtPayload extends JwtPayloadBase {\r\n  sub: string;\r\n  email: string;\r\n  'https://mentor-ai.com/tenant_id'?: string;\r\n  'https://mentor-ai.com/user_id'?: string;\r\n}\r\n\r\n/**\r\n * WebSocket gateway for real-time chat streaming.\r\n * Handles client connections, message sending, and AI response streaming.\r\n * Note: CORS origin is configured dynamically in afterInit using ConfigService.\r\n */\r\n@WebSocketGateway({\r\n  namespace: '/ws/chat',\r\n  cors: {\r\n    origin: true, // Dynamically set in afterInit based on environment\r\n    credentials: true,\r\n  },\r\n})\r\nexport class ConversationGateway implements OnGatewayConnection, OnGatewayDisconnect, OnModuleInit {\r\n  @WebSocketServer()\r\n  server!: Server;\r\n\r\n  private readonly logger = new Logger(ConversationGateway.name);\r\n  private readonly jwksClient: jwksClient.JwksClient;\r\n  private readonly auth0Domain: string;\r\n  private readonly auth0Audience: string;\r\n\r\n  constructor(\r\n    private readonly conversationService: ConversationService,\r\n    private readonly aiGatewayService: AiGatewayService,\r\n    private readonly configService: ConfigService,\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly notesService: NotesService,\r\n    private readonly conceptMatchingService: ConceptMatchingService,\r\n    private readonly citationInjectorService: CitationInjectorService,\r\n    private readonly citationService: CitationService,\r\n    private readonly memoryContextBuilder: MemoryContextBuilderService,\r\n    private readonly memoryExtractionService: MemoryExtractionService,\r\n    private readonly memoryService: MemoryService,\r\n    private readonly workflowService: WorkflowService,\r\n    private readonly conceptService: ConceptService,\r\n    private readonly conceptExtractionService: ConceptExtractionService,\r\n    private readonly yoloScheduler: YoloSchedulerService,\r\n    private readonly webSearchService: WebSearchService,\r\n    private readonly businessContextService: BusinessContextService,\r\n    private readonly executionStateService: ExecutionStateService,\r\n    private readonly attachmentsService: AttachmentsService\r\n  ) {\r\n    this.auth0Domain = this.configService.get<string>('AUTH0_DOMAIN') ?? '';\r\n    this.auth0Audience = this.configService.get<string>('AUTH0_AUDIENCE') ?? '';\r\n\r\n    this.jwksClient = jwksClient({\r\n      cache: true,\r\n      rateLimit: true,\r\n      jwksRequestsPerMinute: 5,\r\n      jwksUri: `https://${this.auth0Domain}/.well-known/jwks.json`,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Server restart recovery: mark stale executions as failed, resume YOLO from checkpoint.\r\n   */\r\n  async onModuleInit(): Promise<void> {\r\n    // Mark stale executions (stuck > 30 min) as failed\r\n    const stale = await this.executionStateService.getStaleExecutions(30);\r\n    for (const exec of stale) {\r\n      await this.executionStateService.updateStatus(\r\n        exec.id,\r\n        'failed',\r\n        null,\r\n        'Server restarted during execution'\r\n      );\r\n      this.logger.warn({\r\n        message: 'Marked stale execution as failed',\r\n        executionId: exec.id,\r\n        type: exec.type,\r\n      });\r\n    }\r\n\r\n    // Find recently active executions (not stale) that can be resumed\r\n    const resumable = await this.executionStateService.getActiveExecutions('*');\r\n    for (const exec of resumable) {\r\n      if (exec.type === 'yolo' || exec.type === 'domain-yolo') {\r\n        this.scheduleYoloResume(exec);\r\n      }\r\n      // Workflows with user-confirmation steps cannot auto-resume\r\n      if (exec.type === 'workflow') {\r\n        await this.executionStateService.updateStatus(\r\n          exec.id,\r\n          'failed',\r\n          null,\r\n          'Server restarted  workflow requires user interaction to resume'\r\n        );\r\n        this.logger.warn({ message: 'Workflow interrupted by restart', executionId: exec.id });\r\n      }\r\n      // Auto-popuni: mark as failed (ephemeral pipeline, not safely resumable)\r\n      if (exec.type === 'auto-popuni') {\r\n        await this.executionStateService.updateStatus(\r\n          exec.id,\r\n          'failed',\r\n          null,\r\n          'Server restarted during auto-popuni'\r\n        );\r\n      }\r\n    }\r\n\r\n    // Daily event journal cleanup\r\n    setInterval(\r\n      () => {\r\n        this.executionStateService\r\n          .pruneOldEvents(7)\r\n          .catch((err) =>\r\n            this.logger.debug({ message: 'Event pruning failed', error: err?.message })\r\n          );\r\n      },\r\n      24 * 60 * 60 * 1000\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Schedule YOLO resume after server restart. Delays 5s to allow full initialization.\r\n   */\r\n  private scheduleYoloResume(exec: {\r\n    id: string;\r\n    tenantId: string;\r\n    userId: string;\r\n    type: string;\r\n    conversationId: string | null;\r\n    metadata: unknown;\r\n    checkpoint: unknown;\r\n  }): void {\r\n    // M4: Runtime metadata validation\r\n    const metadata = exec.metadata;\r\n    if (!metadata || typeof metadata !== 'object') {\r\n      this.executionStateService\r\n        .updateStatus(exec.id, 'failed', null, 'Invalid metadata for resume')\r\n        .catch((err) => this.logger.warn({ message: 'Status update failed', error: err?.message }));\r\n      this.logger.warn({\r\n        message: 'YOLO resume skipped  invalid metadata',\r\n        executionId: exec.id,\r\n        metadata: JSON.stringify(metadata),\r\n      });\r\n      return;\r\n    }\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = metadata as { config?: any; category?: string };\r\n    const checkpoint = (exec.checkpoint ?? {}) as { completedCount?: number };\r\n\r\n    if (!meta.config || !exec.conversationId) {\r\n      this.executionStateService\r\n        .updateStatus(exec.id, 'failed', null, 'Insufficient metadata for resume')\r\n        .catch((err) => this.logger.warn({ message: 'Status update failed', error: err?.message }));\r\n      return;\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Scheduling YOLO resume after server restart',\r\n      executionId: exec.id,\r\n      type: exec.type,\r\n      completedSoFar: checkpoint.completedCount ?? 0,\r\n    });\r\n\r\n    // M3: Mark as 'pending' while waiting for resume to prevent duplicate scheduling\r\n    this.executionStateService\r\n      .updateStatus(exec.id, 'pending')\r\n      .catch((err) =>\r\n        this.logger.warn({\r\n          message: 'Failed to mark execution as pending for resume',\r\n          error: err?.message,\r\n        })\r\n      );\r\n\r\n    // Delay to let server fully initialize (WebSocket server, DB pool, etc.)\r\n    setTimeout(() => {\r\n      // Re-mark as executing before starting\r\n      this.executionStateService\r\n        .updateStatus(exec.id, 'executing')\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        .then(() => this.resumeYoloExecution(exec as any))\r\n        .catch((err) => {\r\n          this.logger.error({\r\n            message: 'YOLO resume failed',\r\n            executionId: exec.id,\r\n            error: err?.message,\r\n          });\r\n          this.executionStateService\r\n            .updateStatus(exec.id, 'failed', null, err?.message ?? 'Resume failed')\r\n            .catch((e) => this.logger.warn({ message: 'Status update failed', error: e?.message }));\r\n        });\r\n    }, 5000);\r\n  }\r\n\r\n  /**\r\n   * Resume a YOLO execution from checkpoint after server restart.\r\n   * Leverages the fact that completed tasks are already COMPLETED in DB \r\n   * the scheduler naturally picks up only PENDING tasks.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  private async resumeYoloExecution(exec: {\r\n    id: string;\r\n    tenantId: string;\r\n    userId: string;\r\n    type: string;\r\n    conversationId: string;\r\n    metadata: any;\r\n  }): Promise<void> {\r\n    const tenantId = exec.tenantId;\r\n    const userId = exec.userId;\r\n    const conversationId = exec.conversationId;\r\n    const executionId = exec.id;\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const metadata = exec.metadata as { config?: any; category?: string };\r\n    const config = metadata.config;\r\n    const category = metadata.category;\r\n    const conceptConversations = new Map<string, string>();\r\n\r\n    this.logger.log({ message: 'Resuming YOLO execution', executionId, tenantId });\r\n\r\n    await this.yoloScheduler.startYoloExecution(\r\n      tenantId,\r\n      userId,\r\n      conversationId,\r\n      config,\r\n      {\r\n        onProgress: (progress: YoloProgressPayload) => {\r\n          this.emitToTenant(tenantId, executionId, 'workflow:yolo-progress', progress);\r\n          this.executionStateService\r\n            .updateCheckpoint(executionId, progress)\r\n            .catch((err) =>\r\n              this.logger.debug({ message: 'Checkpoint update failed', error: err?.message })\r\n            );\r\n        },\r\n        onComplete: (result: YoloCompletePayload) => {\r\n          this.emitToTenant(tenantId, executionId, 'workflow:yolo-complete', result);\r\n          this.emitToTenant(tenantId, executionId, 'chat:notes-updated', {\r\n            conversationId,\r\n            count: 0,\r\n          });\r\n          this.executionStateService\r\n            .updateStatus(executionId, 'completed', result)\r\n            .catch((err) =>\r\n              this.logger.debug({ message: 'Execution status update failed', error: err?.message })\r\n            );\r\n        },\r\n        onError: (error: string) => {\r\n          this.emitToTenant(tenantId, executionId, 'workflow:error', {\r\n            message: error,\r\n            conversationId,\r\n          });\r\n          this.executionStateService\r\n            .updateStatus(executionId, 'failed', null, error)\r\n            .catch((err) =>\r\n              this.logger.debug({ message: 'Execution status update failed', error: err?.message })\r\n            );\r\n        },\r\n        saveMessage: async (_role: string, content: string, conceptId?: string) => {\r\n          const targetConvId =\r\n            conceptId && conceptConversations.has(conceptId)\r\n              ? conceptConversations.get(conceptId)!\r\n              : conversationId;\r\n          const msg = await this.conversationService.addMessage(\r\n            tenantId,\r\n            targetConvId,\r\n            MessageRole.ASSISTANT,\r\n            content\r\n          );\r\n          return msg.id;\r\n        },\r\n        createConversationForConcept: async (conceptId: string, conceptName: string) => {\r\n          try {\r\n            const conv = await this.conversationService.createConversation(\r\n              tenantId,\r\n              userId,\r\n              conceptName,\r\n              undefined,\r\n              conceptId\r\n            );\r\n            conceptConversations.set(conceptId, conv.id);\r\n            this.emitToTenant(tenantId, executionId, 'workflow:conversations-created', {\r\n              planId: 'yolo-resume',\r\n              conversations: [{ conceptId, conceptName, conversationId: conv.id }],\r\n              originalConversationId: conversationId,\r\n            });\r\n            return conv.id;\r\n          } catch (err) {\r\n            this.logger.warn({\r\n              message: 'Failed to create conversation during YOLO resume',\r\n              conceptId,\r\n              error: err instanceof Error ? err.message : 'Unknown',\r\n            });\r\n            return null;\r\n          }\r\n        },\r\n        onConceptDiscovered: (\r\n          conceptId: string,\r\n          conceptName: string,\r\n          discoveredConversationId: string\r\n        ) => {\r\n          this.emitToTenant(tenantId, executionId, 'chat:concept-detected', {\r\n            conversationId,\r\n            conceptId,\r\n            conceptName,\r\n            discoveredConversationId,\r\n          });\r\n        },\r\n      },\r\n      conceptConversations,\r\n      category\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Broadcast an event to all connected sockets belonging to a tenant.\r\n   * Also journals the event for replay on reconnect.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  private emitToTenant(\r\n    tenantId: string,\r\n    executionId: string,\r\n    eventName: string,\r\n    payload: any\r\n  ): void {\r\n    // Journal the event for replay\r\n    this.executionStateService\r\n      .appendEvent(executionId, eventName, payload)\r\n      .catch((err) =>\r\n        this.logger.debug({ message: 'Event journaling failed', error: err?.message })\r\n      );\r\n\r\n    // Broadcast to all sockets in this tenant's room\r\n    if (this.server) {\r\n      this.server.to(`tenant:${tenantId}`).emit(eventName, payload);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns active executions and recently completed ones for reconnecting clients.\r\n   */\r\n  @SubscribeMessage('execution:get-active')\r\n  async handleGetActiveExecutions(@ConnectedSocket() client: Socket): Promise<void> {\r\n    const auth = client as AuthenticatedSocket;\r\n\r\n    const active = await this.executionStateService.getActiveExecutions(auth.tenantId);\r\n    const recentlyCompleted = await this.executionStateService.getRecentCompletions(\r\n      auth.tenantId,\r\n      new Date(Date.now() - 5 * 60 * 1000) // last 5 minutes\r\n    );\r\n\r\n    client.emit('execution:active-state', {\r\n      active: active.map((e) => ({\r\n        id: e.id,\r\n        type: e.type,\r\n        status: e.status,\r\n        planId: e.planId,\r\n        conversationId: e.conversationId,\r\n        checkpoint: e.checkpoint,\r\n        metadata: e.metadata,\r\n        createdAt: e.createdAt,\r\n      })),\r\n      recentlyCompleted: recentlyCompleted.map((e) => ({\r\n        id: e.id,\r\n        type: e.type,\r\n        result: e.result,\r\n        conversationId: e.conversationId,\r\n        updatedAt: e.updatedAt,\r\n      })),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Replays journaled events for an execution since a given timestamp.\r\n   * Used after reconnect to catch up on missed events.\r\n   */\r\n  @SubscribeMessage('execution:replay-events')\r\n  async handleReplayEvents(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { executionId: string; since?: string }\r\n  ): Promise<void> {\r\n    const since = payload.since ? new Date(payload.since) : new Date(0);\r\n    const events = await this.executionStateService.getEventsSince(payload.executionId, since);\r\n\r\n    for (const event of events) {\r\n      client.emit(event.eventName, event.payload);\r\n    }\r\n    client.emit('execution:replay-complete', {\r\n      executionId: payload.executionId,\r\n      eventCount: events.length,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handles new WebSocket connections.\r\n   * Validates JWT token and attaches user info to socket.\r\n   * In dev mode, bypasses token validation and uses mock user.\r\n   */\r\n  async handleConnection(client: Socket) {\r\n    try {\r\n      const devMode = this.configService.get<string>('DEV_MODE') === 'true';\r\n\r\n      if (devMode) {\r\n        const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n        // Try to extract real user identity from JWT token and verify the user exists in DB\r\n        const token = this.extractToken(client);\r\n        if (token && token !== 'dev-mode-token') {\r\n          try {\r\n            const jwtSecret = this.configService.get<string>('JWT_SECRET');\r\n            if (jwtSecret) {\r\n              const payload = verify(token, jwtSecret, { algorithms: ['HS256'] }) as JwtPayload;\r\n              const tokenUserId = (payload as any).userId || payload.sub || 'dev-user-001';\r\n              const tokenTenantId = (payload as any).tenantId || 'dev-tenant-001';\r\n\r\n              // Verify the user actually exists in DB (may have been cleaned up)\r\n              const userExists = await this.prisma.user.findUnique({\r\n                where: { id: tokenUserId },\r\n                select: { id: true },\r\n              });\r\n\r\n              if (userExists) {\r\n                authenticatedClient.userId = tokenUserId;\r\n                authenticatedClient.tenantId = tokenTenantId;\r\n                await client.join(`tenant:${authenticatedClient.tenantId}`);\r\n                this.logger.log({\r\n                  message: 'WebSocket client connected (dev mode, real user)',\r\n                  clientId: client.id,\r\n                  userId: authenticatedClient.userId,\r\n                  tenantId: authenticatedClient.tenantId,\r\n                });\r\n                return;\r\n              }\r\n\r\n              // User deleted from DB  disconnect so frontend clears stale token\r\n              this.logger.warn({\r\n                message: 'WebSocket rejected: JWT user not found in DB',\r\n                tokenUserId,\r\n              });\r\n              client.emit('auth:session-expired', {\r\n                message: 'Your session is no longer valid. Please log in again.',\r\n              });\r\n              client.disconnect();\r\n              return;\r\n            }\r\n          } catch {\r\n            this.logger.debug('Dev mode: WebSocket JWT validation failed, using dev user fallback');\r\n          }\r\n        }\r\n\r\n        // No token or placeholder token  use dev fallback\r\n        authenticatedClient.userId = 'dev-user-001';\r\n        authenticatedClient.tenantId = 'dev-tenant-001';\r\n        await client.join('tenant:dev-tenant-001');\r\n        this.logger.log({\r\n          message: 'WebSocket client connected (dev mode, dev user)',\r\n          clientId: client.id,\r\n        });\r\n        return;\r\n      }\r\n\r\n      const token = this.extractToken(client);\r\n      if (!token) {\r\n        this.logger.warn({\r\n          message: 'WebSocket connection rejected: No token provided',\r\n          clientId: client.id,\r\n        });\r\n        client.disconnect();\r\n        return;\r\n      }\r\n\r\n      const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n      // Try JWT_SECRET (HS256) verification first  covers Google OAuth tokens\r\n      const jwtSecret = this.configService.get<string>('JWT_SECRET');\r\n      let authenticated = false;\r\n\r\n      if (jwtSecret) {\r\n        try {\r\n          const payload = verify(token, jwtSecret, { algorithms: ['HS256'] }) as JwtPayload;\r\n          const tokenUserId = (payload as any).userId || payload.sub;\r\n          const tokenTenantId = (payload as any).tenantId || '';\r\n\r\n          if (tokenUserId) {\r\n            // Verify the user actually exists in DB\r\n            const userExists = await this.prisma.user.findUnique({\r\n              where: { id: tokenUserId },\r\n              select: { id: true },\r\n            });\r\n\r\n            if (userExists) {\r\n              authenticatedClient.userId = tokenUserId;\r\n              authenticatedClient.tenantId = tokenTenantId;\r\n              authenticated = true;\r\n            } else {\r\n              this.logger.warn({\r\n                message: 'WebSocket rejected: JWT user not found in DB',\r\n                tokenUserId,\r\n              });\r\n              client.emit('auth:session-expired', {\r\n                message: 'Your session is no longer valid. Please log in again.',\r\n              });\r\n              client.disconnect();\r\n              return;\r\n            }\r\n          }\r\n        } catch {\r\n          // HS256 verification failed  try Auth0 JWKS fallback below\r\n        }\r\n      }\r\n\r\n      // Fallback: Auth0 JWKS (RS256) verification if configured\r\n      if (!authenticated && this.auth0Domain) {\r\n        try {\r\n          const payload = await this.verifyToken(token);\r\n          authenticatedClient.userId = payload['https://mentor-ai.com/user_id'] ?? payload.sub;\r\n          authenticatedClient.tenantId = payload['https://mentor-ai.com/tenant_id'] ?? '';\r\n          authenticated = true;\r\n        } catch {\r\n          // Auth0 verification also failed\r\n        }\r\n      }\r\n\r\n      if (!authenticated) {\r\n        this.logger.warn({\r\n          message: 'WebSocket connection rejected: Invalid token',\r\n          clientId: client.id,\r\n        });\r\n        client.disconnect();\r\n        return;\r\n      }\r\n\r\n      // Join tenant-specific room for isolation\r\n      await client.join(`tenant:${authenticatedClient.tenantId}`);\r\n\r\n      this.logger.log({\r\n        message: 'WebSocket client connected',\r\n        clientId: client.id,\r\n        userId: authenticatedClient.userId,\r\n        tenantId: authenticatedClient.tenantId,\r\n      });\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'WebSocket connection rejected: Invalid token',\r\n        clientId: client.id,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.disconnect();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles WebSocket disconnections.\r\n   */\r\n  handleDisconnect(client: Socket) {\r\n    this.logger.log({\r\n      message: 'WebSocket client disconnected',\r\n      clientId: client.id,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handles incoming chat messages.\r\n   * Saves user message, streams AI response, and saves AI message.\r\n   */\r\n  @SubscribeMessage('chat:message-send')\r\n  async handleMessage(@ConnectedSocket() client: Socket, @MessageBody() payload: ChatMessageSend & { attachmentIds?: string[] }) {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n    const { conversationId, content, attachmentIds: rawAttachmentIds } = payload;\r\n\r\n    // Validate and sanitize attachmentIds\r\n    const attachmentIds: string[] | undefined =\r\n      Array.isArray(rawAttachmentIds) &&\r\n      rawAttachmentIds.length > 0 &&\r\n      rawAttachmentIds.length <= 5 &&\r\n      rawAttachmentIds.every((id) => typeof id === 'string' && id.length > 0 && id.length < 50)\r\n        ? rawAttachmentIds\r\n        : undefined;\r\n\r\n    // Validate payload\r\n    if (!conversationId || !content) {\r\n      client.emit('chat:error', {\r\n        type: 'invalid_payload',\r\n        message: 'conversationId and content are required',\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Validate conversationId format\r\n    if (!conversationId.startsWith('sess_')) {\r\n      client.emit('chat:error', {\r\n        type: 'invalid_conversation_id',\r\n        message: 'conversationId must have sess_ prefix',\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Validate content length\r\n    const MAX_MESSAGE_LENGTH = 32000;\r\n    if (content.length > MAX_MESSAGE_LENGTH) {\r\n      client.emit('chat:error', {\r\n        type: 'message_too_long',\r\n        message: `Message cannot exceed ${MAX_MESSAGE_LENGTH} characters`,\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Verify user owns the conversation\r\n      await this.conversationService.getConversation(\r\n        authenticatedClient.tenantId,\r\n        conversationId,\r\n        authenticatedClient.userId\r\n      );\r\n\r\n      // Extract text from attachments if provided\r\n      let attachmentContext = '';\r\n      if (attachmentIds && attachmentIds.length > 0) {\r\n        attachmentContext = await this.attachmentsService\r\n          .getExtractedText(attachmentIds, authenticatedClient.tenantId)\r\n          .catch(() => '');\r\n      }\r\n\r\n      // Save user message\r\n      const userMessage = await this.conversationService.addMessage(\r\n        authenticatedClient.tenantId,\r\n        conversationId,\r\n        MessageRole.USER,\r\n        content\r\n      );\r\n\r\n      // Link attachments to the saved message\r\n      if (attachmentIds && attachmentIds.length > 0) {\r\n        await Promise.all(\r\n          attachmentIds.map((attId) =>\r\n            this.attachmentsService\r\n              .linkToMessage(attId, userMessage.id, authenticatedClient.tenantId)\r\n              .catch((err) => {\r\n                this.logger.warn(`Failed to link attachment ${attId}: ${err}`);\r\n              }),\r\n          ),\r\n        );\r\n      }\r\n\r\n      // Emit confirmation of user message received\r\n      client.emit('chat:message-received', {\r\n        messageId: userMessage.id,\r\n        role: 'USER',\r\n      });\r\n\r\n      // Get conversation history for context\r\n      const conversation = await this.conversationService.getConversation(\r\n        authenticatedClient.tenantId,\r\n        conversationId,\r\n        authenticatedClient.userId\r\n      );\r\n\r\n      // Format messages for AI (inject attachment context into last user message)\r\n      const messages = conversation.messages.map((m, i, arr) => {\r\n        const isLastUserMsg = i === arr.length - 1 && m.role.toLowerCase() === 'user';\r\n        const msgContent =\r\n          isLastUserMsg && attachmentContext\r\n            ? `${attachmentContext}\\n\\n${m.content}`\r\n            : m.content;\r\n        return {\r\n          role: m.role.toLowerCase() as 'user' | 'assistant',\r\n          content: msgContent,\r\n        };\r\n      });\r\n\r\n      // Build business context from tenant profile + onboarding notes\r\n      const businessContext = await this.buildBusinessContext(\r\n        authenticatedClient.tenantId,\r\n        authenticatedClient.userId\r\n      );\r\n\r\n      // Pre-AI enrichment: concept search + memory context + web search + business brain context in parallel\r\n      const webSearchEnabled = (payload as any).webSearchEnabled !== false;\r\n      const [relevantConcepts, memoryContext, webSearchResults, businessBrainContext] =\r\n        await Promise.all([\r\n          this.conceptMatchingService\r\n            .findRelevantConcepts(content, {\r\n              limit: 5,\r\n              threshold: 0.5,\r\n              personaType: conversation.personaType ?? undefined,\r\n            })\r\n            .catch(() => [] as import('@mentor-ai/shared/types').ConceptMatch[]),\r\n          this.memoryContextBuilder\r\n            .buildContext(content, authenticatedClient.userId, authenticatedClient.tenantId)\r\n            .catch(() => ({\r\n              context: '',\r\n              attributions: [] as import('@mentor-ai/shared/types').MemoryAttribution[],\r\n              estimatedTokens: 0,\r\n            })),\r\n          webSearchEnabled && this.webSearchService.isAvailable()\r\n            ? this.webSearchService\r\n                .searchAndExtract(content, 3)\r\n                .catch(() => [] as import('@mentor-ai/shared/types').EnrichedSearchResult[])\r\n            : Promise.resolve([] as import('@mentor-ai/shared/types').EnrichedSearchResult[]),\r\n          this.businessContextService\r\n            .getBusinessContext(authenticatedClient.tenantId)\r\n            .catch(() => ''),\r\n        ]);\r\n\r\n      // Build enriched context with curriculum concepts + memory + business brain\r\n      let enrichedContext = businessContext;\r\n\r\n      // Append tenant-wide business brain memories (Story 3.3 AC3)\r\n      if (businessBrainContext) {\r\n        enrichedContext += '\\n' + businessBrainContext;\r\n      }\r\n\r\n      if (relevantConcepts.length > 0) {\r\n        enrichedContext += '\\n\\n--- BAZA ZNANJA (koristi za analizu i preporuke) ---\\n';\r\n        for (const concept of relevantConcepts.slice(0, 5)) {\r\n          enrichedContext += `\\nKONCEPT: ${concept.conceptName} (${concept.category})`;\r\n          enrichedContext += `\\nDEFINICIJA: ${concept.definition}`;\r\n          try {\r\n            const full = await this.conceptService.findById(concept.conceptId);\r\n            if (full.extendedDescription) {\r\n              enrichedContext += `\\nDETALJNO: ${full.extendedDescription}`;\r\n            }\r\n            if (full.relatedConcepts && full.relatedConcepts.length > 0) {\r\n              const related = full.relatedConcepts\r\n                .slice(0, 3)\r\n                .map((r) => `${r.concept.name} (${r.relationshipType})`)\r\n                .join(', ');\r\n              enrichedContext += `\\nPOVEZANI: ${related}`;\r\n            }\r\n          } catch {\r\n            /* skip if concept not found */\r\n          }\r\n          enrichedContext += '\\n';\r\n        }\r\n        enrichedContext += '--- KRAJ BAZE ZNANJA ---\\n';\r\n        enrichedContext +=\r\n          'Primeni ove koncepte u odgovoru. Kada referencira koncept, koristi [[Naziv Koncepta]] oznaku.\\n';\r\n      }\r\n\r\n      if (memoryContext.context) {\r\n        enrichedContext = this.memoryContextBuilder.injectIntoSystemPrompt(\r\n          enrichedContext,\r\n          memoryContext\r\n        );\r\n      }\r\n\r\n      // Append web search context if results available (Story 2.17)\r\n      if (webSearchResults.length > 0) {\r\n        enrichedContext += this.webSearchService.formatSourcesAsObsidian(webSearchResults);\r\n      }\r\n\r\n      // === MULTI-STEP ORCHESTRATION ===\r\n      const isComplex = this.isComplexQuery(content);\r\n      let researchBrief = '';\r\n\r\n      if (isComplex) {\r\n        client.emit('chat:research-phase', { phase: 'researching' });\r\n        researchBrief = await this.buildResearchBrief(\r\n          content,\r\n          enrichedContext,\r\n          relevantConcepts,\r\n          webSearchEnabled,\r\n          conversation.personaType ?? undefined,\r\n          authenticatedClient.tenantId,\r\n          authenticatedClient.userId\r\n        );\r\n        client.emit('chat:research-phase', { phase: 'responding' });\r\n      }\r\n\r\n      const finalContext = researchBrief\r\n        ? `${enrichedContext}\\n\\n--- ISTRAIVAKI BRIEF ---\\n${researchBrief}\\n--- KRAJ BRIEFA ---\\nKoristi brief kao osnovu za struan odgovor. Ne pominjaj brief  samo daj sveobuhvatan odgovor.`\r\n        : enrichedContext;\r\n\r\n      // Stream AI response with confidence calculation (Story 2.5)\r\n      let fullContent = '';\r\n      let chunkIndex = 0;\r\n\r\n      const completionResult = await this.aiGatewayService.streamCompletionWithContext(\r\n        messages,\r\n        {\r\n          tenantId: authenticatedClient.tenantId,\r\n          userId: authenticatedClient.userId,\r\n          conversationId,\r\n          personaType: conversation.personaType ?? undefined,\r\n          messageCount: conversation.messages.length,\r\n          hasClientContext: memoryContext.attributions.length > 0,\r\n          hasSpecificData: relevantConcepts.length > 0 || researchBrief.length > 0,\r\n          userQuestion: content,\r\n          businessContext: finalContext,\r\n        },\r\n        (chunk: string) => {\r\n          fullContent += chunk;\r\n          client.emit('chat:message-chunk', {\r\n            content: chunk,\r\n            index: chunkIndex++,\r\n          });\r\n        }\r\n      );\r\n\r\n      // Extract confidence from result\r\n      const confidence = completionResult.confidence;\r\n\r\n      // Post-AI: inject citation markers into response\r\n      let contentWithCitations = fullContent;\r\n      let citations: ConceptCitation[] = [];\r\n\r\n      if (relevantConcepts.length > 0) {\r\n        const citationResult = this.citationInjectorService.injectCitations(\r\n          fullContent,\r\n          relevantConcepts\r\n        );\r\n        contentWithCitations = citationResult.content;\r\n        citations = citationResult.citations;\r\n      }\r\n\r\n      // Parse memory attributions from the AI response\r\n      const memoryAttributions =\r\n        memoryContext.attributions.length > 0\r\n          ? this.memoryContextBuilder.parseAttributionsFromResponse(\r\n              fullContent,\r\n              memoryContext.attributions\r\n            )\r\n          : [];\r\n\r\n      // Save AI message with citations in content (Story 2.5 + 2.6)\r\n      const aiMessage = await this.conversationService.addMessage(\r\n        authenticatedClient.tenantId,\r\n        conversationId,\r\n        MessageRole.ASSISTANT,\r\n        contentWithCitations,\r\n        confidence?.score ?? null,\r\n        confidence?.factors ?? null\r\n      );\r\n\r\n      // Store citations in DB (fire-and-forget)\r\n      if (citations.length > 0) {\r\n        this.citationService.storeCitations(aiMessage.id, citations).catch((err) => {\r\n          this.logger.warn({\r\n            message: 'Failed to store citations (non-blocking)',\r\n            conversationId,\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n        });\r\n      }\r\n\r\n      // Infer suggested actions based on response context (D1)\r\n      const suggestedActions: SuggestedAction[] = [];\r\n      if (relevantConcepts.length > 0) {\r\n        suggestedActions.push(\r\n          { type: 'create_tasks', label: 'Kreiraj zadatke', icon: 'tasks' },\r\n          { type: 'deep_dive', label: 'Istrai dublje', icon: 'explore' }\r\n        );\r\n        if (relevantConcepts.length > 1) {\r\n          suggestedActions.push({\r\n            type: 'next_domain',\r\n            label: 'Sledei koncept ',\r\n            icon: 'arrow',\r\n            payload: { conceptId: relevantConcepts[1]?.conceptId },\r\n          });\r\n        }\r\n      } else {\r\n        suggestedActions.push({ type: 'save_note', label: 'Sauvaj kao beleku', icon: 'note' });\r\n      }\r\n      if (confidence && confidence.score < 0.5) {\r\n        suggestedActions.push({ type: 'web_search', label: 'Pretrai web', icon: 'web' });\r\n      }\r\n\r\n      // Emit completion with confidence + citations metadata\r\n      client.emit('chat:complete', {\r\n        messageId: aiMessage.id,\r\n        fullContent: contentWithCitations,\r\n        metadata: {\r\n          totalChunks: chunkIndex,\r\n          confidence: confidence\r\n            ? {\r\n                score: confidence.score,\r\n                level: confidence.level,\r\n                factors: confidence.factors,\r\n              }\r\n            : null,\r\n          citations,\r\n          memoryAttributions,\r\n          webSearchSources:\r\n            webSearchResults.length > 0\r\n              ? webSearchResults.map((r) => ({ title: r.title, link: r.link }))\r\n              : undefined,\r\n          suggestedActions: suggestedActions.length > 0 ? suggestedActions : undefined,\r\n        },\r\n      });\r\n\r\n      this.logger.log({\r\n        message: 'Chat message processed',\r\n        conversationId,\r\n        userId: authenticatedClient.userId,\r\n        tenantId: authenticatedClient.tenantId,\r\n        userMessageId: userMessage.id,\r\n        aiMessageId: aiMessage.id,\r\n        confidenceScore: confidence?.score ?? 'N/A',\r\n        confidenceLevel: confidence?.level ?? 'N/A',\r\n        citationCount: citations.length,\r\n        conceptsFound: relevantConcepts.length,\r\n        memoriesUsed: memoryContext.attributions.length,\r\n      });\r\n\r\n      // Fire-and-forget: detect explicit task creation or auto-generate tasks\r\n      const forceRedo = this.hasRedoIntent(content);\r\n      if (this.hasExplicitTaskIntent(content)) {\r\n        this.detectAndCreateExplicitTasks(\r\n          client,\r\n          authenticatedClient.userId,\r\n          authenticatedClient.tenantId,\r\n          conversationId,\r\n          conversation.conceptId ?? null,\r\n          content,\r\n          fullContent,\r\n          relevantConcepts,\r\n          forceRedo\r\n        ).catch((err: unknown) => {\r\n          this.logger.warn({\r\n            message: 'Explicit task creation failed (non-blocking)',\r\n            conversationId,\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n        });\r\n      } else {\r\n        this.generateAutoTasks(\r\n          client,\r\n          authenticatedClient.userId,\r\n          authenticatedClient.tenantId,\r\n          conversationId,\r\n          conversation.conceptId ?? null,\r\n          content,\r\n          fullContent,\r\n          messages,\r\n          aiMessage.id,\r\n          relevantConcepts,\r\n          forceRedo\r\n        ).catch((err: unknown) => {\r\n          this.logger.warn({\r\n            message: 'Auto-task generation failed (non-blocking)',\r\n            conversationId,\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n        });\r\n      }\r\n\r\n      // Fire-and-forget: auto-classify conversation to a curriculum concept\r\n      this.autoClassifyConversation(\r\n        client,\r\n        authenticatedClient.tenantId,\r\n        authenticatedClient.userId,\r\n        conversationId,\r\n        content,\r\n        fullContent\r\n      ).catch((err: unknown) => {\r\n        this.logger.warn({\r\n          message: 'Auto-classify failed (non-blocking)',\r\n          conversationId,\r\n          error: err instanceof Error ? err.message : 'Unknown error',\r\n        });\r\n      });\r\n\r\n      // Fire-and-forget: extract memories from this exchange (Story 3.3: concept-tagging)\r\n      const conceptName = conversation.conceptId\r\n        ? (relevantConcepts.find((c) => c.conceptId === conversation.conceptId)?.conceptName ??\r\n          (await this.conceptService.findById(conversation.conceptId).catch(() => null))?.name)\r\n        : undefined;\r\n\r\n      this.memoryExtractionService\r\n        .extractMemories(\r\n          conversation.messages.concat([\r\n            {\r\n              id: userMessage.id,\r\n              conversationId,\r\n              role: MessageRole.USER,\r\n              content,\r\n              confidenceScore: null,\r\n              confidenceFactors: null,\r\n              createdAt: new Date().toISOString(),\r\n            },\r\n            {\r\n              id: aiMessage.id,\r\n              conversationId,\r\n              role: MessageRole.ASSISTANT,\r\n              content: fullContent,\r\n              confidenceScore: null,\r\n              confidenceFactors: null,\r\n              createdAt: new Date().toISOString(),\r\n            },\r\n          ]),\r\n          authenticatedClient.userId,\r\n          authenticatedClient.tenantId,\r\n          { conceptName }\r\n        )\r\n        .catch((err: unknown) => {\r\n          this.logger.warn({\r\n            message: 'Memory extraction failed (non-blocking)',\r\n            conversationId,\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n        });\r\n\r\n      // Fire-and-forget: extract and create new concepts from AI output (Story 2.15)\r\n      // Deviation: uses .catch() instead of async/await per project-context.md rule\r\n      // \"Always use async/await over raw Promises\". Rationale: concept extraction is\r\n      // optional post-processing; failure must not block message delivery (AC6).\r\n      this.conceptExtractionService\r\n        .extractAndCreateConcepts(fullContent, {\r\n          conversationId,\r\n          conceptId: conversation.conceptId ?? undefined,\r\n        })\r\n        .catch((err: unknown) => {\r\n          this.logger.warn({\r\n            message: 'Concept extraction failed (non-blocking)',\r\n            conversationId,\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n        });\r\n\r\n      // Auto-detect affirmative or selective task execution on welcome conversation\r\n      if (conversation.messages.length <= 4) {\r\n        const lowerContent = content.toLowerCase().trim();\r\n        const affirmatives = [\r\n          'da',\r\n          'yes',\r\n          'izvri',\r\n          'izvrsi',\r\n          'hajde',\r\n          'naravno',\r\n          'svakako',\r\n          'pokreni sve',\r\n        ];\r\n        const isFullAffirmative = affirmatives.some(\r\n          (p) =>\r\n            lowerContent === p ||\r\n            lowerContent.startsWith(p + ' ') ||\r\n            lowerContent.startsWith(p + ',')\r\n        );\r\n\r\n        // Detect selective execution: \"pokreni 1, 3, 5\" or \"pokreni prvi\"\r\n        const numberMatch = lowerContent.match(/(?:pokreni|izvri|izvrsi|run|start)\\s+([\\d,\\s]+)/);\r\n        const isFirstOnly = /(?:pokreni|izvri|izvrsi)\\s+(?:prvi|first|1)$/i.test(lowerContent);\r\n\r\n        const pendingTasks = await this.notesService.getPendingTasksByUser(\r\n          authenticatedClient.userId,\r\n          authenticatedClient.tenantId\r\n        );\r\n\r\n        if (pendingTasks.length > 0) {\r\n          let taskIds: string[];\r\n\r\n          if (isFirstOnly) {\r\n            // Run only the first (recommended) task\r\n            taskIds = [pendingTasks[0]!.id];\r\n          } else if (numberMatch) {\r\n            // Parse selected task numbers: \"pokreni 1, 3, 5\"\r\n            const selectedNumbers = numberMatch[1]!\r\n              .split(/[,\\s]+/)\r\n              .map((n) => parseInt(n.trim(), 10))\r\n              .filter((n) => !isNaN(n) && n >= 1 && n <= pendingTasks.length);\r\n            taskIds = selectedNumbers.map((n) => pendingTasks[n - 1]!.id);\r\n          } else if (isFullAffirmative) {\r\n            // Run all tasks\r\n            taskIds = pendingTasks.map((t) => t.id);\r\n          } else {\r\n            taskIds = [];\r\n          }\r\n\r\n          if (taskIds.length > 0) {\r\n            // Auto-execute: skip plan overlay, build + execute immediately\r\n            this.autoExecuteWorkflow(client, taskIds, conversationId).catch((err: unknown) => {\r\n              this.logger.error({\r\n                message: 'Auto-execute workflow failed',\r\n                error: err instanceof Error ? err.message : 'Unknown error',\r\n              });\r\n              client.emit('workflow:error', {\r\n                message: err instanceof Error ? err.message : 'Automatsko izvravanje nije uspelo',\r\n                conversationId,\r\n              });\r\n            });\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // Extract meaningful error details from HttpException or plain Error\r\n      let errorType = 'processing_error';\r\n      let errorMessage = 'Failed to process message';\r\n\r\n      if (error instanceof HttpException) {\r\n        const response = error.getResponse();\r\n        if (typeof response === 'object' && response !== null) {\r\n          const resp = response as Record<string, unknown>;\r\n          errorType = (resp['type'] as string) ?? errorType;\r\n          errorMessage = (resp['detail'] as string) ?? (resp['message'] as string) ?? error.message;\r\n        } else {\r\n          errorMessage = error.message;\r\n        }\r\n      } else if (error instanceof Error) {\r\n        errorMessage = error.message;\r\n      }\r\n\r\n      this.logger.error({\r\n        message: 'Failed to process chat message',\r\n        conversationId,\r\n        userId: authenticatedClient.userId,\r\n        errorType,\r\n        error: errorMessage,\r\n      });\r\n\r\n      client.emit('chat:error', {\r\n        type: errorType,\r\n        message: errorMessage,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Post-processing: generates auto-tasks from the conversation using a separate LLM call.\r\n   * Runs as fire-and-forget so it doesn't block the chat response.\r\n   */\r\n  private async generateAutoTasks(\r\n    client: Socket,\r\n    userId: string,\r\n    tenantId: string,\r\n    conversationId: string,\r\n    conceptId: string | null,\r\n    userMessage: string,\r\n    aiResponse: string,\r\n    conversationHistory: ChatMessage[],\r\n    messageId: string,\r\n    relevantConcepts?: import('@mentor-ai/shared/types').ConceptMatch[],\r\n    forceRedo = false\r\n  ): Promise<void> {\r\n    // Only generate tasks every 2nd AI response to avoid excessive LLM calls\r\n    const messageCount = conversationHistory.length;\r\n    if (messageCount < 2) return; // Need at least 1 exchange\r\n\r\n    // Load tenant for business-specific context\r\n    let tenantName = 'klijent';\r\n    let tenantIndustry = 'opta';\r\n    try {\r\n      const tenant = await this.prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        select: { name: true, industry: true },\r\n      });\r\n      if (tenant?.name) tenantName = tenant.name;\r\n      if (tenant?.industry) tenantIndustry = tenant.industry;\r\n    } catch {\r\n      /* non-blocking */\r\n    }\r\n\r\n    // Build concept context\r\n    let conceptHint = '';\r\n    if (relevantConcepts && relevantConcepts.length > 0) {\r\n      conceptHint =\r\n        '\\nPovezani koncepti: ' +\r\n        relevantConcepts\r\n          .slice(0, 3)\r\n          .map((c) => c.conceptName)\r\n          .join(', ');\r\n    }\r\n\r\n    const taskSystemPrompt = `Ti si poslovni asistent za \"${tenantName}\" (${tenantIndustry}).\r\nIz konverzacije izvuci 1-3 konkretna, izvriva zadatka. Fokusiraj se na praktine sledee korake koje korisnik moe preduzeti.${conceptHint}\r\n\r\nPRAVILA:\r\n- \"title\": akcioni naslov na srpskom, max 80 karaktera (npr. \"Analizirajte mesene trokove marketinga\")\r\n- \"content\": konkretan opis ta treba uraditi, zato, i koji je oekivani rezultat (150-400 karaktera)\r\n- Zadaci moraju biti SPECIFINI za \"${tenantName}\"  ne generiki poslovni saveti\r\n- Samo izvrive stavke  ne opte observacije\r\n- Ako nema smislenih zadataka, vrati prazan niz\r\n- Pii ISKLJUIVO na srpskom jeziku`;\r\n\r\n    const taskUserPrompt = `KORISNIK: ${userMessage}\r\n\r\nAI ODGOVOR: ${aiResponse.length > 2000 ? aiResponse.substring(0, 2000) + '...' : aiResponse}\r\n\r\nOdgovori SAMO sa validnim JSON nizom: [{\"title\":\"...\",\"content\":\"...\"}]\r\nAko nema zadataka: []`;\r\n\r\n    try {\r\n      let taskResponseContent = '';\r\n      await this.aiGatewayService.streamCompletionWithContext(\r\n        [\r\n          { role: 'system', content: taskSystemPrompt },\r\n          { role: 'user', content: taskUserPrompt },\r\n        ],\r\n        {\r\n          tenantId,\r\n          userId,\r\n          skipRateLimit: true,\r\n          skipQuotaCheck: true,\r\n        },\r\n        (chunk: string) => {\r\n          taskResponseContent += chunk;\r\n        }\r\n      );\r\n\r\n      // Parse the JSON response\r\n      const cleanedContent = taskResponseContent\r\n        .replace(/```(?:json)?\\s*/gi, '')\r\n        .replace(/```/g, '')\r\n        .trim();\r\n      const jsonMatch = cleanedContent.match(/\\[[\\s\\S]*\\]/);\r\n      if (!jsonMatch) {\r\n        this.logger.debug({\r\n          message: 'No JSON array found in task generation response',\r\n          conversationId,\r\n        });\r\n        return;\r\n      }\r\n\r\n      const tasks = JSON.parse(jsonMatch[0]) as Array<{ title: string; content: string }>;\r\n      if (!Array.isArray(tasks) || tasks.length === 0) return;\r\n\r\n      // Create notes for each task (max 3)\r\n      const effectiveConceptId = conceptId ?? relevantConcepts?.[0]?.conceptId ?? undefined;\r\n      const tasksToCreate = tasks.slice(0, 3);\r\n\r\n      // Tenant-wide dedup (Story 3.4 AC3)\r\n      let createdCount = 0;\r\n      let reusedCount = 0;\r\n      for (const task of tasksToCreate) {\r\n        if (!task.title) continue;\r\n        const existingId = await this.notesService.findExistingTask(tenantId, {\r\n          conceptId: effectiveConceptId,\r\n          title: task.title,\r\n        });\r\n        if (existingId) {\r\n          this.logger.debug({\r\n            message: 'Skipping duplicate auto-task',\r\n            title: task.title,\r\n            existingId,\r\n            tenantId,\r\n          });\r\n          continue;\r\n        }\r\n\r\n        // Prior work reuse for auto-tasks\r\n        if (!forceRedo && effectiveConceptId) {\r\n          const reusable = await this.notesService.findReusableTask(tenantId, effectiveConceptId);\r\n          if (reusable) {\r\n            await this.notesService.createNote({\r\n              title: task.title,\r\n              content: reusable.content,\r\n              source: NoteSource.CONVERSATION,\r\n              noteType: NoteType.TASK,\r\n              status: NoteStatus.COMPLETED,\r\n              conversationId,\r\n              conceptId: effectiveConceptId,\r\n              messageId,\r\n              userId,\r\n              tenantId,\r\n              reusedFromNoteId: reusable.id,\r\n              userReport: reusable.userReport,\r\n              aiScore: reusable.aiScore,\r\n              aiFeedback: reusable.aiFeedback ?? undefined,\r\n            });\r\n            reusedCount++;\r\n            this.logger.log({\r\n              message: 'Reused prior work for auto-task',\r\n              title: task.title,\r\n              reusedFrom: reusable.id,\r\n              score: reusable.aiScore,\r\n            });\r\n            continue;\r\n          }\r\n        }\r\n\r\n        await this.notesService.createNote({\r\n          title: task.title,\r\n          content:\r\n            typeof task.content === 'object'\r\n              ? JSON.stringify(task.content, null, 2)\r\n              : (task.content ?? ''),\r\n          source: NoteSource.CONVERSATION,\r\n          noteType: NoteType.TASK,\r\n          status: NoteStatus.PENDING,\r\n          conversationId,\r\n          conceptId: effectiveConceptId,\r\n          messageId,\r\n          userId,\r\n          tenantId,\r\n        });\r\n        createdCount++;\r\n      }\r\n\r\n      if (createdCount === 0 && reusedCount === 0) return;\r\n\r\n      // Notify frontend that new notes are available\r\n      client.emit('chat:notes-updated', { conversationId, count: createdCount + reusedCount });\r\n\r\n      this.logger.log({\r\n        message: 'Auto-tasks generated',\r\n        conversationId,\r\n        freshCount: createdCount,\r\n        reusedCount,\r\n      });\r\n    } catch (error: unknown) {\r\n      this.logger.warn({\r\n        message: 'Failed to generate auto-tasks',\r\n        conversationId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Post-processing: auto-classifies a conversation to a curriculum concept\r\n   * using semantic similarity search. Runs fire-and-forget.\r\n   */\r\n  private async autoClassifyConversation(\r\n    client: Socket,\r\n    tenantId: string,\r\n    userId: string,\r\n    conversationId: string,\r\n    userMessage: string,\r\n    aiResponse: string\r\n  ): Promise<void> {\r\n    // Check if conversation already has a concept assigned\r\n    const conv = await this.conversationService.getConversation(tenantId, conversationId, userId);\r\n    if (conv.conceptId) return;\r\n\r\n    // Use semantic search to find best matching concept\r\n    const matches = await this.conceptMatchingService.findRelevantConcepts(\r\n      `${userMessage}\\n${aiResponse}`,\r\n      { limit: 1, threshold: 0.75 }\r\n    );\r\n\r\n    const topMatch = matches[0];\r\n    if (topMatch) {\r\n      await this.conversationService.updateConceptId(\r\n        tenantId,\r\n        conversationId,\r\n        userId,\r\n        topMatch.conceptId\r\n      );\r\n\r\n      // Retroactively link existing tasks that had no concept\r\n      await this.notesService\r\n        .updateConceptIdForConversation(conversationId, topMatch.conceptId, tenantId)\r\n        .catch(() => {\r\n          /* ignore  best-effort linkage */\r\n        });\r\n\r\n      client.emit('chat:concept-detected', {\r\n        conversationId,\r\n        conceptId: topMatch.conceptId,\r\n        conceptName: topMatch.conceptName,\r\n      });\r\n\r\n      this.logger.log({\r\n        message: 'Conversation auto-classified',\r\n        conversationId,\r\n        conceptId: topMatch.conceptId,\r\n        conceptName: topMatch.conceptName,\r\n        score: topMatch.score,\r\n      });\r\n    }\r\n  }\r\n\r\n  //  Complex Query Detection (Multi-Step Orchestration) \r\n\r\n  private isComplexQuery(content: string): boolean {\r\n    const lower = content.toLowerCase().trim();\r\n\r\n    // Skip short messages (greetings, yes/no)\r\n    if (lower.length < 15) return false;\r\n\r\n    // Skip simple patterns\r\n    if (\r\n      /^(ta je|to je|what is|objasni|explain|zdravo|hej|ao|hi|hello|da|ne|ok|vai|hvala)\\b/.test(\r\n        lower\r\n      )\r\n    )\r\n      return false;\r\n\r\n    // Complex intent verbs (Serbian + English)\r\n    const complexVerbs =\r\n      /\\b(analiziraj|analizuj|uporedi|poredi|istrai|istrauj|razvij|razradi|predloi|predlozi|osmisli|isplaniraj|planiraj|dizajniraj|optimizuj|proceni|evaluate|analyze|compare|research|develop|plan|design|optimize|assess|benchmark|strategij)/;\r\n\r\n    // Complex intent nouns signaling depth\r\n    const complexNouns =\r\n      /\\b(strategij|analiz|konkurencij|trit|market|poslovni model|finansijsk|budet|budget|roi|plan rasta|growth|scaling|skaliranj|optimizacij|swot|pest|porter|canvas|due diligence|rizik|pricing|cenovna|revenue|prihod|forecast|prognoz|roadmap)/;\r\n\r\n    // Multi-clause (comma + action verb = multiple asks)\r\n    const multiClause = /,\\s*(i\\s+)?(predloi|analiziraj|napravi|razvij|osmisli|kreiraj)/.test(\r\n      lower\r\n    );\r\n\r\n    return complexVerbs.test(lower) || complexNouns.test(lower) || multiClause;\r\n  }\r\n\r\n  //  Explicit Task Creation \r\n\r\n  private hasRedoIntent(content: string): boolean {\r\n    const lower = content.toLowerCase();\r\n    return /\\b(ponovo|iznova|opet|redo|ponoviti|again|refresh|auriraj|azuriraj|osvezi|osvei)\\b/.test(lower);\r\n  }\r\n\r\n  private hasExplicitTaskIntent(userMessage: string): boolean {\r\n    const lowerMsg = userMessage.toLowerCase();\r\n\r\n    // Action verbs (Serbian + English)  \\b only at start so \"kreirajte\" matches \"kreiraj\" prefix\r\n    const actionVerbs =\r\n      /\\b(kreiraj|napravi|generii|generisi|dodaj|create|make|add|generate|osmisli|predloi|predlozi|definii|definisi|razradi|isplaniraj|planiraj|odredi|postavi|sastavi|pripremi)/;\r\n    // Task nouns  NO trailing \\b so Serbian inflected roots match: \"zadat\"  \"zadatke\", \"akcij\"  \"akcije\"\r\n    const taskNouns =\r\n      /\\b(tasks?|zadat|plan|workflow|korak|koraci|akcij|to-?do|stavk|cilj|strategi|aktivnost|raspored|checklis|list)/;\r\n\r\n    // Match if message contains both an action verb and a task noun (in any order)\r\n    return actionVerbs.test(lowerMsg) && taskNouns.test(lowerMsg);\r\n  }\r\n\r\n  private async detectAndCreateExplicitTasks(\r\n    client: Socket,\r\n    userId: string,\r\n    tenantId: string,\r\n    conversationId: string,\r\n    conceptId: string | null,\r\n    userMessage: string,\r\n    aiResponse: string,\r\n    relevantConcepts?: import('@mentor-ai/shared/types').ConceptMatch[],\r\n    forceRedo = false\r\n  ): Promise<void> {\r\n    this.logger.log({\r\n      message: 'Explicit task creation intent detected',\r\n      conversationId,\r\n      userId,\r\n    });\r\n\r\n    // Load business context for task personalization\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true, industry: true, description: true },\r\n    });\r\n\r\n    // Load recent conversation history for full context\r\n    let conversationContext = '';\r\n    try {\r\n      const recentMessages = await this.prisma.message.findMany({\r\n        where: { conversationId },\r\n        orderBy: { createdAt: 'desc' },\r\n        take: 10,\r\n        select: { role: true, content: true },\r\n      });\r\n      if (recentMessages.length > 0) {\r\n        conversationContext = '\\n\\nISTORIJA KONVERZACIJE (kontekst iz kojeg nastaju zadaci):\\n';\r\n        for (const msg of recentMessages.reverse()) {\r\n          const role = msg.role === 'USER' ? 'KORISNIK' : 'AI';\r\n          const content =\r\n            msg.content.length > 800 ? msg.content.substring(0, 800) + '...' : msg.content;\r\n          conversationContext += `${role}: ${content}\\n`;\r\n        }\r\n      }\r\n    } catch {\r\n      /* non-blocking */\r\n    }\r\n\r\n    // Build concept context from matched concepts\r\n    let conceptContext = '';\r\n    if (relevantConcepts && relevantConcepts.length > 0) {\r\n      conceptContext = '\\n\\nPOVEZANI POSLOVNI KONCEPTI:\\n';\r\n      for (const c of relevantConcepts.slice(0, 5)) {\r\n        conceptContext += `- ${c.conceptName} (${c.category}): ${c.definition}\\n`;\r\n      }\r\n    }\r\n\r\n    // LLM extraction with full context\r\n    const extractSystemPrompt = `Ti si poslovni konsultant koji kreira konkretne, izvrive zadatke za kompaniju \"${tenant?.name ?? 'klijent'}\" u industriji \"${tenant?.industry ?? 'opta'}\".\r\n${tenant?.description ? `Opis kompanije: ${tenant.description}` : ''}\r\n\r\nTvoj posao: Na osnovu onoga to je korisnik TRAIO i ta je AI ODGOVORIO, ekstrahuj konkretne poslovne zadatke.\r\n\r\nPRAVILA ZA SVAKI ZADATAK:\r\n1. \"title\"  akcioni naslov na srpskom (glagol + radnja, max 80 karaktera): \"Analizirajte...\", \"Kreirajte...\", \"Definiite...\"\r\n2. \"content\"  strukturiran opis sa:\r\n   - Cilj: ta konkretno treba postii (1-2 reenice)\r\n   - Kontekst: zato je ovo vano za poslovanje (1-2 reenice)\r\n   - Koraci: 3-5 konkretnih koraka za realizaciju\r\n   - Oekivani rezultat: merljiv ishod ili deliverable\r\n3. \"conceptMatch\"  ako zadatak odgovara nekom od POVEZANIH POSLOVNIH KONCEPATA, navedi naziv koncepta (taan match)\r\n\r\nKRITINO:\r\n- Zadaci MORAJU biti direktno povezani sa onim to je korisnik TRAIO u konverzaciji\r\n- Svaki zadatak mora biti SPECIFIAN za \"${tenant?.name ?? 'ovu kompaniju'}\"  ne generiki\r\n- Izdvoji samo izvrive stavke  ne opte observacije ili savete\r\n- Minimum 3, maksimum 8 zadataka\r\n- Pii ISKLJUIVO na srpskom jeziku`;\r\n\r\n    const extractUserPrompt = `KORISNIKOV ZAHTEV:\r\n${userMessage}\r\n\r\nAI ODGOVOR:\r\n${aiResponse}${conversationContext}${conceptContext}\r\n\r\nOdgovori SAMO sa validnim JSON nizom:\r\n[{\"title\":\"...\",\"content\":\"...\",\"conceptMatch\":\"naziv koncepta ili null\"}]`;\r\n\r\n    try {\r\n      let extractedContent = '';\r\n      await this.aiGatewayService.streamCompletionWithContext(\r\n        [\r\n          { role: 'system', content: extractSystemPrompt },\r\n          { role: 'user', content: extractUserPrompt },\r\n        ],\r\n        { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true },\r\n        (chunk: string) => {\r\n          extractedContent += chunk;\r\n        }\r\n      );\r\n\r\n      // Strip markdown code block wrappers\r\n      const cleanedContent = extractedContent\r\n        .replace(/```(?:json)?\\s*/gi, '')\r\n        .replace(/```/g, '')\r\n        .trim();\r\n\r\n      const jsonMatch = cleanedContent.match(/\\[[\\s\\S]*\\]/);\r\n      if (!jsonMatch) {\r\n        this.logger.warn({\r\n          message: 'No JSON array in explicit task extraction',\r\n          conversationId,\r\n          extractedContent: extractedContent.substring(0, 500),\r\n        });\r\n        return;\r\n      }\r\n\r\n      const tasks = JSON.parse(jsonMatch[0]) as Array<{\r\n        title: string;\r\n        content: string;\r\n        conceptMatch?: string | null;\r\n      }>;\r\n      if (!Array.isArray(tasks) || tasks.length === 0) return;\r\n\r\n      // Build concept name  ID map for matching\r\n      const conceptNameMap = new Map<string, string>();\r\n      if (relevantConcepts) {\r\n        for (const c of relevantConcepts) {\r\n          conceptNameMap.set(c.conceptName.toLowerCase(), c.conceptId);\r\n        }\r\n      }\r\n\r\n      // Create task notes in DB (with duplicate prevention + prior work reuse)\r\n      const fallbackConceptId = conceptId ?? relevantConcepts?.[0]?.conceptId ?? undefined;\r\n      const createdTasks: Array<{\r\n        id: string;\r\n        title: string;\r\n        conceptId: string | null;\r\n        conversationId: string;\r\n      }> = [];\r\n      const reusedTasks: Array<{\r\n        id: string;\r\n        title: string;\r\n        conceptId: string | null;\r\n        conversationId: string;\r\n      }> = [];\r\n\r\n      for (const task of tasks.slice(0, 10)) {\r\n        if (!task.title) continue;\r\n\r\n        // Resolve concept: LLM-matched concept name  ID, or fallback\r\n        let taskConceptId = fallbackConceptId;\r\n        if (task.conceptMatch) {\r\n          const matchedId = conceptNameMap.get(task.conceptMatch.toLowerCase());\r\n          if (matchedId) taskConceptId = matchedId;\r\n        }\r\n\r\n        // Tenant-wide dedup (Story 3.4 AC3)\r\n        const existingId = await this.notesService.findExistingTask(tenantId, {\r\n          conceptId: taskConceptId,\r\n          title: task.title,\r\n        });\r\n        if (existingId) {\r\n          this.logger.debug({\r\n            message: 'Skipping duplicate explicit task',\r\n            title: task.title,\r\n            existingId,\r\n            tenantId,\r\n          });\r\n          continue;\r\n        }\r\n\r\n        // Prior work reuse: check for high-quality completed task on same concept\r\n        if (!forceRedo && taskConceptId) {\r\n          const reusable = await this.notesService.findReusableTask(tenantId, taskConceptId);\r\n          if (reusable) {\r\n            const result = await this.notesService.createNote({\r\n              title: task.title,\r\n              content: reusable.content,\r\n              source: NoteSource.CONVERSATION,\r\n              noteType: NoteType.TASK,\r\n              status: NoteStatus.COMPLETED,\r\n              conversationId,\r\n              conceptId: taskConceptId,\r\n              userId,\r\n              tenantId,\r\n              reusedFromNoteId: reusable.id,\r\n              userReport: reusable.userReport,\r\n              aiScore: reusable.aiScore,\r\n              aiFeedback: reusable.aiFeedback ?? undefined,\r\n            });\r\n            reusedTasks.push({\r\n              id: result.id,\r\n              title: task.title,\r\n              conceptId: taskConceptId ?? null,\r\n              conversationId,\r\n            });\r\n            this.logger.log({\r\n              message: 'Reused prior work for task',\r\n              title: task.title,\r\n              reusedFrom: reusable.id,\r\n              score: reusable.aiScore,\r\n              tenantId,\r\n            });\r\n            continue;\r\n          }\r\n        }\r\n\r\n        const result = await this.notesService.createNote({\r\n          title: task.title,\r\n          content:\r\n            typeof task.content === 'object'\r\n              ? JSON.stringify(task.content, null, 2)\r\n              : (task.content ?? ''),\r\n          source: NoteSource.CONVERSATION,\r\n          noteType: NoteType.TASK,\r\n          status: NoteStatus.PENDING,\r\n          conversationId,\r\n          conceptId: taskConceptId,\r\n          userId,\r\n          tenantId,\r\n        });\r\n        createdTasks.push({\r\n          id: result.id,\r\n          title: task.title,\r\n          conceptId: taskConceptId ?? null,\r\n          conversationId,\r\n        });\r\n      }\r\n\r\n      const totalCreated = createdTasks.length + reusedTasks.length;\r\n      if (totalCreated === 0) return;\r\n\r\n      // Emit event so frontend shows tasks with execute option\r\n      // reusedTaskIds tells frontend to skip auto-execution for these\r\n      client.emit('chat:tasks-created-for-execution', {\r\n        conversationId,\r\n        taskIds: createdTasks.map((t) => t.id),\r\n        reusedTaskIds: reusedTasks.map((t) => t.id),\r\n        taskCount: totalCreated,\r\n      });\r\n\r\n      // Also notify notes updated\r\n      client.emit('chat:notes-updated', { conversationId, count: totalCreated });\r\n\r\n      this.logger.log({\r\n        message: 'Explicit tasks created',\r\n        conversationId,\r\n        freshCount: createdTasks.length,\r\n        reusedCount: reusedTasks.length,\r\n        conceptsLinked: createdTasks.filter((t) => t.conceptId !== null).length,\r\n      });\r\n\r\n      // Auto AI Popuni is now triggered from frontend when toggle is ON\r\n      // (frontend receives 'chat:tasks-created-for-execution' and auto-emits 'task:execute-ai')\r\n    } catch (error: unknown) {\r\n      this.logger.warn({\r\n        message: 'Failed to create explicit tasks',\r\n        conversationId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Auto AI Popuni pipeline: checks tenant config, then for each task:\r\n   * 1. Execute AI (same as handleExecuteTaskAi)\r\n   * 2. Copy aiResult to userReport, mark COMPLETED\r\n   * 3. Score the result (same as handleSubmitTaskResult)\r\n   * Emits the same events so frontend picks up progress transparently.\r\n   */\r\n  private async triggerAutoAiPopuni(\r\n    client: Socket,\r\n    tenantId: string,\r\n    userId: string,\r\n    tasks: Array<{ id: string; title: string; conceptId: string | null; conversationId: string }>,\r\n    originConversationId?: string\r\n  ): Promise<void> {\r\n    // Check if auto AI popuni is enabled for this tenant\r\n    let tenant: { autoAiPopuni: boolean } | null;\r\n    try {\r\n      tenant = await this.prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        select: { autoAiPopuni: true },\r\n      });\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Auto AI Popuni: tenant lookup failed',\r\n        tenantId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      return;\r\n    }\r\n    if (!tenant?.autoAiPopuni) return;\r\n\r\n    this.logger.log({\r\n      message: 'Auto AI Popuni enabled  starting pipeline',\r\n      tenantId,\r\n      taskCount: tasks.length,\r\n    });\r\n\r\n    // Create execution record for persistence\r\n    const executionId = await this.executionStateService.createExecution(\r\n      tenantId,\r\n      userId,\r\n      'auto-popuni',\r\n      undefined,\r\n      originConversationId,\r\n      { taskIds: tasks.map((t) => t.id) }\r\n    );\r\n\r\n    // Emit event so frontend knows auto-popuni is starting\r\n    this.emitToTenant(tenantId, executionId, 'auto-popuni:start', {\r\n      taskIds: tasks.map((t) => t.id),\r\n      taskCount: tasks.length,\r\n    });\r\n\r\n    // Process tasks sequentially (max 1 at a time to avoid LLM overload)\r\n    let completedCount = 0;\r\n    const completedTaskIds: string[] = [];\r\n    for (const task of tasks) {\r\n      try {\r\n        await this.autoPopuniSingleTask(client, tenantId, userId, task, originConversationId);\r\n        completedCount++;\r\n        completedTaskIds.push(task.id);\r\n        this.executionStateService\r\n          .updateCheckpoint(executionId, { completedTaskIds, completedCount })\r\n          .catch((err) =>\r\n            this.logger.debug({ message: 'Checkpoint update failed', error: err?.message })\r\n          );\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Auto AI Popuni failed for task',\r\n          taskId: task.id,\r\n          taskTitle: task.title,\r\n          error: err instanceof Error ? err.message : 'Unknown error',\r\n        });\r\n        this.emitToTenant(tenantId, executionId, 'auto-popuni:task-error', {\r\n          taskId: task.id,\r\n          message: 'Automatsko popunjavanje nije uspelo',\r\n        });\r\n      }\r\n    }\r\n\r\n    this.emitToTenant(tenantId, executionId, 'auto-popuni:complete', {\r\n      totalTasks: tasks.length,\r\n      completedTasks: completedCount,\r\n    });\r\n\r\n    this.executionStateService\r\n      .updateStatus(executionId, 'completed', {\r\n        totalTasks: tasks.length,\r\n        completedTasks: completedCount,\r\n      })\r\n      .catch((err) =>\r\n        this.logger.debug({ message: 'Execution status update failed', error: err?.message })\r\n      );\r\n\r\n    this.logger.log({\r\n      message: 'Auto AI Popuni pipeline finished',\r\n      tenantId,\r\n      totalTasks: tasks.length,\r\n      completedTasks: completedCount,\r\n    });\r\n\r\n    // TODO(H4): After auto-popuni completes tasks, traverse concept_relationships\r\n    // to spawn new PENDING tasks for ADVANCED/related concepts. This would close\r\n    // the autonomous growth loop (Business Brain architecture). Requires:\r\n    // 1. Query concept_relationships for outgoing edges from completed concepts\r\n    // 2. Create PENDING tasks for connected concepts that don't already have tasks\r\n    // 3. Depth limit to prevent infinite auto-popuni  spawn  auto-popuni loops\r\n    // 4. Must NOT re-trigger triggerAutoAiPopuni on spawned tasks (break recursion)\r\n  }\r\n\r\n  /**\r\n   * Auto-popuni for a single task:\r\n   * 1. AI executes the task (stream to client)\r\n   * 2. Mark as COMPLETED with userReport\r\n   * 3. Score the result (stream to client)\r\n   */\r\n  private async autoPopuniSingleTask(\r\n    client: Socket,\r\n    tenantId: string,\r\n    userId: string,\r\n    task: { id: string; title: string; conceptId: string | null; conversationId: string },\r\n    _originConversationId?: string\r\n  ): Promise<void> {\r\n    const convId = task.conversationId;\r\n\r\n    //  Phase 1: Generate workflow + execute steps \r\n    client.emit('task:ai-start', {\r\n      taskId: task.id,\r\n      conversationId: convId,\r\n      timestamp: new Date().toISOString(),\r\n      auto: true,\r\n    });\r\n\r\n    const businessContext = await this.buildBusinessContext(tenantId, userId);\r\n\r\n    // Load task details\r\n    const taskNote = await this.prisma.note.findUnique({ where: { id: task.id } });\r\n    if (!taskNote) return;\r\n\r\n    // Check if this task already has children (workflow steps)\r\n    let childNotes = await this.prisma.note.findMany({\r\n      where: { parentNoteId: task.id },\r\n      select: { title: true, content: true, workflowStepNumber: true, status: true },\r\n      orderBy: { workflowStepNumber: 'asc' },\r\n    });\r\n\r\n    // Generate and execute workflow if no children exist\r\n    if (childNotes.length === 0) {\r\n      try {\r\n        client.emit('task:ai-workflow-start', {\r\n          taskId: task.id,\r\n          conversationId: convId,\r\n          message: 'Generiem plan izvravanja...',\r\n          auto: true,\r\n        });\r\n\r\n        // Choose workflow type: concept-based for concept-linked tasks with minimal content\r\n        const isMinimalContent = !taskNote.content || taskNote.content.length < 200;\r\n        const hasConcept = !!taskNote.conceptId;\r\n\r\n        let workflow: {\r\n          conceptName: string;\r\n          steps: import('@mentor-ai/shared/types').WorkflowStep[];\r\n        };\r\n        if (hasConcept && isMinimalContent) {\r\n          workflow = await this.workflowService.getOrGenerateWorkflow(\r\n            taskNote.conceptId!,\r\n            tenantId,\r\n            userId\r\n          );\r\n        } else {\r\n          workflow = await this.workflowService.generateTaskSpecificWorkflow(\r\n            {\r\n              title: taskNote.title,\r\n              content: taskNote.content ?? '',\r\n              conversationId: convId ?? null,\r\n              conceptId: taskNote.conceptId,\r\n            },\r\n            tenantId,\r\n            userId\r\n          );\r\n        }\r\n\r\n        this.logger.log({\r\n          message: 'Auto-popuni: workflow generated for task',\r\n          taskId: task.id,\r\n          taskTitle: taskNote.title,\r\n          stepCount: workflow.steps.length,\r\n          workflowType: hasConcept && isMinimalContent ? 'concept-based' : 'task-specific',\r\n        });\r\n\r\n        const completedSummaries: Array<{ title: string; conceptName: string; summary: string }> =\r\n          [];\r\n\r\n        for (let stepIdx = 0; stepIdx < workflow.steps.length; stepIdx++) {\r\n          const workflowStep = workflow.steps[stepIdx]!;\r\n\r\n          client.emit('task:ai-step-progress', {\r\n            taskId: task.id,\r\n            conversationId: convId,\r\n            stepIndex: stepIdx,\r\n            totalSteps: workflow.steps.length,\r\n            stepTitle: workflowStep.title,\r\n            auto: true,\r\n          });\r\n\r\n          const step: ExecutionPlanStep = {\r\n            stepId: `auto_step_${createId()}`,\r\n            conceptId: taskNote.conceptId ?? '',\r\n            conceptName: workflow.conceptName,\r\n            workflowStepNumber: workflowStep.stepNumber,\r\n            title: workflowStep.title,\r\n            description: workflowStep.description,\r\n            estimatedMinutes: workflowStep.estimatedMinutes,\r\n            departmentTag: workflowStep.departmentTag,\r\n            status: 'in_progress',\r\n            taskTitle: taskNote.title,\r\n            taskContent: taskNote.content ?? undefined,\r\n            taskConversationId: convId ?? undefined,\r\n          };\r\n\r\n          const result = await this.workflowService.executeStepAutonomous(\r\n            step,\r\n            convId ?? '',\r\n            userId,\r\n            tenantId,\r\n            () => {\r\n              /* auto-popuni: collect silently */\r\n            },\r\n            completedSummaries\r\n          );\r\n\r\n          // Dedup: check if child note already exists\r\n          const existingSubTask = await this.notesService.findExistingSubTask(\r\n            tenantId,\r\n            task.id,\r\n            workflowStep.stepNumber\r\n          );\r\n\r\n          if (!existingSubTask) {\r\n            await this.notesService.createNote({\r\n              title: workflowStep.title,\r\n              content: result.content,\r\n              source: NoteSource.CONVERSATION,\r\n              noteType: NoteType.TASK,\r\n              status: NoteStatus.READY_FOR_REVIEW,\r\n              userId,\r\n              tenantId,\r\n              conversationId: convId ?? undefined,\r\n              conceptId: taskNote.conceptId ?? undefined,\r\n              parentNoteId: task.id,\r\n              expectedOutcome: workflowStep.expectedOutcome?.substring(0, 500),\r\n              workflowStepNumber: workflowStep.stepNumber,\r\n            });\r\n          }\r\n\r\n          completedSummaries.push({\r\n            title: workflowStep.title,\r\n            conceptName: workflow.conceptName,\r\n            summary: result.content.substring(0, 500),\r\n          });\r\n\r\n          client.emit('task:ai-step-complete', {\r\n            taskId: task.id,\r\n            conversationId: convId,\r\n            stepIndex: stepIdx,\r\n            totalSteps: workflow.steps.length,\r\n            stepTitle: workflowStep.title,\r\n            auto: true,\r\n          });\r\n        }\r\n\r\n        // Re-load children\r\n        childNotes = await this.prisma.note.findMany({\r\n          where: { parentNoteId: task.id },\r\n          select: { title: true, content: true, workflowStepNumber: true, status: true },\r\n          orderBy: { workflowStepNumber: 'asc' },\r\n        });\r\n\r\n        this.logger.log({\r\n          message: 'Auto-popuni: workflow steps completed, proceeding to synthesis',\r\n          taskId: task.id,\r\n          childCount: childNotes.length,\r\n        });\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Auto-popuni: workflow generation failed, falling back to direct execution',\r\n          taskId: task.id,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    //  Phase 2: Synthesis \r\n    // Load concept knowledge for synthesis prompt\r\n    let conceptKnowledge = '';\r\n    if (taskNote.conceptId) {\r\n      try {\r\n        const concept = await this.conceptService.findById(taskNote.conceptId);\r\n        conceptKnowledge = `\\n\\n--- BAZA ZNANJA ---`;\r\n        conceptKnowledge += `\\nKONCEPT: ${concept.name} (${concept.category})`;\r\n        conceptKnowledge += `\\nDEFINICIJA: ${concept.definition}`;\r\n        if (concept.extendedDescription) {\r\n          conceptKnowledge += `\\nDETALJNO: ${concept.extendedDescription}`;\r\n        }\r\n        if (concept.relatedConcepts && concept.relatedConcepts.length > 0) {\r\n          const related = concept.relatedConcepts\r\n            .slice(0, 5)\r\n            .map((r) => `${r.concept.name} (${r.relationshipType})`)\r\n            .join(', ');\r\n          conceptKnowledge += `\\nPOVEZANI KONCEPTI: ${related}`;\r\n        }\r\n        conceptKnowledge += '\\n--- KRAJ BAZE ZNANJA ---';\r\n      } catch {\r\n        /* concept not found */\r\n      }\r\n    }\r\n\r\n    // Web search for synthesis enrichment\r\n    let webContext = '';\r\n    if (this.webSearchService.isAvailable()) {\r\n      try {\r\n        const tenant = await this.prisma.tenant.findUnique({\r\n          where: { id: tenantId },\r\n          select: { name: true, industry: true },\r\n        });\r\n        const searchQuery = `${taskNote.title} ${tenant?.industry ?? ''} ${new Date().getFullYear()}`;\r\n        const webResults = await this.webSearchService.searchAndExtract(searchQuery, 3);\r\n        if (webResults.length > 0) {\r\n          webContext = this.webSearchService.formatSourcesAsObsidian(webResults);\r\n        }\r\n      } catch {\r\n        /* non-blocking */\r\n      }\r\n    }\r\n\r\n    let prompt: string;\r\n\r\n    if (childNotes.length > 0) {\r\n      // Synthesis from workflow step outputs\r\n      const workflowResults = childNotes\r\n        .map((note, i) => {\r\n          const stepNum = note.workflowStepNumber ?? i + 1;\r\n          return `--- KORAK ${stepNum}: ${note.title} ---\\n${note.content}`;\r\n        })\r\n        .join('\\n\\n');\r\n\r\n      prompt = `Ti si vrhunski poslovni strunjak. Tvoj tim je zavrio detaljnu analizu kroz ${childNotes.length} koraka workflow-a. Sintetii SVE rezultate u FINALNI DOKUMENT koji vlasnik moe odmah koristiti.\r\n\r\nZADATAK: ${taskNote.title}\r\n${taskNote.content ? `OPIS ZADATKA: ${taskNote.content}` : ''}\r\n${taskNote.expectedOutcome ? `OEKIVANI REZULTAT: ${taskNote.expectedOutcome}` : ''}\r\n\r\nREZULTATI ISTRAIVANJA I ANALIZE (koristi SVE podatke iz svih koraka):\r\n${workflowResults}\r\n${conceptKnowledge}${webContext}\r\n\r\nKRITINO  RAZLIKUJ DVA TIPA ZADATAKA:\r\n\r\nA) DIGITALNI ZADACI (sadraj, planovi, kampanje, mejlovi, strategije, analize, dokumenti, budeti, prezentacije):\r\n    PROIZVEDI GOTOV REZULTAT. Ne pii instrukcije  NAPII sam dokument/sadraj/plan.\r\n    Primer: ako je zadatak \"Napiite marketing email\"  NAPII ceo email sa subject linijom, telom, CTA\r\n    Primer: ako je zadatak \"Kreirajte content calendar\"  NAPRAVI kompletan kalendar sa datumima, temama, platformama\r\n\r\nB) FIZIKI ZADACI (odlazak u prodavnicu, naruivanje, pozivanje klijenta, fizika instalacija):\r\n    NE simuliraj da si uradio fiziku radnju. NE pii \"Naruio sam...\" ili \"Obavio sam poziv...\"\r\n    UMESTO TOGA: napii TANO ta treba uraditi, ko treba da uradi, sa svim detaljima\r\n    Oznai sa \" ZAHTEVA LJUDSKU AKCIJU:\"\r\n\r\nPRAVILA ZA FINALNI DOKUMENT:\r\n1. Ovo je FINALNI DELIVERABLE  gotov dokument, NE izvetaj o radu\r\n2. Sintetii rezultate iz koraka u koherentan, upotrebljiv dokument\r\n3. NIKADA ne pii \"trebalo bi da...\", \"preporuuje se...\" za digitalne zadatke  URADI to\r\n4. Koristi SPECIFINE podatke, brojke i nalaze iz koraka  ne generalizuj\r\n5. Strukturiraj sa ## zaglavljima, tabelama, nabrajanjima\r\n6. Dodaj sekciju \"Sledei koraci\" sa konkretnim akcijama koje zahtevaju LJUDSKU INTERVENCIJU\r\n7. NIKADA ne pii \"u prethodnim koracima smo...\"  PRIKAI gotov rezultat\r\n8. Ako ima web izvore, citiraj INLINE: ([Naziv](URL))\r\n9. Minimum 1000 rei  ovo je sveobuhvatan dokument\r\n10. Odgovaraj ISKLJUIVO na srpskom jeziku.`;\r\n    } else {\r\n      // Fallback: direct execution (no workflow steps available)\r\n      let conversationContext = '';\r\n      try {\r\n        const conv = await this.conversationService.getConversation(tenantId, convId, userId);\r\n        const recentMessages = conv.messages.slice(-10);\r\n        conversationContext = recentMessages\r\n          .map((m) => {\r\n            const role = m.role === 'USER' ? 'KORISNIK' : 'AI';\r\n            const content =\r\n              m.content.length > 800 ? m.content.substring(0, 800) + '...' : m.content;\r\n            return `${role}: ${content}`;\r\n          })\r\n          .join('\\n\\n');\r\n      } catch {\r\n        /* no context available */\r\n      }\r\n\r\n      prompt = `Ti si poslovni strunjak. IZVRI sledei zadatak u potpunosti.\r\n\r\nZADATAK: ${taskNote.title}\r\n${taskNote.content ? `OPIS:\\n${taskNote.content}` : ''}\r\n${taskNote.expectedOutcome ? `OEKIVANI REZULTAT: ${taskNote.expectedOutcome}` : ''}\r\n${conceptKnowledge}${webContext}\r\n${conversationContext ? `\\nKONTEKST IZ KONVERZACIJE (tvoj rezultat MORA biti relevantan za ovo):\\n${conversationContext}` : ''}\r\n\r\nKRITINO  RAZLIKUJ DVA TIPA ZADATAKA:\r\n\r\nA) DIGITALNI ZADACI (sadraj, planovi, kampanje, mejlovi, strategije, analize, dokumenti, budeti, abloni, procedure):\r\n    PROIZVEDI GOTOV REZULTAT koji se moe odmah koristiti. NE daj instrukcije  URADI posao.\r\n\r\nB) FIZIKI ZADACI (odlazak negde, naruivanje, pozivi, fizika instalacija, sastanci):\r\n    NE simuliraj da si obavio fiziku radnju\r\n    NAPII DETALJAN PLAN: ko treba da uradi ta, sa svim detaljima\r\n    Jasno naznai: \" ZAHTEVA LJUDSKU AKCIJU:\" ispred svakog koraka koji AI ne moe izvriti\r\n\r\nPRAVILA:\r\n1. Proizvedi KOMPLETAN, GOTOV dokument  ne skicu, ne saetak, ne listu preporuka\r\n2. NIKADA ne pii \"trebalo bi da...\", \"preporuuje se...\" za digitalne zadatke  NAPRAVI to sam\r\n3. NIKADA ne izmiljaj podatke  ako nema podatak, naznai \"[POPUNITI: ...]\"\r\n4. Strukturiraj sa ## zaglavljima, tabelama, nabrajanjima\r\n5. Minimum 800 rei za analitike zadatke\r\n6. Odgovaraj ISKLJUIVO na srpskom jeziku`;\r\n    }\r\n\r\n    let fullContent = '';\r\n    let chunkIndex = 0;\r\n\r\n    await this.aiGatewayService.streamCompletionWithContext(\r\n      [{ role: 'user', content: prompt }],\r\n      { tenantId, userId, conversationId: convId, businessContext },\r\n      (chunk: string) => {\r\n        fullContent += chunk;\r\n        client.emit('task:ai-chunk', {\r\n          taskId: task.id,\r\n          conversationId: convId,\r\n          content: chunk,\r\n          index: chunkIndex++,\r\n          auto: true,\r\n        });\r\n      }\r\n    );\r\n\r\n    // Save AI output as message + mark task COMPLETED\r\n    if (convId) {\r\n      await this.conversationService.addMessage(\r\n        tenantId,\r\n        convId,\r\n        MessageRole.ASSISTANT,\r\n        fullContent\r\n      );\r\n    }\r\n    await this.prisma.note.update({\r\n      where: { id: task.id },\r\n      data: { status: 'COMPLETED', userReport: fullContent },\r\n    });\r\n\r\n    client.emit('task:ai-complete', {\r\n      taskId: task.id,\r\n      fullContent,\r\n      conversationId: convId,\r\n      auto: true,\r\n    });\r\n    client.emit('chat:notes-updated', { conversationId: convId, count: 0 });\r\n\r\n    //  Phase 3: Score the result \r\n    client.emit('task:result-start', {\r\n      taskId: task.id,\r\n      conversationId: convId,\r\n      timestamp: new Date().toISOString(),\r\n      auto: true,\r\n    });\r\n\r\n    // Load tenant info for scoring context\r\n    let tenantInfo = '';\r\n    try {\r\n      const tenant = await this.prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        select: { name: true, industry: true },\r\n      });\r\n      if (tenant) {\r\n        tenantInfo = `\\nKOMPANIJA: ${tenant.name}${tenant.industry ? ` | INDUSTRIJA: ${tenant.industry}` : ''}`;\r\n      }\r\n    } catch {\r\n      /* non-blocking */\r\n    }\r\n\r\n    let conceptScoreContext = '';\r\n    if (taskNote.conceptId) {\r\n      try {\r\n        const concept = await this.conceptService.findById(taskNote.conceptId);\r\n        conceptScoreContext = `\\nKONCEPT: ${concept.name} (${concept.category})  ${concept.definition}`;\r\n      } catch {\r\n        /* non-blocking */\r\n      }\r\n    }\r\n\r\n    const scorePrompt = `Ti si senior poslovni konsultant koji recenzira deliverable-e. Tvoj zadatak je da:\r\n\r\n1. OPTIMIZUJE rezultat  napravi finalnu, poliranu verziju:\r\n   - Poboljaj strukturu (## zaglavlja, tabele, nabrajanja)\r\n   - Dodaj konkretne brojke, rokove i metrike gde nedostaju\r\n   - Zameni generike preporuke SPECIFINIM akcijama prilagoenim kompaniji\r\n   - Ukloni redundantni tekst i ponavljanja\r\n   - Dodaj sekciju \"Sledei koraci\" ako ne postoji\r\n\r\n2. OCENI rezultat po 5 kriterijuma (svaki 1-10):\r\n   - PRIMENLJIVOST: Da li se moe odmah implementirati?\r\n   - SPECIFINOST: Da li sadri konkretne brojke, nazive, rokove?\r\n   - KOMPLETNOST: Da li pokriva sve aspekte zadatka?\r\n   - RELEVANTNOST: Da li je prilagoen industriji i kompaniji?\r\n   - KVALITET: Da li je profesionalno strukturiran i jasan?\r\n${tenantInfo}${conceptScoreContext}\r\n\r\nZADATAK: ${taskNote.title}\r\n${taskNote.content ? `OPIS: ${taskNote.content}` : ''}\r\n${taskNote.expectedOutcome ? `OEKIVANI REZULTAT: ${taskNote.expectedOutcome}` : ''}\r\n\r\nIZLAZ KOJI TREBA OCENITI I OPTIMIZOVATI:\r\n${fullContent}\r\n\r\nFORMAT ODGOVORA:\r\n1. Napii OPTIMIZOVANI REZULTAT (kompletan dokument)\r\n2. Na samom kraju dodaj:\r\n---\r\nEVALUACIJA:\r\n- Primenljivost: X/10\r\n- Specifinost: X/10\r\n- Kompletnost: X/10\r\n- Relevantnost: X/10\r\n- Kvalitet: X/10\r\nOCENA: X/10\r\n---\r\n\r\nGde je OCENA prosek svih pet kriterijuma (zaokruen na ceo broj).\r\nOdgovaraj ISKLJUIVO na srpskom jeziku.`;\r\n\r\n    let scoreResult = '';\r\n    let scoreChunkIndex = 0;\r\n\r\n    await this.aiGatewayService.streamCompletionWithContext(\r\n      [{ role: 'user', content: scorePrompt }],\r\n      { tenantId, userId, conversationId: convId, businessContext },\r\n      (chunk: string) => {\r\n        scoreResult += chunk;\r\n        client.emit('task:result-chunk', {\r\n          taskId: task.id,\r\n          conversationId: convId,\r\n          content: chunk,\r\n          index: scoreChunkIndex++,\r\n          auto: true,\r\n        });\r\n      }\r\n    );\r\n\r\n    // Extract score\r\n    let score: number | null = null;\r\n    const scoreMatch = scoreResult.match(/OCENA:\\s*(\\d{1,2})\\s*\\/\\s*10/i);\r\n    if (scoreMatch) {\r\n      const rawScore = parseInt(scoreMatch[1]!, 10);\r\n      if (rawScore >= 1 && rawScore <= 10) {\r\n        score = rawScore * 10;\r\n      }\r\n    }\r\n\r\n    // Save optimized result + score\r\n    await this.prisma.note.update({\r\n      where: { id: task.id },\r\n      data: {\r\n        userReport: scoreResult,\r\n        aiScore: score,\r\n        aiFeedback: score !== null ? `AI ocena: ${score}/100` : null,\r\n      },\r\n    });\r\n\r\n    client.emit('task:result-complete', {\r\n      taskId: task.id,\r\n      conversationId: convId,\r\n      score,\r\n      finalResult: scoreResult,\r\n      timestamp: new Date().toISOString(),\r\n      auto: true,\r\n    });\r\n    client.emit('chat:notes-updated', { conversationId: convId, count: 0 });\r\n  }\r\n\r\n  //  YOLO Auto-Popuni Queue (H2 fix: sequential to avoid LLM overload) \r\n  private autoPopuniYoloQueue: Array<{\r\n    client: Socket;\r\n    tenantId: string;\r\n    userId: string;\r\n    taskId: string;\r\n    conversationId: string;\r\n  }> = [];\r\n  private isProcessingAutoPopuniYolo = false;\r\n\r\n  /**\r\n   * Enqueue a YOLO-completed task for auto-popuni (synthesize + score).\r\n   * Tasks are processed sequentially to avoid overwhelming the LLM provider.\r\n   */\r\n  private enqueueAutoPopuniAfterYolo(\r\n    client: Socket,\r\n    tenantId: string,\r\n    userId: string,\r\n    taskId: string,\r\n    conversationId: string\r\n  ): void {\r\n    this.autoPopuniYoloQueue.push({ client, tenantId, userId, taskId, conversationId });\r\n    this.processAutoPopuniYoloQueue().catch((err) => {\r\n      this.logger.warn({\r\n        message: 'YOLO auto-popuni queue processing error',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    });\r\n  }\r\n\r\n  private async processAutoPopuniYoloQueue(): Promise<void> {\r\n    if (this.isProcessingAutoPopuniYolo) return;\r\n    this.isProcessingAutoPopuniYolo = true;\r\n\r\n    while (this.autoPopuniYoloQueue.length > 0) {\r\n      const item = this.autoPopuniYoloQueue.shift()!;\r\n      await this.autoPopuniAfterYolo(\r\n        item.client,\r\n        item.tenantId,\r\n        item.userId,\r\n        item.taskId,\r\n        item.conversationId\r\n      );\r\n    }\r\n\r\n    this.isProcessingAutoPopuniYolo = false;\r\n  }\r\n\r\n  /**\r\n   * Auto AI Popuni after YOLO completes a task: synthesize workflow step\r\n   * outputs into a userReport and score it. Checks tenant config first.\r\n   * Reuses the same handleExecuteTaskAi  handleSubmitTaskResult logic.\r\n   * Emits auto-popuni:start/complete events for frontend spinner (H3 fix).\r\n   */\r\n  private async autoPopuniAfterYolo(\r\n    client: Socket,\r\n    tenantId: string,\r\n    userId: string,\r\n    taskId: string,\r\n    conversationId: string\r\n  ): Promise<void> {\r\n    // Check if auto AI popuni is enabled\r\n    try {\r\n      const tenant = await this.prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        select: { autoAiPopuni: true },\r\n      });\r\n      if (!tenant?.autoAiPopuni) return;\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'YOLO auto-popuni: tenant lookup failed',\r\n        tenantId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'YOLO auto-popuni: synthesizing + scoring task',\r\n      taskId,\r\n      tenantId,\r\n    });\r\n\r\n    // Emit start event so frontend shows spinner (H3 fix)\r\n    client.emit('auto-popuni:start', {\r\n      taskIds: [taskId],\r\n      taskCount: 1,\r\n    });\r\n\r\n    let completed = false;\r\n\r\n    // Reuse the same handlers  handleExecuteTaskAi will find child notes\r\n    // and synthesize them into a final deliverable\r\n    try {\r\n      await this.handleExecuteTaskAi(client, { taskId, conversationId });\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'YOLO auto-popuni AI execute failed',\r\n        taskId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      client.emit('auto-popuni:complete', { totalTasks: 1, completedTasks: 0 });\r\n      return;\r\n    }\r\n\r\n    // Now score the result\r\n    try {\r\n      await this.handleSubmitTaskResult(client, { taskId });\r\n      completed = true;\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'YOLO auto-popuni scoring failed',\r\n        taskId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    }\r\n\r\n    // Emit complete event (H3 fix)\r\n    client.emit('auto-popuni:complete', {\r\n      totalTasks: 1,\r\n      completedTasks: completed ? 1 : 0,\r\n    });\r\n  }\r\n\r\n  //  Workflow / Agent Execution Events \r\n\r\n  /**\r\n   * Handles \"Run Agents\" request: builds an execution plan from selected tasks.\r\n   */\r\n  @SubscribeMessage('workflow:run-agents')\r\n  async handleRunAgents(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { taskIds: string[]; conversationId: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    try {\r\n      this.logger.log({\r\n        message: 'Run Agents requested',\r\n        userId: authenticatedClient.userId,\r\n        taskIds: payload.taskIds,\r\n        conversationId: payload.conversationId,\r\n      });\r\n\r\n      // Check if tasks have linked concepts  tasks created from chat may not\r\n      const tasks = await this.prisma.note.findMany({\r\n        where: {\r\n          id: { in: payload.taskIds },\r\n          tenantId: authenticatedClient.tenantId,\r\n          noteType: 'TASK',\r\n          status: 'PENDING',\r\n        },\r\n        select: { id: true, conceptId: true },\r\n      });\r\n\r\n      const tasksWithConcepts = tasks.filter((t) => t.conceptId);\r\n      const tasksWithoutConcepts = tasks.filter((t) => !t.conceptId);\r\n\r\n      // If ALL tasks lack concepts, use direct AI execution instead of workflow\r\n      if (tasksWithConcepts.length === 0 && tasksWithoutConcepts.length > 0) {\r\n        this.logger.log({\r\n          message: 'Tasks have no concepts  falling back to direct AI execution',\r\n          taskCount: tasksWithoutConcepts.length,\r\n        });\r\n        for (const task of tasksWithoutConcepts) {\r\n          await this.handleExecuteTaskAi(client, {\r\n            taskId: task.id,\r\n            conversationId: payload.conversationId,\r\n          });\r\n        }\r\n        return;\r\n      }\r\n\r\n      // Build workflow execution plan for concept-linked tasks\r\n      const taskIdsForPlan =\r\n        tasksWithConcepts.length < tasks.length\r\n          ? tasksWithConcepts.map((t) => t.id)\r\n          : payload.taskIds;\r\n\r\n      const plan = await this.workflowService.buildExecutionPlan(\r\n        taskIdsForPlan,\r\n        authenticatedClient.userId,\r\n        authenticatedClient.tenantId,\r\n        payload.conversationId\r\n      );\r\n\r\n      const event: WorkflowPlanReadyPayload = {\r\n        plan,\r\n        conversationId: payload.conversationId,\r\n      };\r\n      client.emit('workflow:plan-ready', event);\r\n\r\n      // Execute concept-less tasks via direct AI (after plan is sent)\r\n      for (const task of tasksWithoutConcepts) {\r\n        await this.handleExecuteTaskAi(client, {\r\n          taskId: task.id,\r\n          conversationId: payload.conversationId,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to build execution plan',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('workflow:error', {\r\n        message: error instanceof Error ? error.message : 'Failed to build plan',\r\n        conversationId: payload.conversationId,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetches a pre-built execution plan by ID.\r\n   * If the plan is not in memory (e.g. server restart), rebuilds from DB tasks.\r\n   */\r\n  @SubscribeMessage('workflow:get-plan')\r\n  async handleGetPlan(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { planId: string; conversationId: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n    const { userId, tenantId } = authenticatedClient;\r\n\r\n    try {\r\n      // Verify the user owns this conversation\r\n      const conv = await this.conversationService.getConversation(\r\n        tenantId,\r\n        payload.conversationId,\r\n        userId\r\n      );\r\n      if (!conv) {\r\n        client.emit('workflow:error', {\r\n          message: 'Conversation not found',\r\n          conversationId: payload.conversationId,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Try to fetch the plan from in-memory store\r\n      const plan = this.workflowService.getActivePlan(payload.planId);\r\n      if (plan) {\r\n        client.emit('workflow:plan-ready', {\r\n          plan,\r\n          conversationId: payload.conversationId,\r\n        } as WorkflowPlanReadyPayload);\r\n        return;\r\n      }\r\n\r\n      // Fallback: rebuild plan from conversation's pending tasks\r\n      this.logger.warn({\r\n        message: 'Plan not found in memory, rebuilding from DB tasks',\r\n        planId: payload.planId,\r\n        conversationId: payload.conversationId,\r\n      });\r\n\r\n      const tasks = await this.prisma.note.findMany({\r\n        where: {\r\n          conversationId: payload.conversationId,\r\n          tenantId,\r\n          noteType: 'TASK',\r\n          status: 'PENDING',\r\n        },\r\n        select: { id: true },\r\n      });\r\n\r\n      if (tasks.length > 0) {\r\n        const rebuilt = await this.workflowService.buildExecutionPlan(\r\n          tasks.map((t) => t.id),\r\n          userId,\r\n          tenantId,\r\n          payload.conversationId\r\n        );\r\n        client.emit('workflow:plan-ready', {\r\n          plan: rebuilt,\r\n          conversationId: payload.conversationId,\r\n        } as WorkflowPlanReadyPayload);\r\n      } else {\r\n        client.emit('workflow:error', {\r\n          message: 'Nije pronaen plan niti zadaci za rekonstrukciju',\r\n          conversationId: payload.conversationId,\r\n        });\r\n      }\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to get/rebuild execution plan',\r\n        planId: payload.planId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('workflow:error', {\r\n        message: error instanceof Error ? error.message : 'Failed to load plan',\r\n        conversationId: payload.conversationId,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles plan approval or rejection.\r\n   * On approval, starts fire-and-forget execution of all plan steps.\r\n   */\r\n  @SubscribeMessage('workflow:approve')\r\n  async handleWorkflowApproval(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { planId: string; approved: boolean; conversationId: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    if (!payload.approved) {\r\n      this.workflowService.cancelPlan(payload.planId);\r\n      const event: WorkflowCompletePayload = {\r\n        planId: payload.planId,\r\n        status: 'cancelled',\r\n        completedSteps: 0,\r\n        totalSteps: 0,\r\n        conversationId: payload.conversationId,\r\n      };\r\n      client.emit('workflow:complete', event);\r\n      return;\r\n    }\r\n\r\n    // Get plan for step metadata\r\n    const plan = this.workflowService.getActivePlan(payload.planId);\r\n    const totalSteps = plan?.steps.length ?? 0;\r\n\r\n    // Create per-concept conversations for execution results\r\n    const conceptConversations = new Map<string, string>();\r\n    if (plan) {\r\n      const conceptIds = [...new Set(plan.steps.map((s: ExecutionPlanStep) => s.conceptId))];\r\n      for (const conceptId of conceptIds) {\r\n        const conceptName =\r\n          plan.steps.find((s: ExecutionPlanStep) => s.conceptId === conceptId)?.conceptName ??\r\n          'Zadatak';\r\n        try {\r\n          const conv = await this.conversationService.createConversation(\r\n            authenticatedClient.tenantId,\r\n            authenticatedClient.userId,\r\n            conceptName,\r\n            undefined,\r\n            conceptId\r\n          );\r\n          conceptConversations.set(conceptId, conv.id);\r\n        } catch (err) {\r\n          this.logger.warn({\r\n            message: 'Failed to create concept conversation, using original',\r\n            conceptId,\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          });\r\n        }\r\n      }\r\n\r\n      // Notify frontend about created conversations\r\n      const conversationsCreated: WorkflowConversationsCreatedPayload = {\r\n        planId: payload.planId,\r\n        conversations: conceptIds\r\n          .filter((id) => conceptConversations.has(id))\r\n          .map((id) => ({\r\n            conceptId: id,\r\n            conceptName:\r\n              plan.steps.find((s: ExecutionPlanStep) => s.conceptId === id)?.conceptName ?? '',\r\n            conversationId: conceptConversations.get(id)!,\r\n          })),\r\n        originalConversationId: payload.conversationId,\r\n      };\r\n      client.emit('workflow:conversations-created', conversationsCreated);\r\n\r\n      // Auto-navigate frontend to the first concept conversation\r\n      const firstConv = conversationsCreated.conversations[0];\r\n      if (firstConv) {\r\n        const navEvent: WorkflowNavigatePayload = {\r\n          planId: payload.planId,\r\n          conversationId: firstConv.conversationId,\r\n          conceptName: firstConv.conceptName,\r\n        };\r\n        client.emit('workflow:navigate-to-conversation', navEvent);\r\n      }\r\n    }\r\n\r\n    // Fire-and-forget execution\r\n    this.workflowService\r\n      .executePlan(\r\n        payload.planId,\r\n        payload.conversationId,\r\n        authenticatedClient.userId,\r\n        authenticatedClient.tenantId,\r\n        {\r\n          onStepStart: (stepId) => {\r\n            const stepInfo = plan?.steps.find((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const stepIndex =\r\n              plan?.steps.findIndex((s: ExecutionPlanStep) => s.stepId === stepId) ?? -1;\r\n            const event: WorkflowStepProgressPayload = {\r\n              planId: payload.planId,\r\n              stepId,\r\n              stepTitle: stepInfo?.title,\r\n              stepIndex,\r\n              totalSteps,\r\n              status: 'in_progress',\r\n              conversationId: payload.conversationId,\r\n            };\r\n            client.emit('workflow:step-progress', event);\r\n          },\r\n          onStepChunk: (_stepId, chunk) => {\r\n            client.emit('chat:message-chunk', { content: chunk, index: -1 });\r\n          },\r\n          onStepComplete: (stepId, fullContent, citations) => {\r\n            const stepInfo = plan?.steps.find((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const stepIndex =\r\n              plan?.steps.findIndex((s: ExecutionPlanStep) => s.stepId === stepId) ?? -1;\r\n            const event: WorkflowStepProgressPayload = {\r\n              planId: payload.planId,\r\n              stepId,\r\n              stepTitle: stepInfo?.title,\r\n              stepIndex,\r\n              totalSteps,\r\n              status: 'completed',\r\n              content: fullContent,\r\n              citations,\r\n              conversationId: payload.conversationId,\r\n            };\r\n            client.emit('workflow:step-progress', event);\r\n\r\n            // Emit complete step message for chat rendering\r\n            const stepMsg: WorkflowStepMessagePayload = {\r\n              planId: payload.planId,\r\n              conversationId: payload.conversationId,\r\n              messageId: stepId,\r\n              content: fullContent,\r\n              stepIndex,\r\n              totalSteps,\r\n              inputType: 'confirmation',\r\n              conceptName: stepInfo?.conceptName ?? '',\r\n            };\r\n            client.emit('workflow:step-message', stepMsg);\r\n          },\r\n          onStepFailed: (stepId, error) => {\r\n            const stepInfo = plan?.steps.find((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const stepIndex =\r\n              plan?.steps.findIndex((s: ExecutionPlanStep) => s.stepId === stepId) ?? -1;\r\n            const event: WorkflowStepProgressPayload = {\r\n              planId: payload.planId,\r\n              stepId,\r\n              stepTitle: stepInfo?.title,\r\n              stepIndex,\r\n              totalSteps,\r\n              status: 'failed',\r\n              content: error,\r\n              conversationId: payload.conversationId,\r\n            };\r\n            client.emit('workflow:step-progress', event);\r\n          },\r\n          onStepAwaitingConfirmation: (upcomingStep) => {\r\n            const stepIndex =\r\n              plan?.steps.findIndex((s: ExecutionPlanStep) => s.stepId === upcomingStep.stepId) ??\r\n              -1;\r\n\r\n            // Notify frontend for UI tracking (non-blocking)\r\n            const event: WorkflowStepConfirmationPayload = {\r\n              planId: payload.planId,\r\n              completedStepId: '',\r\n              nextStep: {\r\n                stepId: upcomingStep.stepId,\r\n                title: upcomingStep.title,\r\n                description: upcomingStep.description,\r\n                conceptName: upcomingStep.conceptName,\r\n                stepIndex,\r\n                totalSteps,\r\n              },\r\n              conversationId: payload.conversationId,\r\n            };\r\n            client.emit('workflow:step-awaiting-confirmation', event);\r\n\r\n            // Auto-resolve on backend: plan was already approved, no frontend round-trip needed.\r\n            // This prevents the workflow from hanging when the user navigates to another conversation.\r\n            setTimeout(() => {\r\n              this.workflowService.continueStep(payload.planId);\r\n            }, 100);\r\n          },\r\n          onComplete: (status, completedSteps, totalStepsCount) => {\r\n            const event: WorkflowCompletePayload = {\r\n              planId: payload.planId,\r\n              status,\r\n              completedSteps,\r\n              totalSteps: totalStepsCount,\r\n              conversationId: payload.conversationId,\r\n            };\r\n            client.emit('workflow:complete', event);\r\n\r\n            // Refresh notes on frontend\r\n            client.emit('chat:notes-updated', {\r\n              conversationId: payload.conversationId,\r\n              count: 0,\r\n            });\r\n          },\r\n          onTasksDiscovered: (newConceptIds) => {\r\n            client.emit('tree:tasks-discovered', {\r\n              conceptIds: newConceptIds,\r\n              conversationId: payload.conversationId,\r\n              timestamp: new Date().toISOString(),\r\n            });\r\n          },\r\n          saveMessage: async (_role, content, conceptId) => {\r\n            // Route message to the concept's conversation if available\r\n            const targetConvId =\r\n              conceptId && conceptConversations.has(conceptId)\r\n                ? conceptConversations.get(conceptId)!\r\n                : payload.conversationId;\r\n            const msg = await this.conversationService.addMessage(\r\n              authenticatedClient.tenantId,\r\n              targetConvId,\r\n              MessageRole.ASSISTANT,\r\n              content\r\n            );\r\n            return msg.id;\r\n          },\r\n        }\r\n      )\r\n      .catch((err: unknown) => {\r\n        this.logger.error({\r\n          message: 'Workflow execution failed',\r\n          planId: payload.planId,\r\n          error: err instanceof Error ? err.message : 'Unknown error',\r\n        });\r\n        client.emit('workflow:error', {\r\n          planId: payload.planId,\r\n          message: err instanceof Error ? err.message : 'Execution failed',\r\n          conversationId: payload.conversationId,\r\n        });\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Handles cancellation of a running workflow.\r\n   */\r\n  @SubscribeMessage('workflow:cancel')\r\n  handleWorkflowCancel(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { planId: string; conversationId: string }\r\n  ): void {\r\n    const cancelled = this.workflowService.cancelPlan(payload.planId);\r\n    if (!cancelled) {\r\n      client.emit('workflow:error', {\r\n        message: 'Plan not found or already completed',\r\n        conversationId: payload.conversationId,\r\n      });\r\n    }\r\n    // The execution loop will detect cancellation and emit workflow:complete\r\n  }\r\n\r\n  /**\r\n   * Handles user confirming to continue to the next workflow step.\r\n   * Optionally passes user input to inject as context for the next step.\r\n   */\r\n  @SubscribeMessage('workflow:step-continue')\r\n  handleStepContinue(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { planId: string; conversationId: string; userInput?: string }\r\n  ): void {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n    this.logger.log({\r\n      message: 'User confirmed next workflow step',\r\n      planId: payload.planId,\r\n      hasUserInput: !!payload.userInput,\r\n    });\r\n\r\n    // Story 3.2: Store user input as Business Brain memory (fire-and-forget)\r\n    if (payload.userInput && payload.userInput.trim().length > 10) {\r\n      this.memoryService\r\n        .createMemory(authenticatedClient.tenantId, authenticatedClient.userId, {\r\n          type: MemoryType.FACTUAL_STATEMENT,\r\n          source: MemorySource.USER_STATED,\r\n          content: payload.userInput.trim(),\r\n          subject: 'workflow-input',\r\n          confidence: 1.0,\r\n        })\r\n        .catch((err) => {\r\n          this.logger.warn({\r\n            message: 'Failed to store workflow user input as memory',\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          });\r\n        });\r\n    }\r\n\r\n    this.workflowService.continueStep(payload.planId, payload.userInput);\r\n  }\r\n\r\n  /**\r\n   * Story 3.11: Handles \"Execute Task with AI\"  AI does the task's work directly\r\n   * and streams the result back. Simpler than the full workflow engine.\r\n   */\r\n  @SubscribeMessage('task:execute-ai')\r\n  async handleExecuteTaskAi(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { taskId: string; conversationId: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    try {\r\n      this.logger.log({\r\n        message: 'AI task execution requested',\r\n        userId: authenticatedClient.userId,\r\n        taskId: payload.taskId,\r\n      });\r\n\r\n      // 1. Load the task note\r\n      const task = await this.prisma.note.findUnique({\r\n        where: { id: payload.taskId },\r\n      });\r\n      if (!task || task.tenantId !== authenticatedClient.tenantId) {\r\n        client.emit('task:ai-error', { taskId: payload.taskId, message: 'Zadatak nije pronaen' });\r\n        return;\r\n      }\r\n\r\n      // 1b. Resolve conversation ID early for all emissions\r\n      const convId = task.conversationId ?? payload.conversationId;\r\n\r\n      // 1c. Emit immediate acknowledgment so frontend knows execution has started\r\n      client.emit('task:ai-start', {\r\n        taskId: payload.taskId,\r\n        conversationId: convId,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n\r\n      // 2. Load all workflow step outputs (child notes = completed workflow steps)\r\n      let childNotes = await this.prisma.note.findMany({\r\n        where: { parentNoteId: task.id },\r\n        select: { title: true, content: true, workflowStepNumber: true, status: true },\r\n        orderBy: { workflowStepNumber: 'asc' },\r\n      });\r\n\r\n      // 2b. If no children exist, generate a workflow and execute each step first\r\n      //     This ensures every task goes through multi-step research before synthesis\r\n      if (childNotes.length === 0) {\r\n        try {\r\n          client.emit('task:ai-workflow-start', {\r\n            taskId: payload.taskId,\r\n            conversationId: convId,\r\n            message: 'Generiem plan izvravanja...',\r\n          });\r\n\r\n          // Choose workflow type: concept-based (rich context from KB) for concept-linked\r\n          // tasks with minimal content; task-specific (uses conversation context) otherwise\r\n          const isMinimalContent = !task.content || task.content.length < 200;\r\n          const hasConcept = !!task.conceptId;\r\n\r\n          let workflow: {\r\n            conceptName: string;\r\n            steps: import('@mentor-ai/shared/types').WorkflowStep[];\r\n          };\r\n          if (hasConcept && isMinimalContent) {\r\n            // Concept-based: gets definition, prerequisites, related concepts, tenant context\r\n            workflow = await this.workflowService.getOrGenerateWorkflow(\r\n              task.conceptId!,\r\n              authenticatedClient.tenantId,\r\n              authenticatedClient.userId\r\n            );\r\n          } else {\r\n            // Task-specific: uses task title, content, conversation context\r\n            workflow = await this.workflowService.generateTaskSpecificWorkflow(\r\n              {\r\n                title: task.title,\r\n                content: task.content ?? '',\r\n                conversationId: convId ?? null,\r\n                conceptId: task.conceptId,\r\n              },\r\n              authenticatedClient.tenantId,\r\n              authenticatedClient.userId\r\n            );\r\n          }\r\n\r\n          this.logger.log({\r\n            message: 'AI Popuni: workflow generated for task',\r\n            taskId: payload.taskId,\r\n            taskTitle: task.title,\r\n            stepCount: workflow.steps.length,\r\n            workflowType: hasConcept && isMinimalContent ? 'concept-based' : 'task-specific',\r\n          });\r\n\r\n          // Execute each workflow step and save as child note\r\n          const completedSummaries: Array<{ title: string; conceptName: string; summary: string }> =\r\n            [];\r\n\r\n          for (let stepIdx = 0; stepIdx < workflow.steps.length; stepIdx++) {\r\n            const workflowStep = workflow.steps[stepIdx]!;\r\n\r\n            client.emit('task:ai-step-progress', {\r\n              taskId: payload.taskId,\r\n              conversationId: convId,\r\n              stepIndex: stepIdx,\r\n              totalSteps: workflow.steps.length,\r\n              stepTitle: workflowStep.title,\r\n            });\r\n\r\n            const step: ExecutionPlanStep = {\r\n              stepId: `popuni_step_${createId()}`,\r\n              conceptId: task.conceptId ?? '',\r\n              conceptName: workflow.conceptName,\r\n              workflowStepNumber: workflowStep.stepNumber,\r\n              title: workflowStep.title,\r\n              description: workflowStep.description,\r\n              estimatedMinutes: workflowStep.estimatedMinutes,\r\n              departmentTag: workflowStep.departmentTag,\r\n              status: 'in_progress',\r\n              taskTitle: task.title,\r\n              taskContent: task.content ?? undefined,\r\n              taskConversationId: convId ?? undefined,\r\n            };\r\n\r\n            const result = await this.workflowService.executeStepAutonomous(\r\n              step,\r\n              convId ?? '',\r\n              authenticatedClient.userId,\r\n              authenticatedClient.tenantId,\r\n              (chunk: string) => {\r\n                // Stream step chunks to frontend so user sees progress\r\n                client.emit('task:ai-chunk', {\r\n                  taskId: payload.taskId,\r\n                  conversationId: convId,\r\n                  content: chunk,\r\n                  index: stepIdx * 1000 + completedSummaries.length,\r\n                  stepTitle: workflowStep.title,\r\n                });\r\n              },\r\n              completedSummaries\r\n            );\r\n\r\n            // Dedup: check if child note already exists for this step\r\n            const existingSubTask = await this.notesService.findExistingSubTask(\r\n              authenticatedClient.tenantId,\r\n              payload.taskId,\r\n              workflowStep.stepNumber\r\n            );\r\n\r\n            if (!existingSubTask) {\r\n              await this.notesService.createNote({\r\n                title: workflowStep.title,\r\n                content: result.content,\r\n                source: NoteSource.CONVERSATION,\r\n                noteType: NoteType.TASK,\r\n                status: NoteStatus.READY_FOR_REVIEW,\r\n                userId: authenticatedClient.userId,\r\n                tenantId: authenticatedClient.tenantId,\r\n                conversationId: convId ?? undefined,\r\n                conceptId: task.conceptId ?? undefined,\r\n                parentNoteId: payload.taskId,\r\n                expectedOutcome: workflowStep.expectedOutcome?.substring(0, 500),\r\n                workflowStepNumber: workflowStep.stepNumber,\r\n              });\r\n            }\r\n\r\n            completedSummaries.push({\r\n              title: workflowStep.title,\r\n              conceptName: workflow.conceptName,\r\n              summary: result.content.substring(0, 500),\r\n            });\r\n\r\n            client.emit('task:ai-step-complete', {\r\n              taskId: payload.taskId,\r\n              conversationId: convId,\r\n              stepIndex: stepIdx,\r\n              totalSteps: workflow.steps.length,\r\n              stepTitle: workflowStep.title,\r\n            });\r\n          }\r\n\r\n          // Re-load child notes now that they exist\r\n          childNotes = await this.prisma.note.findMany({\r\n            where: { parentNoteId: task.id },\r\n            select: { title: true, content: true, workflowStepNumber: true, status: true },\r\n            orderBy: { workflowStepNumber: 'asc' },\r\n          });\r\n\r\n          this.logger.log({\r\n            message: 'AI Popuni: workflow steps completed, proceeding to synthesis',\r\n            taskId: payload.taskId,\r\n            childCount: childNotes.length,\r\n          });\r\n        } catch (err) {\r\n          this.logger.warn({\r\n            message:\r\n              'AI Popuni: workflow generation/execution failed, falling back to direct execution',\r\n            taskId: payload.taskId,\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          });\r\n          // Fall through to direct execution (childNotes still empty)\r\n        }\r\n      }\r\n\r\n      // 3. Build business context\r\n      const businessContext = await this.buildBusinessContext(\r\n        authenticatedClient.tenantId,\r\n        authenticatedClient.userId\r\n      );\r\n\r\n      // 4. Load concept knowledge if task is linked to a concept\r\n      let conceptKnowledge = '';\r\n      if (task.conceptId) {\r\n        try {\r\n          const concept = await this.conceptService.findById(task.conceptId);\r\n          conceptKnowledge = `\\n\\n--- BAZA ZNANJA ---`;\r\n          conceptKnowledge += `\\nKONCEPT: ${concept.name} (${concept.category})`;\r\n          conceptKnowledge += `\\nDEFINICIJA: ${concept.definition}`;\r\n          if (concept.extendedDescription) {\r\n            conceptKnowledge += `\\nDETALJNO: ${concept.extendedDescription}`;\r\n          }\r\n          if (concept.relatedConcepts && concept.relatedConcepts.length > 0) {\r\n            const related = concept.relatedConcepts\r\n              .slice(0, 5)\r\n              .map((r) => `${r.concept.name} (${r.relationshipType})`)\r\n              .join(', ');\r\n            conceptKnowledge += `\\nPOVEZANI KONCEPTI: ${related}`;\r\n          }\r\n          conceptKnowledge += '\\n--- KRAJ BAZE ZNANJA ---';\r\n        } catch {\r\n          /* concept not found */\r\n        }\r\n      }\r\n\r\n      // 4b. Web search for current data (if available)\r\n      let webContext = '';\r\n      if (this.webSearchService.isAvailable()) {\r\n        try {\r\n          const tenant = await this.prisma.tenant.findUnique({\r\n            where: { id: authenticatedClient.tenantId },\r\n            select: { name: true, industry: true },\r\n          });\r\n          const searchQuery = `${task.title} ${tenant?.industry ?? ''} ${new Date().getFullYear()}`;\r\n          const webResults = await this.webSearchService.searchAndExtract(searchQuery, 3);\r\n          if (webResults.length > 0) {\r\n            webContext = this.webSearchService.formatSourcesAsObsidian(webResults);\r\n          }\r\n        } catch {\r\n          /* non-blocking */\r\n        }\r\n      }\r\n\r\n      // 5. Build the prompt\r\n      let prompt: string;\r\n\r\n      if (childNotes.length > 0) {\r\n        // Build workflow results section from all child notes\r\n        const workflowResults = childNotes\r\n          .map((note, i) => {\r\n            const stepNum = note.workflowStepNumber ?? i + 1;\r\n            return `--- KORAK ${stepNum}: ${note.title} ---\\n${note.content}`;\r\n          })\r\n          .join('\\n\\n');\r\n\r\n        prompt = `Ti si vrhunski poslovni strunjak. Tvoj tim je zavrio detaljnu analizu kroz ${childNotes.length} koraka workflow-a. Sintetii SVE rezultate u FINALNI DOKUMENT koji vlasnik moe odmah koristiti.\r\n\r\nZADATAK: ${task.title}\r\n${task.content ? `OPIS ZADATKA: ${task.content}` : ''}\r\n${task.expectedOutcome ? `OEKIVANI REZULTAT: ${task.expectedOutcome}` : ''}\r\n\r\nREZULTATI ISTRAIVANJA I ANALIZE (koristi SVE podatke iz svih koraka):\r\n${workflowResults}\r\n${conceptKnowledge}${webContext}\r\n\r\nKRITINO  RAZLIKUJ DVA TIPA ZADATAKA:\r\n\r\nA) DIGITALNI ZADACI (sadraj, planovi, kampanje, mejlovi, strategije, analize, dokumenti, budeti, prezentacije):\r\n    PROIZVEDI GOTOV REZULTAT. Ne pii instrukcije  NAPII sam dokument/sadraj/plan.\r\n    Primer: ako je zadatak \"Napiite marketing email\"  NAPII ceo email sa subject linijom, telom, CTA\r\n    Primer: ako je zadatak \"Kreirajte content calendar\"  NAPRAVI kompletan kalendar sa datumima, temama, platformama\r\n    Primer: ako je zadatak \"Definiite budet\"  NAPRAVI tabelu sa stavkama, iznosima, totalima\r\n\r\nB) FIZIKI ZADACI (odlazak u prodavnicu, naruivanje, pozivanje klijenta, fizika instalacija):\r\n    NE simuliraj da si uradio fiziku radnju. NE pii \"Naruio sam...\" ili \"Obavio sam poziv...\"\r\n    UMESTO TOGA: napii TANO ta treba uraditi, ko treba da uradi, sa svim detaljima (kontakti, rokovi, koraci)\r\n    Primer: \"Vlasnik treba da pozove dobavljaa XY na broj 011-... i dogovori isporuku do DD.MM.\"\r\n\r\nPRAVILA ZA FINALNI DOKUMENT:\r\n1. Ovo je FINALNI DELIVERABLE  gotov dokument, NE izvetaj o radu\r\n2. Ako su koraci proizveli analizu  sintetii u AKCIONI PLAN sa konkretnim preporukama, rokovima i odgovornim osobama\r\n3. Ako su koraci definisali strategiju  napravi KOMPLETNU STRATEGIJU sa implementacionim koracima i metrikama\r\n4. Ako su koraci istraili vrednost  definii KONKRETNE OBLIKE VREDNOSTI sa cenovnom strategijom\r\n5. NIKADA ne pii \"trebalo bi da...\", \"preporuuje se...\" za digitalne zadatke  URADI to\r\n6. Koristi SPECIFINE podatke, brojke i nalaze iz koraka  ne generalizuj\r\n7. Strukturiraj sa ## zaglavljima, tabelama, nabrajanjima\r\n8. Dodaj sekciju \"Sledei koraci\" sa konkretnim akcijama koje zahtevaju LJUDSKU INTERVENCIJU (samo ono to AI ne moe)\r\n9. NIKADA ne pii \"u prethodnim koracima smo...\"  PRIKAI gotov rezultat\r\n10. Ako ima web izvore, citiraj INLINE: ([Naziv](URL))\r\n11. Minimum 1000 rei  ovo je sveobuhvatan dokument\r\n\r\nOdgovaraj ISKLJUIVO na srpskom jeziku.`;\r\n      } else {\r\n        // No workflow steps  direct task execution with full context\r\n        let conversationContext = '';\r\n        if (convId) {\r\n          try {\r\n            const conv = await this.conversationService.getConversation(\r\n              authenticatedClient.tenantId,\r\n              convId,\r\n              authenticatedClient.userId\r\n            );\r\n            const recentMessages = conv.messages.slice(-10);\r\n            conversationContext = recentMessages\r\n              .map((m) => {\r\n                const role = m.role === 'USER' ? 'KORISNIK' : 'AI';\r\n                const content =\r\n                  m.content.length > 800 ? m.content.substring(0, 800) + '...' : m.content;\r\n                return `${role}: ${content}`;\r\n              })\r\n              .join('\\n\\n');\r\n          } catch {\r\n            /* no context available */\r\n          }\r\n        }\r\n\r\n        prompt = `Ti si poslovni strunjak. IZVRI sledei zadatak u potpunosti.\r\n\r\nZADATAK: ${task.title}\r\n${task.content ? `OPIS:\\n${task.content}` : ''}\r\n${task.expectedOutcome ? `OEKIVANI REZULTAT: ${task.expectedOutcome}` : ''}\r\n${conceptKnowledge}${webContext}\r\n${conversationContext ? `\\nKONTEKST IZ KONVERZACIJE (tvoj rezultat MORA biti relevantan za ovo):\\n${conversationContext}` : ''}\r\n\r\nKRITINO  RAZLIKUJ DVA TIPA ZADATAKA:\r\n\r\nA) DIGITALNI ZADACI (sadraj, planovi, kampanje, mejlovi, strategije, analize, dokumenti, budeti, prezentacije, abloni, procedure):\r\n    PROIZVEDI GOTOV REZULTAT koji se moe odmah koristiti. NE daj instrukcije  URADI posao.\r\n    Primer: \"Napiite email za klijente\"  NAPII ceo email sa subject, telom i CTA\r\n    Primer: \"Kreirajte social media plan\"  NAPRAVI kompletan plan sa konkretnim postovima, datumima, platformama\r\n    Primer: \"Definiite SOP za onboarding\"  NAPII celu proceduru korak po korak\r\n    Primer: \"Analizirajte konkurenciju\"  URADI analizu sa tabelom konkurenata, cenama, prednostima/manama\r\n\r\nB) FIZIKI ZADACI (odlazak negde, naruivanje, pozivi, fizika instalacija, sastanci):\r\n    NE simuliraj da si obavio fiziku radnju\r\n    NAPII DETALJAN PLAN: ko treba da uradi ta, sa svim detaljima (kontakti, rokovi, koraci, budet)\r\n    Jasno naznai: \" ZAHTEVA LJUDSKU AKCIJU:\" ispred svakog koraka koji AI ne moe izvriti\r\n\r\nPRAVILA:\r\n1. Proizvedi KOMPLETAN, GOTOV dokument  ne skicu, ne saetak, ne listu preporuka\r\n2. NIKADA ne pii \"trebalo bi da...\", \"preporuuje se da napravite...\" za digitalne zadatke  NAPRAVI to sam\r\n3. NIKADA ne izmiljaj podatke ili simuliraj da je neto uraeno  ako nema podatak, naznai \"[POPUNITI: ...]\"\r\n4. Strukturiraj sa ## zaglavljima, tabelama, nabrajanjima\r\n5. Koristi znanje iz BAZE ZNANJA i WEB IZVORA ako su dostupni\r\n6. Kada referencira koncept, koristi [[Naziv Koncepta]] oznaku\r\n7. Ako ima web izvore, citiraj INLINE: ([Naziv](URL))\r\n8. Na kraju dodaj \"Sledei koraci\" SAMO za stvari koje zahtevaju LJUDSKU intervenciju\r\n9. Minimum 800 rei za analitike zadatke\r\n10. Odgovaraj ISKLJUIVO na srpskom jeziku`;\r\n      }\r\n\r\n      // 5. Stream the AI response\r\n      let fullContent = '';\r\n      let chunkIndex = 0;\r\n\r\n      await this.aiGatewayService.streamCompletionWithContext(\r\n        [{ role: 'user', content: prompt }],\r\n        {\r\n          tenantId: authenticatedClient.tenantId,\r\n          userId: authenticatedClient.userId,\r\n          conversationId: convId,\r\n          businessContext,\r\n        },\r\n        (chunk: string) => {\r\n          fullContent += chunk;\r\n          client.emit('task:ai-chunk', {\r\n            taskId: payload.taskId,\r\n            conversationId: convId,\r\n            content: chunk,\r\n            index: chunkIndex++,\r\n          });\r\n        }\r\n      );\r\n\r\n      // 6. Save AI output as message in the conversation\r\n      if (convId) {\r\n        await this.conversationService.addMessage(\r\n          authenticatedClient.tenantId,\r\n          convId,\r\n          MessageRole.ASSISTANT,\r\n          fullContent\r\n        );\r\n      }\r\n\r\n      // 7. Mark task as completed with AI output as report\r\n      await this.prisma.note.update({\r\n        where: { id: payload.taskId },\r\n        data: {\r\n          status: 'COMPLETED',\r\n          userReport: fullContent,\r\n        },\r\n      });\r\n\r\n      // 8. Emit completion\r\n      client.emit('task:ai-complete', {\r\n        taskId: payload.taskId,\r\n        fullContent,\r\n        conversationId: convId,\r\n      });\r\n\r\n      // 9. Refresh notes\r\n      client.emit('chat:notes-updated', { conversationId: convId, count: 0 });\r\n\r\n      this.logger.log({\r\n        message: 'AI task execution completed',\r\n        taskId: payload.taskId,\r\n        contentLength: fullContent.length,\r\n      });\r\n\r\n      // 10. Auto-trigger AI Score after completion\r\n      try {\r\n        client.emit('task:scoring-start', { taskId: payload.taskId });\r\n        const {\r\n          score,\r\n          result,\r\n          conversationId: scoredConvId,\r\n        } = await this.scoreTaskInternal(\r\n          client,\r\n          payload.taskId,\r\n          authenticatedClient.tenantId,\r\n          authenticatedClient.userId\r\n        );\r\n        client.emit('task:result-complete', {\r\n          taskId: payload.taskId,\r\n          conversationId: scoredConvId,\r\n          score,\r\n          finalResult: result,\r\n          timestamp: new Date().toISOString(),\r\n        });\r\n        client.emit('chat:notes-updated', { conversationId: scoredConvId, count: 0 });\r\n      } catch (scoreErr) {\r\n        this.logger.warn({\r\n          message: 'Auto-scoring failed after AI task execution',\r\n          taskId: payload.taskId,\r\n          error: scoreErr instanceof Error ? scoreErr.message : 'Unknown error',\r\n        });\r\n        // Non-fatal  task stays COMPLETED, user can manually retry via \"Get AI Score\"\r\n      }\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'AI task execution failed',\r\n        taskId: payload.taskId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('task:ai-error', {\r\n        taskId: payload.taskId,\r\n        conversationId: payload.conversationId,\r\n        message: 'Izvravanje zadatka nije uspelo. Pokuajte ponovo.',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Internal scoring logic: loads task, builds context, streams optimization + score.\r\n   * Used by both manual \"Get AI Score\" and auto-scoring after AI Popuni.\r\n   */\r\n  private async scoreTaskInternal(\r\n    client: Socket,\r\n    taskId: string,\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<{ score: number | null; result: string; conversationId: string | null }> {\r\n    // 1. Load the completed task note\r\n    const task = await this.prisma.note.findUnique({\r\n      where: { id: taskId },\r\n    });\r\n    if (!task || task.tenantId !== tenantId) {\r\n      throw new Error('Zadatak nije pronaen');\r\n    }\r\n    if (task.status !== 'COMPLETED' || !task.userReport) {\r\n      throw new Error('Zadatak nema izvetaj za ocenjivanje');\r\n    }\r\n\r\n    // 2. Build context for scoring\r\n    const businessContext = await this.buildBusinessContext(tenantId, userId);\r\n\r\n    let conceptContext = '';\r\n    if (task.conceptId) {\r\n      try {\r\n        const concept = await this.conceptService.findById(task.conceptId);\r\n        conceptContext = `\\n\\nKONCEPT: ${concept.name} (${concept.category})`;\r\n        conceptContext += `\\nDEFINICIJA: ${concept.definition}`;\r\n        if (concept.extendedDescription) {\r\n          conceptContext += `\\nDETALJNO: ${concept.extendedDescription.substring(0, 500)}`;\r\n        }\r\n      } catch {\r\n        /* concept not found */\r\n      }\r\n    }\r\n\r\n    let tenantInfo = '';\r\n    try {\r\n      const tenant = await this.prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        select: { name: true, industry: true, description: true },\r\n      });\r\n      if (tenant) {\r\n        tenantInfo = `\\nKOMPANIJA: ${tenant.name}${tenant.industry ? ` | INDUSTRIJA: ${tenant.industry}` : ''}`;\r\n      }\r\n    } catch {\r\n      /* non-blocking */\r\n    }\r\n\r\n    // 3. Build the optimization + scoring prompt\r\n    const prompt = `Ti si senior poslovni konsultant koji recenzira deliverable-e za klijenta. Tvoj zadatak je da:\r\n\r\n1. OPTIMIZUJE rezultat  napravi finalnu, poliranu verziju dokumenta:\r\n   - Poboljaj strukturu (## zaglavlja, tabele, nabrajanja)\r\n   - Dodaj konkretne brojke, rokove i metrike gde nedostaju\r\n   - Zameni generike preporuke SPECIFINIM akcijama prilagoenim kompaniji\r\n   - Ukloni redundantni tekst i ponavljanja\r\n   - Dodaj sekciju \"Sledei koraci\" ako ne postoji\r\n\r\n2. OCENI rezultat po 5 kriterijuma (svaki 1-10):\r\n   - PRIMENLJIVOST: Da li se moe odmah implementirati bez dodatnog istraivanja?\r\n   - SPECIFINOST: Da li sadri konkretne brojke, nazive, rokove, a ne generike savete?\r\n   - KOMPLETNOST: Da li pokriva sve aspekte zadatka i oekivanog rezultata?\r\n   - RELEVANTNOST: Da li je prilagoen industriji i specifinim potrebama kompanije?\r\n   - KVALITET: Da li je profesionalno strukturiran, jasan i bez greaka?\r\n${tenantInfo}${conceptContext}\r\n\r\nZADATAK: ${task.title}\r\n${task.content ? `OPIS: ${task.content}` : ''}\r\n${task.expectedOutcome ? `OEKIVANI REZULTAT: ${task.expectedOutcome}` : ''}\r\n\r\nIZLAZ KOJI TREBA OCENITI I OPTIMIZOVATI:\r\n${task.userReport}\r\n\r\nFORMAT ODGOVORA:\r\n1. Napii OPTIMIZOVANI REZULTAT (kompletan dokument, ne samo izmene)\r\n2. Na samom kraju dodaj:\r\n---\r\nEVALUACIJA:\r\n- Primenljivost: X/10\r\n- Specifinost: X/10\r\n- Kompletnost: X/10\r\n- Relevantnost: X/10\r\n- Kvalitet: X/10\r\nOCENA: X/10\r\n---\r\n\r\nGde je OCENA prosek svih pet kriterijuma (zaokruen na ceo broj).\r\nOdgovaraj ISKLJUIVO na srpskom jeziku.`;\r\n\r\n    // 4. Stream the optimized result\r\n    let fullResult = '';\r\n    let chunkIndex = 0;\r\n\r\n    await this.aiGatewayService.streamCompletionWithContext(\r\n      [{ role: 'user', content: prompt }],\r\n      {\r\n        tenantId,\r\n        userId,\r\n        conversationId: task.conversationId ?? undefined,\r\n        businessContext,\r\n      },\r\n      (chunk: string) => {\r\n        fullResult += chunk;\r\n        client.emit('task:result-chunk', {\r\n          taskId,\r\n          conversationId: task.conversationId,\r\n          content: chunk,\r\n          index: chunkIndex++,\r\n        });\r\n      }\r\n    );\r\n\r\n    // 5. Extract score from the result (only accept 1-10)\r\n    let score: number | null = null;\r\n    const scoreMatch = fullResult.match(/OCENA:\\s*(\\d{1,2})\\s*\\/\\s*10/i);\r\n    if (scoreMatch) {\r\n      const rawScore = parseInt(scoreMatch[1]!, 10);\r\n      if (rawScore >= 1 && rawScore <= 10) {\r\n        score = rawScore * 10; // Scale 1-10  10-100\r\n      }\r\n    }\r\n\r\n    // 6. Update the task note with optimized result and score\r\n    await this.prisma.note.update({\r\n      where: { id: taskId },\r\n      data: {\r\n        userReport: fullResult,\r\n        aiScore: score,\r\n        aiFeedback: score !== null ? `AI ocena: ${score}/100` : null,\r\n      },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Task scoring completed',\r\n      taskId,\r\n      score,\r\n      resultLength: fullResult.length,\r\n    });\r\n\r\n    return { score, result: fullResult, conversationId: task.conversationId };\r\n  }\r\n\r\n  /**\r\n   * Story 3.12: Handles \"Submit Result\"  takes completed task output,\r\n   * produces an optimized final deliverable, and scores it 1-10.\r\n   */\r\n  @SubscribeMessage('task:submit-result')\r\n  async handleSubmitTaskResult(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { taskId: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    try {\r\n      this.logger.log({\r\n        message: 'Task result submission requested',\r\n        userId: authenticatedClient.userId,\r\n        taskId: payload.taskId,\r\n      });\r\n\r\n      // Emit start acknowledgment\r\n      client.emit('task:result-start', {\r\n        taskId: payload.taskId,\r\n        conversationId: null,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n\r\n      const { score, result, conversationId } = await this.scoreTaskInternal(\r\n        client,\r\n        payload.taskId,\r\n        authenticatedClient.tenantId,\r\n        authenticatedClient.userId\r\n      );\r\n\r\n      // Emit completion\r\n      client.emit('task:result-complete', {\r\n        taskId: payload.taskId,\r\n        conversationId,\r\n        score,\r\n        finalResult: result,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n\r\n      // Refresh notes\r\n      client.emit('chat:notes-updated', { conversationId, count: 0 });\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Task result submission failed',\r\n        taskId: payload.taskId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('task:result-error', {\r\n        taskId: payload.taskId,\r\n        conversationId: null,\r\n        message:\r\n          error instanceof Error\r\n            ? error.message\r\n            : 'Ocenjivanje rezultata nije uspelo. Pokuajte ponovo.',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles YOLO autonomous execution start.\r\n   * Loads all pending tasks, creates per-concept conversations, and starts the scheduler.\r\n   */\r\n  @SubscribeMessage('workflow:start-yolo')\r\n  async handleStartYolo(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { conversationId: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    try {\r\n      this.logger.log({\r\n        message: 'YOLO execution requested',\r\n        userId: authenticatedClient.userId,\r\n        conversationId: payload.conversationId,\r\n      });\r\n\r\n      // Load all pending TASK notes for this tenant\r\n      const tasks = await this.prisma.note.findMany({\r\n        where: {\r\n          tenantId: authenticatedClient.tenantId,\r\n          noteType: 'TASK',\r\n          status: 'PENDING',\r\n        },\r\n      });\r\n\r\n      if (tasks.length === 0) {\r\n        client.emit('workflow:error', {\r\n          message: 'No pending tasks found',\r\n          conversationId: payload.conversationId,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Create per-concept conversations\r\n      const conceptConversations = new Map<string, string>();\r\n      const conceptIds = [...new Set(tasks.filter((t) => t.conceptId).map((t) => t.conceptId!))];\r\n\r\n      for (const conceptId of conceptIds) {\r\n        const conceptName = tasks.find((t) => t.conceptId === conceptId)?.title ?? 'Zadatak';\r\n        try {\r\n          const conv = await this.conversationService.createConversation(\r\n            authenticatedClient.tenantId,\r\n            authenticatedClient.userId,\r\n            conceptName,\r\n            undefined,\r\n            conceptId\r\n          );\r\n          conceptConversations.set(conceptId, conv.id);\r\n        } catch (err) {\r\n          this.logger.warn({\r\n            message: 'Failed to create concept conversation for YOLO',\r\n            conceptId,\r\n            error: err instanceof Error ? err.message : 'Unknown',\r\n          });\r\n        }\r\n      }\r\n\r\n      // Notify frontend about created conversations\r\n      const conversationsPayload = {\r\n        planId: 'yolo-pending',\r\n        conversations: conceptIds\r\n          .filter((id) => conceptConversations.has(id))\r\n          .map((id) => ({\r\n            conceptId: id,\r\n            conceptName: tasks.find((t) => t.conceptId === id)?.title ?? '',\r\n            conversationId: conceptConversations.get(id)!,\r\n          })),\r\n        originalConversationId: payload.conversationId,\r\n      };\r\n      client.emit('workflow:conversations-created', conversationsPayload);\r\n\r\n      // Start YOLO scheduler\r\n      const executionBudget = parseInt(process.env['YOLO_EXECUTION_BUDGET'] ?? '50', 10);\r\n      const config = {\r\n        maxConcurrency: 3,\r\n        maxConceptsHardStop: 1000,\r\n        retryAttempts: 3,\r\n        maxExecutionBudget: executionBudget,\r\n      };\r\n\r\n      this.yoloScheduler\r\n        .startYoloExecution(\r\n          authenticatedClient.tenantId,\r\n          authenticatedClient.userId,\r\n          payload.conversationId,\r\n          config,\r\n          {\r\n            onProgress: (progress) => {\r\n              client.emit('workflow:yolo-progress', progress);\r\n            },\r\n            onComplete: (result) => {\r\n              client.emit('workflow:yolo-complete', result);\r\n              client.emit('chat:notes-updated', {\r\n                conversationId: payload.conversationId,\r\n                count: 0,\r\n              });\r\n            },\r\n            onError: (error) => {\r\n              client.emit('workflow:error', {\r\n                message: error,\r\n                conversationId: payload.conversationId,\r\n              });\r\n            },\r\n            saveMessage: async (_role, content, conceptId) => {\r\n              const targetConvId =\r\n                conceptId && conceptConversations.has(conceptId)\r\n                  ? conceptConversations.get(conceptId)!\r\n                  : payload.conversationId;\r\n              const msg = await this.conversationService.addMessage(\r\n                authenticatedClient.tenantId,\r\n                targetConvId,\r\n                MessageRole.ASSISTANT,\r\n                content\r\n              );\r\n              return msg.id;\r\n            },\r\n            createConversationForConcept: async (conceptId: string, conceptName: string) => {\r\n              try {\r\n                const conv = await this.conversationService.createConversation(\r\n                  authenticatedClient.tenantId,\r\n                  authenticatedClient.userId,\r\n                  conceptName,\r\n                  undefined,\r\n                  conceptId\r\n                );\r\n                conceptConversations.set(conceptId, conv.id);\r\n                client.emit('workflow:conversations-created', {\r\n                  planId: 'yolo-discovery',\r\n                  conversations: [{ conceptId, conceptName, conversationId: conv.id }],\r\n                  originalConversationId: payload.conversationId,\r\n                });\r\n                return conv.id;\r\n              } catch (err) {\r\n                this.logger.warn({\r\n                  message: 'Failed to create conversation for discovered concept',\r\n                  conceptId,\r\n                  error: err instanceof Error ? err.message : 'Unknown',\r\n                });\r\n                return null;\r\n              }\r\n            },\r\n            onConceptDiscovered: (\r\n              conceptId: string,\r\n              conceptName: string,\r\n              discoveredConversationId: string\r\n            ) => {\r\n              client.emit('chat:concept-detected', {\r\n                conversationId: payload.conversationId,\r\n                conceptId,\r\n                conceptName,\r\n                discoveredConversationId,\r\n              });\r\n            },\r\n          },\r\n          conceptConversations\r\n        )\r\n        .catch((err: unknown) => {\r\n          this.logger.error({\r\n            message: 'YOLO execution failed',\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n          client.emit('workflow:error', {\r\n            message: err instanceof Error ? err.message : 'YOLO execution failed',\r\n            conversationId: payload.conversationId,\r\n          });\r\n        });\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to start YOLO execution',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('workflow:error', {\r\n        message: error instanceof Error ? error.message : 'Failed to start YOLO',\r\n        conversationId: payload.conversationId,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Story 3.2: Handles per-domain YOLO execution start.\r\n   * Scopes YOLO to a single category (domain).\r\n   */\r\n  @SubscribeMessage('yolo:start-domain')\r\n  async handleStartDomainYolo(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { conversationId: string; category: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    try {\r\n      this.logger.log({\r\n        message: 'Per-domain YOLO requested',\r\n        userId: authenticatedClient.userId,\r\n        category: payload.category,\r\n        conversationId: payload.conversationId,\r\n      });\r\n\r\n      // Create per-concept conversations for discovered tasks\r\n      const conceptConversations = new Map<string, string>();\r\n\r\n      // Start YOLO with category scoping\r\n      const executionBudget = parseInt(process.env['YOLO_EXECUTION_BUDGET'] ?? '50', 10);\r\n      const config = {\r\n        maxConcurrency: 3,\r\n        maxConceptsHardStop: 100,\r\n        retryAttempts: 3,\r\n        maxExecutionBudget: executionBudget,\r\n      };\r\n\r\n      this.yoloScheduler\r\n        .startYoloExecution(\r\n          authenticatedClient.tenantId,\r\n          authenticatedClient.userId,\r\n          payload.conversationId,\r\n          config,\r\n          {\r\n            onProgress: (progress) => {\r\n              client.emit('workflow:yolo-progress', progress);\r\n            },\r\n            onComplete: (result) => {\r\n              client.emit('workflow:yolo-complete', result);\r\n              client.emit('chat:notes-updated', {\r\n                conversationId: payload.conversationId,\r\n                count: 0,\r\n              });\r\n            },\r\n            onError: (error) => {\r\n              client.emit('workflow:error', {\r\n                message: error,\r\n                conversationId: payload.conversationId,\r\n              });\r\n            },\r\n            saveMessage: async (_role, content, conceptId) => {\r\n              const targetConvId =\r\n                conceptId && conceptConversations.has(conceptId)\r\n                  ? conceptConversations.get(conceptId)!\r\n                  : payload.conversationId;\r\n              const msg = await this.conversationService.addMessage(\r\n                authenticatedClient.tenantId,\r\n                targetConvId,\r\n                MessageRole.ASSISTANT,\r\n                content\r\n              );\r\n              return msg.id;\r\n            },\r\n            createConversationForConcept: async (conceptId: string, conceptName: string) => {\r\n              try {\r\n                const conv = await this.conversationService.createConversation(\r\n                  authenticatedClient.tenantId,\r\n                  authenticatedClient.userId,\r\n                  conceptName,\r\n                  undefined,\r\n                  conceptId\r\n                );\r\n                conceptConversations.set(conceptId, conv.id);\r\n                client.emit('workflow:conversations-created', {\r\n                  planId: 'yolo-domain',\r\n                  conversations: [{ conceptId, conceptName, conversationId: conv.id }],\r\n                  originalConversationId: payload.conversationId,\r\n                });\r\n                return conv.id;\r\n              } catch (err) {\r\n                this.logger.warn({\r\n                  message: 'Failed to create conversation for domain YOLO concept',\r\n                  conceptId,\r\n                  error: err instanceof Error ? err.message : 'Unknown',\r\n                });\r\n                return null;\r\n              }\r\n            },\r\n            onConceptDiscovered: (\r\n              conceptId: string,\r\n              conceptName: string,\r\n              discoveredConversationId: string\r\n            ) => {\r\n              client.emit('chat:concept-detected', {\r\n                conversationId: payload.conversationId,\r\n                conceptId,\r\n                conceptName,\r\n                discoveredConversationId,\r\n              });\r\n            },\r\n          },\r\n          conceptConversations,\r\n          payload.category // Story 3.2: per-domain scope\r\n        )\r\n        .catch((err: unknown) => {\r\n          this.logger.error({\r\n            message: 'Domain YOLO execution failed',\r\n            category: payload.category,\r\n            error: err instanceof Error ? err.message : 'Unknown error',\r\n          });\r\n          client.emit('workflow:error', {\r\n            message: err instanceof Error ? err.message : 'Domain YOLO failed',\r\n            conversationId: payload.conversationId,\r\n          });\r\n        });\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Failed to start domain YOLO',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('workflow:error', {\r\n        message: error instanceof Error ? error.message : 'Failed to start domain YOLO',\r\n        conversationId: payload.conversationId,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Builds, auto-approves, and executes a workflow plan for welcome conversation.\r\n   * Skips the plan overlay  user sees inline progress directly.\r\n   */\r\n  private async autoExecuteWorkflow(\r\n    client: Socket,\r\n    taskIds: string[],\r\n    conversationId: string\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n\r\n    // 1. Build the plan\r\n    const plan = await this.workflowService.buildExecutionPlan(\r\n      taskIds,\r\n      authenticatedClient.userId,\r\n      authenticatedClient.tenantId,\r\n      conversationId\r\n    );\r\n    const totalSteps = plan.steps.length;\r\n\r\n    // 2. Create per-concept conversations\r\n    const conceptConversations = new Map<string, string>();\r\n    const conceptIds = [...new Set(plan.steps.map((s: ExecutionPlanStep) => s.conceptId))];\r\n\r\n    for (const conceptId of conceptIds) {\r\n      const conceptName =\r\n        plan.steps.find((s: ExecutionPlanStep) => s.conceptId === conceptId)?.conceptName ??\r\n        'Zadatak';\r\n      try {\r\n        const conv = await this.conversationService.createConversation(\r\n          authenticatedClient.tenantId,\r\n          authenticatedClient.userId,\r\n          conceptName,\r\n          undefined,\r\n          conceptId\r\n        );\r\n        conceptConversations.set(conceptId, conv.id);\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Failed to create concept conversation',\r\n          conceptId,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    // 3. Notify frontend about created conversations\r\n    const conversationsCreated: WorkflowConversationsCreatedPayload = {\r\n      planId: plan.planId,\r\n      conversations: conceptIds\r\n        .filter((id) => conceptConversations.has(id))\r\n        .map((id) => ({\r\n          conceptId: id,\r\n          conceptName:\r\n            plan.steps.find((s: ExecutionPlanStep) => s.conceptId === id)?.conceptName ?? '',\r\n          conversationId: conceptConversations.get(id)!,\r\n        })),\r\n      originalConversationId: conversationId,\r\n    };\r\n    client.emit('workflow:conversations-created', conversationsCreated);\r\n\r\n    // Auto-navigate frontend to the first concept conversation\r\n    const firstConv = conversationsCreated.conversations[0];\r\n    if (firstConv) {\r\n      const navEvent: WorkflowNavigatePayload = {\r\n        planId: plan.planId,\r\n        conversationId: firstConv.conversationId,\r\n        conceptName: firstConv.conceptName,\r\n      };\r\n      client.emit('workflow:navigate-to-conversation', navEvent);\r\n    }\r\n\r\n    // 4. Execute immediately (no plan overlay)\r\n    this.workflowService\r\n      .executePlan(\r\n        plan.planId,\r\n        conversationId,\r\n        authenticatedClient.userId,\r\n        authenticatedClient.tenantId,\r\n        {\r\n          onStepStart: (stepId) => {\r\n            const stepInfo = plan.steps.find((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const stepIndex = plan.steps.findIndex((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const event: WorkflowStepProgressPayload = {\r\n              planId: plan.planId,\r\n              stepId,\r\n              stepTitle: stepInfo?.title,\r\n              stepIndex,\r\n              totalSteps,\r\n              status: 'in_progress',\r\n              conversationId,\r\n            };\r\n            client.emit('workflow:step-progress', event);\r\n          },\r\n          onStepChunk: (_stepId, chunk) => {\r\n            client.emit('chat:message-chunk', { content: chunk, index: -1 });\r\n          },\r\n          onStepComplete: (stepId, fullContent, citations) => {\r\n            const stepInfo = plan.steps.find((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const stepIndex = plan.steps.findIndex((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const event: WorkflowStepProgressPayload = {\r\n              planId: plan.planId,\r\n              stepId,\r\n              stepTitle: stepInfo?.title,\r\n              stepIndex,\r\n              totalSteps,\r\n              status: 'completed',\r\n              content: fullContent,\r\n              citations,\r\n              conversationId,\r\n            };\r\n            client.emit('workflow:step-progress', event);\r\n\r\n            // Emit complete step message for chat rendering\r\n            const stepMsg: WorkflowStepMessagePayload = {\r\n              planId: plan.planId,\r\n              conversationId,\r\n              messageId: stepId,\r\n              content: fullContent,\r\n              stepIndex,\r\n              totalSteps,\r\n              inputType: 'confirmation',\r\n              conceptName: stepInfo?.conceptName ?? '',\r\n            };\r\n            client.emit('workflow:step-message', stepMsg);\r\n          },\r\n          onStepFailed: (stepId, error) => {\r\n            const stepInfo = plan.steps.find((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const stepIndex = plan.steps.findIndex((s: ExecutionPlanStep) => s.stepId === stepId);\r\n            const event: WorkflowStepProgressPayload = {\r\n              planId: plan.planId,\r\n              stepId,\r\n              stepTitle: stepInfo?.title,\r\n              stepIndex,\r\n              totalSteps,\r\n              status: 'failed',\r\n              content: error,\r\n              conversationId,\r\n            };\r\n            client.emit('workflow:step-progress', event);\r\n          },\r\n          onStepAwaitingConfirmation: (upcomingStep) => {\r\n            const stepIndex = plan.steps.findIndex(\r\n              (s: ExecutionPlanStep) => s.stepId === upcomingStep.stepId\r\n            );\r\n            const event: WorkflowStepConfirmationPayload = {\r\n              planId: plan.planId,\r\n              completedStepId: '',\r\n              nextStep: {\r\n                stepId: upcomingStep.stepId,\r\n                title: upcomingStep.title,\r\n                description: upcomingStep.description,\r\n                conceptName: upcomingStep.conceptName,\r\n                stepIndex,\r\n                totalSteps,\r\n              },\r\n              conversationId,\r\n            };\r\n            client.emit('workflow:step-awaiting-confirmation', event);\r\n\r\n            // New interactive event with inputType discriminator\r\n            const inputEvent: WorkflowStepAwaitingInputPayload = {\r\n              planId: plan.planId,\r\n              stepId: upcomingStep.stepId,\r\n              stepTitle: upcomingStep.title,\r\n              stepDescription: upcomingStep.description,\r\n              conceptName: upcomingStep.conceptName,\r\n              stepIndex,\r\n              totalSteps,\r\n              inputType: 'confirmation',\r\n              conversationId,\r\n            };\r\n            client.emit('workflow:step-awaiting-input', inputEvent);\r\n          },\r\n          onComplete: (status, completedSteps, totalStepsCount) => {\r\n            const event: WorkflowCompletePayload = {\r\n              planId: plan.planId,\r\n              status,\r\n              completedSteps,\r\n              totalSteps: totalStepsCount,\r\n              conversationId,\r\n            };\r\n            client.emit('workflow:complete', event);\r\n            client.emit('chat:notes-updated', { conversationId, count: 0 });\r\n          },\r\n          onTasksDiscovered: (newConceptIds) => {\r\n            client.emit('tree:tasks-discovered', {\r\n              conceptIds: newConceptIds,\r\n              conversationId,\r\n              timestamp: new Date().toISOString(),\r\n            });\r\n          },\r\n          saveMessage: async (_role, content, conceptId) => {\r\n            const targetConvId =\r\n              conceptId && conceptConversations.has(conceptId)\r\n                ? conceptConversations.get(conceptId)!\r\n                : conversationId;\r\n            const msg = await this.conversationService.addMessage(\r\n              authenticatedClient.tenantId,\r\n              targetConvId,\r\n              MessageRole.ASSISTANT,\r\n              content\r\n            );\r\n            return msg.id;\r\n          },\r\n        }\r\n      )\r\n      .catch((err: unknown) => {\r\n        this.logger.error({\r\n          message: 'Auto-execute plan failed',\r\n          planId: plan.planId,\r\n          error: err instanceof Error ? err.message : 'Unknown error',\r\n        });\r\n        client.emit('workflow:error', {\r\n          planId: plan.planId,\r\n          message: err instanceof Error ? err.message : 'Execution failed',\r\n          conversationId,\r\n        });\r\n      });\r\n  }\r\n\r\n  //  Discovery Chat (Story 2.17) \r\n\r\n  /**\r\n   * Handles discovery chat messages.\r\n   * Ephemeral: no conversation persistence, no concept matching.\r\n   * Web search enabled for supplementing responses.\r\n   */\r\n  @SubscribeMessage('discovery:send-message')\r\n  async handleDiscoveryMessage(\r\n    @ConnectedSocket() client: Socket,\r\n    @MessageBody() payload: { content: string }\r\n  ): Promise<void> {\r\n    const authenticatedClient = client as AuthenticatedSocket;\r\n    const { content } = payload;\r\n\r\n    if (!content) {\r\n      client.emit('discovery:error', {\r\n        message: 'content is required for discovery chat',\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Build business context: tenant profile + business brain memories in parallel\r\n      const [businessContext, brainMemoryContext] = await Promise.all([\r\n        this.buildBusinessContext(authenticatedClient.tenantId, authenticatedClient.userId),\r\n        this.businessContextService\r\n          .getBusinessContext(authenticatedClient.tenantId)\r\n          .catch(() => ''),\r\n      ]);\r\n\r\n      // Web search for discovery context\r\n      let webContext = '';\r\n      if (this.webSearchService.isAvailable()) {\r\n        try {\r\n          const results = await this.webSearchService.searchAndExtract(content, 3);\r\n          if (results.length > 0) {\r\n            webContext = this.webSearchService.formatSourcesAsObsidian(results);\r\n          }\r\n        } catch {\r\n          // Non-blocking: skip web search on failure\r\n        }\r\n      }\r\n\r\n      const systemPrompt = `Ti si poslovni asistent koji pomae korisniku da istrai i razume poslovne teme.\r\nOdgovaraj precizno na srpskom jeziku.\r\n\r\nFORMATIRANJE (OBAVEZNO):\r\n- Organizuj odgovor sa ## naslovom za svaku sekciju\r\n- Koristi **bold** za kljune termine\r\n- Koristi bullet liste za nabrajanje\r\n- Koristi tabele za numerike podatke ili poreenja\r\n- Koristi callout blokove: > **Kljuni uvid:** ... ili > **Rezime:** ...\r\n- Ako ima web izvore, citiraj INLINE: ([Naziv](URL))\r\n\r\n${businessContext}${brainMemoryContext ? '\\n' + brainMemoryContext : ''}${webContext}`;\r\n\r\n      // Stream response via discovery-specific events (no persistence)\r\n      let fullContent = '';\r\n      let chunkIndex = 0;\r\n\r\n      await this.aiGatewayService.streamCompletionWithContext(\r\n        [{ role: 'user', content }],\r\n        {\r\n          tenantId: authenticatedClient.tenantId,\r\n          userId: authenticatedClient.userId,\r\n          businessContext: systemPrompt,\r\n        },\r\n        (chunk: string) => {\r\n          fullContent += chunk;\r\n          client.emit('discovery:message-chunk', {\r\n            chunk,\r\n            index: chunkIndex++,\r\n          });\r\n        }\r\n      );\r\n\r\n      client.emit('discovery:message-complete', {\r\n        fullContent,\r\n        totalChunks: chunkIndex,\r\n      });\r\n\r\n      this.logger.log({\r\n        message: 'Discovery chat message processed',\r\n        userId: authenticatedClient.userId,\r\n        contentLength: content.length,\r\n        responseLength: fullContent.length,\r\n        webSearchUsed: webContext.length > 0,\r\n      });\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'Discovery chat message failed',\r\n        userId: authenticatedClient.userId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      client.emit('discovery:error', {\r\n        message: error instanceof Error ? error.message : 'Discovery chat failed',\r\n      });\r\n    }\r\n  }\r\n\r\n  private async buildBusinessContext(tenantId: string, userId: string): Promise<string> {\r\n    try {\r\n      const [tenant, onboardingNote] = await Promise.all([\r\n        this.prisma.tenant.findUnique({\r\n          where: { id: tenantId },\r\n          select: { name: true, industry: true, description: true },\r\n        }),\r\n        this.notesService.getLatestNoteBySource(userId, tenantId, NoteSource.ONBOARDING),\r\n      ]);\r\n\r\n      if (!tenant) {\r\n        return '';\r\n      }\r\n\r\n      // Core identity  this is the base system prompt when no persona is set\r\n      let context = `Ti si poslovni savetnik za kompaniju \"${tenant.name}\".\r\nTvoj cilj: pruaj konkretne, upotrebljive savete prilagoene OVOM poslovanju. Misli kao iskusan konsultant koji poznaje ovu kompaniju iznutra.\r\n\r\n--- POSLOVNI KONTEKST ---\r\nKompanija: ${tenant.name}`;\r\n      if (tenant.industry) {\r\n        context += `\\nIndustrija: ${tenant.industry}`;\r\n      }\r\n      if (tenant.description) {\r\n        context += `\\nOpis: ${tenant.description}`;\r\n      }\r\n\r\n      if (onboardingNote?.content) {\r\n        // Truncate very long onboarding notes to keep prompt focused\r\n        const noteContent =\r\n          onboardingNote.content.length > 3000\r\n            ? onboardingNote.content.substring(0, 3000) + '\\n...(skraeno)'\r\n            : onboardingNote.content;\r\n        context += `\\n\\nPoslovna analiza (iz onboardinga):\\n${noteContent}`;\r\n      }\r\n\r\n      context += '\\n--- KRAJ POSLOVNOG KONTEKSTA ---';\r\n\r\n      // Output quality rules + mandatory formatting\r\n      context += `\r\n\r\n--- PRAVILA ZA ODGOVARANJE ---\r\n1. UVEK personalizuj odgovore za \"${tenant.name}\" (${tenant.industry ?? 'opte poslovanje'})  ne daj generike savete\r\n2. Koristi podatke iz POSLOVNOG KONTEKSTA, BAZE ZNANJA i MEMORIJE za konkretne preporuke\r\n3. Kada koristi znanje iz koncepta, oznai ga kao [[Naziv Koncepta]]\r\n4. Budi konkretan: umesto \"trebalo bi da razmotrite...\" reci ta tano treba uraditi i zato\r\n5. Ako ima web izvore, citiraj INLINE: ([Naziv izvora](URL))\r\n6. Odgovaraj ISKLJUIVO na srpskom jeziku\r\n7. Minimum 300 rei za pitanja koja zahtevaju analizu  ne daj povrne odgovore\r\n--- KRAJ PRAVILA ---\r\n\r\n--- FORMATIRANJE (STROGO OBAVEZNO  svaki odgovor MORA koristiti ove formate) ---\r\n1. SEKCIJE: Organizuj svaki odgovor sa ## naslovom za svaku sekciju.\r\n\r\n2. CALLOUT BLOKOVI (koristi MINIMUM 2 razliita tipa po odgovoru):\r\n> **Kljuni uvid:** Ovde ide najvaniji zakljuak ili preporuka.\r\n> **Upozorenje:** Ovde ide rizik, opasnost ili problem.\r\n> **Metrika:** Relevantni brojevi i KPI za datu oblast.\r\n> **Rezime:** Kratki zakljuak sa konkretnom preporukom.\r\n\r\n3. TABELE SA BROJEVIMA (OBAVEZNO kad god ima numerike podatke):\r\n| Kategorija | Vrednost | Promena |\r\n|------------|----------|---------|\r\n| Primer     | 100.000 | +15%    |\r\n\r\n4. OSTALA PRAVILA:\r\n- Koristi **bold** za sve kljune termine\r\n- Koristi bullet liste za nabrajanje, NE dugake paragrafe\r\n- NIKADA ne pii odgovor bez bar jednog callout bloka\r\n- Koristi tabele kada god ima numerike podatke ili poreenja\r\n--- KRAJ FORMATIRANJA ---`;\r\n\r\n      this.logger.log({\r\n        message: 'Business context built for chat',\r\n        tenantId,\r\n        userId,\r\n        hasOnboardingNote: !!onboardingNote,\r\n        contextLength: context.length,\r\n      });\r\n\r\n      return context;\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Failed to build business context, proceeding without it',\r\n        tenantId,\r\n        userId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      return '';\r\n    }\r\n  }\r\n\r\n  //  Multi-Step Orchestration: Research Brief Builder \r\n\r\n  private generateSearchAngles(query: string): string[] {\r\n    return [query, `${query} statistika podaci`, `${query} primeri best practice`];\r\n  }\r\n\r\n  private deduplicateConcepts(\r\n    concepts: import('@mentor-ai/shared/types').ConceptMatch[]\r\n  ): import('@mentor-ai/shared/types').ConceptMatch[] {\r\n    const map = new Map<string, import('@mentor-ai/shared/types').ConceptMatch>();\r\n    for (const c of concepts) {\r\n      const existing = map.get(c.conceptId);\r\n      if (!existing || c.score > existing.score) {\r\n        map.set(c.conceptId, c);\r\n      }\r\n    }\r\n    return Array.from(map.values());\r\n  }\r\n\r\n  private async buildResearchBrief(\r\n    userQuery: string,\r\n    existingContext: string,\r\n    existingConcepts: import('@mentor-ai/shared/types').ConceptMatch[],\r\n    webSearchEnabled: boolean,\r\n    personaType: import('@mentor-ai/shared/types').PersonaType | undefined,\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<string> {\r\n    const startTime = Date.now();\r\n    try {\r\n      this.logger.log({\r\n        message: 'Complex query detected  building research brief',\r\n        userQuery: userQuery.substring(0, 80),\r\n      });\r\n\r\n      const searchAngles = this.generateSearchAngles(userQuery);\r\n\r\n      // Parallel: deeper concept matching + web searches\r\n      const [deepConcepts, ...webResults] = await Promise.all([\r\n        this.conceptMatchingService.findRelevantConcepts(userQuery, { limit: 8, threshold: 0.35 }),\r\n        ...(webSearchEnabled\r\n          ? searchAngles.map((angle) =>\r\n              this.webSearchService.searchAndExtract(angle, 3).catch(() => [])\r\n            )\r\n          : []),\r\n      ]);\r\n\r\n      // Deduplicate and merge concepts\r\n      const allConcepts = this.deduplicateConcepts([...existingConcepts, ...deepConcepts]);\r\n      const topConcepts = allConcepts.slice(0, 6);\r\n\r\n      // Load full concept trees for top matches\r\n      const conceptDetails = await Promise.all(\r\n        topConcepts.map((c) => this.conceptService.findById(c.conceptId).catch(() => null))\r\n      );\r\n\r\n      // Build concept knowledge for brief\r\n      let conceptKnowledge = '';\r\n      for (const detail of conceptDetails) {\r\n        if (!detail) continue;\r\n        conceptKnowledge += `\\n## ${detail.name} (${detail.category})\\n${detail.definition?.substring(0, 500) ?? ''}\\n`;\r\n        const prereqs = detail.relatedConcepts\r\n          ?.filter((r) => r.relationshipType === 'PREREQUISITE' && r.direction === 'outgoing')\r\n          .map((r) => r.concept?.name)\r\n          .filter(Boolean);\r\n        if (prereqs?.length) {\r\n          conceptKnowledge += `Preduslovi: ${prereqs.join(', ')}\\n`;\r\n        }\r\n      }\r\n\r\n      // Deduplicate web results by link\r\n      const allWebResults = webResults.flat();\r\n      const seenLinks = new Set<string>();\r\n      const uniqueWeb = allWebResults.filter((r) => {\r\n        if (!r.link || seenLinks.has(r.link)) return false;\r\n        seenLinks.add(r.link);\r\n        return true;\r\n      });\r\n\r\n      let webKnowledge = '';\r\n      for (const r of uniqueWeb.slice(0, 8)) {\r\n        webKnowledge += `\\n- ${r.title}: ${r.snippet ?? ''}${r.pageContent ? ` | ${r.pageContent.substring(0, 300)}` : ''}\\n  Izvor: ${r.link}\\n`;\r\n      }\r\n\r\n      // Internal LLM call to synthesize research brief\r\n      const briefPrompt = `Na osnovu korisnikog pitanja i prikupljenih podataka, napravi ISTRAIVAKI BRIEF (500-800 rei).\r\n\r\nKORISNIKO PITANJE: ${userQuery}\r\n\r\nBAZA ZNANJA:\r\n${conceptKnowledge || '(nema koncepata)'}\r\n\r\nWEB ISTRAIVANJE:\r\n${webKnowledge || '(nema web rezultata)'}\r\n\r\nFORMAT BRIEFA:\r\n1. KLJUNA PITANJA: Koji su glavni aspekti korisnikog pitanja?\r\n2. NALAZI: Za svaki aspekt  ta govore podaci iz baze i weba?\r\n3. PRAZNINE: Koje informacije nedostaju?\r\n4. STRUKTURA ODGOVORA: Predloi logian raspored sekcija za finalni odgovor\r\n5. KONKRETNI PODACI: Navedi sve brojke, statistike, primere iz izvora`;\r\n\r\n      const briefMessages = [{ role: 'user' as const, content: briefPrompt }];\r\n\r\n      let briefContent = '';\r\n      const RESEARCH_TIMEOUT_MS = 10_000;\r\n\r\n      const briefResult = await Promise.race([\r\n        this.aiGatewayService.streamCompletionWithContext(\r\n          briefMessages,\r\n          {\r\n            tenantId,\r\n            userId,\r\n            conversationId: 'research-brief',\r\n            personaType,\r\n            messageCount: 1,\r\n            hasClientContext: false,\r\n            hasSpecificData: true,\r\n            userQuestion: userQuery,\r\n            businessContext: existingContext,\r\n          },\r\n          (chunk: string) => {\r\n            briefContent += chunk;\r\n          }\r\n        ),\r\n        new Promise<null>((resolve) => setTimeout(() => resolve(null), RESEARCH_TIMEOUT_MS)),\r\n      ]);\r\n\r\n      if (!briefResult || briefContent.length < 100) {\r\n        this.logger.warn({\r\n          message: 'Research brief too short or timed out, discarding',\r\n          length: briefContent.length,\r\n        });\r\n        return '';\r\n      }\r\n\r\n      this.logger.log({\r\n        message: 'Research brief completed',\r\n        duration: Date.now() - startTime,\r\n        briefLength: briefContent.length,\r\n        conceptCount: topConcepts.length,\r\n        webResultCount: uniqueWeb.length,\r\n      });\r\n\r\n      return briefContent;\r\n    } catch (error) {\r\n      this.logger.warn({\r\n        message: 'Research brief generation failed, falling back to single-pass',\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        duration: Date.now() - startTime,\r\n      });\r\n      return '';\r\n    }\r\n  }\r\n\r\n  private extractToken(client: Socket): string | null {\r\n    // Try Authorization header first\r\n    const authHeader = client.handshake.headers.authorization;\r\n    if (authHeader?.startsWith('Bearer ')) {\r\n      return authHeader.slice(7);\r\n    }\r\n\r\n    // Try socket.io auth option (client passes auth: { token })\r\n    const authToken = (client.handshake as any).auth?.token;\r\n    if (typeof authToken === 'string' && authToken) {\r\n      return authToken;\r\n    }\r\n\r\n    // Try query parameter\r\n    const token = client.handshake.query.token;\r\n    if (typeof token === 'string') {\r\n      return token;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  private async verifyToken(token: string): Promise<JwtPayload> {\r\n    return new Promise((resolve, reject) => {\r\n      const getKey = (\r\n        header: { kid?: string },\r\n        callback: (err: Error | null, key?: string) => void\r\n      ) => {\r\n        if (!header.kid) {\r\n          callback(new Error('No kid in token header'));\r\n          return;\r\n        }\r\n\r\n        this.jwksClient.getSigningKey(header.kid, (err, key) => {\r\n          if (err) {\r\n            callback(err);\r\n            return;\r\n          }\r\n          const signingKey = key?.getPublicKey();\r\n          callback(null, signingKey);\r\n        });\r\n      };\r\n\r\n      verify(\r\n        token,\r\n        getKey,\r\n        {\r\n          audience: this.auth0Audience,\r\n          issuer: `https://${this.auth0Domain}/`,\r\n          algorithms: ['RS256'],\r\n        },\r\n        (err, decoded) => {\r\n          if (err) {\r\n            reject(new UnauthorizedException('Invalid token'));\r\n          } else {\r\n            resolve(decoded as JwtPayload);\r\n          }\r\n        }\r\n      );\r\n    });\r\n  }\r\n}\r\n","module.exports = require(\"@nestjs/websockets\");","module.exports = require(\"socket.io\");","module.exports = require(\"jwks-rsa\");","import { Module } from '@nestjs/common';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { AiGatewayModule } from '../ai-gateway/ai-gateway.module';\r\nimport { NotesModule } from '../notes/notes.module';\r\nimport { KnowledgeModule } from '../knowledge/knowledge.module';\r\nimport { ConversationModule } from '../conversation/conversation.module';\r\nimport { WebSearchModule } from '../web-search/web-search.module';\r\nimport { FileUploadModule } from '../file-upload/file-upload.module';\r\nimport { WorkflowModule } from '../workflow/workflow.module';\r\nimport { OnboardingController } from './onboarding.controller';\r\nimport { OnboardingService } from './onboarding.service';\r\nimport { OnboardingMetricService } from './onboarding-metric.service';\r\n\r\n/**\r\n * Module for the onboarding quick win flow.\r\n * Provides sub-5-minute first value experience for new users.\r\n */\r\n@Module({\r\n  imports: [\r\n    TenantModule, // Provides PlatformPrismaService\r\n    AuthModule, // Provides AuthService for MfaRequiredGuard\r\n    AiGatewayModule, // Provides AiGatewayService\r\n    NotesModule, // Provides NotesService for saving onboarding output\r\n    KnowledgeModule, // Provides ConceptService for business brain\r\n    ConversationModule, // Provides ConversationService for welcome conversation\r\n    WebSearchModule, // Provides WebSearchService for website analysis\r\n    FileUploadModule, // Provides FileUploadService for PDF validation\r\n    WorkflowModule, // Provides WorkflowService for building execution plans\r\n  ],\r\n  controllers: [OnboardingController],\r\n  providers: [OnboardingService, OnboardingMetricService],\r\n  exports: [OnboardingService, OnboardingMetricService],\r\n})\r\nexport class OnboardingModule {}\r\n","import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Patch,\r\n  Body,\r\n  Param,\r\n  Headers,\r\n  HttpCode,\r\n  HttpStatus,\r\n  Logger,\r\n  UseGuards,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { OnboardingService } from './onboarding.service';\r\nimport type { UploadedFileType } from '../file-upload/file-upload.service';\r\nimport {\r\n  SetupCompanyDto,\r\n  QuickWinDto,\r\n  OnboardingCompleteDto,\r\n  BusinessContextDto,\r\n  SetDepartmentDto,\r\n} from './dto/quick-win.dto';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { MfaRequiredGuard } from '../auth/guards/mfa-required.guard';\r\nimport { SkipMfa } from '../auth/decorators/skip-mfa.decorator';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\nimport type {\r\n  OnboardingStatus,\r\n  QuickTask,\r\n  QuickWinResponse,\r\n  OnboardingCompleteResponse,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Controller for onboarding quick win flow.\r\n * Handles the wizard for sub-5-minute first value experience.\r\n * Requires authentication but skips MFA (onboarding happens before MFA setup).\r\n */\r\n@Controller('onboarding')\r\n@UseGuards(JwtAuthGuard, MfaRequiredGuard)\r\n@SkipMfa()\r\nexport class OnboardingController {\r\n  private readonly logger = new Logger(OnboardingController.name);\r\n\r\n  constructor(private readonly onboardingService: OnboardingService) {}\r\n\r\n  /**\r\n   * POST /api/onboarding/setup-company\r\n   * Saves company details during onboarding step 1.\r\n   */\r\n  @Post('setup-company')\r\n  @HttpCode(HttpStatus.OK)\r\n  async setupCompany(\r\n    @Body() dto: SetupCompanyDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: { success: boolean }; correlationId?: string }> {\r\n    this.logger.log({\r\n      message: 'Setting up company during onboarding',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      companyName: dto.companyName,\r\n      industry: dto.industry,\r\n      correlationId,\r\n    });\r\n\r\n    await this.onboardingService.setupCompany(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.companyName,\r\n      dto.industry,\r\n      dto.description,\r\n      dto.websiteUrl\r\n    );\r\n\r\n    return {\r\n      data: { success: true },\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * POST /api/onboarding/upload-brochure\r\n   * Extracts text from an uploaded PDF brochure for business context enrichment.\r\n   */\r\n  @Post('upload-brochure')\r\n  @HttpCode(HttpStatus.OK)\r\n  @UseInterceptors(FileInterceptor('brochure'))\r\n  async uploadBrochure(\r\n    @UploadedFile() file: UploadedFileType,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: { extractedText: string }; correlationId?: string }> {\r\n    if (!file) {\r\n      throw new BadRequestException({\r\n        type: 'no_file',\r\n        title: 'No File Uploaded',\r\n        status: 400,\r\n        detail: 'Please select a PDF file to upload',\r\n      });\r\n    }\r\n\r\n    if (file.mimetype !== 'application/pdf') {\r\n      throw new BadRequestException({\r\n        type: 'invalid_file_type',\r\n        title: 'Invalid File Type',\r\n        status: 400,\r\n        detail: 'Only PDF files are accepted',\r\n      });\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Uploading brochure PDF for text extraction',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      fileName: file.originalname,\r\n      fileSize: file.size,\r\n      correlationId,\r\n    });\r\n\r\n    const extractedText = await this.onboardingService.extractBrochureText(file.buffer);\r\n\r\n    this.logger.log({\r\n      message: 'Brochure text extracted successfully',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      extractedLength: extractedText.length,\r\n      correlationId,\r\n    });\r\n\r\n    return {\r\n      data: { extractedText },\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * POST /api/onboarding/analyse-business\r\n   * Generates AI-powered business analysis.\r\n   */\r\n  @Post('analyse-business')\r\n  @HttpCode(HttpStatus.OK)\r\n  async analyseBusiness(\r\n    @Body() dto: BusinessContextDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: { output: string; generationTimeMs: number }; correlationId?: string }> {\r\n    this.logger.log({\r\n      message: 'Analysing business during onboarding',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      correlationId,\r\n    });\r\n\r\n    const result = await this.onboardingService.analyseBusiness(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.businessState,\r\n      dto.departments\r\n    );\r\n\r\n    return {\r\n      data: result,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * POST /api/onboarding/create-business-brain\r\n   * Auto-generates personalized tasks and focus areas.\r\n   */\r\n  @Post('create-business-brain')\r\n  @HttpCode(HttpStatus.OK)\r\n  async createBusinessBrain(\r\n    @Body() dto: BusinessContextDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: { output: string; generationTimeMs: number }; correlationId?: string }> {\r\n    this.logger.log({\r\n      message: 'Creating business brain during onboarding',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      correlationId,\r\n    });\r\n\r\n    const result = await this.onboardingService.createBusinessBrain(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.businessState,\r\n      dto.departments\r\n    );\r\n\r\n    return {\r\n      data: result,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * GET /api/onboarding/status\r\n   * Returns the current onboarding status for the authenticated user.\r\n   */\r\n  @Get('status')\r\n  async getStatus(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: OnboardingStatus; correlationId?: string }> {\r\n    this.logger.log({\r\n      message: 'Getting onboarding status',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      correlationId,\r\n    });\r\n\r\n    const status = await this.onboardingService.getStatus(user.tenantId, user.userId);\r\n\r\n    return {\r\n      data: status,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * GET /api/onboarding/tasks\r\n   * Returns all available quick tasks.\r\n   */\r\n  @Get('tasks')\r\n  getAllTasks(@Headers('x-correlation-id') correlationId?: string): {\r\n    data: QuickTask[];\r\n    correlationId?: string;\r\n  } {\r\n    const tasks = this.onboardingService.getAllTasks();\r\n\r\n    return {\r\n      data: tasks,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * GET /api/onboarding/tasks/:industry\r\n   * Returns quick tasks filtered by industry/department.\r\n   */\r\n  @Get('tasks/:industry')\r\n  getTasksByIndustry(\r\n    @Param('industry') industry: string,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): { data: QuickTask[]; correlationId?: string } {\r\n    this.logger.log({\r\n      message: 'Getting tasks for industry',\r\n      industry,\r\n      correlationId,\r\n    });\r\n\r\n    const tasks = this.onboardingService.getTasksForIndustry(industry);\r\n\r\n    return {\r\n      data: tasks,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * POST /api/onboarding/quick-win\r\n   * Executes the quick win task using AI.\r\n   */\r\n  @Post('quick-win')\r\n  @HttpCode(HttpStatus.OK)\r\n  async executeQuickWin(\r\n    @Body() dto: QuickWinDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: QuickWinResponse; correlationId?: string }> {\r\n    this.logger.log({\r\n      message: 'Executing quick win',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      taskId: dto.taskId,\r\n      industry: dto.industry,\r\n      correlationId,\r\n    });\r\n\r\n    const result = await this.onboardingService.executeQuickWin(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.taskId,\r\n      dto.userContext,\r\n      dto.industry\r\n    );\r\n\r\n    return {\r\n      data: result,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * PATCH /api/onboarding/set-department\r\n   * Saves the user's department/role selection (Story 3.2).\r\n   */\r\n  @Patch('set-department')\r\n  @HttpCode(HttpStatus.OK)\r\n  async setDepartment(\r\n    @Body() dto: SetDepartmentDto,\r\n    @CurrentUser() user: CurrentUserPayload\r\n  ): Promise<{ data: { success: boolean } }> {\r\n    await this.onboardingService.setDepartment(user.userId, dto.department ?? null);\r\n    return { data: { success: true } };\r\n  }\r\n\r\n  /**\r\n   * POST /api/onboarding/complete\r\n   * Completes onboarding, saves the note, and transitions tenant to ACTIVE.\r\n   */\r\n  @Post('complete')\r\n  @HttpCode(HttpStatus.OK)\r\n  async completeOnboarding(\r\n    @Body() dto: OnboardingCompleteDto,\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Headers('x-correlation-id') correlationId?: string\r\n  ): Promise<{ data: OnboardingCompleteResponse; correlationId?: string }> {\r\n    this.logger.log({\r\n      message: 'Completing onboarding',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      taskId: dto.taskId,\r\n      correlationId,\r\n    });\r\n\r\n    const result = await this.onboardingService.completeOnboarding(\r\n      user.tenantId,\r\n      user.userId,\r\n      dto.taskId,\r\n      dto.generatedOutput,\r\n      dto.executionMode\r\n    );\r\n\r\n    return {\r\n      data: result,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n}\r\n","import { Injectable, Logger, NotFoundException, BadRequestException } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport {\r\n  TenantStatus as PrismaTenantStatus,\r\n  NoteSource,\r\n  NoteType,\r\n  NoteStatus,\r\n  UserRole,\r\n  Department,\r\n} from '@mentor-ai/shared/prisma';\r\nimport type {\r\n  OnboardingStatus,\r\n  QuickTask,\r\n  QuickWinResponse,\r\n  OnboardingCompleteResponse,\r\n  TenantStatus,\r\n  ConceptMatch,\r\n  MessageRole,\r\n} from '@mentor-ai/shared/types';\r\nimport { AiGatewayService } from '../ai-gateway/ai-gateway.service';\r\nimport { NotesService } from '../notes/notes.service';\r\nimport { ConceptService } from '../knowledge/services/concept.service';\r\nimport { ConceptMatchingService } from '../knowledge/services/concept-matching.service';\r\nimport { ConversationService } from '../conversation/conversation.service';\r\nimport { WebSearchService } from '../web-search/web-search.service';\r\nimport { BrainSeedingService } from '../knowledge/services/brain-seeding.service';\r\nimport { WorkflowService } from '../workflow/workflow.service';\r\nimport { OnboardingMetricService } from './onboarding-metric.service';\r\nimport {\r\n  QUICK_TASK_TEMPLATES,\r\n  getTasksByIndustry,\r\n  getTaskById,\r\n  generateSystemPrompt,\r\n  generateUserPrompt,\r\n} from './templates/quick-task-templates';\r\nimport { FOUNDATION_CATEGORIES } from '../knowledge/config/department-categories';\r\n\r\n/**\r\n * Service for managing the onboarding quick win flow.\r\n * Enables users to experience AI value within 5 minutes of registration.\r\n */\r\n@Injectable()\r\nexport class OnboardingService {\r\n  private readonly logger = new Logger(OnboardingService.name);\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly aiGateway: AiGatewayService,\r\n    private readonly notesService: NotesService,\r\n    private readonly metricService: OnboardingMetricService,\r\n    private readonly conceptService: ConceptService,\r\n    private readonly conceptMatchingService: ConceptMatchingService,\r\n    private readonly conversationService: ConversationService,\r\n    private readonly webSearchService: WebSearchService,\r\n    private readonly brainSeedingService: BrainSeedingService,\r\n    private readonly workflowService: WorkflowService\r\n  ) {}\r\n\r\n  /**\r\n   * Extracts text content from a PDF brochure buffer.\r\n   * Returns the extracted text, truncated to 3000 chars to fit within description limits.\r\n   */\r\n  async extractBrochureText(pdfBuffer: Buffer): Promise<string> {\r\n    const MAX_PDF_SIZE = 70 * 1024 * 1024; // 70MB\r\n    if (pdfBuffer.length > MAX_PDF_SIZE) {\r\n      throw new BadRequestException({\r\n        type: 'pdf_too_large',\r\n        title: 'PDF Too Large',\r\n        status: 400,\r\n        detail: 'PDF file must be 70MB or smaller',\r\n      });\r\n    }\r\n\r\n    let text: string;\r\n    try {\r\n      const { PDFParse } = await import('pdf-parse');\r\n      const parser = new PDFParse({ data: pdfBuffer });\r\n      const result = await parser.getText();\r\n      text = result.text?.trim() ?? '';\r\n      await parser.destroy();\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Failed to parse PDF',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      throw new BadRequestException({\r\n        type: 'pdf_parse_error',\r\n        title: 'PDF Parse Error',\r\n        status: 400,\r\n        detail: 'Could not extract text from this PDF. It may be image-only or corrupted.',\r\n      });\r\n    }\r\n    if (!text) {\r\n      throw new BadRequestException({\r\n        type: 'pdf_empty',\r\n        title: 'No Text Found',\r\n        status: 400,\r\n        detail: 'No text could be extracted from this PDF. It may be image-only.',\r\n      });\r\n    }\r\n\r\n    return text.substring(0, 3000);\r\n  }\r\n\r\n  /**\r\n   * Saves company details during onboarding step 1.\r\n   * Updates the tenant record with company name, industry, and description.\r\n   * Also creates/updates the User record so chat FK constraints are satisfied.\r\n   * Sets tenant status to ONBOARDING if currently DRAFT.\r\n   */\r\n  async setupCompany(\r\n    tenantId: string,\r\n    userId: string,\r\n    companyName: string,\r\n    industry: string,\r\n    description?: string,\r\n    websiteUrl?: string\r\n  ): Promise<void> {\r\n    this.logger.log({\r\n      message: 'Setting up company details',\r\n      tenantId,\r\n      userId,\r\n      companyName,\r\n      industry,\r\n      websiteUrl,\r\n    });\r\n\r\n    const existing = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n    });\r\n\r\n    if (existing) {\r\n      await this.prisma.tenant.update({\r\n        where: { id: tenantId },\r\n        data: {\r\n          name: companyName,\r\n          industry,\r\n          description: description ?? null,\r\n          status:\r\n            existing.status === PrismaTenantStatus.DRAFT\r\n              ? PrismaTenantStatus.ONBOARDING\r\n              : existing.status,\r\n        },\r\n      });\r\n    } else {\r\n      await this.prisma.tenant.create({\r\n        data: {\r\n          id: tenantId,\r\n          name: companyName,\r\n          industry,\r\n          description: description ?? null,\r\n          status: PrismaTenantStatus.ONBOARDING,\r\n        },\r\n      });\r\n    }\r\n\r\n    // Ensure User record exists (fixes chat FK violation)\r\n    await this.prisma.user.upsert({\r\n      where: { id: userId },\r\n      create: {\r\n        id: userId,\r\n        email: `${userId}@mentor-ai.local`,\r\n        name: companyName,\r\n        role: UserRole.TENANT_OWNER,\r\n        tenantId,\r\n      },\r\n      update: {},\r\n    });\r\n\r\n    // Fetch website content if URL provided  enrich description with extracted data\r\n    if (websiteUrl && this.webSearchService.isAvailable()) {\r\n      try {\r\n        const websiteContent = await this.webSearchService.fetchWebpage(websiteUrl);\r\n        if (websiteContent) {\r\n          const enrichedDesc = [\r\n            description,\r\n            `\\n\\n--- Website Content (${websiteUrl}) ---\\n${websiteContent}`,\r\n          ]\r\n            .filter(Boolean)\r\n            .join('');\r\n          await this.prisma.tenant.update({\r\n            where: { id: tenantId },\r\n            data: { description: enrichedDesc.substring(0, 5000) },\r\n          });\r\n          this.logger.log({\r\n            message: 'Enriched tenant description with website content',\r\n            tenantId,\r\n            websiteUrl,\r\n            contentLength: websiteContent.length,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Failed to fetch website content (non-blocking)',\r\n          websiteUrl,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    this.logger.log({\r\n      message: 'Company details and user record saved',\r\n      tenantId,\r\n      userId,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets the user's department during onboarding (Story 3.2).\r\n   * null = owner/CEO (sees all categories).\r\n   */\r\n  async setDepartment(userId: string, department: string | null): Promise<void> {\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { department: (department as Department) ?? null },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets the current onboarding status for a user.\r\n   */\r\n  async getStatus(tenantId: string, userId: string): Promise<OnboardingStatus> {\r\n    this.logger.log({\r\n      message: 'Getting onboarding status',\r\n      tenantId,\r\n      userId,\r\n    });\r\n\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { status: true },\r\n    });\r\n\r\n    if (!tenant) {\r\n      this.logger.log({\r\n        message: 'Tenant not found, returning DRAFT status for onboarding',\r\n        tenantId,\r\n      });\r\n      return {\r\n        currentStep: 1 as const,\r\n        tenantStatus: 'DRAFT' as TenantStatus,\r\n        selectedIndustry: undefined,\r\n        selectedTaskId: undefined,\r\n        startedAt: undefined,\r\n      };\r\n    }\r\n\r\n    // If user already has conversations, they've used the system  skip onboarding\r\n    const conversationCount = await this.prisma.conversation.count({\r\n      where: { userId },\r\n    });\r\n\r\n    if (conversationCount > 0) {\r\n      // Auto-upgrade tenant to ACTIVE if still in DRAFT/ONBOARDING\r\n      if (tenant.status === 'DRAFT' || tenant.status === 'ONBOARDING') {\r\n        await this.prisma.tenant.update({\r\n          where: { id: tenantId },\r\n          data: { status: 'ACTIVE' },\r\n        });\r\n        this.logger.log({\r\n          message: 'Auto-upgraded tenant to ACTIVE (user has existing conversations)',\r\n          tenantId,\r\n          userId,\r\n          conversationCount,\r\n        });\r\n      }\r\n      return {\r\n        currentStep: 'complete' as const,\r\n        tenantStatus: 'ACTIVE' as TenantStatus,\r\n        selectedIndustry: undefined,\r\n        selectedTaskId: undefined,\r\n        startedAt: undefined,\r\n      };\r\n    }\r\n\r\n    const metric = await this.metricService.getMetric(userId);\r\n\r\n    let currentStep: 1 | 2 | 3 | 'complete' = 1;\r\n    if (metric?.completedAt) {\r\n      currentStep = 'complete';\r\n    } else if (metric?.quickTaskType) {\r\n      currentStep = 3;\r\n    } else if (metric?.industry) {\r\n      currentStep = 2;\r\n    }\r\n\r\n    return {\r\n      currentStep,\r\n      tenantStatus: tenant.status as TenantStatus,\r\n      selectedIndustry: metric?.industry,\r\n      selectedTaskId: metric?.quickTaskType,\r\n      startedAt: metric?.startedAt,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Analyses the user's business using AI.\r\n   * Fetches tenant details and generates a comprehensive business analysis.\r\n   */\r\n  async analyseBusiness(\r\n    tenantId: string,\r\n    userId: string,\r\n    businessState: string,\r\n    departments: string[]\r\n  ): Promise<{ output: string; generationTimeMs: number }> {\r\n    this.logger.log({\r\n      message: 'Analysing business',\r\n      tenantId,\r\n      userId,\r\n      departments,\r\n    });\r\n\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true, industry: true, description: true },\r\n    });\r\n\r\n    const companyName = tenant?.name ?? 'Nepoznata kompanija';\r\n    const industry = tenant?.industry ?? 'Opta';\r\n    const companyDescription = tenant?.description ?? '';\r\n\r\n    // 1. Web search for industry context  trends, competitors, market data\r\n    let webContext = '';\r\n    if (this.webSearchService.isAvailable()) {\r\n      try {\r\n        const searchQueries = [\r\n          `${industry} trite Srbija trendovi 2025 2026`,\r\n          `${companyName} ${industry} konkurencija analiza`,\r\n        ];\r\n        const allResults = await Promise.all(\r\n          searchQueries.map((q) => this.webSearchService.searchAndExtract(q, 3).catch(() => []))\r\n        );\r\n        const combined = allResults.flat();\r\n        if (combined.length > 0) {\r\n          webContext = this.webSearchService.formatSourcesAsObsidian(combined);\r\n        }\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Web search failed during business analysis (non-blocking)',\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    // 2. Load knowledge base concepts: foundation first, then keyword-matched\r\n    let conceptContext = '';\r\n    try {\r\n      // Always include foundation concepts (Uvod u Poslovanje, Vrednost)  the starting point\r\n      const foundationConcepts = await this.prisma.concept.findMany({\r\n        where: {\r\n          OR: [\r\n            ...FOUNDATION_CATEGORIES.flatMap((cat) => [\r\n              { category: cat },\r\n              { category: { endsWith: cat } },\r\n            ]),\r\n          ],\r\n        },\r\n        select: { id: true, name: true, category: true, definition: true },\r\n        orderBy: { sortOrder: 'asc' },\r\n      });\r\n\r\n      // Then find industry/business-relevant concepts via keyword matching\r\n      const query = [companyName, industry, companyDescription].filter(Boolean).join('. ');\r\n      const keywordMatches = await this.conceptMatchingService.findRelevantConcepts(query, {\r\n        limit: 15,\r\n        threshold: 0.3,\r\n      });\r\n\r\n      // Merge: foundation first (deduped), then keyword matches\r\n      const foundationIds = new Set(foundationConcepts.map((c) => c.id));\r\n      const allConcepts = [\r\n        ...foundationConcepts.map((c) => ({\r\n          name: c.name,\r\n          category: c.category ?? 'Uvod u Poslovanje',\r\n          definition: c.definition ?? '',\r\n        })),\r\n        ...keywordMatches\r\n          .filter((m) => !foundationIds.has(m.conceptId))\r\n          .map((m) => ({\r\n            name: m.conceptName,\r\n            category: m.category as string,\r\n            definition: m.definition,\r\n          })),\r\n      ];\r\n\r\n      if (allConcepts.length > 0) {\r\n        conceptContext = '\\n\\n--- RELEVANTNI POSLOVNI KONCEPTI IZ BAZE ZNANJA ---\\n';\r\n        conceptContext +=\r\n          'Poni od OSNOVA (Uvod u Poslovanje, Vrednost) pa nadograuj sa specifinim konceptima:\\n\\n';\r\n        conceptContext += allConcepts\r\n          .map((c) => `- **${c.name}** (${c.category}): ${c.definition}`)\r\n          .join('\\n');\r\n        conceptContext += '\\n--- KRAJ KONCEPTA ---';\r\n        conceptContext +=\r\n          '\\nKoristi ove koncepte kao osnovu za konkretne preporuke. Povei svaku preporuku sa relevantnim konceptom.';\r\n      }\r\n    } catch {\r\n      // Non-blocking  concepts may not be seeded yet\r\n    }\r\n\r\n    const systemPrompt = `Ti si vodei poslovni konsultant specijalizovan za ${industry} sektor na Balkanu i u regionu.\r\nTvoj zadatak je da napravi DUBOKU, KONTEKSTUALIZOVANU analizu poslovanja koja e vlasniku dati jasnu sliku gde se nalazi i kuda treba da ide.\r\n\r\nOVO NIJE GENERIKA ANALIZA. Svaki uvid mora biti specifian za ovu kompaniju, ovu industriju, ovo trite.\r\n\r\nSTRUKTURA ANALIZE:\r\n\r\n## 1. Dijagnoza Trenutnog Stanja (300-500 rei)\r\n- Gde se kompanija ZAISTA nalazi  bez ulepavanja\r\n- Koji su kljuni pokazatelji zdravlja poslovanja\r\n- ta funkcionie, a ta ne  konkretno, sa primerima iz njihove industrije\r\n\r\n## 2. Analiza Trita i Konkurencije (300-500 rei)\r\n- Kakvo je stanje u ${industry} sektoru  trendovi, prilike, pretnje\r\n- Ko su glavni konkurenti i kako se ova kompanija pozicionira\r\n- Koje su trine nie neiskoriene\r\n- Koristi podatke iz web istraivanja ako su dostupni\r\n\r\n## 3. Strateke Prednosti (200-300 rei)\r\n- 3-5 konkretnih prednosti koje kompanija moe da iskoristi ODMAH\r\n- Za svaku prednost: ZATO je to prednost i KAKO je pretvoriti u profit\r\n\r\n## 4. Kritine Ranjivosti (200-300 rei)\r\n- 2-4 najvea rizika koji mogu da UNITE poslovanje ako se ne ree\r\n- Za svaki rizik: verovatnoa, uticaj, i prva akcija za mitigaciju\r\n- Budi direktan  vlasnik treba da zna istinu\r\n\r\n## 5. Akcioni Plan  Prvih 90 Dana (500-700 rei)\r\n- 5-8 KONKRETNIH koraka, poreanih po prioritetu\r\n- Za svaki korak:\r\n  * ta tano treba da se uradi (ne \"poboljajte marketing\" nego \"kreirajte landing stranicu za segment X sa ponudom Y\")\r\n  * Ko je odgovoran (koji departman/funkcija)\r\n  * Oekivani rezultat i KPI za merenje\r\n  * Vremenski okvir (nedelja 1-2, nedelja 3-4, mesec 2-3)\r\n  * Povezani poslovni koncept iz baze znanja (ako postoji)\r\n\r\n## 6. Dugorona Vizija  12 Meseci (200-300 rei)\r\n- Gde kompanija moe da bude za godinu dana ako prati plan\r\n- Koji su kljuni mejlstoni na tom putu\r\n- Koja ulaganja su neophodna\r\n\r\nPRAVILA:\r\n- Pii ISKLJUIVO na srpskom jeziku (latinica)\r\n- Koristi direktan, profesionalan ton  kao da razgovara sa vlasnikom\r\n- SVAKA preporuka mora biti SPECIFINA za ovu kompaniju i industriju\r\n- NE koristi generike fraze (\"poboljajte marketing\", \"investirajte u ljude\")\r\n- Koristi konkretne brojke, procente, i vremenske okvire gde god je mogue\r\n- Ako ima podatke iz web istraivanja, citiraj izvore inline u formatu ([Naziv](URL))\r\n- Ukupna duina: 1800-2500 rei`;\r\n\r\n    const userPrompt = `KOMPANIJA: ${companyName}\r\nINDUSTRIJA: ${industry}\r\n${companyDescription ? `OPIS POSLOVANJA:\\n${companyDescription}` : ''}\r\n\r\nTRENUTNO STANJE POSLOVANJA: ${businessState}\r\n\r\nAKTIVNI DEPARTMANI: ${departments.join(', ')}\r\n${webContext}\r\n${conceptContext}\r\n\r\nNapravi duboku analizu ovog poslovanja.`;\r\n\r\n    const startTime = Date.now();\r\n    let fullOutput = '';\r\n\r\n    const result = await this.aiGateway.streamCompletionWithContext(\r\n      [\r\n        { role: 'system', content: systemPrompt },\r\n        { role: 'user', content: userPrompt },\r\n      ],\r\n      { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true },\r\n      (chunk: string) => {\r\n        fullOutput += chunk;\r\n      }\r\n    );\r\n\r\n    const generationTimeMs = Date.now() - startTime;\r\n\r\n    this.logger.log({\r\n      message: 'Business analysis completed',\r\n      tenantId,\r\n      userId,\r\n      generationTimeMs,\r\n      tokens: result.inputTokens + result.outputTokens,\r\n    });\r\n\r\n    return { output: fullOutput, generationTimeMs };\r\n  }\r\n\r\n  /**\r\n   * Creates a \"Business Brain\"  auto-generates personalized tasks and focus areas\r\n   * based on the business profile and available concepts.\r\n   */\r\n  async createBusinessBrain(\r\n    tenantId: string,\r\n    userId: string,\r\n    businessState: string,\r\n    departments: string[]\r\n  ): Promise<{ output: string; generationTimeMs: number }> {\r\n    this.logger.log({\r\n      message: 'Creating business brain',\r\n      tenantId,\r\n      userId,\r\n      departments,\r\n    });\r\n\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true, industry: true, description: true },\r\n    });\r\n\r\n    const companyName = tenant?.name ?? 'Nepoznata kompanija';\r\n    const industry = tenant?.industry ?? 'Opta';\r\n    const companyDescription = tenant?.description ?? '';\r\n\r\n    // 1. Web search  industry best practices, competitor strategies, market opportunities\r\n    let webContext = '';\r\n    if (this.webSearchService.isAvailable()) {\r\n      try {\r\n        const searchQueries = [\r\n          `${industry} najbolje prakse strategija rast Srbija`,\r\n          `${industry} ${departments[0] ?? ''} zadaci prioriteti akcioni plan`,\r\n        ];\r\n        const allResults = await Promise.all(\r\n          searchQueries.map((q) => this.webSearchService.searchAndExtract(q, 3).catch(() => []))\r\n        );\r\n        const combined = allResults.flat();\r\n        if (combined.length > 0) {\r\n          webContext = this.webSearchService.formatSourcesAsObsidian(combined);\r\n        }\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Web search failed during brain creation (non-blocking)',\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    // 2. Load knowledge base concepts: foundation first, then keyword-matched, then department-relevant\r\n    let conceptContext = '';\r\n    try {\r\n      // Always include foundation concepts (Uvod u Poslovanje, Vrednost)\r\n      const foundationConcepts = await this.prisma.concept.findMany({\r\n        where: {\r\n          OR: [\r\n            ...FOUNDATION_CATEGORIES.flatMap((cat) => [\r\n              { category: cat },\r\n              { category: { endsWith: cat } },\r\n            ]),\r\n          ],\r\n        },\r\n        select: { id: true, name: true, category: true, definition: true },\r\n        orderBy: { sortOrder: 'asc' },\r\n      });\r\n      // Keyword-matched concepts for this business\r\n      const query = [companyName, industry, companyDescription, businessState]\r\n        .filter(Boolean)\r\n        .join('. ');\r\n      const keywordMatches = await this.conceptMatchingService.findRelevantConcepts(query, {\r\n        limit: 25,\r\n        threshold: 0.25,\r\n      });\r\n\r\n      // Department-specific concepts (if departments selected)\r\n      const deptCategories = departments.flatMap((dept) => {\r\n        const mapping: Record<string, string[]> = {\r\n          MARKETING: ['Marketing', 'Digitalni Marketing'],\r\n          FINANCE: ['Finansije', 'Raunovodstvo'],\r\n          SALES: ['Prodaja', 'Odnosi sa Klijentima'],\r\n          OPERATIONS: ['Operacije', 'Preduzetnitvo', 'Menadment'],\r\n          TECHNOLOGY: ['Tehnologija', 'Inovacije'],\r\n          STRATEGY: ['Strategija', 'Poslovni Modeli', 'Liderstvo'],\r\n          LEGAL: ['Menadment'],\r\n          CREATIVE: ['Marketing', 'Digitalni Marketing'],\r\n        };\r\n        return mapping[dept] ?? [];\r\n      });\r\n      let deptConcepts: Array<{\r\n        id: string;\r\n        name: string;\r\n        category: string | null;\r\n        definition: string;\r\n      }> = [];\r\n      if (deptCategories.length > 0) {\r\n        deptConcepts = await this.prisma.concept.findMany({\r\n          where: {\r\n            OR: deptCategories.flatMap((cat) => [\r\n              { category: cat },\r\n              { category: { endsWith: cat } },\r\n            ]),\r\n          },\r\n          select: { id: true, name: true, category: true, definition: true },\r\n          orderBy: { sortOrder: 'asc' },\r\n          take: 30,\r\n        });\r\n      }\r\n\r\n      // Merge: foundation  keyword matches  department concepts (deduped)\r\n      const seenIds = new Set<string>();\r\n      const allConcepts: Array<{ name: string; category: string; definition: string }> = [];\r\n\r\n      for (const c of foundationConcepts) {\r\n        seenIds.add(c.id);\r\n        allConcepts.push({\r\n          name: c.name,\r\n          category: c.category ?? 'Uvod u Poslovanje',\r\n          definition: c.definition ?? '',\r\n        });\r\n      }\r\n      for (const m of keywordMatches) {\r\n        if (!seenIds.has(m.conceptId)) {\r\n          seenIds.add(m.conceptId);\r\n          allConcepts.push({\r\n            name: m.conceptName,\r\n            category: m.category as string,\r\n            definition: m.definition,\r\n          });\r\n        }\r\n      }\r\n      for (const c of deptConcepts) {\r\n        if (!seenIds.has(c.id)) {\r\n          seenIds.add(c.id);\r\n          allConcepts.push({\r\n            name: c.name,\r\n            category: c.category ?? 'Opta',\r\n            definition: c.definition ?? '',\r\n          });\r\n        }\r\n      }\r\n\r\n      if (allConcepts.length > 0) {\r\n        conceptContext = '\\n\\n--- BAZA POSLOVNIH KONCEPATA ---\\n';\r\n        conceptContext +=\r\n          'Koncepti su poreani po vanosti: OSNOVE (Uvod u Poslovanje, Vrednost) su temelj na kom se gradi sve ostalo.\\n';\r\n        conceptContext += 'SVAKI zadatak MORA biti vezan za jedan ili vie ovih koncepata:\\n\\n';\r\n        conceptContext += allConcepts\r\n          .map((c) => `- **${c.name}** (${c.category}): ${c.definition}`)\r\n          .join('\\n');\r\n        conceptContext += '\\n--- KRAJ BAZE KONCEPATA ---';\r\n      }\r\n    } catch {\r\n      // Non-blocking  concepts may not be seeded yet\r\n    }\r\n\r\n    const systemPrompt = `Ti si poslovni strateg koji kreira personalizovani \"Poslovni Mozak\"  sistem zadataka koji e pokrenuti kompaniju napred.\r\n\r\nTvoj zadatak je da kreira TANO 10 KONKRETNIH, IZVRIVIH zadataka prilagoenih OVOJ kompaniji, OVOJ industriji, i OVOM trenutnom stanju.\r\nNE vie od 10  fokus je na kvalitetu, ne kvantitetu. Svaki zadatak mora biti dovoljno detaljan da se moe odmah poeti sa radom.\r\n\r\nZA SVAKI ZADATAK OBAVEZNO NAVEDI:\r\n\r\n### [Broj]. [Naslov zadatka  akcioni, jasan]\r\n- **Koncept:** [Koji poslovni koncept iz baze znanja je osnova ovog zadatka]\r\n- **Departman:** [Koji departman je odgovoran]\r\n- **Prioritet:** KRITIAN / VISOK / SREDNJI\r\n- **Zato ba ovo:** [2-3 reenice  ZATO je ovaj zadatak vaan za OVO KONKRETNO poslovanje. Povei sa trenutnim stanjem, industrijom, izazovima. Ne generike fraze.]\r\n- **ta konkretno treba uraditi:**\r\n  1. [Korak 1  specifian, merljiv]\r\n  2. [Korak 2  specifian, merljiv]\r\n  3. [Korak 3  specifian, merljiv]\r\n- **Oekivani rezultat:** [ta e kompanija imati/znati/postii kada se zavri]\r\n- **KPI za merenje:** [Konkretna metrika  broj, procenat, rok]\r\n- **Vremenski okvir:** [Nedelja 1-2 / Mesec 1 / Mesec 2-3]\r\n- **Zavisi od:** [Koji prethodni zadaci moraju biti zavreni pre ovog  ili \"Nezavisan\"]\r\n\r\nREDOSLED ZADATAKA:\r\n- PRVI zadatak MORA biti vezan za koncept \"Uvod u Poslovanje\" / \"Poslovanje\"  ovo je TEMELJ na kom se gradi sve ostalo\r\n- Zatim DIJAGNOSTIKI zadaci (analiza, mapiranje, audit)  vlasnik prvo mora da RAZUME gde je\r\n- Zatim STRATEKI zadaci (definisanje pozicije, ciljeva, plana)\r\n- Zatim OPERATIVNI zadaci (implementacija, kreiranje procesa)\r\n- Na kraju OPTIMIZACIONI zadaci (merenje, poboljanje, skaliranje)\r\n\r\nGRUPII po departmanima: ${departments.join(', ')}\r\nSvaki departman treba da ima minimum 2 zadatka.\r\n\r\nPRAVILA:\r\n- Pii ISKLJUIVO na srpskom jeziku (latinica)\r\n- NE koristi generike zadatke (\"poboljajte komunikaciju\", \"investirajte u tim\")\r\n- SVAKI zadatak mora biti toliko specifian da vlasnik moe da pone da radi ODMAH\r\n- Koristi podatke iz web istraivanja za preporuke zasnovane na tritu\r\n- OBAVEZNO povei svaki zadatak sa konceptom iz baze znanja\r\n- Ako ima web podatke, citiraj izvore inline ([Naziv](URL))\r\n- Ukupna duina: 2000-3000 rei`;\r\n\r\n    const userPrompt = `KOMPANIJA: ${companyName}\r\nINDUSTRIJA: ${industry}\r\n${companyDescription ? `OPIS POSLOVANJA:\\n${companyDescription}` : ''}\r\n\r\nTRENUTNO STANJE POSLOVANJA: ${businessState}\r\n\r\nAKTIVNI DEPARTMANI: ${departments.join(', ')}\r\n${webContext}\r\n${conceptContext}\r\n\r\nKreiraj personalizovani Poslovni Mozak sa tano 10 prioritizovanih zadataka.`;\r\n\r\n    const startTime = Date.now();\r\n    let fullOutput = '';\r\n\r\n    const result = await this.aiGateway.streamCompletionWithContext(\r\n      [\r\n        { role: 'system', content: systemPrompt },\r\n        { role: 'user', content: userPrompt },\r\n      ],\r\n      { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true },\r\n      (chunk: string) => {\r\n        fullOutput += chunk;\r\n      }\r\n    );\r\n\r\n    const generationTimeMs = Date.now() - startTime;\r\n\r\n    this.logger.log({\r\n      message: 'Business brain created',\r\n      tenantId,\r\n      userId,\r\n      generationTimeMs,\r\n      tokens: result.inputTokens + result.outputTokens,\r\n    });\r\n\r\n    return { output: fullOutput, generationTimeMs };\r\n  }\r\n\r\n  /**\r\n   * Gets available quick tasks for an industry.\r\n   */\r\n  getTasksForIndustry(industry: string): QuickTask[] {\r\n    const tasks = getTasksByIndustry(industry);\r\n\r\n    this.logger.log({\r\n      message: 'Retrieved tasks for industry',\r\n      industry,\r\n      taskCount: tasks.length,\r\n    });\r\n\r\n    return tasks;\r\n  }\r\n\r\n  /**\r\n   * Gets all available quick tasks.\r\n   */\r\n  getAllTasks(): QuickTask[] {\r\n    return QUICK_TASK_TEMPLATES;\r\n  }\r\n\r\n  /**\r\n   * Executes a quick win task using the AI Gateway.\r\n   */\r\n  async executeQuickWin(\r\n    tenantId: string,\r\n    userId: string,\r\n    taskId: string,\r\n    userContext: string,\r\n    industry: string\r\n  ): Promise<QuickWinResponse> {\r\n    this.logger.log({\r\n      message: 'Executing quick win task',\r\n      tenantId,\r\n      userId,\r\n      taskId,\r\n      industry,\r\n      contextLength: userContext.length,\r\n    });\r\n\r\n    const task = getTaskById(taskId);\r\n    if (!task) {\r\n      throw new BadRequestException({\r\n        type: 'invalid_task',\r\n        title: 'Invalid Task',\r\n        status: 400,\r\n        detail: `Task with ID '${taskId}' does not exist`,\r\n      });\r\n    }\r\n\r\n    const hasIncomplete = await this.metricService.hasIncompleteOnboarding(userId);\r\n    if (!hasIncomplete) {\r\n      await this.metricService.startOnboarding(tenantId, userId, industry, taskId);\r\n    }\r\n\r\n    const systemPrompt = generateSystemPrompt(task, industry);\r\n    const userPrompt = generateUserPrompt(task, userContext);\r\n\r\n    const startTime = Date.now();\r\n    let fullOutput = '';\r\n    let tokensUsed = 0;\r\n\r\n    try {\r\n      const result = await this.aiGateway.streamCompletionWithContext(\r\n        [\r\n          { role: 'system', content: systemPrompt },\r\n          { role: 'user', content: userPrompt },\r\n        ],\r\n        { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true },\r\n        (chunk: string) => {\r\n          fullOutput += chunk;\r\n        }\r\n      );\r\n\r\n      tokensUsed = result.inputTokens + result.outputTokens;\r\n    } catch (error) {\r\n      this.logger.error({\r\n        message: 'AI Gateway error during quick win',\r\n        tenantId,\r\n        userId,\r\n        taskId,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      });\r\n      throw error;\r\n    }\r\n\r\n    const generationTimeMs = Date.now() - startTime;\r\n\r\n    this.logger.log({\r\n      message: 'Quick win task completed',\r\n      tenantId,\r\n      userId,\r\n      taskId,\r\n      generationTimeMs,\r\n      tokensUsed,\r\n      outputLength: fullOutput.length,\r\n    });\r\n\r\n    return {\r\n      output: fullOutput,\r\n      generationTimeMs,\r\n      tokensUsed,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Completes the onboarding flow, saves the note, and transitions tenant to ACTIVE.\r\n   */\r\n  async completeOnboarding(\r\n    tenantId: string,\r\n    userId: string,\r\n    taskId: string,\r\n    generatedOutput: string,\r\n    executionMode?: string\r\n  ): Promise<OnboardingCompleteResponse> {\r\n    this.logger.log({\r\n      message: 'Completing onboarding',\r\n      tenantId,\r\n      userId,\r\n      taskId,\r\n    });\r\n\r\n    // Determine note title based on strategy or task\r\n    let noteTitle = 'Onboarding Quick Win';\r\n    let timeSavedMinutes = 15;\r\n\r\n    if (taskId === 'ANALYSE_BUSINESS') {\r\n      noteTitle = 'Business Analysis';\r\n      timeSavedMinutes = 30;\r\n    } else if (taskId === 'CREATE_BUSINESS_BRAIN') {\r\n      noteTitle = 'Business Brain  Tasks & Focus Areas';\r\n      timeSavedMinutes = 45;\r\n    } else {\r\n      const task = getTaskById(taskId);\r\n      if (task) {\r\n        noteTitle = task.name;\r\n        timeSavedMinutes = task.estimatedTimeSaved;\r\n      }\r\n    }\r\n\r\n    // Update tenant status to ACTIVE\r\n    await this.updateTenantStatus(tenantId);\r\n\r\n    // Complete the onboarding metric\r\n    await this.metricService.completeOnboarding(userId);\r\n\r\n    // Save the generated output as a note\r\n    const note = await this.notesService.createNote({\r\n      title: noteTitle,\r\n      content: generatedOutput,\r\n      source: NoteSource.ONBOARDING,\r\n      userId,\r\n      tenantId,\r\n    });\r\n\r\n    // Generate initial action plan from business context via embeddings\r\n    let welcomeConversationId: string | null = null;\r\n    let taskIds: string[] = [];\r\n    try {\r\n      const planResult = await this.generateInitialPlan(tenantId, userId);\r\n      welcomeConversationId = planResult.conversationId;\r\n      taskIds = planResult.taskIds;\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Initial plan generation failed (non-blocking)',\r\n        tenantId,\r\n        userId,\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    }\r\n\r\n    // Build execution plan and return planId so frontend can load it\r\n    let planId: string | undefined;\r\n    if (taskIds.length > 0 && welcomeConversationId) {\r\n      try {\r\n        const plan = await this.workflowService.buildExecutionPlan(\r\n          taskIds,\r\n          userId,\r\n          tenantId,\r\n          welcomeConversationId\r\n        );\r\n        planId = plan.planId;\r\n        this.logger.log({\r\n          message: 'Execution plan built for onboarding',\r\n          planId: plan.planId,\r\n          taskCount: taskIds.length,\r\n          tenantId,\r\n          userId,\r\n        });\r\n      } catch (err) {\r\n        this.logger.warn({\r\n          message: 'Plan generation failed (non-blocking)',\r\n          tenantId,\r\n          userId,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      }\r\n    }\r\n\r\n    // Story 3.2: Seed Brain pending tasks based on user's department (fire-and-forget)\r\n    // Loads user's department from DB and seeds concept tasks accordingly\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { department: true, role: true },\r\n    });\r\n    this.brainSeedingService\r\n      .seedPendingTasksForUser(\r\n        userId,\r\n        tenantId,\r\n        (user?.department as string) ?? null,\r\n        user?.role ?? 'TENANT_OWNER'\r\n      )\r\n      .catch((err) => {\r\n        this.logger.warn({\r\n          message: 'Brain seeding failed after onboarding (non-blocking)',\r\n          userId,\r\n          tenantId,\r\n          error: err instanceof Error ? err.message : 'Unknown',\r\n        });\r\n      });\r\n\r\n    this.logger.log({\r\n      message: 'Onboarding completed successfully',\r\n      tenantId,\r\n      userId,\r\n      timeSavedMinutes,\r\n      noteId: note.id,\r\n      welcomeConversationId,\r\n    });\r\n\r\n    return {\r\n      output: generatedOutput,\r\n      timeSavedMinutes,\r\n      noteId: note.id,\r\n      celebrationMessage: `Congratulations! You just saved ~${timeSavedMinutes} minutes!`,\r\n      newTenantStatus: 'ACTIVE' as TenantStatus,\r\n      welcomeConversationId: welcomeConversationId ?? undefined,\r\n      executionMode: (executionMode as 'MANUAL' | 'YOLO') ?? undefined,\r\n      planId,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generates initial action plan by searching embeddings with business context.\r\n   * Multi-query approach for maximum coverage, diversified across categories.\r\n   * Creates rich TASK notes with structured content, then a welcome conversation.\r\n   */\r\n  private async generateInitialPlan(\r\n    tenantId: string,\r\n    userId: string\r\n  ): Promise<{ conversationId: string | null; taskIds: string[] }> {\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { name: true, industry: true, description: true },\r\n    });\r\n    if (!tenant) return { conversationId: null, taskIds: [] };\r\n\r\n    // Multi-query approach for maximum concept coverage\r\n    const queries = [\r\n      tenant.industry,\r\n      tenant.description,\r\n      [tenant.name, tenant.industry, tenant.description].filter(Boolean).join('. '),\r\n    ].filter(Boolean) as string[];\r\n\r\n    // Run all searches in parallel\r\n    const allMatches = new Map<string, ConceptMatch>();\r\n    const searchResults = await Promise.all(\r\n      queries.map((query) =>\r\n        this.conceptMatchingService\r\n          .findRelevantConcepts(query, { limit: 20, threshold: 0.3 })\r\n          .catch(() => [] as ConceptMatch[])\r\n      )\r\n    );\r\n    for (const matches of searchResults) {\r\n      for (const m of matches) {\r\n        const existing = allMatches.get(m.conceptId);\r\n        if (!existing || m.score > existing.score) {\r\n          allMatches.set(m.conceptId, m);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Always include foundation concepts\r\n    const foundationConcepts = await this.prisma.concept.findMany({\r\n      where: {\r\n        OR: [\r\n          ...FOUNDATION_CATEGORIES.flatMap((cat) => [\r\n            { category: cat },\r\n            { category: { endsWith: cat } },\r\n          ]),\r\n          { category: 'Poslovanje' },\r\n        ],\r\n      },\r\n      select: { id: true, name: true, category: true, definition: true },\r\n      orderBy: { sortOrder: 'asc' },\r\n    });\r\n\r\n    const foundationMatches: ConceptMatch[] = foundationConcepts.map((c) => ({\r\n      conceptId: c.id,\r\n      conceptName: c.name,\r\n      category: (c.category ??\r\n        'Uvod u Poslovanje') as unknown as import('@mentor-ai/shared/types').ConceptCategory,\r\n      definition: c.definition ?? '',\r\n      score: 1.0,\r\n    }));\r\n\r\n    // Diversify: max 5 per category, sorted by score\r\n    const byCategory = new Map<string, ConceptMatch[]>();\r\n    const foundationIds = new Set(foundationConcepts.map((c) => c.id));\r\n    for (const m of allMatches.values()) {\r\n      if (foundationIds.has(m.conceptId)) continue;\r\n      const cat = m.category ?? 'General';\r\n      if (!byCategory.has(cat)) byCategory.set(cat, []);\r\n      byCategory.get(cat)!.push(m);\r\n    }\r\n    const embeddingMatches: ConceptMatch[] = [];\r\n    for (const [, concepts] of byCategory) {\r\n      concepts.sort((a, b) => b.score - a.score);\r\n      embeddingMatches.push(...concepts.slice(0, 5));\r\n    }\r\n    embeddingMatches.sort((a, b) => b.score - a.score);\r\n\r\n    const diversified = [...foundationMatches, ...embeddingMatches];\r\n\r\n    if (diversified.length === 0) {\r\n      this.logger.warn({ message: 'No concepts found for initial plan', tenantId });\r\n      return { conversationId: null, taskIds: [] };\r\n    }\r\n\r\n    // Ensure \"Uvod u Poslovanje\" foundation concept is first (foundational starting point)\r\n    // Concept names may have number prefixes (e.g., \"1. Poslovanje\")\r\n    const poslovanjeIdx = diversified.findIndex(\r\n      (m) =>\r\n        m.conceptName === 'Poslovanje' ||\r\n        m.conceptName === '1. Poslovanje' ||\r\n        (m.category as string)?.endsWith('Uvod u Poslovanje')\r\n    );\r\n    if (poslovanjeIdx > 0) {\r\n      const removed = diversified.splice(poslovanjeIdx, 1);\r\n      diversified.unshift(removed[0]!);\r\n    }\r\n\r\n    // Limit to top 10 concepts\r\n    const topTasks = diversified.slice(0, 10);\r\n\r\n    // Load prerequisite relationships for all selected concepts\r\n    const topConceptIds = topTasks.map((m) => m.conceptId);\r\n    const prerequisites = await this.prisma.conceptRelationship.findMany({\r\n      where: {\r\n        sourceConceptId: { in: topConceptIds },\r\n        relationshipType: 'PREREQUISITE',\r\n      },\r\n      select: {\r\n        sourceConceptId: true,\r\n        targetConcept: { select: { name: true } },\r\n      },\r\n    });\r\n    const prereqMap = new Map<string, string[]>();\r\n    for (const rel of prerequisites) {\r\n      const existing = prereqMap.get(rel.sourceConceptId) ?? [];\r\n      existing.push(rel.targetConcept.name);\r\n      prereqMap.set(rel.sourceConceptId, existing);\r\n    }\r\n\r\n    // Generate rich task content via LLM  single batched call for all 10 concepts\r\n    const conceptDescriptions = topTasks\r\n      .map((m, i) => {\r\n        const prereqs = prereqMap.get(m.conceptId) ?? [];\r\n        return `${i + 1}. Koncept: \"${m.conceptName}\" | Kategorija: ${m.category} | Definicija: ${m.definition}${prereqs.length > 0 ? ` | Preduslovi: ${prereqs.join(', ')}` : ''}`;\r\n      })\r\n      .join('\\n');\r\n\r\n    const taskEnrichmentSystemPrompt = `Ti si srpski poslovni konsultant koji kreira akcione zadatke.\r\n\r\nZa SVAKI koncept napii strukturirani zadatak u sledeem formatu:\r\n\r\n---ZADATAK: {redni broj}---\r\nNASLOV: {akcioni naslov na srpskom  glagol + konkretna radnja, max 60 karaktera}\r\nSADRAJ:\r\n## Cilj\r\n{1-2 reenice: ta konkretno treba postii za \"${tenant.name}\" u industriji \"${tenant.industry}\"}\r\n\r\n## Zato je ovo vano\r\n{2-3 reenice: poslovna vrednost, ta se gubi ako se ne uradi}\r\n\r\n## Koraci za realizaciju\r\n1. {Konkretan korak sa opisom  ne generiki}\r\n2. {Konkretan korak sa opisom}\r\n3. {Konkretan korak sa opisom}\r\n4. {Konkretan korak sa opisom}\r\n5. {Konkretan korak sa opisom}\r\n\r\n## Oekivani rezultat\r\n{1-2 reenice: merljiv ishod, KPI ili deliverable}\r\n\r\n## Vremenski okvir\r\n{Predloeni rok: 1 nedelja / 2 nedelje / 1 mesec}\r\n---KRAJ ZADATKA---\r\n\r\nPRAVILA:\r\n- Svaki naslov MORA biti akcioni glagol na srpskom: \"Analizirajte...\", \"Definiite...\", \"Kreirajte...\", \"Mapriajte...\", \"Razvijte...\", \"Optimizujte...\", \"Uspostavite...\"\r\n- Koraci moraju biti SPECIFINI za \"${tenant.name}\" i \"${tenant.industry}\"  ne generiki\r\n- Ako koncept ima preduslove, pomeni ih u sekciji \"Zato je ovo vano\"\r\n- ${tenant.description ? `Kontekst kompanije: ${tenant.description}` : ''}\r\n- Pii ISKLJUIVO na srpskom jeziku\r\n- TANO ${topTasks.length} zadataka, ni vie ni manje`;\r\n\r\n    const taskEnrichmentUserPrompt = `Koncepti za koje treba kreirati zadatke:\r\n${conceptDescriptions}\r\n\r\nGenerii strukturirane zadatke.`;\r\n\r\n    let enrichedContent = '';\r\n    try {\r\n      await this.aiGateway.streamCompletionWithContext(\r\n        [\r\n          { role: 'system', content: taskEnrichmentSystemPrompt },\r\n          { role: 'user', content: taskEnrichmentUserPrompt },\r\n        ],\r\n        { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true },\r\n        (chunk: string) => {\r\n          enrichedContent += chunk;\r\n        }\r\n      );\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Task enrichment LLM call failed, using template fallback',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n    }\r\n\r\n    // Parse LLM output into per-task title + content\r\n    const parsedTasks = this.parseEnrichedTasks(enrichedContent, topTasks);\r\n\r\n    // Create TASK notes (dedup: skip if task already exists for this concept)\r\n    const createdTaskIds: string[] = [];\r\n    for (let i = 0; i < topTasks.length; i++) {\r\n      const match = topTasks[i]!;\r\n      const parsed = parsedTasks[i];\r\n\r\n      const existingId = await this.notesService.findExistingTask(tenantId, {\r\n        conceptId: match.conceptId,\r\n      });\r\n      if (existingId) {\r\n        createdTaskIds.push(existingId);\r\n        continue;\r\n      }\r\n\r\n      const title = parsed?.title ?? this.buildActionTitle(match.conceptName);\r\n      const content = parsed?.content ?? this.buildFallbackTaskContent(match, tenant);\r\n\r\n      const note = await this.notesService.createNote({\r\n        title,\r\n        content,\r\n        source: NoteSource.ONBOARDING,\r\n        noteType: NoteType.TASK,\r\n        status: NoteStatus.PENDING,\r\n        conceptId: match.conceptId,\r\n        userId,\r\n        tenantId,\r\n      });\r\n      createdTaskIds.push(note.id);\r\n    }\r\n\r\n    // Build concept summaries for welcome message\r\n    const conceptSummaries = topTasks\r\n      .map((m, i) => {\r\n        const parsed = parsedTasks[i];\r\n        const title = parsed?.title ?? this.buildActionTitle(m.conceptName);\r\n        return `${i + 1}. \"${title}\"  Koncept: ${m.conceptName}, Definicija: ${m.definition}`;\r\n      })\r\n      .join('\\n');\r\n\r\n    // Generate narrative welcome message via LLM\r\n    const welcomeSystemPrompt = `Ti si poslovni savetnik koji upoznaje klijenta sa personalizovanim akcionim planom.\r\n\r\nNapii dobrodolicu koja:\r\n1. Pozdravi klijenta po imenu kompanije i rezimira njihov profil (2-3 reenice)\r\n2. Objasni strategiju: ZATO ovih ${topTasks.length} zadataka, koji je krajnji cilj\r\n3. Za SVAKI zadatak objasni ZATO je vaan za NJIHOVO poslovanje (ne samo naziv  poslovnu vrednost)\r\n4. Objasni REDOSLED  zato poinjemo sa zadatkom #1, kako svaki naredni nadograuje prethodni\r\n5. Na kraju jasno predloi prvi korak\r\n\r\nPRAVILA:\r\n- NE koristi [[Naziv Koncepta]] oznake\r\n- NE nabraja korake kao suvu listu  objasni poslovnu logiku iza svakog\r\n- Koristi ime kompanije \"${tenant.name}\" i industrije \"${tenant.industry}\"\r\n- Pii toplo ali profesionalno, kao iskusan konsultant\r\n- Na kraju dodaj: odgovorite \"da\" za sve zadatke, \"pokreni 1, 3, 5\" za izbor, ili \"pokreni prvi\" za samo prvi\r\n- Pii ISKLJUIVO na srpskom jeziku\r\n- Izmeu 500 i 800 rei  dovoljno detalja za kontekst`;\r\n\r\n    const welcomeUserPrompt = `Kompanija: ${tenant.name ?? 'Nepoznata'}\r\nIndustrija: ${tenant.industry ?? 'Opta'}\r\n${tenant.description ? `Opis: ${tenant.description}` : ''}\r\n\r\nPripremljeni zadaci (po redosledu):\r\n${conceptSummaries}\r\n\r\nNapii personalizovanu dobrodolicu.`;\r\n\r\n    let welcomeMsg = '';\r\n    try {\r\n      await this.aiGateway.streamCompletionWithContext(\r\n        [\r\n          { role: 'system', content: welcomeSystemPrompt },\r\n          { role: 'user', content: welcomeUserPrompt },\r\n        ],\r\n        { tenantId, userId, skipRateLimit: true, skipQuotaCheck: true },\r\n        (chunk: string) => {\r\n          welcomeMsg += chunk;\r\n        }\r\n      );\r\n    } catch (err) {\r\n      this.logger.warn({\r\n        message: 'Failed to generate narrative welcome message, using fallback',\r\n        error: err instanceof Error ? err.message : 'Unknown',\r\n      });\r\n      const taskList = topTasks\r\n        .map((m, i) => {\r\n          const parsed = parsedTasks[i];\r\n          const title = parsed?.title ?? this.buildActionTitle(m.conceptName);\r\n          return `${i + 1}. **${title}**${i === 0 ? ' (preporueno)' : ''}`;\r\n        })\r\n        .join('\\n');\r\n      welcomeMsg = `Dobrodoli! Pripremili smo ${topTasks.length} zadataka za vae poslovanje:\\n\\n${taskList}\\n\\nOdgovorite \"da\" da pokrenete sve zadatke.`;\r\n    }\r\n\r\n    // Create welcome conversation\r\n    const conversation = await this.conversationService.createConversation(\r\n      tenantId,\r\n      userId,\r\n      'Dobrodoli u Mentor AI',\r\n      undefined,\r\n      topTasks[0]?.conceptId\r\n    );\r\n    await this.conversationService.addMessage(\r\n      tenantId,\r\n      conversation.id,\r\n      'ASSISTANT' as MessageRole,\r\n      welcomeMsg\r\n    );\r\n\r\n    // Link task notes to the welcome conversation\r\n    const conceptIds = topTasks.map((m) => m.conceptId);\r\n    await this.notesService.linkNotesToConversation(conceptIds, conversation.id, userId, tenantId);\r\n\r\n    this.logger.log({\r\n      message: 'Initial plan generated',\r\n      tenantId,\r\n      userId,\r\n      taskCount: topTasks.length,\r\n      enrichedViaLLM: enrichedContent.length > 0,\r\n      concepts: topTasks.map((m) => m.conceptName),\r\n      welcomeConversationId: conversation.id,\r\n    });\r\n\r\n    return { conversationId: conversation.id, taskIds: createdTaskIds };\r\n  }\r\n\r\n  /**\r\n   * Parses LLM-generated enriched task content into per-task title + content.\r\n   * Falls back gracefully if LLM output is malformed.\r\n   */\r\n  private parseEnrichedTasks(\r\n    llmOutput: string,\r\n    concepts: ConceptMatch[]\r\n  ): Array<{ title: string; content: string } | null> {\r\n    if (!llmOutput || llmOutput.trim().length === 0) {\r\n      return concepts.map(() => null);\r\n    }\r\n\r\n    // Split by task delimiters\r\n    const taskBlocks = llmOutput.split(/---ZADATAK:\\s*\\d+---/).filter((b) => b.trim().length > 0);\r\n\r\n    return concepts.map((_, index) => {\r\n      const block = taskBlocks[index];\r\n      if (!block) return null;\r\n\r\n      // Remove end delimiter if present\r\n      const cleaned = block.replace(/---KRAJ ZADATKA---/g, '').trim();\r\n\r\n      // Extract title\r\n      const titleMatch = cleaned.match(/NASLOV:\\s*(.+?)(?:\\n|$)/);\r\n      const title = titleMatch?.[1]?.trim();\r\n      if (!title) return null;\r\n\r\n      // Extract content (everything after SADRAJ:)\r\n      const contentMatch = cleaned.match(/SADRAJ:\\s*([\\s\\S]+)/);\r\n      const content = contentMatch?.[1]?.trim();\r\n      if (!content) return null;\r\n\r\n      return { title, content };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Fallback task content when LLM enrichment fails.\r\n   * Still richer than a single line  includes definition + category context.\r\n   */\r\n  private buildFallbackTaskContent(\r\n    match: ConceptMatch,\r\n    tenant: { name: string | null; industry: string | null }\r\n  ): string {\r\n    return `## Cilj\r\nPrimenite koncept \"${match.conceptName}\" na poslovanje ${tenant.name ?? 'vae kompanije'} u industriji ${tenant.industry ?? 'vaoj industriji'}.\r\n\r\n## Definicija koncepta\r\n${match.definition}\r\n\r\n## Kategorija\r\n${match.category}\r\n\r\n## Koraci za realizaciju\r\n1. Analizirajte trenutno stanje u kontekstu ovog koncepta\r\n2. Identifikujte kljune oblasti za poboljanje\r\n3. Definiite konkretne akcije i odgovorne osobe\r\n4. Postavite merljive KPI za praenje napretka\r\n5. Implementirajte i pratite rezultate`;\r\n  }\r\n\r\n  /**\r\n   * Generates an action title for a concept name (Serbian).\r\n   * Uses category-aware verb mapping for natural Serbian titles.\r\n   */\r\n  private buildActionTitle(conceptName: string): string {\r\n    const lower = conceptName.toLowerCase();\r\n\r\n    // Category-based Serbian verb prefixes\r\n    if (lower.includes('analiz') || lower.includes('swot') || lower.includes('dijagnos'))\r\n      return `Analizirajte: ${conceptName}`;\r\n    if (lower.includes('plan') || lower.includes('strategij') || lower.includes('model'))\r\n      return `Kreirajte: ${conceptName}`;\r\n    if (lower.includes('vrednost') || lower.includes('ponud') || lower.includes('cen'))\r\n      return `Definiite: ${conceptName}`;\r\n    if (lower.includes('marketing') || lower.includes('brend') || lower.includes('brand'))\r\n      return `Razvijte: ${conceptName}`;\r\n    if (lower.includes('prodaj') || lower.includes('kupac') || lower.includes('klijent'))\r\n      return `Optimizujte: ${conceptName}`;\r\n    if (lower.includes('finans') || lower.includes('budet') || lower.includes('novan'))\r\n      return `Analizirajte: ${conceptName}`;\r\n    if (lower.includes('operaci') || lower.includes('proces') || lower.includes('efikas'))\r\n      return `Uspostavite: ${conceptName}`;\r\n    if (lower.includes('tim') || lower.includes('lider') || lower.includes('menad'))\r\n      return `Razvijte: ${conceptName}`;\r\n    if (lower.includes('inovacij') || lower.includes('tehnolog') || lower.includes('digital'))\r\n      return `Implementirajte: ${conceptName}`;\r\n\r\n    // Default: \"Primenite\" (Apply)  universal action verb\r\n    return `Primenite: ${conceptName}`;\r\n  }\r\n\r\n  /**\r\n   * Updates the tenant status from ONBOARDING to ACTIVE.\r\n   */\r\n  private async updateTenantStatus(tenantId: string): Promise<void> {\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: tenantId },\r\n      select: { status: true },\r\n    });\r\n\r\n    if (!tenant) {\r\n      throw new NotFoundException({\r\n        type: 'tenant_not_found',\r\n        title: 'Tenant Not Found',\r\n        status: 404,\r\n        detail: 'Cannot update status for non-existent tenant',\r\n      });\r\n    }\r\n\r\n    if (\r\n      tenant.status !== PrismaTenantStatus.DRAFT &&\r\n      tenant.status !== PrismaTenantStatus.ONBOARDING\r\n    ) {\r\n      this.logger.log({\r\n        message: 'Tenant already active, skipping status update',\r\n        tenantId,\r\n        currentStatus: tenant.status,\r\n      });\r\n      return;\r\n    }\r\n\r\n    await this.prisma.tenant.update({\r\n      where: { id: tenantId },\r\n      data: { status: PrismaTenantStatus.ACTIVE },\r\n    });\r\n\r\n    this.logger.log({\r\n      message: 'Tenant status updated to ACTIVE',\r\n      tenantId,\r\n      previousStatus: tenant.status,\r\n      newStatus: 'ACTIVE',\r\n    });\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { createId } from '@paralleldrive/cuid2';\r\nimport type { OnboardingMetricResponse } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Service for tracking onboarding metrics, specifically time-to-first-value.\r\n * Records when users start and complete the onboarding quick win flow.\r\n */\r\n@Injectable()\r\nexport class OnboardingMetricService {\r\n  private readonly logger = new Logger(OnboardingMetricService.name);\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  /**\r\n   * Records the start of the onboarding process for a user.\r\n   *\r\n   * @param tenantId - The tenant ID\r\n   * @param userId - The user ID\r\n   * @param industry - The selected industry\r\n   * @param quickTaskType - The type of quick task selected\r\n   * @returns The created metric record\r\n   */\r\n  async startOnboarding(\r\n    tenantId: string,\r\n    userId: string,\r\n    industry: string,\r\n    quickTaskType: string\r\n  ): Promise<OnboardingMetricResponse> {\r\n    const id = `obm_${createId()}`;\r\n\r\n    this.logger.log({\r\n      message: 'Recording onboarding start',\r\n      tenantId,\r\n      userId,\r\n      industry,\r\n      quickTaskType,\r\n      metricId: id,\r\n    });\r\n\r\n    const metric = await this.prisma.onboardingMetric.create({\r\n      data: {\r\n        id,\r\n        tenantId,\r\n        userId,\r\n        startedAt: new Date(),\r\n        industry,\r\n        quickTaskType,\r\n      },\r\n    });\r\n\r\n    return this.toResponse(metric);\r\n  }\r\n\r\n  /**\r\n   * Marks the onboarding as complete and calculates time-to-first-value.\r\n   *\r\n   * @param userId - The user ID\r\n   * @returns The updated metric record with completion time\r\n   */\r\n  async completeOnboarding(userId: string): Promise<OnboardingMetricResponse | null> {\r\n    // Find the most recent incomplete onboarding metric for this user\r\n    const metric = await this.prisma.onboardingMetric.findFirst({\r\n      where: {\r\n        userId,\r\n        completedAt: null,\r\n      },\r\n      orderBy: {\r\n        startedAt: 'desc',\r\n      },\r\n    });\r\n\r\n    if (!metric) {\r\n      this.logger.warn({\r\n        message: 'No incomplete onboarding metric found for user',\r\n        userId,\r\n      });\r\n      return null;\r\n    }\r\n\r\n    const completedAt = new Date();\r\n    const timeToFirstValueMs = completedAt.getTime() - metric.startedAt.getTime();\r\n\r\n    this.logger.log({\r\n      message: 'Recording onboarding completion',\r\n      userId,\r\n      metricId: metric.id,\r\n      timeToFirstValueMs,\r\n      timeToFirstValueMinutes: Math.round(timeToFirstValueMs / 60000),\r\n    });\r\n\r\n    const updated = await this.prisma.onboardingMetric.update({\r\n      where: { id: metric.id },\r\n      data: {\r\n        completedAt,\r\n        timeToFirstValueMs,\r\n      },\r\n    });\r\n\r\n    return this.toResponse(updated);\r\n  }\r\n\r\n  /**\r\n   * Gets the onboarding metric for a user.\r\n   *\r\n   * @param userId - The user ID\r\n   * @returns The most recent metric record or null\r\n   */\r\n  async getMetric(userId: string): Promise<OnboardingMetricResponse | null> {\r\n    const metric = await this.prisma.onboardingMetric.findFirst({\r\n      where: { userId },\r\n      orderBy: { startedAt: 'desc' },\r\n    });\r\n\r\n    if (!metric) {\r\n      return null;\r\n    }\r\n\r\n    return this.toResponse(metric);\r\n  }\r\n\r\n  /**\r\n   * Checks if a user has an incomplete onboarding session.\r\n   *\r\n   * @param userId - The user ID\r\n   * @returns True if there's an incomplete onboarding\r\n   */\r\n  async hasIncompleteOnboarding(userId: string): Promise<boolean> {\r\n    const count = await this.prisma.onboardingMetric.count({\r\n      where: {\r\n        userId,\r\n        completedAt: null,\r\n      },\r\n    });\r\n    return count > 0;\r\n  }\r\n\r\n  /**\r\n   * Converts a Prisma OnboardingMetric to the API response type.\r\n   */\r\n  private toResponse(metric: {\r\n    id: string;\r\n    tenantId: string;\r\n    userId: string;\r\n    startedAt: Date;\r\n    completedAt: Date | null;\r\n    timeToFirstValueMs: number | null;\r\n    quickTaskType: string;\r\n    industry: string;\r\n  }): OnboardingMetricResponse {\r\n    return {\r\n      id: metric.id,\r\n      tenantId: metric.tenantId,\r\n      userId: metric.userId,\r\n      startedAt: metric.startedAt.toISOString(),\r\n      completedAt: metric.completedAt?.toISOString() ?? null,\r\n      timeToFirstValueMs: metric.timeToFirstValueMs,\r\n      quickTaskType: metric.quickTaskType,\r\n      industry: metric.industry,\r\n    };\r\n  }\r\n}\r\n","import { Department, QuickTask } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * @deprecated Story 3.2  Quick-task templates are superseded by the\r\n * Autonomous Business Brain concept seeding (BrainSeedingService).\r\n * Kept for backward compatibility with legacy onboarding flows.\r\n * New onboarding uses brain seeding via department-based concept categories.\r\n */\r\nexport const QUICK_TASK_TEMPLATES: QuickTask[] = [\r\n  // Finance tasks\r\n  {\r\n    id: 'finance-email',\r\n    name: 'Draft a Financial Summary Email',\r\n    description: 'Create a professional email summarizing financial metrics or updates',\r\n    department: Department.FINANCE,\r\n    estimatedTimeSaved: 15,\r\n  },\r\n  {\r\n    id: 'finance-report',\r\n    name: 'Create a Budget Report Outline',\r\n    description: 'Generate an outline for a budget or financial report',\r\n    department: Department.FINANCE,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n\r\n  // Marketing tasks\r\n  {\r\n    id: 'marketing-brief',\r\n    name: 'Create a Campaign Brief Outline',\r\n    description: 'Generate a marketing campaign brief with goals and strategy',\r\n    department: Department.MARKETING,\r\n    estimatedTimeSaved: 15,\r\n  },\r\n  {\r\n    id: 'marketing-social',\r\n    name: 'Draft Social Media Posts',\r\n    description: 'Create engaging social media content for your brand',\r\n    department: Department.MARKETING,\r\n    estimatedTimeSaved: 10,\r\n  },\r\n\r\n  // Technology tasks\r\n  {\r\n    id: 'tech-memo',\r\n    name: 'Write a Technical Decision Memo',\r\n    description: 'Document a technical decision with rationale and trade-offs',\r\n    department: Department.TECHNOLOGY,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n  {\r\n    id: 'tech-spec',\r\n    name: 'Create a Feature Specification',\r\n    description: 'Generate a specification outline for a new feature',\r\n    department: Department.TECHNOLOGY,\r\n    estimatedTimeSaved: 25,\r\n  },\r\n\r\n  // Operations tasks\r\n  {\r\n    id: 'ops-agenda',\r\n    name: 'Generate a Meeting Agenda',\r\n    description: 'Create a structured agenda for your upcoming meeting',\r\n    department: Department.OPERATIONS,\r\n    estimatedTimeSaved: 10,\r\n  },\r\n  {\r\n    id: 'ops-process',\r\n    name: 'Draft a Process Document',\r\n    description: 'Outline a standard operating procedure or process',\r\n    department: Department.OPERATIONS,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n\r\n  // Legal tasks\r\n  {\r\n    id: 'legal-checklist',\r\n    name: 'Draft a Contract Review Checklist',\r\n    description: 'Create a checklist for reviewing contract terms',\r\n    department: Department.LEGAL,\r\n    estimatedTimeSaved: 15,\r\n  },\r\n  {\r\n    id: 'legal-summary',\r\n    name: 'Summarize Legal Requirements',\r\n    description: 'Outline key legal requirements or compliance points',\r\n    department: Department.LEGAL,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n\r\n  // Creative tasks\r\n  {\r\n    id: 'creative-pitch',\r\n    name: 'Create a Project Pitch Outline',\r\n    description: 'Generate a compelling pitch for your creative project',\r\n    department: Department.CREATIVE,\r\n    estimatedTimeSaved: 15,\r\n  },\r\n  {\r\n    id: 'creative-brief',\r\n    name: 'Draft a Creative Brief',\r\n    description: 'Create a brief outlining project goals and creative direction',\r\n    department: Department.CREATIVE,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n\r\n  // Strategy tasks\r\n  {\r\n    id: 'strategy-framework',\r\n    name: 'Create a Strategic Analysis Framework',\r\n    description: 'Generate a SWOT or competitive analysis framework for your business',\r\n    department: Department.STRATEGY,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n  {\r\n    id: 'strategy-landscape',\r\n    name: 'Draft a Competitive Landscape Overview',\r\n    description: 'Outline key competitors, market positioning, and strategic opportunities',\r\n    department: Department.STRATEGY,\r\n    estimatedTimeSaved: 25,\r\n  },\r\n\r\n  // Sales tasks\r\n  {\r\n    id: 'sales-pipeline',\r\n    name: 'Build a Sales Pipeline Template',\r\n    description: 'Create a structured sales pipeline with stages and qualification criteria',\r\n    department: Department.SALES,\r\n    estimatedTimeSaved: 20,\r\n  },\r\n  {\r\n    id: 'sales-proposal',\r\n    name: 'Draft a Client Proposal Outline',\r\n    description: 'Generate a professional proposal outline for a prospective client',\r\n    department: Department.SALES,\r\n    estimatedTimeSaved: 25,\r\n  },\r\n];\r\n\r\n/**\r\n * Get tasks filtered by department/industry.\r\n *\r\n * @param industry - The department/industry to filter by\r\n * @returns Array of quick tasks for the specified industry\r\n */\r\nexport function getTasksByIndustry(industry: string): QuickTask[] {\r\n  return QUICK_TASK_TEMPLATES.filter(\r\n    (task) => task.department.toLowerCase() === industry.toLowerCase()\r\n  );\r\n}\r\n\r\n/**\r\n * Get a specific task by ID.\r\n *\r\n * @param taskId - The task ID to find\r\n * @returns The quick task or undefined if not found\r\n */\r\nexport function getTaskById(taskId: string): QuickTask | undefined {\r\n  return QUICK_TASK_TEMPLATES.find((task) => task.id === taskId);\r\n}\r\n\r\n/**\r\n * Generate the system prompt for a quick task.\r\n *\r\n * @param task - The quick task\r\n * @param industry - The selected industry\r\n * @returns Optimized system prompt for the AI\r\n */\r\nexport function generateSystemPrompt(task: QuickTask, industry: string): string {\r\n  return `You are a professional ${industry.toLowerCase()} assistant with expertise in ${task.department.toLowerCase()}.\r\nYour task is to generate a high-quality, immediately usable ${task.name.toLowerCase()}.\r\nBe concise but comprehensive. Provide professional, actionable content.\r\nFormat the output clearly with appropriate sections and bullet points where helpful.\r\nThe user is new to this platform and this is their first interaction - make it impressive and valuable.`;\r\n}\r\n\r\n/**\r\n * Generate the user prompt for a quick task.\r\n *\r\n * @param task - The quick task\r\n * @param userContext - User-provided context\r\n * @returns User prompt for the AI\r\n */\r\nexport function generateUserPrompt(task: QuickTask, userContext: string): string {\r\n  return `Task: ${task.name}\r\nDescription: ${task.description}\r\n\r\nUser's context and requirements:\r\n${userContext}\r\n\r\nPlease generate a professional, ready-to-use output that demonstrates immediate value.`;\r\n}\r\n","import {\r\n  IsString,\r\n  IsNotEmpty,\r\n  MaxLength,\r\n  MinLength,\r\n  IsOptional,\r\n  IsArray,\r\n  IsIn,\r\n} from 'class-validator';\r\n\r\n/**\r\n * DTO for setting up company details during onboarding step 1.\r\n */\r\nexport class SetupCompanyDto {\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  @MinLength(2, { message: 'Company name must be at least 2 characters' })\r\n  @MaxLength(100, { message: 'Company name must be 100 characters or less' })\r\n  companyName!: string;\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  @MinLength(2, { message: 'Industry must be at least 2 characters' })\r\n  @MaxLength(100, { message: 'Industry must be 100 characters or less' })\r\n  industry!: string;\r\n\r\n  @IsString()\r\n  @IsOptional()\r\n  @MaxLength(3000, { message: 'Description must be 3000 characters or less' })\r\n  description?: string;\r\n\r\n  @IsString()\r\n  @IsOptional()\r\n  @MaxLength(500, { message: 'Website URL must be 500 characters or less' })\r\n  websiteUrl?: string;\r\n}\r\n\r\n/**\r\n * DTO for business context during onboarding step 3.\r\n */\r\nexport class BusinessContextDto {\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  @MaxLength(1000, { message: 'Business state must be 1000 characters or less' })\r\n  businessState!: string;\r\n\r\n  @IsArray()\r\n  @IsString({ each: true })\r\n  departments!: string[];\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  strategy!: string;\r\n}\r\n\r\n/**\r\n * DTO for executing a quick win task during onboarding.\r\n */\r\nexport class QuickWinDto {\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  taskId!: string;\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  @MaxLength(280, { message: 'Context must be 280 characters or less' })\r\n  userContext!: string;\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  industry!: string;\r\n}\r\n\r\n/**\r\n * DTO for setting the user's department/role during onboarding (Story 3.2).\r\n */\r\nexport class SetDepartmentDto {\r\n  @IsOptional()\r\n  @IsIn(\r\n    [\r\n      'MARKETING',\r\n      'FINANCE',\r\n      'SALES',\r\n      'OPERATIONS',\r\n      'TECHNOLOGY',\r\n      'STRATEGY',\r\n      'LEGAL',\r\n      'CREATIVE',\r\n      null,\r\n    ],\r\n    { message: 'department must be a valid Department enum value or null' }\r\n  )\r\n  department?: string | null;\r\n}\r\n\r\n/**\r\n * DTO for completing onboarding and saving the first note.\r\n */\r\nexport class OnboardingCompleteDto {\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  taskId!: string;\r\n\r\n  @IsString()\r\n  @IsNotEmpty()\r\n  generatedOutput!: string;\r\n\r\n  @IsString()\r\n  @IsOptional()\r\n  executionMode?: string;\r\n}\r\n","import { Module } from '@nestjs/common';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { PersonasService } from './personas.service';\r\nimport { PersonasController } from './personas.controller';\r\n\r\n/**\r\n * Module for department persona management.\r\n * Provides persona definitions and API endpoints for persona selection.\r\n */\r\n@Module({\r\n  imports: [AuthModule], // Provides AuthService for MfaRequiredGuard\r\n  controllers: [PersonasController],\r\n  providers: [PersonasService],\r\n  exports: [PersonasService],\r\n})\r\nexport class PersonasModule {}\r\n","import { Injectable, Logger, NotFoundException } from '@nestjs/common';\r\nimport {\r\n  PERSONA_COLORS,\r\n  PERSONA_NAMES,\r\n  PersonaType,\r\n  type Persona,\r\n} from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Static persona definitions with prs_ prefix IDs.\r\n * These are predefined personas representing C-suite and department leads.\r\n * Colors and names are sourced from shared constants for consistency.\r\n */\r\nconst PERSONAS: Record<string, Persona> = {\r\n  CFO: {\r\n    id: 'prs_cfo001',\r\n    type: PersonaType.CFO,\r\n    name: 'Chief Financial Officer',\r\n    shortName: PERSONA_NAMES[PersonaType.CFO],\r\n    description:\r\n      'Financial strategy, budgeting, forecasting, ROI analysis, and fiscal responsibility',\r\n    avatarUrl: '/assets/images/personas/cfo-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.CFO],\r\n  },\r\n  CMO: {\r\n    id: 'prs_cmo002',\r\n    type: PersonaType.CMO,\r\n    name: 'Chief Marketing Officer',\r\n    shortName: PERSONA_NAMES[PersonaType.CMO],\r\n    description:\r\n      'Brand strategy, marketing campaigns, growth initiatives, and customer acquisition',\r\n    avatarUrl: '/assets/images/personas/cmo-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.CMO],\r\n  },\r\n  CTO: {\r\n    id: 'prs_cto003',\r\n    type: PersonaType.CTO,\r\n    name: 'Chief Technology Officer',\r\n    shortName: PERSONA_NAMES[PersonaType.CTO],\r\n    description:\r\n      'Technical architecture, software development, infrastructure, and technology strategy',\r\n    avatarUrl: '/assets/images/personas/cto-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.CTO],\r\n  },\r\n  OPERATIONS: {\r\n    id: 'prs_ops004',\r\n    type: PersonaType.OPERATIONS,\r\n    name: 'Chief Operations Officer',\r\n    shortName: PERSONA_NAMES[PersonaType.OPERATIONS],\r\n    description:\r\n      'Process optimization, operational efficiency, supply chain, and resource management',\r\n    avatarUrl: '/assets/images/personas/operations-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.OPERATIONS],\r\n  },\r\n  LEGAL: {\r\n    id: 'prs_leg005',\r\n    type: PersonaType.LEGAL,\r\n    name: 'General Counsel',\r\n    shortName: PERSONA_NAMES[PersonaType.LEGAL],\r\n    description:\r\n      'Compliance, contracts, risk management, intellectual property, and regulatory affairs',\r\n    avatarUrl: '/assets/images/personas/legal-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.LEGAL],\r\n  },\r\n  CREATIVE: {\r\n    id: 'prs_cre006',\r\n    type: PersonaType.CREATIVE,\r\n    name: 'Chief Creative Officer',\r\n    shortName: PERSONA_NAMES[PersonaType.CREATIVE],\r\n    description:\r\n      'Design thinking, brand identity, creative strategy, and innovation',\r\n    avatarUrl: '/assets/images/personas/creative-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.CREATIVE],\r\n  },\r\n  CSO: {\r\n    id: 'prs_cso007',\r\n    type: PersonaType.CSO,\r\n    name: 'Chief Strategy Officer',\r\n    shortName: PERSONA_NAMES[PersonaType.CSO],\r\n    description:\r\n      'Business strategy, competitive analysis, market positioning, and strategic planning',\r\n    avatarUrl: '/assets/images/personas/cso-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.CSO],\r\n  },\r\n  SALES: {\r\n    id: 'prs_sal008',\r\n    type: PersonaType.SALES,\r\n    name: 'VP of Sales',\r\n    shortName: PERSONA_NAMES[PersonaType.SALES],\r\n    description:\r\n      'Sales strategy, pipeline management, client relationships, and revenue growth',\r\n    avatarUrl: '/assets/images/personas/sales-avatar.svg',\r\n    color: PERSONA_COLORS[PersonaType.SALES],\r\n  },\r\n};\r\n\r\n/**\r\n * Service for managing department personas.\r\n * Provides static persona definitions for AI conversation context.\r\n */\r\n@Injectable()\r\nexport class PersonasService {\r\n  private readonly logger = new Logger(PersonasService.name);\r\n\r\n  /**\r\n   * Retrieves all available personas.\r\n   * @returns Array of all persona definitions\r\n   */\r\n  getPersonas(): Persona[] {\r\n    this.logger.log({ message: 'Retrieving all personas' });\r\n    return Object.values(PERSONAS);\r\n  }\r\n\r\n  /**\r\n   * Retrieves a specific persona by type.\r\n   * @param type - PersonaType enum value\r\n   * @returns Persona definition\r\n   * @throws NotFoundException if persona type is invalid\r\n   */\r\n  getPersonaByType(type: string): Persona {\r\n    const persona = PERSONAS[type];\r\n\r\n    if (!persona) {\r\n      this.logger.warn({ message: 'Persona not found', type });\r\n      throw new NotFoundException({\r\n        type: 'persona_not_found',\r\n        title: 'Persona Not Found',\r\n        status: 404,\r\n        detail: `Persona with type '${type}' not found. Valid types: ${Object.keys(PERSONAS).join(', ')}`,\r\n      });\r\n    }\r\n\r\n    this.logger.log({ message: 'Persona retrieved', type, personaId: persona.id });\r\n    return persona;\r\n  }\r\n\r\n  /**\r\n   * Validates if a persona type is valid.\r\n   * @param type - PersonaType string to validate\r\n   * @returns Boolean indicating validity\r\n   */\r\n  isValidPersonaType(type: string): boolean {\r\n    return type in PERSONAS;\r\n  }\r\n}\r\n","import { Controller, Get, Param, UseGuards } from '@nestjs/common';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { MfaRequiredGuard } from '../auth/guards/mfa-required.guard';\r\nimport { PersonasService } from './personas.service';\r\nimport type { Persona } from '@mentor-ai/shared/types';\r\n\r\n/**\r\n * Controller for persona-related API endpoints.\r\n * All endpoints require authentication and MFA verification.\r\n */\r\n@Controller('v1/personas')\r\n@UseGuards(JwtAuthGuard, MfaRequiredGuard)\r\nexport class PersonasController {\r\n  constructor(private readonly personasService: PersonasService) {}\r\n\r\n  /**\r\n   * GET /api/v1/personas\r\n   * Retrieves all available department personas.\r\n   * @returns Array of all persona definitions\r\n   */\r\n  @Get()\r\n  getPersonas(): { data: Persona[] } {\r\n    const personas = this.personasService.getPersonas();\r\n    return { data: personas };\r\n  }\r\n\r\n  /**\r\n   * GET /api/v1/personas/:type\r\n   * Retrieves a specific persona by type.\r\n   * @param type - Persona type (CFO, CMO, CTO, OPERATIONS, LEGAL, CREATIVE)\r\n   * @returns Single persona definition\r\n   * @throws NotFoundException if type is invalid\r\n   */\r\n  @Get(':type')\r\n  getPersonaByType(@Param('type') type: string): { data: Persona } {\r\n    const persona = this.personasService.getPersonaByType(type.toUpperCase());\r\n    return { data: persona };\r\n  }\r\n}\r\n","import { Module, Global } from '@nestjs/common';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport { QdrantClientService } from './qdrant-client.service';\r\n\r\n/**\r\n * Global module for Qdrant vector database client.\r\n * Marked @Global so all modules can inject QdrantClientService\r\n * without explicit imports.\r\n */\r\n@Global()\r\n@Module({\r\n  imports: [ConfigModule],\r\n  providers: [QdrantClientService],\r\n  exports: [QdrantClientService],\r\n})\r\nexport class QdrantModule {}\r\n","import { Module } from '@nestjs/common';\r\nimport { TenantModule } from '@mentor-ai/shared/tenant-context';\r\nimport { AuthModule } from '../auth/auth.module';\r\nimport { DataIntegrityController } from './data-integrity.controller';\r\nimport { DataIntegrityService } from './data-integrity.service';\r\nimport { BrainConfigController } from './brain-config.controller';\r\n\r\n@Module({\r\n  imports: [TenantModule, AuthModule],\r\n  controllers: [DataIntegrityController, BrainConfigController],\r\n  providers: [DataIntegrityService],\r\n})\r\nexport class AdminModule {}\r\n","import { Controller, Get } from '@nestjs/common';\r\nimport { DataIntegrityService, DataIntegrityReport } from './data-integrity.service';\r\n\r\n@Controller('v1/admin')\r\nexport class DataIntegrityController {\r\n  constructor(private readonly integrityService: DataIntegrityService) {}\r\n\r\n  @Get('data-integrity')\r\n  async checkIntegrity(): Promise<DataIntegrityReport> {\r\n    return this.integrityService.runFullCheck();\r\n  }\r\n}\r\n","import { Injectable, Logger } from '@nestjs/common';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { QdrantClientService } from '../qdrant/qdrant-client.service';\r\n\r\nexport interface DataIntegrityReport {\r\n  timestamp: string;\r\n  concepts: {\r\n    total: number;\r\n    withEmbeddingId: number;\r\n    withoutEmbeddingId: number;\r\n    withCurriculumId: number;\r\n    withoutCurriculumId: number;\r\n  };\r\n  qdrant: {\r\n    available: boolean;\r\n    pointCount: number | null;\r\n    collectionExists: boolean;\r\n  };\r\n  sync: {\r\n    status: 'synced' | 'drift' | 'unavailable';\r\n    mismatchCount: number;\r\n  };\r\n  issues: string[];\r\n}\r\n\r\n@Injectable()\r\nexport class DataIntegrityService {\r\n  private readonly logger = new Logger(DataIntegrityService.name);\r\n  private readonly COLLECTION_NAME = 'concepts';\r\n\r\n  constructor(\r\n    private readonly prisma: PlatformPrismaService,\r\n    private readonly qdrantClient: QdrantClientService,\r\n  ) {}\r\n\r\n  async runFullCheck(): Promise<DataIntegrityReport> {\r\n    const issues: string[] = [];\r\n\r\n    // 1. Concept stats from PostgreSQL\r\n    const concepts = await this.prisma.concept.findMany({\r\n      select: { id: true, embeddingId: true, curriculumId: true, slug: true },\r\n    });\r\n\r\n    const total = concepts.length;\r\n    const withEmbeddingId = concepts.filter((c) => c.embeddingId).length;\r\n    const withCurriculumId = concepts.filter((c) => c.curriculumId).length;\r\n\r\n    if (total === 0) {\r\n      issues.push('No concepts found in database  run seed script');\r\n    }\r\n    if (withEmbeddingId === 0 && total > 0) {\r\n      issues.push('No concepts have embeddings  run embedding script');\r\n    }\r\n\r\n    // 2. Qdrant stats\r\n    let qdrantAvailable = false;\r\n    let pointCount: number | null = null;\r\n    let collectionExists = false;\r\n\r\n    if (this.qdrantClient.isAvailable()) {\r\n      qdrantAvailable = true;\r\n      try {\r\n        const client = this.qdrantClient.getClient();\r\n        const collections = await client.getCollections();\r\n        collectionExists = collections.collections.some(\r\n          (c) => c.name === this.COLLECTION_NAME,\r\n        );\r\n\r\n        if (collectionExists) {\r\n          const info = await client.getCollection(this.COLLECTION_NAME);\r\n          pointCount = info.points_count ?? null;\r\n        } else {\r\n          issues.push(`Qdrant collection '${this.COLLECTION_NAME}' does not exist`);\r\n        }\r\n      } catch (err) {\r\n        const msg = err instanceof Error ? err.message : 'Unknown';\r\n        issues.push(`Qdrant query failed: ${msg}`);\r\n        qdrantAvailable = false;\r\n      }\r\n    } else {\r\n      issues.push('Qdrant not configured (QDRANT_URL missing)');\r\n    }\r\n\r\n    // 3. Sync check\r\n    let syncStatus: 'synced' | 'drift' | 'unavailable' = 'unavailable';\r\n    let mismatchCount = 0;\r\n\r\n    if (qdrantAvailable && pointCount !== null) {\r\n      mismatchCount = Math.abs(withEmbeddingId - pointCount);\r\n      if (mismatchCount === 0 && withEmbeddingId === pointCount) {\r\n        syncStatus = 'synced';\r\n      } else {\r\n        syncStatus = 'drift';\r\n        issues.push(\r\n          `DB has ${withEmbeddingId} concepts with embeddingId but Qdrant has ${pointCount} points (diff: ${mismatchCount})`,\r\n        );\r\n      }\r\n    }\r\n\r\n    // Check for duplicate slugs\r\n    const slugs = concepts.map((c) => c.slug);\r\n    const dupSlugs = slugs.filter((s, i) => slugs.indexOf(s) !== i);\r\n    if (dupSlugs.length > 0) {\r\n      issues.push(`Duplicate slugs found: ${dupSlugs.join(', ')}`);\r\n    }\r\n\r\n    // Check for duplicate curriculumIds\r\n    const currIds = concepts.filter((c) => c.curriculumId).map((c) => c.curriculumId!);\r\n    const dupCurrIds = currIds.filter((id, i) => currIds.indexOf(id) !== i);\r\n    if (dupCurrIds.length > 0) {\r\n      issues.push(`Duplicate curriculumIds: ${dupCurrIds.join(', ')}`);\r\n    }\r\n\r\n    const report: DataIntegrityReport = {\r\n      timestamp: new Date().toISOString(),\r\n      concepts: {\r\n        total,\r\n        withEmbeddingId,\r\n        withoutEmbeddingId: total - withEmbeddingId,\r\n        withCurriculumId,\r\n        withoutCurriculumId: total - withCurriculumId,\r\n      },\r\n      qdrant: {\r\n        available: qdrantAvailable,\r\n        pointCount,\r\n        collectionExists,\r\n      },\r\n      sync: {\r\n        status: syncStatus,\r\n        mismatchCount,\r\n      },\r\n      issues,\r\n    };\r\n\r\n    this.logger.log({\r\n      message: 'Data integrity check completed',\r\n      syncStatus,\r\n      issueCount: issues.length,\r\n    });\r\n\r\n    return report;\r\n  }\r\n}\r\n","import { Controller, Get, Patch, Body, UseGuards, Logger } from '@nestjs/common';\r\nimport { IsBoolean, IsOptional } from 'class-validator';\r\nimport { PlatformPrismaService } from '@mentor-ai/shared/tenant-context';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { CurrentUser } from '../auth/decorators/current-user.decorator';\r\nimport type { CurrentUserPayload } from '../auth/strategies/jwt.strategy';\r\n\r\nexport class UpdateBrainConfigDto {\r\n  @IsBoolean()\r\n  @IsOptional()\r\n  autoAiPopuni?: boolean;\r\n}\r\n\r\n@Controller('admin/brain-config')\r\n@UseGuards(JwtAuthGuard)\r\nexport class BrainConfigController {\r\n  private readonly logger = new Logger(BrainConfigController.name);\r\n\r\n  constructor(private readonly prisma: PlatformPrismaService) {}\r\n\r\n  @Get()\r\n  async getBrainConfig(\r\n    @CurrentUser() user: CurrentUserPayload\r\n  ): Promise<{ data: { autoAiPopuni: boolean } }> {\r\n    const tenant = await this.prisma.tenant.findUnique({\r\n      where: { id: user.tenantId },\r\n      select: { autoAiPopuni: true },\r\n    });\r\n\r\n    return { data: { autoAiPopuni: tenant?.autoAiPopuni ?? false } };\r\n  }\r\n\r\n  @Patch()\r\n  async updateBrainConfig(\r\n    @CurrentUser() user: CurrentUserPayload,\r\n    @Body() dto: UpdateBrainConfigDto\r\n  ): Promise<{ data: { autoAiPopuni: boolean } }> {\r\n    this.logger.log({\r\n      message: 'Updating brain config',\r\n      tenantId: user.tenantId,\r\n      userId: user.userId,\r\n      autoAiPopuni: dto.autoAiPopuni,\r\n    });\r\n\r\n    const updated = await this.prisma.tenant.update({\r\n      where: { id: user.tenantId },\r\n      data: {\r\n        ...(typeof dto.autoAiPopuni === 'boolean' && { autoAiPopuni: dto.autoAiPopuni }),\r\n      },\r\n      select: { autoAiPopuni: true },\r\n    });\r\n\r\n    return { data: { autoAiPopuni: updated.autoAiPopuni } };\r\n  }\r\n}\r\n","import {\r\n  ExceptionFilter,\r\n  Catch,\r\n  ArgumentsHost,\r\n  HttpException,\r\n  HttpStatus,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { Request, Response } from 'express';\r\n\r\n/**\r\n * RFC 7807 Problem Details response shape.\r\n * @see https://datatracker.ietf.org/doc/html/rfc7807\r\n */\r\nexport interface ProblemDetails {\r\n  type: string;\r\n  title: string;\r\n  status: number;\r\n  detail: string;\r\n  instance: string;\r\n  correlationId?: string;\r\n  errors?: Array<{ field: string; message: string }>;\r\n}\r\n\r\n@Catch()\r\nexport class AllExceptionsFilter implements ExceptionFilter {\r\n  private readonly logger = new Logger(AllExceptionsFilter.name);\r\n\r\n  catch(exception: unknown, host: ArgumentsHost): void {\r\n    const ctx = host.switchToHttp();\r\n    const response = ctx.getResponse<Response>();\r\n    const request = ctx.getRequest<Request>();\r\n\r\n    const correlationId = request.headers['x-correlation-id'] as\r\n      | string\r\n      | undefined;\r\n\r\n    const problem = this.buildProblemDetails(exception, request, correlationId);\r\n\r\n    this.logException(exception, problem);\r\n\r\n    response\r\n      .status(problem.status)\r\n      .header('Content-Type', 'application/problem+json')\r\n      .json(problem);\r\n  }\r\n\r\n  private buildProblemDetails(\r\n    exception: unknown,\r\n    request: Request,\r\n    correlationId?: string,\r\n  ): ProblemDetails {\r\n    if (exception instanceof HttpException) {\r\n      return this.fromHttpException(exception, request, correlationId);\r\n    }\r\n    return this.fromUnknown(exception, request, correlationId);\r\n  }\r\n\r\n  private fromHttpException(\r\n    exception: HttpException,\r\n    request: Request,\r\n    correlationId?: string,\r\n  ): ProblemDetails {\r\n    const status = exception.getStatus();\r\n    const exceptionResponse = exception.getResponse();\r\n\r\n    // If the controller already threw RFC 7807 shape, preserve it\r\n    if (this.isRfc7807(exceptionResponse)) {\r\n      return {\r\n        type: exceptionResponse.type,\r\n        title: exceptionResponse.title,\r\n        status,\r\n        detail: exceptionResponse.detail,\r\n        instance: request.url,\r\n        ...(correlationId && { correlationId }),\r\n        ...(exceptionResponse.errors && { errors: exceptionResponse.errors }),\r\n      };\r\n    }\r\n\r\n    // NestJS ValidationPipe errors come as { statusCode, message: string[], error }\r\n    if (this.isValidationError(exceptionResponse)) {\r\n      return {\r\n        type: 'validation_error',\r\n        title: 'Validation Failed',\r\n        status,\r\n        detail: 'One or more fields failed validation',\r\n        instance: request.url,\r\n        ...(correlationId && { correlationId }),\r\n        errors: exceptionResponse.message.map((msg: string) => ({\r\n          field: this.extractFieldFromMessage(msg),\r\n          message: msg,\r\n        })),\r\n      };\r\n    }\r\n\r\n    // Standard NestJS exception (string or { message, error, statusCode })\r\n    const detail =\r\n      typeof exceptionResponse === 'string'\r\n        ? exceptionResponse\r\n        : (exceptionResponse as Record<string, unknown>).message?.toString() ||\r\n          exception.message;\r\n\r\n    return {\r\n      type: this.statusToType(status),\r\n      title: this.statusToTitle(status),\r\n      status,\r\n      detail,\r\n      instance: request.url,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  private fromUnknown(\r\n    exception: unknown,\r\n    request: Request,\r\n    correlationId?: string,\r\n  ): ProblemDetails {\r\n    const detail =\r\n      exception instanceof Error ? exception.message : 'An unexpected error occurred';\r\n\r\n    return {\r\n      type: 'internal_error',\r\n      title: 'Internal Server Error',\r\n      status: HttpStatus.INTERNAL_SERVER_ERROR,\r\n      detail,\r\n      instance: request.url,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n\r\n  private isRfc7807(\r\n    response: unknown,\r\n  ): response is { type: string; title: string; detail: string; errors?: Array<{ field: string; message: string }> } {\r\n    if (typeof response !== 'object' || response === null) return false;\r\n    const obj = response as Record<string, unknown>;\r\n    return (\r\n      typeof obj.type === 'string' &&\r\n      typeof obj.title === 'string' &&\r\n      typeof obj.detail === 'string'\r\n    );\r\n  }\r\n\r\n  private isValidationError(\r\n    response: unknown,\r\n  ): response is { statusCode: number; message: string[]; error: string } {\r\n    if (typeof response !== 'object' || response === null) return false;\r\n    const obj = response as Record<string, unknown>;\r\n    return Array.isArray(obj.message) && typeof obj.statusCode === 'number';\r\n  }\r\n\r\n  private extractFieldFromMessage(message: string): string {\r\n    // NestJS validation messages typically start with the property name\r\n    const match = message.match(/^(\\w+)\\s/);\r\n    return match?.[1] ?? 'unknown';\r\n  }\r\n\r\n  private logException(exception: unknown, problem: ProblemDetails): void {\r\n    const logContext = {\r\n      type: problem.type,\r\n      status: problem.status,\r\n      instance: problem.instance,\r\n      correlationId: problem.correlationId,\r\n    };\r\n\r\n    if (problem.status >= 500) {\r\n      this.logger.error(\r\n        `[${problem.correlationId || 'no-correlation'}] ${problem.detail}`,\r\n        exception instanceof Error ? exception.stack : undefined,\r\n        logContext,\r\n      );\r\n    } else if (problem.status >= 400) {\r\n      this.logger.warn(\r\n        `[${problem.correlationId || 'no-correlation'}] ${problem.type}: ${problem.detail}`,\r\n      );\r\n    }\r\n  }\r\n\r\n  private statusToType(status: number): string {\r\n    const map: Record<number, string> = {\r\n      400: 'bad_request',\r\n      401: 'unauthorized',\r\n      403: 'forbidden',\r\n      404: 'not_found',\r\n      409: 'conflict',\r\n      422: 'unprocessable_entity',\r\n      429: 'too_many_requests',\r\n      500: 'internal_error',\r\n      502: 'bad_gateway',\r\n      503: 'service_unavailable',\r\n    };\r\n    return map[status] || `http_error_${status}`;\r\n  }\r\n\r\n  private statusToTitle(status: number): string {\r\n    const map: Record<number, string> = {\r\n      400: 'Bad Request',\r\n      401: 'Unauthorized',\r\n      403: 'Forbidden',\r\n      404: 'Not Found',\r\n      409: 'Conflict',\r\n      422: 'Unprocessable Entity',\r\n      429: 'Too Many Requests',\r\n      500: 'Internal Server Error',\r\n      502: 'Bad Gateway',\r\n      503: 'Service Unavailable',\r\n    };\r\n    return map[status] || `HTTP Error ${status}`;\r\n  }\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","/**\r\n * Mentor AI API Server\r\n */\r\n\r\nimport { Logger, ValidationPipe } from '@nestjs/common';\r\nimport { NestFactory } from '@nestjs/core';\r\nimport { AppModule } from './app/app.module';\r\nimport { AllExceptionsFilter } from './app/common/filters/all-exceptions.filter';\r\n\r\nasync function bootstrap() {\r\n  const app = await NestFactory.create(AppModule);\r\n  const globalPrefix = 'api';\r\n  app.setGlobalPrefix(globalPrefix);\r\n\r\n  // CORS: use CORS_ORIGIN env var in production, localhost in dev\r\n  const corsOrigin = process.env.CORS_ORIGIN\r\n    ? process.env.CORS_ORIGIN.split(',')\r\n    : ['http://localhost:4200', 'http://127.0.0.1:4200'];\r\n  app.enableCors({\r\n    origin: corsOrigin,\r\n    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\r\n    allowedHeaders: ['Content-Type', 'Authorization', 'Accept', 'X-Tenant-Id', 'X-Correlation-Id'],\r\n    credentials: true,\r\n  });\r\n\r\n  // Global exception filter  RFC 7807 ProblemDetails for all errors\r\n  app.useGlobalFilters(new AllExceptionsFilter());\r\n\r\n  // Enable validation with class-validator\r\n  app.useGlobalPipes(\r\n    new ValidationPipe({\r\n      whitelist: true,\r\n      forbidNonWhitelisted: true,\r\n      transform: true,\r\n    })\r\n  );\r\n\r\n  const port = process.env.PORT || 3000;\r\n  await app.listen(port);\r\n  Logger.log(` Application is running on: http://localhost:${port}/${globalPrefix}`);\r\n\r\n  if (process.env.DEV_MODE === 'true') {\r\n    Logger.warn('  DEV MODE ENABLED - Authentication bypassed for development');\r\n  }\r\n}\r\n\r\nbootstrap();\r\n"],"names":[],"sourceRoot":""}