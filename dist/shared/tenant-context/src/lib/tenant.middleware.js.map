{"version":3,"sources":["../../../../../shared/tenant-context/src/lib/tenant.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware, ForbiddenException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { PlatformPrismaService } from './platform-prisma.service';\r\nimport { TenantStatus } from '@prisma/client';\r\n\r\nexport const TENANT_ID_HEADER = 'x-tenant-id';\r\nexport const TENANT_ID_KEY = 'tenantId';\r\n\r\n// Extend Express Request to include tenant context\r\ndeclare global {\r\n  // eslint-disable-next-line @typescript-eslint/no-namespace\r\n  namespace Express {\r\n    interface Request {\r\n      tenantId?: string;\r\n    }\r\n  }\r\n}\r\n\r\ninterface Rfc7807Error {\r\n  type: string;\r\n  title: string;\r\n  status: number;\r\n  detail: string;\r\n  correlationId?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class TenantMiddleware implements NestMiddleware {\r\n  // Paths that don't require tenant context (e.g., health checks, platform admin)\r\n  private readonly excludedPaths = [\r\n    '/health',\r\n    '/api/health',\r\n    '/api/v1/health',\r\n  ];\r\n\r\n  constructor(\r\n    private readonly platformPrisma: PlatformPrismaService,\r\n    private readonly configService: ConfigService\r\n  ) {}\r\n\r\n  async use(req: Request, res: Response, next: NextFunction): Promise<void> {\r\n    // Skip tenant validation for excluded paths\r\n    if (this.isExcludedPath(req.path)) {\r\n      return next();\r\n    }\r\n\r\n    // Dev mode: try to extract tenantId from JWT if a real token is present,\r\n    // otherwise fall back to dev-tenant-001\r\n    if (this.configService.get<string>('DEV_MODE') === 'true') {\r\n      const authHeader = req.headers?.authorization as string | undefined;\r\n      if (authHeader?.startsWith('Bearer ') && !authHeader.includes('dev-mode-token')) {\r\n        try {\r\n          const token = authHeader.substring(7);\r\n          const payloadBase64 = token.split('.')[1];\r\n          if (payloadBase64) {\r\n            const payload = JSON.parse(Buffer.from(payloadBase64, 'base64').toString());\r\n            if (payload.tenantId) {\r\n              req.tenantId = payload.tenantId;\r\n              return next();\r\n            }\r\n          }\r\n        } catch {\r\n          // Token decode failed - use dev fallback\r\n        }\r\n      }\r\n      req.tenantId = 'dev-tenant-001';\r\n      return next();\r\n    }\r\n\r\n    const tenantId = req.headers[TENANT_ID_HEADER] as string | undefined;\r\n    const correlationId = req.headers['x-correlation-id'] as string | undefined;\r\n\r\n    // Validate tenant ID is present\r\n    if (!tenantId) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'tenant_id_missing',\r\n        'Tenant ID Required',\r\n        'X-Tenant-Id header is required for this request',\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    // Validate tenant ID format (must have tnt_ prefix)\r\n    if (!tenantId.startsWith('tnt_')) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'invalid_tenant_id_format',\r\n        'Invalid Tenant ID Format',\r\n        'Tenant ID must start with \"tnt_\" prefix',\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    // Validate tenant exists and is active\r\n    const tenant = await this.platformPrisma.tenantRegistry.findUnique({\r\n      where: { id: tenantId },\r\n    });\r\n\r\n    if (!tenant) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'tenant_not_found',\r\n        'Tenant Not Found',\r\n        'No tenant found for provided X-Tenant-Id header',\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    if (tenant.status !== TenantStatus.ACTIVE) {\r\n      throw new ForbiddenException(this.createRfc7807Error(\r\n        'tenant_not_active',\r\n        'Tenant Not Active',\r\n        `Tenant is currently ${tenant.status.toLowerCase()}`,\r\n        correlationId\r\n      ));\r\n    }\r\n\r\n    // Attach tenant ID to request for downstream use\r\n    req.tenantId = tenantId;\r\n\r\n    next();\r\n  }\r\n\r\n  private isExcludedPath(path: string): boolean {\r\n    return this.excludedPaths.some(\r\n      (excluded) => path === excluded || path.startsWith(`${excluded}/`)\r\n    );\r\n  }\r\n\r\n  private createRfc7807Error(\r\n    type: string,\r\n    title: string,\r\n    detail: string,\r\n    correlationId?: string\r\n  ): Rfc7807Error {\r\n    return {\r\n      type,\r\n      title,\r\n      status: 403,\r\n      detail,\r\n      ...(correlationId && { correlationId }),\r\n    };\r\n  }\r\n}\r\n"],"names":["TENANT_ID_HEADER","TENANT_ID_KEY","TenantMiddleware","use","req","res","next","isExcludedPath","path","configService","get","authHeader","headers","authorization","startsWith","includes","token","substring","payloadBase64","split","payload","JSON","parse","Buffer","from","toString","tenantId","correlationId","ForbiddenException","createRfc7807Error","tenant","platformPrisma","tenantRegistry","findUnique","where","id","status","TenantStatus","ACTIVE","toLowerCase","excludedPaths","some","excluded","type","title","detail","constructor","Injectable"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}